// 10B MoE Model Parallel Strategy DAG
digraph {
	nodesep=0.5 rankdir=TB ranksep=1.0 splines=ortho
	node [fillcolor=lightblue shape=ellipse style=filled]
	node [fillcolor=lightgreen shape=rect style=filled]
	node [fillcolor=lightyellow shape=parallelogram style=filled]
	node [fontsize=10 height=0.8 width=2.0]
	R1_Input -> R1_Stage1_Input
	R1_Stage1_Input -> R1_Stage1_L1_Output
	R1_Stage1_L1_Output -> R1_Stage1_L2_Output
	R1_Stage1_L2_Output -> R1_Stage1_L3_Output
	R1_Stage1_L3_Output -> R1_Stage1_L4_Output
	R1_Stage1_L4_Output -> R1_Stage1_Output
	R1_Stage1_Output -> R1_Stage2_Input [label="PP Communication"]
	R1_Stage2_Input -> R1_Stage2_L5_Output
	R1_Stage2_L5_Output -> R1_Stage2_L6_Output
	R1_Stage2_L6_Output -> R1_Stage2_L7_Output
	R1_Stage2_L7_Output -> R1_Stage2_L8_Output
	R1_Stage2_L8_Output -> R1_Stage2_Output
	R1_Stage2_Output -> R1_Stage3_Input [label="PP Communication"]
	R1_Stage3_Input -> R1_Stage3_L9_Output
	R1_Stage3_L9_Output -> R1_Stage3_L10_Output
	R1_Stage3_L10_Output -> R1_Stage3_L11_Output
	R1_Stage3_L11_Output -> R1_Stage3_L12_Output
	R1_Stage3_L12_Output -> R1_Stage3_Output
	R1_Stage3_Output -> R1_Stage4_Input [label="PP Communication"]
	R1_Stage4_Input -> R1_Stage4_L13_Output
	R1_Stage4_L13_Output -> R1_Stage4_L14_Output
	R1_Stage4_L14_Output -> R1_Stage4_L15_Output
	R1_Stage4_L15_Output -> R1_Stage4_L16_Output
	R1_Stage4_L16_Output -> R1_Stage4_Output
	R1_Stage4_Output -> R1_Output [label="Final Output"]
	R2_Input -> R2_Stage1_Input
	R2_Stage1_Input -> R2_Stage1_L1_Output
	R2_Stage1_L1_Output -> R2_Stage1_L2_Output
	R2_Stage1_L2_Output -> R2_Stage1_L3_Output
	R2_Stage1_L3_Output -> R2_Stage1_L4_Output
	R2_Stage1_L4_Output -> R2_Stage1_Output
	R2_Stage1_Output -> R2_Stage2_Input [label="PP Communication"]
	R2_Stage2_Input -> R2_Stage2_L5_Output
	R2_Stage2_L5_Output -> R2_Stage2_L6_Output
	R2_Stage2_L6_Output -> R2_Stage2_L7_Output
	R2_Stage2_L7_Output -> R2_Stage2_L8_Output
	R2_Stage2_L8_Output -> R2_Stage2_Output
	R2_Stage2_Output -> R2_Stage3_Input [label="PP Communication"]
	R2_Stage3_Input -> R2_Stage3_L9_Output
	R2_Stage3_L9_Output -> R2_Stage3_L10_Output
	R2_Stage3_L10_Output -> R2_Stage3_L11_Output
	R2_Stage3_L11_Output -> R2_Stage3_L12_Output
	R2_Stage3_L12_Output -> R2_Stage3_Output
	R2_Stage3_Output -> R2_Stage4_Input [label="PP Communication"]
	R2_Stage4_Input -> R2_Stage4_L13_Output
	R2_Stage4_L13_Output -> R2_Stage4_L14_Output
	R2_Stage4_L14_Output -> R2_Stage4_L15_Output
	R2_Stage4_L15_Output -> R2_Stage4_L16_Output
	R2_Stage4_L16_Output -> R2_Stage4_Output
	R2_Stage4_Output -> R2_Output [label="Final Output"]
	subgraph cluster_dp {
		fillcolor=lightgray fontname=bold label="DP=2 (Request Parallelism)" style="rounded,filled"
		subgraph cluster_replica1 {
			fillcolor=lightblue label="Pipeline Replica 1 (64 GPUs)" style="rounded,filled"
			R1_Input [label="Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			subgraph cluster_R1_Stage1 {
				fillcolor=lightgreen label="Stage1: Layers 1-4 (16 GPUs)" style="rounded,filled"
				R1_Stage1_Input [label="Stage1 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L1_Input [label="Layer 1 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L1_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L1_Input -> R1_Stage1_L1_Attn_Input
				R1_Stage1_L1_Attn_TP1 [label="Attention TP GPU 0\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Attn_TP2 [label="Attention TP GPU 1\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Attn_Input -> R1_Stage1_L1_Attn_TP1
				R1_Stage1_L1_Attn_Input -> R1_Stage1_L1_Attn_TP2
				R1_Stage1_L1_Attn_Output [label="Attention Output\nAllReduce GPUs 0-1\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L1_Attn_TP1 -> R1_Stage1_L1_Attn_Output
				R1_Stage1_L1_Attn_TP2 -> R1_Stage1_L1_Attn_Output
				R1_Stage1_L1_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L1_Attn_Output -> R1_Stage1_L1_MoE_Input
				R1_Stage1_L1_Router [label="Router GPU 0\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L1_MoE_Input -> R1_Stage1_L1_Router
				R1_Stage1_L1_Expert0 [label="Expert 0 GPU 0\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert0 [label=select style=dashed]
				R1_Stage1_L1_Expert1 [label="Expert 1 GPU 1\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert1 [label=select style=dashed]
				R1_Stage1_L1_Expert2 [label="Expert 2 GPU 2\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert2 [label=select style=dashed]
				R1_Stage1_L1_Expert3 [label="Expert 3 GPU 3\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert3 [label=select style=dashed]
				R1_Stage1_L1_Expert4 [label="Expert 4 GPU 4\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert4 [label=select style=dashed]
				R1_Stage1_L1_Expert5 [label="Expert 5 GPU 5\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert5 [label=select style=dashed]
				R1_Stage1_L1_Expert6 [label="Expert 6 GPU 6\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert6 [label=select style=dashed]
				R1_Stage1_L1_Expert7 [label="Expert 7 GPU 7\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert7 [label=select style=dashed]
				R1_Stage1_L1_Expert8 [label="Expert 8 GPU 8\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert8 [label=select style=dashed]
				R1_Stage1_L1_Expert9 [label="Expert 9 GPU 9\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert9 [label=select style=dashed]
				R1_Stage1_L1_Expert10 [label="Expert 10 GPU 10\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert10 [label=select style=dashed]
				R1_Stage1_L1_Expert11 [label="Expert 11 GPU 11\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert11 [label=select style=dashed]
				R1_Stage1_L1_Expert12 [label="Expert 12 GPU 12\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert12 [label=select style=dashed]
				R1_Stage1_L1_Expert13 [label="Expert 13 GPU 13\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert13 [label=select style=dashed]
				R1_Stage1_L1_Expert14 [label="Expert 14 GPU 14\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert14 [label=select style=dashed]
				R1_Stage1_L1_Expert15 [label="Expert 15 GPU 15\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L1_Router -> R1_Stage1_L1_Expert15 [label=select style=dashed]
				R1_Stage1_L1_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L1_Expert0 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert1 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert2 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert3 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert4 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert5 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert6 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert7 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert8 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert9 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert10 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert11 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert12 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert13 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert14 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Expert15 -> R1_Stage1_L1_MoE_Output
				R1_Stage1_L1_Output [label="Layer 1 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L1_MoE_Output -> R1_Stage1_L1_Output
				R1_Stage1_L2_Input [label="Layer 2 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L2_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L2_Input -> R1_Stage1_L2_Attn_Input
				R1_Stage1_L2_Attn_TP1 [label="Attention TP GPU 0\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Attn_TP2 [label="Attention TP GPU 1\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Attn_Input -> R1_Stage1_L2_Attn_TP1
				R1_Stage1_L2_Attn_Input -> R1_Stage1_L2_Attn_TP2
				R1_Stage1_L2_Attn_Output [label="Attention Output\nAllReduce GPUs 0-1\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L2_Attn_TP1 -> R1_Stage1_L2_Attn_Output
				R1_Stage1_L2_Attn_TP2 -> R1_Stage1_L2_Attn_Output
				R1_Stage1_L2_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L2_Attn_Output -> R1_Stage1_L2_MoE_Input
				R1_Stage1_L2_Router [label="Router GPU 0\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L2_MoE_Input -> R1_Stage1_L2_Router
				R1_Stage1_L2_Expert0 [label="Expert 0 GPU 0\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert0 [label=select style=dashed]
				R1_Stage1_L2_Expert1 [label="Expert 1 GPU 1\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert1 [label=select style=dashed]
				R1_Stage1_L2_Expert2 [label="Expert 2 GPU 2\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert2 [label=select style=dashed]
				R1_Stage1_L2_Expert3 [label="Expert 3 GPU 3\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert3 [label=select style=dashed]
				R1_Stage1_L2_Expert4 [label="Expert 4 GPU 4\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert4 [label=select style=dashed]
				R1_Stage1_L2_Expert5 [label="Expert 5 GPU 5\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert5 [label=select style=dashed]
				R1_Stage1_L2_Expert6 [label="Expert 6 GPU 6\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert6 [label=select style=dashed]
				R1_Stage1_L2_Expert7 [label="Expert 7 GPU 7\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert7 [label=select style=dashed]
				R1_Stage1_L2_Expert8 [label="Expert 8 GPU 8\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert8 [label=select style=dashed]
				R1_Stage1_L2_Expert9 [label="Expert 9 GPU 9\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert9 [label=select style=dashed]
				R1_Stage1_L2_Expert10 [label="Expert 10 GPU 10\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert10 [label=select style=dashed]
				R1_Stage1_L2_Expert11 [label="Expert 11 GPU 11\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert11 [label=select style=dashed]
				R1_Stage1_L2_Expert12 [label="Expert 12 GPU 12\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert12 [label=select style=dashed]
				R1_Stage1_L2_Expert13 [label="Expert 13 GPU 13\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert13 [label=select style=dashed]
				R1_Stage1_L2_Expert14 [label="Expert 14 GPU 14\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert14 [label=select style=dashed]
				R1_Stage1_L2_Expert15 [label="Expert 15 GPU 15\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L2_Router -> R1_Stage1_L2_Expert15 [label=select style=dashed]
				R1_Stage1_L2_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L2_Expert0 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert1 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert2 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert3 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert4 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert5 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert6 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert7 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert8 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert9 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert10 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert11 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert12 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert13 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert14 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Expert15 -> R1_Stage1_L2_MoE_Output
				R1_Stage1_L2_Output [label="Layer 2 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L2_MoE_Output -> R1_Stage1_L2_Output
				R1_Stage1_L3_Input [label="Layer 3 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L3_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L3_Input -> R1_Stage1_L3_Attn_Input
				R1_Stage1_L3_Attn_TP1 [label="Attention TP GPU 0\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Attn_TP2 [label="Attention TP GPU 1\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Attn_Input -> R1_Stage1_L3_Attn_TP1
				R1_Stage1_L3_Attn_Input -> R1_Stage1_L3_Attn_TP2
				R1_Stage1_L3_Attn_Output [label="Attention Output\nAllReduce GPUs 0-1\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L3_Attn_TP1 -> R1_Stage1_L3_Attn_Output
				R1_Stage1_L3_Attn_TP2 -> R1_Stage1_L3_Attn_Output
				R1_Stage1_L3_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L3_Attn_Output -> R1_Stage1_L3_MoE_Input
				R1_Stage1_L3_Router [label="Router GPU 0\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L3_MoE_Input -> R1_Stage1_L3_Router
				R1_Stage1_L3_Expert0 [label="Expert 0 GPU 0\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert0 [label=select style=dashed]
				R1_Stage1_L3_Expert1 [label="Expert 1 GPU 1\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert1 [label=select style=dashed]
				R1_Stage1_L3_Expert2 [label="Expert 2 GPU 2\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert2 [label=select style=dashed]
				R1_Stage1_L3_Expert3 [label="Expert 3 GPU 3\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert3 [label=select style=dashed]
				R1_Stage1_L3_Expert4 [label="Expert 4 GPU 4\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert4 [label=select style=dashed]
				R1_Stage1_L3_Expert5 [label="Expert 5 GPU 5\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert5 [label=select style=dashed]
				R1_Stage1_L3_Expert6 [label="Expert 6 GPU 6\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert6 [label=select style=dashed]
				R1_Stage1_L3_Expert7 [label="Expert 7 GPU 7\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert7 [label=select style=dashed]
				R1_Stage1_L3_Expert8 [label="Expert 8 GPU 8\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert8 [label=select style=dashed]
				R1_Stage1_L3_Expert9 [label="Expert 9 GPU 9\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert9 [label=select style=dashed]
				R1_Stage1_L3_Expert10 [label="Expert 10 GPU 10\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert10 [label=select style=dashed]
				R1_Stage1_L3_Expert11 [label="Expert 11 GPU 11\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert11 [label=select style=dashed]
				R1_Stage1_L3_Expert12 [label="Expert 12 GPU 12\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert12 [label=select style=dashed]
				R1_Stage1_L3_Expert13 [label="Expert 13 GPU 13\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert13 [label=select style=dashed]
				R1_Stage1_L3_Expert14 [label="Expert 14 GPU 14\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert14 [label=select style=dashed]
				R1_Stage1_L3_Expert15 [label="Expert 15 GPU 15\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L3_Router -> R1_Stage1_L3_Expert15 [label=select style=dashed]
				R1_Stage1_L3_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L3_Expert0 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert1 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert2 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert3 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert4 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert5 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert6 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert7 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert8 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert9 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert10 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert11 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert12 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert13 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert14 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Expert15 -> R1_Stage1_L3_MoE_Output
				R1_Stage1_L3_Output [label="Layer 3 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L3_MoE_Output -> R1_Stage1_L3_Output
				R1_Stage1_L4_Input [label="Layer 4 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L4_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L4_Input -> R1_Stage1_L4_Attn_Input
				R1_Stage1_L4_Attn_TP1 [label="Attention TP GPU 0\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Attn_TP2 [label="Attention TP GPU 1\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Attn_Input -> R1_Stage1_L4_Attn_TP1
				R1_Stage1_L4_Attn_Input -> R1_Stage1_L4_Attn_TP2
				R1_Stage1_L4_Attn_Output [label="Attention Output\nAllReduce GPUs 0-1\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L4_Attn_TP1 -> R1_Stage1_L4_Attn_Output
				R1_Stage1_L4_Attn_TP2 -> R1_Stage1_L4_Attn_Output
				R1_Stage1_L4_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L4_Attn_Output -> R1_Stage1_L4_MoE_Input
				R1_Stage1_L4_Router [label="Router GPU 0\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L4_MoE_Input -> R1_Stage1_L4_Router
				R1_Stage1_L4_Expert0 [label="Expert 0 GPU 0\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert0 [label=select style=dashed]
				R1_Stage1_L4_Expert1 [label="Expert 1 GPU 1\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert1 [label=select style=dashed]
				R1_Stage1_L4_Expert2 [label="Expert 2 GPU 2\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert2 [label=select style=dashed]
				R1_Stage1_L4_Expert3 [label="Expert 3 GPU 3\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert3 [label=select style=dashed]
				R1_Stage1_L4_Expert4 [label="Expert 4 GPU 4\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert4 [label=select style=dashed]
				R1_Stage1_L4_Expert5 [label="Expert 5 GPU 5\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert5 [label=select style=dashed]
				R1_Stage1_L4_Expert6 [label="Expert 6 GPU 6\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert6 [label=select style=dashed]
				R1_Stage1_L4_Expert7 [label="Expert 7 GPU 7\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert7 [label=select style=dashed]
				R1_Stage1_L4_Expert8 [label="Expert 8 GPU 8\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert8 [label=select style=dashed]
				R1_Stage1_L4_Expert9 [label="Expert 9 GPU 9\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert9 [label=select style=dashed]
				R1_Stage1_L4_Expert10 [label="Expert 10 GPU 10\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert10 [label=select style=dashed]
				R1_Stage1_L4_Expert11 [label="Expert 11 GPU 11\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert11 [label=select style=dashed]
				R1_Stage1_L4_Expert12 [label="Expert 12 GPU 12\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert12 [label=select style=dashed]
				R1_Stage1_L4_Expert13 [label="Expert 13 GPU 13\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert13 [label=select style=dashed]
				R1_Stage1_L4_Expert14 [label="Expert 14 GPU 14\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert14 [label=select style=dashed]
				R1_Stage1_L4_Expert15 [label="Expert 15 GPU 15\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage1_L4_Router -> R1_Stage1_L4_Expert15 [label=select style=dashed]
				R1_Stage1_L4_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage1_L4_Expert0 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert1 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert2 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert3 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert4 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert5 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert6 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert7 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert8 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert9 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert10 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert11 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert12 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert13 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert14 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Expert15 -> R1_Stage1_L4_MoE_Output
				R1_Stage1_L4_Output [label="Layer 4 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage1_L4_MoE_Output -> R1_Stage1_L4_Output
				R1_Stage1_Output [label="Stage1 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			subgraph cluster_R1_Stage2 {
				fillcolor=lightgreen label="Stage2: Layers 5-8 (16 GPUs)" style="rounded,filled"
				R1_Stage2_Input [label="Stage2 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L5_Input [label="Layer 5 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L5_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L5_Input -> R1_Stage2_L5_Attn_Input
				R1_Stage2_L5_Attn_TP1 [label="Attention TP GPU 16\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Attn_TP2 [label="Attention TP GPU 17\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Attn_Input -> R1_Stage2_L5_Attn_TP1
				R1_Stage2_L5_Attn_Input -> R1_Stage2_L5_Attn_TP2
				R1_Stage2_L5_Attn_Output [label="Attention Output\nAllReduce GPUs 16-17\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L5_Attn_TP1 -> R1_Stage2_L5_Attn_Output
				R1_Stage2_L5_Attn_TP2 -> R1_Stage2_L5_Attn_Output
				R1_Stage2_L5_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L5_Attn_Output -> R1_Stage2_L5_MoE_Input
				R1_Stage2_L5_Router [label="Router GPU 16\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L5_MoE_Input -> R1_Stage2_L5_Router
				R1_Stage2_L5_Expert0 [label="Expert 0 GPU 16\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert0 [label=select style=dashed]
				R1_Stage2_L5_Expert1 [label="Expert 1 GPU 17\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert1 [label=select style=dashed]
				R1_Stage2_L5_Expert2 [label="Expert 2 GPU 18\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert2 [label=select style=dashed]
				R1_Stage2_L5_Expert3 [label="Expert 3 GPU 19\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert3 [label=select style=dashed]
				R1_Stage2_L5_Expert4 [label="Expert 4 GPU 20\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert4 [label=select style=dashed]
				R1_Stage2_L5_Expert5 [label="Expert 5 GPU 21\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert5 [label=select style=dashed]
				R1_Stage2_L5_Expert6 [label="Expert 6 GPU 22\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert6 [label=select style=dashed]
				R1_Stage2_L5_Expert7 [label="Expert 7 GPU 23\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert7 [label=select style=dashed]
				R1_Stage2_L5_Expert8 [label="Expert 8 GPU 24\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert8 [label=select style=dashed]
				R1_Stage2_L5_Expert9 [label="Expert 9 GPU 25\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert9 [label=select style=dashed]
				R1_Stage2_L5_Expert10 [label="Expert 10 GPU 26\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert10 [label=select style=dashed]
				R1_Stage2_L5_Expert11 [label="Expert 11 GPU 27\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert11 [label=select style=dashed]
				R1_Stage2_L5_Expert12 [label="Expert 12 GPU 28\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert12 [label=select style=dashed]
				R1_Stage2_L5_Expert13 [label="Expert 13 GPU 29\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert13 [label=select style=dashed]
				R1_Stage2_L5_Expert14 [label="Expert 14 GPU 30\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert14 [label=select style=dashed]
				R1_Stage2_L5_Expert15 [label="Expert 15 GPU 31\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L5_Router -> R1_Stage2_L5_Expert15 [label=select style=dashed]
				R1_Stage2_L5_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L5_Expert0 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert1 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert2 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert3 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert4 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert5 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert6 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert7 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert8 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert9 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert10 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert11 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert12 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert13 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert14 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Expert15 -> R1_Stage2_L5_MoE_Output
				R1_Stage2_L5_Output [label="Layer 5 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L5_MoE_Output -> R1_Stage2_L5_Output
				R1_Stage2_L6_Input [label="Layer 6 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L6_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L6_Input -> R1_Stage2_L6_Attn_Input
				R1_Stage2_L6_Attn_TP1 [label="Attention TP GPU 16\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Attn_TP2 [label="Attention TP GPU 17\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Attn_Input -> R1_Stage2_L6_Attn_TP1
				R1_Stage2_L6_Attn_Input -> R1_Stage2_L6_Attn_TP2
				R1_Stage2_L6_Attn_Output [label="Attention Output\nAllReduce GPUs 16-17\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L6_Attn_TP1 -> R1_Stage2_L6_Attn_Output
				R1_Stage2_L6_Attn_TP2 -> R1_Stage2_L6_Attn_Output
				R1_Stage2_L6_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L6_Attn_Output -> R1_Stage2_L6_MoE_Input
				R1_Stage2_L6_Router [label="Router GPU 16\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L6_MoE_Input -> R1_Stage2_L6_Router
				R1_Stage2_L6_Expert0 [label="Expert 0 GPU 16\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert0 [label=select style=dashed]
				R1_Stage2_L6_Expert1 [label="Expert 1 GPU 17\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert1 [label=select style=dashed]
				R1_Stage2_L6_Expert2 [label="Expert 2 GPU 18\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert2 [label=select style=dashed]
				R1_Stage2_L6_Expert3 [label="Expert 3 GPU 19\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert3 [label=select style=dashed]
				R1_Stage2_L6_Expert4 [label="Expert 4 GPU 20\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert4 [label=select style=dashed]
				R1_Stage2_L6_Expert5 [label="Expert 5 GPU 21\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert5 [label=select style=dashed]
				R1_Stage2_L6_Expert6 [label="Expert 6 GPU 22\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert6 [label=select style=dashed]
				R1_Stage2_L6_Expert7 [label="Expert 7 GPU 23\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert7 [label=select style=dashed]
				R1_Stage2_L6_Expert8 [label="Expert 8 GPU 24\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert8 [label=select style=dashed]
				R1_Stage2_L6_Expert9 [label="Expert 9 GPU 25\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert9 [label=select style=dashed]
				R1_Stage2_L6_Expert10 [label="Expert 10 GPU 26\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert10 [label=select style=dashed]
				R1_Stage2_L6_Expert11 [label="Expert 11 GPU 27\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert11 [label=select style=dashed]
				R1_Stage2_L6_Expert12 [label="Expert 12 GPU 28\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert12 [label=select style=dashed]
				R1_Stage2_L6_Expert13 [label="Expert 13 GPU 29\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert13 [label=select style=dashed]
				R1_Stage2_L6_Expert14 [label="Expert 14 GPU 30\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert14 [label=select style=dashed]
				R1_Stage2_L6_Expert15 [label="Expert 15 GPU 31\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L6_Router -> R1_Stage2_L6_Expert15 [label=select style=dashed]
				R1_Stage2_L6_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L6_Expert0 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert1 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert2 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert3 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert4 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert5 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert6 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert7 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert8 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert9 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert10 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert11 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert12 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert13 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert14 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Expert15 -> R1_Stage2_L6_MoE_Output
				R1_Stage2_L6_Output [label="Layer 6 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L6_MoE_Output -> R1_Stage2_L6_Output
				R1_Stage2_L7_Input [label="Layer 7 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L7_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L7_Input -> R1_Stage2_L7_Attn_Input
				R1_Stage2_L7_Attn_TP1 [label="Attention TP GPU 16\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Attn_TP2 [label="Attention TP GPU 17\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Attn_Input -> R1_Stage2_L7_Attn_TP1
				R1_Stage2_L7_Attn_Input -> R1_Stage2_L7_Attn_TP2
				R1_Stage2_L7_Attn_Output [label="Attention Output\nAllReduce GPUs 16-17\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L7_Attn_TP1 -> R1_Stage2_L7_Attn_Output
				R1_Stage2_L7_Attn_TP2 -> R1_Stage2_L7_Attn_Output
				R1_Stage2_L7_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L7_Attn_Output -> R1_Stage2_L7_MoE_Input
				R1_Stage2_L7_Router [label="Router GPU 16\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L7_MoE_Input -> R1_Stage2_L7_Router
				R1_Stage2_L7_Expert0 [label="Expert 0 GPU 16\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert0 [label=select style=dashed]
				R1_Stage2_L7_Expert1 [label="Expert 1 GPU 17\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert1 [label=select style=dashed]
				R1_Stage2_L7_Expert2 [label="Expert 2 GPU 18\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert2 [label=select style=dashed]
				R1_Stage2_L7_Expert3 [label="Expert 3 GPU 19\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert3 [label=select style=dashed]
				R1_Stage2_L7_Expert4 [label="Expert 4 GPU 20\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert4 [label=select style=dashed]
				R1_Stage2_L7_Expert5 [label="Expert 5 GPU 21\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert5 [label=select style=dashed]
				R1_Stage2_L7_Expert6 [label="Expert 6 GPU 22\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert6 [label=select style=dashed]
				R1_Stage2_L7_Expert7 [label="Expert 7 GPU 23\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert7 [label=select style=dashed]
				R1_Stage2_L7_Expert8 [label="Expert 8 GPU 24\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert8 [label=select style=dashed]
				R1_Stage2_L7_Expert9 [label="Expert 9 GPU 25\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert9 [label=select style=dashed]
				R1_Stage2_L7_Expert10 [label="Expert 10 GPU 26\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert10 [label=select style=dashed]
				R1_Stage2_L7_Expert11 [label="Expert 11 GPU 27\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert11 [label=select style=dashed]
				R1_Stage2_L7_Expert12 [label="Expert 12 GPU 28\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert12 [label=select style=dashed]
				R1_Stage2_L7_Expert13 [label="Expert 13 GPU 29\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert13 [label=select style=dashed]
				R1_Stage2_L7_Expert14 [label="Expert 14 GPU 30\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert14 [label=select style=dashed]
				R1_Stage2_L7_Expert15 [label="Expert 15 GPU 31\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L7_Router -> R1_Stage2_L7_Expert15 [label=select style=dashed]
				R1_Stage2_L7_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L7_Expert0 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert1 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert2 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert3 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert4 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert5 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert6 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert7 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert8 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert9 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert10 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert11 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert12 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert13 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert14 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Expert15 -> R1_Stage2_L7_MoE_Output
				R1_Stage2_L7_Output [label="Layer 7 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L7_MoE_Output -> R1_Stage2_L7_Output
				R1_Stage2_L8_Input [label="Layer 8 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L8_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L8_Input -> R1_Stage2_L8_Attn_Input
				R1_Stage2_L8_Attn_TP1 [label="Attention TP GPU 16\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Attn_TP2 [label="Attention TP GPU 17\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Attn_Input -> R1_Stage2_L8_Attn_TP1
				R1_Stage2_L8_Attn_Input -> R1_Stage2_L8_Attn_TP2
				R1_Stage2_L8_Attn_Output [label="Attention Output\nAllReduce GPUs 16-17\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L8_Attn_TP1 -> R1_Stage2_L8_Attn_Output
				R1_Stage2_L8_Attn_TP2 -> R1_Stage2_L8_Attn_Output
				R1_Stage2_L8_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L8_Attn_Output -> R1_Stage2_L8_MoE_Input
				R1_Stage2_L8_Router [label="Router GPU 16\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L8_MoE_Input -> R1_Stage2_L8_Router
				R1_Stage2_L8_Expert0 [label="Expert 0 GPU 16\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert0 [label=select style=dashed]
				R1_Stage2_L8_Expert1 [label="Expert 1 GPU 17\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert1 [label=select style=dashed]
				R1_Stage2_L8_Expert2 [label="Expert 2 GPU 18\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert2 [label=select style=dashed]
				R1_Stage2_L8_Expert3 [label="Expert 3 GPU 19\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert3 [label=select style=dashed]
				R1_Stage2_L8_Expert4 [label="Expert 4 GPU 20\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert4 [label=select style=dashed]
				R1_Stage2_L8_Expert5 [label="Expert 5 GPU 21\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert5 [label=select style=dashed]
				R1_Stage2_L8_Expert6 [label="Expert 6 GPU 22\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert6 [label=select style=dashed]
				R1_Stage2_L8_Expert7 [label="Expert 7 GPU 23\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert7 [label=select style=dashed]
				R1_Stage2_L8_Expert8 [label="Expert 8 GPU 24\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert8 [label=select style=dashed]
				R1_Stage2_L8_Expert9 [label="Expert 9 GPU 25\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert9 [label=select style=dashed]
				R1_Stage2_L8_Expert10 [label="Expert 10 GPU 26\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert10 [label=select style=dashed]
				R1_Stage2_L8_Expert11 [label="Expert 11 GPU 27\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert11 [label=select style=dashed]
				R1_Stage2_L8_Expert12 [label="Expert 12 GPU 28\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert12 [label=select style=dashed]
				R1_Stage2_L8_Expert13 [label="Expert 13 GPU 29\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert13 [label=select style=dashed]
				R1_Stage2_L8_Expert14 [label="Expert 14 GPU 30\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert14 [label=select style=dashed]
				R1_Stage2_L8_Expert15 [label="Expert 15 GPU 31\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage2_L8_Router -> R1_Stage2_L8_Expert15 [label=select style=dashed]
				R1_Stage2_L8_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage2_L8_Expert0 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert1 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert2 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert3 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert4 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert5 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert6 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert7 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert8 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert9 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert10 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert11 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert12 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert13 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert14 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Expert15 -> R1_Stage2_L8_MoE_Output
				R1_Stage2_L8_Output [label="Layer 8 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage2_L8_MoE_Output -> R1_Stage2_L8_Output
				R1_Stage2_Output [label="Stage2 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			subgraph cluster_R1_Stage3 {
				fillcolor=lightgreen label="Stage3: Layers 9-12 (16 GPUs)" style="rounded,filled"
				R1_Stage3_Input [label="Stage3 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L9_Input [label="Layer 9 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L9_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L9_Input -> R1_Stage3_L9_Attn_Input
				R1_Stage3_L9_Attn_TP1 [label="Attention TP GPU 32\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Attn_TP2 [label="Attention TP GPU 33\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Attn_Input -> R1_Stage3_L9_Attn_TP1
				R1_Stage3_L9_Attn_Input -> R1_Stage3_L9_Attn_TP2
				R1_Stage3_L9_Attn_Output [label="Attention Output\nAllReduce GPUs 32-33\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L9_Attn_TP1 -> R1_Stage3_L9_Attn_Output
				R1_Stage3_L9_Attn_TP2 -> R1_Stage3_L9_Attn_Output
				R1_Stage3_L9_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L9_Attn_Output -> R1_Stage3_L9_MoE_Input
				R1_Stage3_L9_Router [label="Router GPU 32\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L9_MoE_Input -> R1_Stage3_L9_Router
				R1_Stage3_L9_Expert0 [label="Expert 0 GPU 32\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert0 [label=select style=dashed]
				R1_Stage3_L9_Expert1 [label="Expert 1 GPU 33\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert1 [label=select style=dashed]
				R1_Stage3_L9_Expert2 [label="Expert 2 GPU 34\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert2 [label=select style=dashed]
				R1_Stage3_L9_Expert3 [label="Expert 3 GPU 35\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert3 [label=select style=dashed]
				R1_Stage3_L9_Expert4 [label="Expert 4 GPU 36\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert4 [label=select style=dashed]
				R1_Stage3_L9_Expert5 [label="Expert 5 GPU 37\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert5 [label=select style=dashed]
				R1_Stage3_L9_Expert6 [label="Expert 6 GPU 38\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert6 [label=select style=dashed]
				R1_Stage3_L9_Expert7 [label="Expert 7 GPU 39\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert7 [label=select style=dashed]
				R1_Stage3_L9_Expert8 [label="Expert 8 GPU 40\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert8 [label=select style=dashed]
				R1_Stage3_L9_Expert9 [label="Expert 9 GPU 41\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert9 [label=select style=dashed]
				R1_Stage3_L9_Expert10 [label="Expert 10 GPU 42\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert10 [label=select style=dashed]
				R1_Stage3_L9_Expert11 [label="Expert 11 GPU 43\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert11 [label=select style=dashed]
				R1_Stage3_L9_Expert12 [label="Expert 12 GPU 44\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert12 [label=select style=dashed]
				R1_Stage3_L9_Expert13 [label="Expert 13 GPU 45\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert13 [label=select style=dashed]
				R1_Stage3_L9_Expert14 [label="Expert 14 GPU 46\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert14 [label=select style=dashed]
				R1_Stage3_L9_Expert15 [label="Expert 15 GPU 47\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L9_Router -> R1_Stage3_L9_Expert15 [label=select style=dashed]
				R1_Stage3_L9_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L9_Expert0 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert1 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert2 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert3 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert4 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert5 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert6 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert7 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert8 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert9 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert10 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert11 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert12 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert13 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert14 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Expert15 -> R1_Stage3_L9_MoE_Output
				R1_Stage3_L9_Output [label="Layer 9 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L9_MoE_Output -> R1_Stage3_L9_Output
				R1_Stage3_L10_Input [label="Layer 10 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L10_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L10_Input -> R1_Stage3_L10_Attn_Input
				R1_Stage3_L10_Attn_TP1 [label="Attention TP GPU 32\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Attn_TP2 [label="Attention TP GPU 33\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Attn_Input -> R1_Stage3_L10_Attn_TP1
				R1_Stage3_L10_Attn_Input -> R1_Stage3_L10_Attn_TP2
				R1_Stage3_L10_Attn_Output [label="Attention Output\nAllReduce GPUs 32-33\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L10_Attn_TP1 -> R1_Stage3_L10_Attn_Output
				R1_Stage3_L10_Attn_TP2 -> R1_Stage3_L10_Attn_Output
				R1_Stage3_L10_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L10_Attn_Output -> R1_Stage3_L10_MoE_Input
				R1_Stage3_L10_Router [label="Router GPU 32\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L10_MoE_Input -> R1_Stage3_L10_Router
				R1_Stage3_L10_Expert0 [label="Expert 0 GPU 32\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert0 [label=select style=dashed]
				R1_Stage3_L10_Expert1 [label="Expert 1 GPU 33\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert1 [label=select style=dashed]
				R1_Stage3_L10_Expert2 [label="Expert 2 GPU 34\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert2 [label=select style=dashed]
				R1_Stage3_L10_Expert3 [label="Expert 3 GPU 35\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert3 [label=select style=dashed]
				R1_Stage3_L10_Expert4 [label="Expert 4 GPU 36\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert4 [label=select style=dashed]
				R1_Stage3_L10_Expert5 [label="Expert 5 GPU 37\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert5 [label=select style=dashed]
				R1_Stage3_L10_Expert6 [label="Expert 6 GPU 38\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert6 [label=select style=dashed]
				R1_Stage3_L10_Expert7 [label="Expert 7 GPU 39\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert7 [label=select style=dashed]
				R1_Stage3_L10_Expert8 [label="Expert 8 GPU 40\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert8 [label=select style=dashed]
				R1_Stage3_L10_Expert9 [label="Expert 9 GPU 41\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert9 [label=select style=dashed]
				R1_Stage3_L10_Expert10 [label="Expert 10 GPU 42\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert10 [label=select style=dashed]
				R1_Stage3_L10_Expert11 [label="Expert 11 GPU 43\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert11 [label=select style=dashed]
				R1_Stage3_L10_Expert12 [label="Expert 12 GPU 44\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert12 [label=select style=dashed]
				R1_Stage3_L10_Expert13 [label="Expert 13 GPU 45\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert13 [label=select style=dashed]
				R1_Stage3_L10_Expert14 [label="Expert 14 GPU 46\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert14 [label=select style=dashed]
				R1_Stage3_L10_Expert15 [label="Expert 15 GPU 47\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L10_Router -> R1_Stage3_L10_Expert15 [label=select style=dashed]
				R1_Stage3_L10_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L10_Expert0 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert1 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert2 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert3 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert4 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert5 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert6 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert7 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert8 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert9 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert10 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert11 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert12 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert13 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert14 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Expert15 -> R1_Stage3_L10_MoE_Output
				R1_Stage3_L10_Output [label="Layer 10 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L10_MoE_Output -> R1_Stage3_L10_Output
				R1_Stage3_L11_Input [label="Layer 11 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L11_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L11_Input -> R1_Stage3_L11_Attn_Input
				R1_Stage3_L11_Attn_TP1 [label="Attention TP GPU 32\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Attn_TP2 [label="Attention TP GPU 33\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Attn_Input -> R1_Stage3_L11_Attn_TP1
				R1_Stage3_L11_Attn_Input -> R1_Stage3_L11_Attn_TP2
				R1_Stage3_L11_Attn_Output [label="Attention Output\nAllReduce GPUs 32-33\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L11_Attn_TP1 -> R1_Stage3_L11_Attn_Output
				R1_Stage3_L11_Attn_TP2 -> R1_Stage3_L11_Attn_Output
				R1_Stage3_L11_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L11_Attn_Output -> R1_Stage3_L11_MoE_Input
				R1_Stage3_L11_Router [label="Router GPU 32\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L11_MoE_Input -> R1_Stage3_L11_Router
				R1_Stage3_L11_Expert0 [label="Expert 0 GPU 32\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert0 [label=select style=dashed]
				R1_Stage3_L11_Expert1 [label="Expert 1 GPU 33\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert1 [label=select style=dashed]
				R1_Stage3_L11_Expert2 [label="Expert 2 GPU 34\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert2 [label=select style=dashed]
				R1_Stage3_L11_Expert3 [label="Expert 3 GPU 35\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert3 [label=select style=dashed]
				R1_Stage3_L11_Expert4 [label="Expert 4 GPU 36\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert4 [label=select style=dashed]
				R1_Stage3_L11_Expert5 [label="Expert 5 GPU 37\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert5 [label=select style=dashed]
				R1_Stage3_L11_Expert6 [label="Expert 6 GPU 38\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert6 [label=select style=dashed]
				R1_Stage3_L11_Expert7 [label="Expert 7 GPU 39\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert7 [label=select style=dashed]
				R1_Stage3_L11_Expert8 [label="Expert 8 GPU 40\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert8 [label=select style=dashed]
				R1_Stage3_L11_Expert9 [label="Expert 9 GPU 41\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert9 [label=select style=dashed]
				R1_Stage3_L11_Expert10 [label="Expert 10 GPU 42\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert10 [label=select style=dashed]
				R1_Stage3_L11_Expert11 [label="Expert 11 GPU 43\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert11 [label=select style=dashed]
				R1_Stage3_L11_Expert12 [label="Expert 12 GPU 44\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert12 [label=select style=dashed]
				R1_Stage3_L11_Expert13 [label="Expert 13 GPU 45\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert13 [label=select style=dashed]
				R1_Stage3_L11_Expert14 [label="Expert 14 GPU 46\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert14 [label=select style=dashed]
				R1_Stage3_L11_Expert15 [label="Expert 15 GPU 47\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L11_Router -> R1_Stage3_L11_Expert15 [label=select style=dashed]
				R1_Stage3_L11_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L11_Expert0 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert1 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert2 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert3 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert4 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert5 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert6 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert7 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert8 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert9 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert10 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert11 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert12 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert13 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert14 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Expert15 -> R1_Stage3_L11_MoE_Output
				R1_Stage3_L11_Output [label="Layer 11 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L11_MoE_Output -> R1_Stage3_L11_Output
				R1_Stage3_L12_Input [label="Layer 12 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L12_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L12_Input -> R1_Stage3_L12_Attn_Input
				R1_Stage3_L12_Attn_TP1 [label="Attention TP GPU 32\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Attn_TP2 [label="Attention TP GPU 33\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Attn_Input -> R1_Stage3_L12_Attn_TP1
				R1_Stage3_L12_Attn_Input -> R1_Stage3_L12_Attn_TP2
				R1_Stage3_L12_Attn_Output [label="Attention Output\nAllReduce GPUs 32-33\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L12_Attn_TP1 -> R1_Stage3_L12_Attn_Output
				R1_Stage3_L12_Attn_TP2 -> R1_Stage3_L12_Attn_Output
				R1_Stage3_L12_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L12_Attn_Output -> R1_Stage3_L12_MoE_Input
				R1_Stage3_L12_Router [label="Router GPU 32\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L12_MoE_Input -> R1_Stage3_L12_Router
				R1_Stage3_L12_Expert0 [label="Expert 0 GPU 32\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert0 [label=select style=dashed]
				R1_Stage3_L12_Expert1 [label="Expert 1 GPU 33\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert1 [label=select style=dashed]
				R1_Stage3_L12_Expert2 [label="Expert 2 GPU 34\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert2 [label=select style=dashed]
				R1_Stage3_L12_Expert3 [label="Expert 3 GPU 35\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert3 [label=select style=dashed]
				R1_Stage3_L12_Expert4 [label="Expert 4 GPU 36\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert4 [label=select style=dashed]
				R1_Stage3_L12_Expert5 [label="Expert 5 GPU 37\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert5 [label=select style=dashed]
				R1_Stage3_L12_Expert6 [label="Expert 6 GPU 38\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert6 [label=select style=dashed]
				R1_Stage3_L12_Expert7 [label="Expert 7 GPU 39\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert7 [label=select style=dashed]
				R1_Stage3_L12_Expert8 [label="Expert 8 GPU 40\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert8 [label=select style=dashed]
				R1_Stage3_L12_Expert9 [label="Expert 9 GPU 41\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert9 [label=select style=dashed]
				R1_Stage3_L12_Expert10 [label="Expert 10 GPU 42\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert10 [label=select style=dashed]
				R1_Stage3_L12_Expert11 [label="Expert 11 GPU 43\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert11 [label=select style=dashed]
				R1_Stage3_L12_Expert12 [label="Expert 12 GPU 44\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert12 [label=select style=dashed]
				R1_Stage3_L12_Expert13 [label="Expert 13 GPU 45\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert13 [label=select style=dashed]
				R1_Stage3_L12_Expert14 [label="Expert 14 GPU 46\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert14 [label=select style=dashed]
				R1_Stage3_L12_Expert15 [label="Expert 15 GPU 47\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage3_L12_Router -> R1_Stage3_L12_Expert15 [label=select style=dashed]
				R1_Stage3_L12_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage3_L12_Expert0 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert1 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert2 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert3 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert4 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert5 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert6 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert7 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert8 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert9 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert10 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert11 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert12 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert13 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert14 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Expert15 -> R1_Stage3_L12_MoE_Output
				R1_Stage3_L12_Output [label="Layer 12 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage3_L12_MoE_Output -> R1_Stage3_L12_Output
				R1_Stage3_Output [label="Stage3 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			subgraph cluster_R1_Stage4 {
				fillcolor=lightgreen label="Stage4: Layers 13-16 (16 GPUs)" style="rounded,filled"
				R1_Stage4_Input [label="Stage4 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L13_Input [label="Layer 13 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L13_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L13_Input -> R1_Stage4_L13_Attn_Input
				R1_Stage4_L13_Attn_TP1 [label="Attention TP GPU 48\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Attn_TP2 [label="Attention TP GPU 49\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Attn_Input -> R1_Stage4_L13_Attn_TP1
				R1_Stage4_L13_Attn_Input -> R1_Stage4_L13_Attn_TP2
				R1_Stage4_L13_Attn_Output [label="Attention Output\nAllReduce GPUs 48-49\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L13_Attn_TP1 -> R1_Stage4_L13_Attn_Output
				R1_Stage4_L13_Attn_TP2 -> R1_Stage4_L13_Attn_Output
				R1_Stage4_L13_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L13_Attn_Output -> R1_Stage4_L13_MoE_Input
				R1_Stage4_L13_Router [label="Router GPU 48\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L13_MoE_Input -> R1_Stage4_L13_Router
				R1_Stage4_L13_Expert0 [label="Expert 0 GPU 48\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert0 [label=select style=dashed]
				R1_Stage4_L13_Expert1 [label="Expert 1 GPU 49\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert1 [label=select style=dashed]
				R1_Stage4_L13_Expert2 [label="Expert 2 GPU 50\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert2 [label=select style=dashed]
				R1_Stage4_L13_Expert3 [label="Expert 3 GPU 51\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert3 [label=select style=dashed]
				R1_Stage4_L13_Expert4 [label="Expert 4 GPU 52\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert4 [label=select style=dashed]
				R1_Stage4_L13_Expert5 [label="Expert 5 GPU 53\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert5 [label=select style=dashed]
				R1_Stage4_L13_Expert6 [label="Expert 6 GPU 54\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert6 [label=select style=dashed]
				R1_Stage4_L13_Expert7 [label="Expert 7 GPU 55\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert7 [label=select style=dashed]
				R1_Stage4_L13_Expert8 [label="Expert 8 GPU 56\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert8 [label=select style=dashed]
				R1_Stage4_L13_Expert9 [label="Expert 9 GPU 57\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert9 [label=select style=dashed]
				R1_Stage4_L13_Expert10 [label="Expert 10 GPU 58\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert10 [label=select style=dashed]
				R1_Stage4_L13_Expert11 [label="Expert 11 GPU 59\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert11 [label=select style=dashed]
				R1_Stage4_L13_Expert12 [label="Expert 12 GPU 60\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert12 [label=select style=dashed]
				R1_Stage4_L13_Expert13 [label="Expert 13 GPU 61\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert13 [label=select style=dashed]
				R1_Stage4_L13_Expert14 [label="Expert 14 GPU 62\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert14 [label=select style=dashed]
				R1_Stage4_L13_Expert15 [label="Expert 15 GPU 63\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L13_Router -> R1_Stage4_L13_Expert15 [label=select style=dashed]
				R1_Stage4_L13_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L13_Expert0 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert1 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert2 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert3 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert4 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert5 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert6 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert7 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert8 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert9 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert10 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert11 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert12 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert13 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert14 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Expert15 -> R1_Stage4_L13_MoE_Output
				R1_Stage4_L13_Output [label="Layer 13 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L13_MoE_Output -> R1_Stage4_L13_Output
				R1_Stage4_L14_Input [label="Layer 14 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L14_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L14_Input -> R1_Stage4_L14_Attn_Input
				R1_Stage4_L14_Attn_TP1 [label="Attention TP GPU 48\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Attn_TP2 [label="Attention TP GPU 49\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Attn_Input -> R1_Stage4_L14_Attn_TP1
				R1_Stage4_L14_Attn_Input -> R1_Stage4_L14_Attn_TP2
				R1_Stage4_L14_Attn_Output [label="Attention Output\nAllReduce GPUs 48-49\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L14_Attn_TP1 -> R1_Stage4_L14_Attn_Output
				R1_Stage4_L14_Attn_TP2 -> R1_Stage4_L14_Attn_Output
				R1_Stage4_L14_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L14_Attn_Output -> R1_Stage4_L14_MoE_Input
				R1_Stage4_L14_Router [label="Router GPU 48\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L14_MoE_Input -> R1_Stage4_L14_Router
				R1_Stage4_L14_Expert0 [label="Expert 0 GPU 48\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert0 [label=select style=dashed]
				R1_Stage4_L14_Expert1 [label="Expert 1 GPU 49\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert1 [label=select style=dashed]
				R1_Stage4_L14_Expert2 [label="Expert 2 GPU 50\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert2 [label=select style=dashed]
				R1_Stage4_L14_Expert3 [label="Expert 3 GPU 51\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert3 [label=select style=dashed]
				R1_Stage4_L14_Expert4 [label="Expert 4 GPU 52\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert4 [label=select style=dashed]
				R1_Stage4_L14_Expert5 [label="Expert 5 GPU 53\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert5 [label=select style=dashed]
				R1_Stage4_L14_Expert6 [label="Expert 6 GPU 54\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert6 [label=select style=dashed]
				R1_Stage4_L14_Expert7 [label="Expert 7 GPU 55\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert7 [label=select style=dashed]
				R1_Stage4_L14_Expert8 [label="Expert 8 GPU 56\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert8 [label=select style=dashed]
				R1_Stage4_L14_Expert9 [label="Expert 9 GPU 57\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert9 [label=select style=dashed]
				R1_Stage4_L14_Expert10 [label="Expert 10 GPU 58\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert10 [label=select style=dashed]
				R1_Stage4_L14_Expert11 [label="Expert 11 GPU 59\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert11 [label=select style=dashed]
				R1_Stage4_L14_Expert12 [label="Expert 12 GPU 60\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert12 [label=select style=dashed]
				R1_Stage4_L14_Expert13 [label="Expert 13 GPU 61\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert13 [label=select style=dashed]
				R1_Stage4_L14_Expert14 [label="Expert 14 GPU 62\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert14 [label=select style=dashed]
				R1_Stage4_L14_Expert15 [label="Expert 15 GPU 63\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L14_Router -> R1_Stage4_L14_Expert15 [label=select style=dashed]
				R1_Stage4_L14_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L14_Expert0 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert1 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert2 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert3 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert4 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert5 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert6 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert7 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert8 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert9 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert10 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert11 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert12 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert13 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert14 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Expert15 -> R1_Stage4_L14_MoE_Output
				R1_Stage4_L14_Output [label="Layer 14 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L14_MoE_Output -> R1_Stage4_L14_Output
				R1_Stage4_L15_Input [label="Layer 15 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L15_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L15_Input -> R1_Stage4_L15_Attn_Input
				R1_Stage4_L15_Attn_TP1 [label="Attention TP GPU 48\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Attn_TP2 [label="Attention TP GPU 49\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Attn_Input -> R1_Stage4_L15_Attn_TP1
				R1_Stage4_L15_Attn_Input -> R1_Stage4_L15_Attn_TP2
				R1_Stage4_L15_Attn_Output [label="Attention Output\nAllReduce GPUs 48-49\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L15_Attn_TP1 -> R1_Stage4_L15_Attn_Output
				R1_Stage4_L15_Attn_TP2 -> R1_Stage4_L15_Attn_Output
				R1_Stage4_L15_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L15_Attn_Output -> R1_Stage4_L15_MoE_Input
				R1_Stage4_L15_Router [label="Router GPU 48\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L15_MoE_Input -> R1_Stage4_L15_Router
				R1_Stage4_L15_Expert0 [label="Expert 0 GPU 48\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert0 [label=select style=dashed]
				R1_Stage4_L15_Expert1 [label="Expert 1 GPU 49\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert1 [label=select style=dashed]
				R1_Stage4_L15_Expert2 [label="Expert 2 GPU 50\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert2 [label=select style=dashed]
				R1_Stage4_L15_Expert3 [label="Expert 3 GPU 51\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert3 [label=select style=dashed]
				R1_Stage4_L15_Expert4 [label="Expert 4 GPU 52\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert4 [label=select style=dashed]
				R1_Stage4_L15_Expert5 [label="Expert 5 GPU 53\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert5 [label=select style=dashed]
				R1_Stage4_L15_Expert6 [label="Expert 6 GPU 54\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert6 [label=select style=dashed]
				R1_Stage4_L15_Expert7 [label="Expert 7 GPU 55\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert7 [label=select style=dashed]
				R1_Stage4_L15_Expert8 [label="Expert 8 GPU 56\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert8 [label=select style=dashed]
				R1_Stage4_L15_Expert9 [label="Expert 9 GPU 57\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert9 [label=select style=dashed]
				R1_Stage4_L15_Expert10 [label="Expert 10 GPU 58\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert10 [label=select style=dashed]
				R1_Stage4_L15_Expert11 [label="Expert 11 GPU 59\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert11 [label=select style=dashed]
				R1_Stage4_L15_Expert12 [label="Expert 12 GPU 60\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert12 [label=select style=dashed]
				R1_Stage4_L15_Expert13 [label="Expert 13 GPU 61\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert13 [label=select style=dashed]
				R1_Stage4_L15_Expert14 [label="Expert 14 GPU 62\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert14 [label=select style=dashed]
				R1_Stage4_L15_Expert15 [label="Expert 15 GPU 63\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L15_Router -> R1_Stage4_L15_Expert15 [label=select style=dashed]
				R1_Stage4_L15_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L15_Expert0 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert1 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert2 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert3 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert4 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert5 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert6 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert7 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert8 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert9 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert10 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert11 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert12 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert13 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert14 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Expert15 -> R1_Stage4_L15_MoE_Output
				R1_Stage4_L15_Output [label="Layer 15 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L15_MoE_Output -> R1_Stage4_L15_Output
				R1_Stage4_L16_Input [label="Layer 16 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L16_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L16_Input -> R1_Stage4_L16_Attn_Input
				R1_Stage4_L16_Attn_TP1 [label="Attention TP GPU 48\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Attn_TP2 [label="Attention TP GPU 49\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Attn_Input -> R1_Stage4_L16_Attn_TP1
				R1_Stage4_L16_Attn_Input -> R1_Stage4_L16_Attn_TP2
				R1_Stage4_L16_Attn_Output [label="Attention Output\nAllReduce GPUs 48-49\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L16_Attn_TP1 -> R1_Stage4_L16_Attn_Output
				R1_Stage4_L16_Attn_TP2 -> R1_Stage4_L16_Attn_Output
				R1_Stage4_L16_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L16_Attn_Output -> R1_Stage4_L16_MoE_Input
				R1_Stage4_L16_Router [label="Router GPU 48\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L16_MoE_Input -> R1_Stage4_L16_Router
				R1_Stage4_L16_Expert0 [label="Expert 0 GPU 48\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert0 [label=select style=dashed]
				R1_Stage4_L16_Expert1 [label="Expert 1 GPU 49\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert1 [label=select style=dashed]
				R1_Stage4_L16_Expert2 [label="Expert 2 GPU 50\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert2 [label=select style=dashed]
				R1_Stage4_L16_Expert3 [label="Expert 3 GPU 51\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert3 [label=select style=dashed]
				R1_Stage4_L16_Expert4 [label="Expert 4 GPU 52\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert4 [label=select style=dashed]
				R1_Stage4_L16_Expert5 [label="Expert 5 GPU 53\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert5 [label=select style=dashed]
				R1_Stage4_L16_Expert6 [label="Expert 6 GPU 54\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert6 [label=select style=dashed]
				R1_Stage4_L16_Expert7 [label="Expert 7 GPU 55\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert7 [label=select style=dashed]
				R1_Stage4_L16_Expert8 [label="Expert 8 GPU 56\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert8 [label=select style=dashed]
				R1_Stage4_L16_Expert9 [label="Expert 9 GPU 57\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert9 [label=select style=dashed]
				R1_Stage4_L16_Expert10 [label="Expert 10 GPU 58\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert10 [label=select style=dashed]
				R1_Stage4_L16_Expert11 [label="Expert 11 GPU 59\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert11 [label=select style=dashed]
				R1_Stage4_L16_Expert12 [label="Expert 12 GPU 60\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert12 [label=select style=dashed]
				R1_Stage4_L16_Expert13 [label="Expert 13 GPU 61\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert13 [label=select style=dashed]
				R1_Stage4_L16_Expert14 [label="Expert 14 GPU 62\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert14 [label=select style=dashed]
				R1_Stage4_L16_Expert15 [label="Expert 15 GPU 63\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R1_Stage4_L16_Router -> R1_Stage4_L16_Expert15 [label=select style=dashed]
				R1_Stage4_L16_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R1_Stage4_L16_Expert0 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert1 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert2 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert3 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert4 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert5 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert6 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert7 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert8 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert9 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert10 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert11 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert12 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert13 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert14 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Expert15 -> R1_Stage4_L16_MoE_Output
				R1_Stage4_L16_Output [label="Layer 16 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R1_Stage4_L16_MoE_Output -> R1_Stage4_L16_Output
				R1_Stage4_Output [label="Stage4 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			R1_Output [label="Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
		}
		subgraph cluster_replica2 {
			fillcolor=lightblue label="Pipeline Replica 2 (64 GPUs)" style="rounded,filled"
			R2_Input [label="Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			subgraph cluster_R2_Stage1 {
				fillcolor=lightgreen label="Stage1: Layers 1-4 (16 GPUs)" style="rounded,filled"
				R2_Stage1_Input [label="Stage1 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L1_Input [label="Layer 1 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L1_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L1_Input -> R2_Stage1_L1_Attn_Input
				R2_Stage1_L1_Attn_TP1 [label="Attention TP GPU 64\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Attn_TP2 [label="Attention TP GPU 65\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Attn_Input -> R2_Stage1_L1_Attn_TP1
				R2_Stage1_L1_Attn_Input -> R2_Stage1_L1_Attn_TP2
				R2_Stage1_L1_Attn_Output [label="Attention Output\nAllReduce GPUs 64-65\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L1_Attn_TP1 -> R2_Stage1_L1_Attn_Output
				R2_Stage1_L1_Attn_TP2 -> R2_Stage1_L1_Attn_Output
				R2_Stage1_L1_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L1_Attn_Output -> R2_Stage1_L1_MoE_Input
				R2_Stage1_L1_Router [label="Router GPU 64\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L1_MoE_Input -> R2_Stage1_L1_Router
				R2_Stage1_L1_Expert0 [label="Expert 0 GPU 64\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert0 [label=select style=dashed]
				R2_Stage1_L1_Expert1 [label="Expert 1 GPU 65\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert1 [label=select style=dashed]
				R2_Stage1_L1_Expert2 [label="Expert 2 GPU 66\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert2 [label=select style=dashed]
				R2_Stage1_L1_Expert3 [label="Expert 3 GPU 67\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert3 [label=select style=dashed]
				R2_Stage1_L1_Expert4 [label="Expert 4 GPU 68\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert4 [label=select style=dashed]
				R2_Stage1_L1_Expert5 [label="Expert 5 GPU 69\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert5 [label=select style=dashed]
				R2_Stage1_L1_Expert6 [label="Expert 6 GPU 70\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert6 [label=select style=dashed]
				R2_Stage1_L1_Expert7 [label="Expert 7 GPU 71\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert7 [label=select style=dashed]
				R2_Stage1_L1_Expert8 [label="Expert 8 GPU 72\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert8 [label=select style=dashed]
				R2_Stage1_L1_Expert9 [label="Expert 9 GPU 73\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert9 [label=select style=dashed]
				R2_Stage1_L1_Expert10 [label="Expert 10 GPU 74\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert10 [label=select style=dashed]
				R2_Stage1_L1_Expert11 [label="Expert 11 GPU 75\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert11 [label=select style=dashed]
				R2_Stage1_L1_Expert12 [label="Expert 12 GPU 76\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert12 [label=select style=dashed]
				R2_Stage1_L1_Expert13 [label="Expert 13 GPU 77\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert13 [label=select style=dashed]
				R2_Stage1_L1_Expert14 [label="Expert 14 GPU 78\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert14 [label=select style=dashed]
				R2_Stage1_L1_Expert15 [label="Expert 15 GPU 79\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L1_Router -> R2_Stage1_L1_Expert15 [label=select style=dashed]
				R2_Stage1_L1_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L1_Expert0 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert1 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert2 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert3 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert4 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert5 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert6 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert7 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert8 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert9 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert10 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert11 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert12 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert13 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert14 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Expert15 -> R2_Stage1_L1_MoE_Output
				R2_Stage1_L1_Output [label="Layer 1 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L1_MoE_Output -> R2_Stage1_L1_Output
				R2_Stage1_L2_Input [label="Layer 2 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L2_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L2_Input -> R2_Stage1_L2_Attn_Input
				R2_Stage1_L2_Attn_TP1 [label="Attention TP GPU 64\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Attn_TP2 [label="Attention TP GPU 65\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Attn_Input -> R2_Stage1_L2_Attn_TP1
				R2_Stage1_L2_Attn_Input -> R2_Stage1_L2_Attn_TP2
				R2_Stage1_L2_Attn_Output [label="Attention Output\nAllReduce GPUs 64-65\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L2_Attn_TP1 -> R2_Stage1_L2_Attn_Output
				R2_Stage1_L2_Attn_TP2 -> R2_Stage1_L2_Attn_Output
				R2_Stage1_L2_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L2_Attn_Output -> R2_Stage1_L2_MoE_Input
				R2_Stage1_L2_Router [label="Router GPU 64\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L2_MoE_Input -> R2_Stage1_L2_Router
				R2_Stage1_L2_Expert0 [label="Expert 0 GPU 64\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert0 [label=select style=dashed]
				R2_Stage1_L2_Expert1 [label="Expert 1 GPU 65\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert1 [label=select style=dashed]
				R2_Stage1_L2_Expert2 [label="Expert 2 GPU 66\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert2 [label=select style=dashed]
				R2_Stage1_L2_Expert3 [label="Expert 3 GPU 67\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert3 [label=select style=dashed]
				R2_Stage1_L2_Expert4 [label="Expert 4 GPU 68\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert4 [label=select style=dashed]
				R2_Stage1_L2_Expert5 [label="Expert 5 GPU 69\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert5 [label=select style=dashed]
				R2_Stage1_L2_Expert6 [label="Expert 6 GPU 70\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert6 [label=select style=dashed]
				R2_Stage1_L2_Expert7 [label="Expert 7 GPU 71\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert7 [label=select style=dashed]
				R2_Stage1_L2_Expert8 [label="Expert 8 GPU 72\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert8 [label=select style=dashed]
				R2_Stage1_L2_Expert9 [label="Expert 9 GPU 73\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert9 [label=select style=dashed]
				R2_Stage1_L2_Expert10 [label="Expert 10 GPU 74\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert10 [label=select style=dashed]
				R2_Stage1_L2_Expert11 [label="Expert 11 GPU 75\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert11 [label=select style=dashed]
				R2_Stage1_L2_Expert12 [label="Expert 12 GPU 76\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert12 [label=select style=dashed]
				R2_Stage1_L2_Expert13 [label="Expert 13 GPU 77\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert13 [label=select style=dashed]
				R2_Stage1_L2_Expert14 [label="Expert 14 GPU 78\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert14 [label=select style=dashed]
				R2_Stage1_L2_Expert15 [label="Expert 15 GPU 79\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L2_Router -> R2_Stage1_L2_Expert15 [label=select style=dashed]
				R2_Stage1_L2_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L2_Expert0 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert1 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert2 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert3 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert4 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert5 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert6 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert7 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert8 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert9 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert10 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert11 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert12 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert13 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert14 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Expert15 -> R2_Stage1_L2_MoE_Output
				R2_Stage1_L2_Output [label="Layer 2 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L2_MoE_Output -> R2_Stage1_L2_Output
				R2_Stage1_L3_Input [label="Layer 3 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L3_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L3_Input -> R2_Stage1_L3_Attn_Input
				R2_Stage1_L3_Attn_TP1 [label="Attention TP GPU 64\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Attn_TP2 [label="Attention TP GPU 65\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Attn_Input -> R2_Stage1_L3_Attn_TP1
				R2_Stage1_L3_Attn_Input -> R2_Stage1_L3_Attn_TP2
				R2_Stage1_L3_Attn_Output [label="Attention Output\nAllReduce GPUs 64-65\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L3_Attn_TP1 -> R2_Stage1_L3_Attn_Output
				R2_Stage1_L3_Attn_TP2 -> R2_Stage1_L3_Attn_Output
				R2_Stage1_L3_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L3_Attn_Output -> R2_Stage1_L3_MoE_Input
				R2_Stage1_L3_Router [label="Router GPU 64\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L3_MoE_Input -> R2_Stage1_L3_Router
				R2_Stage1_L3_Expert0 [label="Expert 0 GPU 64\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert0 [label=select style=dashed]
				R2_Stage1_L3_Expert1 [label="Expert 1 GPU 65\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert1 [label=select style=dashed]
				R2_Stage1_L3_Expert2 [label="Expert 2 GPU 66\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert2 [label=select style=dashed]
				R2_Stage1_L3_Expert3 [label="Expert 3 GPU 67\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert3 [label=select style=dashed]
				R2_Stage1_L3_Expert4 [label="Expert 4 GPU 68\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert4 [label=select style=dashed]
				R2_Stage1_L3_Expert5 [label="Expert 5 GPU 69\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert5 [label=select style=dashed]
				R2_Stage1_L3_Expert6 [label="Expert 6 GPU 70\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert6 [label=select style=dashed]
				R2_Stage1_L3_Expert7 [label="Expert 7 GPU 71\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert7 [label=select style=dashed]
				R2_Stage1_L3_Expert8 [label="Expert 8 GPU 72\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert8 [label=select style=dashed]
				R2_Stage1_L3_Expert9 [label="Expert 9 GPU 73\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert9 [label=select style=dashed]
				R2_Stage1_L3_Expert10 [label="Expert 10 GPU 74\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert10 [label=select style=dashed]
				R2_Stage1_L3_Expert11 [label="Expert 11 GPU 75\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert11 [label=select style=dashed]
				R2_Stage1_L3_Expert12 [label="Expert 12 GPU 76\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert12 [label=select style=dashed]
				R2_Stage1_L3_Expert13 [label="Expert 13 GPU 77\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert13 [label=select style=dashed]
				R2_Stage1_L3_Expert14 [label="Expert 14 GPU 78\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert14 [label=select style=dashed]
				R2_Stage1_L3_Expert15 [label="Expert 15 GPU 79\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L3_Router -> R2_Stage1_L3_Expert15 [label=select style=dashed]
				R2_Stage1_L3_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L3_Expert0 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert1 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert2 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert3 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert4 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert5 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert6 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert7 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert8 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert9 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert10 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert11 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert12 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert13 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert14 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Expert15 -> R2_Stage1_L3_MoE_Output
				R2_Stage1_L3_Output [label="Layer 3 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L3_MoE_Output -> R2_Stage1_L3_Output
				R2_Stage1_L4_Input [label="Layer 4 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L4_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L4_Input -> R2_Stage1_L4_Attn_Input
				R2_Stage1_L4_Attn_TP1 [label="Attention TP GPU 64\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Attn_TP2 [label="Attention TP GPU 65\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Attn_Input -> R2_Stage1_L4_Attn_TP1
				R2_Stage1_L4_Attn_Input -> R2_Stage1_L4_Attn_TP2
				R2_Stage1_L4_Attn_Output [label="Attention Output\nAllReduce GPUs 64-65\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L4_Attn_TP1 -> R2_Stage1_L4_Attn_Output
				R2_Stage1_L4_Attn_TP2 -> R2_Stage1_L4_Attn_Output
				R2_Stage1_L4_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L4_Attn_Output -> R2_Stage1_L4_MoE_Input
				R2_Stage1_L4_Router [label="Router GPU 64\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L4_MoE_Input -> R2_Stage1_L4_Router
				R2_Stage1_L4_Expert0 [label="Expert 0 GPU 64\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert0 [label=select style=dashed]
				R2_Stage1_L4_Expert1 [label="Expert 1 GPU 65\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert1 [label=select style=dashed]
				R2_Stage1_L4_Expert2 [label="Expert 2 GPU 66\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert2 [label=select style=dashed]
				R2_Stage1_L4_Expert3 [label="Expert 3 GPU 67\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert3 [label=select style=dashed]
				R2_Stage1_L4_Expert4 [label="Expert 4 GPU 68\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert4 [label=select style=dashed]
				R2_Stage1_L4_Expert5 [label="Expert 5 GPU 69\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert5 [label=select style=dashed]
				R2_Stage1_L4_Expert6 [label="Expert 6 GPU 70\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert6 [label=select style=dashed]
				R2_Stage1_L4_Expert7 [label="Expert 7 GPU 71\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert7 [label=select style=dashed]
				R2_Stage1_L4_Expert8 [label="Expert 8 GPU 72\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert8 [label=select style=dashed]
				R2_Stage1_L4_Expert9 [label="Expert 9 GPU 73\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert9 [label=select style=dashed]
				R2_Stage1_L4_Expert10 [label="Expert 10 GPU 74\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert10 [label=select style=dashed]
				R2_Stage1_L4_Expert11 [label="Expert 11 GPU 75\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert11 [label=select style=dashed]
				R2_Stage1_L4_Expert12 [label="Expert 12 GPU 76\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert12 [label=select style=dashed]
				R2_Stage1_L4_Expert13 [label="Expert 13 GPU 77\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert13 [label=select style=dashed]
				R2_Stage1_L4_Expert14 [label="Expert 14 GPU 78\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert14 [label=select style=dashed]
				R2_Stage1_L4_Expert15 [label="Expert 15 GPU 79\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage1_L4_Router -> R2_Stage1_L4_Expert15 [label=select style=dashed]
				R2_Stage1_L4_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage1_L4_Expert0 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert1 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert2 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert3 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert4 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert5 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert6 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert7 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert8 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert9 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert10 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert11 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert12 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert13 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert14 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Expert15 -> R2_Stage1_L4_MoE_Output
				R2_Stage1_L4_Output [label="Layer 4 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage1_L4_MoE_Output -> R2_Stage1_L4_Output
				R2_Stage1_Output [label="Stage1 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			subgraph cluster_R2_Stage2 {
				fillcolor=lightgreen label="Stage2: Layers 5-8 (16 GPUs)" style="rounded,filled"
				R2_Stage2_Input [label="Stage2 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L5_Input [label="Layer 5 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L5_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L5_Input -> R2_Stage2_L5_Attn_Input
				R2_Stage2_L5_Attn_TP1 [label="Attention TP GPU 80\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Attn_TP2 [label="Attention TP GPU 81\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Attn_Input -> R2_Stage2_L5_Attn_TP1
				R2_Stage2_L5_Attn_Input -> R2_Stage2_L5_Attn_TP2
				R2_Stage2_L5_Attn_Output [label="Attention Output\nAllReduce GPUs 80-81\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L5_Attn_TP1 -> R2_Stage2_L5_Attn_Output
				R2_Stage2_L5_Attn_TP2 -> R2_Stage2_L5_Attn_Output
				R2_Stage2_L5_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L5_Attn_Output -> R2_Stage2_L5_MoE_Input
				R2_Stage2_L5_Router [label="Router GPU 80\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L5_MoE_Input -> R2_Stage2_L5_Router
				R2_Stage2_L5_Expert0 [label="Expert 0 GPU 80\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert0 [label=select style=dashed]
				R2_Stage2_L5_Expert1 [label="Expert 1 GPU 81\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert1 [label=select style=dashed]
				R2_Stage2_L5_Expert2 [label="Expert 2 GPU 82\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert2 [label=select style=dashed]
				R2_Stage2_L5_Expert3 [label="Expert 3 GPU 83\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert3 [label=select style=dashed]
				R2_Stage2_L5_Expert4 [label="Expert 4 GPU 84\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert4 [label=select style=dashed]
				R2_Stage2_L5_Expert5 [label="Expert 5 GPU 85\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert5 [label=select style=dashed]
				R2_Stage2_L5_Expert6 [label="Expert 6 GPU 86\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert6 [label=select style=dashed]
				R2_Stage2_L5_Expert7 [label="Expert 7 GPU 87\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert7 [label=select style=dashed]
				R2_Stage2_L5_Expert8 [label="Expert 8 GPU 88\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert8 [label=select style=dashed]
				R2_Stage2_L5_Expert9 [label="Expert 9 GPU 89\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert9 [label=select style=dashed]
				R2_Stage2_L5_Expert10 [label="Expert 10 GPU 90\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert10 [label=select style=dashed]
				R2_Stage2_L5_Expert11 [label="Expert 11 GPU 91\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert11 [label=select style=dashed]
				R2_Stage2_L5_Expert12 [label="Expert 12 GPU 92\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert12 [label=select style=dashed]
				R2_Stage2_L5_Expert13 [label="Expert 13 GPU 93\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert13 [label=select style=dashed]
				R2_Stage2_L5_Expert14 [label="Expert 14 GPU 94\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert14 [label=select style=dashed]
				R2_Stage2_L5_Expert15 [label="Expert 15 GPU 95\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L5_Router -> R2_Stage2_L5_Expert15 [label=select style=dashed]
				R2_Stage2_L5_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L5_Expert0 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert1 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert2 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert3 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert4 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert5 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert6 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert7 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert8 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert9 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert10 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert11 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert12 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert13 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert14 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Expert15 -> R2_Stage2_L5_MoE_Output
				R2_Stage2_L5_Output [label="Layer 5 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L5_MoE_Output -> R2_Stage2_L5_Output
				R2_Stage2_L6_Input [label="Layer 6 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L6_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L6_Input -> R2_Stage2_L6_Attn_Input
				R2_Stage2_L6_Attn_TP1 [label="Attention TP GPU 80\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Attn_TP2 [label="Attention TP GPU 81\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Attn_Input -> R2_Stage2_L6_Attn_TP1
				R2_Stage2_L6_Attn_Input -> R2_Stage2_L6_Attn_TP2
				R2_Stage2_L6_Attn_Output [label="Attention Output\nAllReduce GPUs 80-81\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L6_Attn_TP1 -> R2_Stage2_L6_Attn_Output
				R2_Stage2_L6_Attn_TP2 -> R2_Stage2_L6_Attn_Output
				R2_Stage2_L6_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L6_Attn_Output -> R2_Stage2_L6_MoE_Input
				R2_Stage2_L6_Router [label="Router GPU 80\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L6_MoE_Input -> R2_Stage2_L6_Router
				R2_Stage2_L6_Expert0 [label="Expert 0 GPU 80\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert0 [label=select style=dashed]
				R2_Stage2_L6_Expert1 [label="Expert 1 GPU 81\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert1 [label=select style=dashed]
				R2_Stage2_L6_Expert2 [label="Expert 2 GPU 82\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert2 [label=select style=dashed]
				R2_Stage2_L6_Expert3 [label="Expert 3 GPU 83\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert3 [label=select style=dashed]
				R2_Stage2_L6_Expert4 [label="Expert 4 GPU 84\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert4 [label=select style=dashed]
				R2_Stage2_L6_Expert5 [label="Expert 5 GPU 85\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert5 [label=select style=dashed]
				R2_Stage2_L6_Expert6 [label="Expert 6 GPU 86\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert6 [label=select style=dashed]
				R2_Stage2_L6_Expert7 [label="Expert 7 GPU 87\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert7 [label=select style=dashed]
				R2_Stage2_L6_Expert8 [label="Expert 8 GPU 88\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert8 [label=select style=dashed]
				R2_Stage2_L6_Expert9 [label="Expert 9 GPU 89\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert9 [label=select style=dashed]
				R2_Stage2_L6_Expert10 [label="Expert 10 GPU 90\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert10 [label=select style=dashed]
				R2_Stage2_L6_Expert11 [label="Expert 11 GPU 91\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert11 [label=select style=dashed]
				R2_Stage2_L6_Expert12 [label="Expert 12 GPU 92\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert12 [label=select style=dashed]
				R2_Stage2_L6_Expert13 [label="Expert 13 GPU 93\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert13 [label=select style=dashed]
				R2_Stage2_L6_Expert14 [label="Expert 14 GPU 94\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert14 [label=select style=dashed]
				R2_Stage2_L6_Expert15 [label="Expert 15 GPU 95\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L6_Router -> R2_Stage2_L6_Expert15 [label=select style=dashed]
				R2_Stage2_L6_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L6_Expert0 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert1 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert2 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert3 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert4 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert5 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert6 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert7 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert8 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert9 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert10 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert11 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert12 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert13 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert14 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Expert15 -> R2_Stage2_L6_MoE_Output
				R2_Stage2_L6_Output [label="Layer 6 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L6_MoE_Output -> R2_Stage2_L6_Output
				R2_Stage2_L7_Input [label="Layer 7 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L7_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L7_Input -> R2_Stage2_L7_Attn_Input
				R2_Stage2_L7_Attn_TP1 [label="Attention TP GPU 80\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Attn_TP2 [label="Attention TP GPU 81\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Attn_Input -> R2_Stage2_L7_Attn_TP1
				R2_Stage2_L7_Attn_Input -> R2_Stage2_L7_Attn_TP2
				R2_Stage2_L7_Attn_Output [label="Attention Output\nAllReduce GPUs 80-81\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L7_Attn_TP1 -> R2_Stage2_L7_Attn_Output
				R2_Stage2_L7_Attn_TP2 -> R2_Stage2_L7_Attn_Output
				R2_Stage2_L7_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L7_Attn_Output -> R2_Stage2_L7_MoE_Input
				R2_Stage2_L7_Router [label="Router GPU 80\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L7_MoE_Input -> R2_Stage2_L7_Router
				R2_Stage2_L7_Expert0 [label="Expert 0 GPU 80\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert0 [label=select style=dashed]
				R2_Stage2_L7_Expert1 [label="Expert 1 GPU 81\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert1 [label=select style=dashed]
				R2_Stage2_L7_Expert2 [label="Expert 2 GPU 82\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert2 [label=select style=dashed]
				R2_Stage2_L7_Expert3 [label="Expert 3 GPU 83\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert3 [label=select style=dashed]
				R2_Stage2_L7_Expert4 [label="Expert 4 GPU 84\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert4 [label=select style=dashed]
				R2_Stage2_L7_Expert5 [label="Expert 5 GPU 85\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert5 [label=select style=dashed]
				R2_Stage2_L7_Expert6 [label="Expert 6 GPU 86\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert6 [label=select style=dashed]
				R2_Stage2_L7_Expert7 [label="Expert 7 GPU 87\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert7 [label=select style=dashed]
				R2_Stage2_L7_Expert8 [label="Expert 8 GPU 88\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert8 [label=select style=dashed]
				R2_Stage2_L7_Expert9 [label="Expert 9 GPU 89\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert9 [label=select style=dashed]
				R2_Stage2_L7_Expert10 [label="Expert 10 GPU 90\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert10 [label=select style=dashed]
				R2_Stage2_L7_Expert11 [label="Expert 11 GPU 91\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert11 [label=select style=dashed]
				R2_Stage2_L7_Expert12 [label="Expert 12 GPU 92\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert12 [label=select style=dashed]
				R2_Stage2_L7_Expert13 [label="Expert 13 GPU 93\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert13 [label=select style=dashed]
				R2_Stage2_L7_Expert14 [label="Expert 14 GPU 94\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert14 [label=select style=dashed]
				R2_Stage2_L7_Expert15 [label="Expert 15 GPU 95\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L7_Router -> R2_Stage2_L7_Expert15 [label=select style=dashed]
				R2_Stage2_L7_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L7_Expert0 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert1 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert2 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert3 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert4 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert5 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert6 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert7 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert8 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert9 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert10 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert11 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert12 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert13 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert14 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Expert15 -> R2_Stage2_L7_MoE_Output
				R2_Stage2_L7_Output [label="Layer 7 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L7_MoE_Output -> R2_Stage2_L7_Output
				R2_Stage2_L8_Input [label="Layer 8 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L8_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L8_Input -> R2_Stage2_L8_Attn_Input
				R2_Stage2_L8_Attn_TP1 [label="Attention TP GPU 80\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Attn_TP2 [label="Attention TP GPU 81\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Attn_Input -> R2_Stage2_L8_Attn_TP1
				R2_Stage2_L8_Attn_Input -> R2_Stage2_L8_Attn_TP2
				R2_Stage2_L8_Attn_Output [label="Attention Output\nAllReduce GPUs 80-81\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L8_Attn_TP1 -> R2_Stage2_L8_Attn_Output
				R2_Stage2_L8_Attn_TP2 -> R2_Stage2_L8_Attn_Output
				R2_Stage2_L8_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L8_Attn_Output -> R2_Stage2_L8_MoE_Input
				R2_Stage2_L8_Router [label="Router GPU 80\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L8_MoE_Input -> R2_Stage2_L8_Router
				R2_Stage2_L8_Expert0 [label="Expert 0 GPU 80\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert0 [label=select style=dashed]
				R2_Stage2_L8_Expert1 [label="Expert 1 GPU 81\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert1 [label=select style=dashed]
				R2_Stage2_L8_Expert2 [label="Expert 2 GPU 82\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert2 [label=select style=dashed]
				R2_Stage2_L8_Expert3 [label="Expert 3 GPU 83\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert3 [label=select style=dashed]
				R2_Stage2_L8_Expert4 [label="Expert 4 GPU 84\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert4 [label=select style=dashed]
				R2_Stage2_L8_Expert5 [label="Expert 5 GPU 85\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert5 [label=select style=dashed]
				R2_Stage2_L8_Expert6 [label="Expert 6 GPU 86\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert6 [label=select style=dashed]
				R2_Stage2_L8_Expert7 [label="Expert 7 GPU 87\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert7 [label=select style=dashed]
				R2_Stage2_L8_Expert8 [label="Expert 8 GPU 88\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert8 [label=select style=dashed]
				R2_Stage2_L8_Expert9 [label="Expert 9 GPU 89\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert9 [label=select style=dashed]
				R2_Stage2_L8_Expert10 [label="Expert 10 GPU 90\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert10 [label=select style=dashed]
				R2_Stage2_L8_Expert11 [label="Expert 11 GPU 91\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert11 [label=select style=dashed]
				R2_Stage2_L8_Expert12 [label="Expert 12 GPU 92\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert12 [label=select style=dashed]
				R2_Stage2_L8_Expert13 [label="Expert 13 GPU 93\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert13 [label=select style=dashed]
				R2_Stage2_L8_Expert14 [label="Expert 14 GPU 94\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert14 [label=select style=dashed]
				R2_Stage2_L8_Expert15 [label="Expert 15 GPU 95\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage2_L8_Router -> R2_Stage2_L8_Expert15 [label=select style=dashed]
				R2_Stage2_L8_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage2_L8_Expert0 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert1 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert2 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert3 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert4 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert5 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert6 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert7 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert8 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert9 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert10 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert11 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert12 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert13 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert14 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Expert15 -> R2_Stage2_L8_MoE_Output
				R2_Stage2_L8_Output [label="Layer 8 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage2_L8_MoE_Output -> R2_Stage2_L8_Output
				R2_Stage2_Output [label="Stage2 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			subgraph cluster_R2_Stage3 {
				fillcolor=lightgreen label="Stage3: Layers 9-12 (16 GPUs)" style="rounded,filled"
				R2_Stage3_Input [label="Stage3 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L9_Input [label="Layer 9 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L9_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L9_Input -> R2_Stage3_L9_Attn_Input
				R2_Stage3_L9_Attn_TP1 [label="Attention TP GPU 96\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Attn_TP2 [label="Attention TP GPU 97\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Attn_Input -> R2_Stage3_L9_Attn_TP1
				R2_Stage3_L9_Attn_Input -> R2_Stage3_L9_Attn_TP2
				R2_Stage3_L9_Attn_Output [label="Attention Output\nAllReduce GPUs 96-97\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L9_Attn_TP1 -> R2_Stage3_L9_Attn_Output
				R2_Stage3_L9_Attn_TP2 -> R2_Stage3_L9_Attn_Output
				R2_Stage3_L9_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L9_Attn_Output -> R2_Stage3_L9_MoE_Input
				R2_Stage3_L9_Router [label="Router GPU 96\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L9_MoE_Input -> R2_Stage3_L9_Router
				R2_Stage3_L9_Expert0 [label="Expert 0 GPU 96\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert0 [label=select style=dashed]
				R2_Stage3_L9_Expert1 [label="Expert 1 GPU 97\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert1 [label=select style=dashed]
				R2_Stage3_L9_Expert2 [label="Expert 2 GPU 98\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert2 [label=select style=dashed]
				R2_Stage3_L9_Expert3 [label="Expert 3 GPU 99\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert3 [label=select style=dashed]
				R2_Stage3_L9_Expert4 [label="Expert 4 GPU 100\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert4 [label=select style=dashed]
				R2_Stage3_L9_Expert5 [label="Expert 5 GPU 101\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert5 [label=select style=dashed]
				R2_Stage3_L9_Expert6 [label="Expert 6 GPU 102\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert6 [label=select style=dashed]
				R2_Stage3_L9_Expert7 [label="Expert 7 GPU 103\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert7 [label=select style=dashed]
				R2_Stage3_L9_Expert8 [label="Expert 8 GPU 104\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert8 [label=select style=dashed]
				R2_Stage3_L9_Expert9 [label="Expert 9 GPU 105\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert9 [label=select style=dashed]
				R2_Stage3_L9_Expert10 [label="Expert 10 GPU 106\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert10 [label=select style=dashed]
				R2_Stage3_L9_Expert11 [label="Expert 11 GPU 107\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert11 [label=select style=dashed]
				R2_Stage3_L9_Expert12 [label="Expert 12 GPU 108\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert12 [label=select style=dashed]
				R2_Stage3_L9_Expert13 [label="Expert 13 GPU 109\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert13 [label=select style=dashed]
				R2_Stage3_L9_Expert14 [label="Expert 14 GPU 110\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert14 [label=select style=dashed]
				R2_Stage3_L9_Expert15 [label="Expert 15 GPU 111\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L9_Router -> R2_Stage3_L9_Expert15 [label=select style=dashed]
				R2_Stage3_L9_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L9_Expert0 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert1 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert2 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert3 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert4 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert5 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert6 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert7 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert8 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert9 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert10 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert11 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert12 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert13 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert14 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Expert15 -> R2_Stage3_L9_MoE_Output
				R2_Stage3_L9_Output [label="Layer 9 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L9_MoE_Output -> R2_Stage3_L9_Output
				R2_Stage3_L10_Input [label="Layer 10 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L10_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L10_Input -> R2_Stage3_L10_Attn_Input
				R2_Stage3_L10_Attn_TP1 [label="Attention TP GPU 96\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Attn_TP2 [label="Attention TP GPU 97\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Attn_Input -> R2_Stage3_L10_Attn_TP1
				R2_Stage3_L10_Attn_Input -> R2_Stage3_L10_Attn_TP2
				R2_Stage3_L10_Attn_Output [label="Attention Output\nAllReduce GPUs 96-97\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L10_Attn_TP1 -> R2_Stage3_L10_Attn_Output
				R2_Stage3_L10_Attn_TP2 -> R2_Stage3_L10_Attn_Output
				R2_Stage3_L10_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L10_Attn_Output -> R2_Stage3_L10_MoE_Input
				R2_Stage3_L10_Router [label="Router GPU 96\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L10_MoE_Input -> R2_Stage3_L10_Router
				R2_Stage3_L10_Expert0 [label="Expert 0 GPU 96\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert0 [label=select style=dashed]
				R2_Stage3_L10_Expert1 [label="Expert 1 GPU 97\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert1 [label=select style=dashed]
				R2_Stage3_L10_Expert2 [label="Expert 2 GPU 98\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert2 [label=select style=dashed]
				R2_Stage3_L10_Expert3 [label="Expert 3 GPU 99\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert3 [label=select style=dashed]
				R2_Stage3_L10_Expert4 [label="Expert 4 GPU 100\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert4 [label=select style=dashed]
				R2_Stage3_L10_Expert5 [label="Expert 5 GPU 101\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert5 [label=select style=dashed]
				R2_Stage3_L10_Expert6 [label="Expert 6 GPU 102\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert6 [label=select style=dashed]
				R2_Stage3_L10_Expert7 [label="Expert 7 GPU 103\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert7 [label=select style=dashed]
				R2_Stage3_L10_Expert8 [label="Expert 8 GPU 104\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert8 [label=select style=dashed]
				R2_Stage3_L10_Expert9 [label="Expert 9 GPU 105\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert9 [label=select style=dashed]
				R2_Stage3_L10_Expert10 [label="Expert 10 GPU 106\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert10 [label=select style=dashed]
				R2_Stage3_L10_Expert11 [label="Expert 11 GPU 107\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert11 [label=select style=dashed]
				R2_Stage3_L10_Expert12 [label="Expert 12 GPU 108\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert12 [label=select style=dashed]
				R2_Stage3_L10_Expert13 [label="Expert 13 GPU 109\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert13 [label=select style=dashed]
				R2_Stage3_L10_Expert14 [label="Expert 14 GPU 110\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert14 [label=select style=dashed]
				R2_Stage3_L10_Expert15 [label="Expert 15 GPU 111\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L10_Router -> R2_Stage3_L10_Expert15 [label=select style=dashed]
				R2_Stage3_L10_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L10_Expert0 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert1 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert2 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert3 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert4 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert5 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert6 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert7 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert8 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert9 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert10 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert11 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert12 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert13 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert14 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Expert15 -> R2_Stage3_L10_MoE_Output
				R2_Stage3_L10_Output [label="Layer 10 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L10_MoE_Output -> R2_Stage3_L10_Output
				R2_Stage3_L11_Input [label="Layer 11 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L11_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L11_Input -> R2_Stage3_L11_Attn_Input
				R2_Stage3_L11_Attn_TP1 [label="Attention TP GPU 96\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Attn_TP2 [label="Attention TP GPU 97\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Attn_Input -> R2_Stage3_L11_Attn_TP1
				R2_Stage3_L11_Attn_Input -> R2_Stage3_L11_Attn_TP2
				R2_Stage3_L11_Attn_Output [label="Attention Output\nAllReduce GPUs 96-97\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L11_Attn_TP1 -> R2_Stage3_L11_Attn_Output
				R2_Stage3_L11_Attn_TP2 -> R2_Stage3_L11_Attn_Output
				R2_Stage3_L11_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L11_Attn_Output -> R2_Stage3_L11_MoE_Input
				R2_Stage3_L11_Router [label="Router GPU 96\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L11_MoE_Input -> R2_Stage3_L11_Router
				R2_Stage3_L11_Expert0 [label="Expert 0 GPU 96\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert0 [label=select style=dashed]
				R2_Stage3_L11_Expert1 [label="Expert 1 GPU 97\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert1 [label=select style=dashed]
				R2_Stage3_L11_Expert2 [label="Expert 2 GPU 98\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert2 [label=select style=dashed]
				R2_Stage3_L11_Expert3 [label="Expert 3 GPU 99\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert3 [label=select style=dashed]
				R2_Stage3_L11_Expert4 [label="Expert 4 GPU 100\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert4 [label=select style=dashed]
				R2_Stage3_L11_Expert5 [label="Expert 5 GPU 101\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert5 [label=select style=dashed]
				R2_Stage3_L11_Expert6 [label="Expert 6 GPU 102\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert6 [label=select style=dashed]
				R2_Stage3_L11_Expert7 [label="Expert 7 GPU 103\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert7 [label=select style=dashed]
				R2_Stage3_L11_Expert8 [label="Expert 8 GPU 104\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert8 [label=select style=dashed]
				R2_Stage3_L11_Expert9 [label="Expert 9 GPU 105\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert9 [label=select style=dashed]
				R2_Stage3_L11_Expert10 [label="Expert 10 GPU 106\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert10 [label=select style=dashed]
				R2_Stage3_L11_Expert11 [label="Expert 11 GPU 107\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert11 [label=select style=dashed]
				R2_Stage3_L11_Expert12 [label="Expert 12 GPU 108\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert12 [label=select style=dashed]
				R2_Stage3_L11_Expert13 [label="Expert 13 GPU 109\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert13 [label=select style=dashed]
				R2_Stage3_L11_Expert14 [label="Expert 14 GPU 110\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert14 [label=select style=dashed]
				R2_Stage3_L11_Expert15 [label="Expert 15 GPU 111\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L11_Router -> R2_Stage3_L11_Expert15 [label=select style=dashed]
				R2_Stage3_L11_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L11_Expert0 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert1 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert2 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert3 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert4 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert5 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert6 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert7 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert8 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert9 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert10 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert11 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert12 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert13 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert14 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Expert15 -> R2_Stage3_L11_MoE_Output
				R2_Stage3_L11_Output [label="Layer 11 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L11_MoE_Output -> R2_Stage3_L11_Output
				R2_Stage3_L12_Input [label="Layer 12 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L12_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L12_Input -> R2_Stage3_L12_Attn_Input
				R2_Stage3_L12_Attn_TP1 [label="Attention TP GPU 96\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Attn_TP2 [label="Attention TP GPU 97\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Attn_Input -> R2_Stage3_L12_Attn_TP1
				R2_Stage3_L12_Attn_Input -> R2_Stage3_L12_Attn_TP2
				R2_Stage3_L12_Attn_Output [label="Attention Output\nAllReduce GPUs 96-97\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L12_Attn_TP1 -> R2_Stage3_L12_Attn_Output
				R2_Stage3_L12_Attn_TP2 -> R2_Stage3_L12_Attn_Output
				R2_Stage3_L12_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L12_Attn_Output -> R2_Stage3_L12_MoE_Input
				R2_Stage3_L12_Router [label="Router GPU 96\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L12_MoE_Input -> R2_Stage3_L12_Router
				R2_Stage3_L12_Expert0 [label="Expert 0 GPU 96\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert0 [label=select style=dashed]
				R2_Stage3_L12_Expert1 [label="Expert 1 GPU 97\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert1 [label=select style=dashed]
				R2_Stage3_L12_Expert2 [label="Expert 2 GPU 98\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert2 [label=select style=dashed]
				R2_Stage3_L12_Expert3 [label="Expert 3 GPU 99\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert3 [label=select style=dashed]
				R2_Stage3_L12_Expert4 [label="Expert 4 GPU 100\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert4 [label=select style=dashed]
				R2_Stage3_L12_Expert5 [label="Expert 5 GPU 101\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert5 [label=select style=dashed]
				R2_Stage3_L12_Expert6 [label="Expert 6 GPU 102\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert6 [label=select style=dashed]
				R2_Stage3_L12_Expert7 [label="Expert 7 GPU 103\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert7 [label=select style=dashed]
				R2_Stage3_L12_Expert8 [label="Expert 8 GPU 104\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert8 [label=select style=dashed]
				R2_Stage3_L12_Expert9 [label="Expert 9 GPU 105\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert9 [label=select style=dashed]
				R2_Stage3_L12_Expert10 [label="Expert 10 GPU 106\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert10 [label=select style=dashed]
				R2_Stage3_L12_Expert11 [label="Expert 11 GPU 107\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert11 [label=select style=dashed]
				R2_Stage3_L12_Expert12 [label="Expert 12 GPU 108\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert12 [label=select style=dashed]
				R2_Stage3_L12_Expert13 [label="Expert 13 GPU 109\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert13 [label=select style=dashed]
				R2_Stage3_L12_Expert14 [label="Expert 14 GPU 110\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert14 [label=select style=dashed]
				R2_Stage3_L12_Expert15 [label="Expert 15 GPU 111\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage3_L12_Router -> R2_Stage3_L12_Expert15 [label=select style=dashed]
				R2_Stage3_L12_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage3_L12_Expert0 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert1 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert2 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert3 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert4 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert5 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert6 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert7 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert8 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert9 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert10 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert11 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert12 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert13 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert14 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Expert15 -> R2_Stage3_L12_MoE_Output
				R2_Stage3_L12_Output [label="Layer 12 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage3_L12_MoE_Output -> R2_Stage3_L12_Output
				R2_Stage3_Output [label="Stage3 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			subgraph cluster_R2_Stage4 {
				fillcolor=lightgreen label="Stage4: Layers 13-16 (16 GPUs)" style="rounded,filled"
				R2_Stage4_Input [label="Stage4 Input\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L13_Input [label="Layer 13 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L13_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L13_Input -> R2_Stage4_L13_Attn_Input
				R2_Stage4_L13_Attn_TP1 [label="Attention TP GPU 112\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Attn_TP2 [label="Attention TP GPU 113\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Attn_Input -> R2_Stage4_L13_Attn_TP1
				R2_Stage4_L13_Attn_Input -> R2_Stage4_L13_Attn_TP2
				R2_Stage4_L13_Attn_Output [label="Attention Output\nAllReduce GPUs 112-113\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L13_Attn_TP1 -> R2_Stage4_L13_Attn_Output
				R2_Stage4_L13_Attn_TP2 -> R2_Stage4_L13_Attn_Output
				R2_Stage4_L13_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L13_Attn_Output -> R2_Stage4_L13_MoE_Input
				R2_Stage4_L13_Router [label="Router GPU 112\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L13_MoE_Input -> R2_Stage4_L13_Router
				R2_Stage4_L13_Expert0 [label="Expert 0 GPU 112\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert0 [label=select style=dashed]
				R2_Stage4_L13_Expert1 [label="Expert 1 GPU 113\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert1 [label=select style=dashed]
				R2_Stage4_L13_Expert2 [label="Expert 2 GPU 114\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert2 [label=select style=dashed]
				R2_Stage4_L13_Expert3 [label="Expert 3 GPU 115\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert3 [label=select style=dashed]
				R2_Stage4_L13_Expert4 [label="Expert 4 GPU 116\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert4 [label=select style=dashed]
				R2_Stage4_L13_Expert5 [label="Expert 5 GPU 117\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert5 [label=select style=dashed]
				R2_Stage4_L13_Expert6 [label="Expert 6 GPU 118\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert6 [label=select style=dashed]
				R2_Stage4_L13_Expert7 [label="Expert 7 GPU 119\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert7 [label=select style=dashed]
				R2_Stage4_L13_Expert8 [label="Expert 8 GPU 120\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert8 [label=select style=dashed]
				R2_Stage4_L13_Expert9 [label="Expert 9 GPU 121\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert9 [label=select style=dashed]
				R2_Stage4_L13_Expert10 [label="Expert 10 GPU 122\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert10 [label=select style=dashed]
				R2_Stage4_L13_Expert11 [label="Expert 11 GPU 123\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert11 [label=select style=dashed]
				R2_Stage4_L13_Expert12 [label="Expert 12 GPU 124\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert12 [label=select style=dashed]
				R2_Stage4_L13_Expert13 [label="Expert 13 GPU 125\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert13 [label=select style=dashed]
				R2_Stage4_L13_Expert14 [label="Expert 14 GPU 126\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert14 [label=select style=dashed]
				R2_Stage4_L13_Expert15 [label="Expert 15 GPU 127\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L13_Router -> R2_Stage4_L13_Expert15 [label=select style=dashed]
				R2_Stage4_L13_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L13_Expert0 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert1 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert2 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert3 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert4 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert5 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert6 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert7 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert8 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert9 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert10 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert11 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert12 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert13 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert14 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Expert15 -> R2_Stage4_L13_MoE_Output
				R2_Stage4_L13_Output [label="Layer 13 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L13_MoE_Output -> R2_Stage4_L13_Output
				R2_Stage4_L14_Input [label="Layer 14 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L14_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L14_Input -> R2_Stage4_L14_Attn_Input
				R2_Stage4_L14_Attn_TP1 [label="Attention TP GPU 112\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Attn_TP2 [label="Attention TP GPU 113\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Attn_Input -> R2_Stage4_L14_Attn_TP1
				R2_Stage4_L14_Attn_Input -> R2_Stage4_L14_Attn_TP2
				R2_Stage4_L14_Attn_Output [label="Attention Output\nAllReduce GPUs 112-113\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L14_Attn_TP1 -> R2_Stage4_L14_Attn_Output
				R2_Stage4_L14_Attn_TP2 -> R2_Stage4_L14_Attn_Output
				R2_Stage4_L14_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L14_Attn_Output -> R2_Stage4_L14_MoE_Input
				R2_Stage4_L14_Router [label="Router GPU 112\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L14_MoE_Input -> R2_Stage4_L14_Router
				R2_Stage4_L14_Expert0 [label="Expert 0 GPU 112\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert0 [label=select style=dashed]
				R2_Stage4_L14_Expert1 [label="Expert 1 GPU 113\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert1 [label=select style=dashed]
				R2_Stage4_L14_Expert2 [label="Expert 2 GPU 114\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert2 [label=select style=dashed]
				R2_Stage4_L14_Expert3 [label="Expert 3 GPU 115\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert3 [label=select style=dashed]
				R2_Stage4_L14_Expert4 [label="Expert 4 GPU 116\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert4 [label=select style=dashed]
				R2_Stage4_L14_Expert5 [label="Expert 5 GPU 117\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert5 [label=select style=dashed]
				R2_Stage4_L14_Expert6 [label="Expert 6 GPU 118\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert6 [label=select style=dashed]
				R2_Stage4_L14_Expert7 [label="Expert 7 GPU 119\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert7 [label=select style=dashed]
				R2_Stage4_L14_Expert8 [label="Expert 8 GPU 120\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert8 [label=select style=dashed]
				R2_Stage4_L14_Expert9 [label="Expert 9 GPU 121\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert9 [label=select style=dashed]
				R2_Stage4_L14_Expert10 [label="Expert 10 GPU 122\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert10 [label=select style=dashed]
				R2_Stage4_L14_Expert11 [label="Expert 11 GPU 123\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert11 [label=select style=dashed]
				R2_Stage4_L14_Expert12 [label="Expert 12 GPU 124\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert12 [label=select style=dashed]
				R2_Stage4_L14_Expert13 [label="Expert 13 GPU 125\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert13 [label=select style=dashed]
				R2_Stage4_L14_Expert14 [label="Expert 14 GPU 126\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert14 [label=select style=dashed]
				R2_Stage4_L14_Expert15 [label="Expert 15 GPU 127\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L14_Router -> R2_Stage4_L14_Expert15 [label=select style=dashed]
				R2_Stage4_L14_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L14_Expert0 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert1 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert2 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert3 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert4 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert5 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert6 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert7 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert8 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert9 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert10 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert11 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert12 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert13 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert14 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Expert15 -> R2_Stage4_L14_MoE_Output
				R2_Stage4_L14_Output [label="Layer 14 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L14_MoE_Output -> R2_Stage4_L14_Output
				R2_Stage4_L15_Input [label="Layer 15 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L15_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L15_Input -> R2_Stage4_L15_Attn_Input
				R2_Stage4_L15_Attn_TP1 [label="Attention TP GPU 112\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Attn_TP2 [label="Attention TP GPU 113\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Attn_Input -> R2_Stage4_L15_Attn_TP1
				R2_Stage4_L15_Attn_Input -> R2_Stage4_L15_Attn_TP2
				R2_Stage4_L15_Attn_Output [label="Attention Output\nAllReduce GPUs 112-113\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L15_Attn_TP1 -> R2_Stage4_L15_Attn_Output
				R2_Stage4_L15_Attn_TP2 -> R2_Stage4_L15_Attn_Output
				R2_Stage4_L15_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L15_Attn_Output -> R2_Stage4_L15_MoE_Input
				R2_Stage4_L15_Router [label="Router GPU 112\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L15_MoE_Input -> R2_Stage4_L15_Router
				R2_Stage4_L15_Expert0 [label="Expert 0 GPU 112\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert0 [label=select style=dashed]
				R2_Stage4_L15_Expert1 [label="Expert 1 GPU 113\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert1 [label=select style=dashed]
				R2_Stage4_L15_Expert2 [label="Expert 2 GPU 114\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert2 [label=select style=dashed]
				R2_Stage4_L15_Expert3 [label="Expert 3 GPU 115\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert3 [label=select style=dashed]
				R2_Stage4_L15_Expert4 [label="Expert 4 GPU 116\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert4 [label=select style=dashed]
				R2_Stage4_L15_Expert5 [label="Expert 5 GPU 117\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert5 [label=select style=dashed]
				R2_Stage4_L15_Expert6 [label="Expert 6 GPU 118\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert6 [label=select style=dashed]
				R2_Stage4_L15_Expert7 [label="Expert 7 GPU 119\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert7 [label=select style=dashed]
				R2_Stage4_L15_Expert8 [label="Expert 8 GPU 120\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert8 [label=select style=dashed]
				R2_Stage4_L15_Expert9 [label="Expert 9 GPU 121\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert9 [label=select style=dashed]
				R2_Stage4_L15_Expert10 [label="Expert 10 GPU 122\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert10 [label=select style=dashed]
				R2_Stage4_L15_Expert11 [label="Expert 11 GPU 123\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert11 [label=select style=dashed]
				R2_Stage4_L15_Expert12 [label="Expert 12 GPU 124\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert12 [label=select style=dashed]
				R2_Stage4_L15_Expert13 [label="Expert 13 GPU 125\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert13 [label=select style=dashed]
				R2_Stage4_L15_Expert14 [label="Expert 14 GPU 126\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert14 [label=select style=dashed]
				R2_Stage4_L15_Expert15 [label="Expert 15 GPU 127\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L15_Router -> R2_Stage4_L15_Expert15 [label=select style=dashed]
				R2_Stage4_L15_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L15_Expert0 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert1 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert2 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert3 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert4 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert5 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert6 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert7 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert8 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert9 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert10 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert11 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert12 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert13 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert14 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Expert15 -> R2_Stage4_L15_MoE_Output
				R2_Stage4_L15_Output [label="Layer 15 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L15_MoE_Output -> R2_Stage4_L15_Output
				R2_Stage4_L16_Input [label="Layer 16 Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L16_Attn_Input [label="Attention Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L16_Input -> R2_Stage4_L16_Attn_Input
				R2_Stage4_L16_Attn_TP1 [label="Attention TP GPU 112\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Attn_TP2 [label="Attention TP GPU 113\n8 heads\nInput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, heads=8, d_k=32]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Attn_Input -> R2_Stage4_L16_Attn_TP1
				R2_Stage4_L16_Attn_Input -> R2_Stage4_L16_Attn_TP2
				R2_Stage4_L16_Attn_Output [label="Attention Output\nAllReduce GPUs 112-113\nInput: [batch_size=128, seq_len=128-10240, heads=16, d_k=32]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L16_Attn_TP1 -> R2_Stage4_L16_Attn_Output
				R2_Stage4_L16_Attn_TP2 -> R2_Stage4_L16_Attn_Output
				R2_Stage4_L16_MoE_Input [label="MoE Input\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L16_Attn_Output -> R2_Stage4_L16_MoE_Input
				R2_Stage4_L16_Router [label="Router GPU 112\nExpert Selection\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: routing decisions" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L16_MoE_Input -> R2_Stage4_L16_Router
				R2_Stage4_L16_Expert0 [label="Expert 0 GPU 112\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert0 [label=select style=dashed]
				R2_Stage4_L16_Expert1 [label="Expert 1 GPU 113\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert1 [label=select style=dashed]
				R2_Stage4_L16_Expert2 [label="Expert 2 GPU 114\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert2 [label=select style=dashed]
				R2_Stage4_L16_Expert3 [label="Expert 3 GPU 115\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert3 [label=select style=dashed]
				R2_Stage4_L16_Expert4 [label="Expert 4 GPU 116\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert4 [label=select style=dashed]
				R2_Stage4_L16_Expert5 [label="Expert 5 GPU 117\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert5 [label=select style=dashed]
				R2_Stage4_L16_Expert6 [label="Expert 6 GPU 118\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert6 [label=select style=dashed]
				R2_Stage4_L16_Expert7 [label="Expert 7 GPU 119\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert7 [label=select style=dashed]
				R2_Stage4_L16_Expert8 [label="Expert 8 GPU 120\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert8 [label=select style=dashed]
				R2_Stage4_L16_Expert9 [label="Expert 9 GPU 121\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert9 [label=select style=dashed]
				R2_Stage4_L16_Expert10 [label="Expert 10 GPU 122\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert10 [label=select style=dashed]
				R2_Stage4_L16_Expert11 [label="Expert 11 GPU 123\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert11 [label=select style=dashed]
				R2_Stage4_L16_Expert12 [label="Expert 12 GPU 124\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert12 [label=select style=dashed]
				R2_Stage4_L16_Expert13 [label="Expert 13 GPU 125\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert13 [label=select style=dashed]
				R2_Stage4_L16_Expert14 [label="Expert 14 GPU 126\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert14 [label=select style=dashed]
				R2_Stage4_L16_Expert15 [label="Expert 15 GPU 127\nInput: [batch_size=?, seq_len=?, hidden=512]\nOutput: [batch_size=?, seq_len=?, hidden=512]" fillcolor=lightgreen shape=rect]
				R2_Stage4_L16_Router -> R2_Stage4_L16_Expert15 [label=select style=dashed]
				R2_Stage4_L16_MoE_Output [label="MoE Output\nExpert Aggregation\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				R2_Stage4_L16_Expert0 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert1 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert2 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert3 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert4 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert5 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert6 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert7 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert8 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert9 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert10 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert11 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert12 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert13 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert14 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Expert15 -> R2_Stage4_L16_MoE_Output
				R2_Stage4_L16_Output [label="Layer 16 Output\nInput: [batch_size=128, seq_len=128-10240, hidden=512]\nOutput: [batch_size=128, seq_len=128-10240, hidden=512]" fillcolor=lightblue shape=ellipse]
				R2_Stage4_L16_MoE_Output -> R2_Stage4_L16_Output
				R2_Stage4_Output [label="Stage4 Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
			}
			R2_Output [label="Output\nInput: [batch_size=128, seq_len=128-10240]\nOutput: [batch_size=128, seq_len=128-10240]" fillcolor=lightblue shape=ellipse]
		}
	}
}
