<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="1340pt" height="3547pt"
 viewBox="0.00 0.00 1340.40 3547.42" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 3543.42)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-3543.42 1336.4,-3543.42 1336.4,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_input</title>
<path fill="none" stroke="black" d="M260,-3439.42C260,-3439.42 674,-3439.42 674,-3439.42 680,-3439.42 686,-3445.42 686,-3451.42 686,-3451.42 686,-3519.42 686,-3519.42 686,-3525.42 680,-3531.42 674,-3531.42 674,-3531.42 260,-3531.42 260,-3531.42 254,-3531.42 248,-3525.42 248,-3519.42 248,-3519.42 248,-3451.42 248,-3451.42 248,-3445.42 254,-3439.42 260,-3439.42"/>
<text text-anchor="middle" x="467" y="-3516.22" font-family="Times,serif" font-size="14.00">Input Layer</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_stage1</title>
<path fill="none" stroke="black" d="M20,-1463.5C20,-1463.5 914,-1463.5 914,-1463.5 920,-1463.5 926,-1469.5 926,-1475.5 926,-1475.5 926,-3358.83 926,-3358.83 926,-3364.83 920,-3370.83 914,-3370.83 914,-3370.83 20,-3370.83 20,-3370.83 14,-3370.83 8,-3364.83 8,-3358.83 8,-3358.83 8,-1475.5 8,-1475.5 8,-1469.5 14,-1463.5 20,-1463.5"/>
<text text-anchor="middle" x="467" y="-3355.63" font-family="Times,serif" font-size="14.00">Pipeline Stage 1: Layers 0&#45;7 (GPUs 0&#45;127)</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_stage2</title>
<path fill="none" stroke="black" d="M156,-147C156,-147 778,-147 778,-147 784,-147 790,-153 790,-159 790,-159 790,-1222.33 790,-1222.33 790,-1228.33 784,-1234.33 778,-1234.33 778,-1234.33 156,-1234.33 156,-1234.33 150,-1234.33 144,-1228.33 144,-1222.33 144,-1222.33 144,-159 144,-159 144,-153 150,-147 156,-147"/>
<text text-anchor="middle" x="467" y="-1219.13" font-family="Times,serif" font-size="14.00">Pipeline Stage 2: Layers 8&#45;15 (GPUs 128&#45;255)</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_output</title>
<path fill="none" stroke="black" d="M266,-8C266,-8 668,-8 668,-8 674,-8 680,-14 680,-20 680,-20 680,-88 680,-88 680,-94 674,-100 668,-100 668,-100 266,-100 266,-100 260,-100 254,-94 254,-88 254,-88 254,-20 254,-20 254,-14 260,-8 266,-8"/>
<text text-anchor="middle" x="467" y="-84.8" font-family="Times,serif" font-size="14.00">Output Layer</text>
</g>
<!-- input -->
<g id="node1" class="node">
<title>input</title>
<polygon fill="white" stroke="black" points="678,-3500.42 256,-3500.42 256,-3447.42 678,-3447.42 678,-3500.42"/>
<text text-anchor="middle" x="467" y="-3485.22" font-family="Times,serif" font-size="14.00">Input</text>
<text text-anchor="middle" x="467" y="-3470.22" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-3455.22" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- layernorm0 -->
<g id="node2" class="node">
<title>layernorm0</title>
<polygon fill="lightgreen" stroke="black" points="678,-3339.83 256,-3339.83 256,-3271.83 678,-3271.83 678,-3339.83"/>
<text text-anchor="middle" x="467" y="-3324.63" font-family="Times,serif" font-size="14.00">LayerNorm (Layer 0)</text>
<text text-anchor="middle" x="467" y="-3309.63" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127</text>
<text text-anchor="middle" x="467" y="-3294.63" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-3279.63" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- input&#45;&gt;layernorm0 -->
<g id="edge1" class="edge">
<title>input&#45;&gt;layernorm0</title>
<path fill="none" stroke="black" d="M467,-3447.28C467,-3447.28 467,-3349.89 467,-3349.89"/>
<polygon fill="black" stroke="black" points="470.5,-3349.89 467,-3339.89 463.5,-3349.89 470.5,-3349.89"/>
</g>
<!-- qkv_proj -->
<g id="node3" class="node">
<title>qkv_proj</title>
<polygon fill="lightgreen" stroke="black" points="689.5,-3185.83 244.5,-3185.83 244.5,-3117.83 689.5,-3117.83 689.5,-3185.83"/>
<text text-anchor="middle" x="467" y="-3170.63" font-family="Times,serif" font-size="14.00">QKV Projection TP=4</text>
<text text-anchor="middle" x="467" y="-3155.63" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 (TP groups)</text>
<text text-anchor="middle" x="467" y="-3140.63" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-3125.63" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
</g>
<!-- layernorm0&#45;&gt;qkv_proj -->
<g id="edge2" class="edge">
<title>layernorm0&#45;&gt;qkv_proj</title>
<path fill="none" stroke="black" d="M467,-3271.66C467,-3271.66 467,-3195.91 467,-3195.91"/>
<polygon fill="black" stroke="black" points="470.5,-3195.91 467,-3185.91 463.5,-3195.91 470.5,-3195.91"/>
</g>
<!-- qkv_allreduce -->
<g id="node4" class="node">
<title>qkv_allreduce</title>
<ellipse fill="lightblue" stroke="black" cx="467" cy="-2983.75" rx="314.83" ry="48.17"/>
<text text-anchor="middle" x="467" y="-3002.55" font-family="Times,serif" font-size="14.00">TP All&#45;Reduce QKV</text>
<text text-anchor="middle" x="467" y="-2987.55" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 (TP groups)</text>
<text text-anchor="middle" x="467" y="-2972.55" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, heads=4, d_k=32]</text>
<text text-anchor="middle" x="467" y="-2957.55" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
</g>
<!-- qkv_proj&#45;&gt;qkv_allreduce -->
<g id="edge3" class="edge">
<title>qkv_proj&#45;&gt;qkv_allreduce</title>
<path fill="none" stroke="black" d="M467,-3117.82C467,-3117.82 467,-3042.05 467,-3042.05"/>
<polygon fill="black" stroke="black" points="470.5,-3042.05 467,-3032.05 463.5,-3042.05 470.5,-3042.05"/>
</g>
<!-- attention -->
<g id="node5" class="node">
<title>attention</title>
<polygon fill="lightgreen" stroke="black" points="689.5,-2849.67 244.5,-2849.67 244.5,-2781.67 689.5,-2781.67 689.5,-2849.67"/>
<text text-anchor="middle" x="467" y="-2834.47" font-family="Times,serif" font-size="14.00">Multi&#45;Head Attention</text>
<text text-anchor="middle" x="467" y="-2819.47" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127</text>
<text text-anchor="middle" x="467" y="-2804.47" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
<text text-anchor="middle" x="467" y="-2789.47" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
</g>
<!-- qkv_allreduce&#45;&gt;attention -->
<g id="edge4" class="edge">
<title>qkv_allreduce&#45;&gt;attention</title>
<path fill="none" stroke="black" d="M467,-2935.58C467,-2935.58 467,-2859.7 467,-2859.7"/>
<polygon fill="black" stroke="black" points="470.5,-2859.7 467,-2849.7 463.5,-2859.7 470.5,-2859.7"/>
</g>
<!-- attn_out -->
<g id="node6" class="node">
<title>attn_out</title>
<polygon fill="lightgreen" stroke="black" points="683.5,-2695.67 250.5,-2695.67 250.5,-2627.67 683.5,-2627.67 683.5,-2695.67"/>
<text text-anchor="middle" x="467" y="-2680.47" font-family="Times,serif" font-size="14.00">Attention Output Projection TP=4</text>
<text text-anchor="middle" x="467" y="-2665.47" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 (TP groups)</text>
<text text-anchor="middle" x="467" y="-2650.47" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
<text text-anchor="middle" x="467" y="-2635.47" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=128]</text>
</g>
<!-- attention&#45;&gt;attn_out -->
<g id="edge5" class="edge">
<title>attention&#45;&gt;attn_out</title>
<path fill="none" stroke="black" d="M467,-2781.49C467,-2781.49 467,-2705.75 467,-2705.75"/>
<polygon fill="black" stroke="black" points="470.5,-2705.75 467,-2695.75 463.5,-2705.75 470.5,-2705.75"/>
</g>
<!-- attn_allreduce -->
<g id="node7" class="node">
<title>attn_allreduce</title>
<ellipse fill="lightblue" stroke="black" cx="467" cy="-2493.58" rx="298.3" ry="48.17"/>
<text text-anchor="middle" x="467" y="-2512.38" font-family="Times,serif" font-size="14.00">TP All&#45;Reduce Attention</text>
<text text-anchor="middle" x="467" y="-2497.38" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 (TP groups)</text>
<text text-anchor="middle" x="467" y="-2482.38" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=128]</text>
<text text-anchor="middle" x="467" y="-2467.38" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- attn_out&#45;&gt;attn_allreduce -->
<g id="edge6" class="edge">
<title>attn_out&#45;&gt;attn_allreduce</title>
<path fill="none" stroke="black" d="M467,-2627.65C467,-2627.65 467,-2551.88 467,-2551.88"/>
<polygon fill="black" stroke="black" points="470.5,-2551.88 467,-2541.88 463.5,-2551.88 470.5,-2551.88"/>
</g>
<!-- residual1 -->
<g id="node8" class="node">
<title>residual1</title>
<polygon fill="lightgreen" stroke="black" points="678,-2359.5 256,-2359.5 256,-2291.5 678,-2291.5 678,-2359.5"/>
<text text-anchor="middle" x="467" y="-2344.3" font-family="Times,serif" font-size="14.00">Residual Connection</text>
<text text-anchor="middle" x="467" y="-2329.3" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127</text>
<text text-anchor="middle" x="467" y="-2314.3" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-2299.3" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- attn_allreduce&#45;&gt;residual1 -->
<g id="edge7" class="edge">
<title>attn_allreduce&#45;&gt;residual1</title>
<path fill="none" stroke="black" d="M467,-2445.42C467,-2445.42 467,-2369.53 467,-2369.53"/>
<polygon fill="black" stroke="black" points="470.5,-2369.53 467,-2359.53 463.5,-2369.53 470.5,-2369.53"/>
</g>
<!-- moe_gate -->
<g id="node9" class="node">
<title>moe_gate</title>
<polygon fill="lightyellow" stroke="black" points="914.75,-2205.5 202.48,-2205.5 19.25,-2069.5 731.52,-2069.5 914.75,-2205.5"/>
<text text-anchor="middle" x="467" y="-2156.3" font-family="Times,serif" font-size="14.00">MoE Gate (Expert Selection)</text>
<text text-anchor="middle" x="467" y="-2141.3" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127</text>
<text text-anchor="middle" x="467" y="-2126.3" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-2111.3" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, num_experts=16]</text>
</g>
<!-- residual1&#45;&gt;moe_gate -->
<g id="edge8" class="edge">
<title>residual1&#45;&gt;moe_gate</title>
<path fill="none" stroke="black" d="M467,-2291.45C467,-2291.45 467,-2215.56 467,-2215.56"/>
<polygon fill="black" stroke="black" points="470.5,-2215.56 467,-2205.56 463.5,-2215.56 470.5,-2215.56"/>
</g>
<!-- expert_route -->
<g id="node10" class="node">
<title>expert_route</title>
<polygon fill="lightyellow" stroke="black" points="892.14,-1983.5 215.84,-1983.5 41.86,-1847.5 718.16,-1847.5 892.14,-1983.5"/>
<text text-anchor="middle" x="467" y="-1934.3" font-family="Times,serif" font-size="14.00">Expert Routing EP=8</text>
<text text-anchor="middle" x="467" y="-1919.3" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127</text>
<text text-anchor="middle" x="467" y="-1904.3" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-1889.3" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, experts=2]</text>
</g>
<!-- moe_gate&#45;&gt;expert_route -->
<g id="edge9" class="edge">
<title>moe_gate&#45;&gt;expert_route</title>
<path fill="none" stroke="black" d="M467,-2069.38C467,-2069.38 467,-1993.87 467,-1993.87"/>
<polygon fill="black" stroke="black" points="470.5,-1993.87 467,-1983.87 463.5,-1993.87 470.5,-1993.87"/>
</g>
<!-- expert_0 -->
<g id="node11" class="node">
<title>expert_0</title>
<polygon fill="lightgreen" stroke="black" points="438,-1761.5 16,-1761.5 16,-1693.5 438,-1693.5 438,-1761.5"/>
<text text-anchor="middle" x="227" y="-1746.3" font-family="Times,serif" font-size="14.00">Expert 0 Computation</text>
<text text-anchor="middle" x="227" y="-1731.3" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 (2 experts per GPU)</text>
<text text-anchor="middle" x="227" y="-1716.3" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="227" y="-1701.3" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- expert_route&#45;&gt;expert_0 -->
<g id="edge10" class="edge">
<title>expert_route&#45;&gt;expert_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M239.97,-1847.36C239.97,-1847.36 239.97,-1771.68 239.97,-1771.68"/>
<polygon fill="black" stroke="black" points="243.47,-1771.68 239.97,-1761.68 236.47,-1771.68 243.47,-1771.68"/>
</g>
<!-- expert_1 -->
<g id="node12" class="node">
<title>expert_1</title>
<polygon fill="lightgreen" stroke="black" points="918,-1761.5 496,-1761.5 496,-1693.5 918,-1693.5 918,-1761.5"/>
<text text-anchor="middle" x="707" y="-1746.3" font-family="Times,serif" font-size="14.00">Expert 1 Computation</text>
<text text-anchor="middle" x="707" y="-1731.3" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 (2 experts per GPU)</text>
<text text-anchor="middle" x="707" y="-1716.3" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="707" y="-1701.3" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- expert_route&#45;&gt;expert_1 -->
<g id="edge12" class="edge">
<title>expert_route&#45;&gt;expert_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M694.03,-1847.36C694.03,-1847.36 694.03,-1771.68 694.03,-1771.68"/>
<polygon fill="black" stroke="black" points="697.53,-1771.68 694.03,-1761.68 690.53,-1771.68 697.53,-1771.68"/>
</g>
<!-- expert_combine -->
<g id="node13" class="node">
<title>expert_combine</title>
<polygon fill="lightyellow" stroke="black" points="904.52,-1607.5 208.52,-1607.5 29.48,-1471.5 725.48,-1471.5 904.52,-1607.5"/>
<text text-anchor="middle" x="467" y="-1558.3" font-family="Times,serif" font-size="14.00">Expert Combination EP=8</text>
<text text-anchor="middle" x="467" y="-1543.3" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127</text>
<text text-anchor="middle" x="467" y="-1528.3" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, experts=2]</text>
<text text-anchor="middle" x="467" y="-1513.3" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- expert_0&#45;&gt;expert_combine -->
<g id="edge11" class="edge">
<title>expert_0&#45;&gt;expert_combine</title>
<path fill="none" stroke="black" d="M233.75,-1693.45C233.75,-1693.45 233.75,-1617.56 233.75,-1617.56"/>
<polygon fill="black" stroke="black" points="237.25,-1617.56 233.75,-1607.56 230.25,-1617.56 237.25,-1617.56"/>
</g>
<!-- expert_1&#45;&gt;expert_combine -->
<g id="edge13" class="edge">
<title>expert_1&#45;&gt;expert_combine</title>
<path fill="none" stroke="black" d="M700.25,-1693.45C700.25,-1693.45 700.25,-1617.56 700.25,-1617.56"/>
<polygon fill="black" stroke="black" points="703.76,-1617.56 700.25,-1607.56 696.76,-1617.56 703.76,-1617.56"/>
</g>
<!-- stage1_to_stage2 -->
<g id="node14" class="node">
<title>stage1_to_stage2</title>
<ellipse fill="lightblue" stroke="black" cx="467" cy="-1337.42" rx="298.3" ry="48.17"/>
<text text-anchor="middle" x="467" y="-1356.22" font-family="Times,serif" font-size="14.00">Pipeline Communication PP=2</text>
<text text-anchor="middle" x="467" y="-1341.22" font-family="Times,serif" font-size="14.00">GPU: 0&#45;127 â†’ 128&#45;255</text>
<text text-anchor="middle" x="467" y="-1326.22" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-1311.22" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- expert_combine&#45;&gt;stage1_to_stage2 -->
<g id="edge14" class="edge">
<title>expert_combine&#45;&gt;stage1_to_stage2</title>
<path fill="none" stroke="black" d="M467,-1471.37C467,-1471.37 467,-1395.8 467,-1395.8"/>
<polygon fill="black" stroke="black" points="470.5,-1395.8 467,-1385.8 463.5,-1395.8 470.5,-1395.8"/>
</g>
<!-- layernorm8 -->
<g id="node15" class="node">
<title>layernorm8</title>
<polygon fill="lightgreen" stroke="black" points="678,-1203.33 256,-1203.33 256,-1135.33 678,-1135.33 678,-1203.33"/>
<text text-anchor="middle" x="467" y="-1188.13" font-family="Times,serif" font-size="14.00">LayerNorm (Layer 8)</text>
<text text-anchor="middle" x="467" y="-1173.13" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255</text>
<text text-anchor="middle" x="467" y="-1158.13" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-1143.13" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- stage1_to_stage2&#45;&gt;layernorm8 -->
<g id="edge15" class="edge">
<title>stage1_to_stage2&#45;&gt;layernorm8</title>
<path fill="none" stroke="black" d="M467,-1289.25C467,-1289.25 467,-1213.37 467,-1213.37"/>
<polygon fill="black" stroke="black" points="470.5,-1213.37 467,-1203.37 463.5,-1213.37 470.5,-1213.37"/>
</g>
<!-- qkv_proj2 -->
<g id="node16" class="node">
<title>qkv_proj2</title>
<polygon fill="lightgreen" stroke="black" points="689.5,-1049.33 244.5,-1049.33 244.5,-981.33 689.5,-981.33 689.5,-1049.33"/>
<text text-anchor="middle" x="467" y="-1034.13" font-family="Times,serif" font-size="14.00">QKV Projection TP=4</text>
<text text-anchor="middle" x="467" y="-1019.13" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255 (TP groups)</text>
<text text-anchor="middle" x="467" y="-1004.13" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-989.13" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
</g>
<!-- layernorm8&#45;&gt;qkv_proj2 -->
<g id="edge16" class="edge">
<title>layernorm8&#45;&gt;qkv_proj2</title>
<path fill="none" stroke="black" d="M467,-1135.16C467,-1135.16 467,-1059.42 467,-1059.42"/>
<polygon fill="black" stroke="black" points="470.5,-1059.42 467,-1049.42 463.5,-1059.42 470.5,-1059.42"/>
</g>
<!-- qkv_allreduce2 -->
<g id="node17" class="node">
<title>qkv_allreduce2</title>
<ellipse fill="lightblue" stroke="black" cx="467" cy="-847.25" rx="314.83" ry="48.17"/>
<text text-anchor="middle" x="467" y="-866.05" font-family="Times,serif" font-size="14.00">TP All&#45;Reduce QKV</text>
<text text-anchor="middle" x="467" y="-851.05" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255 (TP groups)</text>
<text text-anchor="middle" x="467" y="-836.05" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, heads=4, d_k=32]</text>
<text text-anchor="middle" x="467" y="-821.05" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
</g>
<!-- qkv_proj2&#45;&gt;qkv_allreduce2 -->
<g id="edge17" class="edge">
<title>qkv_proj2&#45;&gt;qkv_allreduce2</title>
<path fill="none" stroke="black" d="M467,-981.32C467,-981.32 467,-905.55 467,-905.55"/>
<polygon fill="black" stroke="black" points="470.5,-905.55 467,-895.55 463.5,-905.55 470.5,-905.55"/>
</g>
<!-- attention2 -->
<g id="node18" class="node">
<title>attention2</title>
<polygon fill="lightgreen" stroke="black" points="689.5,-713.17 244.5,-713.17 244.5,-645.17 689.5,-645.17 689.5,-713.17"/>
<text text-anchor="middle" x="467" y="-697.97" font-family="Times,serif" font-size="14.00">Multi&#45;Head Attention</text>
<text text-anchor="middle" x="467" y="-682.97" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255</text>
<text text-anchor="middle" x="467" y="-667.97" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
<text text-anchor="middle" x="467" y="-652.97" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
</g>
<!-- qkv_allreduce2&#45;&gt;attention2 -->
<g id="edge18" class="edge">
<title>qkv_allreduce2&#45;&gt;attention2</title>
<path fill="none" stroke="black" d="M467,-799.08C467,-799.08 467,-723.2 467,-723.2"/>
<polygon fill="black" stroke="black" points="470.5,-723.2 467,-713.2 463.5,-723.2 470.5,-723.2"/>
</g>
<!-- attn_out2 -->
<g id="node19" class="node">
<title>attn_out2</title>
<polygon fill="lightgreen" stroke="black" points="683.5,-559.17 250.5,-559.17 250.5,-491.17 683.5,-491.17 683.5,-559.17"/>
<text text-anchor="middle" x="467" y="-543.97" font-family="Times,serif" font-size="14.00">Attention Output Projection TP=4</text>
<text text-anchor="middle" x="467" y="-528.97" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255 (TP groups)</text>
<text text-anchor="middle" x="467" y="-513.97" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, heads=16, d_k=32]</text>
<text text-anchor="middle" x="467" y="-498.97" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=128]</text>
</g>
<!-- attention2&#45;&gt;attn_out2 -->
<g id="edge19" class="edge">
<title>attention2&#45;&gt;attn_out2</title>
<path fill="none" stroke="black" d="M467,-644.99C467,-644.99 467,-569.25 467,-569.25"/>
<polygon fill="black" stroke="black" points="470.5,-569.25 467,-559.25 463.5,-569.25 470.5,-569.25"/>
</g>
<!-- attn_allreduce2 -->
<g id="node20" class="node">
<title>attn_allreduce2</title>
<ellipse fill="lightblue" stroke="black" cx="467" cy="-357.08" rx="298.3" ry="48.17"/>
<text text-anchor="middle" x="467" y="-375.88" font-family="Times,serif" font-size="14.00">TP All&#45;Reduce Attention</text>
<text text-anchor="middle" x="467" y="-360.88" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255 (TP groups)</text>
<text text-anchor="middle" x="467" y="-345.88" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=128]</text>
<text text-anchor="middle" x="467" y="-330.88" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- attn_out2&#45;&gt;attn_allreduce2 -->
<g id="edge20" class="edge">
<title>attn_out2&#45;&gt;attn_allreduce2</title>
<path fill="none" stroke="black" d="M467,-491.15C467,-491.15 467,-415.38 467,-415.38"/>
<polygon fill="black" stroke="black" points="470.5,-415.38 467,-405.38 463.5,-415.38 470.5,-415.38"/>
</g>
<!-- final_layernorm -->
<g id="node21" class="node">
<title>final_layernorm</title>
<polygon fill="lightgreen" stroke="black" points="678,-223 256,-223 256,-155 678,-155 678,-223"/>
<text text-anchor="middle" x="467" y="-207.8" font-family="Times,serif" font-size="14.00">Final LayerNorm</text>
<text text-anchor="middle" x="467" y="-192.8" font-family="Times,serif" font-size="14.00">GPU: 128&#45;255</text>
<text text-anchor="middle" x="467" y="-177.8" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-162.8" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- attn_allreduce2&#45;&gt;final_layernorm -->
<g id="edge21" class="edge">
<title>attn_allreduce2&#45;&gt;final_layernorm</title>
<path fill="none" stroke="black" d="M467,-308.92C467,-308.92 467,-233.03 467,-233.03"/>
<polygon fill="black" stroke="black" points="470.5,-233.03 467,-223.03 463.5,-233.03 470.5,-233.03"/>
</g>
<!-- output -->
<g id="node22" class="node">
<title>output</title>
<polygon fill="white" stroke="black" points="672,-69 262,-69 262,-16 672,-16 672,-69"/>
<text text-anchor="middle" x="467" y="-53.8" font-family="Times,serif" font-size="14.00">Output</text>
<text text-anchor="middle" x="467" y="-38.8" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="467" y="-23.8" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, vocab_size=V]</text>
</g>
<!-- final_layernorm&#45;&gt;output -->
<g id="edge22" class="edge">
<title>final_layernorm&#45;&gt;output</title>
<path fill="none" stroke="black" d="M467,-154.65C467,-154.65 467,-79.32 467,-79.32"/>
<polygon fill="black" stroke="black" points="470.5,-79.32 467,-69.32 463.5,-79.32 470.5,-79.32"/>
</g>
<!-- dp_sync -->
<g id="node23" class="node">
<title>dp_sync</title>
<ellipse fill="lightblue" stroke="black" cx="1034" cy="-3473.92" rx="298.3" ry="48.17"/>
<text text-anchor="middle" x="1034" y="-3492.72" font-family="Times,serif" font-size="14.00">Data Parallelism Sync DP=4</text>
<text text-anchor="middle" x="1034" y="-3477.72" font-family="Times,serif" font-size="14.00">GPU: All DP groups</text>
<text text-anchor="middle" x="1034" y="-3462.72" font-family="Times,serif" font-size="14.00">Input: [batch_size=32, seq_len=1024, token_dim=512]</text>
<text text-anchor="middle" x="1034" y="-3447.72" font-family="Times,serif" font-size="14.00">Output: [batch_size=32, seq_len=1024, token_dim=512]</text>
</g>
<!-- output&#45;&gt;dp_sync -->
<g id="edge23" class="edge">
<title>output&#45;&gt;dp_sync</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M672.1,-42C865.27,-42 1125.2,-42 1125.2,-42 1125.2,-42 1125.2,-3418 1125.2,-3418"/>
<polygon fill="black" stroke="black" points="1121.7,-3418 1125.2,-3428 1128.7,-3418 1121.7,-3418"/>
</g>
</g>
</svg>
