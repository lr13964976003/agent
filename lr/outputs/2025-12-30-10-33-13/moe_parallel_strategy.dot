// MoE Model Parallel Strategy DAG
digraph {
	rankdir=TB size="20,30"
	node [fontname=Arial fontsize=10]
	node [fillcolor=lightblue shape=ellipse style=filled]
	node [fillcolor=lightgreen shape=rectangle style=filled]
	node [fillcolor=lightyellow shape=parallelogram style=filled]
	input [label="Input\nInput: [batch_size=4, seq_len=1024, hidden=512]\nOutput: [batch_size=4, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
	subgraph dp_0 {
		fillcolor=lightgray label="DP Replica 0" rank=same style="rounded,filled"
		subgraph stage1_dp0 {
			fillcolor=lightcyan label="PP Stage 1 (Layers 1-8)" style="rounded,filled"
			stage1_input_dp0 [label="Stage1 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage1_input_dp0 -> attn_input_l1_dp0
			subgraph layer1_dp0_stage1 {
				label="Layer 1" style=rounded
				attn_input_l1_dp0 [label="Attention Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp0 [label="Attention TP0 L1\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp0 -> attn_tp0_l1_dp0
				attn_tp1_l1_dp0 [label="Attention TP1 L1\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp0 -> attn_tp1_l1_dp0
				attn_tp2_l1_dp0 [label="Attention TP2 L1\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp0 -> attn_tp2_l1_dp0
				attn_tp3_l1_dp0 [label="Attention TP3 L1\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp0 -> attn_tp3_l1_dp0
				allreduce_l1_dp0 [label="AllReduce L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp0 -> allreduce_l1_dp0
				attn_tp1_l1_dp0 -> allreduce_l1_dp0
				attn_tp2_l1_dp0 -> allreduce_l1_dp0
				attn_tp3_l1_dp0 -> allreduce_l1_dp0
				moe_input_l1_dp0 [label="MoE Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l1_dp0 [label="Router L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l1_dp0 -> moe_input_l1_dp0
				moe_input_l1_dp0 -> router_l1_dp0
				expert0_l1_dp0 [label="Expert 0 L1\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert0_l1_dp0 [label=select style=dashed]
				expert1_l1_dp0 [label="Expert 1 L1\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert1_l1_dp0 [label=select style=dashed]
				expert2_l1_dp0 [label="Expert 2 L1\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert2_l1_dp0 [label=select style=dashed]
				expert3_l1_dp0 [label="Expert 3 L1\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert3_l1_dp0 [label=select style=dashed]
				expert4_l1_dp0 [label="Expert 4 L1\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert4_l1_dp0 [label=select style=dashed]
				expert5_l1_dp0 [label="Expert 5 L1\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert5_l1_dp0 [label=select style=dashed]
				expert6_l1_dp0 [label="Expert 6 L1\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert6_l1_dp0 [label=select style=dashed]
				expert7_l1_dp0 [label="Expert 7 L1\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert7_l1_dp0 [label=select style=dashed]
				expert8_l1_dp0 [label="Expert 8 L1\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert8_l1_dp0 [label=select style=dashed]
				expert9_l1_dp0 [label="Expert 9 L1\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert9_l1_dp0 [label=select style=dashed]
				expert10_l1_dp0 [label="Expert 10 L1\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert10_l1_dp0 [label=select style=dashed]
				expert11_l1_dp0 [label="Expert 11 L1\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert11_l1_dp0 [label=select style=dashed]
				expert12_l1_dp0 [label="Expert 12 L1\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert12_l1_dp0 [label=select style=dashed]
				expert13_l1_dp0 [label="Expert 13 L1\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert13_l1_dp0 [label=select style=dashed]
				expert14_l1_dp0 [label="Expert 14 L1\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert14_l1_dp0 [label=select style=dashed]
				expert15_l1_dp0 [label="Expert 15 L1\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp0 -> expert15_l1_dp0 [label=select style=dashed]
				expert_agg_l1_dp0 [label="Expert Aggregation L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l1_dp0 -> expert_agg_l1_dp0
				expert1_l1_dp0 -> expert_agg_l1_dp0
				expert2_l1_dp0 -> expert_agg_l1_dp0
				expert3_l1_dp0 -> expert_agg_l1_dp0
				expert4_l1_dp0 -> expert_agg_l1_dp0
				expert5_l1_dp0 -> expert_agg_l1_dp0
				expert6_l1_dp0 -> expert_agg_l1_dp0
				expert7_l1_dp0 -> expert_agg_l1_dp0
				expert8_l1_dp0 -> expert_agg_l1_dp0
				expert9_l1_dp0 -> expert_agg_l1_dp0
				expert10_l1_dp0 -> expert_agg_l1_dp0
				expert11_l1_dp0 -> expert_agg_l1_dp0
				expert12_l1_dp0 -> expert_agg_l1_dp0
				expert13_l1_dp0 -> expert_agg_l1_dp0
				expert14_l1_dp0 -> expert_agg_l1_dp0
				expert15_l1_dp0 -> expert_agg_l1_dp0
				layer1_output_dp0 [label="Layer 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l1_dp0 -> layer1_output_dp0
			}
			layer1_output_dp0 -> attn_input_l2_dp0
			subgraph layer2_dp0_stage1 {
				label="Layer 2" style=rounded
				attn_input_l2_dp0 [label="Attention Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp0 [label="Attention TP0 L2\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp0 -> attn_tp0_l2_dp0
				attn_tp1_l2_dp0 [label="Attention TP1 L2\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp0 -> attn_tp1_l2_dp0
				attn_tp2_l2_dp0 [label="Attention TP2 L2\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp0 -> attn_tp2_l2_dp0
				attn_tp3_l2_dp0 [label="Attention TP3 L2\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp0 -> attn_tp3_l2_dp0
				allreduce_l2_dp0 [label="AllReduce L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp0 -> allreduce_l2_dp0
				attn_tp1_l2_dp0 -> allreduce_l2_dp0
				attn_tp2_l2_dp0 -> allreduce_l2_dp0
				attn_tp3_l2_dp0 -> allreduce_l2_dp0
				moe_input_l2_dp0 [label="MoE Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l2_dp0 [label="Router L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l2_dp0 -> moe_input_l2_dp0
				moe_input_l2_dp0 -> router_l2_dp0
				expert0_l2_dp0 [label="Expert 0 L2\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert0_l2_dp0 [label=select style=dashed]
				expert1_l2_dp0 [label="Expert 1 L2\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert1_l2_dp0 [label=select style=dashed]
				expert2_l2_dp0 [label="Expert 2 L2\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert2_l2_dp0 [label=select style=dashed]
				expert3_l2_dp0 [label="Expert 3 L2\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert3_l2_dp0 [label=select style=dashed]
				expert4_l2_dp0 [label="Expert 4 L2\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert4_l2_dp0 [label=select style=dashed]
				expert5_l2_dp0 [label="Expert 5 L2\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert5_l2_dp0 [label=select style=dashed]
				expert6_l2_dp0 [label="Expert 6 L2\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert6_l2_dp0 [label=select style=dashed]
				expert7_l2_dp0 [label="Expert 7 L2\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert7_l2_dp0 [label=select style=dashed]
				expert8_l2_dp0 [label="Expert 8 L2\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert8_l2_dp0 [label=select style=dashed]
				expert9_l2_dp0 [label="Expert 9 L2\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert9_l2_dp0 [label=select style=dashed]
				expert10_l2_dp0 [label="Expert 10 L2\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert10_l2_dp0 [label=select style=dashed]
				expert11_l2_dp0 [label="Expert 11 L2\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert11_l2_dp0 [label=select style=dashed]
				expert12_l2_dp0 [label="Expert 12 L2\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert12_l2_dp0 [label=select style=dashed]
				expert13_l2_dp0 [label="Expert 13 L2\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert13_l2_dp0 [label=select style=dashed]
				expert14_l2_dp0 [label="Expert 14 L2\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert14_l2_dp0 [label=select style=dashed]
				expert15_l2_dp0 [label="Expert 15 L2\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp0 -> expert15_l2_dp0 [label=select style=dashed]
				expert_agg_l2_dp0 [label="Expert Aggregation L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l2_dp0 -> expert_agg_l2_dp0
				expert1_l2_dp0 -> expert_agg_l2_dp0
				expert2_l2_dp0 -> expert_agg_l2_dp0
				expert3_l2_dp0 -> expert_agg_l2_dp0
				expert4_l2_dp0 -> expert_agg_l2_dp0
				expert5_l2_dp0 -> expert_agg_l2_dp0
				expert6_l2_dp0 -> expert_agg_l2_dp0
				expert7_l2_dp0 -> expert_agg_l2_dp0
				expert8_l2_dp0 -> expert_agg_l2_dp0
				expert9_l2_dp0 -> expert_agg_l2_dp0
				expert10_l2_dp0 -> expert_agg_l2_dp0
				expert11_l2_dp0 -> expert_agg_l2_dp0
				expert12_l2_dp0 -> expert_agg_l2_dp0
				expert13_l2_dp0 -> expert_agg_l2_dp0
				expert14_l2_dp0 -> expert_agg_l2_dp0
				expert15_l2_dp0 -> expert_agg_l2_dp0
				layer2_output_dp0 [label="Layer 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l2_dp0 -> layer2_output_dp0
			}
			layer2_output_dp0 -> attn_input_l3_dp0
			subgraph layer3_dp0_stage1 {
				label="Layer 3" style=rounded
				attn_input_l3_dp0 [label="Attention Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp0 [label="Attention TP0 L3\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp0 -> attn_tp0_l3_dp0
				attn_tp1_l3_dp0 [label="Attention TP1 L3\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp0 -> attn_tp1_l3_dp0
				attn_tp2_l3_dp0 [label="Attention TP2 L3\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp0 -> attn_tp2_l3_dp0
				attn_tp3_l3_dp0 [label="Attention TP3 L3\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp0 -> attn_tp3_l3_dp0
				allreduce_l3_dp0 [label="AllReduce L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp0 -> allreduce_l3_dp0
				attn_tp1_l3_dp0 -> allreduce_l3_dp0
				attn_tp2_l3_dp0 -> allreduce_l3_dp0
				attn_tp3_l3_dp0 -> allreduce_l3_dp0
				moe_input_l3_dp0 [label="MoE Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l3_dp0 [label="Router L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l3_dp0 -> moe_input_l3_dp0
				moe_input_l3_dp0 -> router_l3_dp0
				expert0_l3_dp0 [label="Expert 0 L3\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert0_l3_dp0 [label=select style=dashed]
				expert1_l3_dp0 [label="Expert 1 L3\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert1_l3_dp0 [label=select style=dashed]
				expert2_l3_dp0 [label="Expert 2 L3\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert2_l3_dp0 [label=select style=dashed]
				expert3_l3_dp0 [label="Expert 3 L3\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert3_l3_dp0 [label=select style=dashed]
				expert4_l3_dp0 [label="Expert 4 L3\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert4_l3_dp0 [label=select style=dashed]
				expert5_l3_dp0 [label="Expert 5 L3\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert5_l3_dp0 [label=select style=dashed]
				expert6_l3_dp0 [label="Expert 6 L3\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert6_l3_dp0 [label=select style=dashed]
				expert7_l3_dp0 [label="Expert 7 L3\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert7_l3_dp0 [label=select style=dashed]
				expert8_l3_dp0 [label="Expert 8 L3\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert8_l3_dp0 [label=select style=dashed]
				expert9_l3_dp0 [label="Expert 9 L3\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert9_l3_dp0 [label=select style=dashed]
				expert10_l3_dp0 [label="Expert 10 L3\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert10_l3_dp0 [label=select style=dashed]
				expert11_l3_dp0 [label="Expert 11 L3\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert11_l3_dp0 [label=select style=dashed]
				expert12_l3_dp0 [label="Expert 12 L3\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert12_l3_dp0 [label=select style=dashed]
				expert13_l3_dp0 [label="Expert 13 L3\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert13_l3_dp0 [label=select style=dashed]
				expert14_l3_dp0 [label="Expert 14 L3\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert14_l3_dp0 [label=select style=dashed]
				expert15_l3_dp0 [label="Expert 15 L3\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp0 -> expert15_l3_dp0 [label=select style=dashed]
				expert_agg_l3_dp0 [label="Expert Aggregation L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l3_dp0 -> expert_agg_l3_dp0
				expert1_l3_dp0 -> expert_agg_l3_dp0
				expert2_l3_dp0 -> expert_agg_l3_dp0
				expert3_l3_dp0 -> expert_agg_l3_dp0
				expert4_l3_dp0 -> expert_agg_l3_dp0
				expert5_l3_dp0 -> expert_agg_l3_dp0
				expert6_l3_dp0 -> expert_agg_l3_dp0
				expert7_l3_dp0 -> expert_agg_l3_dp0
				expert8_l3_dp0 -> expert_agg_l3_dp0
				expert9_l3_dp0 -> expert_agg_l3_dp0
				expert10_l3_dp0 -> expert_agg_l3_dp0
				expert11_l3_dp0 -> expert_agg_l3_dp0
				expert12_l3_dp0 -> expert_agg_l3_dp0
				expert13_l3_dp0 -> expert_agg_l3_dp0
				expert14_l3_dp0 -> expert_agg_l3_dp0
				expert15_l3_dp0 -> expert_agg_l3_dp0
				layer3_output_dp0 [label="Layer 3 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l3_dp0 -> layer3_output_dp0
			}
			layer3_output_dp0 -> attn_input_l4_dp0
			subgraph layer4_dp0_stage1 {
				label="Layer 4" style=rounded
				attn_input_l4_dp0 [label="Attention Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp0 [label="Attention TP0 L4\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp0 -> attn_tp0_l4_dp0
				attn_tp1_l4_dp0 [label="Attention TP1 L4\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp0 -> attn_tp1_l4_dp0
				attn_tp2_l4_dp0 [label="Attention TP2 L4\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp0 -> attn_tp2_l4_dp0
				attn_tp3_l4_dp0 [label="Attention TP3 L4\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp0 -> attn_tp3_l4_dp0
				allreduce_l4_dp0 [label="AllReduce L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp0 -> allreduce_l4_dp0
				attn_tp1_l4_dp0 -> allreduce_l4_dp0
				attn_tp2_l4_dp0 -> allreduce_l4_dp0
				attn_tp3_l4_dp0 -> allreduce_l4_dp0
				moe_input_l4_dp0 [label="MoE Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l4_dp0 [label="Router L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l4_dp0 -> moe_input_l4_dp0
				moe_input_l4_dp0 -> router_l4_dp0
				expert0_l4_dp0 [label="Expert 0 L4\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert0_l4_dp0 [label=select style=dashed]
				expert1_l4_dp0 [label="Expert 1 L4\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert1_l4_dp0 [label=select style=dashed]
				expert2_l4_dp0 [label="Expert 2 L4\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert2_l4_dp0 [label=select style=dashed]
				expert3_l4_dp0 [label="Expert 3 L4\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert3_l4_dp0 [label=select style=dashed]
				expert4_l4_dp0 [label="Expert 4 L4\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert4_l4_dp0 [label=select style=dashed]
				expert5_l4_dp0 [label="Expert 5 L4\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert5_l4_dp0 [label=select style=dashed]
				expert6_l4_dp0 [label="Expert 6 L4\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert6_l4_dp0 [label=select style=dashed]
				expert7_l4_dp0 [label="Expert 7 L4\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert7_l4_dp0 [label=select style=dashed]
				expert8_l4_dp0 [label="Expert 8 L4\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert8_l4_dp0 [label=select style=dashed]
				expert9_l4_dp0 [label="Expert 9 L4\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert9_l4_dp0 [label=select style=dashed]
				expert10_l4_dp0 [label="Expert 10 L4\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert10_l4_dp0 [label=select style=dashed]
				expert11_l4_dp0 [label="Expert 11 L4\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert11_l4_dp0 [label=select style=dashed]
				expert12_l4_dp0 [label="Expert 12 L4\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert12_l4_dp0 [label=select style=dashed]
				expert13_l4_dp0 [label="Expert 13 L4\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert13_l4_dp0 [label=select style=dashed]
				expert14_l4_dp0 [label="Expert 14 L4\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert14_l4_dp0 [label=select style=dashed]
				expert15_l4_dp0 [label="Expert 15 L4\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp0 -> expert15_l4_dp0 [label=select style=dashed]
				expert_agg_l4_dp0 [label="Expert Aggregation L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l4_dp0 -> expert_agg_l4_dp0
				expert1_l4_dp0 -> expert_agg_l4_dp0
				expert2_l4_dp0 -> expert_agg_l4_dp0
				expert3_l4_dp0 -> expert_agg_l4_dp0
				expert4_l4_dp0 -> expert_agg_l4_dp0
				expert5_l4_dp0 -> expert_agg_l4_dp0
				expert6_l4_dp0 -> expert_agg_l4_dp0
				expert7_l4_dp0 -> expert_agg_l4_dp0
				expert8_l4_dp0 -> expert_agg_l4_dp0
				expert9_l4_dp0 -> expert_agg_l4_dp0
				expert10_l4_dp0 -> expert_agg_l4_dp0
				expert11_l4_dp0 -> expert_agg_l4_dp0
				expert12_l4_dp0 -> expert_agg_l4_dp0
				expert13_l4_dp0 -> expert_agg_l4_dp0
				expert14_l4_dp0 -> expert_agg_l4_dp0
				expert15_l4_dp0 -> expert_agg_l4_dp0
				layer4_output_dp0 [label="Layer 4 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l4_dp0 -> layer4_output_dp0
			}
			layer4_output_dp0 -> attn_input_l5_dp0
			subgraph layer5_dp0_stage1 {
				label="Layer 5" style=rounded
				attn_input_l5_dp0 [label="Attention Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp0 [label="Attention TP0 L5\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp0 -> attn_tp0_l5_dp0
				attn_tp1_l5_dp0 [label="Attention TP1 L5\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp0 -> attn_tp1_l5_dp0
				attn_tp2_l5_dp0 [label="Attention TP2 L5\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp0 -> attn_tp2_l5_dp0
				attn_tp3_l5_dp0 [label="Attention TP3 L5\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp0 -> attn_tp3_l5_dp0
				allreduce_l5_dp0 [label="AllReduce L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp0 -> allreduce_l5_dp0
				attn_tp1_l5_dp0 -> allreduce_l5_dp0
				attn_tp2_l5_dp0 -> allreduce_l5_dp0
				attn_tp3_l5_dp0 -> allreduce_l5_dp0
				moe_input_l5_dp0 [label="MoE Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l5_dp0 [label="Router L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l5_dp0 -> moe_input_l5_dp0
				moe_input_l5_dp0 -> router_l5_dp0
				expert0_l5_dp0 [label="Expert 0 L5\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert0_l5_dp0 [label=select style=dashed]
				expert1_l5_dp0 [label="Expert 1 L5\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert1_l5_dp0 [label=select style=dashed]
				expert2_l5_dp0 [label="Expert 2 L5\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert2_l5_dp0 [label=select style=dashed]
				expert3_l5_dp0 [label="Expert 3 L5\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert3_l5_dp0 [label=select style=dashed]
				expert4_l5_dp0 [label="Expert 4 L5\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert4_l5_dp0 [label=select style=dashed]
				expert5_l5_dp0 [label="Expert 5 L5\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert5_l5_dp0 [label=select style=dashed]
				expert6_l5_dp0 [label="Expert 6 L5\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert6_l5_dp0 [label=select style=dashed]
				expert7_l5_dp0 [label="Expert 7 L5\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert7_l5_dp0 [label=select style=dashed]
				expert8_l5_dp0 [label="Expert 8 L5\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert8_l5_dp0 [label=select style=dashed]
				expert9_l5_dp0 [label="Expert 9 L5\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert9_l5_dp0 [label=select style=dashed]
				expert10_l5_dp0 [label="Expert 10 L5\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert10_l5_dp0 [label=select style=dashed]
				expert11_l5_dp0 [label="Expert 11 L5\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert11_l5_dp0 [label=select style=dashed]
				expert12_l5_dp0 [label="Expert 12 L5\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert12_l5_dp0 [label=select style=dashed]
				expert13_l5_dp0 [label="Expert 13 L5\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert13_l5_dp0 [label=select style=dashed]
				expert14_l5_dp0 [label="Expert 14 L5\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert14_l5_dp0 [label=select style=dashed]
				expert15_l5_dp0 [label="Expert 15 L5\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp0 -> expert15_l5_dp0 [label=select style=dashed]
				expert_agg_l5_dp0 [label="Expert Aggregation L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l5_dp0 -> expert_agg_l5_dp0
				expert1_l5_dp0 -> expert_agg_l5_dp0
				expert2_l5_dp0 -> expert_agg_l5_dp0
				expert3_l5_dp0 -> expert_agg_l5_dp0
				expert4_l5_dp0 -> expert_agg_l5_dp0
				expert5_l5_dp0 -> expert_agg_l5_dp0
				expert6_l5_dp0 -> expert_agg_l5_dp0
				expert7_l5_dp0 -> expert_agg_l5_dp0
				expert8_l5_dp0 -> expert_agg_l5_dp0
				expert9_l5_dp0 -> expert_agg_l5_dp0
				expert10_l5_dp0 -> expert_agg_l5_dp0
				expert11_l5_dp0 -> expert_agg_l5_dp0
				expert12_l5_dp0 -> expert_agg_l5_dp0
				expert13_l5_dp0 -> expert_agg_l5_dp0
				expert14_l5_dp0 -> expert_agg_l5_dp0
				expert15_l5_dp0 -> expert_agg_l5_dp0
				layer5_output_dp0 [label="Layer 5 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l5_dp0 -> layer5_output_dp0
			}
			layer5_output_dp0 -> attn_input_l6_dp0
			subgraph layer6_dp0_stage1 {
				label="Layer 6" style=rounded
				attn_input_l6_dp0 [label="Attention Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp0 [label="Attention TP0 L6\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp0 -> attn_tp0_l6_dp0
				attn_tp1_l6_dp0 [label="Attention TP1 L6\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp0 -> attn_tp1_l6_dp0
				attn_tp2_l6_dp0 [label="Attention TP2 L6\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp0 -> attn_tp2_l6_dp0
				attn_tp3_l6_dp0 [label="Attention TP3 L6\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp0 -> attn_tp3_l6_dp0
				allreduce_l6_dp0 [label="AllReduce L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp0 -> allreduce_l6_dp0
				attn_tp1_l6_dp0 -> allreduce_l6_dp0
				attn_tp2_l6_dp0 -> allreduce_l6_dp0
				attn_tp3_l6_dp0 -> allreduce_l6_dp0
				moe_input_l6_dp0 [label="MoE Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l6_dp0 [label="Router L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l6_dp0 -> moe_input_l6_dp0
				moe_input_l6_dp0 -> router_l6_dp0
				expert0_l6_dp0 [label="Expert 0 L6\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert0_l6_dp0 [label=select style=dashed]
				expert1_l6_dp0 [label="Expert 1 L6\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert1_l6_dp0 [label=select style=dashed]
				expert2_l6_dp0 [label="Expert 2 L6\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert2_l6_dp0 [label=select style=dashed]
				expert3_l6_dp0 [label="Expert 3 L6\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert3_l6_dp0 [label=select style=dashed]
				expert4_l6_dp0 [label="Expert 4 L6\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert4_l6_dp0 [label=select style=dashed]
				expert5_l6_dp0 [label="Expert 5 L6\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert5_l6_dp0 [label=select style=dashed]
				expert6_l6_dp0 [label="Expert 6 L6\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert6_l6_dp0 [label=select style=dashed]
				expert7_l6_dp0 [label="Expert 7 L6\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert7_l6_dp0 [label=select style=dashed]
				expert8_l6_dp0 [label="Expert 8 L6\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert8_l6_dp0 [label=select style=dashed]
				expert9_l6_dp0 [label="Expert 9 L6\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert9_l6_dp0 [label=select style=dashed]
				expert10_l6_dp0 [label="Expert 10 L6\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert10_l6_dp0 [label=select style=dashed]
				expert11_l6_dp0 [label="Expert 11 L6\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert11_l6_dp0 [label=select style=dashed]
				expert12_l6_dp0 [label="Expert 12 L6\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert12_l6_dp0 [label=select style=dashed]
				expert13_l6_dp0 [label="Expert 13 L6\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert13_l6_dp0 [label=select style=dashed]
				expert14_l6_dp0 [label="Expert 14 L6\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert14_l6_dp0 [label=select style=dashed]
				expert15_l6_dp0 [label="Expert 15 L6\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp0 -> expert15_l6_dp0 [label=select style=dashed]
				expert_agg_l6_dp0 [label="Expert Aggregation L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l6_dp0 -> expert_agg_l6_dp0
				expert1_l6_dp0 -> expert_agg_l6_dp0
				expert2_l6_dp0 -> expert_agg_l6_dp0
				expert3_l6_dp0 -> expert_agg_l6_dp0
				expert4_l6_dp0 -> expert_agg_l6_dp0
				expert5_l6_dp0 -> expert_agg_l6_dp0
				expert6_l6_dp0 -> expert_agg_l6_dp0
				expert7_l6_dp0 -> expert_agg_l6_dp0
				expert8_l6_dp0 -> expert_agg_l6_dp0
				expert9_l6_dp0 -> expert_agg_l6_dp0
				expert10_l6_dp0 -> expert_agg_l6_dp0
				expert11_l6_dp0 -> expert_agg_l6_dp0
				expert12_l6_dp0 -> expert_agg_l6_dp0
				expert13_l6_dp0 -> expert_agg_l6_dp0
				expert14_l6_dp0 -> expert_agg_l6_dp0
				expert15_l6_dp0 -> expert_agg_l6_dp0
				layer6_output_dp0 [label="Layer 6 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l6_dp0 -> layer6_output_dp0
			}
			layer6_output_dp0 -> attn_input_l7_dp0
			subgraph layer7_dp0_stage1 {
				label="Layer 7" style=rounded
				attn_input_l7_dp0 [label="Attention Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp0 [label="Attention TP0 L7\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp0 -> attn_tp0_l7_dp0
				attn_tp1_l7_dp0 [label="Attention TP1 L7\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp0 -> attn_tp1_l7_dp0
				attn_tp2_l7_dp0 [label="Attention TP2 L7\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp0 -> attn_tp2_l7_dp0
				attn_tp3_l7_dp0 [label="Attention TP3 L7\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp0 -> attn_tp3_l7_dp0
				allreduce_l7_dp0 [label="AllReduce L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp0 -> allreduce_l7_dp0
				attn_tp1_l7_dp0 -> allreduce_l7_dp0
				attn_tp2_l7_dp0 -> allreduce_l7_dp0
				attn_tp3_l7_dp0 -> allreduce_l7_dp0
				moe_input_l7_dp0 [label="MoE Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l7_dp0 [label="Router L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l7_dp0 -> moe_input_l7_dp0
				moe_input_l7_dp0 -> router_l7_dp0
				expert0_l7_dp0 [label="Expert 0 L7\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert0_l7_dp0 [label=select style=dashed]
				expert1_l7_dp0 [label="Expert 1 L7\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert1_l7_dp0 [label=select style=dashed]
				expert2_l7_dp0 [label="Expert 2 L7\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert2_l7_dp0 [label=select style=dashed]
				expert3_l7_dp0 [label="Expert 3 L7\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert3_l7_dp0 [label=select style=dashed]
				expert4_l7_dp0 [label="Expert 4 L7\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert4_l7_dp0 [label=select style=dashed]
				expert5_l7_dp0 [label="Expert 5 L7\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert5_l7_dp0 [label=select style=dashed]
				expert6_l7_dp0 [label="Expert 6 L7\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert6_l7_dp0 [label=select style=dashed]
				expert7_l7_dp0 [label="Expert 7 L7\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert7_l7_dp0 [label=select style=dashed]
				expert8_l7_dp0 [label="Expert 8 L7\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert8_l7_dp0 [label=select style=dashed]
				expert9_l7_dp0 [label="Expert 9 L7\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert9_l7_dp0 [label=select style=dashed]
				expert10_l7_dp0 [label="Expert 10 L7\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert10_l7_dp0 [label=select style=dashed]
				expert11_l7_dp0 [label="Expert 11 L7\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert11_l7_dp0 [label=select style=dashed]
				expert12_l7_dp0 [label="Expert 12 L7\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert12_l7_dp0 [label=select style=dashed]
				expert13_l7_dp0 [label="Expert 13 L7\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert13_l7_dp0 [label=select style=dashed]
				expert14_l7_dp0 [label="Expert 14 L7\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert14_l7_dp0 [label=select style=dashed]
				expert15_l7_dp0 [label="Expert 15 L7\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp0 -> expert15_l7_dp0 [label=select style=dashed]
				expert_agg_l7_dp0 [label="Expert Aggregation L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l7_dp0 -> expert_agg_l7_dp0
				expert1_l7_dp0 -> expert_agg_l7_dp0
				expert2_l7_dp0 -> expert_agg_l7_dp0
				expert3_l7_dp0 -> expert_agg_l7_dp0
				expert4_l7_dp0 -> expert_agg_l7_dp0
				expert5_l7_dp0 -> expert_agg_l7_dp0
				expert6_l7_dp0 -> expert_agg_l7_dp0
				expert7_l7_dp0 -> expert_agg_l7_dp0
				expert8_l7_dp0 -> expert_agg_l7_dp0
				expert9_l7_dp0 -> expert_agg_l7_dp0
				expert10_l7_dp0 -> expert_agg_l7_dp0
				expert11_l7_dp0 -> expert_agg_l7_dp0
				expert12_l7_dp0 -> expert_agg_l7_dp0
				expert13_l7_dp0 -> expert_agg_l7_dp0
				expert14_l7_dp0 -> expert_agg_l7_dp0
				expert15_l7_dp0 -> expert_agg_l7_dp0
				layer7_output_dp0 [label="Layer 7 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l7_dp0 -> layer7_output_dp0
			}
			layer7_output_dp0 -> attn_input_l8_dp0
			subgraph layer8_dp0_stage1 {
				label="Layer 8" style=rounded
				attn_input_l8_dp0 [label="Attention Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp0 [label="Attention TP0 L8\nGPU 0\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp0 -> attn_tp0_l8_dp0
				attn_tp1_l8_dp0 [label="Attention TP1 L8\nGPU 1\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp0 -> attn_tp1_l8_dp0
				attn_tp2_l8_dp0 [label="Attention TP2 L8\nGPU 2\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp0 -> attn_tp2_l8_dp0
				attn_tp3_l8_dp0 [label="Attention TP3 L8\nGPU 3\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp0 -> attn_tp3_l8_dp0
				allreduce_l8_dp0 [label="AllReduce L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp0 -> allreduce_l8_dp0
				attn_tp1_l8_dp0 -> allreduce_l8_dp0
				attn_tp2_l8_dp0 -> allreduce_l8_dp0
				attn_tp3_l8_dp0 -> allreduce_l8_dp0
				moe_input_l8_dp0 [label="MoE Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l8_dp0 [label="Router L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l8_dp0 -> moe_input_l8_dp0
				moe_input_l8_dp0 -> router_l8_dp0
				expert0_l8_dp0 [label="Expert 0 L8\nGPU 0\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert0_l8_dp0 [label=select style=dashed]
				expert1_l8_dp0 [label="Expert 1 L8\nGPU 1\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert1_l8_dp0 [label=select style=dashed]
				expert2_l8_dp0 [label="Expert 2 L8\nGPU 2\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert2_l8_dp0 [label=select style=dashed]
				expert3_l8_dp0 [label="Expert 3 L8\nGPU 3\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert3_l8_dp0 [label=select style=dashed]
				expert4_l8_dp0 [label="Expert 4 L8\nGPU 4\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert4_l8_dp0 [label=select style=dashed]
				expert5_l8_dp0 [label="Expert 5 L8\nGPU 5\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert5_l8_dp0 [label=select style=dashed]
				expert6_l8_dp0 [label="Expert 6 L8\nGPU 6\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert6_l8_dp0 [label=select style=dashed]
				expert7_l8_dp0 [label="Expert 7 L8\nGPU 7\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert7_l8_dp0 [label=select style=dashed]
				expert8_l8_dp0 [label="Expert 8 L8\nGPU 8\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert8_l8_dp0 [label=select style=dashed]
				expert9_l8_dp0 [label="Expert 9 L8\nGPU 9\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert9_l8_dp0 [label=select style=dashed]
				expert10_l8_dp0 [label="Expert 10 L8\nGPU 10\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert10_l8_dp0 [label=select style=dashed]
				expert11_l8_dp0 [label="Expert 11 L8\nGPU 11\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert11_l8_dp0 [label=select style=dashed]
				expert12_l8_dp0 [label="Expert 12 L8\nGPU 12\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert12_l8_dp0 [label=select style=dashed]
				expert13_l8_dp0 [label="Expert 13 L8\nGPU 13\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert13_l8_dp0 [label=select style=dashed]
				expert14_l8_dp0 [label="Expert 14 L8\nGPU 14\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert14_l8_dp0 [label=select style=dashed]
				expert15_l8_dp0 [label="Expert 15 L8\nGPU 15\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp0 -> expert15_l8_dp0 [label=select style=dashed]
				expert_agg_l8_dp0 [label="Expert Aggregation L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l8_dp0 -> expert_agg_l8_dp0
				expert1_l8_dp0 -> expert_agg_l8_dp0
				expert2_l8_dp0 -> expert_agg_l8_dp0
				expert3_l8_dp0 -> expert_agg_l8_dp0
				expert4_l8_dp0 -> expert_agg_l8_dp0
				expert5_l8_dp0 -> expert_agg_l8_dp0
				expert6_l8_dp0 -> expert_agg_l8_dp0
				expert7_l8_dp0 -> expert_agg_l8_dp0
				expert8_l8_dp0 -> expert_agg_l8_dp0
				expert9_l8_dp0 -> expert_agg_l8_dp0
				expert10_l8_dp0 -> expert_agg_l8_dp0
				expert11_l8_dp0 -> expert_agg_l8_dp0
				expert12_l8_dp0 -> expert_agg_l8_dp0
				expert13_l8_dp0 -> expert_agg_l8_dp0
				expert14_l8_dp0 -> expert_agg_l8_dp0
				expert15_l8_dp0 -> expert_agg_l8_dp0
				layer8_output_dp0 [label="Layer 8 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l8_dp0 -> layer8_output_dp0
			}
			stage1_output_dp0 [label="Stage 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer8_output_dp0 -> stage1_output_dp0
		}
		stage1_output_dp0 -> stage2_input_dp0 [lhead=stage2_dp0]
		subgraph stage2_dp0 {
			fillcolor=lightcyan label="PP Stage 2 (Layers 9-16)" style="rounded,filled"
			stage2_input_dp0 [label="Stage 2 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage2_input_dp0 -> attn_input_l9_dp0
			subgraph layer9_dp0_stage2 {
				label="Layer 9" style=rounded
				attn_input_l9_dp0 [label="Attention Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp0 [label="Attention TP0 L9\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp0 -> attn_tp0_l9_dp0
				attn_tp1_l9_dp0 [label="Attention TP1 L9\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp0 -> attn_tp1_l9_dp0
				attn_tp2_l9_dp0 [label="Attention TP2 L9\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp0 -> attn_tp2_l9_dp0
				attn_tp3_l9_dp0 [label="Attention TP3 L9\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp0 -> attn_tp3_l9_dp0
				allreduce_l9_dp0 [label="AllReduce L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp0 -> allreduce_l9_dp0
				attn_tp1_l9_dp0 -> allreduce_l9_dp0
				attn_tp2_l9_dp0 -> allreduce_l9_dp0
				attn_tp3_l9_dp0 -> allreduce_l9_dp0
				moe_input_l9_dp0 [label="MoE Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l9_dp0 [label="Router L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l9_dp0 -> moe_input_l9_dp0
				moe_input_l9_dp0 -> router_l9_dp0
				expert0_l9_dp0 [label="Expert 0 L9\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert0_l9_dp0 [label=select style=dashed]
				expert1_l9_dp0 [label="Expert 1 L9\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert1_l9_dp0 [label=select style=dashed]
				expert2_l9_dp0 [label="Expert 2 L9\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert2_l9_dp0 [label=select style=dashed]
				expert3_l9_dp0 [label="Expert 3 L9\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert3_l9_dp0 [label=select style=dashed]
				expert4_l9_dp0 [label="Expert 4 L9\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert4_l9_dp0 [label=select style=dashed]
				expert5_l9_dp0 [label="Expert 5 L9\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert5_l9_dp0 [label=select style=dashed]
				expert6_l9_dp0 [label="Expert 6 L9\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert6_l9_dp0 [label=select style=dashed]
				expert7_l9_dp0 [label="Expert 7 L9\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert7_l9_dp0 [label=select style=dashed]
				expert8_l9_dp0 [label="Expert 8 L9\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert8_l9_dp0 [label=select style=dashed]
				expert9_l9_dp0 [label="Expert 9 L9\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert9_l9_dp0 [label=select style=dashed]
				expert10_l9_dp0 [label="Expert 10 L9\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert10_l9_dp0 [label=select style=dashed]
				expert11_l9_dp0 [label="Expert 11 L9\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert11_l9_dp0 [label=select style=dashed]
				expert12_l9_dp0 [label="Expert 12 L9\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert12_l9_dp0 [label=select style=dashed]
				expert13_l9_dp0 [label="Expert 13 L9\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert13_l9_dp0 [label=select style=dashed]
				expert14_l9_dp0 [label="Expert 14 L9\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert14_l9_dp0 [label=select style=dashed]
				expert15_l9_dp0 [label="Expert 15 L9\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp0 -> expert15_l9_dp0 [label=select style=dashed]
				expert_agg_l9_dp0 [label="Expert Aggregation L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l9_dp0 -> expert_agg_l9_dp0
				expert1_l9_dp0 -> expert_agg_l9_dp0
				expert2_l9_dp0 -> expert_agg_l9_dp0
				expert3_l9_dp0 -> expert_agg_l9_dp0
				expert4_l9_dp0 -> expert_agg_l9_dp0
				expert5_l9_dp0 -> expert_agg_l9_dp0
				expert6_l9_dp0 -> expert_agg_l9_dp0
				expert7_l9_dp0 -> expert_agg_l9_dp0
				expert8_l9_dp0 -> expert_agg_l9_dp0
				expert9_l9_dp0 -> expert_agg_l9_dp0
				expert10_l9_dp0 -> expert_agg_l9_dp0
				expert11_l9_dp0 -> expert_agg_l9_dp0
				expert12_l9_dp0 -> expert_agg_l9_dp0
				expert13_l9_dp0 -> expert_agg_l9_dp0
				expert14_l9_dp0 -> expert_agg_l9_dp0
				expert15_l9_dp0 -> expert_agg_l9_dp0
				layer9_output_dp0 [label="Layer 9 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l9_dp0 -> layer9_output_dp0
			}
			layer9_output_dp0 -> attn_input_l10_dp0
			subgraph layer10_dp0_stage2 {
				label="Layer 10" style=rounded
				attn_input_l10_dp0 [label="Attention Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp0 [label="Attention TP0 L10\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp0 -> attn_tp0_l10_dp0
				attn_tp1_l10_dp0 [label="Attention TP1 L10\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp0 -> attn_tp1_l10_dp0
				attn_tp2_l10_dp0 [label="Attention TP2 L10\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp0 -> attn_tp2_l10_dp0
				attn_tp3_l10_dp0 [label="Attention TP3 L10\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp0 -> attn_tp3_l10_dp0
				allreduce_l10_dp0 [label="AllReduce L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp0 -> allreduce_l10_dp0
				attn_tp1_l10_dp0 -> allreduce_l10_dp0
				attn_tp2_l10_dp0 -> allreduce_l10_dp0
				attn_tp3_l10_dp0 -> allreduce_l10_dp0
				moe_input_l10_dp0 [label="MoE Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l10_dp0 [label="Router L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l10_dp0 -> moe_input_l10_dp0
				moe_input_l10_dp0 -> router_l10_dp0
				expert0_l10_dp0 [label="Expert 0 L10\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert0_l10_dp0 [label=select style=dashed]
				expert1_l10_dp0 [label="Expert 1 L10\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert1_l10_dp0 [label=select style=dashed]
				expert2_l10_dp0 [label="Expert 2 L10\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert2_l10_dp0 [label=select style=dashed]
				expert3_l10_dp0 [label="Expert 3 L10\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert3_l10_dp0 [label=select style=dashed]
				expert4_l10_dp0 [label="Expert 4 L10\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert4_l10_dp0 [label=select style=dashed]
				expert5_l10_dp0 [label="Expert 5 L10\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert5_l10_dp0 [label=select style=dashed]
				expert6_l10_dp0 [label="Expert 6 L10\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert6_l10_dp0 [label=select style=dashed]
				expert7_l10_dp0 [label="Expert 7 L10\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert7_l10_dp0 [label=select style=dashed]
				expert8_l10_dp0 [label="Expert 8 L10\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert8_l10_dp0 [label=select style=dashed]
				expert9_l10_dp0 [label="Expert 9 L10\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert9_l10_dp0 [label=select style=dashed]
				expert10_l10_dp0 [label="Expert 10 L10\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert10_l10_dp0 [label=select style=dashed]
				expert11_l10_dp0 [label="Expert 11 L10\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert11_l10_dp0 [label=select style=dashed]
				expert12_l10_dp0 [label="Expert 12 L10\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert12_l10_dp0 [label=select style=dashed]
				expert13_l10_dp0 [label="Expert 13 L10\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert13_l10_dp0 [label=select style=dashed]
				expert14_l10_dp0 [label="Expert 14 L10\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert14_l10_dp0 [label=select style=dashed]
				expert15_l10_dp0 [label="Expert 15 L10\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp0 -> expert15_l10_dp0 [label=select style=dashed]
				expert_agg_l10_dp0 [label="Expert Aggregation L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l10_dp0 -> expert_agg_l10_dp0
				expert1_l10_dp0 -> expert_agg_l10_dp0
				expert2_l10_dp0 -> expert_agg_l10_dp0
				expert3_l10_dp0 -> expert_agg_l10_dp0
				expert4_l10_dp0 -> expert_agg_l10_dp0
				expert5_l10_dp0 -> expert_agg_l10_dp0
				expert6_l10_dp0 -> expert_agg_l10_dp0
				expert7_l10_dp0 -> expert_agg_l10_dp0
				expert8_l10_dp0 -> expert_agg_l10_dp0
				expert9_l10_dp0 -> expert_agg_l10_dp0
				expert10_l10_dp0 -> expert_agg_l10_dp0
				expert11_l10_dp0 -> expert_agg_l10_dp0
				expert12_l10_dp0 -> expert_agg_l10_dp0
				expert13_l10_dp0 -> expert_agg_l10_dp0
				expert14_l10_dp0 -> expert_agg_l10_dp0
				expert15_l10_dp0 -> expert_agg_l10_dp0
				layer10_output_dp0 [label="Layer 10 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l10_dp0 -> layer10_output_dp0
			}
			layer10_output_dp0 -> attn_input_l11_dp0
			subgraph layer11_dp0_stage2 {
				label="Layer 11" style=rounded
				attn_input_l11_dp0 [label="Attention Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp0 [label="Attention TP0 L11\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp0 -> attn_tp0_l11_dp0
				attn_tp1_l11_dp0 [label="Attention TP1 L11\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp0 -> attn_tp1_l11_dp0
				attn_tp2_l11_dp0 [label="Attention TP2 L11\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp0 -> attn_tp2_l11_dp0
				attn_tp3_l11_dp0 [label="Attention TP3 L11\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp0 -> attn_tp3_l11_dp0
				allreduce_l11_dp0 [label="AllReduce L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp0 -> allreduce_l11_dp0
				attn_tp1_l11_dp0 -> allreduce_l11_dp0
				attn_tp2_l11_dp0 -> allreduce_l11_dp0
				attn_tp3_l11_dp0 -> allreduce_l11_dp0
				moe_input_l11_dp0 [label="MoE Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l11_dp0 [label="Router L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l11_dp0 -> moe_input_l11_dp0
				moe_input_l11_dp0 -> router_l11_dp0
				expert0_l11_dp0 [label="Expert 0 L11\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert0_l11_dp0 [label=select style=dashed]
				expert1_l11_dp0 [label="Expert 1 L11\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert1_l11_dp0 [label=select style=dashed]
				expert2_l11_dp0 [label="Expert 2 L11\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert2_l11_dp0 [label=select style=dashed]
				expert3_l11_dp0 [label="Expert 3 L11\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert3_l11_dp0 [label=select style=dashed]
				expert4_l11_dp0 [label="Expert 4 L11\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert4_l11_dp0 [label=select style=dashed]
				expert5_l11_dp0 [label="Expert 5 L11\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert5_l11_dp0 [label=select style=dashed]
				expert6_l11_dp0 [label="Expert 6 L11\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert6_l11_dp0 [label=select style=dashed]
				expert7_l11_dp0 [label="Expert 7 L11\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert7_l11_dp0 [label=select style=dashed]
				expert8_l11_dp0 [label="Expert 8 L11\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert8_l11_dp0 [label=select style=dashed]
				expert9_l11_dp0 [label="Expert 9 L11\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert9_l11_dp0 [label=select style=dashed]
				expert10_l11_dp0 [label="Expert 10 L11\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert10_l11_dp0 [label=select style=dashed]
				expert11_l11_dp0 [label="Expert 11 L11\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert11_l11_dp0 [label=select style=dashed]
				expert12_l11_dp0 [label="Expert 12 L11\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert12_l11_dp0 [label=select style=dashed]
				expert13_l11_dp0 [label="Expert 13 L11\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert13_l11_dp0 [label=select style=dashed]
				expert14_l11_dp0 [label="Expert 14 L11\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert14_l11_dp0 [label=select style=dashed]
				expert15_l11_dp0 [label="Expert 15 L11\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp0 -> expert15_l11_dp0 [label=select style=dashed]
				expert_agg_l11_dp0 [label="Expert Aggregation L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l11_dp0 -> expert_agg_l11_dp0
				expert1_l11_dp0 -> expert_agg_l11_dp0
				expert2_l11_dp0 -> expert_agg_l11_dp0
				expert3_l11_dp0 -> expert_agg_l11_dp0
				expert4_l11_dp0 -> expert_agg_l11_dp0
				expert5_l11_dp0 -> expert_agg_l11_dp0
				expert6_l11_dp0 -> expert_agg_l11_dp0
				expert7_l11_dp0 -> expert_agg_l11_dp0
				expert8_l11_dp0 -> expert_agg_l11_dp0
				expert9_l11_dp0 -> expert_agg_l11_dp0
				expert10_l11_dp0 -> expert_agg_l11_dp0
				expert11_l11_dp0 -> expert_agg_l11_dp0
				expert12_l11_dp0 -> expert_agg_l11_dp0
				expert13_l11_dp0 -> expert_agg_l11_dp0
				expert14_l11_dp0 -> expert_agg_l11_dp0
				expert15_l11_dp0 -> expert_agg_l11_dp0
				layer11_output_dp0 [label="Layer 11 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l11_dp0 -> layer11_output_dp0
			}
			layer11_output_dp0 -> attn_input_l12_dp0
			subgraph layer12_dp0_stage2 {
				label="Layer 12" style=rounded
				attn_input_l12_dp0 [label="Attention Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp0 [label="Attention TP0 L12\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp0 -> attn_tp0_l12_dp0
				attn_tp1_l12_dp0 [label="Attention TP1 L12\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp0 -> attn_tp1_l12_dp0
				attn_tp2_l12_dp0 [label="Attention TP2 L12\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp0 -> attn_tp2_l12_dp0
				attn_tp3_l12_dp0 [label="Attention TP3 L12\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp0 -> attn_tp3_l12_dp0
				allreduce_l12_dp0 [label="AllReduce L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp0 -> allreduce_l12_dp0
				attn_tp1_l12_dp0 -> allreduce_l12_dp0
				attn_tp2_l12_dp0 -> allreduce_l12_dp0
				attn_tp3_l12_dp0 -> allreduce_l12_dp0
				moe_input_l12_dp0 [label="MoE Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l12_dp0 [label="Router L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l12_dp0 -> moe_input_l12_dp0
				moe_input_l12_dp0 -> router_l12_dp0
				expert0_l12_dp0 [label="Expert 0 L12\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert0_l12_dp0 [label=select style=dashed]
				expert1_l12_dp0 [label="Expert 1 L12\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert1_l12_dp0 [label=select style=dashed]
				expert2_l12_dp0 [label="Expert 2 L12\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert2_l12_dp0 [label=select style=dashed]
				expert3_l12_dp0 [label="Expert 3 L12\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert3_l12_dp0 [label=select style=dashed]
				expert4_l12_dp0 [label="Expert 4 L12\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert4_l12_dp0 [label=select style=dashed]
				expert5_l12_dp0 [label="Expert 5 L12\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert5_l12_dp0 [label=select style=dashed]
				expert6_l12_dp0 [label="Expert 6 L12\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert6_l12_dp0 [label=select style=dashed]
				expert7_l12_dp0 [label="Expert 7 L12\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert7_l12_dp0 [label=select style=dashed]
				expert8_l12_dp0 [label="Expert 8 L12\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert8_l12_dp0 [label=select style=dashed]
				expert9_l12_dp0 [label="Expert 9 L12\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert9_l12_dp0 [label=select style=dashed]
				expert10_l12_dp0 [label="Expert 10 L12\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert10_l12_dp0 [label=select style=dashed]
				expert11_l12_dp0 [label="Expert 11 L12\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert11_l12_dp0 [label=select style=dashed]
				expert12_l12_dp0 [label="Expert 12 L12\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert12_l12_dp0 [label=select style=dashed]
				expert13_l12_dp0 [label="Expert 13 L12\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert13_l12_dp0 [label=select style=dashed]
				expert14_l12_dp0 [label="Expert 14 L12\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert14_l12_dp0 [label=select style=dashed]
				expert15_l12_dp0 [label="Expert 15 L12\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp0 -> expert15_l12_dp0 [label=select style=dashed]
				expert_agg_l12_dp0 [label="Expert Aggregation L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l12_dp0 -> expert_agg_l12_dp0
				expert1_l12_dp0 -> expert_agg_l12_dp0
				expert2_l12_dp0 -> expert_agg_l12_dp0
				expert3_l12_dp0 -> expert_agg_l12_dp0
				expert4_l12_dp0 -> expert_agg_l12_dp0
				expert5_l12_dp0 -> expert_agg_l12_dp0
				expert6_l12_dp0 -> expert_agg_l12_dp0
				expert7_l12_dp0 -> expert_agg_l12_dp0
				expert8_l12_dp0 -> expert_agg_l12_dp0
				expert9_l12_dp0 -> expert_agg_l12_dp0
				expert10_l12_dp0 -> expert_agg_l12_dp0
				expert11_l12_dp0 -> expert_agg_l12_dp0
				expert12_l12_dp0 -> expert_agg_l12_dp0
				expert13_l12_dp0 -> expert_agg_l12_dp0
				expert14_l12_dp0 -> expert_agg_l12_dp0
				expert15_l12_dp0 -> expert_agg_l12_dp0
				layer12_output_dp0 [label="Layer 12 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l12_dp0 -> layer12_output_dp0
			}
			layer12_output_dp0 -> attn_input_l13_dp0
			subgraph layer13_dp0_stage2 {
				label="Layer 13" style=rounded
				attn_input_l13_dp0 [label="Attention Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp0 [label="Attention TP0 L13\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp0 -> attn_tp0_l13_dp0
				attn_tp1_l13_dp0 [label="Attention TP1 L13\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp0 -> attn_tp1_l13_dp0
				attn_tp2_l13_dp0 [label="Attention TP2 L13\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp0 -> attn_tp2_l13_dp0
				attn_tp3_l13_dp0 [label="Attention TP3 L13\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp0 -> attn_tp3_l13_dp0
				allreduce_l13_dp0 [label="AllReduce L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp0 -> allreduce_l13_dp0
				attn_tp1_l13_dp0 -> allreduce_l13_dp0
				attn_tp2_l13_dp0 -> allreduce_l13_dp0
				attn_tp3_l13_dp0 -> allreduce_l13_dp0
				moe_input_l13_dp0 [label="MoE Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l13_dp0 [label="Router L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l13_dp0 -> moe_input_l13_dp0
				moe_input_l13_dp0 -> router_l13_dp0
				expert0_l13_dp0 [label="Expert 0 L13\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert0_l13_dp0 [label=select style=dashed]
				expert1_l13_dp0 [label="Expert 1 L13\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert1_l13_dp0 [label=select style=dashed]
				expert2_l13_dp0 [label="Expert 2 L13\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert2_l13_dp0 [label=select style=dashed]
				expert3_l13_dp0 [label="Expert 3 L13\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert3_l13_dp0 [label=select style=dashed]
				expert4_l13_dp0 [label="Expert 4 L13\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert4_l13_dp0 [label=select style=dashed]
				expert5_l13_dp0 [label="Expert 5 L13\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert5_l13_dp0 [label=select style=dashed]
				expert6_l13_dp0 [label="Expert 6 L13\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert6_l13_dp0 [label=select style=dashed]
				expert7_l13_dp0 [label="Expert 7 L13\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert7_l13_dp0 [label=select style=dashed]
				expert8_l13_dp0 [label="Expert 8 L13\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert8_l13_dp0 [label=select style=dashed]
				expert9_l13_dp0 [label="Expert 9 L13\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert9_l13_dp0 [label=select style=dashed]
				expert10_l13_dp0 [label="Expert 10 L13\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert10_l13_dp0 [label=select style=dashed]
				expert11_l13_dp0 [label="Expert 11 L13\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert11_l13_dp0 [label=select style=dashed]
				expert12_l13_dp0 [label="Expert 12 L13\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert12_l13_dp0 [label=select style=dashed]
				expert13_l13_dp0 [label="Expert 13 L13\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert13_l13_dp0 [label=select style=dashed]
				expert14_l13_dp0 [label="Expert 14 L13\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert14_l13_dp0 [label=select style=dashed]
				expert15_l13_dp0 [label="Expert 15 L13\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp0 -> expert15_l13_dp0 [label=select style=dashed]
				expert_agg_l13_dp0 [label="Expert Aggregation L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l13_dp0 -> expert_agg_l13_dp0
				expert1_l13_dp0 -> expert_agg_l13_dp0
				expert2_l13_dp0 -> expert_agg_l13_dp0
				expert3_l13_dp0 -> expert_agg_l13_dp0
				expert4_l13_dp0 -> expert_agg_l13_dp0
				expert5_l13_dp0 -> expert_agg_l13_dp0
				expert6_l13_dp0 -> expert_agg_l13_dp0
				expert7_l13_dp0 -> expert_agg_l13_dp0
				expert8_l13_dp0 -> expert_agg_l13_dp0
				expert9_l13_dp0 -> expert_agg_l13_dp0
				expert10_l13_dp0 -> expert_agg_l13_dp0
				expert11_l13_dp0 -> expert_agg_l13_dp0
				expert12_l13_dp0 -> expert_agg_l13_dp0
				expert13_l13_dp0 -> expert_agg_l13_dp0
				expert14_l13_dp0 -> expert_agg_l13_dp0
				expert15_l13_dp0 -> expert_agg_l13_dp0
				layer13_output_dp0 [label="Layer 13 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l13_dp0 -> layer13_output_dp0
			}
			layer13_output_dp0 -> attn_input_l14_dp0
			subgraph layer14_dp0_stage2 {
				label="Layer 14" style=rounded
				attn_input_l14_dp0 [label="Attention Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp0 [label="Attention TP0 L14\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp0 -> attn_tp0_l14_dp0
				attn_tp1_l14_dp0 [label="Attention TP1 L14\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp0 -> attn_tp1_l14_dp0
				attn_tp2_l14_dp0 [label="Attention TP2 L14\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp0 -> attn_tp2_l14_dp0
				attn_tp3_l14_dp0 [label="Attention TP3 L14\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp0 -> attn_tp3_l14_dp0
				allreduce_l14_dp0 [label="AllReduce L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp0 -> allreduce_l14_dp0
				attn_tp1_l14_dp0 -> allreduce_l14_dp0
				attn_tp2_l14_dp0 -> allreduce_l14_dp0
				attn_tp3_l14_dp0 -> allreduce_l14_dp0
				moe_input_l14_dp0 [label="MoE Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l14_dp0 [label="Router L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l14_dp0 -> moe_input_l14_dp0
				moe_input_l14_dp0 -> router_l14_dp0
				expert0_l14_dp0 [label="Expert 0 L14\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert0_l14_dp0 [label=select style=dashed]
				expert1_l14_dp0 [label="Expert 1 L14\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert1_l14_dp0 [label=select style=dashed]
				expert2_l14_dp0 [label="Expert 2 L14\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert2_l14_dp0 [label=select style=dashed]
				expert3_l14_dp0 [label="Expert 3 L14\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert3_l14_dp0 [label=select style=dashed]
				expert4_l14_dp0 [label="Expert 4 L14\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert4_l14_dp0 [label=select style=dashed]
				expert5_l14_dp0 [label="Expert 5 L14\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert5_l14_dp0 [label=select style=dashed]
				expert6_l14_dp0 [label="Expert 6 L14\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert6_l14_dp0 [label=select style=dashed]
				expert7_l14_dp0 [label="Expert 7 L14\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert7_l14_dp0 [label=select style=dashed]
				expert8_l14_dp0 [label="Expert 8 L14\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert8_l14_dp0 [label=select style=dashed]
				expert9_l14_dp0 [label="Expert 9 L14\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert9_l14_dp0 [label=select style=dashed]
				expert10_l14_dp0 [label="Expert 10 L14\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert10_l14_dp0 [label=select style=dashed]
				expert11_l14_dp0 [label="Expert 11 L14\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert11_l14_dp0 [label=select style=dashed]
				expert12_l14_dp0 [label="Expert 12 L14\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert12_l14_dp0 [label=select style=dashed]
				expert13_l14_dp0 [label="Expert 13 L14\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert13_l14_dp0 [label=select style=dashed]
				expert14_l14_dp0 [label="Expert 14 L14\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert14_l14_dp0 [label=select style=dashed]
				expert15_l14_dp0 [label="Expert 15 L14\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp0 -> expert15_l14_dp0 [label=select style=dashed]
				expert_agg_l14_dp0 [label="Expert Aggregation L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l14_dp0 -> expert_agg_l14_dp0
				expert1_l14_dp0 -> expert_agg_l14_dp0
				expert2_l14_dp0 -> expert_agg_l14_dp0
				expert3_l14_dp0 -> expert_agg_l14_dp0
				expert4_l14_dp0 -> expert_agg_l14_dp0
				expert5_l14_dp0 -> expert_agg_l14_dp0
				expert6_l14_dp0 -> expert_agg_l14_dp0
				expert7_l14_dp0 -> expert_agg_l14_dp0
				expert8_l14_dp0 -> expert_agg_l14_dp0
				expert9_l14_dp0 -> expert_agg_l14_dp0
				expert10_l14_dp0 -> expert_agg_l14_dp0
				expert11_l14_dp0 -> expert_agg_l14_dp0
				expert12_l14_dp0 -> expert_agg_l14_dp0
				expert13_l14_dp0 -> expert_agg_l14_dp0
				expert14_l14_dp0 -> expert_agg_l14_dp0
				expert15_l14_dp0 -> expert_agg_l14_dp0
				layer14_output_dp0 [label="Layer 14 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l14_dp0 -> layer14_output_dp0
			}
			layer14_output_dp0 -> attn_input_l15_dp0
			subgraph layer15_dp0_stage2 {
				label="Layer 15" style=rounded
				attn_input_l15_dp0 [label="Attention Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp0 [label="Attention TP0 L15\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp0 -> attn_tp0_l15_dp0
				attn_tp1_l15_dp0 [label="Attention TP1 L15\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp0 -> attn_tp1_l15_dp0
				attn_tp2_l15_dp0 [label="Attention TP2 L15\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp0 -> attn_tp2_l15_dp0
				attn_tp3_l15_dp0 [label="Attention TP3 L15\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp0 -> attn_tp3_l15_dp0
				allreduce_l15_dp0 [label="AllReduce L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp0 -> allreduce_l15_dp0
				attn_tp1_l15_dp0 -> allreduce_l15_dp0
				attn_tp2_l15_dp0 -> allreduce_l15_dp0
				attn_tp3_l15_dp0 -> allreduce_l15_dp0
				moe_input_l15_dp0 [label="MoE Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l15_dp0 [label="Router L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l15_dp0 -> moe_input_l15_dp0
				moe_input_l15_dp0 -> router_l15_dp0
				expert0_l15_dp0 [label="Expert 0 L15\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert0_l15_dp0 [label=select style=dashed]
				expert1_l15_dp0 [label="Expert 1 L15\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert1_l15_dp0 [label=select style=dashed]
				expert2_l15_dp0 [label="Expert 2 L15\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert2_l15_dp0 [label=select style=dashed]
				expert3_l15_dp0 [label="Expert 3 L15\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert3_l15_dp0 [label=select style=dashed]
				expert4_l15_dp0 [label="Expert 4 L15\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert4_l15_dp0 [label=select style=dashed]
				expert5_l15_dp0 [label="Expert 5 L15\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert5_l15_dp0 [label=select style=dashed]
				expert6_l15_dp0 [label="Expert 6 L15\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert6_l15_dp0 [label=select style=dashed]
				expert7_l15_dp0 [label="Expert 7 L15\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert7_l15_dp0 [label=select style=dashed]
				expert8_l15_dp0 [label="Expert 8 L15\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert8_l15_dp0 [label=select style=dashed]
				expert9_l15_dp0 [label="Expert 9 L15\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert9_l15_dp0 [label=select style=dashed]
				expert10_l15_dp0 [label="Expert 10 L15\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert10_l15_dp0 [label=select style=dashed]
				expert11_l15_dp0 [label="Expert 11 L15\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert11_l15_dp0 [label=select style=dashed]
				expert12_l15_dp0 [label="Expert 12 L15\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert12_l15_dp0 [label=select style=dashed]
				expert13_l15_dp0 [label="Expert 13 L15\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert13_l15_dp0 [label=select style=dashed]
				expert14_l15_dp0 [label="Expert 14 L15\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert14_l15_dp0 [label=select style=dashed]
				expert15_l15_dp0 [label="Expert 15 L15\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp0 -> expert15_l15_dp0 [label=select style=dashed]
				expert_agg_l15_dp0 [label="Expert Aggregation L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l15_dp0 -> expert_agg_l15_dp0
				expert1_l15_dp0 -> expert_agg_l15_dp0
				expert2_l15_dp0 -> expert_agg_l15_dp0
				expert3_l15_dp0 -> expert_agg_l15_dp0
				expert4_l15_dp0 -> expert_agg_l15_dp0
				expert5_l15_dp0 -> expert_agg_l15_dp0
				expert6_l15_dp0 -> expert_agg_l15_dp0
				expert7_l15_dp0 -> expert_agg_l15_dp0
				expert8_l15_dp0 -> expert_agg_l15_dp0
				expert9_l15_dp0 -> expert_agg_l15_dp0
				expert10_l15_dp0 -> expert_agg_l15_dp0
				expert11_l15_dp0 -> expert_agg_l15_dp0
				expert12_l15_dp0 -> expert_agg_l15_dp0
				expert13_l15_dp0 -> expert_agg_l15_dp0
				expert14_l15_dp0 -> expert_agg_l15_dp0
				expert15_l15_dp0 -> expert_agg_l15_dp0
				layer15_output_dp0 [label="Layer 15 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l15_dp0 -> layer15_output_dp0
			}
			layer15_output_dp0 -> attn_input_l16_dp0
			subgraph layer16_dp0_stage2 {
				label="Layer 16" style=rounded
				attn_input_l16_dp0 [label="Attention Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp0 [label="Attention TP0 L16\nGPU 16\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp0 -> attn_tp0_l16_dp0
				attn_tp1_l16_dp0 [label="Attention TP1 L16\nGPU 17\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp0 -> attn_tp1_l16_dp0
				attn_tp2_l16_dp0 [label="Attention TP2 L16\nGPU 18\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp0 -> attn_tp2_l16_dp0
				attn_tp3_l16_dp0 [label="Attention TP3 L16\nGPU 19\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp0 -> attn_tp3_l16_dp0
				allreduce_l16_dp0 [label="AllReduce L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp0 -> allreduce_l16_dp0
				attn_tp1_l16_dp0 -> allreduce_l16_dp0
				attn_tp2_l16_dp0 -> allreduce_l16_dp0
				attn_tp3_l16_dp0 -> allreduce_l16_dp0
				moe_input_l16_dp0 [label="MoE Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l16_dp0 [label="Router L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l16_dp0 -> moe_input_l16_dp0
				moe_input_l16_dp0 -> router_l16_dp0
				expert0_l16_dp0 [label="Expert 0 L16\nGPU 16\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert0_l16_dp0 [label=select style=dashed]
				expert1_l16_dp0 [label="Expert 1 L16\nGPU 17\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert1_l16_dp0 [label=select style=dashed]
				expert2_l16_dp0 [label="Expert 2 L16\nGPU 18\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert2_l16_dp0 [label=select style=dashed]
				expert3_l16_dp0 [label="Expert 3 L16\nGPU 19\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert3_l16_dp0 [label=select style=dashed]
				expert4_l16_dp0 [label="Expert 4 L16\nGPU 20\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert4_l16_dp0 [label=select style=dashed]
				expert5_l16_dp0 [label="Expert 5 L16\nGPU 21\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert5_l16_dp0 [label=select style=dashed]
				expert6_l16_dp0 [label="Expert 6 L16\nGPU 22\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert6_l16_dp0 [label=select style=dashed]
				expert7_l16_dp0 [label="Expert 7 L16\nGPU 23\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert7_l16_dp0 [label=select style=dashed]
				expert8_l16_dp0 [label="Expert 8 L16\nGPU 24\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert8_l16_dp0 [label=select style=dashed]
				expert9_l16_dp0 [label="Expert 9 L16\nGPU 25\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert9_l16_dp0 [label=select style=dashed]
				expert10_l16_dp0 [label="Expert 10 L16\nGPU 26\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert10_l16_dp0 [label=select style=dashed]
				expert11_l16_dp0 [label="Expert 11 L16\nGPU 27\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert11_l16_dp0 [label=select style=dashed]
				expert12_l16_dp0 [label="Expert 12 L16\nGPU 28\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert12_l16_dp0 [label=select style=dashed]
				expert13_l16_dp0 [label="Expert 13 L16\nGPU 29\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert13_l16_dp0 [label=select style=dashed]
				expert14_l16_dp0 [label="Expert 14 L16\nGPU 30\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert14_l16_dp0 [label=select style=dashed]
				expert15_l16_dp0 [label="Expert 15 L16\nGPU 31\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp0 -> expert15_l16_dp0 [label=select style=dashed]
				expert_agg_l16_dp0 [label="Expert Aggregation L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l16_dp0 -> expert_agg_l16_dp0
				expert1_l16_dp0 -> expert_agg_l16_dp0
				expert2_l16_dp0 -> expert_agg_l16_dp0
				expert3_l16_dp0 -> expert_agg_l16_dp0
				expert4_l16_dp0 -> expert_agg_l16_dp0
				expert5_l16_dp0 -> expert_agg_l16_dp0
				expert6_l16_dp0 -> expert_agg_l16_dp0
				expert7_l16_dp0 -> expert_agg_l16_dp0
				expert8_l16_dp0 -> expert_agg_l16_dp0
				expert9_l16_dp0 -> expert_agg_l16_dp0
				expert10_l16_dp0 -> expert_agg_l16_dp0
				expert11_l16_dp0 -> expert_agg_l16_dp0
				expert12_l16_dp0 -> expert_agg_l16_dp0
				expert13_l16_dp0 -> expert_agg_l16_dp0
				expert14_l16_dp0 -> expert_agg_l16_dp0
				expert15_l16_dp0 -> expert_agg_l16_dp0
				layer16_output_dp0 [label="Layer 16 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l16_dp0 -> layer16_output_dp0
			}
			stage2_output_dp0 [label="Stage 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer16_output_dp0 -> stage2_output_dp0
		}
	}
	subgraph dp_1 {
		fillcolor=lightgray label="DP Replica 1" rank=same style="rounded,filled"
		subgraph stage1_dp1 {
			fillcolor=lightcyan label="PP Stage 1 (Layers 1-8)" style="rounded,filled"
			stage1_input_dp1 [label="Stage1 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage1_input_dp1 -> attn_input_l1_dp1
			subgraph layer1_dp1_stage1 {
				label="Layer 1" style=rounded
				attn_input_l1_dp1 [label="Attention Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp1 [label="Attention TP0 L1\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp1 -> attn_tp0_l1_dp1
				attn_tp1_l1_dp1 [label="Attention TP1 L1\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp1 -> attn_tp1_l1_dp1
				attn_tp2_l1_dp1 [label="Attention TP2 L1\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp1 -> attn_tp2_l1_dp1
				attn_tp3_l1_dp1 [label="Attention TP3 L1\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp1 -> attn_tp3_l1_dp1
				allreduce_l1_dp1 [label="AllReduce L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp1 -> allreduce_l1_dp1
				attn_tp1_l1_dp1 -> allreduce_l1_dp1
				attn_tp2_l1_dp1 -> allreduce_l1_dp1
				attn_tp3_l1_dp1 -> allreduce_l1_dp1
				moe_input_l1_dp1 [label="MoE Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l1_dp1 [label="Router L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l1_dp1 -> moe_input_l1_dp1
				moe_input_l1_dp1 -> router_l1_dp1
				expert0_l1_dp1 [label="Expert 0 L1\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert0_l1_dp1 [label=select style=dashed]
				expert1_l1_dp1 [label="Expert 1 L1\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert1_l1_dp1 [label=select style=dashed]
				expert2_l1_dp1 [label="Expert 2 L1\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert2_l1_dp1 [label=select style=dashed]
				expert3_l1_dp1 [label="Expert 3 L1\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert3_l1_dp1 [label=select style=dashed]
				expert4_l1_dp1 [label="Expert 4 L1\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert4_l1_dp1 [label=select style=dashed]
				expert5_l1_dp1 [label="Expert 5 L1\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert5_l1_dp1 [label=select style=dashed]
				expert6_l1_dp1 [label="Expert 6 L1\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert6_l1_dp1 [label=select style=dashed]
				expert7_l1_dp1 [label="Expert 7 L1\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert7_l1_dp1 [label=select style=dashed]
				expert8_l1_dp1 [label="Expert 8 L1\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert8_l1_dp1 [label=select style=dashed]
				expert9_l1_dp1 [label="Expert 9 L1\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert9_l1_dp1 [label=select style=dashed]
				expert10_l1_dp1 [label="Expert 10 L1\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert10_l1_dp1 [label=select style=dashed]
				expert11_l1_dp1 [label="Expert 11 L1\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert11_l1_dp1 [label=select style=dashed]
				expert12_l1_dp1 [label="Expert 12 L1\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert12_l1_dp1 [label=select style=dashed]
				expert13_l1_dp1 [label="Expert 13 L1\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert13_l1_dp1 [label=select style=dashed]
				expert14_l1_dp1 [label="Expert 14 L1\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert14_l1_dp1 [label=select style=dashed]
				expert15_l1_dp1 [label="Expert 15 L1\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp1 -> expert15_l1_dp1 [label=select style=dashed]
				expert_agg_l1_dp1 [label="Expert Aggregation L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l1_dp1 -> expert_agg_l1_dp1
				expert1_l1_dp1 -> expert_agg_l1_dp1
				expert2_l1_dp1 -> expert_agg_l1_dp1
				expert3_l1_dp1 -> expert_agg_l1_dp1
				expert4_l1_dp1 -> expert_agg_l1_dp1
				expert5_l1_dp1 -> expert_agg_l1_dp1
				expert6_l1_dp1 -> expert_agg_l1_dp1
				expert7_l1_dp1 -> expert_agg_l1_dp1
				expert8_l1_dp1 -> expert_agg_l1_dp1
				expert9_l1_dp1 -> expert_agg_l1_dp1
				expert10_l1_dp1 -> expert_agg_l1_dp1
				expert11_l1_dp1 -> expert_agg_l1_dp1
				expert12_l1_dp1 -> expert_agg_l1_dp1
				expert13_l1_dp1 -> expert_agg_l1_dp1
				expert14_l1_dp1 -> expert_agg_l1_dp1
				expert15_l1_dp1 -> expert_agg_l1_dp1
				layer1_output_dp1 [label="Layer 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l1_dp1 -> layer1_output_dp1
			}
			layer1_output_dp1 -> attn_input_l2_dp1
			subgraph layer2_dp1_stage1 {
				label="Layer 2" style=rounded
				attn_input_l2_dp1 [label="Attention Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp1 [label="Attention TP0 L2\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp1 -> attn_tp0_l2_dp1
				attn_tp1_l2_dp1 [label="Attention TP1 L2\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp1 -> attn_tp1_l2_dp1
				attn_tp2_l2_dp1 [label="Attention TP2 L2\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp1 -> attn_tp2_l2_dp1
				attn_tp3_l2_dp1 [label="Attention TP3 L2\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp1 -> attn_tp3_l2_dp1
				allreduce_l2_dp1 [label="AllReduce L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp1 -> allreduce_l2_dp1
				attn_tp1_l2_dp1 -> allreduce_l2_dp1
				attn_tp2_l2_dp1 -> allreduce_l2_dp1
				attn_tp3_l2_dp1 -> allreduce_l2_dp1
				moe_input_l2_dp1 [label="MoE Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l2_dp1 [label="Router L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l2_dp1 -> moe_input_l2_dp1
				moe_input_l2_dp1 -> router_l2_dp1
				expert0_l2_dp1 [label="Expert 0 L2\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert0_l2_dp1 [label=select style=dashed]
				expert1_l2_dp1 [label="Expert 1 L2\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert1_l2_dp1 [label=select style=dashed]
				expert2_l2_dp1 [label="Expert 2 L2\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert2_l2_dp1 [label=select style=dashed]
				expert3_l2_dp1 [label="Expert 3 L2\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert3_l2_dp1 [label=select style=dashed]
				expert4_l2_dp1 [label="Expert 4 L2\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert4_l2_dp1 [label=select style=dashed]
				expert5_l2_dp1 [label="Expert 5 L2\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert5_l2_dp1 [label=select style=dashed]
				expert6_l2_dp1 [label="Expert 6 L2\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert6_l2_dp1 [label=select style=dashed]
				expert7_l2_dp1 [label="Expert 7 L2\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert7_l2_dp1 [label=select style=dashed]
				expert8_l2_dp1 [label="Expert 8 L2\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert8_l2_dp1 [label=select style=dashed]
				expert9_l2_dp1 [label="Expert 9 L2\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert9_l2_dp1 [label=select style=dashed]
				expert10_l2_dp1 [label="Expert 10 L2\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert10_l2_dp1 [label=select style=dashed]
				expert11_l2_dp1 [label="Expert 11 L2\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert11_l2_dp1 [label=select style=dashed]
				expert12_l2_dp1 [label="Expert 12 L2\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert12_l2_dp1 [label=select style=dashed]
				expert13_l2_dp1 [label="Expert 13 L2\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert13_l2_dp1 [label=select style=dashed]
				expert14_l2_dp1 [label="Expert 14 L2\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert14_l2_dp1 [label=select style=dashed]
				expert15_l2_dp1 [label="Expert 15 L2\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp1 -> expert15_l2_dp1 [label=select style=dashed]
				expert_agg_l2_dp1 [label="Expert Aggregation L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l2_dp1 -> expert_agg_l2_dp1
				expert1_l2_dp1 -> expert_agg_l2_dp1
				expert2_l2_dp1 -> expert_agg_l2_dp1
				expert3_l2_dp1 -> expert_agg_l2_dp1
				expert4_l2_dp1 -> expert_agg_l2_dp1
				expert5_l2_dp1 -> expert_agg_l2_dp1
				expert6_l2_dp1 -> expert_agg_l2_dp1
				expert7_l2_dp1 -> expert_agg_l2_dp1
				expert8_l2_dp1 -> expert_agg_l2_dp1
				expert9_l2_dp1 -> expert_agg_l2_dp1
				expert10_l2_dp1 -> expert_agg_l2_dp1
				expert11_l2_dp1 -> expert_agg_l2_dp1
				expert12_l2_dp1 -> expert_agg_l2_dp1
				expert13_l2_dp1 -> expert_agg_l2_dp1
				expert14_l2_dp1 -> expert_agg_l2_dp1
				expert15_l2_dp1 -> expert_agg_l2_dp1
				layer2_output_dp1 [label="Layer 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l2_dp1 -> layer2_output_dp1
			}
			layer2_output_dp1 -> attn_input_l3_dp1
			subgraph layer3_dp1_stage1 {
				label="Layer 3" style=rounded
				attn_input_l3_dp1 [label="Attention Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp1 [label="Attention TP0 L3\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp1 -> attn_tp0_l3_dp1
				attn_tp1_l3_dp1 [label="Attention TP1 L3\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp1 -> attn_tp1_l3_dp1
				attn_tp2_l3_dp1 [label="Attention TP2 L3\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp1 -> attn_tp2_l3_dp1
				attn_tp3_l3_dp1 [label="Attention TP3 L3\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp1 -> attn_tp3_l3_dp1
				allreduce_l3_dp1 [label="AllReduce L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp1 -> allreduce_l3_dp1
				attn_tp1_l3_dp1 -> allreduce_l3_dp1
				attn_tp2_l3_dp1 -> allreduce_l3_dp1
				attn_tp3_l3_dp1 -> allreduce_l3_dp1
				moe_input_l3_dp1 [label="MoE Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l3_dp1 [label="Router L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l3_dp1 -> moe_input_l3_dp1
				moe_input_l3_dp1 -> router_l3_dp1
				expert0_l3_dp1 [label="Expert 0 L3\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert0_l3_dp1 [label=select style=dashed]
				expert1_l3_dp1 [label="Expert 1 L3\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert1_l3_dp1 [label=select style=dashed]
				expert2_l3_dp1 [label="Expert 2 L3\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert2_l3_dp1 [label=select style=dashed]
				expert3_l3_dp1 [label="Expert 3 L3\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert3_l3_dp1 [label=select style=dashed]
				expert4_l3_dp1 [label="Expert 4 L3\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert4_l3_dp1 [label=select style=dashed]
				expert5_l3_dp1 [label="Expert 5 L3\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert5_l3_dp1 [label=select style=dashed]
				expert6_l3_dp1 [label="Expert 6 L3\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert6_l3_dp1 [label=select style=dashed]
				expert7_l3_dp1 [label="Expert 7 L3\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert7_l3_dp1 [label=select style=dashed]
				expert8_l3_dp1 [label="Expert 8 L3\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert8_l3_dp1 [label=select style=dashed]
				expert9_l3_dp1 [label="Expert 9 L3\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert9_l3_dp1 [label=select style=dashed]
				expert10_l3_dp1 [label="Expert 10 L3\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert10_l3_dp1 [label=select style=dashed]
				expert11_l3_dp1 [label="Expert 11 L3\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert11_l3_dp1 [label=select style=dashed]
				expert12_l3_dp1 [label="Expert 12 L3\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert12_l3_dp1 [label=select style=dashed]
				expert13_l3_dp1 [label="Expert 13 L3\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert13_l3_dp1 [label=select style=dashed]
				expert14_l3_dp1 [label="Expert 14 L3\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert14_l3_dp1 [label=select style=dashed]
				expert15_l3_dp1 [label="Expert 15 L3\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp1 -> expert15_l3_dp1 [label=select style=dashed]
				expert_agg_l3_dp1 [label="Expert Aggregation L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l3_dp1 -> expert_agg_l3_dp1
				expert1_l3_dp1 -> expert_agg_l3_dp1
				expert2_l3_dp1 -> expert_agg_l3_dp1
				expert3_l3_dp1 -> expert_agg_l3_dp1
				expert4_l3_dp1 -> expert_agg_l3_dp1
				expert5_l3_dp1 -> expert_agg_l3_dp1
				expert6_l3_dp1 -> expert_agg_l3_dp1
				expert7_l3_dp1 -> expert_agg_l3_dp1
				expert8_l3_dp1 -> expert_agg_l3_dp1
				expert9_l3_dp1 -> expert_agg_l3_dp1
				expert10_l3_dp1 -> expert_agg_l3_dp1
				expert11_l3_dp1 -> expert_agg_l3_dp1
				expert12_l3_dp1 -> expert_agg_l3_dp1
				expert13_l3_dp1 -> expert_agg_l3_dp1
				expert14_l3_dp1 -> expert_agg_l3_dp1
				expert15_l3_dp1 -> expert_agg_l3_dp1
				layer3_output_dp1 [label="Layer 3 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l3_dp1 -> layer3_output_dp1
			}
			layer3_output_dp1 -> attn_input_l4_dp1
			subgraph layer4_dp1_stage1 {
				label="Layer 4" style=rounded
				attn_input_l4_dp1 [label="Attention Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp1 [label="Attention TP0 L4\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp1 -> attn_tp0_l4_dp1
				attn_tp1_l4_dp1 [label="Attention TP1 L4\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp1 -> attn_tp1_l4_dp1
				attn_tp2_l4_dp1 [label="Attention TP2 L4\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp1 -> attn_tp2_l4_dp1
				attn_tp3_l4_dp1 [label="Attention TP3 L4\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp1 -> attn_tp3_l4_dp1
				allreduce_l4_dp1 [label="AllReduce L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp1 -> allreduce_l4_dp1
				attn_tp1_l4_dp1 -> allreduce_l4_dp1
				attn_tp2_l4_dp1 -> allreduce_l4_dp1
				attn_tp3_l4_dp1 -> allreduce_l4_dp1
				moe_input_l4_dp1 [label="MoE Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l4_dp1 [label="Router L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l4_dp1 -> moe_input_l4_dp1
				moe_input_l4_dp1 -> router_l4_dp1
				expert0_l4_dp1 [label="Expert 0 L4\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert0_l4_dp1 [label=select style=dashed]
				expert1_l4_dp1 [label="Expert 1 L4\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert1_l4_dp1 [label=select style=dashed]
				expert2_l4_dp1 [label="Expert 2 L4\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert2_l4_dp1 [label=select style=dashed]
				expert3_l4_dp1 [label="Expert 3 L4\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert3_l4_dp1 [label=select style=dashed]
				expert4_l4_dp1 [label="Expert 4 L4\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert4_l4_dp1 [label=select style=dashed]
				expert5_l4_dp1 [label="Expert 5 L4\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert5_l4_dp1 [label=select style=dashed]
				expert6_l4_dp1 [label="Expert 6 L4\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert6_l4_dp1 [label=select style=dashed]
				expert7_l4_dp1 [label="Expert 7 L4\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert7_l4_dp1 [label=select style=dashed]
				expert8_l4_dp1 [label="Expert 8 L4\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert8_l4_dp1 [label=select style=dashed]
				expert9_l4_dp1 [label="Expert 9 L4\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert9_l4_dp1 [label=select style=dashed]
				expert10_l4_dp1 [label="Expert 10 L4\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert10_l4_dp1 [label=select style=dashed]
				expert11_l4_dp1 [label="Expert 11 L4\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert11_l4_dp1 [label=select style=dashed]
				expert12_l4_dp1 [label="Expert 12 L4\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert12_l4_dp1 [label=select style=dashed]
				expert13_l4_dp1 [label="Expert 13 L4\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert13_l4_dp1 [label=select style=dashed]
				expert14_l4_dp1 [label="Expert 14 L4\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert14_l4_dp1 [label=select style=dashed]
				expert15_l4_dp1 [label="Expert 15 L4\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp1 -> expert15_l4_dp1 [label=select style=dashed]
				expert_agg_l4_dp1 [label="Expert Aggregation L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l4_dp1 -> expert_agg_l4_dp1
				expert1_l4_dp1 -> expert_agg_l4_dp1
				expert2_l4_dp1 -> expert_agg_l4_dp1
				expert3_l4_dp1 -> expert_agg_l4_dp1
				expert4_l4_dp1 -> expert_agg_l4_dp1
				expert5_l4_dp1 -> expert_agg_l4_dp1
				expert6_l4_dp1 -> expert_agg_l4_dp1
				expert7_l4_dp1 -> expert_agg_l4_dp1
				expert8_l4_dp1 -> expert_agg_l4_dp1
				expert9_l4_dp1 -> expert_agg_l4_dp1
				expert10_l4_dp1 -> expert_agg_l4_dp1
				expert11_l4_dp1 -> expert_agg_l4_dp1
				expert12_l4_dp1 -> expert_agg_l4_dp1
				expert13_l4_dp1 -> expert_agg_l4_dp1
				expert14_l4_dp1 -> expert_agg_l4_dp1
				expert15_l4_dp1 -> expert_agg_l4_dp1
				layer4_output_dp1 [label="Layer 4 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l4_dp1 -> layer4_output_dp1
			}
			layer4_output_dp1 -> attn_input_l5_dp1
			subgraph layer5_dp1_stage1 {
				label="Layer 5" style=rounded
				attn_input_l5_dp1 [label="Attention Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp1 [label="Attention TP0 L5\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp1 -> attn_tp0_l5_dp1
				attn_tp1_l5_dp1 [label="Attention TP1 L5\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp1 -> attn_tp1_l5_dp1
				attn_tp2_l5_dp1 [label="Attention TP2 L5\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp1 -> attn_tp2_l5_dp1
				attn_tp3_l5_dp1 [label="Attention TP3 L5\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp1 -> attn_tp3_l5_dp1
				allreduce_l5_dp1 [label="AllReduce L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp1 -> allreduce_l5_dp1
				attn_tp1_l5_dp1 -> allreduce_l5_dp1
				attn_tp2_l5_dp1 -> allreduce_l5_dp1
				attn_tp3_l5_dp1 -> allreduce_l5_dp1
				moe_input_l5_dp1 [label="MoE Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l5_dp1 [label="Router L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l5_dp1 -> moe_input_l5_dp1
				moe_input_l5_dp1 -> router_l5_dp1
				expert0_l5_dp1 [label="Expert 0 L5\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert0_l5_dp1 [label=select style=dashed]
				expert1_l5_dp1 [label="Expert 1 L5\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert1_l5_dp1 [label=select style=dashed]
				expert2_l5_dp1 [label="Expert 2 L5\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert2_l5_dp1 [label=select style=dashed]
				expert3_l5_dp1 [label="Expert 3 L5\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert3_l5_dp1 [label=select style=dashed]
				expert4_l5_dp1 [label="Expert 4 L5\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert4_l5_dp1 [label=select style=dashed]
				expert5_l5_dp1 [label="Expert 5 L5\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert5_l5_dp1 [label=select style=dashed]
				expert6_l5_dp1 [label="Expert 6 L5\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert6_l5_dp1 [label=select style=dashed]
				expert7_l5_dp1 [label="Expert 7 L5\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert7_l5_dp1 [label=select style=dashed]
				expert8_l5_dp1 [label="Expert 8 L5\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert8_l5_dp1 [label=select style=dashed]
				expert9_l5_dp1 [label="Expert 9 L5\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert9_l5_dp1 [label=select style=dashed]
				expert10_l5_dp1 [label="Expert 10 L5\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert10_l5_dp1 [label=select style=dashed]
				expert11_l5_dp1 [label="Expert 11 L5\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert11_l5_dp1 [label=select style=dashed]
				expert12_l5_dp1 [label="Expert 12 L5\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert12_l5_dp1 [label=select style=dashed]
				expert13_l5_dp1 [label="Expert 13 L5\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert13_l5_dp1 [label=select style=dashed]
				expert14_l5_dp1 [label="Expert 14 L5\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert14_l5_dp1 [label=select style=dashed]
				expert15_l5_dp1 [label="Expert 15 L5\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp1 -> expert15_l5_dp1 [label=select style=dashed]
				expert_agg_l5_dp1 [label="Expert Aggregation L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l5_dp1 -> expert_agg_l5_dp1
				expert1_l5_dp1 -> expert_agg_l5_dp1
				expert2_l5_dp1 -> expert_agg_l5_dp1
				expert3_l5_dp1 -> expert_agg_l5_dp1
				expert4_l5_dp1 -> expert_agg_l5_dp1
				expert5_l5_dp1 -> expert_agg_l5_dp1
				expert6_l5_dp1 -> expert_agg_l5_dp1
				expert7_l5_dp1 -> expert_agg_l5_dp1
				expert8_l5_dp1 -> expert_agg_l5_dp1
				expert9_l5_dp1 -> expert_agg_l5_dp1
				expert10_l5_dp1 -> expert_agg_l5_dp1
				expert11_l5_dp1 -> expert_agg_l5_dp1
				expert12_l5_dp1 -> expert_agg_l5_dp1
				expert13_l5_dp1 -> expert_agg_l5_dp1
				expert14_l5_dp1 -> expert_agg_l5_dp1
				expert15_l5_dp1 -> expert_agg_l5_dp1
				layer5_output_dp1 [label="Layer 5 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l5_dp1 -> layer5_output_dp1
			}
			layer5_output_dp1 -> attn_input_l6_dp1
			subgraph layer6_dp1_stage1 {
				label="Layer 6" style=rounded
				attn_input_l6_dp1 [label="Attention Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp1 [label="Attention TP0 L6\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp1 -> attn_tp0_l6_dp1
				attn_tp1_l6_dp1 [label="Attention TP1 L6\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp1 -> attn_tp1_l6_dp1
				attn_tp2_l6_dp1 [label="Attention TP2 L6\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp1 -> attn_tp2_l6_dp1
				attn_tp3_l6_dp1 [label="Attention TP3 L6\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp1 -> attn_tp3_l6_dp1
				allreduce_l6_dp1 [label="AllReduce L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp1 -> allreduce_l6_dp1
				attn_tp1_l6_dp1 -> allreduce_l6_dp1
				attn_tp2_l6_dp1 -> allreduce_l6_dp1
				attn_tp3_l6_dp1 -> allreduce_l6_dp1
				moe_input_l6_dp1 [label="MoE Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l6_dp1 [label="Router L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l6_dp1 -> moe_input_l6_dp1
				moe_input_l6_dp1 -> router_l6_dp1
				expert0_l6_dp1 [label="Expert 0 L6\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert0_l6_dp1 [label=select style=dashed]
				expert1_l6_dp1 [label="Expert 1 L6\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert1_l6_dp1 [label=select style=dashed]
				expert2_l6_dp1 [label="Expert 2 L6\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert2_l6_dp1 [label=select style=dashed]
				expert3_l6_dp1 [label="Expert 3 L6\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert3_l6_dp1 [label=select style=dashed]
				expert4_l6_dp1 [label="Expert 4 L6\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert4_l6_dp1 [label=select style=dashed]
				expert5_l6_dp1 [label="Expert 5 L6\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert5_l6_dp1 [label=select style=dashed]
				expert6_l6_dp1 [label="Expert 6 L6\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert6_l6_dp1 [label=select style=dashed]
				expert7_l6_dp1 [label="Expert 7 L6\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert7_l6_dp1 [label=select style=dashed]
				expert8_l6_dp1 [label="Expert 8 L6\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert8_l6_dp1 [label=select style=dashed]
				expert9_l6_dp1 [label="Expert 9 L6\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert9_l6_dp1 [label=select style=dashed]
				expert10_l6_dp1 [label="Expert 10 L6\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert10_l6_dp1 [label=select style=dashed]
				expert11_l6_dp1 [label="Expert 11 L6\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert11_l6_dp1 [label=select style=dashed]
				expert12_l6_dp1 [label="Expert 12 L6\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert12_l6_dp1 [label=select style=dashed]
				expert13_l6_dp1 [label="Expert 13 L6\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert13_l6_dp1 [label=select style=dashed]
				expert14_l6_dp1 [label="Expert 14 L6\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert14_l6_dp1 [label=select style=dashed]
				expert15_l6_dp1 [label="Expert 15 L6\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp1 -> expert15_l6_dp1 [label=select style=dashed]
				expert_agg_l6_dp1 [label="Expert Aggregation L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l6_dp1 -> expert_agg_l6_dp1
				expert1_l6_dp1 -> expert_agg_l6_dp1
				expert2_l6_dp1 -> expert_agg_l6_dp1
				expert3_l6_dp1 -> expert_agg_l6_dp1
				expert4_l6_dp1 -> expert_agg_l6_dp1
				expert5_l6_dp1 -> expert_agg_l6_dp1
				expert6_l6_dp1 -> expert_agg_l6_dp1
				expert7_l6_dp1 -> expert_agg_l6_dp1
				expert8_l6_dp1 -> expert_agg_l6_dp1
				expert9_l6_dp1 -> expert_agg_l6_dp1
				expert10_l6_dp1 -> expert_agg_l6_dp1
				expert11_l6_dp1 -> expert_agg_l6_dp1
				expert12_l6_dp1 -> expert_agg_l6_dp1
				expert13_l6_dp1 -> expert_agg_l6_dp1
				expert14_l6_dp1 -> expert_agg_l6_dp1
				expert15_l6_dp1 -> expert_agg_l6_dp1
				layer6_output_dp1 [label="Layer 6 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l6_dp1 -> layer6_output_dp1
			}
			layer6_output_dp1 -> attn_input_l7_dp1
			subgraph layer7_dp1_stage1 {
				label="Layer 7" style=rounded
				attn_input_l7_dp1 [label="Attention Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp1 [label="Attention TP0 L7\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp1 -> attn_tp0_l7_dp1
				attn_tp1_l7_dp1 [label="Attention TP1 L7\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp1 -> attn_tp1_l7_dp1
				attn_tp2_l7_dp1 [label="Attention TP2 L7\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp1 -> attn_tp2_l7_dp1
				attn_tp3_l7_dp1 [label="Attention TP3 L7\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp1 -> attn_tp3_l7_dp1
				allreduce_l7_dp1 [label="AllReduce L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp1 -> allreduce_l7_dp1
				attn_tp1_l7_dp1 -> allreduce_l7_dp1
				attn_tp2_l7_dp1 -> allreduce_l7_dp1
				attn_tp3_l7_dp1 -> allreduce_l7_dp1
				moe_input_l7_dp1 [label="MoE Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l7_dp1 [label="Router L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l7_dp1 -> moe_input_l7_dp1
				moe_input_l7_dp1 -> router_l7_dp1
				expert0_l7_dp1 [label="Expert 0 L7\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert0_l7_dp1 [label=select style=dashed]
				expert1_l7_dp1 [label="Expert 1 L7\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert1_l7_dp1 [label=select style=dashed]
				expert2_l7_dp1 [label="Expert 2 L7\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert2_l7_dp1 [label=select style=dashed]
				expert3_l7_dp1 [label="Expert 3 L7\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert3_l7_dp1 [label=select style=dashed]
				expert4_l7_dp1 [label="Expert 4 L7\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert4_l7_dp1 [label=select style=dashed]
				expert5_l7_dp1 [label="Expert 5 L7\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert5_l7_dp1 [label=select style=dashed]
				expert6_l7_dp1 [label="Expert 6 L7\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert6_l7_dp1 [label=select style=dashed]
				expert7_l7_dp1 [label="Expert 7 L7\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert7_l7_dp1 [label=select style=dashed]
				expert8_l7_dp1 [label="Expert 8 L7\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert8_l7_dp1 [label=select style=dashed]
				expert9_l7_dp1 [label="Expert 9 L7\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert9_l7_dp1 [label=select style=dashed]
				expert10_l7_dp1 [label="Expert 10 L7\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert10_l7_dp1 [label=select style=dashed]
				expert11_l7_dp1 [label="Expert 11 L7\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert11_l7_dp1 [label=select style=dashed]
				expert12_l7_dp1 [label="Expert 12 L7\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert12_l7_dp1 [label=select style=dashed]
				expert13_l7_dp1 [label="Expert 13 L7\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert13_l7_dp1 [label=select style=dashed]
				expert14_l7_dp1 [label="Expert 14 L7\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert14_l7_dp1 [label=select style=dashed]
				expert15_l7_dp1 [label="Expert 15 L7\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp1 -> expert15_l7_dp1 [label=select style=dashed]
				expert_agg_l7_dp1 [label="Expert Aggregation L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l7_dp1 -> expert_agg_l7_dp1
				expert1_l7_dp1 -> expert_agg_l7_dp1
				expert2_l7_dp1 -> expert_agg_l7_dp1
				expert3_l7_dp1 -> expert_agg_l7_dp1
				expert4_l7_dp1 -> expert_agg_l7_dp1
				expert5_l7_dp1 -> expert_agg_l7_dp1
				expert6_l7_dp1 -> expert_agg_l7_dp1
				expert7_l7_dp1 -> expert_agg_l7_dp1
				expert8_l7_dp1 -> expert_agg_l7_dp1
				expert9_l7_dp1 -> expert_agg_l7_dp1
				expert10_l7_dp1 -> expert_agg_l7_dp1
				expert11_l7_dp1 -> expert_agg_l7_dp1
				expert12_l7_dp1 -> expert_agg_l7_dp1
				expert13_l7_dp1 -> expert_agg_l7_dp1
				expert14_l7_dp1 -> expert_agg_l7_dp1
				expert15_l7_dp1 -> expert_agg_l7_dp1
				layer7_output_dp1 [label="Layer 7 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l7_dp1 -> layer7_output_dp1
			}
			layer7_output_dp1 -> attn_input_l8_dp1
			subgraph layer8_dp1_stage1 {
				label="Layer 8" style=rounded
				attn_input_l8_dp1 [label="Attention Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp1 [label="Attention TP0 L8\nGPU 32\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp1 -> attn_tp0_l8_dp1
				attn_tp1_l8_dp1 [label="Attention TP1 L8\nGPU 33\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp1 -> attn_tp1_l8_dp1
				attn_tp2_l8_dp1 [label="Attention TP2 L8\nGPU 34\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp1 -> attn_tp2_l8_dp1
				attn_tp3_l8_dp1 [label="Attention TP3 L8\nGPU 35\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp1 -> attn_tp3_l8_dp1
				allreduce_l8_dp1 [label="AllReduce L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp1 -> allreduce_l8_dp1
				attn_tp1_l8_dp1 -> allreduce_l8_dp1
				attn_tp2_l8_dp1 -> allreduce_l8_dp1
				attn_tp3_l8_dp1 -> allreduce_l8_dp1
				moe_input_l8_dp1 [label="MoE Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l8_dp1 [label="Router L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l8_dp1 -> moe_input_l8_dp1
				moe_input_l8_dp1 -> router_l8_dp1
				expert0_l8_dp1 [label="Expert 0 L8\nGPU 32\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert0_l8_dp1 [label=select style=dashed]
				expert1_l8_dp1 [label="Expert 1 L8\nGPU 33\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert1_l8_dp1 [label=select style=dashed]
				expert2_l8_dp1 [label="Expert 2 L8\nGPU 34\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert2_l8_dp1 [label=select style=dashed]
				expert3_l8_dp1 [label="Expert 3 L8\nGPU 35\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert3_l8_dp1 [label=select style=dashed]
				expert4_l8_dp1 [label="Expert 4 L8\nGPU 36\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert4_l8_dp1 [label=select style=dashed]
				expert5_l8_dp1 [label="Expert 5 L8\nGPU 37\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert5_l8_dp1 [label=select style=dashed]
				expert6_l8_dp1 [label="Expert 6 L8\nGPU 38\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert6_l8_dp1 [label=select style=dashed]
				expert7_l8_dp1 [label="Expert 7 L8\nGPU 39\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert7_l8_dp1 [label=select style=dashed]
				expert8_l8_dp1 [label="Expert 8 L8\nGPU 40\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert8_l8_dp1 [label=select style=dashed]
				expert9_l8_dp1 [label="Expert 9 L8\nGPU 41\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert9_l8_dp1 [label=select style=dashed]
				expert10_l8_dp1 [label="Expert 10 L8\nGPU 42\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert10_l8_dp1 [label=select style=dashed]
				expert11_l8_dp1 [label="Expert 11 L8\nGPU 43\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert11_l8_dp1 [label=select style=dashed]
				expert12_l8_dp1 [label="Expert 12 L8\nGPU 44\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert12_l8_dp1 [label=select style=dashed]
				expert13_l8_dp1 [label="Expert 13 L8\nGPU 45\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert13_l8_dp1 [label=select style=dashed]
				expert14_l8_dp1 [label="Expert 14 L8\nGPU 46\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert14_l8_dp1 [label=select style=dashed]
				expert15_l8_dp1 [label="Expert 15 L8\nGPU 47\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp1 -> expert15_l8_dp1 [label=select style=dashed]
				expert_agg_l8_dp1 [label="Expert Aggregation L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l8_dp1 -> expert_agg_l8_dp1
				expert1_l8_dp1 -> expert_agg_l8_dp1
				expert2_l8_dp1 -> expert_agg_l8_dp1
				expert3_l8_dp1 -> expert_agg_l8_dp1
				expert4_l8_dp1 -> expert_agg_l8_dp1
				expert5_l8_dp1 -> expert_agg_l8_dp1
				expert6_l8_dp1 -> expert_agg_l8_dp1
				expert7_l8_dp1 -> expert_agg_l8_dp1
				expert8_l8_dp1 -> expert_agg_l8_dp1
				expert9_l8_dp1 -> expert_agg_l8_dp1
				expert10_l8_dp1 -> expert_agg_l8_dp1
				expert11_l8_dp1 -> expert_agg_l8_dp1
				expert12_l8_dp1 -> expert_agg_l8_dp1
				expert13_l8_dp1 -> expert_agg_l8_dp1
				expert14_l8_dp1 -> expert_agg_l8_dp1
				expert15_l8_dp1 -> expert_agg_l8_dp1
				layer8_output_dp1 [label="Layer 8 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l8_dp1 -> layer8_output_dp1
			}
			stage1_output_dp1 [label="Stage 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer8_output_dp1 -> stage1_output_dp1
		}
		stage1_output_dp1 -> stage2_input_dp1 [lhead=stage2_dp1]
		subgraph stage2_dp1 {
			fillcolor=lightcyan label="PP Stage 2 (Layers 9-16)" style="rounded,filled"
			stage2_input_dp1 [label="Stage 2 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage2_input_dp1 -> attn_input_l9_dp1
			subgraph layer9_dp1_stage2 {
				label="Layer 9" style=rounded
				attn_input_l9_dp1 [label="Attention Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp1 [label="Attention TP0 L9\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp1 -> attn_tp0_l9_dp1
				attn_tp1_l9_dp1 [label="Attention TP1 L9\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp1 -> attn_tp1_l9_dp1
				attn_tp2_l9_dp1 [label="Attention TP2 L9\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp1 -> attn_tp2_l9_dp1
				attn_tp3_l9_dp1 [label="Attention TP3 L9\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp1 -> attn_tp3_l9_dp1
				allreduce_l9_dp1 [label="AllReduce L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp1 -> allreduce_l9_dp1
				attn_tp1_l9_dp1 -> allreduce_l9_dp1
				attn_tp2_l9_dp1 -> allreduce_l9_dp1
				attn_tp3_l9_dp1 -> allreduce_l9_dp1
				moe_input_l9_dp1 [label="MoE Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l9_dp1 [label="Router L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l9_dp1 -> moe_input_l9_dp1
				moe_input_l9_dp1 -> router_l9_dp1
				expert0_l9_dp1 [label="Expert 0 L9\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert0_l9_dp1 [label=select style=dashed]
				expert1_l9_dp1 [label="Expert 1 L9\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert1_l9_dp1 [label=select style=dashed]
				expert2_l9_dp1 [label="Expert 2 L9\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert2_l9_dp1 [label=select style=dashed]
				expert3_l9_dp1 [label="Expert 3 L9\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert3_l9_dp1 [label=select style=dashed]
				expert4_l9_dp1 [label="Expert 4 L9\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert4_l9_dp1 [label=select style=dashed]
				expert5_l9_dp1 [label="Expert 5 L9\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert5_l9_dp1 [label=select style=dashed]
				expert6_l9_dp1 [label="Expert 6 L9\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert6_l9_dp1 [label=select style=dashed]
				expert7_l9_dp1 [label="Expert 7 L9\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert7_l9_dp1 [label=select style=dashed]
				expert8_l9_dp1 [label="Expert 8 L9\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert8_l9_dp1 [label=select style=dashed]
				expert9_l9_dp1 [label="Expert 9 L9\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert9_l9_dp1 [label=select style=dashed]
				expert10_l9_dp1 [label="Expert 10 L9\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert10_l9_dp1 [label=select style=dashed]
				expert11_l9_dp1 [label="Expert 11 L9\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert11_l9_dp1 [label=select style=dashed]
				expert12_l9_dp1 [label="Expert 12 L9\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert12_l9_dp1 [label=select style=dashed]
				expert13_l9_dp1 [label="Expert 13 L9\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert13_l9_dp1 [label=select style=dashed]
				expert14_l9_dp1 [label="Expert 14 L9\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert14_l9_dp1 [label=select style=dashed]
				expert15_l9_dp1 [label="Expert 15 L9\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp1 -> expert15_l9_dp1 [label=select style=dashed]
				expert_agg_l9_dp1 [label="Expert Aggregation L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l9_dp1 -> expert_agg_l9_dp1
				expert1_l9_dp1 -> expert_agg_l9_dp1
				expert2_l9_dp1 -> expert_agg_l9_dp1
				expert3_l9_dp1 -> expert_agg_l9_dp1
				expert4_l9_dp1 -> expert_agg_l9_dp1
				expert5_l9_dp1 -> expert_agg_l9_dp1
				expert6_l9_dp1 -> expert_agg_l9_dp1
				expert7_l9_dp1 -> expert_agg_l9_dp1
				expert8_l9_dp1 -> expert_agg_l9_dp1
				expert9_l9_dp1 -> expert_agg_l9_dp1
				expert10_l9_dp1 -> expert_agg_l9_dp1
				expert11_l9_dp1 -> expert_agg_l9_dp1
				expert12_l9_dp1 -> expert_agg_l9_dp1
				expert13_l9_dp1 -> expert_agg_l9_dp1
				expert14_l9_dp1 -> expert_agg_l9_dp1
				expert15_l9_dp1 -> expert_agg_l9_dp1
				layer9_output_dp1 [label="Layer 9 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l9_dp1 -> layer9_output_dp1
			}
			layer9_output_dp1 -> attn_input_l10_dp1
			subgraph layer10_dp1_stage2 {
				label="Layer 10" style=rounded
				attn_input_l10_dp1 [label="Attention Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp1 [label="Attention TP0 L10\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp1 -> attn_tp0_l10_dp1
				attn_tp1_l10_dp1 [label="Attention TP1 L10\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp1 -> attn_tp1_l10_dp1
				attn_tp2_l10_dp1 [label="Attention TP2 L10\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp1 -> attn_tp2_l10_dp1
				attn_tp3_l10_dp1 [label="Attention TP3 L10\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp1 -> attn_tp3_l10_dp1
				allreduce_l10_dp1 [label="AllReduce L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp1 -> allreduce_l10_dp1
				attn_tp1_l10_dp1 -> allreduce_l10_dp1
				attn_tp2_l10_dp1 -> allreduce_l10_dp1
				attn_tp3_l10_dp1 -> allreduce_l10_dp1
				moe_input_l10_dp1 [label="MoE Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l10_dp1 [label="Router L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l10_dp1 -> moe_input_l10_dp1
				moe_input_l10_dp1 -> router_l10_dp1
				expert0_l10_dp1 [label="Expert 0 L10\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert0_l10_dp1 [label=select style=dashed]
				expert1_l10_dp1 [label="Expert 1 L10\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert1_l10_dp1 [label=select style=dashed]
				expert2_l10_dp1 [label="Expert 2 L10\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert2_l10_dp1 [label=select style=dashed]
				expert3_l10_dp1 [label="Expert 3 L10\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert3_l10_dp1 [label=select style=dashed]
				expert4_l10_dp1 [label="Expert 4 L10\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert4_l10_dp1 [label=select style=dashed]
				expert5_l10_dp1 [label="Expert 5 L10\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert5_l10_dp1 [label=select style=dashed]
				expert6_l10_dp1 [label="Expert 6 L10\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert6_l10_dp1 [label=select style=dashed]
				expert7_l10_dp1 [label="Expert 7 L10\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert7_l10_dp1 [label=select style=dashed]
				expert8_l10_dp1 [label="Expert 8 L10\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert8_l10_dp1 [label=select style=dashed]
				expert9_l10_dp1 [label="Expert 9 L10\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert9_l10_dp1 [label=select style=dashed]
				expert10_l10_dp1 [label="Expert 10 L10\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert10_l10_dp1 [label=select style=dashed]
				expert11_l10_dp1 [label="Expert 11 L10\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert11_l10_dp1 [label=select style=dashed]
				expert12_l10_dp1 [label="Expert 12 L10\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert12_l10_dp1 [label=select style=dashed]
				expert13_l10_dp1 [label="Expert 13 L10\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert13_l10_dp1 [label=select style=dashed]
				expert14_l10_dp1 [label="Expert 14 L10\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert14_l10_dp1 [label=select style=dashed]
				expert15_l10_dp1 [label="Expert 15 L10\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp1 -> expert15_l10_dp1 [label=select style=dashed]
				expert_agg_l10_dp1 [label="Expert Aggregation L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l10_dp1 -> expert_agg_l10_dp1
				expert1_l10_dp1 -> expert_agg_l10_dp1
				expert2_l10_dp1 -> expert_agg_l10_dp1
				expert3_l10_dp1 -> expert_agg_l10_dp1
				expert4_l10_dp1 -> expert_agg_l10_dp1
				expert5_l10_dp1 -> expert_agg_l10_dp1
				expert6_l10_dp1 -> expert_agg_l10_dp1
				expert7_l10_dp1 -> expert_agg_l10_dp1
				expert8_l10_dp1 -> expert_agg_l10_dp1
				expert9_l10_dp1 -> expert_agg_l10_dp1
				expert10_l10_dp1 -> expert_agg_l10_dp1
				expert11_l10_dp1 -> expert_agg_l10_dp1
				expert12_l10_dp1 -> expert_agg_l10_dp1
				expert13_l10_dp1 -> expert_agg_l10_dp1
				expert14_l10_dp1 -> expert_agg_l10_dp1
				expert15_l10_dp1 -> expert_agg_l10_dp1
				layer10_output_dp1 [label="Layer 10 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l10_dp1 -> layer10_output_dp1
			}
			layer10_output_dp1 -> attn_input_l11_dp1
			subgraph layer11_dp1_stage2 {
				label="Layer 11" style=rounded
				attn_input_l11_dp1 [label="Attention Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp1 [label="Attention TP0 L11\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp1 -> attn_tp0_l11_dp1
				attn_tp1_l11_dp1 [label="Attention TP1 L11\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp1 -> attn_tp1_l11_dp1
				attn_tp2_l11_dp1 [label="Attention TP2 L11\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp1 -> attn_tp2_l11_dp1
				attn_tp3_l11_dp1 [label="Attention TP3 L11\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp1 -> attn_tp3_l11_dp1
				allreduce_l11_dp1 [label="AllReduce L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp1 -> allreduce_l11_dp1
				attn_tp1_l11_dp1 -> allreduce_l11_dp1
				attn_tp2_l11_dp1 -> allreduce_l11_dp1
				attn_tp3_l11_dp1 -> allreduce_l11_dp1
				moe_input_l11_dp1 [label="MoE Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l11_dp1 [label="Router L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l11_dp1 -> moe_input_l11_dp1
				moe_input_l11_dp1 -> router_l11_dp1
				expert0_l11_dp1 [label="Expert 0 L11\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert0_l11_dp1 [label=select style=dashed]
				expert1_l11_dp1 [label="Expert 1 L11\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert1_l11_dp1 [label=select style=dashed]
				expert2_l11_dp1 [label="Expert 2 L11\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert2_l11_dp1 [label=select style=dashed]
				expert3_l11_dp1 [label="Expert 3 L11\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert3_l11_dp1 [label=select style=dashed]
				expert4_l11_dp1 [label="Expert 4 L11\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert4_l11_dp1 [label=select style=dashed]
				expert5_l11_dp1 [label="Expert 5 L11\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert5_l11_dp1 [label=select style=dashed]
				expert6_l11_dp1 [label="Expert 6 L11\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert6_l11_dp1 [label=select style=dashed]
				expert7_l11_dp1 [label="Expert 7 L11\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert7_l11_dp1 [label=select style=dashed]
				expert8_l11_dp1 [label="Expert 8 L11\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert8_l11_dp1 [label=select style=dashed]
				expert9_l11_dp1 [label="Expert 9 L11\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert9_l11_dp1 [label=select style=dashed]
				expert10_l11_dp1 [label="Expert 10 L11\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert10_l11_dp1 [label=select style=dashed]
				expert11_l11_dp1 [label="Expert 11 L11\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert11_l11_dp1 [label=select style=dashed]
				expert12_l11_dp1 [label="Expert 12 L11\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert12_l11_dp1 [label=select style=dashed]
				expert13_l11_dp1 [label="Expert 13 L11\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert13_l11_dp1 [label=select style=dashed]
				expert14_l11_dp1 [label="Expert 14 L11\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert14_l11_dp1 [label=select style=dashed]
				expert15_l11_dp1 [label="Expert 15 L11\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp1 -> expert15_l11_dp1 [label=select style=dashed]
				expert_agg_l11_dp1 [label="Expert Aggregation L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l11_dp1 -> expert_agg_l11_dp1
				expert1_l11_dp1 -> expert_agg_l11_dp1
				expert2_l11_dp1 -> expert_agg_l11_dp1
				expert3_l11_dp1 -> expert_agg_l11_dp1
				expert4_l11_dp1 -> expert_agg_l11_dp1
				expert5_l11_dp1 -> expert_agg_l11_dp1
				expert6_l11_dp1 -> expert_agg_l11_dp1
				expert7_l11_dp1 -> expert_agg_l11_dp1
				expert8_l11_dp1 -> expert_agg_l11_dp1
				expert9_l11_dp1 -> expert_agg_l11_dp1
				expert10_l11_dp1 -> expert_agg_l11_dp1
				expert11_l11_dp1 -> expert_agg_l11_dp1
				expert12_l11_dp1 -> expert_agg_l11_dp1
				expert13_l11_dp1 -> expert_agg_l11_dp1
				expert14_l11_dp1 -> expert_agg_l11_dp1
				expert15_l11_dp1 -> expert_agg_l11_dp1
				layer11_output_dp1 [label="Layer 11 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l11_dp1 -> layer11_output_dp1
			}
			layer11_output_dp1 -> attn_input_l12_dp1
			subgraph layer12_dp1_stage2 {
				label="Layer 12" style=rounded
				attn_input_l12_dp1 [label="Attention Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp1 [label="Attention TP0 L12\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp1 -> attn_tp0_l12_dp1
				attn_tp1_l12_dp1 [label="Attention TP1 L12\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp1 -> attn_tp1_l12_dp1
				attn_tp2_l12_dp1 [label="Attention TP2 L12\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp1 -> attn_tp2_l12_dp1
				attn_tp3_l12_dp1 [label="Attention TP3 L12\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp1 -> attn_tp3_l12_dp1
				allreduce_l12_dp1 [label="AllReduce L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp1 -> allreduce_l12_dp1
				attn_tp1_l12_dp1 -> allreduce_l12_dp1
				attn_tp2_l12_dp1 -> allreduce_l12_dp1
				attn_tp3_l12_dp1 -> allreduce_l12_dp1
				moe_input_l12_dp1 [label="MoE Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l12_dp1 [label="Router L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l12_dp1 -> moe_input_l12_dp1
				moe_input_l12_dp1 -> router_l12_dp1
				expert0_l12_dp1 [label="Expert 0 L12\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert0_l12_dp1 [label=select style=dashed]
				expert1_l12_dp1 [label="Expert 1 L12\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert1_l12_dp1 [label=select style=dashed]
				expert2_l12_dp1 [label="Expert 2 L12\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert2_l12_dp1 [label=select style=dashed]
				expert3_l12_dp1 [label="Expert 3 L12\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert3_l12_dp1 [label=select style=dashed]
				expert4_l12_dp1 [label="Expert 4 L12\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert4_l12_dp1 [label=select style=dashed]
				expert5_l12_dp1 [label="Expert 5 L12\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert5_l12_dp1 [label=select style=dashed]
				expert6_l12_dp1 [label="Expert 6 L12\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert6_l12_dp1 [label=select style=dashed]
				expert7_l12_dp1 [label="Expert 7 L12\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert7_l12_dp1 [label=select style=dashed]
				expert8_l12_dp1 [label="Expert 8 L12\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert8_l12_dp1 [label=select style=dashed]
				expert9_l12_dp1 [label="Expert 9 L12\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert9_l12_dp1 [label=select style=dashed]
				expert10_l12_dp1 [label="Expert 10 L12\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert10_l12_dp1 [label=select style=dashed]
				expert11_l12_dp1 [label="Expert 11 L12\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert11_l12_dp1 [label=select style=dashed]
				expert12_l12_dp1 [label="Expert 12 L12\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert12_l12_dp1 [label=select style=dashed]
				expert13_l12_dp1 [label="Expert 13 L12\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert13_l12_dp1 [label=select style=dashed]
				expert14_l12_dp1 [label="Expert 14 L12\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert14_l12_dp1 [label=select style=dashed]
				expert15_l12_dp1 [label="Expert 15 L12\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp1 -> expert15_l12_dp1 [label=select style=dashed]
				expert_agg_l12_dp1 [label="Expert Aggregation L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l12_dp1 -> expert_agg_l12_dp1
				expert1_l12_dp1 -> expert_agg_l12_dp1
				expert2_l12_dp1 -> expert_agg_l12_dp1
				expert3_l12_dp1 -> expert_agg_l12_dp1
				expert4_l12_dp1 -> expert_agg_l12_dp1
				expert5_l12_dp1 -> expert_agg_l12_dp1
				expert6_l12_dp1 -> expert_agg_l12_dp1
				expert7_l12_dp1 -> expert_agg_l12_dp1
				expert8_l12_dp1 -> expert_agg_l12_dp1
				expert9_l12_dp1 -> expert_agg_l12_dp1
				expert10_l12_dp1 -> expert_agg_l12_dp1
				expert11_l12_dp1 -> expert_agg_l12_dp1
				expert12_l12_dp1 -> expert_agg_l12_dp1
				expert13_l12_dp1 -> expert_agg_l12_dp1
				expert14_l12_dp1 -> expert_agg_l12_dp1
				expert15_l12_dp1 -> expert_agg_l12_dp1
				layer12_output_dp1 [label="Layer 12 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l12_dp1 -> layer12_output_dp1
			}
			layer12_output_dp1 -> attn_input_l13_dp1
			subgraph layer13_dp1_stage2 {
				label="Layer 13" style=rounded
				attn_input_l13_dp1 [label="Attention Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp1 [label="Attention TP0 L13\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp1 -> attn_tp0_l13_dp1
				attn_tp1_l13_dp1 [label="Attention TP1 L13\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp1 -> attn_tp1_l13_dp1
				attn_tp2_l13_dp1 [label="Attention TP2 L13\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp1 -> attn_tp2_l13_dp1
				attn_tp3_l13_dp1 [label="Attention TP3 L13\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp1 -> attn_tp3_l13_dp1
				allreduce_l13_dp1 [label="AllReduce L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp1 -> allreduce_l13_dp1
				attn_tp1_l13_dp1 -> allreduce_l13_dp1
				attn_tp2_l13_dp1 -> allreduce_l13_dp1
				attn_tp3_l13_dp1 -> allreduce_l13_dp1
				moe_input_l13_dp1 [label="MoE Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l13_dp1 [label="Router L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l13_dp1 -> moe_input_l13_dp1
				moe_input_l13_dp1 -> router_l13_dp1
				expert0_l13_dp1 [label="Expert 0 L13\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert0_l13_dp1 [label=select style=dashed]
				expert1_l13_dp1 [label="Expert 1 L13\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert1_l13_dp1 [label=select style=dashed]
				expert2_l13_dp1 [label="Expert 2 L13\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert2_l13_dp1 [label=select style=dashed]
				expert3_l13_dp1 [label="Expert 3 L13\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert3_l13_dp1 [label=select style=dashed]
				expert4_l13_dp1 [label="Expert 4 L13\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert4_l13_dp1 [label=select style=dashed]
				expert5_l13_dp1 [label="Expert 5 L13\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert5_l13_dp1 [label=select style=dashed]
				expert6_l13_dp1 [label="Expert 6 L13\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert6_l13_dp1 [label=select style=dashed]
				expert7_l13_dp1 [label="Expert 7 L13\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert7_l13_dp1 [label=select style=dashed]
				expert8_l13_dp1 [label="Expert 8 L13\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert8_l13_dp1 [label=select style=dashed]
				expert9_l13_dp1 [label="Expert 9 L13\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert9_l13_dp1 [label=select style=dashed]
				expert10_l13_dp1 [label="Expert 10 L13\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert10_l13_dp1 [label=select style=dashed]
				expert11_l13_dp1 [label="Expert 11 L13\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert11_l13_dp1 [label=select style=dashed]
				expert12_l13_dp1 [label="Expert 12 L13\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert12_l13_dp1 [label=select style=dashed]
				expert13_l13_dp1 [label="Expert 13 L13\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert13_l13_dp1 [label=select style=dashed]
				expert14_l13_dp1 [label="Expert 14 L13\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert14_l13_dp1 [label=select style=dashed]
				expert15_l13_dp1 [label="Expert 15 L13\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp1 -> expert15_l13_dp1 [label=select style=dashed]
				expert_agg_l13_dp1 [label="Expert Aggregation L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l13_dp1 -> expert_agg_l13_dp1
				expert1_l13_dp1 -> expert_agg_l13_dp1
				expert2_l13_dp1 -> expert_agg_l13_dp1
				expert3_l13_dp1 -> expert_agg_l13_dp1
				expert4_l13_dp1 -> expert_agg_l13_dp1
				expert5_l13_dp1 -> expert_agg_l13_dp1
				expert6_l13_dp1 -> expert_agg_l13_dp1
				expert7_l13_dp1 -> expert_agg_l13_dp1
				expert8_l13_dp1 -> expert_agg_l13_dp1
				expert9_l13_dp1 -> expert_agg_l13_dp1
				expert10_l13_dp1 -> expert_agg_l13_dp1
				expert11_l13_dp1 -> expert_agg_l13_dp1
				expert12_l13_dp1 -> expert_agg_l13_dp1
				expert13_l13_dp1 -> expert_agg_l13_dp1
				expert14_l13_dp1 -> expert_agg_l13_dp1
				expert15_l13_dp1 -> expert_agg_l13_dp1
				layer13_output_dp1 [label="Layer 13 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l13_dp1 -> layer13_output_dp1
			}
			layer13_output_dp1 -> attn_input_l14_dp1
			subgraph layer14_dp1_stage2 {
				label="Layer 14" style=rounded
				attn_input_l14_dp1 [label="Attention Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp1 [label="Attention TP0 L14\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp1 -> attn_tp0_l14_dp1
				attn_tp1_l14_dp1 [label="Attention TP1 L14\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp1 -> attn_tp1_l14_dp1
				attn_tp2_l14_dp1 [label="Attention TP2 L14\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp1 -> attn_tp2_l14_dp1
				attn_tp3_l14_dp1 [label="Attention TP3 L14\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp1 -> attn_tp3_l14_dp1
				allreduce_l14_dp1 [label="AllReduce L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp1 -> allreduce_l14_dp1
				attn_tp1_l14_dp1 -> allreduce_l14_dp1
				attn_tp2_l14_dp1 -> allreduce_l14_dp1
				attn_tp3_l14_dp1 -> allreduce_l14_dp1
				moe_input_l14_dp1 [label="MoE Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l14_dp1 [label="Router L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l14_dp1 -> moe_input_l14_dp1
				moe_input_l14_dp1 -> router_l14_dp1
				expert0_l14_dp1 [label="Expert 0 L14\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert0_l14_dp1 [label=select style=dashed]
				expert1_l14_dp1 [label="Expert 1 L14\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert1_l14_dp1 [label=select style=dashed]
				expert2_l14_dp1 [label="Expert 2 L14\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert2_l14_dp1 [label=select style=dashed]
				expert3_l14_dp1 [label="Expert 3 L14\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert3_l14_dp1 [label=select style=dashed]
				expert4_l14_dp1 [label="Expert 4 L14\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert4_l14_dp1 [label=select style=dashed]
				expert5_l14_dp1 [label="Expert 5 L14\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert5_l14_dp1 [label=select style=dashed]
				expert6_l14_dp1 [label="Expert 6 L14\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert6_l14_dp1 [label=select style=dashed]
				expert7_l14_dp1 [label="Expert 7 L14\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert7_l14_dp1 [label=select style=dashed]
				expert8_l14_dp1 [label="Expert 8 L14\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert8_l14_dp1 [label=select style=dashed]
				expert9_l14_dp1 [label="Expert 9 L14\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert9_l14_dp1 [label=select style=dashed]
				expert10_l14_dp1 [label="Expert 10 L14\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert10_l14_dp1 [label=select style=dashed]
				expert11_l14_dp1 [label="Expert 11 L14\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert11_l14_dp1 [label=select style=dashed]
				expert12_l14_dp1 [label="Expert 12 L14\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert12_l14_dp1 [label=select style=dashed]
				expert13_l14_dp1 [label="Expert 13 L14\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert13_l14_dp1 [label=select style=dashed]
				expert14_l14_dp1 [label="Expert 14 L14\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert14_l14_dp1 [label=select style=dashed]
				expert15_l14_dp1 [label="Expert 15 L14\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp1 -> expert15_l14_dp1 [label=select style=dashed]
				expert_agg_l14_dp1 [label="Expert Aggregation L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l14_dp1 -> expert_agg_l14_dp1
				expert1_l14_dp1 -> expert_agg_l14_dp1
				expert2_l14_dp1 -> expert_agg_l14_dp1
				expert3_l14_dp1 -> expert_agg_l14_dp1
				expert4_l14_dp1 -> expert_agg_l14_dp1
				expert5_l14_dp1 -> expert_agg_l14_dp1
				expert6_l14_dp1 -> expert_agg_l14_dp1
				expert7_l14_dp1 -> expert_agg_l14_dp1
				expert8_l14_dp1 -> expert_agg_l14_dp1
				expert9_l14_dp1 -> expert_agg_l14_dp1
				expert10_l14_dp1 -> expert_agg_l14_dp1
				expert11_l14_dp1 -> expert_agg_l14_dp1
				expert12_l14_dp1 -> expert_agg_l14_dp1
				expert13_l14_dp1 -> expert_agg_l14_dp1
				expert14_l14_dp1 -> expert_agg_l14_dp1
				expert15_l14_dp1 -> expert_agg_l14_dp1
				layer14_output_dp1 [label="Layer 14 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l14_dp1 -> layer14_output_dp1
			}
			layer14_output_dp1 -> attn_input_l15_dp1
			subgraph layer15_dp1_stage2 {
				label="Layer 15" style=rounded
				attn_input_l15_dp1 [label="Attention Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp1 [label="Attention TP0 L15\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp1 -> attn_tp0_l15_dp1
				attn_tp1_l15_dp1 [label="Attention TP1 L15\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp1 -> attn_tp1_l15_dp1
				attn_tp2_l15_dp1 [label="Attention TP2 L15\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp1 -> attn_tp2_l15_dp1
				attn_tp3_l15_dp1 [label="Attention TP3 L15\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp1 -> attn_tp3_l15_dp1
				allreduce_l15_dp1 [label="AllReduce L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp1 -> allreduce_l15_dp1
				attn_tp1_l15_dp1 -> allreduce_l15_dp1
				attn_tp2_l15_dp1 -> allreduce_l15_dp1
				attn_tp3_l15_dp1 -> allreduce_l15_dp1
				moe_input_l15_dp1 [label="MoE Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l15_dp1 [label="Router L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l15_dp1 -> moe_input_l15_dp1
				moe_input_l15_dp1 -> router_l15_dp1
				expert0_l15_dp1 [label="Expert 0 L15\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert0_l15_dp1 [label=select style=dashed]
				expert1_l15_dp1 [label="Expert 1 L15\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert1_l15_dp1 [label=select style=dashed]
				expert2_l15_dp1 [label="Expert 2 L15\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert2_l15_dp1 [label=select style=dashed]
				expert3_l15_dp1 [label="Expert 3 L15\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert3_l15_dp1 [label=select style=dashed]
				expert4_l15_dp1 [label="Expert 4 L15\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert4_l15_dp1 [label=select style=dashed]
				expert5_l15_dp1 [label="Expert 5 L15\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert5_l15_dp1 [label=select style=dashed]
				expert6_l15_dp1 [label="Expert 6 L15\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert6_l15_dp1 [label=select style=dashed]
				expert7_l15_dp1 [label="Expert 7 L15\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert7_l15_dp1 [label=select style=dashed]
				expert8_l15_dp1 [label="Expert 8 L15\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert8_l15_dp1 [label=select style=dashed]
				expert9_l15_dp1 [label="Expert 9 L15\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert9_l15_dp1 [label=select style=dashed]
				expert10_l15_dp1 [label="Expert 10 L15\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert10_l15_dp1 [label=select style=dashed]
				expert11_l15_dp1 [label="Expert 11 L15\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert11_l15_dp1 [label=select style=dashed]
				expert12_l15_dp1 [label="Expert 12 L15\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert12_l15_dp1 [label=select style=dashed]
				expert13_l15_dp1 [label="Expert 13 L15\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert13_l15_dp1 [label=select style=dashed]
				expert14_l15_dp1 [label="Expert 14 L15\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert14_l15_dp1 [label=select style=dashed]
				expert15_l15_dp1 [label="Expert 15 L15\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp1 -> expert15_l15_dp1 [label=select style=dashed]
				expert_agg_l15_dp1 [label="Expert Aggregation L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l15_dp1 -> expert_agg_l15_dp1
				expert1_l15_dp1 -> expert_agg_l15_dp1
				expert2_l15_dp1 -> expert_agg_l15_dp1
				expert3_l15_dp1 -> expert_agg_l15_dp1
				expert4_l15_dp1 -> expert_agg_l15_dp1
				expert5_l15_dp1 -> expert_agg_l15_dp1
				expert6_l15_dp1 -> expert_agg_l15_dp1
				expert7_l15_dp1 -> expert_agg_l15_dp1
				expert8_l15_dp1 -> expert_agg_l15_dp1
				expert9_l15_dp1 -> expert_agg_l15_dp1
				expert10_l15_dp1 -> expert_agg_l15_dp1
				expert11_l15_dp1 -> expert_agg_l15_dp1
				expert12_l15_dp1 -> expert_agg_l15_dp1
				expert13_l15_dp1 -> expert_agg_l15_dp1
				expert14_l15_dp1 -> expert_agg_l15_dp1
				expert15_l15_dp1 -> expert_agg_l15_dp1
				layer15_output_dp1 [label="Layer 15 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l15_dp1 -> layer15_output_dp1
			}
			layer15_output_dp1 -> attn_input_l16_dp1
			subgraph layer16_dp1_stage2 {
				label="Layer 16" style=rounded
				attn_input_l16_dp1 [label="Attention Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp1 [label="Attention TP0 L16\nGPU 48\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp1 -> attn_tp0_l16_dp1
				attn_tp1_l16_dp1 [label="Attention TP1 L16\nGPU 49\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp1 -> attn_tp1_l16_dp1
				attn_tp2_l16_dp1 [label="Attention TP2 L16\nGPU 50\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp1 -> attn_tp2_l16_dp1
				attn_tp3_l16_dp1 [label="Attention TP3 L16\nGPU 51\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp1 -> attn_tp3_l16_dp1
				allreduce_l16_dp1 [label="AllReduce L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp1 -> allreduce_l16_dp1
				attn_tp1_l16_dp1 -> allreduce_l16_dp1
				attn_tp2_l16_dp1 -> allreduce_l16_dp1
				attn_tp3_l16_dp1 -> allreduce_l16_dp1
				moe_input_l16_dp1 [label="MoE Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l16_dp1 [label="Router L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l16_dp1 -> moe_input_l16_dp1
				moe_input_l16_dp1 -> router_l16_dp1
				expert0_l16_dp1 [label="Expert 0 L16\nGPU 48\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert0_l16_dp1 [label=select style=dashed]
				expert1_l16_dp1 [label="Expert 1 L16\nGPU 49\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert1_l16_dp1 [label=select style=dashed]
				expert2_l16_dp1 [label="Expert 2 L16\nGPU 50\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert2_l16_dp1 [label=select style=dashed]
				expert3_l16_dp1 [label="Expert 3 L16\nGPU 51\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert3_l16_dp1 [label=select style=dashed]
				expert4_l16_dp1 [label="Expert 4 L16\nGPU 52\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert4_l16_dp1 [label=select style=dashed]
				expert5_l16_dp1 [label="Expert 5 L16\nGPU 53\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert5_l16_dp1 [label=select style=dashed]
				expert6_l16_dp1 [label="Expert 6 L16\nGPU 54\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert6_l16_dp1 [label=select style=dashed]
				expert7_l16_dp1 [label="Expert 7 L16\nGPU 55\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert7_l16_dp1 [label=select style=dashed]
				expert8_l16_dp1 [label="Expert 8 L16\nGPU 56\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert8_l16_dp1 [label=select style=dashed]
				expert9_l16_dp1 [label="Expert 9 L16\nGPU 57\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert9_l16_dp1 [label=select style=dashed]
				expert10_l16_dp1 [label="Expert 10 L16\nGPU 58\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert10_l16_dp1 [label=select style=dashed]
				expert11_l16_dp1 [label="Expert 11 L16\nGPU 59\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert11_l16_dp1 [label=select style=dashed]
				expert12_l16_dp1 [label="Expert 12 L16\nGPU 60\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert12_l16_dp1 [label=select style=dashed]
				expert13_l16_dp1 [label="Expert 13 L16\nGPU 61\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert13_l16_dp1 [label=select style=dashed]
				expert14_l16_dp1 [label="Expert 14 L16\nGPU 62\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert14_l16_dp1 [label=select style=dashed]
				expert15_l16_dp1 [label="Expert 15 L16\nGPU 63\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp1 -> expert15_l16_dp1 [label=select style=dashed]
				expert_agg_l16_dp1 [label="Expert Aggregation L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l16_dp1 -> expert_agg_l16_dp1
				expert1_l16_dp1 -> expert_agg_l16_dp1
				expert2_l16_dp1 -> expert_agg_l16_dp1
				expert3_l16_dp1 -> expert_agg_l16_dp1
				expert4_l16_dp1 -> expert_agg_l16_dp1
				expert5_l16_dp1 -> expert_agg_l16_dp1
				expert6_l16_dp1 -> expert_agg_l16_dp1
				expert7_l16_dp1 -> expert_agg_l16_dp1
				expert8_l16_dp1 -> expert_agg_l16_dp1
				expert9_l16_dp1 -> expert_agg_l16_dp1
				expert10_l16_dp1 -> expert_agg_l16_dp1
				expert11_l16_dp1 -> expert_agg_l16_dp1
				expert12_l16_dp1 -> expert_agg_l16_dp1
				expert13_l16_dp1 -> expert_agg_l16_dp1
				expert14_l16_dp1 -> expert_agg_l16_dp1
				expert15_l16_dp1 -> expert_agg_l16_dp1
				layer16_output_dp1 [label="Layer 16 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l16_dp1 -> layer16_output_dp1
			}
			stage2_output_dp1 [label="Stage 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer16_output_dp1 -> stage2_output_dp1
		}
	}
	subgraph dp_2 {
		fillcolor=lightgray label="DP Replica 2" rank=same style="rounded,filled"
		subgraph stage1_dp2 {
			fillcolor=lightcyan label="PP Stage 1 (Layers 1-8)" style="rounded,filled"
			stage1_input_dp2 [label="Stage1 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage1_input_dp2 -> attn_input_l1_dp2
			subgraph layer1_dp2_stage1 {
				label="Layer 1" style=rounded
				attn_input_l1_dp2 [label="Attention Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp2 [label="Attention TP0 L1\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp2 -> attn_tp0_l1_dp2
				attn_tp1_l1_dp2 [label="Attention TP1 L1\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp2 -> attn_tp1_l1_dp2
				attn_tp2_l1_dp2 [label="Attention TP2 L1\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp2 -> attn_tp2_l1_dp2
				attn_tp3_l1_dp2 [label="Attention TP3 L1\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp2 -> attn_tp3_l1_dp2
				allreduce_l1_dp2 [label="AllReduce L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp2 -> allreduce_l1_dp2
				attn_tp1_l1_dp2 -> allreduce_l1_dp2
				attn_tp2_l1_dp2 -> allreduce_l1_dp2
				attn_tp3_l1_dp2 -> allreduce_l1_dp2
				moe_input_l1_dp2 [label="MoE Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l1_dp2 [label="Router L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l1_dp2 -> moe_input_l1_dp2
				moe_input_l1_dp2 -> router_l1_dp2
				expert0_l1_dp2 [label="Expert 0 L1\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert0_l1_dp2 [label=select style=dashed]
				expert1_l1_dp2 [label="Expert 1 L1\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert1_l1_dp2 [label=select style=dashed]
				expert2_l1_dp2 [label="Expert 2 L1\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert2_l1_dp2 [label=select style=dashed]
				expert3_l1_dp2 [label="Expert 3 L1\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert3_l1_dp2 [label=select style=dashed]
				expert4_l1_dp2 [label="Expert 4 L1\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert4_l1_dp2 [label=select style=dashed]
				expert5_l1_dp2 [label="Expert 5 L1\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert5_l1_dp2 [label=select style=dashed]
				expert6_l1_dp2 [label="Expert 6 L1\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert6_l1_dp2 [label=select style=dashed]
				expert7_l1_dp2 [label="Expert 7 L1\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert7_l1_dp2 [label=select style=dashed]
				expert8_l1_dp2 [label="Expert 8 L1\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert8_l1_dp2 [label=select style=dashed]
				expert9_l1_dp2 [label="Expert 9 L1\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert9_l1_dp2 [label=select style=dashed]
				expert10_l1_dp2 [label="Expert 10 L1\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert10_l1_dp2 [label=select style=dashed]
				expert11_l1_dp2 [label="Expert 11 L1\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert11_l1_dp2 [label=select style=dashed]
				expert12_l1_dp2 [label="Expert 12 L1\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert12_l1_dp2 [label=select style=dashed]
				expert13_l1_dp2 [label="Expert 13 L1\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert13_l1_dp2 [label=select style=dashed]
				expert14_l1_dp2 [label="Expert 14 L1\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert14_l1_dp2 [label=select style=dashed]
				expert15_l1_dp2 [label="Expert 15 L1\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp2 -> expert15_l1_dp2 [label=select style=dashed]
				expert_agg_l1_dp2 [label="Expert Aggregation L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l1_dp2 -> expert_agg_l1_dp2
				expert1_l1_dp2 -> expert_agg_l1_dp2
				expert2_l1_dp2 -> expert_agg_l1_dp2
				expert3_l1_dp2 -> expert_agg_l1_dp2
				expert4_l1_dp2 -> expert_agg_l1_dp2
				expert5_l1_dp2 -> expert_agg_l1_dp2
				expert6_l1_dp2 -> expert_agg_l1_dp2
				expert7_l1_dp2 -> expert_agg_l1_dp2
				expert8_l1_dp2 -> expert_agg_l1_dp2
				expert9_l1_dp2 -> expert_agg_l1_dp2
				expert10_l1_dp2 -> expert_agg_l1_dp2
				expert11_l1_dp2 -> expert_agg_l1_dp2
				expert12_l1_dp2 -> expert_agg_l1_dp2
				expert13_l1_dp2 -> expert_agg_l1_dp2
				expert14_l1_dp2 -> expert_agg_l1_dp2
				expert15_l1_dp2 -> expert_agg_l1_dp2
				layer1_output_dp2 [label="Layer 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l1_dp2 -> layer1_output_dp2
			}
			layer1_output_dp2 -> attn_input_l2_dp2
			subgraph layer2_dp2_stage1 {
				label="Layer 2" style=rounded
				attn_input_l2_dp2 [label="Attention Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp2 [label="Attention TP0 L2\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp2 -> attn_tp0_l2_dp2
				attn_tp1_l2_dp2 [label="Attention TP1 L2\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp2 -> attn_tp1_l2_dp2
				attn_tp2_l2_dp2 [label="Attention TP2 L2\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp2 -> attn_tp2_l2_dp2
				attn_tp3_l2_dp2 [label="Attention TP3 L2\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp2 -> attn_tp3_l2_dp2
				allreduce_l2_dp2 [label="AllReduce L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp2 -> allreduce_l2_dp2
				attn_tp1_l2_dp2 -> allreduce_l2_dp2
				attn_tp2_l2_dp2 -> allreduce_l2_dp2
				attn_tp3_l2_dp2 -> allreduce_l2_dp2
				moe_input_l2_dp2 [label="MoE Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l2_dp2 [label="Router L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l2_dp2 -> moe_input_l2_dp2
				moe_input_l2_dp2 -> router_l2_dp2
				expert0_l2_dp2 [label="Expert 0 L2\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert0_l2_dp2 [label=select style=dashed]
				expert1_l2_dp2 [label="Expert 1 L2\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert1_l2_dp2 [label=select style=dashed]
				expert2_l2_dp2 [label="Expert 2 L2\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert2_l2_dp2 [label=select style=dashed]
				expert3_l2_dp2 [label="Expert 3 L2\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert3_l2_dp2 [label=select style=dashed]
				expert4_l2_dp2 [label="Expert 4 L2\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert4_l2_dp2 [label=select style=dashed]
				expert5_l2_dp2 [label="Expert 5 L2\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert5_l2_dp2 [label=select style=dashed]
				expert6_l2_dp2 [label="Expert 6 L2\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert6_l2_dp2 [label=select style=dashed]
				expert7_l2_dp2 [label="Expert 7 L2\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert7_l2_dp2 [label=select style=dashed]
				expert8_l2_dp2 [label="Expert 8 L2\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert8_l2_dp2 [label=select style=dashed]
				expert9_l2_dp2 [label="Expert 9 L2\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert9_l2_dp2 [label=select style=dashed]
				expert10_l2_dp2 [label="Expert 10 L2\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert10_l2_dp2 [label=select style=dashed]
				expert11_l2_dp2 [label="Expert 11 L2\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert11_l2_dp2 [label=select style=dashed]
				expert12_l2_dp2 [label="Expert 12 L2\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert12_l2_dp2 [label=select style=dashed]
				expert13_l2_dp2 [label="Expert 13 L2\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert13_l2_dp2 [label=select style=dashed]
				expert14_l2_dp2 [label="Expert 14 L2\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert14_l2_dp2 [label=select style=dashed]
				expert15_l2_dp2 [label="Expert 15 L2\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp2 -> expert15_l2_dp2 [label=select style=dashed]
				expert_agg_l2_dp2 [label="Expert Aggregation L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l2_dp2 -> expert_agg_l2_dp2
				expert1_l2_dp2 -> expert_agg_l2_dp2
				expert2_l2_dp2 -> expert_agg_l2_dp2
				expert3_l2_dp2 -> expert_agg_l2_dp2
				expert4_l2_dp2 -> expert_agg_l2_dp2
				expert5_l2_dp2 -> expert_agg_l2_dp2
				expert6_l2_dp2 -> expert_agg_l2_dp2
				expert7_l2_dp2 -> expert_agg_l2_dp2
				expert8_l2_dp2 -> expert_agg_l2_dp2
				expert9_l2_dp2 -> expert_agg_l2_dp2
				expert10_l2_dp2 -> expert_agg_l2_dp2
				expert11_l2_dp2 -> expert_agg_l2_dp2
				expert12_l2_dp2 -> expert_agg_l2_dp2
				expert13_l2_dp2 -> expert_agg_l2_dp2
				expert14_l2_dp2 -> expert_agg_l2_dp2
				expert15_l2_dp2 -> expert_agg_l2_dp2
				layer2_output_dp2 [label="Layer 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l2_dp2 -> layer2_output_dp2
			}
			layer2_output_dp2 -> attn_input_l3_dp2
			subgraph layer3_dp2_stage1 {
				label="Layer 3" style=rounded
				attn_input_l3_dp2 [label="Attention Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp2 [label="Attention TP0 L3\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp2 -> attn_tp0_l3_dp2
				attn_tp1_l3_dp2 [label="Attention TP1 L3\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp2 -> attn_tp1_l3_dp2
				attn_tp2_l3_dp2 [label="Attention TP2 L3\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp2 -> attn_tp2_l3_dp2
				attn_tp3_l3_dp2 [label="Attention TP3 L3\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp2 -> attn_tp3_l3_dp2
				allreduce_l3_dp2 [label="AllReduce L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp2 -> allreduce_l3_dp2
				attn_tp1_l3_dp2 -> allreduce_l3_dp2
				attn_tp2_l3_dp2 -> allreduce_l3_dp2
				attn_tp3_l3_dp2 -> allreduce_l3_dp2
				moe_input_l3_dp2 [label="MoE Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l3_dp2 [label="Router L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l3_dp2 -> moe_input_l3_dp2
				moe_input_l3_dp2 -> router_l3_dp2
				expert0_l3_dp2 [label="Expert 0 L3\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert0_l3_dp2 [label=select style=dashed]
				expert1_l3_dp2 [label="Expert 1 L3\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert1_l3_dp2 [label=select style=dashed]
				expert2_l3_dp2 [label="Expert 2 L3\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert2_l3_dp2 [label=select style=dashed]
				expert3_l3_dp2 [label="Expert 3 L3\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert3_l3_dp2 [label=select style=dashed]
				expert4_l3_dp2 [label="Expert 4 L3\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert4_l3_dp2 [label=select style=dashed]
				expert5_l3_dp2 [label="Expert 5 L3\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert5_l3_dp2 [label=select style=dashed]
				expert6_l3_dp2 [label="Expert 6 L3\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert6_l3_dp2 [label=select style=dashed]
				expert7_l3_dp2 [label="Expert 7 L3\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert7_l3_dp2 [label=select style=dashed]
				expert8_l3_dp2 [label="Expert 8 L3\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert8_l3_dp2 [label=select style=dashed]
				expert9_l3_dp2 [label="Expert 9 L3\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert9_l3_dp2 [label=select style=dashed]
				expert10_l3_dp2 [label="Expert 10 L3\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert10_l3_dp2 [label=select style=dashed]
				expert11_l3_dp2 [label="Expert 11 L3\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert11_l3_dp2 [label=select style=dashed]
				expert12_l3_dp2 [label="Expert 12 L3\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert12_l3_dp2 [label=select style=dashed]
				expert13_l3_dp2 [label="Expert 13 L3\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert13_l3_dp2 [label=select style=dashed]
				expert14_l3_dp2 [label="Expert 14 L3\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert14_l3_dp2 [label=select style=dashed]
				expert15_l3_dp2 [label="Expert 15 L3\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp2 -> expert15_l3_dp2 [label=select style=dashed]
				expert_agg_l3_dp2 [label="Expert Aggregation L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l3_dp2 -> expert_agg_l3_dp2
				expert1_l3_dp2 -> expert_agg_l3_dp2
				expert2_l3_dp2 -> expert_agg_l3_dp2
				expert3_l3_dp2 -> expert_agg_l3_dp2
				expert4_l3_dp2 -> expert_agg_l3_dp2
				expert5_l3_dp2 -> expert_agg_l3_dp2
				expert6_l3_dp2 -> expert_agg_l3_dp2
				expert7_l3_dp2 -> expert_agg_l3_dp2
				expert8_l3_dp2 -> expert_agg_l3_dp2
				expert9_l3_dp2 -> expert_agg_l3_dp2
				expert10_l3_dp2 -> expert_agg_l3_dp2
				expert11_l3_dp2 -> expert_agg_l3_dp2
				expert12_l3_dp2 -> expert_agg_l3_dp2
				expert13_l3_dp2 -> expert_agg_l3_dp2
				expert14_l3_dp2 -> expert_agg_l3_dp2
				expert15_l3_dp2 -> expert_agg_l3_dp2
				layer3_output_dp2 [label="Layer 3 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l3_dp2 -> layer3_output_dp2
			}
			layer3_output_dp2 -> attn_input_l4_dp2
			subgraph layer4_dp2_stage1 {
				label="Layer 4" style=rounded
				attn_input_l4_dp2 [label="Attention Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp2 [label="Attention TP0 L4\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp2 -> attn_tp0_l4_dp2
				attn_tp1_l4_dp2 [label="Attention TP1 L4\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp2 -> attn_tp1_l4_dp2
				attn_tp2_l4_dp2 [label="Attention TP2 L4\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp2 -> attn_tp2_l4_dp2
				attn_tp3_l4_dp2 [label="Attention TP3 L4\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp2 -> attn_tp3_l4_dp2
				allreduce_l4_dp2 [label="AllReduce L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp2 -> allreduce_l4_dp2
				attn_tp1_l4_dp2 -> allreduce_l4_dp2
				attn_tp2_l4_dp2 -> allreduce_l4_dp2
				attn_tp3_l4_dp2 -> allreduce_l4_dp2
				moe_input_l4_dp2 [label="MoE Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l4_dp2 [label="Router L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l4_dp2 -> moe_input_l4_dp2
				moe_input_l4_dp2 -> router_l4_dp2
				expert0_l4_dp2 [label="Expert 0 L4\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert0_l4_dp2 [label=select style=dashed]
				expert1_l4_dp2 [label="Expert 1 L4\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert1_l4_dp2 [label=select style=dashed]
				expert2_l4_dp2 [label="Expert 2 L4\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert2_l4_dp2 [label=select style=dashed]
				expert3_l4_dp2 [label="Expert 3 L4\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert3_l4_dp2 [label=select style=dashed]
				expert4_l4_dp2 [label="Expert 4 L4\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert4_l4_dp2 [label=select style=dashed]
				expert5_l4_dp2 [label="Expert 5 L4\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert5_l4_dp2 [label=select style=dashed]
				expert6_l4_dp2 [label="Expert 6 L4\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert6_l4_dp2 [label=select style=dashed]
				expert7_l4_dp2 [label="Expert 7 L4\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert7_l4_dp2 [label=select style=dashed]
				expert8_l4_dp2 [label="Expert 8 L4\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert8_l4_dp2 [label=select style=dashed]
				expert9_l4_dp2 [label="Expert 9 L4\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert9_l4_dp2 [label=select style=dashed]
				expert10_l4_dp2 [label="Expert 10 L4\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert10_l4_dp2 [label=select style=dashed]
				expert11_l4_dp2 [label="Expert 11 L4\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert11_l4_dp2 [label=select style=dashed]
				expert12_l4_dp2 [label="Expert 12 L4\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert12_l4_dp2 [label=select style=dashed]
				expert13_l4_dp2 [label="Expert 13 L4\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert13_l4_dp2 [label=select style=dashed]
				expert14_l4_dp2 [label="Expert 14 L4\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert14_l4_dp2 [label=select style=dashed]
				expert15_l4_dp2 [label="Expert 15 L4\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp2 -> expert15_l4_dp2 [label=select style=dashed]
				expert_agg_l4_dp2 [label="Expert Aggregation L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l4_dp2 -> expert_agg_l4_dp2
				expert1_l4_dp2 -> expert_agg_l4_dp2
				expert2_l4_dp2 -> expert_agg_l4_dp2
				expert3_l4_dp2 -> expert_agg_l4_dp2
				expert4_l4_dp2 -> expert_agg_l4_dp2
				expert5_l4_dp2 -> expert_agg_l4_dp2
				expert6_l4_dp2 -> expert_agg_l4_dp2
				expert7_l4_dp2 -> expert_agg_l4_dp2
				expert8_l4_dp2 -> expert_agg_l4_dp2
				expert9_l4_dp2 -> expert_agg_l4_dp2
				expert10_l4_dp2 -> expert_agg_l4_dp2
				expert11_l4_dp2 -> expert_agg_l4_dp2
				expert12_l4_dp2 -> expert_agg_l4_dp2
				expert13_l4_dp2 -> expert_agg_l4_dp2
				expert14_l4_dp2 -> expert_agg_l4_dp2
				expert15_l4_dp2 -> expert_agg_l4_dp2
				layer4_output_dp2 [label="Layer 4 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l4_dp2 -> layer4_output_dp2
			}
			layer4_output_dp2 -> attn_input_l5_dp2
			subgraph layer5_dp2_stage1 {
				label="Layer 5" style=rounded
				attn_input_l5_dp2 [label="Attention Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp2 [label="Attention TP0 L5\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp2 -> attn_tp0_l5_dp2
				attn_tp1_l5_dp2 [label="Attention TP1 L5\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp2 -> attn_tp1_l5_dp2
				attn_tp2_l5_dp2 [label="Attention TP2 L5\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp2 -> attn_tp2_l5_dp2
				attn_tp3_l5_dp2 [label="Attention TP3 L5\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp2 -> attn_tp3_l5_dp2
				allreduce_l5_dp2 [label="AllReduce L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp2 -> allreduce_l5_dp2
				attn_tp1_l5_dp2 -> allreduce_l5_dp2
				attn_tp2_l5_dp2 -> allreduce_l5_dp2
				attn_tp3_l5_dp2 -> allreduce_l5_dp2
				moe_input_l5_dp2 [label="MoE Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l5_dp2 [label="Router L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l5_dp2 -> moe_input_l5_dp2
				moe_input_l5_dp2 -> router_l5_dp2
				expert0_l5_dp2 [label="Expert 0 L5\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert0_l5_dp2 [label=select style=dashed]
				expert1_l5_dp2 [label="Expert 1 L5\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert1_l5_dp2 [label=select style=dashed]
				expert2_l5_dp2 [label="Expert 2 L5\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert2_l5_dp2 [label=select style=dashed]
				expert3_l5_dp2 [label="Expert 3 L5\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert3_l5_dp2 [label=select style=dashed]
				expert4_l5_dp2 [label="Expert 4 L5\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert4_l5_dp2 [label=select style=dashed]
				expert5_l5_dp2 [label="Expert 5 L5\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert5_l5_dp2 [label=select style=dashed]
				expert6_l5_dp2 [label="Expert 6 L5\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert6_l5_dp2 [label=select style=dashed]
				expert7_l5_dp2 [label="Expert 7 L5\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert7_l5_dp2 [label=select style=dashed]
				expert8_l5_dp2 [label="Expert 8 L5\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert8_l5_dp2 [label=select style=dashed]
				expert9_l5_dp2 [label="Expert 9 L5\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert9_l5_dp2 [label=select style=dashed]
				expert10_l5_dp2 [label="Expert 10 L5\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert10_l5_dp2 [label=select style=dashed]
				expert11_l5_dp2 [label="Expert 11 L5\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert11_l5_dp2 [label=select style=dashed]
				expert12_l5_dp2 [label="Expert 12 L5\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert12_l5_dp2 [label=select style=dashed]
				expert13_l5_dp2 [label="Expert 13 L5\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert13_l5_dp2 [label=select style=dashed]
				expert14_l5_dp2 [label="Expert 14 L5\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert14_l5_dp2 [label=select style=dashed]
				expert15_l5_dp2 [label="Expert 15 L5\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp2 -> expert15_l5_dp2 [label=select style=dashed]
				expert_agg_l5_dp2 [label="Expert Aggregation L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l5_dp2 -> expert_agg_l5_dp2
				expert1_l5_dp2 -> expert_agg_l5_dp2
				expert2_l5_dp2 -> expert_agg_l5_dp2
				expert3_l5_dp2 -> expert_agg_l5_dp2
				expert4_l5_dp2 -> expert_agg_l5_dp2
				expert5_l5_dp2 -> expert_agg_l5_dp2
				expert6_l5_dp2 -> expert_agg_l5_dp2
				expert7_l5_dp2 -> expert_agg_l5_dp2
				expert8_l5_dp2 -> expert_agg_l5_dp2
				expert9_l5_dp2 -> expert_agg_l5_dp2
				expert10_l5_dp2 -> expert_agg_l5_dp2
				expert11_l5_dp2 -> expert_agg_l5_dp2
				expert12_l5_dp2 -> expert_agg_l5_dp2
				expert13_l5_dp2 -> expert_agg_l5_dp2
				expert14_l5_dp2 -> expert_agg_l5_dp2
				expert15_l5_dp2 -> expert_agg_l5_dp2
				layer5_output_dp2 [label="Layer 5 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l5_dp2 -> layer5_output_dp2
			}
			layer5_output_dp2 -> attn_input_l6_dp2
			subgraph layer6_dp2_stage1 {
				label="Layer 6" style=rounded
				attn_input_l6_dp2 [label="Attention Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp2 [label="Attention TP0 L6\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp2 -> attn_tp0_l6_dp2
				attn_tp1_l6_dp2 [label="Attention TP1 L6\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp2 -> attn_tp1_l6_dp2
				attn_tp2_l6_dp2 [label="Attention TP2 L6\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp2 -> attn_tp2_l6_dp2
				attn_tp3_l6_dp2 [label="Attention TP3 L6\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp2 -> attn_tp3_l6_dp2
				allreduce_l6_dp2 [label="AllReduce L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp2 -> allreduce_l6_dp2
				attn_tp1_l6_dp2 -> allreduce_l6_dp2
				attn_tp2_l6_dp2 -> allreduce_l6_dp2
				attn_tp3_l6_dp2 -> allreduce_l6_dp2
				moe_input_l6_dp2 [label="MoE Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l6_dp2 [label="Router L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l6_dp2 -> moe_input_l6_dp2
				moe_input_l6_dp2 -> router_l6_dp2
				expert0_l6_dp2 [label="Expert 0 L6\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert0_l6_dp2 [label=select style=dashed]
				expert1_l6_dp2 [label="Expert 1 L6\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert1_l6_dp2 [label=select style=dashed]
				expert2_l6_dp2 [label="Expert 2 L6\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert2_l6_dp2 [label=select style=dashed]
				expert3_l6_dp2 [label="Expert 3 L6\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert3_l6_dp2 [label=select style=dashed]
				expert4_l6_dp2 [label="Expert 4 L6\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert4_l6_dp2 [label=select style=dashed]
				expert5_l6_dp2 [label="Expert 5 L6\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert5_l6_dp2 [label=select style=dashed]
				expert6_l6_dp2 [label="Expert 6 L6\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert6_l6_dp2 [label=select style=dashed]
				expert7_l6_dp2 [label="Expert 7 L6\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert7_l6_dp2 [label=select style=dashed]
				expert8_l6_dp2 [label="Expert 8 L6\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert8_l6_dp2 [label=select style=dashed]
				expert9_l6_dp2 [label="Expert 9 L6\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert9_l6_dp2 [label=select style=dashed]
				expert10_l6_dp2 [label="Expert 10 L6\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert10_l6_dp2 [label=select style=dashed]
				expert11_l6_dp2 [label="Expert 11 L6\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert11_l6_dp2 [label=select style=dashed]
				expert12_l6_dp2 [label="Expert 12 L6\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert12_l6_dp2 [label=select style=dashed]
				expert13_l6_dp2 [label="Expert 13 L6\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert13_l6_dp2 [label=select style=dashed]
				expert14_l6_dp2 [label="Expert 14 L6\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert14_l6_dp2 [label=select style=dashed]
				expert15_l6_dp2 [label="Expert 15 L6\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp2 -> expert15_l6_dp2 [label=select style=dashed]
				expert_agg_l6_dp2 [label="Expert Aggregation L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l6_dp2 -> expert_agg_l6_dp2
				expert1_l6_dp2 -> expert_agg_l6_dp2
				expert2_l6_dp2 -> expert_agg_l6_dp2
				expert3_l6_dp2 -> expert_agg_l6_dp2
				expert4_l6_dp2 -> expert_agg_l6_dp2
				expert5_l6_dp2 -> expert_agg_l6_dp2
				expert6_l6_dp2 -> expert_agg_l6_dp2
				expert7_l6_dp2 -> expert_agg_l6_dp2
				expert8_l6_dp2 -> expert_agg_l6_dp2
				expert9_l6_dp2 -> expert_agg_l6_dp2
				expert10_l6_dp2 -> expert_agg_l6_dp2
				expert11_l6_dp2 -> expert_agg_l6_dp2
				expert12_l6_dp2 -> expert_agg_l6_dp2
				expert13_l6_dp2 -> expert_agg_l6_dp2
				expert14_l6_dp2 -> expert_agg_l6_dp2
				expert15_l6_dp2 -> expert_agg_l6_dp2
				layer6_output_dp2 [label="Layer 6 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l6_dp2 -> layer6_output_dp2
			}
			layer6_output_dp2 -> attn_input_l7_dp2
			subgraph layer7_dp2_stage1 {
				label="Layer 7" style=rounded
				attn_input_l7_dp2 [label="Attention Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp2 [label="Attention TP0 L7\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp2 -> attn_tp0_l7_dp2
				attn_tp1_l7_dp2 [label="Attention TP1 L7\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp2 -> attn_tp1_l7_dp2
				attn_tp2_l7_dp2 [label="Attention TP2 L7\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp2 -> attn_tp2_l7_dp2
				attn_tp3_l7_dp2 [label="Attention TP3 L7\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp2 -> attn_tp3_l7_dp2
				allreduce_l7_dp2 [label="AllReduce L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp2 -> allreduce_l7_dp2
				attn_tp1_l7_dp2 -> allreduce_l7_dp2
				attn_tp2_l7_dp2 -> allreduce_l7_dp2
				attn_tp3_l7_dp2 -> allreduce_l7_dp2
				moe_input_l7_dp2 [label="MoE Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l7_dp2 [label="Router L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l7_dp2 -> moe_input_l7_dp2
				moe_input_l7_dp2 -> router_l7_dp2
				expert0_l7_dp2 [label="Expert 0 L7\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert0_l7_dp2 [label=select style=dashed]
				expert1_l7_dp2 [label="Expert 1 L7\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert1_l7_dp2 [label=select style=dashed]
				expert2_l7_dp2 [label="Expert 2 L7\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert2_l7_dp2 [label=select style=dashed]
				expert3_l7_dp2 [label="Expert 3 L7\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert3_l7_dp2 [label=select style=dashed]
				expert4_l7_dp2 [label="Expert 4 L7\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert4_l7_dp2 [label=select style=dashed]
				expert5_l7_dp2 [label="Expert 5 L7\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert5_l7_dp2 [label=select style=dashed]
				expert6_l7_dp2 [label="Expert 6 L7\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert6_l7_dp2 [label=select style=dashed]
				expert7_l7_dp2 [label="Expert 7 L7\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert7_l7_dp2 [label=select style=dashed]
				expert8_l7_dp2 [label="Expert 8 L7\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert8_l7_dp2 [label=select style=dashed]
				expert9_l7_dp2 [label="Expert 9 L7\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert9_l7_dp2 [label=select style=dashed]
				expert10_l7_dp2 [label="Expert 10 L7\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert10_l7_dp2 [label=select style=dashed]
				expert11_l7_dp2 [label="Expert 11 L7\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert11_l7_dp2 [label=select style=dashed]
				expert12_l7_dp2 [label="Expert 12 L7\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert12_l7_dp2 [label=select style=dashed]
				expert13_l7_dp2 [label="Expert 13 L7\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert13_l7_dp2 [label=select style=dashed]
				expert14_l7_dp2 [label="Expert 14 L7\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert14_l7_dp2 [label=select style=dashed]
				expert15_l7_dp2 [label="Expert 15 L7\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp2 -> expert15_l7_dp2 [label=select style=dashed]
				expert_agg_l7_dp2 [label="Expert Aggregation L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l7_dp2 -> expert_agg_l7_dp2
				expert1_l7_dp2 -> expert_agg_l7_dp2
				expert2_l7_dp2 -> expert_agg_l7_dp2
				expert3_l7_dp2 -> expert_agg_l7_dp2
				expert4_l7_dp2 -> expert_agg_l7_dp2
				expert5_l7_dp2 -> expert_agg_l7_dp2
				expert6_l7_dp2 -> expert_agg_l7_dp2
				expert7_l7_dp2 -> expert_agg_l7_dp2
				expert8_l7_dp2 -> expert_agg_l7_dp2
				expert9_l7_dp2 -> expert_agg_l7_dp2
				expert10_l7_dp2 -> expert_agg_l7_dp2
				expert11_l7_dp2 -> expert_agg_l7_dp2
				expert12_l7_dp2 -> expert_agg_l7_dp2
				expert13_l7_dp2 -> expert_agg_l7_dp2
				expert14_l7_dp2 -> expert_agg_l7_dp2
				expert15_l7_dp2 -> expert_agg_l7_dp2
				layer7_output_dp2 [label="Layer 7 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l7_dp2 -> layer7_output_dp2
			}
			layer7_output_dp2 -> attn_input_l8_dp2
			subgraph layer8_dp2_stage1 {
				label="Layer 8" style=rounded
				attn_input_l8_dp2 [label="Attention Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp2 [label="Attention TP0 L8\nGPU 64\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp2 -> attn_tp0_l8_dp2
				attn_tp1_l8_dp2 [label="Attention TP1 L8\nGPU 65\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp2 -> attn_tp1_l8_dp2
				attn_tp2_l8_dp2 [label="Attention TP2 L8\nGPU 66\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp2 -> attn_tp2_l8_dp2
				attn_tp3_l8_dp2 [label="Attention TP3 L8\nGPU 67\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp2 -> attn_tp3_l8_dp2
				allreduce_l8_dp2 [label="AllReduce L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp2 -> allreduce_l8_dp2
				attn_tp1_l8_dp2 -> allreduce_l8_dp2
				attn_tp2_l8_dp2 -> allreduce_l8_dp2
				attn_tp3_l8_dp2 -> allreduce_l8_dp2
				moe_input_l8_dp2 [label="MoE Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l8_dp2 [label="Router L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l8_dp2 -> moe_input_l8_dp2
				moe_input_l8_dp2 -> router_l8_dp2
				expert0_l8_dp2 [label="Expert 0 L8\nGPU 64\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert0_l8_dp2 [label=select style=dashed]
				expert1_l8_dp2 [label="Expert 1 L8\nGPU 65\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert1_l8_dp2 [label=select style=dashed]
				expert2_l8_dp2 [label="Expert 2 L8\nGPU 66\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert2_l8_dp2 [label=select style=dashed]
				expert3_l8_dp2 [label="Expert 3 L8\nGPU 67\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert3_l8_dp2 [label=select style=dashed]
				expert4_l8_dp2 [label="Expert 4 L8\nGPU 68\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert4_l8_dp2 [label=select style=dashed]
				expert5_l8_dp2 [label="Expert 5 L8\nGPU 69\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert5_l8_dp2 [label=select style=dashed]
				expert6_l8_dp2 [label="Expert 6 L8\nGPU 70\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert6_l8_dp2 [label=select style=dashed]
				expert7_l8_dp2 [label="Expert 7 L8\nGPU 71\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert7_l8_dp2 [label=select style=dashed]
				expert8_l8_dp2 [label="Expert 8 L8\nGPU 72\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert8_l8_dp2 [label=select style=dashed]
				expert9_l8_dp2 [label="Expert 9 L8\nGPU 73\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert9_l8_dp2 [label=select style=dashed]
				expert10_l8_dp2 [label="Expert 10 L8\nGPU 74\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert10_l8_dp2 [label=select style=dashed]
				expert11_l8_dp2 [label="Expert 11 L8\nGPU 75\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert11_l8_dp2 [label=select style=dashed]
				expert12_l8_dp2 [label="Expert 12 L8\nGPU 76\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert12_l8_dp2 [label=select style=dashed]
				expert13_l8_dp2 [label="Expert 13 L8\nGPU 77\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert13_l8_dp2 [label=select style=dashed]
				expert14_l8_dp2 [label="Expert 14 L8\nGPU 78\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert14_l8_dp2 [label=select style=dashed]
				expert15_l8_dp2 [label="Expert 15 L8\nGPU 79\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp2 -> expert15_l8_dp2 [label=select style=dashed]
				expert_agg_l8_dp2 [label="Expert Aggregation L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l8_dp2 -> expert_agg_l8_dp2
				expert1_l8_dp2 -> expert_agg_l8_dp2
				expert2_l8_dp2 -> expert_agg_l8_dp2
				expert3_l8_dp2 -> expert_agg_l8_dp2
				expert4_l8_dp2 -> expert_agg_l8_dp2
				expert5_l8_dp2 -> expert_agg_l8_dp2
				expert6_l8_dp2 -> expert_agg_l8_dp2
				expert7_l8_dp2 -> expert_agg_l8_dp2
				expert8_l8_dp2 -> expert_agg_l8_dp2
				expert9_l8_dp2 -> expert_agg_l8_dp2
				expert10_l8_dp2 -> expert_agg_l8_dp2
				expert11_l8_dp2 -> expert_agg_l8_dp2
				expert12_l8_dp2 -> expert_agg_l8_dp2
				expert13_l8_dp2 -> expert_agg_l8_dp2
				expert14_l8_dp2 -> expert_agg_l8_dp2
				expert15_l8_dp2 -> expert_agg_l8_dp2
				layer8_output_dp2 [label="Layer 8 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l8_dp2 -> layer8_output_dp2
			}
			stage1_output_dp2 [label="Stage 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer8_output_dp2 -> stage1_output_dp2
		}
		stage1_output_dp2 -> stage2_input_dp2 [lhead=stage2_dp2]
		subgraph stage2_dp2 {
			fillcolor=lightcyan label="PP Stage 2 (Layers 9-16)" style="rounded,filled"
			stage2_input_dp2 [label="Stage 2 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage2_input_dp2 -> attn_input_l9_dp2
			subgraph layer9_dp2_stage2 {
				label="Layer 9" style=rounded
				attn_input_l9_dp2 [label="Attention Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp2 [label="Attention TP0 L9\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp2 -> attn_tp0_l9_dp2
				attn_tp1_l9_dp2 [label="Attention TP1 L9\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp2 -> attn_tp1_l9_dp2
				attn_tp2_l9_dp2 [label="Attention TP2 L9\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp2 -> attn_tp2_l9_dp2
				attn_tp3_l9_dp2 [label="Attention TP3 L9\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp2 -> attn_tp3_l9_dp2
				allreduce_l9_dp2 [label="AllReduce L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp2 -> allreduce_l9_dp2
				attn_tp1_l9_dp2 -> allreduce_l9_dp2
				attn_tp2_l9_dp2 -> allreduce_l9_dp2
				attn_tp3_l9_dp2 -> allreduce_l9_dp2
				moe_input_l9_dp2 [label="MoE Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l9_dp2 [label="Router L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l9_dp2 -> moe_input_l9_dp2
				moe_input_l9_dp2 -> router_l9_dp2
				expert0_l9_dp2 [label="Expert 0 L9\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert0_l9_dp2 [label=select style=dashed]
				expert1_l9_dp2 [label="Expert 1 L9\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert1_l9_dp2 [label=select style=dashed]
				expert2_l9_dp2 [label="Expert 2 L9\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert2_l9_dp2 [label=select style=dashed]
				expert3_l9_dp2 [label="Expert 3 L9\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert3_l9_dp2 [label=select style=dashed]
				expert4_l9_dp2 [label="Expert 4 L9\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert4_l9_dp2 [label=select style=dashed]
				expert5_l9_dp2 [label="Expert 5 L9\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert5_l9_dp2 [label=select style=dashed]
				expert6_l9_dp2 [label="Expert 6 L9\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert6_l9_dp2 [label=select style=dashed]
				expert7_l9_dp2 [label="Expert 7 L9\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert7_l9_dp2 [label=select style=dashed]
				expert8_l9_dp2 [label="Expert 8 L9\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert8_l9_dp2 [label=select style=dashed]
				expert9_l9_dp2 [label="Expert 9 L9\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert9_l9_dp2 [label=select style=dashed]
				expert10_l9_dp2 [label="Expert 10 L9\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert10_l9_dp2 [label=select style=dashed]
				expert11_l9_dp2 [label="Expert 11 L9\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert11_l9_dp2 [label=select style=dashed]
				expert12_l9_dp2 [label="Expert 12 L9\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert12_l9_dp2 [label=select style=dashed]
				expert13_l9_dp2 [label="Expert 13 L9\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert13_l9_dp2 [label=select style=dashed]
				expert14_l9_dp2 [label="Expert 14 L9\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert14_l9_dp2 [label=select style=dashed]
				expert15_l9_dp2 [label="Expert 15 L9\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp2 -> expert15_l9_dp2 [label=select style=dashed]
				expert_agg_l9_dp2 [label="Expert Aggregation L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l9_dp2 -> expert_agg_l9_dp2
				expert1_l9_dp2 -> expert_agg_l9_dp2
				expert2_l9_dp2 -> expert_agg_l9_dp2
				expert3_l9_dp2 -> expert_agg_l9_dp2
				expert4_l9_dp2 -> expert_agg_l9_dp2
				expert5_l9_dp2 -> expert_agg_l9_dp2
				expert6_l9_dp2 -> expert_agg_l9_dp2
				expert7_l9_dp2 -> expert_agg_l9_dp2
				expert8_l9_dp2 -> expert_agg_l9_dp2
				expert9_l9_dp2 -> expert_agg_l9_dp2
				expert10_l9_dp2 -> expert_agg_l9_dp2
				expert11_l9_dp2 -> expert_agg_l9_dp2
				expert12_l9_dp2 -> expert_agg_l9_dp2
				expert13_l9_dp2 -> expert_agg_l9_dp2
				expert14_l9_dp2 -> expert_agg_l9_dp2
				expert15_l9_dp2 -> expert_agg_l9_dp2
				layer9_output_dp2 [label="Layer 9 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l9_dp2 -> layer9_output_dp2
			}
			layer9_output_dp2 -> attn_input_l10_dp2
			subgraph layer10_dp2_stage2 {
				label="Layer 10" style=rounded
				attn_input_l10_dp2 [label="Attention Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp2 [label="Attention TP0 L10\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp2 -> attn_tp0_l10_dp2
				attn_tp1_l10_dp2 [label="Attention TP1 L10\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp2 -> attn_tp1_l10_dp2
				attn_tp2_l10_dp2 [label="Attention TP2 L10\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp2 -> attn_tp2_l10_dp2
				attn_tp3_l10_dp2 [label="Attention TP3 L10\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp2 -> attn_tp3_l10_dp2
				allreduce_l10_dp2 [label="AllReduce L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp2 -> allreduce_l10_dp2
				attn_tp1_l10_dp2 -> allreduce_l10_dp2
				attn_tp2_l10_dp2 -> allreduce_l10_dp2
				attn_tp3_l10_dp2 -> allreduce_l10_dp2
				moe_input_l10_dp2 [label="MoE Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l10_dp2 [label="Router L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l10_dp2 -> moe_input_l10_dp2
				moe_input_l10_dp2 -> router_l10_dp2
				expert0_l10_dp2 [label="Expert 0 L10\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert0_l10_dp2 [label=select style=dashed]
				expert1_l10_dp2 [label="Expert 1 L10\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert1_l10_dp2 [label=select style=dashed]
				expert2_l10_dp2 [label="Expert 2 L10\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert2_l10_dp2 [label=select style=dashed]
				expert3_l10_dp2 [label="Expert 3 L10\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert3_l10_dp2 [label=select style=dashed]
				expert4_l10_dp2 [label="Expert 4 L10\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert4_l10_dp2 [label=select style=dashed]
				expert5_l10_dp2 [label="Expert 5 L10\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert5_l10_dp2 [label=select style=dashed]
				expert6_l10_dp2 [label="Expert 6 L10\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert6_l10_dp2 [label=select style=dashed]
				expert7_l10_dp2 [label="Expert 7 L10\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert7_l10_dp2 [label=select style=dashed]
				expert8_l10_dp2 [label="Expert 8 L10\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert8_l10_dp2 [label=select style=dashed]
				expert9_l10_dp2 [label="Expert 9 L10\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert9_l10_dp2 [label=select style=dashed]
				expert10_l10_dp2 [label="Expert 10 L10\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert10_l10_dp2 [label=select style=dashed]
				expert11_l10_dp2 [label="Expert 11 L10\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert11_l10_dp2 [label=select style=dashed]
				expert12_l10_dp2 [label="Expert 12 L10\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert12_l10_dp2 [label=select style=dashed]
				expert13_l10_dp2 [label="Expert 13 L10\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert13_l10_dp2 [label=select style=dashed]
				expert14_l10_dp2 [label="Expert 14 L10\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert14_l10_dp2 [label=select style=dashed]
				expert15_l10_dp2 [label="Expert 15 L10\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp2 -> expert15_l10_dp2 [label=select style=dashed]
				expert_agg_l10_dp2 [label="Expert Aggregation L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l10_dp2 -> expert_agg_l10_dp2
				expert1_l10_dp2 -> expert_agg_l10_dp2
				expert2_l10_dp2 -> expert_agg_l10_dp2
				expert3_l10_dp2 -> expert_agg_l10_dp2
				expert4_l10_dp2 -> expert_agg_l10_dp2
				expert5_l10_dp2 -> expert_agg_l10_dp2
				expert6_l10_dp2 -> expert_agg_l10_dp2
				expert7_l10_dp2 -> expert_agg_l10_dp2
				expert8_l10_dp2 -> expert_agg_l10_dp2
				expert9_l10_dp2 -> expert_agg_l10_dp2
				expert10_l10_dp2 -> expert_agg_l10_dp2
				expert11_l10_dp2 -> expert_agg_l10_dp2
				expert12_l10_dp2 -> expert_agg_l10_dp2
				expert13_l10_dp2 -> expert_agg_l10_dp2
				expert14_l10_dp2 -> expert_agg_l10_dp2
				expert15_l10_dp2 -> expert_agg_l10_dp2
				layer10_output_dp2 [label="Layer 10 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l10_dp2 -> layer10_output_dp2
			}
			layer10_output_dp2 -> attn_input_l11_dp2
			subgraph layer11_dp2_stage2 {
				label="Layer 11" style=rounded
				attn_input_l11_dp2 [label="Attention Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp2 [label="Attention TP0 L11\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp2 -> attn_tp0_l11_dp2
				attn_tp1_l11_dp2 [label="Attention TP1 L11\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp2 -> attn_tp1_l11_dp2
				attn_tp2_l11_dp2 [label="Attention TP2 L11\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp2 -> attn_tp2_l11_dp2
				attn_tp3_l11_dp2 [label="Attention TP3 L11\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp2 -> attn_tp3_l11_dp2
				allreduce_l11_dp2 [label="AllReduce L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp2 -> allreduce_l11_dp2
				attn_tp1_l11_dp2 -> allreduce_l11_dp2
				attn_tp2_l11_dp2 -> allreduce_l11_dp2
				attn_tp3_l11_dp2 -> allreduce_l11_dp2
				moe_input_l11_dp2 [label="MoE Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l11_dp2 [label="Router L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l11_dp2 -> moe_input_l11_dp2
				moe_input_l11_dp2 -> router_l11_dp2
				expert0_l11_dp2 [label="Expert 0 L11\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert0_l11_dp2 [label=select style=dashed]
				expert1_l11_dp2 [label="Expert 1 L11\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert1_l11_dp2 [label=select style=dashed]
				expert2_l11_dp2 [label="Expert 2 L11\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert2_l11_dp2 [label=select style=dashed]
				expert3_l11_dp2 [label="Expert 3 L11\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert3_l11_dp2 [label=select style=dashed]
				expert4_l11_dp2 [label="Expert 4 L11\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert4_l11_dp2 [label=select style=dashed]
				expert5_l11_dp2 [label="Expert 5 L11\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert5_l11_dp2 [label=select style=dashed]
				expert6_l11_dp2 [label="Expert 6 L11\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert6_l11_dp2 [label=select style=dashed]
				expert7_l11_dp2 [label="Expert 7 L11\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert7_l11_dp2 [label=select style=dashed]
				expert8_l11_dp2 [label="Expert 8 L11\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert8_l11_dp2 [label=select style=dashed]
				expert9_l11_dp2 [label="Expert 9 L11\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert9_l11_dp2 [label=select style=dashed]
				expert10_l11_dp2 [label="Expert 10 L11\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert10_l11_dp2 [label=select style=dashed]
				expert11_l11_dp2 [label="Expert 11 L11\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert11_l11_dp2 [label=select style=dashed]
				expert12_l11_dp2 [label="Expert 12 L11\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert12_l11_dp2 [label=select style=dashed]
				expert13_l11_dp2 [label="Expert 13 L11\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert13_l11_dp2 [label=select style=dashed]
				expert14_l11_dp2 [label="Expert 14 L11\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert14_l11_dp2 [label=select style=dashed]
				expert15_l11_dp2 [label="Expert 15 L11\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp2 -> expert15_l11_dp2 [label=select style=dashed]
				expert_agg_l11_dp2 [label="Expert Aggregation L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l11_dp2 -> expert_agg_l11_dp2
				expert1_l11_dp2 -> expert_agg_l11_dp2
				expert2_l11_dp2 -> expert_agg_l11_dp2
				expert3_l11_dp2 -> expert_agg_l11_dp2
				expert4_l11_dp2 -> expert_agg_l11_dp2
				expert5_l11_dp2 -> expert_agg_l11_dp2
				expert6_l11_dp2 -> expert_agg_l11_dp2
				expert7_l11_dp2 -> expert_agg_l11_dp2
				expert8_l11_dp2 -> expert_agg_l11_dp2
				expert9_l11_dp2 -> expert_agg_l11_dp2
				expert10_l11_dp2 -> expert_agg_l11_dp2
				expert11_l11_dp2 -> expert_agg_l11_dp2
				expert12_l11_dp2 -> expert_agg_l11_dp2
				expert13_l11_dp2 -> expert_agg_l11_dp2
				expert14_l11_dp2 -> expert_agg_l11_dp2
				expert15_l11_dp2 -> expert_agg_l11_dp2
				layer11_output_dp2 [label="Layer 11 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l11_dp2 -> layer11_output_dp2
			}
			layer11_output_dp2 -> attn_input_l12_dp2
			subgraph layer12_dp2_stage2 {
				label="Layer 12" style=rounded
				attn_input_l12_dp2 [label="Attention Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp2 [label="Attention TP0 L12\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp2 -> attn_tp0_l12_dp2
				attn_tp1_l12_dp2 [label="Attention TP1 L12\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp2 -> attn_tp1_l12_dp2
				attn_tp2_l12_dp2 [label="Attention TP2 L12\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp2 -> attn_tp2_l12_dp2
				attn_tp3_l12_dp2 [label="Attention TP3 L12\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp2 -> attn_tp3_l12_dp2
				allreduce_l12_dp2 [label="AllReduce L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp2 -> allreduce_l12_dp2
				attn_tp1_l12_dp2 -> allreduce_l12_dp2
				attn_tp2_l12_dp2 -> allreduce_l12_dp2
				attn_tp3_l12_dp2 -> allreduce_l12_dp2
				moe_input_l12_dp2 [label="MoE Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l12_dp2 [label="Router L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l12_dp2 -> moe_input_l12_dp2
				moe_input_l12_dp2 -> router_l12_dp2
				expert0_l12_dp2 [label="Expert 0 L12\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert0_l12_dp2 [label=select style=dashed]
				expert1_l12_dp2 [label="Expert 1 L12\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert1_l12_dp2 [label=select style=dashed]
				expert2_l12_dp2 [label="Expert 2 L12\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert2_l12_dp2 [label=select style=dashed]
				expert3_l12_dp2 [label="Expert 3 L12\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert3_l12_dp2 [label=select style=dashed]
				expert4_l12_dp2 [label="Expert 4 L12\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert4_l12_dp2 [label=select style=dashed]
				expert5_l12_dp2 [label="Expert 5 L12\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert5_l12_dp2 [label=select style=dashed]
				expert6_l12_dp2 [label="Expert 6 L12\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert6_l12_dp2 [label=select style=dashed]
				expert7_l12_dp2 [label="Expert 7 L12\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert7_l12_dp2 [label=select style=dashed]
				expert8_l12_dp2 [label="Expert 8 L12\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert8_l12_dp2 [label=select style=dashed]
				expert9_l12_dp2 [label="Expert 9 L12\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert9_l12_dp2 [label=select style=dashed]
				expert10_l12_dp2 [label="Expert 10 L12\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert10_l12_dp2 [label=select style=dashed]
				expert11_l12_dp2 [label="Expert 11 L12\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert11_l12_dp2 [label=select style=dashed]
				expert12_l12_dp2 [label="Expert 12 L12\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert12_l12_dp2 [label=select style=dashed]
				expert13_l12_dp2 [label="Expert 13 L12\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert13_l12_dp2 [label=select style=dashed]
				expert14_l12_dp2 [label="Expert 14 L12\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert14_l12_dp2 [label=select style=dashed]
				expert15_l12_dp2 [label="Expert 15 L12\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp2 -> expert15_l12_dp2 [label=select style=dashed]
				expert_agg_l12_dp2 [label="Expert Aggregation L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l12_dp2 -> expert_agg_l12_dp2
				expert1_l12_dp2 -> expert_agg_l12_dp2
				expert2_l12_dp2 -> expert_agg_l12_dp2
				expert3_l12_dp2 -> expert_agg_l12_dp2
				expert4_l12_dp2 -> expert_agg_l12_dp2
				expert5_l12_dp2 -> expert_agg_l12_dp2
				expert6_l12_dp2 -> expert_agg_l12_dp2
				expert7_l12_dp2 -> expert_agg_l12_dp2
				expert8_l12_dp2 -> expert_agg_l12_dp2
				expert9_l12_dp2 -> expert_agg_l12_dp2
				expert10_l12_dp2 -> expert_agg_l12_dp2
				expert11_l12_dp2 -> expert_agg_l12_dp2
				expert12_l12_dp2 -> expert_agg_l12_dp2
				expert13_l12_dp2 -> expert_agg_l12_dp2
				expert14_l12_dp2 -> expert_agg_l12_dp2
				expert15_l12_dp2 -> expert_agg_l12_dp2
				layer12_output_dp2 [label="Layer 12 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l12_dp2 -> layer12_output_dp2
			}
			layer12_output_dp2 -> attn_input_l13_dp2
			subgraph layer13_dp2_stage2 {
				label="Layer 13" style=rounded
				attn_input_l13_dp2 [label="Attention Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp2 [label="Attention TP0 L13\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp2 -> attn_tp0_l13_dp2
				attn_tp1_l13_dp2 [label="Attention TP1 L13\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp2 -> attn_tp1_l13_dp2
				attn_tp2_l13_dp2 [label="Attention TP2 L13\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp2 -> attn_tp2_l13_dp2
				attn_tp3_l13_dp2 [label="Attention TP3 L13\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp2 -> attn_tp3_l13_dp2
				allreduce_l13_dp2 [label="AllReduce L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp2 -> allreduce_l13_dp2
				attn_tp1_l13_dp2 -> allreduce_l13_dp2
				attn_tp2_l13_dp2 -> allreduce_l13_dp2
				attn_tp3_l13_dp2 -> allreduce_l13_dp2
				moe_input_l13_dp2 [label="MoE Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l13_dp2 [label="Router L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l13_dp2 -> moe_input_l13_dp2
				moe_input_l13_dp2 -> router_l13_dp2
				expert0_l13_dp2 [label="Expert 0 L13\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert0_l13_dp2 [label=select style=dashed]
				expert1_l13_dp2 [label="Expert 1 L13\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert1_l13_dp2 [label=select style=dashed]
				expert2_l13_dp2 [label="Expert 2 L13\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert2_l13_dp2 [label=select style=dashed]
				expert3_l13_dp2 [label="Expert 3 L13\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert3_l13_dp2 [label=select style=dashed]
				expert4_l13_dp2 [label="Expert 4 L13\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert4_l13_dp2 [label=select style=dashed]
				expert5_l13_dp2 [label="Expert 5 L13\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert5_l13_dp2 [label=select style=dashed]
				expert6_l13_dp2 [label="Expert 6 L13\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert6_l13_dp2 [label=select style=dashed]
				expert7_l13_dp2 [label="Expert 7 L13\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert7_l13_dp2 [label=select style=dashed]
				expert8_l13_dp2 [label="Expert 8 L13\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert8_l13_dp2 [label=select style=dashed]
				expert9_l13_dp2 [label="Expert 9 L13\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert9_l13_dp2 [label=select style=dashed]
				expert10_l13_dp2 [label="Expert 10 L13\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert10_l13_dp2 [label=select style=dashed]
				expert11_l13_dp2 [label="Expert 11 L13\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert11_l13_dp2 [label=select style=dashed]
				expert12_l13_dp2 [label="Expert 12 L13\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert12_l13_dp2 [label=select style=dashed]
				expert13_l13_dp2 [label="Expert 13 L13\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert13_l13_dp2 [label=select style=dashed]
				expert14_l13_dp2 [label="Expert 14 L13\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert14_l13_dp2 [label=select style=dashed]
				expert15_l13_dp2 [label="Expert 15 L13\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp2 -> expert15_l13_dp2 [label=select style=dashed]
				expert_agg_l13_dp2 [label="Expert Aggregation L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l13_dp2 -> expert_agg_l13_dp2
				expert1_l13_dp2 -> expert_agg_l13_dp2
				expert2_l13_dp2 -> expert_agg_l13_dp2
				expert3_l13_dp2 -> expert_agg_l13_dp2
				expert4_l13_dp2 -> expert_agg_l13_dp2
				expert5_l13_dp2 -> expert_agg_l13_dp2
				expert6_l13_dp2 -> expert_agg_l13_dp2
				expert7_l13_dp2 -> expert_agg_l13_dp2
				expert8_l13_dp2 -> expert_agg_l13_dp2
				expert9_l13_dp2 -> expert_agg_l13_dp2
				expert10_l13_dp2 -> expert_agg_l13_dp2
				expert11_l13_dp2 -> expert_agg_l13_dp2
				expert12_l13_dp2 -> expert_agg_l13_dp2
				expert13_l13_dp2 -> expert_agg_l13_dp2
				expert14_l13_dp2 -> expert_agg_l13_dp2
				expert15_l13_dp2 -> expert_agg_l13_dp2
				layer13_output_dp2 [label="Layer 13 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l13_dp2 -> layer13_output_dp2
			}
			layer13_output_dp2 -> attn_input_l14_dp2
			subgraph layer14_dp2_stage2 {
				label="Layer 14" style=rounded
				attn_input_l14_dp2 [label="Attention Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp2 [label="Attention TP0 L14\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp2 -> attn_tp0_l14_dp2
				attn_tp1_l14_dp2 [label="Attention TP1 L14\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp2 -> attn_tp1_l14_dp2
				attn_tp2_l14_dp2 [label="Attention TP2 L14\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp2 -> attn_tp2_l14_dp2
				attn_tp3_l14_dp2 [label="Attention TP3 L14\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp2 -> attn_tp3_l14_dp2
				allreduce_l14_dp2 [label="AllReduce L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp2 -> allreduce_l14_dp2
				attn_tp1_l14_dp2 -> allreduce_l14_dp2
				attn_tp2_l14_dp2 -> allreduce_l14_dp2
				attn_tp3_l14_dp2 -> allreduce_l14_dp2
				moe_input_l14_dp2 [label="MoE Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l14_dp2 [label="Router L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l14_dp2 -> moe_input_l14_dp2
				moe_input_l14_dp2 -> router_l14_dp2
				expert0_l14_dp2 [label="Expert 0 L14\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert0_l14_dp2 [label=select style=dashed]
				expert1_l14_dp2 [label="Expert 1 L14\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert1_l14_dp2 [label=select style=dashed]
				expert2_l14_dp2 [label="Expert 2 L14\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert2_l14_dp2 [label=select style=dashed]
				expert3_l14_dp2 [label="Expert 3 L14\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert3_l14_dp2 [label=select style=dashed]
				expert4_l14_dp2 [label="Expert 4 L14\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert4_l14_dp2 [label=select style=dashed]
				expert5_l14_dp2 [label="Expert 5 L14\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert5_l14_dp2 [label=select style=dashed]
				expert6_l14_dp2 [label="Expert 6 L14\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert6_l14_dp2 [label=select style=dashed]
				expert7_l14_dp2 [label="Expert 7 L14\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert7_l14_dp2 [label=select style=dashed]
				expert8_l14_dp2 [label="Expert 8 L14\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert8_l14_dp2 [label=select style=dashed]
				expert9_l14_dp2 [label="Expert 9 L14\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert9_l14_dp2 [label=select style=dashed]
				expert10_l14_dp2 [label="Expert 10 L14\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert10_l14_dp2 [label=select style=dashed]
				expert11_l14_dp2 [label="Expert 11 L14\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert11_l14_dp2 [label=select style=dashed]
				expert12_l14_dp2 [label="Expert 12 L14\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert12_l14_dp2 [label=select style=dashed]
				expert13_l14_dp2 [label="Expert 13 L14\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert13_l14_dp2 [label=select style=dashed]
				expert14_l14_dp2 [label="Expert 14 L14\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert14_l14_dp2 [label=select style=dashed]
				expert15_l14_dp2 [label="Expert 15 L14\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp2 -> expert15_l14_dp2 [label=select style=dashed]
				expert_agg_l14_dp2 [label="Expert Aggregation L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l14_dp2 -> expert_agg_l14_dp2
				expert1_l14_dp2 -> expert_agg_l14_dp2
				expert2_l14_dp2 -> expert_agg_l14_dp2
				expert3_l14_dp2 -> expert_agg_l14_dp2
				expert4_l14_dp2 -> expert_agg_l14_dp2
				expert5_l14_dp2 -> expert_agg_l14_dp2
				expert6_l14_dp2 -> expert_agg_l14_dp2
				expert7_l14_dp2 -> expert_agg_l14_dp2
				expert8_l14_dp2 -> expert_agg_l14_dp2
				expert9_l14_dp2 -> expert_agg_l14_dp2
				expert10_l14_dp2 -> expert_agg_l14_dp2
				expert11_l14_dp2 -> expert_agg_l14_dp2
				expert12_l14_dp2 -> expert_agg_l14_dp2
				expert13_l14_dp2 -> expert_agg_l14_dp2
				expert14_l14_dp2 -> expert_agg_l14_dp2
				expert15_l14_dp2 -> expert_agg_l14_dp2
				layer14_output_dp2 [label="Layer 14 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l14_dp2 -> layer14_output_dp2
			}
			layer14_output_dp2 -> attn_input_l15_dp2
			subgraph layer15_dp2_stage2 {
				label="Layer 15" style=rounded
				attn_input_l15_dp2 [label="Attention Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp2 [label="Attention TP0 L15\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp2 -> attn_tp0_l15_dp2
				attn_tp1_l15_dp2 [label="Attention TP1 L15\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp2 -> attn_tp1_l15_dp2
				attn_tp2_l15_dp2 [label="Attention TP2 L15\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp2 -> attn_tp2_l15_dp2
				attn_tp3_l15_dp2 [label="Attention TP3 L15\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp2 -> attn_tp3_l15_dp2
				allreduce_l15_dp2 [label="AllReduce L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp2 -> allreduce_l15_dp2
				attn_tp1_l15_dp2 -> allreduce_l15_dp2
				attn_tp2_l15_dp2 -> allreduce_l15_dp2
				attn_tp3_l15_dp2 -> allreduce_l15_dp2
				moe_input_l15_dp2 [label="MoE Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l15_dp2 [label="Router L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l15_dp2 -> moe_input_l15_dp2
				moe_input_l15_dp2 -> router_l15_dp2
				expert0_l15_dp2 [label="Expert 0 L15\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert0_l15_dp2 [label=select style=dashed]
				expert1_l15_dp2 [label="Expert 1 L15\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert1_l15_dp2 [label=select style=dashed]
				expert2_l15_dp2 [label="Expert 2 L15\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert2_l15_dp2 [label=select style=dashed]
				expert3_l15_dp2 [label="Expert 3 L15\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert3_l15_dp2 [label=select style=dashed]
				expert4_l15_dp2 [label="Expert 4 L15\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert4_l15_dp2 [label=select style=dashed]
				expert5_l15_dp2 [label="Expert 5 L15\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert5_l15_dp2 [label=select style=dashed]
				expert6_l15_dp2 [label="Expert 6 L15\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert6_l15_dp2 [label=select style=dashed]
				expert7_l15_dp2 [label="Expert 7 L15\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert7_l15_dp2 [label=select style=dashed]
				expert8_l15_dp2 [label="Expert 8 L15\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert8_l15_dp2 [label=select style=dashed]
				expert9_l15_dp2 [label="Expert 9 L15\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert9_l15_dp2 [label=select style=dashed]
				expert10_l15_dp2 [label="Expert 10 L15\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert10_l15_dp2 [label=select style=dashed]
				expert11_l15_dp2 [label="Expert 11 L15\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert11_l15_dp2 [label=select style=dashed]
				expert12_l15_dp2 [label="Expert 12 L15\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert12_l15_dp2 [label=select style=dashed]
				expert13_l15_dp2 [label="Expert 13 L15\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert13_l15_dp2 [label=select style=dashed]
				expert14_l15_dp2 [label="Expert 14 L15\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert14_l15_dp2 [label=select style=dashed]
				expert15_l15_dp2 [label="Expert 15 L15\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp2 -> expert15_l15_dp2 [label=select style=dashed]
				expert_agg_l15_dp2 [label="Expert Aggregation L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l15_dp2 -> expert_agg_l15_dp2
				expert1_l15_dp2 -> expert_agg_l15_dp2
				expert2_l15_dp2 -> expert_agg_l15_dp2
				expert3_l15_dp2 -> expert_agg_l15_dp2
				expert4_l15_dp2 -> expert_agg_l15_dp2
				expert5_l15_dp2 -> expert_agg_l15_dp2
				expert6_l15_dp2 -> expert_agg_l15_dp2
				expert7_l15_dp2 -> expert_agg_l15_dp2
				expert8_l15_dp2 -> expert_agg_l15_dp2
				expert9_l15_dp2 -> expert_agg_l15_dp2
				expert10_l15_dp2 -> expert_agg_l15_dp2
				expert11_l15_dp2 -> expert_agg_l15_dp2
				expert12_l15_dp2 -> expert_agg_l15_dp2
				expert13_l15_dp2 -> expert_agg_l15_dp2
				expert14_l15_dp2 -> expert_agg_l15_dp2
				expert15_l15_dp2 -> expert_agg_l15_dp2
				layer15_output_dp2 [label="Layer 15 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l15_dp2 -> layer15_output_dp2
			}
			layer15_output_dp2 -> attn_input_l16_dp2
			subgraph layer16_dp2_stage2 {
				label="Layer 16" style=rounded
				attn_input_l16_dp2 [label="Attention Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp2 [label="Attention TP0 L16\nGPU 80\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp2 -> attn_tp0_l16_dp2
				attn_tp1_l16_dp2 [label="Attention TP1 L16\nGPU 81\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp2 -> attn_tp1_l16_dp2
				attn_tp2_l16_dp2 [label="Attention TP2 L16\nGPU 82\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp2 -> attn_tp2_l16_dp2
				attn_tp3_l16_dp2 [label="Attention TP3 L16\nGPU 83\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp2 -> attn_tp3_l16_dp2
				allreduce_l16_dp2 [label="AllReduce L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp2 -> allreduce_l16_dp2
				attn_tp1_l16_dp2 -> allreduce_l16_dp2
				attn_tp2_l16_dp2 -> allreduce_l16_dp2
				attn_tp3_l16_dp2 -> allreduce_l16_dp2
				moe_input_l16_dp2 [label="MoE Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l16_dp2 [label="Router L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l16_dp2 -> moe_input_l16_dp2
				moe_input_l16_dp2 -> router_l16_dp2
				expert0_l16_dp2 [label="Expert 0 L16\nGPU 80\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert0_l16_dp2 [label=select style=dashed]
				expert1_l16_dp2 [label="Expert 1 L16\nGPU 81\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert1_l16_dp2 [label=select style=dashed]
				expert2_l16_dp2 [label="Expert 2 L16\nGPU 82\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert2_l16_dp2 [label=select style=dashed]
				expert3_l16_dp2 [label="Expert 3 L16\nGPU 83\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert3_l16_dp2 [label=select style=dashed]
				expert4_l16_dp2 [label="Expert 4 L16\nGPU 84\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert4_l16_dp2 [label=select style=dashed]
				expert5_l16_dp2 [label="Expert 5 L16\nGPU 85\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert5_l16_dp2 [label=select style=dashed]
				expert6_l16_dp2 [label="Expert 6 L16\nGPU 86\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert6_l16_dp2 [label=select style=dashed]
				expert7_l16_dp2 [label="Expert 7 L16\nGPU 87\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert7_l16_dp2 [label=select style=dashed]
				expert8_l16_dp2 [label="Expert 8 L16\nGPU 88\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert8_l16_dp2 [label=select style=dashed]
				expert9_l16_dp2 [label="Expert 9 L16\nGPU 89\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert9_l16_dp2 [label=select style=dashed]
				expert10_l16_dp2 [label="Expert 10 L16\nGPU 90\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert10_l16_dp2 [label=select style=dashed]
				expert11_l16_dp2 [label="Expert 11 L16\nGPU 91\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert11_l16_dp2 [label=select style=dashed]
				expert12_l16_dp2 [label="Expert 12 L16\nGPU 92\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert12_l16_dp2 [label=select style=dashed]
				expert13_l16_dp2 [label="Expert 13 L16\nGPU 93\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert13_l16_dp2 [label=select style=dashed]
				expert14_l16_dp2 [label="Expert 14 L16\nGPU 94\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert14_l16_dp2 [label=select style=dashed]
				expert15_l16_dp2 [label="Expert 15 L16\nGPU 95\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp2 -> expert15_l16_dp2 [label=select style=dashed]
				expert_agg_l16_dp2 [label="Expert Aggregation L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l16_dp2 -> expert_agg_l16_dp2
				expert1_l16_dp2 -> expert_agg_l16_dp2
				expert2_l16_dp2 -> expert_agg_l16_dp2
				expert3_l16_dp2 -> expert_agg_l16_dp2
				expert4_l16_dp2 -> expert_agg_l16_dp2
				expert5_l16_dp2 -> expert_agg_l16_dp2
				expert6_l16_dp2 -> expert_agg_l16_dp2
				expert7_l16_dp2 -> expert_agg_l16_dp2
				expert8_l16_dp2 -> expert_agg_l16_dp2
				expert9_l16_dp2 -> expert_agg_l16_dp2
				expert10_l16_dp2 -> expert_agg_l16_dp2
				expert11_l16_dp2 -> expert_agg_l16_dp2
				expert12_l16_dp2 -> expert_agg_l16_dp2
				expert13_l16_dp2 -> expert_agg_l16_dp2
				expert14_l16_dp2 -> expert_agg_l16_dp2
				expert15_l16_dp2 -> expert_agg_l16_dp2
				layer16_output_dp2 [label="Layer 16 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l16_dp2 -> layer16_output_dp2
			}
			stage2_output_dp2 [label="Stage 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer16_output_dp2 -> stage2_output_dp2
		}
	}
	subgraph dp_3 {
		fillcolor=lightgray label="DP Replica 3" rank=same style="rounded,filled"
		subgraph stage1_dp3 {
			fillcolor=lightcyan label="PP Stage 1 (Layers 1-8)" style="rounded,filled"
			stage1_input_dp3 [label="Stage1 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage1_input_dp3 -> attn_input_l1_dp3
			subgraph layer1_dp3_stage1 {
				label="Layer 1" style=rounded
				attn_input_l1_dp3 [label="Attention Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp3 [label="Attention TP0 L1\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp3 -> attn_tp0_l1_dp3
				attn_tp1_l1_dp3 [label="Attention TP1 L1\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp3 -> attn_tp1_l1_dp3
				attn_tp2_l1_dp3 [label="Attention TP2 L1\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp3 -> attn_tp2_l1_dp3
				attn_tp3_l1_dp3 [label="Attention TP3 L1\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l1_dp3 -> attn_tp3_l1_dp3
				allreduce_l1_dp3 [label="AllReduce L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l1_dp3 -> allreduce_l1_dp3
				attn_tp1_l1_dp3 -> allreduce_l1_dp3
				attn_tp2_l1_dp3 -> allreduce_l1_dp3
				attn_tp3_l1_dp3 -> allreduce_l1_dp3
				moe_input_l1_dp3 [label="MoE Input L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l1_dp3 [label="Router L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l1_dp3 -> moe_input_l1_dp3
				moe_input_l1_dp3 -> router_l1_dp3
				expert0_l1_dp3 [label="Expert 0 L1\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert0_l1_dp3 [label=select style=dashed]
				expert1_l1_dp3 [label="Expert 1 L1\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert1_l1_dp3 [label=select style=dashed]
				expert2_l1_dp3 [label="Expert 2 L1\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert2_l1_dp3 [label=select style=dashed]
				expert3_l1_dp3 [label="Expert 3 L1\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert3_l1_dp3 [label=select style=dashed]
				expert4_l1_dp3 [label="Expert 4 L1\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert4_l1_dp3 [label=select style=dashed]
				expert5_l1_dp3 [label="Expert 5 L1\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert5_l1_dp3 [label=select style=dashed]
				expert6_l1_dp3 [label="Expert 6 L1\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert6_l1_dp3 [label=select style=dashed]
				expert7_l1_dp3 [label="Expert 7 L1\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert7_l1_dp3 [label=select style=dashed]
				expert8_l1_dp3 [label="Expert 8 L1\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert8_l1_dp3 [label=select style=dashed]
				expert9_l1_dp3 [label="Expert 9 L1\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert9_l1_dp3 [label=select style=dashed]
				expert10_l1_dp3 [label="Expert 10 L1\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert10_l1_dp3 [label=select style=dashed]
				expert11_l1_dp3 [label="Expert 11 L1\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert11_l1_dp3 [label=select style=dashed]
				expert12_l1_dp3 [label="Expert 12 L1\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert12_l1_dp3 [label=select style=dashed]
				expert13_l1_dp3 [label="Expert 13 L1\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert13_l1_dp3 [label=select style=dashed]
				expert14_l1_dp3 [label="Expert 14 L1\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert14_l1_dp3 [label=select style=dashed]
				expert15_l1_dp3 [label="Expert 15 L1\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l1_dp3 -> expert15_l1_dp3 [label=select style=dashed]
				expert_agg_l1_dp3 [label="Expert Aggregation L1\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l1_dp3 -> expert_agg_l1_dp3
				expert1_l1_dp3 -> expert_agg_l1_dp3
				expert2_l1_dp3 -> expert_agg_l1_dp3
				expert3_l1_dp3 -> expert_agg_l1_dp3
				expert4_l1_dp3 -> expert_agg_l1_dp3
				expert5_l1_dp3 -> expert_agg_l1_dp3
				expert6_l1_dp3 -> expert_agg_l1_dp3
				expert7_l1_dp3 -> expert_agg_l1_dp3
				expert8_l1_dp3 -> expert_agg_l1_dp3
				expert9_l1_dp3 -> expert_agg_l1_dp3
				expert10_l1_dp3 -> expert_agg_l1_dp3
				expert11_l1_dp3 -> expert_agg_l1_dp3
				expert12_l1_dp3 -> expert_agg_l1_dp3
				expert13_l1_dp3 -> expert_agg_l1_dp3
				expert14_l1_dp3 -> expert_agg_l1_dp3
				expert15_l1_dp3 -> expert_agg_l1_dp3
				layer1_output_dp3 [label="Layer 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l1_dp3 -> layer1_output_dp3
			}
			layer1_output_dp3 -> attn_input_l2_dp3
			subgraph layer2_dp3_stage1 {
				label="Layer 2" style=rounded
				attn_input_l2_dp3 [label="Attention Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp3 [label="Attention TP0 L2\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp3 -> attn_tp0_l2_dp3
				attn_tp1_l2_dp3 [label="Attention TP1 L2\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp3 -> attn_tp1_l2_dp3
				attn_tp2_l2_dp3 [label="Attention TP2 L2\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp3 -> attn_tp2_l2_dp3
				attn_tp3_l2_dp3 [label="Attention TP3 L2\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l2_dp3 -> attn_tp3_l2_dp3
				allreduce_l2_dp3 [label="AllReduce L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l2_dp3 -> allreduce_l2_dp3
				attn_tp1_l2_dp3 -> allreduce_l2_dp3
				attn_tp2_l2_dp3 -> allreduce_l2_dp3
				attn_tp3_l2_dp3 -> allreduce_l2_dp3
				moe_input_l2_dp3 [label="MoE Input L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l2_dp3 [label="Router L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l2_dp3 -> moe_input_l2_dp3
				moe_input_l2_dp3 -> router_l2_dp3
				expert0_l2_dp3 [label="Expert 0 L2\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert0_l2_dp3 [label=select style=dashed]
				expert1_l2_dp3 [label="Expert 1 L2\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert1_l2_dp3 [label=select style=dashed]
				expert2_l2_dp3 [label="Expert 2 L2\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert2_l2_dp3 [label=select style=dashed]
				expert3_l2_dp3 [label="Expert 3 L2\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert3_l2_dp3 [label=select style=dashed]
				expert4_l2_dp3 [label="Expert 4 L2\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert4_l2_dp3 [label=select style=dashed]
				expert5_l2_dp3 [label="Expert 5 L2\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert5_l2_dp3 [label=select style=dashed]
				expert6_l2_dp3 [label="Expert 6 L2\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert6_l2_dp3 [label=select style=dashed]
				expert7_l2_dp3 [label="Expert 7 L2\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert7_l2_dp3 [label=select style=dashed]
				expert8_l2_dp3 [label="Expert 8 L2\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert8_l2_dp3 [label=select style=dashed]
				expert9_l2_dp3 [label="Expert 9 L2\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert9_l2_dp3 [label=select style=dashed]
				expert10_l2_dp3 [label="Expert 10 L2\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert10_l2_dp3 [label=select style=dashed]
				expert11_l2_dp3 [label="Expert 11 L2\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert11_l2_dp3 [label=select style=dashed]
				expert12_l2_dp3 [label="Expert 12 L2\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert12_l2_dp3 [label=select style=dashed]
				expert13_l2_dp3 [label="Expert 13 L2\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert13_l2_dp3 [label=select style=dashed]
				expert14_l2_dp3 [label="Expert 14 L2\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert14_l2_dp3 [label=select style=dashed]
				expert15_l2_dp3 [label="Expert 15 L2\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l2_dp3 -> expert15_l2_dp3 [label=select style=dashed]
				expert_agg_l2_dp3 [label="Expert Aggregation L2\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l2_dp3 -> expert_agg_l2_dp3
				expert1_l2_dp3 -> expert_agg_l2_dp3
				expert2_l2_dp3 -> expert_agg_l2_dp3
				expert3_l2_dp3 -> expert_agg_l2_dp3
				expert4_l2_dp3 -> expert_agg_l2_dp3
				expert5_l2_dp3 -> expert_agg_l2_dp3
				expert6_l2_dp3 -> expert_agg_l2_dp3
				expert7_l2_dp3 -> expert_agg_l2_dp3
				expert8_l2_dp3 -> expert_agg_l2_dp3
				expert9_l2_dp3 -> expert_agg_l2_dp3
				expert10_l2_dp3 -> expert_agg_l2_dp3
				expert11_l2_dp3 -> expert_agg_l2_dp3
				expert12_l2_dp3 -> expert_agg_l2_dp3
				expert13_l2_dp3 -> expert_agg_l2_dp3
				expert14_l2_dp3 -> expert_agg_l2_dp3
				expert15_l2_dp3 -> expert_agg_l2_dp3
				layer2_output_dp3 [label="Layer 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l2_dp3 -> layer2_output_dp3
			}
			layer2_output_dp3 -> attn_input_l3_dp3
			subgraph layer3_dp3_stage1 {
				label="Layer 3" style=rounded
				attn_input_l3_dp3 [label="Attention Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp3 [label="Attention TP0 L3\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp3 -> attn_tp0_l3_dp3
				attn_tp1_l3_dp3 [label="Attention TP1 L3\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp3 -> attn_tp1_l3_dp3
				attn_tp2_l3_dp3 [label="Attention TP2 L3\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp3 -> attn_tp2_l3_dp3
				attn_tp3_l3_dp3 [label="Attention TP3 L3\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l3_dp3 -> attn_tp3_l3_dp3
				allreduce_l3_dp3 [label="AllReduce L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l3_dp3 -> allreduce_l3_dp3
				attn_tp1_l3_dp3 -> allreduce_l3_dp3
				attn_tp2_l3_dp3 -> allreduce_l3_dp3
				attn_tp3_l3_dp3 -> allreduce_l3_dp3
				moe_input_l3_dp3 [label="MoE Input L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l3_dp3 [label="Router L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l3_dp3 -> moe_input_l3_dp3
				moe_input_l3_dp3 -> router_l3_dp3
				expert0_l3_dp3 [label="Expert 0 L3\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert0_l3_dp3 [label=select style=dashed]
				expert1_l3_dp3 [label="Expert 1 L3\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert1_l3_dp3 [label=select style=dashed]
				expert2_l3_dp3 [label="Expert 2 L3\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert2_l3_dp3 [label=select style=dashed]
				expert3_l3_dp3 [label="Expert 3 L3\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert3_l3_dp3 [label=select style=dashed]
				expert4_l3_dp3 [label="Expert 4 L3\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert4_l3_dp3 [label=select style=dashed]
				expert5_l3_dp3 [label="Expert 5 L3\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert5_l3_dp3 [label=select style=dashed]
				expert6_l3_dp3 [label="Expert 6 L3\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert6_l3_dp3 [label=select style=dashed]
				expert7_l3_dp3 [label="Expert 7 L3\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert7_l3_dp3 [label=select style=dashed]
				expert8_l3_dp3 [label="Expert 8 L3\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert8_l3_dp3 [label=select style=dashed]
				expert9_l3_dp3 [label="Expert 9 L3\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert9_l3_dp3 [label=select style=dashed]
				expert10_l3_dp3 [label="Expert 10 L3\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert10_l3_dp3 [label=select style=dashed]
				expert11_l3_dp3 [label="Expert 11 L3\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert11_l3_dp3 [label=select style=dashed]
				expert12_l3_dp3 [label="Expert 12 L3\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert12_l3_dp3 [label=select style=dashed]
				expert13_l3_dp3 [label="Expert 13 L3\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert13_l3_dp3 [label=select style=dashed]
				expert14_l3_dp3 [label="Expert 14 L3\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert14_l3_dp3 [label=select style=dashed]
				expert15_l3_dp3 [label="Expert 15 L3\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l3_dp3 -> expert15_l3_dp3 [label=select style=dashed]
				expert_agg_l3_dp3 [label="Expert Aggregation L3\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l3_dp3 -> expert_agg_l3_dp3
				expert1_l3_dp3 -> expert_agg_l3_dp3
				expert2_l3_dp3 -> expert_agg_l3_dp3
				expert3_l3_dp3 -> expert_agg_l3_dp3
				expert4_l3_dp3 -> expert_agg_l3_dp3
				expert5_l3_dp3 -> expert_agg_l3_dp3
				expert6_l3_dp3 -> expert_agg_l3_dp3
				expert7_l3_dp3 -> expert_agg_l3_dp3
				expert8_l3_dp3 -> expert_agg_l3_dp3
				expert9_l3_dp3 -> expert_agg_l3_dp3
				expert10_l3_dp3 -> expert_agg_l3_dp3
				expert11_l3_dp3 -> expert_agg_l3_dp3
				expert12_l3_dp3 -> expert_agg_l3_dp3
				expert13_l3_dp3 -> expert_agg_l3_dp3
				expert14_l3_dp3 -> expert_agg_l3_dp3
				expert15_l3_dp3 -> expert_agg_l3_dp3
				layer3_output_dp3 [label="Layer 3 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l3_dp3 -> layer3_output_dp3
			}
			layer3_output_dp3 -> attn_input_l4_dp3
			subgraph layer4_dp3_stage1 {
				label="Layer 4" style=rounded
				attn_input_l4_dp3 [label="Attention Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp3 [label="Attention TP0 L4\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp3 -> attn_tp0_l4_dp3
				attn_tp1_l4_dp3 [label="Attention TP1 L4\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp3 -> attn_tp1_l4_dp3
				attn_tp2_l4_dp3 [label="Attention TP2 L4\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp3 -> attn_tp2_l4_dp3
				attn_tp3_l4_dp3 [label="Attention TP3 L4\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l4_dp3 -> attn_tp3_l4_dp3
				allreduce_l4_dp3 [label="AllReduce L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l4_dp3 -> allreduce_l4_dp3
				attn_tp1_l4_dp3 -> allreduce_l4_dp3
				attn_tp2_l4_dp3 -> allreduce_l4_dp3
				attn_tp3_l4_dp3 -> allreduce_l4_dp3
				moe_input_l4_dp3 [label="MoE Input L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l4_dp3 [label="Router L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l4_dp3 -> moe_input_l4_dp3
				moe_input_l4_dp3 -> router_l4_dp3
				expert0_l4_dp3 [label="Expert 0 L4\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert0_l4_dp3 [label=select style=dashed]
				expert1_l4_dp3 [label="Expert 1 L4\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert1_l4_dp3 [label=select style=dashed]
				expert2_l4_dp3 [label="Expert 2 L4\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert2_l4_dp3 [label=select style=dashed]
				expert3_l4_dp3 [label="Expert 3 L4\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert3_l4_dp3 [label=select style=dashed]
				expert4_l4_dp3 [label="Expert 4 L4\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert4_l4_dp3 [label=select style=dashed]
				expert5_l4_dp3 [label="Expert 5 L4\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert5_l4_dp3 [label=select style=dashed]
				expert6_l4_dp3 [label="Expert 6 L4\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert6_l4_dp3 [label=select style=dashed]
				expert7_l4_dp3 [label="Expert 7 L4\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert7_l4_dp3 [label=select style=dashed]
				expert8_l4_dp3 [label="Expert 8 L4\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert8_l4_dp3 [label=select style=dashed]
				expert9_l4_dp3 [label="Expert 9 L4\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert9_l4_dp3 [label=select style=dashed]
				expert10_l4_dp3 [label="Expert 10 L4\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert10_l4_dp3 [label=select style=dashed]
				expert11_l4_dp3 [label="Expert 11 L4\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert11_l4_dp3 [label=select style=dashed]
				expert12_l4_dp3 [label="Expert 12 L4\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert12_l4_dp3 [label=select style=dashed]
				expert13_l4_dp3 [label="Expert 13 L4\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert13_l4_dp3 [label=select style=dashed]
				expert14_l4_dp3 [label="Expert 14 L4\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert14_l4_dp3 [label=select style=dashed]
				expert15_l4_dp3 [label="Expert 15 L4\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l4_dp3 -> expert15_l4_dp3 [label=select style=dashed]
				expert_agg_l4_dp3 [label="Expert Aggregation L4\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l4_dp3 -> expert_agg_l4_dp3
				expert1_l4_dp3 -> expert_agg_l4_dp3
				expert2_l4_dp3 -> expert_agg_l4_dp3
				expert3_l4_dp3 -> expert_agg_l4_dp3
				expert4_l4_dp3 -> expert_agg_l4_dp3
				expert5_l4_dp3 -> expert_agg_l4_dp3
				expert6_l4_dp3 -> expert_agg_l4_dp3
				expert7_l4_dp3 -> expert_agg_l4_dp3
				expert8_l4_dp3 -> expert_agg_l4_dp3
				expert9_l4_dp3 -> expert_agg_l4_dp3
				expert10_l4_dp3 -> expert_agg_l4_dp3
				expert11_l4_dp3 -> expert_agg_l4_dp3
				expert12_l4_dp3 -> expert_agg_l4_dp3
				expert13_l4_dp3 -> expert_agg_l4_dp3
				expert14_l4_dp3 -> expert_agg_l4_dp3
				expert15_l4_dp3 -> expert_agg_l4_dp3
				layer4_output_dp3 [label="Layer 4 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l4_dp3 -> layer4_output_dp3
			}
			layer4_output_dp3 -> attn_input_l5_dp3
			subgraph layer5_dp3_stage1 {
				label="Layer 5" style=rounded
				attn_input_l5_dp3 [label="Attention Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp3 [label="Attention TP0 L5\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp3 -> attn_tp0_l5_dp3
				attn_tp1_l5_dp3 [label="Attention TP1 L5\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp3 -> attn_tp1_l5_dp3
				attn_tp2_l5_dp3 [label="Attention TP2 L5\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp3 -> attn_tp2_l5_dp3
				attn_tp3_l5_dp3 [label="Attention TP3 L5\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l5_dp3 -> attn_tp3_l5_dp3
				allreduce_l5_dp3 [label="AllReduce L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l5_dp3 -> allreduce_l5_dp3
				attn_tp1_l5_dp3 -> allreduce_l5_dp3
				attn_tp2_l5_dp3 -> allreduce_l5_dp3
				attn_tp3_l5_dp3 -> allreduce_l5_dp3
				moe_input_l5_dp3 [label="MoE Input L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l5_dp3 [label="Router L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l5_dp3 -> moe_input_l5_dp3
				moe_input_l5_dp3 -> router_l5_dp3
				expert0_l5_dp3 [label="Expert 0 L5\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert0_l5_dp3 [label=select style=dashed]
				expert1_l5_dp3 [label="Expert 1 L5\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert1_l5_dp3 [label=select style=dashed]
				expert2_l5_dp3 [label="Expert 2 L5\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert2_l5_dp3 [label=select style=dashed]
				expert3_l5_dp3 [label="Expert 3 L5\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert3_l5_dp3 [label=select style=dashed]
				expert4_l5_dp3 [label="Expert 4 L5\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert4_l5_dp3 [label=select style=dashed]
				expert5_l5_dp3 [label="Expert 5 L5\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert5_l5_dp3 [label=select style=dashed]
				expert6_l5_dp3 [label="Expert 6 L5\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert6_l5_dp3 [label=select style=dashed]
				expert7_l5_dp3 [label="Expert 7 L5\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert7_l5_dp3 [label=select style=dashed]
				expert8_l5_dp3 [label="Expert 8 L5\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert8_l5_dp3 [label=select style=dashed]
				expert9_l5_dp3 [label="Expert 9 L5\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert9_l5_dp3 [label=select style=dashed]
				expert10_l5_dp3 [label="Expert 10 L5\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert10_l5_dp3 [label=select style=dashed]
				expert11_l5_dp3 [label="Expert 11 L5\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert11_l5_dp3 [label=select style=dashed]
				expert12_l5_dp3 [label="Expert 12 L5\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert12_l5_dp3 [label=select style=dashed]
				expert13_l5_dp3 [label="Expert 13 L5\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert13_l5_dp3 [label=select style=dashed]
				expert14_l5_dp3 [label="Expert 14 L5\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert14_l5_dp3 [label=select style=dashed]
				expert15_l5_dp3 [label="Expert 15 L5\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l5_dp3 -> expert15_l5_dp3 [label=select style=dashed]
				expert_agg_l5_dp3 [label="Expert Aggregation L5\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l5_dp3 -> expert_agg_l5_dp3
				expert1_l5_dp3 -> expert_agg_l5_dp3
				expert2_l5_dp3 -> expert_agg_l5_dp3
				expert3_l5_dp3 -> expert_agg_l5_dp3
				expert4_l5_dp3 -> expert_agg_l5_dp3
				expert5_l5_dp3 -> expert_agg_l5_dp3
				expert6_l5_dp3 -> expert_agg_l5_dp3
				expert7_l5_dp3 -> expert_agg_l5_dp3
				expert8_l5_dp3 -> expert_agg_l5_dp3
				expert9_l5_dp3 -> expert_agg_l5_dp3
				expert10_l5_dp3 -> expert_agg_l5_dp3
				expert11_l5_dp3 -> expert_agg_l5_dp3
				expert12_l5_dp3 -> expert_agg_l5_dp3
				expert13_l5_dp3 -> expert_agg_l5_dp3
				expert14_l5_dp3 -> expert_agg_l5_dp3
				expert15_l5_dp3 -> expert_agg_l5_dp3
				layer5_output_dp3 [label="Layer 5 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l5_dp3 -> layer5_output_dp3
			}
			layer5_output_dp3 -> attn_input_l6_dp3
			subgraph layer6_dp3_stage1 {
				label="Layer 6" style=rounded
				attn_input_l6_dp3 [label="Attention Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp3 [label="Attention TP0 L6\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp3 -> attn_tp0_l6_dp3
				attn_tp1_l6_dp3 [label="Attention TP1 L6\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp3 -> attn_tp1_l6_dp3
				attn_tp2_l6_dp3 [label="Attention TP2 L6\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp3 -> attn_tp2_l6_dp3
				attn_tp3_l6_dp3 [label="Attention TP3 L6\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l6_dp3 -> attn_tp3_l6_dp3
				allreduce_l6_dp3 [label="AllReduce L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l6_dp3 -> allreduce_l6_dp3
				attn_tp1_l6_dp3 -> allreduce_l6_dp3
				attn_tp2_l6_dp3 -> allreduce_l6_dp3
				attn_tp3_l6_dp3 -> allreduce_l6_dp3
				moe_input_l6_dp3 [label="MoE Input L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l6_dp3 [label="Router L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l6_dp3 -> moe_input_l6_dp3
				moe_input_l6_dp3 -> router_l6_dp3
				expert0_l6_dp3 [label="Expert 0 L6\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert0_l6_dp3 [label=select style=dashed]
				expert1_l6_dp3 [label="Expert 1 L6\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert1_l6_dp3 [label=select style=dashed]
				expert2_l6_dp3 [label="Expert 2 L6\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert2_l6_dp3 [label=select style=dashed]
				expert3_l6_dp3 [label="Expert 3 L6\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert3_l6_dp3 [label=select style=dashed]
				expert4_l6_dp3 [label="Expert 4 L6\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert4_l6_dp3 [label=select style=dashed]
				expert5_l6_dp3 [label="Expert 5 L6\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert5_l6_dp3 [label=select style=dashed]
				expert6_l6_dp3 [label="Expert 6 L6\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert6_l6_dp3 [label=select style=dashed]
				expert7_l6_dp3 [label="Expert 7 L6\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert7_l6_dp3 [label=select style=dashed]
				expert8_l6_dp3 [label="Expert 8 L6\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert8_l6_dp3 [label=select style=dashed]
				expert9_l6_dp3 [label="Expert 9 L6\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert9_l6_dp3 [label=select style=dashed]
				expert10_l6_dp3 [label="Expert 10 L6\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert10_l6_dp3 [label=select style=dashed]
				expert11_l6_dp3 [label="Expert 11 L6\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert11_l6_dp3 [label=select style=dashed]
				expert12_l6_dp3 [label="Expert 12 L6\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert12_l6_dp3 [label=select style=dashed]
				expert13_l6_dp3 [label="Expert 13 L6\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert13_l6_dp3 [label=select style=dashed]
				expert14_l6_dp3 [label="Expert 14 L6\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert14_l6_dp3 [label=select style=dashed]
				expert15_l6_dp3 [label="Expert 15 L6\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l6_dp3 -> expert15_l6_dp3 [label=select style=dashed]
				expert_agg_l6_dp3 [label="Expert Aggregation L6\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l6_dp3 -> expert_agg_l6_dp3
				expert1_l6_dp3 -> expert_agg_l6_dp3
				expert2_l6_dp3 -> expert_agg_l6_dp3
				expert3_l6_dp3 -> expert_agg_l6_dp3
				expert4_l6_dp3 -> expert_agg_l6_dp3
				expert5_l6_dp3 -> expert_agg_l6_dp3
				expert6_l6_dp3 -> expert_agg_l6_dp3
				expert7_l6_dp3 -> expert_agg_l6_dp3
				expert8_l6_dp3 -> expert_agg_l6_dp3
				expert9_l6_dp3 -> expert_agg_l6_dp3
				expert10_l6_dp3 -> expert_agg_l6_dp3
				expert11_l6_dp3 -> expert_agg_l6_dp3
				expert12_l6_dp3 -> expert_agg_l6_dp3
				expert13_l6_dp3 -> expert_agg_l6_dp3
				expert14_l6_dp3 -> expert_agg_l6_dp3
				expert15_l6_dp3 -> expert_agg_l6_dp3
				layer6_output_dp3 [label="Layer 6 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l6_dp3 -> layer6_output_dp3
			}
			layer6_output_dp3 -> attn_input_l7_dp3
			subgraph layer7_dp3_stage1 {
				label="Layer 7" style=rounded
				attn_input_l7_dp3 [label="Attention Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp3 [label="Attention TP0 L7\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp3 -> attn_tp0_l7_dp3
				attn_tp1_l7_dp3 [label="Attention TP1 L7\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp3 -> attn_tp1_l7_dp3
				attn_tp2_l7_dp3 [label="Attention TP2 L7\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp3 -> attn_tp2_l7_dp3
				attn_tp3_l7_dp3 [label="Attention TP3 L7\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l7_dp3 -> attn_tp3_l7_dp3
				allreduce_l7_dp3 [label="AllReduce L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l7_dp3 -> allreduce_l7_dp3
				attn_tp1_l7_dp3 -> allreduce_l7_dp3
				attn_tp2_l7_dp3 -> allreduce_l7_dp3
				attn_tp3_l7_dp3 -> allreduce_l7_dp3
				moe_input_l7_dp3 [label="MoE Input L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l7_dp3 [label="Router L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l7_dp3 -> moe_input_l7_dp3
				moe_input_l7_dp3 -> router_l7_dp3
				expert0_l7_dp3 [label="Expert 0 L7\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert0_l7_dp3 [label=select style=dashed]
				expert1_l7_dp3 [label="Expert 1 L7\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert1_l7_dp3 [label=select style=dashed]
				expert2_l7_dp3 [label="Expert 2 L7\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert2_l7_dp3 [label=select style=dashed]
				expert3_l7_dp3 [label="Expert 3 L7\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert3_l7_dp3 [label=select style=dashed]
				expert4_l7_dp3 [label="Expert 4 L7\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert4_l7_dp3 [label=select style=dashed]
				expert5_l7_dp3 [label="Expert 5 L7\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert5_l7_dp3 [label=select style=dashed]
				expert6_l7_dp3 [label="Expert 6 L7\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert6_l7_dp3 [label=select style=dashed]
				expert7_l7_dp3 [label="Expert 7 L7\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert7_l7_dp3 [label=select style=dashed]
				expert8_l7_dp3 [label="Expert 8 L7\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert8_l7_dp3 [label=select style=dashed]
				expert9_l7_dp3 [label="Expert 9 L7\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert9_l7_dp3 [label=select style=dashed]
				expert10_l7_dp3 [label="Expert 10 L7\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert10_l7_dp3 [label=select style=dashed]
				expert11_l7_dp3 [label="Expert 11 L7\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert11_l7_dp3 [label=select style=dashed]
				expert12_l7_dp3 [label="Expert 12 L7\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert12_l7_dp3 [label=select style=dashed]
				expert13_l7_dp3 [label="Expert 13 L7\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert13_l7_dp3 [label=select style=dashed]
				expert14_l7_dp3 [label="Expert 14 L7\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert14_l7_dp3 [label=select style=dashed]
				expert15_l7_dp3 [label="Expert 15 L7\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l7_dp3 -> expert15_l7_dp3 [label=select style=dashed]
				expert_agg_l7_dp3 [label="Expert Aggregation L7\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l7_dp3 -> expert_agg_l7_dp3
				expert1_l7_dp3 -> expert_agg_l7_dp3
				expert2_l7_dp3 -> expert_agg_l7_dp3
				expert3_l7_dp3 -> expert_agg_l7_dp3
				expert4_l7_dp3 -> expert_agg_l7_dp3
				expert5_l7_dp3 -> expert_agg_l7_dp3
				expert6_l7_dp3 -> expert_agg_l7_dp3
				expert7_l7_dp3 -> expert_agg_l7_dp3
				expert8_l7_dp3 -> expert_agg_l7_dp3
				expert9_l7_dp3 -> expert_agg_l7_dp3
				expert10_l7_dp3 -> expert_agg_l7_dp3
				expert11_l7_dp3 -> expert_agg_l7_dp3
				expert12_l7_dp3 -> expert_agg_l7_dp3
				expert13_l7_dp3 -> expert_agg_l7_dp3
				expert14_l7_dp3 -> expert_agg_l7_dp3
				expert15_l7_dp3 -> expert_agg_l7_dp3
				layer7_output_dp3 [label="Layer 7 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l7_dp3 -> layer7_output_dp3
			}
			layer7_output_dp3 -> attn_input_l8_dp3
			subgraph layer8_dp3_stage1 {
				label="Layer 8" style=rounded
				attn_input_l8_dp3 [label="Attention Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp3 [label="Attention TP0 L8\nGPU 96\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp3 -> attn_tp0_l8_dp3
				attn_tp1_l8_dp3 [label="Attention TP1 L8\nGPU 97\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp3 -> attn_tp1_l8_dp3
				attn_tp2_l8_dp3 [label="Attention TP2 L8\nGPU 98\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp3 -> attn_tp2_l8_dp3
				attn_tp3_l8_dp3 [label="Attention TP3 L8\nGPU 99\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l8_dp3 -> attn_tp3_l8_dp3
				allreduce_l8_dp3 [label="AllReduce L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l8_dp3 -> allreduce_l8_dp3
				attn_tp1_l8_dp3 -> allreduce_l8_dp3
				attn_tp2_l8_dp3 -> allreduce_l8_dp3
				attn_tp3_l8_dp3 -> allreduce_l8_dp3
				moe_input_l8_dp3 [label="MoE Input L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l8_dp3 [label="Router L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l8_dp3 -> moe_input_l8_dp3
				moe_input_l8_dp3 -> router_l8_dp3
				expert0_l8_dp3 [label="Expert 0 L8\nGPU 96\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert0_l8_dp3 [label=select style=dashed]
				expert1_l8_dp3 [label="Expert 1 L8\nGPU 97\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert1_l8_dp3 [label=select style=dashed]
				expert2_l8_dp3 [label="Expert 2 L8\nGPU 98\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert2_l8_dp3 [label=select style=dashed]
				expert3_l8_dp3 [label="Expert 3 L8\nGPU 99\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert3_l8_dp3 [label=select style=dashed]
				expert4_l8_dp3 [label="Expert 4 L8\nGPU 100\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert4_l8_dp3 [label=select style=dashed]
				expert5_l8_dp3 [label="Expert 5 L8\nGPU 101\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert5_l8_dp3 [label=select style=dashed]
				expert6_l8_dp3 [label="Expert 6 L8\nGPU 102\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert6_l8_dp3 [label=select style=dashed]
				expert7_l8_dp3 [label="Expert 7 L8\nGPU 103\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert7_l8_dp3 [label=select style=dashed]
				expert8_l8_dp3 [label="Expert 8 L8\nGPU 104\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert8_l8_dp3 [label=select style=dashed]
				expert9_l8_dp3 [label="Expert 9 L8\nGPU 105\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert9_l8_dp3 [label=select style=dashed]
				expert10_l8_dp3 [label="Expert 10 L8\nGPU 106\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert10_l8_dp3 [label=select style=dashed]
				expert11_l8_dp3 [label="Expert 11 L8\nGPU 107\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert11_l8_dp3 [label=select style=dashed]
				expert12_l8_dp3 [label="Expert 12 L8\nGPU 108\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert12_l8_dp3 [label=select style=dashed]
				expert13_l8_dp3 [label="Expert 13 L8\nGPU 109\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert13_l8_dp3 [label=select style=dashed]
				expert14_l8_dp3 [label="Expert 14 L8\nGPU 110\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert14_l8_dp3 [label=select style=dashed]
				expert15_l8_dp3 [label="Expert 15 L8\nGPU 111\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l8_dp3 -> expert15_l8_dp3 [label=select style=dashed]
				expert_agg_l8_dp3 [label="Expert Aggregation L8\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l8_dp3 -> expert_agg_l8_dp3
				expert1_l8_dp3 -> expert_agg_l8_dp3
				expert2_l8_dp3 -> expert_agg_l8_dp3
				expert3_l8_dp3 -> expert_agg_l8_dp3
				expert4_l8_dp3 -> expert_agg_l8_dp3
				expert5_l8_dp3 -> expert_agg_l8_dp3
				expert6_l8_dp3 -> expert_agg_l8_dp3
				expert7_l8_dp3 -> expert_agg_l8_dp3
				expert8_l8_dp3 -> expert_agg_l8_dp3
				expert9_l8_dp3 -> expert_agg_l8_dp3
				expert10_l8_dp3 -> expert_agg_l8_dp3
				expert11_l8_dp3 -> expert_agg_l8_dp3
				expert12_l8_dp3 -> expert_agg_l8_dp3
				expert13_l8_dp3 -> expert_agg_l8_dp3
				expert14_l8_dp3 -> expert_agg_l8_dp3
				expert15_l8_dp3 -> expert_agg_l8_dp3
				layer8_output_dp3 [label="Layer 8 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l8_dp3 -> layer8_output_dp3
			}
			stage1_output_dp3 [label="Stage 1 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer8_output_dp3 -> stage1_output_dp3
		}
		stage1_output_dp3 -> stage2_input_dp3 [lhead=stage2_dp3]
		subgraph stage2_dp3 {
			fillcolor=lightcyan label="PP Stage 2 (Layers 9-16)" style="rounded,filled"
			stage2_input_dp3 [label="Stage 2 Input\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			stage2_input_dp3 -> attn_input_l9_dp3
			subgraph layer9_dp3_stage2 {
				label="Layer 9" style=rounded
				attn_input_l9_dp3 [label="Attention Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp3 [label="Attention TP0 L9\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp3 -> attn_tp0_l9_dp3
				attn_tp1_l9_dp3 [label="Attention TP1 L9\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp3 -> attn_tp1_l9_dp3
				attn_tp2_l9_dp3 [label="Attention TP2 L9\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp3 -> attn_tp2_l9_dp3
				attn_tp3_l9_dp3 [label="Attention TP3 L9\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l9_dp3 -> attn_tp3_l9_dp3
				allreduce_l9_dp3 [label="AllReduce L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l9_dp3 -> allreduce_l9_dp3
				attn_tp1_l9_dp3 -> allreduce_l9_dp3
				attn_tp2_l9_dp3 -> allreduce_l9_dp3
				attn_tp3_l9_dp3 -> allreduce_l9_dp3
				moe_input_l9_dp3 [label="MoE Input L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l9_dp3 [label="Router L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l9_dp3 -> moe_input_l9_dp3
				moe_input_l9_dp3 -> router_l9_dp3
				expert0_l9_dp3 [label="Expert 0 L9\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert0_l9_dp3 [label=select style=dashed]
				expert1_l9_dp3 [label="Expert 1 L9\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert1_l9_dp3 [label=select style=dashed]
				expert2_l9_dp3 [label="Expert 2 L9\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert2_l9_dp3 [label=select style=dashed]
				expert3_l9_dp3 [label="Expert 3 L9\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert3_l9_dp3 [label=select style=dashed]
				expert4_l9_dp3 [label="Expert 4 L9\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert4_l9_dp3 [label=select style=dashed]
				expert5_l9_dp3 [label="Expert 5 L9\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert5_l9_dp3 [label=select style=dashed]
				expert6_l9_dp3 [label="Expert 6 L9\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert6_l9_dp3 [label=select style=dashed]
				expert7_l9_dp3 [label="Expert 7 L9\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert7_l9_dp3 [label=select style=dashed]
				expert8_l9_dp3 [label="Expert 8 L9\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert8_l9_dp3 [label=select style=dashed]
				expert9_l9_dp3 [label="Expert 9 L9\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert9_l9_dp3 [label=select style=dashed]
				expert10_l9_dp3 [label="Expert 10 L9\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert10_l9_dp3 [label=select style=dashed]
				expert11_l9_dp3 [label="Expert 11 L9\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert11_l9_dp3 [label=select style=dashed]
				expert12_l9_dp3 [label="Expert 12 L9\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert12_l9_dp3 [label=select style=dashed]
				expert13_l9_dp3 [label="Expert 13 L9\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert13_l9_dp3 [label=select style=dashed]
				expert14_l9_dp3 [label="Expert 14 L9\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert14_l9_dp3 [label=select style=dashed]
				expert15_l9_dp3 [label="Expert 15 L9\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l9_dp3 -> expert15_l9_dp3 [label=select style=dashed]
				expert_agg_l9_dp3 [label="Expert Aggregation L9\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l9_dp3 -> expert_agg_l9_dp3
				expert1_l9_dp3 -> expert_agg_l9_dp3
				expert2_l9_dp3 -> expert_agg_l9_dp3
				expert3_l9_dp3 -> expert_agg_l9_dp3
				expert4_l9_dp3 -> expert_agg_l9_dp3
				expert5_l9_dp3 -> expert_agg_l9_dp3
				expert6_l9_dp3 -> expert_agg_l9_dp3
				expert7_l9_dp3 -> expert_agg_l9_dp3
				expert8_l9_dp3 -> expert_agg_l9_dp3
				expert9_l9_dp3 -> expert_agg_l9_dp3
				expert10_l9_dp3 -> expert_agg_l9_dp3
				expert11_l9_dp3 -> expert_agg_l9_dp3
				expert12_l9_dp3 -> expert_agg_l9_dp3
				expert13_l9_dp3 -> expert_agg_l9_dp3
				expert14_l9_dp3 -> expert_agg_l9_dp3
				expert15_l9_dp3 -> expert_agg_l9_dp3
				layer9_output_dp3 [label="Layer 9 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l9_dp3 -> layer9_output_dp3
			}
			layer9_output_dp3 -> attn_input_l10_dp3
			subgraph layer10_dp3_stage2 {
				label="Layer 10" style=rounded
				attn_input_l10_dp3 [label="Attention Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp3 [label="Attention TP0 L10\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp3 -> attn_tp0_l10_dp3
				attn_tp1_l10_dp3 [label="Attention TP1 L10\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp3 -> attn_tp1_l10_dp3
				attn_tp2_l10_dp3 [label="Attention TP2 L10\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp3 -> attn_tp2_l10_dp3
				attn_tp3_l10_dp3 [label="Attention TP3 L10\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l10_dp3 -> attn_tp3_l10_dp3
				allreduce_l10_dp3 [label="AllReduce L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l10_dp3 -> allreduce_l10_dp3
				attn_tp1_l10_dp3 -> allreduce_l10_dp3
				attn_tp2_l10_dp3 -> allreduce_l10_dp3
				attn_tp3_l10_dp3 -> allreduce_l10_dp3
				moe_input_l10_dp3 [label="MoE Input L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l10_dp3 [label="Router L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l10_dp3 -> moe_input_l10_dp3
				moe_input_l10_dp3 -> router_l10_dp3
				expert0_l10_dp3 [label="Expert 0 L10\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert0_l10_dp3 [label=select style=dashed]
				expert1_l10_dp3 [label="Expert 1 L10\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert1_l10_dp3 [label=select style=dashed]
				expert2_l10_dp3 [label="Expert 2 L10\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert2_l10_dp3 [label=select style=dashed]
				expert3_l10_dp3 [label="Expert 3 L10\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert3_l10_dp3 [label=select style=dashed]
				expert4_l10_dp3 [label="Expert 4 L10\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert4_l10_dp3 [label=select style=dashed]
				expert5_l10_dp3 [label="Expert 5 L10\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert5_l10_dp3 [label=select style=dashed]
				expert6_l10_dp3 [label="Expert 6 L10\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert6_l10_dp3 [label=select style=dashed]
				expert7_l10_dp3 [label="Expert 7 L10\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert7_l10_dp3 [label=select style=dashed]
				expert8_l10_dp3 [label="Expert 8 L10\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert8_l10_dp3 [label=select style=dashed]
				expert9_l10_dp3 [label="Expert 9 L10\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert9_l10_dp3 [label=select style=dashed]
				expert10_l10_dp3 [label="Expert 10 L10\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert10_l10_dp3 [label=select style=dashed]
				expert11_l10_dp3 [label="Expert 11 L10\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert11_l10_dp3 [label=select style=dashed]
				expert12_l10_dp3 [label="Expert 12 L10\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert12_l10_dp3 [label=select style=dashed]
				expert13_l10_dp3 [label="Expert 13 L10\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert13_l10_dp3 [label=select style=dashed]
				expert14_l10_dp3 [label="Expert 14 L10\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert14_l10_dp3 [label=select style=dashed]
				expert15_l10_dp3 [label="Expert 15 L10\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l10_dp3 -> expert15_l10_dp3 [label=select style=dashed]
				expert_agg_l10_dp3 [label="Expert Aggregation L10\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l10_dp3 -> expert_agg_l10_dp3
				expert1_l10_dp3 -> expert_agg_l10_dp3
				expert2_l10_dp3 -> expert_agg_l10_dp3
				expert3_l10_dp3 -> expert_agg_l10_dp3
				expert4_l10_dp3 -> expert_agg_l10_dp3
				expert5_l10_dp3 -> expert_agg_l10_dp3
				expert6_l10_dp3 -> expert_agg_l10_dp3
				expert7_l10_dp3 -> expert_agg_l10_dp3
				expert8_l10_dp3 -> expert_agg_l10_dp3
				expert9_l10_dp3 -> expert_agg_l10_dp3
				expert10_l10_dp3 -> expert_agg_l10_dp3
				expert11_l10_dp3 -> expert_agg_l10_dp3
				expert12_l10_dp3 -> expert_agg_l10_dp3
				expert13_l10_dp3 -> expert_agg_l10_dp3
				expert14_l10_dp3 -> expert_agg_l10_dp3
				expert15_l10_dp3 -> expert_agg_l10_dp3
				layer10_output_dp3 [label="Layer 10 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l10_dp3 -> layer10_output_dp3
			}
			layer10_output_dp3 -> attn_input_l11_dp3
			subgraph layer11_dp3_stage2 {
				label="Layer 11" style=rounded
				attn_input_l11_dp3 [label="Attention Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp3 [label="Attention TP0 L11\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp3 -> attn_tp0_l11_dp3
				attn_tp1_l11_dp3 [label="Attention TP1 L11\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp3 -> attn_tp1_l11_dp3
				attn_tp2_l11_dp3 [label="Attention TP2 L11\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp3 -> attn_tp2_l11_dp3
				attn_tp3_l11_dp3 [label="Attention TP3 L11\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l11_dp3 -> attn_tp3_l11_dp3
				allreduce_l11_dp3 [label="AllReduce L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l11_dp3 -> allreduce_l11_dp3
				attn_tp1_l11_dp3 -> allreduce_l11_dp3
				attn_tp2_l11_dp3 -> allreduce_l11_dp3
				attn_tp3_l11_dp3 -> allreduce_l11_dp3
				moe_input_l11_dp3 [label="MoE Input L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l11_dp3 [label="Router L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l11_dp3 -> moe_input_l11_dp3
				moe_input_l11_dp3 -> router_l11_dp3
				expert0_l11_dp3 [label="Expert 0 L11\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert0_l11_dp3 [label=select style=dashed]
				expert1_l11_dp3 [label="Expert 1 L11\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert1_l11_dp3 [label=select style=dashed]
				expert2_l11_dp3 [label="Expert 2 L11\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert2_l11_dp3 [label=select style=dashed]
				expert3_l11_dp3 [label="Expert 3 L11\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert3_l11_dp3 [label=select style=dashed]
				expert4_l11_dp3 [label="Expert 4 L11\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert4_l11_dp3 [label=select style=dashed]
				expert5_l11_dp3 [label="Expert 5 L11\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert5_l11_dp3 [label=select style=dashed]
				expert6_l11_dp3 [label="Expert 6 L11\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert6_l11_dp3 [label=select style=dashed]
				expert7_l11_dp3 [label="Expert 7 L11\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert7_l11_dp3 [label=select style=dashed]
				expert8_l11_dp3 [label="Expert 8 L11\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert8_l11_dp3 [label=select style=dashed]
				expert9_l11_dp3 [label="Expert 9 L11\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert9_l11_dp3 [label=select style=dashed]
				expert10_l11_dp3 [label="Expert 10 L11\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert10_l11_dp3 [label=select style=dashed]
				expert11_l11_dp3 [label="Expert 11 L11\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert11_l11_dp3 [label=select style=dashed]
				expert12_l11_dp3 [label="Expert 12 L11\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert12_l11_dp3 [label=select style=dashed]
				expert13_l11_dp3 [label="Expert 13 L11\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert13_l11_dp3 [label=select style=dashed]
				expert14_l11_dp3 [label="Expert 14 L11\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert14_l11_dp3 [label=select style=dashed]
				expert15_l11_dp3 [label="Expert 15 L11\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l11_dp3 -> expert15_l11_dp3 [label=select style=dashed]
				expert_agg_l11_dp3 [label="Expert Aggregation L11\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l11_dp3 -> expert_agg_l11_dp3
				expert1_l11_dp3 -> expert_agg_l11_dp3
				expert2_l11_dp3 -> expert_agg_l11_dp3
				expert3_l11_dp3 -> expert_agg_l11_dp3
				expert4_l11_dp3 -> expert_agg_l11_dp3
				expert5_l11_dp3 -> expert_agg_l11_dp3
				expert6_l11_dp3 -> expert_agg_l11_dp3
				expert7_l11_dp3 -> expert_agg_l11_dp3
				expert8_l11_dp3 -> expert_agg_l11_dp3
				expert9_l11_dp3 -> expert_agg_l11_dp3
				expert10_l11_dp3 -> expert_agg_l11_dp3
				expert11_l11_dp3 -> expert_agg_l11_dp3
				expert12_l11_dp3 -> expert_agg_l11_dp3
				expert13_l11_dp3 -> expert_agg_l11_dp3
				expert14_l11_dp3 -> expert_agg_l11_dp3
				expert15_l11_dp3 -> expert_agg_l11_dp3
				layer11_output_dp3 [label="Layer 11 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l11_dp3 -> layer11_output_dp3
			}
			layer11_output_dp3 -> attn_input_l12_dp3
			subgraph layer12_dp3_stage2 {
				label="Layer 12" style=rounded
				attn_input_l12_dp3 [label="Attention Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp3 [label="Attention TP0 L12\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp3 -> attn_tp0_l12_dp3
				attn_tp1_l12_dp3 [label="Attention TP1 L12\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp3 -> attn_tp1_l12_dp3
				attn_tp2_l12_dp3 [label="Attention TP2 L12\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp3 -> attn_tp2_l12_dp3
				attn_tp3_l12_dp3 [label="Attention TP3 L12\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l12_dp3 -> attn_tp3_l12_dp3
				allreduce_l12_dp3 [label="AllReduce L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l12_dp3 -> allreduce_l12_dp3
				attn_tp1_l12_dp3 -> allreduce_l12_dp3
				attn_tp2_l12_dp3 -> allreduce_l12_dp3
				attn_tp3_l12_dp3 -> allreduce_l12_dp3
				moe_input_l12_dp3 [label="MoE Input L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l12_dp3 [label="Router L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l12_dp3 -> moe_input_l12_dp3
				moe_input_l12_dp3 -> router_l12_dp3
				expert0_l12_dp3 [label="Expert 0 L12\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert0_l12_dp3 [label=select style=dashed]
				expert1_l12_dp3 [label="Expert 1 L12\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert1_l12_dp3 [label=select style=dashed]
				expert2_l12_dp3 [label="Expert 2 L12\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert2_l12_dp3 [label=select style=dashed]
				expert3_l12_dp3 [label="Expert 3 L12\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert3_l12_dp3 [label=select style=dashed]
				expert4_l12_dp3 [label="Expert 4 L12\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert4_l12_dp3 [label=select style=dashed]
				expert5_l12_dp3 [label="Expert 5 L12\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert5_l12_dp3 [label=select style=dashed]
				expert6_l12_dp3 [label="Expert 6 L12\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert6_l12_dp3 [label=select style=dashed]
				expert7_l12_dp3 [label="Expert 7 L12\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert7_l12_dp3 [label=select style=dashed]
				expert8_l12_dp3 [label="Expert 8 L12\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert8_l12_dp3 [label=select style=dashed]
				expert9_l12_dp3 [label="Expert 9 L12\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert9_l12_dp3 [label=select style=dashed]
				expert10_l12_dp3 [label="Expert 10 L12\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert10_l12_dp3 [label=select style=dashed]
				expert11_l12_dp3 [label="Expert 11 L12\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert11_l12_dp3 [label=select style=dashed]
				expert12_l12_dp3 [label="Expert 12 L12\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert12_l12_dp3 [label=select style=dashed]
				expert13_l12_dp3 [label="Expert 13 L12\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert13_l12_dp3 [label=select style=dashed]
				expert14_l12_dp3 [label="Expert 14 L12\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert14_l12_dp3 [label=select style=dashed]
				expert15_l12_dp3 [label="Expert 15 L12\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l12_dp3 -> expert15_l12_dp3 [label=select style=dashed]
				expert_agg_l12_dp3 [label="Expert Aggregation L12\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l12_dp3 -> expert_agg_l12_dp3
				expert1_l12_dp3 -> expert_agg_l12_dp3
				expert2_l12_dp3 -> expert_agg_l12_dp3
				expert3_l12_dp3 -> expert_agg_l12_dp3
				expert4_l12_dp3 -> expert_agg_l12_dp3
				expert5_l12_dp3 -> expert_agg_l12_dp3
				expert6_l12_dp3 -> expert_agg_l12_dp3
				expert7_l12_dp3 -> expert_agg_l12_dp3
				expert8_l12_dp3 -> expert_agg_l12_dp3
				expert9_l12_dp3 -> expert_agg_l12_dp3
				expert10_l12_dp3 -> expert_agg_l12_dp3
				expert11_l12_dp3 -> expert_agg_l12_dp3
				expert12_l12_dp3 -> expert_agg_l12_dp3
				expert13_l12_dp3 -> expert_agg_l12_dp3
				expert14_l12_dp3 -> expert_agg_l12_dp3
				expert15_l12_dp3 -> expert_agg_l12_dp3
				layer12_output_dp3 [label="Layer 12 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l12_dp3 -> layer12_output_dp3
			}
			layer12_output_dp3 -> attn_input_l13_dp3
			subgraph layer13_dp3_stage2 {
				label="Layer 13" style=rounded
				attn_input_l13_dp3 [label="Attention Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp3 [label="Attention TP0 L13\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp3 -> attn_tp0_l13_dp3
				attn_tp1_l13_dp3 [label="Attention TP1 L13\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp3 -> attn_tp1_l13_dp3
				attn_tp2_l13_dp3 [label="Attention TP2 L13\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp3 -> attn_tp2_l13_dp3
				attn_tp3_l13_dp3 [label="Attention TP3 L13\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l13_dp3 -> attn_tp3_l13_dp3
				allreduce_l13_dp3 [label="AllReduce L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l13_dp3 -> allreduce_l13_dp3
				attn_tp1_l13_dp3 -> allreduce_l13_dp3
				attn_tp2_l13_dp3 -> allreduce_l13_dp3
				attn_tp3_l13_dp3 -> allreduce_l13_dp3
				moe_input_l13_dp3 [label="MoE Input L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l13_dp3 [label="Router L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l13_dp3 -> moe_input_l13_dp3
				moe_input_l13_dp3 -> router_l13_dp3
				expert0_l13_dp3 [label="Expert 0 L13\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert0_l13_dp3 [label=select style=dashed]
				expert1_l13_dp3 [label="Expert 1 L13\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert1_l13_dp3 [label=select style=dashed]
				expert2_l13_dp3 [label="Expert 2 L13\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert2_l13_dp3 [label=select style=dashed]
				expert3_l13_dp3 [label="Expert 3 L13\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert3_l13_dp3 [label=select style=dashed]
				expert4_l13_dp3 [label="Expert 4 L13\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert4_l13_dp3 [label=select style=dashed]
				expert5_l13_dp3 [label="Expert 5 L13\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert5_l13_dp3 [label=select style=dashed]
				expert6_l13_dp3 [label="Expert 6 L13\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert6_l13_dp3 [label=select style=dashed]
				expert7_l13_dp3 [label="Expert 7 L13\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert7_l13_dp3 [label=select style=dashed]
				expert8_l13_dp3 [label="Expert 8 L13\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert8_l13_dp3 [label=select style=dashed]
				expert9_l13_dp3 [label="Expert 9 L13\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert9_l13_dp3 [label=select style=dashed]
				expert10_l13_dp3 [label="Expert 10 L13\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert10_l13_dp3 [label=select style=dashed]
				expert11_l13_dp3 [label="Expert 11 L13\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert11_l13_dp3 [label=select style=dashed]
				expert12_l13_dp3 [label="Expert 12 L13\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert12_l13_dp3 [label=select style=dashed]
				expert13_l13_dp3 [label="Expert 13 L13\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert13_l13_dp3 [label=select style=dashed]
				expert14_l13_dp3 [label="Expert 14 L13\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert14_l13_dp3 [label=select style=dashed]
				expert15_l13_dp3 [label="Expert 15 L13\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l13_dp3 -> expert15_l13_dp3 [label=select style=dashed]
				expert_agg_l13_dp3 [label="Expert Aggregation L13\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l13_dp3 -> expert_agg_l13_dp3
				expert1_l13_dp3 -> expert_agg_l13_dp3
				expert2_l13_dp3 -> expert_agg_l13_dp3
				expert3_l13_dp3 -> expert_agg_l13_dp3
				expert4_l13_dp3 -> expert_agg_l13_dp3
				expert5_l13_dp3 -> expert_agg_l13_dp3
				expert6_l13_dp3 -> expert_agg_l13_dp3
				expert7_l13_dp3 -> expert_agg_l13_dp3
				expert8_l13_dp3 -> expert_agg_l13_dp3
				expert9_l13_dp3 -> expert_agg_l13_dp3
				expert10_l13_dp3 -> expert_agg_l13_dp3
				expert11_l13_dp3 -> expert_agg_l13_dp3
				expert12_l13_dp3 -> expert_agg_l13_dp3
				expert13_l13_dp3 -> expert_agg_l13_dp3
				expert14_l13_dp3 -> expert_agg_l13_dp3
				expert15_l13_dp3 -> expert_agg_l13_dp3
				layer13_output_dp3 [label="Layer 13 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l13_dp3 -> layer13_output_dp3
			}
			layer13_output_dp3 -> attn_input_l14_dp3
			subgraph layer14_dp3_stage2 {
				label="Layer 14" style=rounded
				attn_input_l14_dp3 [label="Attention Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp3 [label="Attention TP0 L14\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp3 -> attn_tp0_l14_dp3
				attn_tp1_l14_dp3 [label="Attention TP1 L14\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp3 -> attn_tp1_l14_dp3
				attn_tp2_l14_dp3 [label="Attention TP2 L14\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp3 -> attn_tp2_l14_dp3
				attn_tp3_l14_dp3 [label="Attention TP3 L14\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l14_dp3 -> attn_tp3_l14_dp3
				allreduce_l14_dp3 [label="AllReduce L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l14_dp3 -> allreduce_l14_dp3
				attn_tp1_l14_dp3 -> allreduce_l14_dp3
				attn_tp2_l14_dp3 -> allreduce_l14_dp3
				attn_tp3_l14_dp3 -> allreduce_l14_dp3
				moe_input_l14_dp3 [label="MoE Input L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l14_dp3 [label="Router L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l14_dp3 -> moe_input_l14_dp3
				moe_input_l14_dp3 -> router_l14_dp3
				expert0_l14_dp3 [label="Expert 0 L14\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert0_l14_dp3 [label=select style=dashed]
				expert1_l14_dp3 [label="Expert 1 L14\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert1_l14_dp3 [label=select style=dashed]
				expert2_l14_dp3 [label="Expert 2 L14\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert2_l14_dp3 [label=select style=dashed]
				expert3_l14_dp3 [label="Expert 3 L14\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert3_l14_dp3 [label=select style=dashed]
				expert4_l14_dp3 [label="Expert 4 L14\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert4_l14_dp3 [label=select style=dashed]
				expert5_l14_dp3 [label="Expert 5 L14\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert5_l14_dp3 [label=select style=dashed]
				expert6_l14_dp3 [label="Expert 6 L14\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert6_l14_dp3 [label=select style=dashed]
				expert7_l14_dp3 [label="Expert 7 L14\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert7_l14_dp3 [label=select style=dashed]
				expert8_l14_dp3 [label="Expert 8 L14\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert8_l14_dp3 [label=select style=dashed]
				expert9_l14_dp3 [label="Expert 9 L14\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert9_l14_dp3 [label=select style=dashed]
				expert10_l14_dp3 [label="Expert 10 L14\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert10_l14_dp3 [label=select style=dashed]
				expert11_l14_dp3 [label="Expert 11 L14\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert11_l14_dp3 [label=select style=dashed]
				expert12_l14_dp3 [label="Expert 12 L14\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert12_l14_dp3 [label=select style=dashed]
				expert13_l14_dp3 [label="Expert 13 L14\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert13_l14_dp3 [label=select style=dashed]
				expert14_l14_dp3 [label="Expert 14 L14\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert14_l14_dp3 [label=select style=dashed]
				expert15_l14_dp3 [label="Expert 15 L14\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l14_dp3 -> expert15_l14_dp3 [label=select style=dashed]
				expert_agg_l14_dp3 [label="Expert Aggregation L14\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l14_dp3 -> expert_agg_l14_dp3
				expert1_l14_dp3 -> expert_agg_l14_dp3
				expert2_l14_dp3 -> expert_agg_l14_dp3
				expert3_l14_dp3 -> expert_agg_l14_dp3
				expert4_l14_dp3 -> expert_agg_l14_dp3
				expert5_l14_dp3 -> expert_agg_l14_dp3
				expert6_l14_dp3 -> expert_agg_l14_dp3
				expert7_l14_dp3 -> expert_agg_l14_dp3
				expert8_l14_dp3 -> expert_agg_l14_dp3
				expert9_l14_dp3 -> expert_agg_l14_dp3
				expert10_l14_dp3 -> expert_agg_l14_dp3
				expert11_l14_dp3 -> expert_agg_l14_dp3
				expert12_l14_dp3 -> expert_agg_l14_dp3
				expert13_l14_dp3 -> expert_agg_l14_dp3
				expert14_l14_dp3 -> expert_agg_l14_dp3
				expert15_l14_dp3 -> expert_agg_l14_dp3
				layer14_output_dp3 [label="Layer 14 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l14_dp3 -> layer14_output_dp3
			}
			layer14_output_dp3 -> attn_input_l15_dp3
			subgraph layer15_dp3_stage2 {
				label="Layer 15" style=rounded
				attn_input_l15_dp3 [label="Attention Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp3 [label="Attention TP0 L15\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp3 -> attn_tp0_l15_dp3
				attn_tp1_l15_dp3 [label="Attention TP1 L15\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp3 -> attn_tp1_l15_dp3
				attn_tp2_l15_dp3 [label="Attention TP2 L15\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp3 -> attn_tp2_l15_dp3
				attn_tp3_l15_dp3 [label="Attention TP3 L15\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l15_dp3 -> attn_tp3_l15_dp3
				allreduce_l15_dp3 [label="AllReduce L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l15_dp3 -> allreduce_l15_dp3
				attn_tp1_l15_dp3 -> allreduce_l15_dp3
				attn_tp2_l15_dp3 -> allreduce_l15_dp3
				attn_tp3_l15_dp3 -> allreduce_l15_dp3
				moe_input_l15_dp3 [label="MoE Input L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l15_dp3 [label="Router L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l15_dp3 -> moe_input_l15_dp3
				moe_input_l15_dp3 -> router_l15_dp3
				expert0_l15_dp3 [label="Expert 0 L15\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert0_l15_dp3 [label=select style=dashed]
				expert1_l15_dp3 [label="Expert 1 L15\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert1_l15_dp3 [label=select style=dashed]
				expert2_l15_dp3 [label="Expert 2 L15\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert2_l15_dp3 [label=select style=dashed]
				expert3_l15_dp3 [label="Expert 3 L15\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert3_l15_dp3 [label=select style=dashed]
				expert4_l15_dp3 [label="Expert 4 L15\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert4_l15_dp3 [label=select style=dashed]
				expert5_l15_dp3 [label="Expert 5 L15\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert5_l15_dp3 [label=select style=dashed]
				expert6_l15_dp3 [label="Expert 6 L15\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert6_l15_dp3 [label=select style=dashed]
				expert7_l15_dp3 [label="Expert 7 L15\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert7_l15_dp3 [label=select style=dashed]
				expert8_l15_dp3 [label="Expert 8 L15\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert8_l15_dp3 [label=select style=dashed]
				expert9_l15_dp3 [label="Expert 9 L15\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert9_l15_dp3 [label=select style=dashed]
				expert10_l15_dp3 [label="Expert 10 L15\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert10_l15_dp3 [label=select style=dashed]
				expert11_l15_dp3 [label="Expert 11 L15\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert11_l15_dp3 [label=select style=dashed]
				expert12_l15_dp3 [label="Expert 12 L15\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert12_l15_dp3 [label=select style=dashed]
				expert13_l15_dp3 [label="Expert 13 L15\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert13_l15_dp3 [label=select style=dashed]
				expert14_l15_dp3 [label="Expert 14 L15\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert14_l15_dp3 [label=select style=dashed]
				expert15_l15_dp3 [label="Expert 15 L15\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l15_dp3 -> expert15_l15_dp3 [label=select style=dashed]
				expert_agg_l15_dp3 [label="Expert Aggregation L15\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l15_dp3 -> expert_agg_l15_dp3
				expert1_l15_dp3 -> expert_agg_l15_dp3
				expert2_l15_dp3 -> expert_agg_l15_dp3
				expert3_l15_dp3 -> expert_agg_l15_dp3
				expert4_l15_dp3 -> expert_agg_l15_dp3
				expert5_l15_dp3 -> expert_agg_l15_dp3
				expert6_l15_dp3 -> expert_agg_l15_dp3
				expert7_l15_dp3 -> expert_agg_l15_dp3
				expert8_l15_dp3 -> expert_agg_l15_dp3
				expert9_l15_dp3 -> expert_agg_l15_dp3
				expert10_l15_dp3 -> expert_agg_l15_dp3
				expert11_l15_dp3 -> expert_agg_l15_dp3
				expert12_l15_dp3 -> expert_agg_l15_dp3
				expert13_l15_dp3 -> expert_agg_l15_dp3
				expert14_l15_dp3 -> expert_agg_l15_dp3
				expert15_l15_dp3 -> expert_agg_l15_dp3
				layer15_output_dp3 [label="Layer 15 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l15_dp3 -> layer15_output_dp3
			}
			layer15_output_dp3 -> attn_input_l16_dp3
			subgraph layer16_dp3_stage2 {
				label="Layer 16" style=rounded
				attn_input_l16_dp3 [label="Attention Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp3 [label="Attention TP0 L16\nGPU 112\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp3 -> attn_tp0_l16_dp3
				attn_tp1_l16_dp3 [label="Attention TP1 L16\nGPU 113\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp3 -> attn_tp1_l16_dp3
				attn_tp2_l16_dp3 [label="Attention TP2 L16\nGPU 114\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp3 -> attn_tp2_l16_dp3
				attn_tp3_l16_dp3 [label="Attention TP3 L16\nGPU 115\nInput: [batch_size=1, seq_len=256, heads=4, d_k=32]\nOutput: [batch_size=1, seq_len=256, heads=4, d_k=32]" fillcolor=lightgreen shape=rectangle]
				attn_input_l16_dp3 -> attn_tp3_l16_dp3
				allreduce_l16_dp3 [label="AllReduce L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				attn_tp0_l16_dp3 -> allreduce_l16_dp3
				attn_tp1_l16_dp3 -> allreduce_l16_dp3
				attn_tp2_l16_dp3 -> allreduce_l16_dp3
				attn_tp3_l16_dp3 -> allreduce_l16_dp3
				moe_input_l16_dp3 [label="MoE Input L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				router_l16_dp3 [label="Router L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				allreduce_l16_dp3 -> moe_input_l16_dp3
				moe_input_l16_dp3 -> router_l16_dp3
				expert0_l16_dp3 [label="Expert 0 L16\nGPU 112\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert0_l16_dp3 [label=select style=dashed]
				expert1_l16_dp3 [label="Expert 1 L16\nGPU 113\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert1_l16_dp3 [label=select style=dashed]
				expert2_l16_dp3 [label="Expert 2 L16\nGPU 114\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert2_l16_dp3 [label=select style=dashed]
				expert3_l16_dp3 [label="Expert 3 L16\nGPU 115\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert3_l16_dp3 [label=select style=dashed]
				expert4_l16_dp3 [label="Expert 4 L16\nGPU 116\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert4_l16_dp3 [label=select style=dashed]
				expert5_l16_dp3 [label="Expert 5 L16\nGPU 117\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert5_l16_dp3 [label=select style=dashed]
				expert6_l16_dp3 [label="Expert 6 L16\nGPU 118\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert6_l16_dp3 [label=select style=dashed]
				expert7_l16_dp3 [label="Expert 7 L16\nGPU 119\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert7_l16_dp3 [label=select style=dashed]
				expert8_l16_dp3 [label="Expert 8 L16\nGPU 120\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert8_l16_dp3 [label=select style=dashed]
				expert9_l16_dp3 [label="Expert 9 L16\nGPU 121\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert9_l16_dp3 [label=select style=dashed]
				expert10_l16_dp3 [label="Expert 10 L16\nGPU 122\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert10_l16_dp3 [label=select style=dashed]
				expert11_l16_dp3 [label="Expert 11 L16\nGPU 123\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert11_l16_dp3 [label=select style=dashed]
				expert12_l16_dp3 [label="Expert 12 L16\nGPU 124\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert12_l16_dp3 [label=select style=dashed]
				expert13_l16_dp3 [label="Expert 13 L16\nGPU 125\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert13_l16_dp3 [label=select style=dashed]
				expert14_l16_dp3 [label="Expert 14 L16\nGPU 126\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert14_l16_dp3 [label=select style=dashed]
				expert15_l16_dp3 [label="Expert 15 L16\nGPU 127\nInput: [batch_size=1, seq_len=64, hidden=512]\nOutput: [batch_size=1, seq_len=64, hidden=512]" fillcolor=lightgreen shape=rectangle]
				router_l16_dp3 -> expert15_l16_dp3 [label=select style=dashed]
				expert_agg_l16_dp3 [label="Expert Aggregation L16\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightyellow shape=parallelogram]
				expert0_l16_dp3 -> expert_agg_l16_dp3
				expert1_l16_dp3 -> expert_agg_l16_dp3
				expert2_l16_dp3 -> expert_agg_l16_dp3
				expert3_l16_dp3 -> expert_agg_l16_dp3
				expert4_l16_dp3 -> expert_agg_l16_dp3
				expert5_l16_dp3 -> expert_agg_l16_dp3
				expert6_l16_dp3 -> expert_agg_l16_dp3
				expert7_l16_dp3 -> expert_agg_l16_dp3
				expert8_l16_dp3 -> expert_agg_l16_dp3
				expert9_l16_dp3 -> expert_agg_l16_dp3
				expert10_l16_dp3 -> expert_agg_l16_dp3
				expert11_l16_dp3 -> expert_agg_l16_dp3
				expert12_l16_dp3 -> expert_agg_l16_dp3
				expert13_l16_dp3 -> expert_agg_l16_dp3
				expert14_l16_dp3 -> expert_agg_l16_dp3
				expert15_l16_dp3 -> expert_agg_l16_dp3
				layer16_output_dp3 [label="Layer 16 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
				expert_agg_l16_dp3 -> layer16_output_dp3
			}
			stage2_output_dp3 [label="Stage 2 Output\nInput: [batch_size=1, seq_len=1024, hidden=512]\nOutput: [batch_size=1, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
			layer16_output_dp3 -> stage2_output_dp3
		}
	}
	output [label="Output\nInput: [batch_size=4, seq_len=1024, hidden=512]\nOutput: [batch_size=4, seq_len=1024, hidden=512]" fillcolor=lightblue shape=ellipse]
	stage2_output_dp0 -> output
	stage2_output_dp1 -> output
	stage2_output_dp2 -> output
	stage2_output_dp3 -> output
}
