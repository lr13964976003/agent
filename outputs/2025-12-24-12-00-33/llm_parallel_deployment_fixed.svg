<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="4139pt" height="9000pt"
 viewBox="0.00 0.00 993.29 2160.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1.74 1.74) rotate(0) translate(4 5163.94)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-5163.94 2372.5,-5163.94 2372.5,4 -4,4"/>
<!-- prefill_start -->
<g id="node1" class="node">
<title>prefill_start</title>
<polygon fill="red" stroke="black" points="204,-5149.67 0,-5149.67 0,-5096.67 204,-5096.67 204,-5149.67"/>
<text text-anchor="middle" x="102" y="-5134.47" font-family="Times,serif" font-size="14.00">PREFILL PHASE</text>
<text text-anchor="middle" x="102" y="-5119.47" font-family="Times,serif" font-size="14.00">PP=4, EP=4, TP=2, SP=2</text>
<text text-anchor="middle" x="102" y="-5104.47" font-family="Times,serif" font-size="14.00">64 GPUs Total</text>
</g>
<!-- input -->
<g id="node2" class="node">
<title>input</title>
<ellipse fill="white" stroke="black" stroke-width="3" cx="422" cy="-5123.17" rx="200.22" ry="28.98"/>
<text text-anchor="middle" x="422" y="-5131.67" font-family="Times,serif" font-size="10.00">INPUT</text>
<text text-anchor="middle" x="422" y="-5120.67" font-family="Times,serif" font-size="10.00">Input: [batch_size=4, seq_len=10240, hidden=512]</text>
<text text-anchor="middle" x="422" y="-5109.67" font-family="Times,serif" font-size="10.00">Output: [batch_size=4, seq_len=10240, hidden=512]</text>
</g>
<!-- sp_split_1 -->
<g id="node4" class="node">
<title>sp_split_1</title>
<polygon fill="lightyellow" stroke="black" points="661.48,-5049.4 280.52,-5049.4 182.52,-4945.4 563.48,-4945.4 661.48,-5049.4"/>
<text text-anchor="middle" x="422" y="-5011.4" font-family="Times,serif" font-size="10.00">SP SPLIT</text>
<text text-anchor="middle" x="422" y="-5000.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="422" y="-4989.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="422" y="-4978.4" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- input&#45;&gt;sp_split_1 -->
<g id="edge1" class="edge">
<title>input&#45;&gt;sp_split_1</title>
<path fill="none" stroke="black" d="M422,-5094.08C422,-5083.83 422,-5071.79 422,-5059.78"/>
<polygon fill="black" stroke="black" points="425.5,-5059.73 422,-5049.73 418.5,-5059.73 425.5,-5059.73"/>
</g>
<!-- stage1_label -->
<g id="node3" class="node">
<title>stage1_label</title>
<polygon fill="purple" stroke="black" points="777.5,-5146.67 642.5,-5146.67 642.5,-5099.67 777.5,-5099.67 777.5,-5146.67"/>
<text text-anchor="middle" x="710" y="-5133.07" font-family="Times,serif" font-size="12.00">PIPELINE STAGE 1</text>
<text text-anchor="middle" x="710" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 1&#45;4</text>
<text text-anchor="middle" x="710" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 0&#45;15</text>
</g>
<!-- layernorm1_1 -->
<g id="node5" class="node">
<title>layernorm1_1</title>
<polygon fill="lightgreen" stroke="black" points="537.5,-4902.9 306.5,-4902.9 306.5,-4850.9 537.5,-4850.9 537.5,-4902.9"/>
<text text-anchor="middle" x="422" y="-4890.9" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="422" y="-4879.9" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="422" y="-4868.9" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="422" y="-4857.9" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- sp_split_1&#45;&gt;layernorm1_1 -->
<g id="edge2" class="edge">
<title>sp_split_1&#45;&gt;layernorm1_1</title>
<path fill="none" stroke="black" d="M422,-4945.11C422,-4934.45 422,-4923.45 422,-4913.5"/>
<polygon fill="black" stroke="black" points="425.5,-4913.2 422,-4903.2 418.5,-4913.2 425.5,-4913.2"/>
</g>
<!-- attn_qkv1_1 -->
<g id="node6" class="node">
<title>attn_qkv1_1</title>
<polygon fill="lightgreen" stroke="black" points="513.5,-4808.4 282.5,-4808.4 282.5,-4745.4 513.5,-4745.4 513.5,-4808.4"/>
<text text-anchor="middle" x="398" y="-4796.4" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="398" y="-4785.4" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="398" y="-4774.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="398" y="-4763.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="398" y="-4752.4" font-family="Times,serif" font-size="10.00">GPU: 0&#45;7</text>
</g>
<!-- layernorm1_1&#45;&gt;attn_qkv1_1 -->
<g id="edge3" class="edge">
<title>layernorm1_1&#45;&gt;attn_qkv1_1</title>
<path fill="none" stroke="black" d="M415.82,-4850.66C413.42,-4840.85 410.6,-4829.36 407.93,-4818.44"/>
<polygon fill="black" stroke="black" points="411.31,-4817.53 405.53,-4808.65 404.51,-4819.19 411.31,-4817.53"/>
</g>
<!-- attn_qkv1_2 -->
<g id="node7" class="node">
<title>attn_qkv1_2</title>
<polygon fill="lightgreen" stroke="black" points="762.5,-4808.4 531.5,-4808.4 531.5,-4745.4 762.5,-4745.4 762.5,-4808.4"/>
<text text-anchor="middle" x="647" y="-4796.4" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="647" y="-4785.4" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="647" y="-4774.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="647" y="-4763.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="647" y="-4752.4" font-family="Times,serif" font-size="10.00">GPU: 8&#45;15</text>
</g>
<!-- layernorm1_1&#45;&gt;attn_qkv1_2 -->
<g id="edge4" class="edge">
<title>layernorm1_1&#45;&gt;attn_qkv1_2</title>
<path fill="none" stroke="black" d="M479.65,-4850.79C506.32,-4839.17 538.44,-4825.18 567.37,-4812.58"/>
<polygon fill="black" stroke="black" points="568.87,-4815.74 576.64,-4808.54 566.08,-4809.33 568.87,-4815.74"/>
</g>
<!-- attn_compute1_1 -->
<g id="node8" class="node">
<title>attn_compute1_1</title>
<polygon fill="lightgreen" stroke="black" points="513.5,-4695.35 282.5,-4695.35 282.5,-4632.35 513.5,-4632.35 513.5,-4695.35"/>
<text text-anchor="middle" x="398" y="-4683.35" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="398" y="-4672.35" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="398" y="-4661.35" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="398" y="-4650.35" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="398" y="-4639.35" font-family="Times,serif" font-size="10.00">GPU: 0&#45;7</text>
</g>
<!-- attn_qkv1_1&#45;&gt;attn_compute1_1 -->
<g id="edge5" class="edge">
<title>attn_qkv1_1&#45;&gt;attn_compute1_1</title>
<path fill="none" stroke="black" d="M398,-4745.26C398,-4733 398,-4718.7 398,-4705.59"/>
<polygon fill="black" stroke="black" points="401.5,-4705.39 398,-4695.39 394.5,-4705.39 401.5,-4705.39"/>
</g>
<!-- attn_compute1_2 -->
<g id="node9" class="node">
<title>attn_compute1_2</title>
<polygon fill="lightgreen" stroke="black" points="762.5,-4695.35 531.5,-4695.35 531.5,-4632.35 762.5,-4632.35 762.5,-4695.35"/>
<text text-anchor="middle" x="647" y="-4683.35" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="647" y="-4672.35" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="647" y="-4661.35" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="647" y="-4650.35" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="647" y="-4639.35" font-family="Times,serif" font-size="10.00">GPU: 8&#45;15</text>
</g>
<!-- attn_qkv1_2&#45;&gt;attn_compute1_2 -->
<g id="edge6" class="edge">
<title>attn_qkv1_2&#45;&gt;attn_compute1_2</title>
<path fill="none" stroke="black" d="M647,-4745.26C647,-4733 647,-4718.7 647,-4705.59"/>
<polygon fill="black" stroke="black" points="650.5,-4705.39 647,-4695.39 643.5,-4705.39 650.5,-4705.39"/>
</g>
<!-- attn_gather1 -->
<g id="node10" class="node">
<title>attn_gather1</title>
<ellipse fill="lightblue" stroke="black" cx="644" cy="-4537.75" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="644" y="-4557.25" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="644" y="-4546.25" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="644" y="-4535.25" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="644" y="-4524.25" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="644" y="-4513.25" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- attn_compute1_1&#45;&gt;attn_gather1 -->
<g id="edge7" class="edge">
<title>attn_compute1_1&#45;&gt;attn_gather1</title>
<path fill="none" stroke="black" d="M458.49,-4632.33C488.66,-4617.11 525.66,-4598.45 558.66,-4581.8"/>
<polygon fill="black" stroke="black" points="560.5,-4584.8 567.85,-4577.17 557.35,-4578.55 560.5,-4584.8"/>
</g>
<!-- attn_compute1_2&#45;&gt;attn_gather1 -->
<g id="edge8" class="edge">
<title>attn_compute1_2&#45;&gt;attn_gather1</title>
<path fill="none" stroke="black" d="M646.26,-4632.17C645.97,-4620.28 645.63,-4606.29 645.31,-4592.82"/>
<polygon fill="black" stroke="black" points="648.8,-4592.57 645.06,-4582.66 641.8,-4592.74 648.8,-4592.57"/>
</g>
<!-- mlp_gate1 -->
<g id="node11" class="node">
<title>mlp_gate1</title>
<polygon fill="lightgreen" stroke="black" points="772,-4441.21 516,-4441.21 516,-4389.21 772,-4389.21 772,-4441.21"/>
<text text-anchor="middle" x="644" y="-4429.21" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="644" y="-4418.21" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="644" y="-4407.21" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, num_experts=16]</text>
<text text-anchor="middle" x="644" y="-4396.21" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- attn_gather1&#45;&gt;mlp_gate1 -->
<g id="edge9" class="edge">
<title>attn_gather1&#45;&gt;mlp_gate1</title>
<path fill="none" stroke="black" d="M644,-4492.89C644,-4479.32 644,-4464.55 644,-4451.63"/>
<polygon fill="black" stroke="black" points="647.5,-4451.28 644,-4441.28 640.5,-4451.28 647.5,-4451.28"/>
</g>
<!-- expert_route1 -->
<g id="node12" class="node">
<title>expert_route1</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="740.34,-4337.21 587.09,-4337.21 547.66,-4255.21 700.91,-4255.21 740.34,-4337.21"/>
<text text-anchor="middle" x="644" y="-4304.71" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="644" y="-4293.71" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="644" y="-4282.71" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- mlp_gate1&#45;&gt;expert_route1 -->
<g id="edge10" class="edge">
<title>mlp_gate1&#45;&gt;expert_route1</title>
<path fill="none" stroke="black" d="M644,-4389.11C644,-4377 644,-4362.03 644,-4347.71"/>
<polygon fill="black" stroke="black" points="647.5,-4347.45 644,-4337.45 640.5,-4347.45 647.5,-4347.45"/>
</g>
<!-- expert1_1 -->
<g id="node13" class="node">
<title>expert1_1</title>
<polygon fill="lightgreen" stroke="black" points="442.5,-4205.16 211.5,-4205.16 211.5,-4142.16 442.5,-4142.16 442.5,-4205.16"/>
<text text-anchor="middle" x="327" y="-4193.16" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="327" y="-4182.16" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="327" y="-4171.16" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="327" y="-4160.16" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="327" y="-4149.16" font-family="Times,serif" font-size="10.00">GPU: 0&#45;3</text>
</g>
<!-- expert_route1&#45;&gt;expert1_1 -->
<g id="edge11" class="edge">
<title>expert_route1&#45;&gt;expert1_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M549.32,-4259.2C507.34,-4243.24 458.2,-4224.55 416.81,-4208.81"/>
<polygon fill="black" stroke="black" points="417.87,-4205.47 407.28,-4205.19 415.38,-4212.01 417.87,-4205.47"/>
</g>
<!-- expert1_2 -->
<g id="node14" class="node">
<title>expert1_2</title>
<polygon fill="lightgreen" stroke="black" points="691.5,-4205.16 460.5,-4205.16 460.5,-4142.16 691.5,-4142.16 691.5,-4205.16"/>
<text text-anchor="middle" x="576" y="-4193.16" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="576" y="-4182.16" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="576" y="-4171.16" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="576" y="-4160.16" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="576" y="-4149.16" font-family="Times,serif" font-size="10.00">GPU: 4&#45;7</text>
</g>
<!-- expert_route1&#45;&gt;expert1_2 -->
<g id="edge12" class="edge">
<title>expert_route1&#45;&gt;expert1_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M621.36,-4255.07C613.95,-4241.93 605.73,-4227.36 598.34,-4214.27"/>
<polygon fill="black" stroke="black" points="601.34,-4212.46 593.38,-4205.47 595.25,-4215.9 601.34,-4212.46"/>
</g>
<!-- expert1_3 -->
<g id="node15" class="node">
<title>expert1_3</title>
<polygon fill="lightgreen" stroke="black" points="940.5,-4205.16 709.5,-4205.16 709.5,-4142.16 940.5,-4142.16 940.5,-4205.16"/>
<text text-anchor="middle" x="825" y="-4193.16" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="825" y="-4182.16" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="825" y="-4171.16" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="825" y="-4160.16" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="825" y="-4149.16" font-family="Times,serif" font-size="10.00">GPU: 8&#45;11</text>
</g>
<!-- expert_route1&#45;&gt;expert1_3 -->
<g id="edge13" class="edge">
<title>expert_route1&#45;&gt;expert1_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M701.77,-4256.73C723.78,-4242.07 748.78,-4225.42 770.48,-4210.97"/>
<polygon fill="black" stroke="black" points="772.55,-4213.8 778.93,-4205.34 768.67,-4207.97 772.55,-4213.8"/>
</g>
<!-- expert1_4 -->
<g id="node16" class="node">
<title>expert1_4</title>
<polygon fill="lightgreen" stroke="black" points="1189.5,-4205.16 958.5,-4205.16 958.5,-4142.16 1189.5,-4142.16 1189.5,-4205.16"/>
<text text-anchor="middle" x="1074" y="-4193.16" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1074" y="-4182.16" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1074" y="-4171.16" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="1074" y="-4160.16" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="1074" y="-4149.16" font-family="Times,serif" font-size="10.00">GPU: 12&#45;15</text>
</g>
<!-- expert_route1&#45;&gt;expert1_4 -->
<g id="edge14" class="edge">
<title>expert_route1&#45;&gt;expert1_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M712.91,-4279.64C775.04,-4265.17 868.7,-4242.28 949,-4218.21 959.11,-4215.17 969.62,-4211.83 980.06,-4208.38"/>
<polygon fill="black" stroke="black" points="981.23,-4211.68 989.61,-4205.19 979.01,-4205.04 981.23,-4211.68"/>
</g>
<!-- expert_all2all1 -->
<g id="node17" class="node">
<title>expert_all2all1</title>
<ellipse fill="lightblue" stroke="black" cx="663" cy="-4047.56" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="663" y="-4067.06" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="663" y="-4056.06" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="663" y="-4045.06" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="663" y="-4034.06" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="663" y="-4023.06" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- expert1_1&#45;&gt;expert_all2all1 -->
<g id="edge15" class="edge">
<title>expert1_1&#45;&gt;expert_all2all1</title>
<path fill="none" stroke="black" d="M409.63,-4142.14C454.44,-4125.59 510.29,-4104.96 558.14,-4087.29"/>
<polygon fill="black" stroke="black" points="559.43,-4090.55 567.6,-4083.8 557.01,-4083.98 559.43,-4090.55"/>
</g>
<!-- expert1_2&#45;&gt;expert_all2all1 -->
<g id="edge16" class="edge">
<title>expert1_2&#45;&gt;expert_all2all1</title>
<path fill="none" stroke="black" d="M597.51,-4141.98C606.42,-4129.26 617.01,-4114.16 627.05,-4099.84"/>
<polygon fill="black" stroke="black" points="630.01,-4101.72 632.88,-4091.53 624.27,-4097.7 630.01,-4101.72"/>
</g>
<!-- expert1_3&#45;&gt;expert_all2all1 -->
<g id="edge17" class="edge">
<title>expert1_3&#45;&gt;expert_all2all1</title>
<path fill="none" stroke="black" d="M784.96,-4141.98C766.76,-4128.04 744.82,-4111.24 724.59,-4095.74"/>
<polygon fill="black" stroke="black" points="726.71,-4092.96 716.64,-4089.65 722.45,-4098.51 726.71,-4092.96"/>
</g>
<!-- expert1_4&#45;&gt;expert_all2all1 -->
<g id="edge18" class="edge">
<title>expert1_4&#45;&gt;expert_all2all1</title>
<path fill="none" stroke="black" d="M988.5,-4142.1C975.31,-4137.61 961.82,-4133.15 949,-4129.11 896.53,-4112.6 838.14,-4095.87 787.88,-4081.96"/>
<polygon fill="black" stroke="black" points="788.51,-4078.5 777.94,-4079.22 786.64,-4085.25 788.51,-4078.5"/>
</g>
<!-- sp_gather_1 -->
<g id="node18" class="node">
<title>sp_gather_1</title>
<polygon fill="lightyellow" stroke="black" points="908.92,-3937.02 517.72,-3937.02 417.08,-3833.02 808.28,-3833.02 908.92,-3937.02"/>
<text text-anchor="middle" x="663" y="-3899.02" font-family="Times,serif" font-size="10.00">SP GATHER</text>
<text text-anchor="middle" x="663" y="-3888.02" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="663" y="-3877.02" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="663" y="-3866.02" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- expert_all2all1&#45;&gt;sp_gather_1 -->
<g id="edge19" class="edge">
<title>expert_all2all1&#45;&gt;sp_gather_1</title>
<path fill="none" stroke="black" d="M663,-4002.69C663,-3985.62 663,-3965.75 663,-3947.3"/>
<polygon fill="black" stroke="black" points="666.5,-3947.23 663,-3937.23 659.5,-3947.23 666.5,-3947.23"/>
</g>
<!-- sp_split_2 -->
<g id="node20" class="node">
<title>sp_split_2</title>
<polygon fill="lightyellow" stroke="black" points="902.48,-3767.02 521.52,-3767.02 423.52,-3663.02 804.48,-3663.02 902.48,-3767.02"/>
<text text-anchor="middle" x="663" y="-3729.02" font-family="Times,serif" font-size="10.00">SP SPLIT</text>
<text text-anchor="middle" x="663" y="-3718.02" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="663" y="-3707.02" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="663" y="-3696.02" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- sp_gather_1&#45;&gt;sp_split_2 -->
<g id="edge20" class="edge">
<title>sp_gather_1&#45;&gt;sp_split_2</title>
<path fill="none" stroke="black" stroke-width="2" d="M663,-3832.7C663,-3815.19 663,-3795.44 663,-3777.24"/>
<polygon fill="black" stroke="black" stroke-width="2" points="666.5,-3777.02 663,-3767.02 659.5,-3777.02 666.5,-3777.02"/>
<text text-anchor="middle" x="701" y="-3803.82" font-family="Times,serif" font-size="14.00">Pipeline</text>
<text text-anchor="middle" x="701" y="-3788.82" font-family="Times,serif" font-size="14.00">Stage 1→2</text>
</g>
<!-- stage2_label -->
<g id="node19" class="node">
<title>stage2_label</title>
<polygon fill="purple" stroke="black" points="931.5,-5146.67 796.5,-5146.67 796.5,-5099.67 931.5,-5099.67 931.5,-5146.67"/>
<text text-anchor="middle" x="864" y="-5133.07" font-family="Times,serif" font-size="12.00">PIPELINE STAGE 2</text>
<text text-anchor="middle" x="864" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 5&#45;8</text>
<text text-anchor="middle" x="864" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 16&#45;31</text>
</g>
<!-- layernorm2_1 -->
<g id="node21" class="node">
<title>layernorm2_1</title>
<polygon fill="lightgreen" stroke="black" points="778.5,-3620.52 547.5,-3620.52 547.5,-3568.52 778.5,-3568.52 778.5,-3620.52"/>
<text text-anchor="middle" x="663" y="-3608.52" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="663" y="-3597.52" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="663" y="-3586.52" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="663" y="-3575.52" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- sp_split_2&#45;&gt;layernorm2_1 -->
<g id="edge21" class="edge">
<title>sp_split_2&#45;&gt;layernorm2_1</title>
<path fill="none" stroke="black" d="M663,-3662.73C663,-3652.07 663,-3641.06 663,-3631.12"/>
<polygon fill="black" stroke="black" points="666.5,-3630.81 663,-3620.81 659.5,-3630.81 666.5,-3630.81"/>
</g>
<!-- attn_qkv2_1 -->
<g id="node22" class="node">
<title>attn_qkv2_1</title>
<polygon fill="lightgreen" stroke="black" points="639.5,-3512.97 408.5,-3512.97 408.5,-3449.97 639.5,-3449.97 639.5,-3512.97"/>
<text text-anchor="middle" x="524" y="-3500.97" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="524" y="-3489.97" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="524" y="-3478.97" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="524" y="-3467.97" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="524" y="-3456.97" font-family="Times,serif" font-size="10.00">GPU: 16&#45;23</text>
</g>
<!-- layernorm2_1&#45;&gt;attn_qkv2_1 -->
<g id="edge22" class="edge">
<title>layernorm2_1&#45;&gt;attn_qkv2_1</title>
<path fill="none" stroke="black" d="M631.46,-3568.32C613.36,-3553.85 590.3,-3535.43 570.19,-3519.37"/>
<polygon fill="black" stroke="black" points="572.35,-3516.61 562.35,-3513.11 567.98,-3522.08 572.35,-3516.61"/>
</g>
<!-- attn_qkv2_2 -->
<g id="node23" class="node">
<title>attn_qkv2_2</title>
<polygon fill="lightgreen" stroke="black" points="888.5,-3512.97 657.5,-3512.97 657.5,-3449.97 888.5,-3449.97 888.5,-3512.97"/>
<text text-anchor="middle" x="773" y="-3500.97" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="773" y="-3489.97" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="773" y="-3478.97" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="773" y="-3467.97" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="773" y="-3456.97" font-family="Times,serif" font-size="10.00">GPU: 24&#45;31</text>
</g>
<!-- layernorm2_1&#45;&gt;attn_qkv2_2 -->
<g id="edge23" class="edge">
<title>layernorm2_1&#45;&gt;attn_qkv2_2</title>
<path fill="none" stroke="black" d="M687.96,-3568.32C702.03,-3554.11 719.89,-3536.08 735.6,-3520.22"/>
<polygon fill="black" stroke="black" points="738.1,-3522.67 742.65,-3513.11 733.13,-3517.75 738.1,-3522.67"/>
</g>
<!-- attn_compute2_1 -->
<g id="node24" class="node">
<title>attn_compute2_1</title>
<polygon fill="lightgreen" stroke="black" points="639.5,-3399.92 408.5,-3399.92 408.5,-3336.92 639.5,-3336.92 639.5,-3399.92"/>
<text text-anchor="middle" x="524" y="-3387.92" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="524" y="-3376.92" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="524" y="-3365.92" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="524" y="-3354.92" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="524" y="-3343.92" font-family="Times,serif" font-size="10.00">GPU: 16&#45;23</text>
</g>
<!-- attn_qkv2_1&#45;&gt;attn_compute2_1 -->
<g id="edge24" class="edge">
<title>attn_qkv2_1&#45;&gt;attn_compute2_1</title>
<path fill="none" stroke="black" d="M524,-3449.83C524,-3437.57 524,-3423.27 524,-3410.16"/>
<polygon fill="black" stroke="black" points="527.5,-3409.96 524,-3399.96 520.5,-3409.96 527.5,-3409.96"/>
</g>
<!-- attn_compute2_2 -->
<g id="node25" class="node">
<title>attn_compute2_2</title>
<polygon fill="lightgreen" stroke="black" points="888.5,-3399.92 657.5,-3399.92 657.5,-3336.92 888.5,-3336.92 888.5,-3399.92"/>
<text text-anchor="middle" x="773" y="-3387.92" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="773" y="-3376.92" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="773" y="-3365.92" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="773" y="-3354.92" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="773" y="-3343.92" font-family="Times,serif" font-size="10.00">GPU: 24&#45;31</text>
</g>
<!-- attn_qkv2_2&#45;&gt;attn_compute2_2 -->
<g id="edge25" class="edge">
<title>attn_qkv2_2&#45;&gt;attn_compute2_2</title>
<path fill="none" stroke="black" d="M773,-3449.83C773,-3437.57 773,-3423.27 773,-3410.16"/>
<polygon fill="black" stroke="black" points="776.5,-3409.96 773,-3399.96 769.5,-3409.96 776.5,-3409.96"/>
</g>
<!-- attn_gather2 -->
<g id="node26" class="node">
<title>attn_gather2</title>
<ellipse fill="lightblue" stroke="black" cx="601" cy="-3255.37" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="601" y="-3274.87" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="601" y="-3263.87" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="601" y="-3252.87" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="601" y="-3241.87" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="601" y="-3230.87" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- attn_compute2_1&#45;&gt;attn_gather2 -->
<g id="edge26" class="edge">
<title>attn_compute2_1&#45;&gt;attn_gather2</title>
<path fill="none" stroke="black" d="M545.24,-3336.78C551.5,-3327.75 558.53,-3317.62 565.43,-3307.67"/>
<polygon fill="black" stroke="black" points="568.36,-3309.59 571.18,-3299.38 562.61,-3305.6 568.36,-3309.59"/>
</g>
<!-- attn_compute2_2&#45;&gt;attn_gather2 -->
<g id="edge27" class="edge">
<title>attn_compute2_2&#45;&gt;attn_gather2</title>
<path fill="none" stroke="black" d="M725.54,-3336.78C709.05,-3326.13 690.18,-3313.95 672.19,-3302.33"/>
<polygon fill="black" stroke="black" points="673.75,-3299.17 663.45,-3296.69 669.95,-3305.05 673.75,-3299.17"/>
</g>
<!-- mlp_gate2 -->
<g id="node27" class="node">
<title>mlp_gate2</title>
<polygon fill="lightgreen" stroke="black" points="729,-3168.32 473,-3168.32 473,-3116.32 729,-3116.32 729,-3168.32"/>
<text text-anchor="middle" x="601" y="-3156.32" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="601" y="-3145.32" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="601" y="-3134.32" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, num_experts=16]</text>
<text text-anchor="middle" x="601" y="-3123.32" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- attn_gather2&#45;&gt;mlp_gate2 -->
<g id="edge28" class="edge">
<title>attn_gather2&#45;&gt;mlp_gate2</title>
<path fill="none" stroke="black" d="M601,-3210.8C601,-3200.16 601,-3188.9 601,-3178.69"/>
<polygon fill="black" stroke="black" points="604.5,-3178.51 601,-3168.51 597.5,-3178.51 604.5,-3178.51"/>
</g>
<!-- expert_route2 -->
<g id="node28" class="node">
<title>expert_route2</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="697.34,-3070.28 544.09,-3070.28 504.66,-2988.28 657.91,-2988.28 697.34,-3070.28"/>
<text text-anchor="middle" x="601" y="-3037.78" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="601" y="-3026.78" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="601" y="-3015.78" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- mlp_gate2&#45;&gt;expert_route2 -->
<g id="edge29" class="edge">
<title>mlp_gate2&#45;&gt;expert_route2</title>
<path fill="none" stroke="black" d="M601,-3116.13C601,-3105.63 601,-3093.04 601,-3080.79"/>
<polygon fill="black" stroke="black" points="604.5,-3080.62 601,-3070.62 597.5,-3080.62 604.5,-3080.62"/>
</g>
<!-- expert2_1 -->
<g id="node29" class="node">
<title>expert2_1</title>
<polygon fill="lightgreen" stroke="black" points="434.5,-2942.46 203.5,-2942.46 203.5,-2879.46 434.5,-2879.46 434.5,-2942.46"/>
<text text-anchor="middle" x="319" y="-2930.46" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="319" y="-2919.46" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="319" y="-2908.46" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="319" y="-2897.46" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="319" y="-2886.46" font-family="Times,serif" font-size="10.00">GPU: 16&#45;19</text>
</g>
<!-- expert_route2&#45;&gt;expert2_1 -->
<g id="edge30" class="edge">
<title>expert_route2&#45;&gt;expert2_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M504.74,-2988.57C471.48,-2974.86 434.52,-2959.61 402.39,-2946.35"/>
<polygon fill="black" stroke="black" points="403.6,-2943.07 393.02,-2942.49 400.93,-2949.54 403.6,-2943.07"/>
</g>
<!-- expert2_2 -->
<g id="node30" class="node">
<title>expert2_2</title>
<polygon fill="lightgreen" stroke="black" points="683.5,-2942.46 452.5,-2942.46 452.5,-2879.46 683.5,-2879.46 683.5,-2942.46"/>
<text text-anchor="middle" x="568" y="-2930.46" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="568" y="-2919.46" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="568" y="-2908.46" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="568" y="-2897.46" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="568" y="-2886.46" font-family="Times,serif" font-size="10.00">GPU: 20&#45;23</text>
</g>
<!-- expert_route2&#45;&gt;expert2_2 -->
<g id="edge31" class="edge">
<title>expert_route2&#45;&gt;expert2_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M589.64,-2988.25C586.36,-2976.66 582.77,-2964 579.47,-2952.39"/>
<polygon fill="black" stroke="black" points="582.76,-2951.17 576.67,-2942.51 576.03,-2953.08 582.76,-2951.17"/>
</g>
<!-- expert2_3 -->
<g id="node31" class="node">
<title>expert2_3</title>
<polygon fill="lightgreen" stroke="black" points="932.5,-2942.46 701.5,-2942.46 701.5,-2879.46 932.5,-2879.46 932.5,-2942.46"/>
<text text-anchor="middle" x="817" y="-2930.46" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="817" y="-2919.46" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="817" y="-2908.46" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="817" y="-2897.46" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="817" y="-2886.46" font-family="Times,serif" font-size="10.00">GPU: 24&#45;27</text>
</g>
<!-- expert_route2&#45;&gt;expert2_3 -->
<g id="edge32" class="edge">
<title>expert_route2&#45;&gt;expert2_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M661.74,-2995.57C689.55,-2980.59 722.57,-2962.81 750.99,-2947.5"/>
<polygon fill="black" stroke="black" points="752.9,-2950.45 760.05,-2942.63 749.58,-2944.29 752.9,-2950.45"/>
</g>
<!-- expert2_4 -->
<g id="node32" class="node">
<title>expert2_4</title>
<polygon fill="lightgreen" stroke="black" points="1181.5,-2942.46 950.5,-2942.46 950.5,-2879.46 1181.5,-2879.46 1181.5,-2942.46"/>
<text text-anchor="middle" x="1066" y="-2930.46" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1066" y="-2919.46" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1066" y="-2908.46" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="1066" y="-2897.46" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="1066" y="-2886.46" font-family="Times,serif" font-size="10.00">GPU: 28&#45;31</text>
</g>
<!-- expert_route2&#45;&gt;expert2_4 -->
<g id="edge33" class="edge">
<title>expert_route2&#45;&gt;expert2_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M669.93,-3012.93C738.78,-2997.36 847.54,-2972.16 941,-2947.73 944.17,-2946.9 947.38,-2946.05 950.61,-2945.19"/>
<polygon fill="black" stroke="black" points="951.64,-2948.53 960.39,-2942.55 949.82,-2941.78 951.64,-2948.53"/>
</g>
<!-- expert_all2all2 -->
<g id="node33" class="node">
<title>expert_all2all2</title>
<ellipse fill="lightblue" stroke="black" cx="680" cy="-2763.64" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="680" y="-2783.14" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="680" y="-2772.14" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="680" y="-2761.14" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2750.14" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2739.14" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- expert2_1&#45;&gt;expert_all2all2 -->
<g id="edge34" class="edge">
<title>expert2_1&#45;&gt;expert_all2all2</title>
<path fill="none" stroke="black" d="M395.12,-2879.32C449,-2857.63 521.8,-2828.32 580.32,-2804.77"/>
<polygon fill="black" stroke="black" points="581.98,-2807.87 589.95,-2800.89 579.37,-2801.38 581.98,-2807.87"/>
</g>
<!-- expert2_2&#45;&gt;expert_all2all2 -->
<g id="edge35" class="edge">
<title>expert2_2&#45;&gt;expert_all2all2</title>
<path fill="none" stroke="black" d="M591.75,-2879.14C605.99,-2860.67 624.44,-2836.73 640.79,-2815.52"/>
<polygon fill="black" stroke="black" points="643.6,-2817.6 646.94,-2807.54 638.06,-2813.33 643.6,-2817.6"/>
</g>
<!-- expert2_3&#45;&gt;expert_all2all2 -->
<g id="edge36" class="edge">
<title>expert2_3&#45;&gt;expert_all2all2</title>
<path fill="none" stroke="black" d="M787.95,-2879.14C770.24,-2860.36 747.2,-2835.92 726.96,-2814.45"/>
<polygon fill="black" stroke="black" points="729.33,-2811.87 719.93,-2806.99 724.24,-2816.67 729.33,-2811.87"/>
</g>
<!-- expert2_4&#45;&gt;expert_all2all2 -->
<g id="edge37" class="edge">
<title>expert2_4&#45;&gt;expert_all2all2</title>
<path fill="none" stroke="black" d="M984.61,-2879.32C926.12,-2857.3 846.8,-2827.44 783.76,-2803.71"/>
<polygon fill="black" stroke="black" points="784.78,-2800.35 774.19,-2800.1 782.31,-2806.9 784.78,-2800.35"/>
</g>
<!-- sp_gather_2 -->
<g id="node34" class="node">
<title>sp_gather_2</title>
<polygon fill="lightyellow" stroke="black" points="925.92,-2682.09 534.72,-2682.09 434.08,-2578.09 825.28,-2578.09 925.92,-2682.09"/>
<text text-anchor="middle" x="680" y="-2644.09" font-family="Times,serif" font-size="10.00">SP GATHER</text>
<text text-anchor="middle" x="680" y="-2633.09" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2622.09" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2611.09" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- expert_all2all2&#45;&gt;sp_gather_2 -->
<g id="edge38" class="edge">
<title>expert_all2all2&#45;&gt;sp_gather_2</title>
<path fill="none" stroke="black" d="M680,-2718.84C680,-2710.46 680,-2701.54 680,-2692.72"/>
<polygon fill="black" stroke="black" points="683.5,-2692.45 680,-2682.45 676.5,-2692.45 683.5,-2692.45"/>
</g>
<!-- sp_split_3 -->
<g id="node36" class="node">
<title>sp_split_3</title>
<polygon fill="lightyellow" stroke="black" points="919.48,-2512.09 538.52,-2512.09 440.52,-2408.09 821.48,-2408.09 919.48,-2512.09"/>
<text text-anchor="middle" x="680" y="-2474.09" font-family="Times,serif" font-size="10.00">SP SPLIT</text>
<text text-anchor="middle" x="680" y="-2463.09" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2452.09" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2441.09" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- sp_gather_2&#45;&gt;sp_split_3 -->
<g id="edge39" class="edge">
<title>sp_gather_2&#45;&gt;sp_split_3</title>
<path fill="none" stroke="black" stroke-width="2" d="M680,-2577.78C680,-2560.27 680,-2540.52 680,-2522.32"/>
<polygon fill="black" stroke="black" stroke-width="2" points="683.5,-2522.1 680,-2512.1 676.5,-2522.1 683.5,-2522.1"/>
<text text-anchor="middle" x="718" y="-2548.89" font-family="Times,serif" font-size="14.00">Pipeline</text>
<text text-anchor="middle" x="718" y="-2533.89" font-family="Times,serif" font-size="14.00">Stage 2→3</text>
</g>
<!-- stage3_label -->
<g id="node35" class="node">
<title>stage3_label</title>
<polygon fill="purple" stroke="black" points="1085.5,-5146.67 950.5,-5146.67 950.5,-5099.67 1085.5,-5099.67 1085.5,-5146.67"/>
<text text-anchor="middle" x="1018" y="-5133.07" font-family="Times,serif" font-size="12.00">PIPELINE STAGE 3</text>
<text text-anchor="middle" x="1018" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 9&#45;12</text>
<text text-anchor="middle" x="1018" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 32&#45;47</text>
</g>
<!-- layernorm3_1 -->
<g id="node37" class="node">
<title>layernorm3_1</title>
<polygon fill="lightgreen" stroke="black" points="795.5,-2352.55 564.5,-2352.55 564.5,-2300.55 795.5,-2300.55 795.5,-2352.55"/>
<text text-anchor="middle" x="680" y="-2340.55" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="680" y="-2329.55" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2318.55" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="680" y="-2307.55" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- sp_split_3&#45;&gt;layernorm3_1 -->
<g id="edge40" class="edge">
<title>sp_split_3&#45;&gt;layernorm3_1</title>
<path fill="none" stroke="black" d="M680,-2407.86C680,-2392.8 680,-2376.66 680,-2362.84"/>
<polygon fill="black" stroke="black" points="683.5,-2362.77 680,-2352.77 676.5,-2362.77 683.5,-2362.77"/>
</g>
<!-- attn_qkv3_1 -->
<g id="node38" class="node">
<title>attn_qkv3_1</title>
<polygon fill="lightgreen" stroke="black" points="693.5,-2245 462.5,-2245 462.5,-2182 693.5,-2182 693.5,-2245"/>
<text text-anchor="middle" x="578" y="-2233" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="578" y="-2222" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="578" y="-2211" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="578" y="-2200" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="578" y="-2189" font-family="Times,serif" font-size="10.00">GPU: 32&#45;39</text>
</g>
<!-- layernorm3_1&#45;&gt;attn_qkv3_1 -->
<g id="edge41" class="edge">
<title>layernorm3_1&#45;&gt;attn_qkv3_1</title>
<path fill="none" stroke="black" d="M656.85,-2300.35C643.92,-2286.27 627.55,-2268.44 613.07,-2252.68"/>
<polygon fill="black" stroke="black" points="615.48,-2250.13 606.14,-2245.14 610.33,-2254.87 615.48,-2250.13"/>
</g>
<!-- attn_qkv3_2 -->
<g id="node39" class="node">
<title>attn_qkv3_2</title>
<polygon fill="lightgreen" stroke="black" points="942.5,-2245 711.5,-2245 711.5,-2182 942.5,-2182 942.5,-2245"/>
<text text-anchor="middle" x="827" y="-2233" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="827" y="-2222" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="827" y="-2211" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="827" y="-2200" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="827" y="-2189" font-family="Times,serif" font-size="10.00">GPU: 40&#45;47</text>
</g>
<!-- layernorm3_1&#45;&gt;attn_qkv3_2 -->
<g id="edge42" class="edge">
<title>layernorm3_1&#45;&gt;attn_qkv3_2</title>
<path fill="none" stroke="black" d="M713.36,-2300.35C732.59,-2285.82 757.1,-2267.3 778.44,-2251.18"/>
<polygon fill="black" stroke="black" points="780.57,-2253.96 786.44,-2245.14 776.35,-2248.37 780.57,-2253.96"/>
</g>
<!-- attn_compute3_1 -->
<g id="node40" class="node">
<title>attn_compute3_1</title>
<polygon fill="lightgreen" stroke="black" points="693.5,-2135.5 462.5,-2135.5 462.5,-2072.5 693.5,-2072.5 693.5,-2135.5"/>
<text text-anchor="middle" x="578" y="-2123.5" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="578" y="-2112.5" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="578" y="-2101.5" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="578" y="-2090.5" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="578" y="-2079.5" font-family="Times,serif" font-size="10.00">GPU: 32&#45;39</text>
</g>
<!-- attn_qkv3_1&#45;&gt;attn_compute3_1 -->
<g id="edge43" class="edge">
<title>attn_qkv3_1&#45;&gt;attn_compute3_1</title>
<path fill="none" stroke="black" d="M578,-2181.98C578,-2170.75 578,-2157.84 578,-2145.84"/>
<polygon fill="black" stroke="black" points="581.5,-2145.59 578,-2135.59 574.5,-2145.59 581.5,-2145.59"/>
</g>
<!-- attn_compute3_2 -->
<g id="node41" class="node">
<title>attn_compute3_2</title>
<polygon fill="lightgreen" stroke="black" points="942.5,-2135.5 711.5,-2135.5 711.5,-2072.5 942.5,-2072.5 942.5,-2135.5"/>
<text text-anchor="middle" x="827" y="-2123.5" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="827" y="-2112.5" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="827" y="-2101.5" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="827" y="-2090.5" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="827" y="-2079.5" font-family="Times,serif" font-size="10.00">GPU: 40&#45;47</text>
</g>
<!-- attn_qkv3_2&#45;&gt;attn_compute3_2 -->
<g id="edge44" class="edge">
<title>attn_qkv3_2&#45;&gt;attn_compute3_2</title>
<path fill="none" stroke="black" d="M827,-2181.98C827,-2170.75 827,-2157.84 827,-2145.84"/>
<polygon fill="black" stroke="black" points="830.5,-2145.59 827,-2135.59 823.5,-2145.59 830.5,-2145.59"/>
</g>
<!-- attn_gather3 -->
<g id="node42" class="node">
<title>attn_gather3</title>
<ellipse fill="lightblue" stroke="black" cx="646" cy="-1981.45" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="646" y="-2000.95" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="646" y="-1989.95" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="646" y="-1978.95" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="646" y="-1967.95" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="646" y="-1956.95" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- attn_compute3_1&#45;&gt;attn_gather3 -->
<g id="edge45" class="edge">
<title>attn_compute3_1&#45;&gt;attn_gather3</title>
<path fill="none" stroke="black" d="M595.34,-2072.27C601.79,-2060.82 609.32,-2047.48 616.56,-2034.64"/>
<polygon fill="black" stroke="black" points="619.65,-2036.29 621.51,-2025.86 613.55,-2032.85 619.65,-2036.29"/>
</g>
<!-- attn_compute3_2&#45;&gt;attn_gather3 -->
<g id="edge46" class="edge">
<title>attn_compute3_2&#45;&gt;attn_gather3</title>
<path fill="none" stroke="black" d="M780.86,-2072.27C760.89,-2058.97 737.09,-2043.12 715.09,-2028.47"/>
<polygon fill="black" stroke="black" points="717.02,-2025.55 706.76,-2022.92 713.14,-2031.37 717.02,-2025.55"/>
</g>
<!-- mlp_gate3 -->
<g id="node43" class="node">
<title>mlp_gate3</title>
<polygon fill="lightgreen" stroke="black" points="774,-1881.36 518,-1881.36 518,-1829.36 774,-1829.36 774,-1881.36"/>
<text text-anchor="middle" x="646" y="-1869.36" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="646" y="-1858.36" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="646" y="-1847.36" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, num_experts=16]</text>
<text text-anchor="middle" x="646" y="-1836.36" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- attn_gather3&#45;&gt;mlp_gate3 -->
<g id="edge47" class="edge">
<title>attn_gather3&#45;&gt;mlp_gate3</title>
<path fill="none" stroke="black" d="M646,-1936.7C646,-1922.02 646,-1905.84 646,-1891.87"/>
<polygon fill="black" stroke="black" points="649.5,-1891.68 646,-1881.68 642.5,-1891.68 649.5,-1891.68"/>
</g>
<!-- expert_route3 -->
<g id="node44" class="node">
<title>expert_route3</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="742.34,-1773.81 589.09,-1773.81 549.66,-1691.81 702.91,-1691.81 742.34,-1773.81"/>
<text text-anchor="middle" x="646" y="-1741.31" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="646" y="-1730.31" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="646" y="-1719.31" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- mlp_gate3&#45;&gt;expert_route3 -->
<g id="edge48" class="edge">
<title>mlp_gate3&#45;&gt;expert_route3</title>
<path fill="none" stroke="black" d="M646,-1829.09C646,-1816.18 646,-1800.01 646,-1784.67"/>
<polygon fill="black" stroke="black" points="649.5,-1784.23 646,-1774.23 642.5,-1784.23 649.5,-1784.23"/>
</g>
<!-- expert3_1 -->
<g id="node45" class="node">
<title>expert3_1</title>
<polygon fill="lightgreen" stroke="black" points="431.5,-1625.81 200.5,-1625.81 200.5,-1562.81 431.5,-1562.81 431.5,-1625.81"/>
<text text-anchor="middle" x="316" y="-1613.81" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="316" y="-1602.81" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="316" y="-1591.81" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="316" y="-1580.81" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="316" y="-1569.81" font-family="Times,serif" font-size="10.00">GPU: 32&#45;35</text>
</g>
<!-- expert_route3&#45;&gt;expert3_1 -->
<g id="edge49" class="edge">
<title>expert_route3&#45;&gt;expert3_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M549.66,-1691.96C501.96,-1672.23 444.95,-1648.65 399.18,-1629.71"/>
<polygon fill="black" stroke="black" points="400.46,-1626.46 389.89,-1625.87 397.79,-1632.93 400.46,-1626.46"/>
</g>
<!-- expert3_2 -->
<g id="node46" class="node">
<title>expert3_2</title>
<polygon fill="lightgreen" stroke="black" points="680.5,-1625.81 449.5,-1625.81 449.5,-1562.81 680.5,-1562.81 680.5,-1625.81"/>
<text text-anchor="middle" x="565" y="-1613.81" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="565" y="-1602.81" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="565" y="-1591.81" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="565" y="-1580.81" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="565" y="-1569.81" font-family="Times,serif" font-size="10.00">GPU: 36&#45;39</text>
</g>
<!-- expert_route3&#45;&gt;expert3_2 -->
<g id="edge50" class="edge">
<title>expert_route3&#45;&gt;expert3_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M622.14,-1691.59C611.56,-1673.78 599.16,-1652.88 588.62,-1635.12"/>
<polygon fill="black" stroke="black" points="591.41,-1632.96 583.3,-1626.14 585.39,-1636.53 591.41,-1632.96"/>
</g>
<!-- expert3_3 -->
<g id="node47" class="node">
<title>expert3_3</title>
<polygon fill="lightgreen" stroke="black" points="929.5,-1625.81 698.5,-1625.81 698.5,-1562.81 929.5,-1562.81 929.5,-1625.81"/>
<text text-anchor="middle" x="814" y="-1613.81" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="814" y="-1602.81" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="814" y="-1591.81" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="814" y="-1580.81" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="814" y="-1569.81" font-family="Times,serif" font-size="10.00">GPU: 40&#45;43</text>
</g>
<!-- expert_route3&#45;&gt;expert3_3 -->
<g id="edge51" class="edge">
<title>expert_route3&#45;&gt;expert3_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M695.5,-1691.59C718.61,-1672.81 745.95,-1650.6 768.54,-1632.24"/>
<polygon fill="black" stroke="black" points="770.76,-1634.95 776.32,-1625.93 766.35,-1629.52 770.76,-1634.95"/>
</g>
<!-- expert3_4 -->
<g id="node48" class="node">
<title>expert3_4</title>
<polygon fill="lightgreen" stroke="black" points="1178.5,-1625.81 947.5,-1625.81 947.5,-1562.81 1178.5,-1562.81 1178.5,-1625.81"/>
<text text-anchor="middle" x="1063" y="-1613.81" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1063" y="-1602.81" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1063" y="-1591.81" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="1063" y="-1580.81" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="1063" y="-1569.81" font-family="Times,serif" font-size="10.00">GPU: 44&#45;47</text>
</g>
<!-- expert_route3&#45;&gt;expert3_4 -->
<g id="edge52" class="edge">
<title>expert_route3&#45;&gt;expert3_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M712.07,-1710.18C778.7,-1688.37 882.48,-1654.4 959.92,-1629.05"/>
<polygon fill="black" stroke="black" points="961.3,-1632.28 969.71,-1625.84 959.12,-1625.63 961.3,-1632.28"/>
</g>
<!-- expert_all2all3 -->
<g id="node49" class="node">
<title>expert_all2all3</title>
<ellipse fill="lightblue" stroke="black" cx="656" cy="-1481.26" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="656" y="-1500.76" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="656" y="-1489.76" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="656" y="-1478.76" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1467.76" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1456.76" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- expert3_1&#45;&gt;expert_all2all3 -->
<g id="edge53" class="edge">
<title>expert3_1&#45;&gt;expert_all2all3</title>
<path fill="none" stroke="black" d="M409.81,-1562.67C451.11,-1549.18 499.97,-1533.22 543.23,-1519.09"/>
<polygon fill="black" stroke="black" points="544.53,-1522.35 552.95,-1515.92 542.35,-1515.7 544.53,-1522.35"/>
</g>
<!-- expert3_2&#45;&gt;expert_all2all3 -->
<g id="edge54" class="edge">
<title>expert3_2&#45;&gt;expert_all2all3</title>
<path fill="none" stroke="black" d="M590.11,-1562.67C597.74,-1553.36 606.33,-1542.87 614.73,-1532.62"/>
<polygon fill="black" stroke="black" points="617.47,-1534.8 621.1,-1524.85 612.05,-1530.37 617.47,-1534.8"/>
</g>
<!-- expert3_3&#45;&gt;expert_all2all3 -->
<g id="edge55" class="edge">
<title>expert3_3&#45;&gt;expert_all2all3</title>
<path fill="none" stroke="black" d="M770.41,-1562.67C755.55,-1552.23 738.59,-1540.31 722.36,-1528.9"/>
<polygon fill="black" stroke="black" points="724.14,-1525.88 713.95,-1522.99 720.12,-1531.6 724.14,-1525.88"/>
</g>
<!-- expert3_4&#45;&gt;expert_all2all3 -->
<g id="edge56" class="edge">
<title>expert3_4&#45;&gt;expert_all2all3</title>
<path fill="none" stroke="black" d="M950.98,-1562.74C897.81,-1548.24 834.13,-1530.86 779.56,-1515.97"/>
<polygon fill="black" stroke="black" points="780.41,-1512.58 769.84,-1513.32 778.56,-1519.33 780.41,-1512.58"/>
</g>
<!-- sp_gather_3 -->
<g id="node50" class="node">
<title>sp_gather_3</title>
<polygon fill="lightyellow" stroke="black" points="901.92,-1399.71 510.72,-1399.71 410.08,-1295.71 801.28,-1295.71 901.92,-1399.71"/>
<text text-anchor="middle" x="656" y="-1361.71" font-family="Times,serif" font-size="10.00">SP GATHER</text>
<text text-anchor="middle" x="656" y="-1350.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1339.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1328.71" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- expert_all2all3&#45;&gt;sp_gather_3 -->
<g id="edge57" class="edge">
<title>expert_all2all3&#45;&gt;sp_gather_3</title>
<path fill="none" stroke="black" d="M656,-1436.46C656,-1428.08 656,-1419.16 656,-1410.34"/>
<polygon fill="black" stroke="black" points="659.5,-1410.07 656,-1400.07 652.5,-1410.07 659.5,-1410.07"/>
</g>
<!-- sp_split_4 -->
<g id="node52" class="node">
<title>sp_split_4</title>
<polygon fill="lightyellow" stroke="black" points="895.48,-1229.71 514.52,-1229.71 416.52,-1125.71 797.48,-1125.71 895.48,-1229.71"/>
<text text-anchor="middle" x="656" y="-1191.71" font-family="Times,serif" font-size="10.00">SP SPLIT</text>
<text text-anchor="middle" x="656" y="-1180.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1169.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1158.71" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- sp_gather_3&#45;&gt;sp_split_4 -->
<g id="edge58" class="edge">
<title>sp_gather_3&#45;&gt;sp_split_4</title>
<path fill="none" stroke="black" stroke-width="2" d="M656,-1295.39C656,-1277.89 656,-1258.14 656,-1239.94"/>
<polygon fill="black" stroke="black" stroke-width="2" points="659.5,-1239.72 656,-1229.72 652.5,-1239.72 659.5,-1239.72"/>
<text text-anchor="middle" x="694" y="-1266.51" font-family="Times,serif" font-size="14.00">Pipeline</text>
<text text-anchor="middle" x="694" y="-1251.51" font-family="Times,serif" font-size="14.00">Stage 3→4</text>
</g>
<!-- stage4_label -->
<g id="node51" class="node">
<title>stage4_label</title>
<polygon fill="purple" stroke="black" points="1238.5,-5146.67 1103.5,-5146.67 1103.5,-5099.67 1238.5,-5099.67 1238.5,-5146.67"/>
<text text-anchor="middle" x="1171" y="-5133.07" font-family="Times,serif" font-size="12.00">PIPELINE STAGE 4</text>
<text text-anchor="middle" x="1171" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 13&#45;16</text>
<text text-anchor="middle" x="1171" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 48&#45;63</text>
</g>
<!-- layernorm4_1 -->
<g id="node53" class="node">
<title>layernorm4_1</title>
<polygon fill="lightgreen" stroke="black" points="771.5,-1088.71 540.5,-1088.71 540.5,-1036.71 771.5,-1036.71 771.5,-1088.71"/>
<text text-anchor="middle" x="656" y="-1076.71" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="656" y="-1065.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1054.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="656" y="-1043.71" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- sp_split_4&#45;&gt;layernorm4_1 -->
<g id="edge59" class="edge">
<title>sp_split_4&#45;&gt;layernorm4_1</title>
<path fill="none" stroke="black" d="M656,-1125.5C656,-1116.55 656,-1107.42 656,-1099.02"/>
<polygon fill="black" stroke="black" points="659.5,-1098.84 656,-1088.84 652.5,-1098.84 659.5,-1098.84"/>
</g>
<!-- attn_qkv4_1 -->
<g id="node54" class="node">
<title>attn_qkv4_1</title>
<polygon fill="lightgreen" stroke="black" points="552.5,-990.21 321.5,-990.21 321.5,-927.21 552.5,-927.21 552.5,-990.21"/>
<text text-anchor="middle" x="437" y="-978.21" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="437" y="-967.21" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="437" y="-956.21" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="437" y="-945.21" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="437" y="-934.21" font-family="Times,serif" font-size="10.00">GPU: 48&#45;55</text>
</g>
<!-- layernorm4_1&#45;&gt;attn_qkv4_1 -->
<g id="edge60" class="edge">
<title>layernorm4_1&#45;&gt;attn_qkv4_1</title>
<path fill="none" stroke="black" d="M602.15,-1036.63C574.94,-1023.96 541.5,-1008.39 511.84,-994.57"/>
<polygon fill="black" stroke="black" points="513.31,-991.4 502.77,-990.35 510.36,-997.74 513.31,-991.4"/>
</g>
<!-- attn_qkv4_2 -->
<g id="node55" class="node">
<title>attn_qkv4_2</title>
<polygon fill="lightgreen" stroke="black" points="801.5,-990.21 570.5,-990.21 570.5,-927.21 801.5,-927.21 801.5,-990.21"/>
<text text-anchor="middle" x="686" y="-978.21" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="686" y="-967.21" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="686" y="-956.21" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="686" y="-945.21" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="686" y="-934.21" font-family="Times,serif" font-size="10.00">GPU: 56&#45;63</text>
</g>
<!-- layernorm4_1&#45;&gt;attn_qkv4_2 -->
<g id="edge61" class="edge">
<title>layernorm4_1&#45;&gt;attn_qkv4_2</title>
<path fill="none" stroke="black" d="M663.42,-1036.5C666.65,-1025.51 670.52,-1012.36 674.13,-1000.07"/>
<polygon fill="black" stroke="black" points="677.49,-1001.04 676.96,-990.46 670.78,-999.06 677.49,-1001.04"/>
</g>
<!-- attn_compute4_1 -->
<g id="node56" class="node">
<title>attn_compute4_1</title>
<polygon fill="lightgreen" stroke="black" points="552.5,-880.71 321.5,-880.71 321.5,-817.71 552.5,-817.71 552.5,-880.71"/>
<text text-anchor="middle" x="437" y="-868.71" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="437" y="-857.71" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="437" y="-846.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="437" y="-835.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="437" y="-824.71" font-family="Times,serif" font-size="10.00">GPU: 48&#45;55</text>
</g>
<!-- attn_qkv4_1&#45;&gt;attn_compute4_1 -->
<g id="edge62" class="edge">
<title>attn_qkv4_1&#45;&gt;attn_compute4_1</title>
<path fill="none" stroke="black" d="M437,-927.2C437,-915.96 437,-903.05 437,-891.05"/>
<polygon fill="black" stroke="black" points="440.5,-890.81 437,-880.81 433.5,-890.81 440.5,-890.81"/>
</g>
<!-- attn_compute4_2 -->
<g id="node57" class="node">
<title>attn_compute4_2</title>
<polygon fill="lightgreen" stroke="black" points="801.5,-880.71 570.5,-880.71 570.5,-817.71 801.5,-817.71 801.5,-880.71"/>
<text text-anchor="middle" x="686" y="-868.71" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="686" y="-857.71" font-family="Times,serif" font-size="10.00">SP=2</text>
<text text-anchor="middle" x="686" y="-846.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="686" y="-835.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="686" y="-824.71" font-family="Times,serif" font-size="10.00">GPU: 56&#45;63</text>
</g>
<!-- attn_qkv4_2&#45;&gt;attn_compute4_2 -->
<g id="edge63" class="edge">
<title>attn_qkv4_2&#45;&gt;attn_compute4_2</title>
<path fill="none" stroke="black" d="M686,-927.2C686,-915.96 686,-903.05 686,-891.05"/>
<polygon fill="black" stroke="black" points="689.5,-890.81 686,-880.81 682.5,-890.81 689.5,-890.81"/>
</g>
<!-- attn_gather4 -->
<g id="node58" class="node">
<title>attn_gather4</title>
<ellipse fill="lightblue" stroke="black" cx="534" cy="-736.17" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="534" y="-755.67" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="534" y="-744.67" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="534" y="-733.67" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=256]</text>
<text text-anchor="middle" x="534" y="-722.67" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="534" y="-711.67" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- attn_compute4_1&#45;&gt;attn_gather4 -->
<g id="edge64" class="edge">
<title>attn_compute4_1&#45;&gt;attn_gather4</title>
<path fill="none" stroke="black" d="M463.76,-817.57C471.9,-808.26 481.06,-797.78 490.01,-787.52"/>
<polygon fill="black" stroke="black" points="492.85,-789.59 496.8,-779.76 487.58,-784.98 492.85,-789.59"/>
</g>
<!-- attn_compute4_2&#45;&gt;attn_gather4 -->
<g id="edge65" class="edge">
<title>attn_compute4_2&#45;&gt;attn_gather4</title>
<path fill="none" stroke="black" d="M644.06,-817.57C629.98,-807.28 613.92,-795.55 598.51,-784.29"/>
<polygon fill="black" stroke="black" points="600.17,-781.17 590.03,-778.1 596.04,-786.83 600.17,-781.17"/>
</g>
<!-- mlp_gate4 -->
<g id="node59" class="node">
<title>mlp_gate4</title>
<polygon fill="lightgreen" stroke="black" points="662,-643.85 406,-643.85 406,-591.85 662,-591.85 662,-643.85"/>
<text text-anchor="middle" x="534" y="-631.85" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="534" y="-620.85" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="534" y="-609.85" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, num_experts=16]</text>
<text text-anchor="middle" x="534" y="-598.85" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- attn_gather4&#45;&gt;mlp_gate4 -->
<g id="edge66" class="edge">
<title>attn_gather4&#45;&gt;mlp_gate4</title>
<path fill="none" stroke="black" d="M534,-691.52C534,-679.28 534,-666.13 534,-654.42"/>
<polygon fill="black" stroke="black" points="537.5,-654.14 534,-644.14 530.5,-654.14 537.5,-654.14"/>
</g>
<!-- expert_route4 -->
<g id="node60" class="node">
<title>expert_route4</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="630.34,-544.08 477.09,-544.08 437.66,-462.08 590.91,-462.08 630.34,-544.08"/>
<text text-anchor="middle" x="534" y="-511.58" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="534" y="-500.58" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="534" y="-489.58" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- mlp_gate4&#45;&gt;expert_route4 -->
<g id="edge67" class="edge">
<title>mlp_gate4&#45;&gt;expert_route4</title>
<path fill="none" stroke="black" d="M534,-591.82C534,-580.76 534,-567.34 534,-554.36"/>
<polygon fill="black" stroke="black" points="537.5,-554.09 534,-544.09 530.5,-554.09 537.5,-554.09"/>
</g>
<!-- expert4_1 -->
<g id="node61" class="node">
<title>expert4_1</title>
<polygon fill="lightgreen" stroke="black" points="276.5,-425.08 45.5,-425.08 45.5,-362.08 276.5,-362.08 276.5,-425.08"/>
<text text-anchor="middle" x="161" y="-413.08" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="161" y="-402.08" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="161" y="-391.08" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="161" y="-380.08" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="161" y="-369.08" font-family="Times,serif" font-size="10.00">GPU: 48&#45;51</text>
</g>
<!-- expert_route4&#45;&gt;expert4_1 -->
<g id="edge68" class="edge">
<title>expert_route4&#45;&gt;expert4_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M444.18,-476.19C393.85,-461.69 330.54,-443.44 276.54,-427.88"/>
<polygon fill="black" stroke="black" points="277.5,-424.51 266.92,-425.11 275.56,-431.24 277.5,-424.51"/>
</g>
<!-- expert4_2 -->
<g id="node62" class="node">
<title>expert4_2</title>
<polygon fill="lightgreen" stroke="black" points="525.5,-425.08 294.5,-425.08 294.5,-362.08 525.5,-362.08 525.5,-425.08"/>
<text text-anchor="middle" x="410" y="-413.08" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="410" y="-402.08" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="410" y="-391.08" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="410" y="-380.08" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="410" y="-369.08" font-family="Times,serif" font-size="10.00">GPU: 52&#45;55</text>
</g>
<!-- expert_route4&#45;&gt;expert4_2 -->
<g id="edge69" class="edge">
<title>expert_route4&#45;&gt;expert4_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M487.83,-462.05C476.41,-452.15 464.23,-441.6 452.98,-431.84"/>
<polygon fill="black" stroke="black" points="455.21,-429.14 445.36,-425.23 450.62,-434.43 455.21,-429.14"/>
</g>
<!-- expert4_3 -->
<g id="node63" class="node">
<title>expert4_3</title>
<polygon fill="lightgreen" stroke="black" points="774.5,-425.08 543.5,-425.08 543.5,-362.08 774.5,-362.08 774.5,-425.08"/>
<text text-anchor="middle" x="659" y="-413.08" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="659" y="-402.08" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="659" y="-391.08" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="659" y="-380.08" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="659" y="-369.08" font-family="Times,serif" font-size="10.00">GPU: 56&#45;59</text>
</g>
<!-- expert_route4&#45;&gt;expert4_3 -->
<g id="edge70" class="edge">
<title>expert_route4&#45;&gt;expert4_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M580.55,-462.05C592.05,-452.15 604.33,-441.6 615.67,-431.84"/>
<polygon fill="black" stroke="black" points="618.06,-434.4 623.36,-425.23 613.49,-429.1 618.06,-434.4"/>
</g>
<!-- expert4_4 -->
<g id="node64" class="node">
<title>expert4_4</title>
<polygon fill="lightgreen" stroke="black" points="1023.5,-425.08 792.5,-425.08 792.5,-362.08 1023.5,-362.08 1023.5,-425.08"/>
<text text-anchor="middle" x="908" y="-413.08" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="908" y="-402.08" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="908" y="-391.08" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="908" y="-380.08" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="908" y="-369.08" font-family="Times,serif" font-size="10.00">GPU: 60&#45;63</text>
</g>
<!-- expert_route4&#45;&gt;expert4_4 -->
<g id="edge71" class="edge">
<title>expert_route4&#45;&gt;expert4_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M601.3,-482.74C654.2,-467.53 729.15,-445.99 791.71,-428"/>
<polygon fill="black" stroke="black" points="793,-431.28 801.64,-425.15 791.06,-424.55 793,-431.28"/>
</g>
<!-- expert_all2all4 -->
<g id="node65" class="node">
<title>expert_all2all4</title>
<ellipse fill="lightblue" stroke="black" cx="478" cy="-280.53" rx="163.18" ry="44.6"/>
<text text-anchor="middle" x="478" y="-300.03" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="478" y="-289.03" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="478" y="-278.03" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1280, hidden=512]</text>
<text text-anchor="middle" x="478" y="-267.03" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="478" y="-256.03" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- expert4_1&#45;&gt;expert_all2all4 -->
<g id="edge72" class="edge">
<title>expert4_1&#45;&gt;expert_all2all4</title>
<path fill="none" stroke="black" d="M248.46,-361.94C285.96,-348.8 330.15,-333.32 369.69,-319.47"/>
<polygon fill="black" stroke="black" points="371.09,-322.69 379.37,-316.08 368.78,-316.08 371.09,-322.69"/>
</g>
<!-- expert4_2&#45;&gt;expert_all2all4 -->
<g id="edge73" class="edge">
<title>expert4_2&#45;&gt;expert_all2all4</title>
<path fill="none" stroke="black" d="M428.76,-361.94C434.23,-353 440.37,-342.98 446.41,-333.12"/>
<polygon fill="black" stroke="black" points="449.43,-334.89 451.67,-324.54 443.46,-331.24 449.43,-334.89"/>
</g>
<!-- expert4_3&#45;&gt;expert_all2all4 -->
<g id="edge74" class="edge">
<title>expert4_3&#45;&gt;expert_all2all4</title>
<path fill="none" stroke="black" d="M609.06,-361.94C591.37,-351.08 571.06,-338.63 551.81,-326.81"/>
<polygon fill="black" stroke="black" points="553.4,-323.68 543.04,-321.44 549.74,-329.65 553.4,-323.68"/>
</g>
<!-- expert4_4&#45;&gt;expert_all2all4 -->
<g id="edge75" class="edge">
<title>expert4_4&#45;&gt;expert_all2all4</title>
<path fill="none" stroke="black" d="M792.49,-362.75C734.52,-347.78 664.17,-329.61 604.72,-314.26"/>
<polygon fill="black" stroke="black" points="605.46,-310.83 594.9,-311.72 603.71,-317.61 605.46,-310.83"/>
</g>
<!-- sp_gather_4 -->
<g id="node66" class="node">
<title>sp_gather_4</title>
<polygon fill="lightyellow" stroke="black" points="723.92,-198.98 332.72,-198.98 232.08,-94.98 623.28,-94.98 723.92,-198.98"/>
<text text-anchor="middle" x="478" y="-160.98" font-family="Times,serif" font-size="10.00">SP GATHER</text>
<text text-anchor="middle" x="478" y="-149.98" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=5120, hidden=512]</text>
<text text-anchor="middle" x="478" y="-138.98" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="478" y="-127.98" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- expert_all2all4&#45;&gt;sp_gather_4 -->
<g id="edge76" class="edge">
<title>expert_all2all4&#45;&gt;sp_gather_4</title>
<path fill="none" stroke="black" d="M478,-235.73C478,-227.35 478,-218.43 478,-209.61"/>
<polygon fill="black" stroke="black" points="481.5,-209.34 478,-199.34 474.5,-209.34 481.5,-209.34"/>
</g>
<!-- final_output -->
<g id="node67" class="node">
<title>final_output</title>
<ellipse fill="white" stroke="black" stroke-width="3" cx="478" cy="-28.99" rx="167.67" ry="28.98"/>
<text text-anchor="middle" x="478" y="-37.49" font-family="Times,serif" font-size="10.00">FINAL OUTPUT</text>
<text text-anchor="middle" x="478" y="-26.49" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=10240, hidden=512]</text>
<text text-anchor="middle" x="478" y="-15.49" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=10240, hidden=512]</text>
</g>
<!-- sp_gather_4&#45;&gt;final_output -->
<g id="edge77" class="edge">
<title>sp_gather_4&#45;&gt;final_output</title>
<path fill="none" stroke="black" d="M478,-94.77C478,-85.8 478,-76.6 478,-68.06"/>
<polygon fill="black" stroke="black" points="481.5,-68.03 478,-58.03 474.5,-68.03 481.5,-68.03"/>
</g>
<!-- decode_start -->
<g id="node68" class="node">
<title>decode_start</title>
<polygon fill="red" stroke="black" points="1461,-5149.67 1257,-5149.67 1257,-5096.67 1461,-5096.67 1461,-5149.67"/>
<text text-anchor="middle" x="1359" y="-5134.47" font-family="Times,serif" font-size="14.00">DECODE PHASE</text>
<text text-anchor="middle" x="1359" y="-5119.47" font-family="Times,serif" font-size="14.00">PP=4, EP=4, TP=2, SP=1</text>
<text text-anchor="middle" x="1359" y="-5104.47" font-family="Times,serif" font-size="14.00">32 GPUs Total</text>
</g>
<!-- decode_input -->
<g id="node69" class="node">
<title>decode_input</title>
<ellipse fill="pink" stroke="black" stroke-width="3" cx="1630" cy="-5123.17" rx="150.73" ry="36.54"/>
<text text-anchor="middle" x="1630" y="-5137.17" font-family="Times,serif" font-size="10.00">DECODE INPUT</text>
<text text-anchor="middle" x="1630" y="-5126.17" font-family="Times,serif" font-size="10.00">Single Token</text>
<text text-anchor="middle" x="1630" y="-5115.17" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1630" y="-5104.17" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
</g>
<!-- decode_layernorm1 -->
<g id="node71" class="node">
<title>decode_layernorm1</title>
<polygon fill="lightgreen" stroke="black" points="1736.5,-5023.4 1523.5,-5023.4 1523.5,-4971.4 1736.5,-4971.4 1736.5,-5023.4"/>
<text text-anchor="middle" x="1630" y="-5011.4" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="1630" y="-5000.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1630" y="-4989.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1630" y="-4978.4" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- decode_input&#45;&gt;decode_layernorm1 -->
<g id="edge78" class="edge">
<title>decode_input&#45;&gt;decode_layernorm1</title>
<path fill="none" stroke="black" d="M1630,-5086.37C1630,-5069.85 1630,-5050.3 1630,-5033.83"/>
<polygon fill="black" stroke="black" points="1633.5,-5033.52 1630,-5023.52 1626.5,-5033.52 1633.5,-5033.52"/>
</g>
<!-- decode_stage1 -->
<g id="node70" class="node">
<title>decode_stage1</title>
<polygon fill="purple" stroke="black" points="1927.5,-5146.67 1798.5,-5146.67 1798.5,-5099.67 1927.5,-5099.67 1927.5,-5146.67"/>
<text text-anchor="middle" x="1863" y="-5133.07" font-family="Times,serif" font-size="12.00">DECODE STAGE 1</text>
<text text-anchor="middle" x="1863" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 1&#45;4</text>
<text text-anchor="middle" x="1863" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 0&#45;15</text>
</g>
<!-- decode_attn_qkv1_1 -->
<g id="node72" class="node">
<title>decode_attn_qkv1_1</title>
<polygon fill="lightgreen" stroke="black" points="1509.5,-4908.4 1296.5,-4908.4 1296.5,-4845.4 1509.5,-4845.4 1509.5,-4908.4"/>
<text text-anchor="middle" x="1403" y="-4896.4" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1403" y="-4885.4" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1403" y="-4874.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1403" y="-4863.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1403" y="-4852.4" font-family="Times,serif" font-size="10.00">GPU: 0&#45;7</text>
</g>
<!-- decode_layernorm1&#45;&gt;decode_attn_qkv1_1 -->
<g id="edge79" class="edge">
<title>decode_layernorm1&#45;&gt;decode_attn_qkv1_1</title>
<path fill="none" stroke="black" d="M1581.86,-4971.27C1549.47,-4954.36 1506.3,-4931.82 1470.49,-4913.13"/>
<polygon fill="black" stroke="black" points="1472.03,-4909.99 1461.55,-4908.46 1468.8,-4916.19 1472.03,-4909.99"/>
</g>
<!-- decode_attn_qkv1_2 -->
<g id="node73" class="node">
<title>decode_attn_qkv1_2</title>
<polygon fill="lightgreen" stroke="black" points="1740.5,-4908.4 1527.5,-4908.4 1527.5,-4845.4 1740.5,-4845.4 1740.5,-4908.4"/>
<text text-anchor="middle" x="1634" y="-4896.4" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1634" y="-4885.4" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1634" y="-4874.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1634" y="-4863.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1634" y="-4852.4" font-family="Times,serif" font-size="10.00">GPU: 8&#45;15</text>
</g>
<!-- decode_layernorm1&#45;&gt;decode_attn_qkv1_2 -->
<g id="edge80" class="edge">
<title>decode_layernorm1&#45;&gt;decode_attn_qkv1_2</title>
<path fill="none" stroke="black" d="M1630.85,-4971.27C1631.36,-4956.08 1632.03,-4936.35 1632.61,-4918.94"/>
<polygon fill="black" stroke="black" points="1636.13,-4918.57 1632.97,-4908.46 1629.13,-4918.34 1636.13,-4918.57"/>
</g>
<!-- decode_attn1_1 -->
<g id="node74" class="node">
<title>decode_attn1_1</title>
<polygon fill="lightgreen" stroke="black" points="1509.5,-4808.4 1296.5,-4808.4 1296.5,-4745.4 1509.5,-4745.4 1509.5,-4808.4"/>
<text text-anchor="middle" x="1403" y="-4796.4" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1403" y="-4785.4" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1403" y="-4774.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1403" y="-4763.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1403" y="-4752.4" font-family="Times,serif" font-size="10.00">GPU: 0&#45;7</text>
</g>
<!-- decode_attn_qkv1_1&#45;&gt;decode_attn1_1 -->
<g id="edge81" class="edge">
<title>decode_attn_qkv1_1&#45;&gt;decode_attn1_1</title>
<path fill="none" stroke="black" d="M1403,-4845.16C1403,-4836.77 1403,-4827.54 1403,-4818.68"/>
<polygon fill="black" stroke="black" points="1406.5,-4818.53 1403,-4808.53 1399.5,-4818.53 1406.5,-4818.53"/>
</g>
<!-- decode_attn1_2 -->
<g id="node75" class="node">
<title>decode_attn1_2</title>
<polygon fill="lightgreen" stroke="black" points="1740.5,-4808.4 1527.5,-4808.4 1527.5,-4745.4 1740.5,-4745.4 1740.5,-4808.4"/>
<text text-anchor="middle" x="1634" y="-4796.4" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1634" y="-4785.4" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1634" y="-4774.4" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1634" y="-4763.4" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1634" y="-4752.4" font-family="Times,serif" font-size="10.00">GPU: 8&#45;15</text>
</g>
<!-- decode_attn_qkv1_2&#45;&gt;decode_attn1_2 -->
<g id="edge82" class="edge">
<title>decode_attn_qkv1_2&#45;&gt;decode_attn1_2</title>
<path fill="none" stroke="black" d="M1634,-4845.16C1634,-4836.77 1634,-4827.54 1634,-4818.68"/>
<polygon fill="black" stroke="black" points="1637.5,-4818.53 1634,-4808.53 1630.5,-4818.53 1637.5,-4818.53"/>
</g>
<!-- decode_attn_gather1 -->
<g id="node76" class="node">
<title>decode_attn_gather1</title>
<ellipse fill="lightblue" stroke="black" cx="1435" cy="-4663.85" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1435" y="-4683.35" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="1435" y="-4672.35" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="1435" y="-4661.35" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1435" y="-4650.35" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1435" y="-4639.35" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- decode_attn1_1&#45;&gt;decode_attn_gather1 -->
<g id="edge83" class="edge">
<title>decode_attn1_1&#45;&gt;decode_attn_gather1</title>
<path fill="none" stroke="black" d="M1411.83,-4745.26C1414.27,-4736.78 1417,-4727.32 1419.7,-4717.95"/>
<polygon fill="black" stroke="black" points="1423.08,-4718.85 1422.49,-4708.27 1416.36,-4716.91 1423.08,-4718.85"/>
</g>
<!-- decode_attn1_2&#45;&gt;decode_attn_gather1 -->
<g id="edge84" class="edge">
<title>decode_attn1_2&#45;&gt;decode_attn_gather1</title>
<path fill="none" stroke="black" d="M1579.1,-4745.26C1558.77,-4733.92 1535.32,-4720.83 1513.31,-4708.55"/>
<polygon fill="black" stroke="black" points="1514.75,-4705.35 1504.31,-4703.53 1511.34,-4711.46 1514.75,-4705.35"/>
</g>
<!-- decode_mlp_gate1 -->
<g id="node77" class="node">
<title>decode_mlp_gate1</title>
<polygon fill="lightgreen" stroke="black" points="1554,-4563.75 1316,-4563.75 1316,-4511.75 1554,-4511.75 1554,-4563.75"/>
<text text-anchor="middle" x="1435" y="-4551.75" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="1435" y="-4540.75" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1435" y="-4529.75" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, num_experts=16]</text>
<text text-anchor="middle" x="1435" y="-4518.75" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- decode_attn_gather1&#45;&gt;decode_mlp_gate1 -->
<g id="edge85" class="edge">
<title>decode_attn_gather1&#45;&gt;decode_mlp_gate1</title>
<path fill="none" stroke="black" d="M1435,-4619.1C1435,-4604.42 1435,-4588.24 1435,-4574.27"/>
<polygon fill="black" stroke="black" points="1438.5,-4574.08 1435,-4564.08 1431.5,-4574.08 1438.5,-4574.08"/>
</g>
<!-- decode_expert_route1 -->
<g id="node78" class="node">
<title>decode_expert_route1</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="1531.34,-4456.21 1378.09,-4456.21 1338.66,-4374.21 1491.91,-4374.21 1531.34,-4456.21"/>
<text text-anchor="middle" x="1435" y="-4423.71" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="1435" y="-4412.71" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="1435" y="-4401.71" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- decode_mlp_gate1&#45;&gt;decode_expert_route1 -->
<g id="edge86" class="edge">
<title>decode_mlp_gate1&#45;&gt;decode_expert_route1</title>
<path fill="none" stroke="black" d="M1435,-4511.48C1435,-4498.58 1435,-4482.41 1435,-4467.06"/>
<polygon fill="black" stroke="black" points="1438.5,-4466.63 1435,-4456.63 1431.5,-4466.63 1438.5,-4466.63"/>
</g>
<!-- decode_expert1_1 -->
<g id="node79" class="node">
<title>decode_expert1_1</title>
<polygon fill="lightgreen" stroke="black" points="1095.5,-4327.71 882.5,-4327.71 882.5,-4264.71 1095.5,-4264.71 1095.5,-4327.71"/>
<text text-anchor="middle" x="989" y="-4315.71" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="989" y="-4304.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="989" y="-4293.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="989" y="-4282.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="989" y="-4271.71" font-family="Times,serif" font-size="10.00">GPU: 0&#45;3</text>
</g>
<!-- decode_expert_route1&#45;&gt;decode_expert1_1 -->
<g id="edge87" class="edge">
<title>decode_expert_route1&#45;&gt;decode_expert1_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1349.32,-4396.89C1282.11,-4382.68 1186.46,-4361.07 1104,-4337.21 1097.16,-4335.23 1090.13,-4333.08 1083.07,-4330.83"/>
<polygon fill="black" stroke="black" points="1084.05,-4327.47 1073.46,-4327.72 1081.9,-4334.13 1084.05,-4327.47"/>
</g>
<!-- decode_expert1_2 -->
<g id="node80" class="node">
<title>decode_expert1_2</title>
<polygon fill="lightgreen" stroke="black" points="1326.5,-4327.71 1113.5,-4327.71 1113.5,-4264.71 1326.5,-4264.71 1326.5,-4327.71"/>
<text text-anchor="middle" x="1220" y="-4315.71" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="1220" y="-4304.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1220" y="-4293.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1220" y="-4282.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1220" y="-4271.71" font-family="Times,serif" font-size="10.00">GPU: 4&#45;7</text>
</g>
<!-- decode_expert_route1&#45;&gt;decode_expert1_2 -->
<g id="edge88" class="edge">
<title>decode_expert_route1&#45;&gt;decode_expert1_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1361.31,-4374.11C1336.63,-4360.67 1309.3,-4345.8 1285.3,-4332.74"/>
<polygon fill="black" stroke="black" points="1286.73,-4329.54 1276.28,-4327.83 1283.39,-4335.69 1286.73,-4329.54"/>
</g>
<!-- decode_expert1_3 -->
<g id="node81" class="node">
<title>decode_expert1_3</title>
<polygon fill="lightgreen" stroke="black" points="1557.5,-4327.71 1344.5,-4327.71 1344.5,-4264.71 1557.5,-4264.71 1557.5,-4327.71"/>
<text text-anchor="middle" x="1451" y="-4315.71" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="1451" y="-4304.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1451" y="-4293.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1451" y="-4282.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1451" y="-4271.71" font-family="Times,serif" font-size="10.00">GPU: 8&#45;11</text>
</g>
<!-- decode_expert_route1&#45;&gt;decode_expert1_3 -->
<g id="edge89" class="edge">
<title>decode_expert_route1&#45;&gt;decode_expert1_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1440.51,-4373.94C1442.1,-4362.29 1443.84,-4349.56 1445.44,-4337.87"/>
<polygon fill="black" stroke="black" points="1448.91,-4338.31 1446.8,-4327.93 1441.98,-4337.37 1448.91,-4338.31"/>
</g>
<!-- decode_expert1_4 -->
<g id="node82" class="node">
<title>decode_expert1_4</title>
<polygon fill="lightgreen" stroke="black" points="1788.5,-4327.71 1575.5,-4327.71 1575.5,-4264.71 1788.5,-4264.71 1788.5,-4327.71"/>
<text text-anchor="middle" x="1682" y="-4315.71" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1682" y="-4304.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1682" y="-4293.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1682" y="-4282.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1682" y="-4271.71" font-family="Times,serif" font-size="10.00">GPU: 12&#45;15</text>
</g>
<!-- decode_expert_route1&#45;&gt;decode_expert1_4 -->
<g id="edge90" class="edge">
<title>decode_expert_route1&#45;&gt;decode_expert1_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1497.33,-4384.68C1531.04,-4368.71 1572.9,-4348.89 1608.23,-4332.15"/>
<polygon fill="black" stroke="black" points="1610,-4335.19 1617.54,-4327.74 1607,-4328.86 1610,-4335.19"/>
</g>
<!-- decode_expert_all2all1 -->
<g id="node83" class="node">
<title>decode_expert_all2all1</title>
<ellipse fill="lightblue" stroke="black" cx="1376" cy="-4173.66" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1376" y="-4193.16" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="1376" y="-4182.16" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="1376" y="-4171.16" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1376" y="-4160.16" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1376" y="-4149.16" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- decode_expert1_1&#45;&gt;decode_expert_all2all1 -->
<g id="edge91" class="edge">
<title>decode_expert1_1&#45;&gt;decode_expert_all2all1</title>
<path fill="none" stroke="black" d="M1075.51,-4264.63C1085.1,-4261.38 1094.74,-4258.18 1104,-4255.21 1154.66,-4238.91 1211.01,-4222.01 1259.23,-4207.94"/>
<polygon fill="black" stroke="black" points="1260.45,-4211.23 1269.07,-4205.07 1258.49,-4204.51 1260.45,-4211.23"/>
</g>
<!-- decode_expert1_2&#45;&gt;decode_expert_all2all1 -->
<g id="edge92" class="edge">
<title>decode_expert1_2&#45;&gt;decode_expert_all2all1</title>
<path fill="none" stroke="black" d="M1259.77,-4264.48C1276.44,-4251.59 1296.21,-4236.31 1314.68,-4222.05"/>
<polygon fill="black" stroke="black" points="1317.28,-4224.46 1323.05,-4215.57 1313,-4218.92 1317.28,-4224.46"/>
</g>
<!-- decode_expert1_3&#45;&gt;decode_expert_all2all1 -->
<g id="edge93" class="edge">
<title>decode_expert1_3&#45;&gt;decode_expert_all2all1</title>
<path fill="none" stroke="black" d="M1431.88,-4264.48C1424.69,-4252.91 1416.29,-4239.42 1408.23,-4226.47"/>
<polygon fill="black" stroke="black" points="1410.98,-4224.25 1402.72,-4217.61 1405.04,-4227.95 1410.98,-4224.25"/>
</g>
<!-- decode_expert1_4&#45;&gt;decode_expert_all2all1 -->
<g id="edge94" class="edge">
<title>decode_expert1_4&#45;&gt;decode_expert_all2all1</title>
<path fill="none" stroke="black" d="M1604.39,-4264.63C1564.88,-4249.07 1516.43,-4229.98 1474.34,-4213.4"/>
<polygon fill="black" stroke="black" points="1475.49,-4210.09 1464.91,-4209.68 1472.93,-4216.6 1475.49,-4210.09"/>
</g>
<!-- decode_stage1_output -->
<g id="node84" class="node">
<title>decode_stage1_output</title>
<ellipse fill="lightcyan" stroke="black" cx="1376" cy="-4047.56" rx="150.73" ry="36.54"/>
<text text-anchor="middle" x="1376" y="-4061.56" font-family="Times,serif" font-size="10.00">DECODE STAGE 1 OUTPUT</text>
<text text-anchor="middle" x="1376" y="-4050.56" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1376" y="-4039.56" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1376" y="-4028.56" font-family="Times,serif" font-size="10.00">GPU: 0&#45;15</text>
</g>
<!-- decode_expert_all2all1&#45;&gt;decode_stage1_output -->
<g id="edge95" class="edge">
<title>decode_expert_all2all1&#45;&gt;decode_stage1_output</title>
<path fill="none" stroke="black" d="M1376,-4128.91C1376,-4117.79 1376,-4105.82 1376,-4094.6"/>
<polygon fill="black" stroke="black" points="1379.5,-4094.55 1376,-4084.55 1372.5,-4094.55 1379.5,-4094.55"/>
</g>
<!-- decode_layernorm2 -->
<g id="node86" class="node">
<title>decode_layernorm2</title>
<polygon fill="lightgreen" stroke="black" points="1482.5,-3911.02 1269.5,-3911.02 1269.5,-3859.02 1482.5,-3859.02 1482.5,-3911.02"/>
<text text-anchor="middle" x="1376" y="-3899.02" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="1376" y="-3888.02" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1376" y="-3877.02" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1376" y="-3866.02" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- decode_stage1_output&#45;&gt;decode_layernorm2 -->
<g id="edge96" class="edge">
<title>decode_stage1_output&#45;&gt;decode_layernorm2</title>
<path fill="none" stroke="black" stroke-width="2" d="M1376,-4010.53C1376,-3984.04 1376,-3948.21 1376,-3921.78"/>
<polygon fill="black" stroke="black" stroke-width="2" points="1379.5,-3921.44 1376,-3911.44 1372.5,-3921.44 1379.5,-3921.44"/>
<text text-anchor="middle" x="1442.5" y="-3973.82" font-family="Times,serif" font-size="14.00">Pipeline</text>
<text text-anchor="middle" x="1442.5" y="-3958.82" font-family="Times,serif" font-size="14.00">Decode Stage 1→2</text>
</g>
<!-- decode_stage2 -->
<g id="node85" class="node">
<title>decode_stage2</title>
<polygon fill="purple" stroke="black" points="2074.5,-5146.67 1945.5,-5146.67 1945.5,-5099.67 2074.5,-5099.67 2074.5,-5146.67"/>
<text text-anchor="middle" x="2010" y="-5133.07" font-family="Times,serif" font-size="12.00">DECODE STAGE 2</text>
<text text-anchor="middle" x="2010" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 5&#45;8</text>
<text text-anchor="middle" x="2010" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 16&#45;31</text>
</g>
<!-- decode_attn_qkv2_1 -->
<g id="node87" class="node">
<title>decode_attn_qkv2_1</title>
<polygon fill="lightgreen" stroke="black" points="1422.5,-3746.52 1209.5,-3746.52 1209.5,-3683.52 1422.5,-3683.52 1422.5,-3746.52"/>
<text text-anchor="middle" x="1316" y="-3734.52" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1316" y="-3723.52" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1316" y="-3712.52" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1316" y="-3701.52" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1316" y="-3690.52" font-family="Times,serif" font-size="10.00">GPU: 16&#45;23</text>
</g>
<!-- decode_layernorm2&#45;&gt;decode_attn_qkv2_1 -->
<g id="edge97" class="edge">
<title>decode_layernorm2&#45;&gt;decode_attn_qkv2_1</title>
<path fill="none" stroke="black" d="M1367.02,-3858.86C1357.33,-3831.74 1341.77,-3788.16 1330.37,-3756.26"/>
<polygon fill="black" stroke="black" points="1333.64,-3755 1326.98,-3746.76 1327.05,-3757.36 1333.64,-3755"/>
</g>
<!-- decode_attn_qkv2_2 -->
<g id="node88" class="node">
<title>decode_attn_qkv2_2</title>
<polygon fill="lightgreen" stroke="black" points="1653.5,-3746.52 1440.5,-3746.52 1440.5,-3683.52 1653.5,-3683.52 1653.5,-3746.52"/>
<text text-anchor="middle" x="1547" y="-3734.52" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1547" y="-3723.52" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1547" y="-3712.52" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1547" y="-3701.52" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1547" y="-3690.52" font-family="Times,serif" font-size="10.00">GPU: 24&#45;31</text>
</g>
<!-- decode_layernorm2&#45;&gt;decode_attn_qkv2_2 -->
<g id="edge98" class="edge">
<title>decode_layernorm2&#45;&gt;decode_attn_qkv2_2</title>
<path fill="none" stroke="black" d="M1401.6,-3858.86C1429.92,-3831.04 1475.87,-3785.89 1508.53,-3753.81"/>
<polygon fill="black" stroke="black" points="1511.02,-3756.27 1515.7,-3746.76 1506.12,-3751.28 1511.02,-3756.27"/>
</g>
<!-- decode_attn2_1 -->
<g id="node89" class="node">
<title>decode_attn2_1</title>
<polygon fill="lightgreen" stroke="black" points="1422.5,-3626.02 1209.5,-3626.02 1209.5,-3563.02 1422.5,-3563.02 1422.5,-3626.02"/>
<text text-anchor="middle" x="1316" y="-3614.02" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1316" y="-3603.02" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1316" y="-3592.02" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1316" y="-3581.02" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1316" y="-3570.02" font-family="Times,serif" font-size="10.00">GPU: 16&#45;23</text>
</g>
<!-- decode_attn_qkv2_1&#45;&gt;decode_attn2_1 -->
<g id="edge99" class="edge">
<title>decode_attn_qkv2_1&#45;&gt;decode_attn2_1</title>
<path fill="none" stroke="black" d="M1316,-3683.5C1316,-3669.24 1316,-3652.04 1316,-3636.65"/>
<polygon fill="black" stroke="black" points="1319.5,-3636.34 1316,-3626.34 1312.5,-3636.34 1319.5,-3636.34"/>
</g>
<!-- decode_attn2_2 -->
<g id="node90" class="node">
<title>decode_attn2_2</title>
<polygon fill="lightgreen" stroke="black" points="1653.5,-3626.02 1440.5,-3626.02 1440.5,-3563.02 1653.5,-3563.02 1653.5,-3626.02"/>
<text text-anchor="middle" x="1547" y="-3614.02" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1547" y="-3603.02" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1547" y="-3592.02" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1547" y="-3581.02" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1547" y="-3570.02" font-family="Times,serif" font-size="10.00">GPU: 24&#45;31</text>
</g>
<!-- decode_attn_qkv2_2&#45;&gt;decode_attn2_2 -->
<g id="edge100" class="edge">
<title>decode_attn_qkv2_2&#45;&gt;decode_attn2_2</title>
<path fill="none" stroke="black" d="M1547,-3683.5C1547,-3669.24 1547,-3652.04 1547,-3636.65"/>
<polygon fill="black" stroke="black" points="1550.5,-3636.34 1547,-3626.34 1543.5,-3636.34 1550.5,-3636.34"/>
</g>
<!-- decode_attn_gather2 -->
<g id="node91" class="node">
<title>decode_attn_gather2</title>
<ellipse fill="lightblue" stroke="black" cx="1395" cy="-3481.47" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1395" y="-3500.97" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="1395" y="-3489.97" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="1395" y="-3478.97" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1395" y="-3467.97" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1395" y="-3456.97" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- decode_attn2_1&#45;&gt;decode_attn_gather2 -->
<g id="edge101" class="edge">
<title>decode_attn2_1&#45;&gt;decode_attn_gather2</title>
<path fill="none" stroke="black" d="M1337.8,-3562.88C1344.22,-3553.85 1351.43,-3543.71 1358.51,-3533.76"/>
<polygon fill="black" stroke="black" points="1361.46,-3535.65 1364.41,-3525.47 1355.76,-3531.59 1361.46,-3535.65"/>
</g>
<!-- decode_attn2_2&#45;&gt;decode_attn_gather2 -->
<g id="edge102" class="edge">
<title>decode_attn2_2&#45;&gt;decode_attn_gather2</title>
<path fill="none" stroke="black" d="M1505.06,-3562.88C1490.7,-3552.38 1474.28,-3540.39 1458.59,-3528.93"/>
<polygon fill="black" stroke="black" points="1460.61,-3526.06 1450.47,-3522.99 1456.48,-3531.72 1460.61,-3526.06"/>
</g>
<!-- decode_mlp_gate2 -->
<g id="node92" class="node">
<title>decode_mlp_gate2</title>
<polygon fill="lightgreen" stroke="black" points="1514,-3394.42 1276,-3394.42 1276,-3342.42 1514,-3342.42 1514,-3394.42"/>
<text text-anchor="middle" x="1395" y="-3382.42" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="1395" y="-3371.42" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1395" y="-3360.42" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, num_experts=16]</text>
<text text-anchor="middle" x="1395" y="-3349.42" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- decode_attn_gather2&#45;&gt;decode_mlp_gate2 -->
<g id="edge103" class="edge">
<title>decode_attn_gather2&#45;&gt;decode_mlp_gate2</title>
<path fill="none" stroke="black" d="M1395,-3436.9C1395,-3426.25 1395,-3415 1395,-3404.79"/>
<polygon fill="black" stroke="black" points="1398.5,-3404.6 1395,-3394.6 1391.5,-3404.6 1398.5,-3404.6"/>
</g>
<!-- decode_expert_route2 -->
<g id="node93" class="node">
<title>decode_expert_route2</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="1491.34,-3296.37 1338.09,-3296.37 1298.66,-3214.37 1451.91,-3214.37 1491.34,-3296.37"/>
<text text-anchor="middle" x="1395" y="-3263.87" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="1395" y="-3252.87" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="1395" y="-3241.87" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- decode_mlp_gate2&#45;&gt;decode_expert_route2 -->
<g id="edge104" class="edge">
<title>decode_mlp_gate2&#45;&gt;decode_expert_route2</title>
<path fill="none" stroke="black" d="M1395,-3342.22C1395,-3331.72 1395,-3319.14 1395,-3306.88"/>
<polygon fill="black" stroke="black" points="1398.5,-3306.72 1395,-3296.72 1391.5,-3306.72 1398.5,-3306.72"/>
</g>
<!-- decode_expert2_1 -->
<g id="node94" class="node">
<title>decode_expert2_1</title>
<polygon fill="lightgreen" stroke="black" points="1116.5,-3173.82 903.5,-3173.82 903.5,-3110.82 1116.5,-3110.82 1116.5,-3173.82"/>
<text text-anchor="middle" x="1010" y="-3161.82" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="1010" y="-3150.82" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1010" y="-3139.82" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1010" y="-3128.82" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1010" y="-3117.82" font-family="Times,serif" font-size="10.00">GPU: 16&#45;19</text>
</g>
<!-- decode_expert_route2&#45;&gt;decode_expert2_1 -->
<g id="edge105" class="edge">
<title>decode_expert_route2&#45;&gt;decode_expert2_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1305.22,-3228.48C1251.76,-3213.06 1183.36,-3193.33 1125.86,-3176.74"/>
<polygon fill="black" stroke="black" points="1126.58,-3173.31 1116,-3173.9 1124.64,-3180.03 1126.58,-3173.31"/>
</g>
<!-- decode_expert2_2 -->
<g id="node95" class="node">
<title>decode_expert2_2</title>
<polygon fill="lightgreen" stroke="black" points="1347.5,-3173.82 1134.5,-3173.82 1134.5,-3110.82 1347.5,-3110.82 1347.5,-3173.82"/>
<text text-anchor="middle" x="1241" y="-3161.82" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="1241" y="-3150.82" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1241" y="-3139.82" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1241" y="-3128.82" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1241" y="-3117.82" font-family="Times,serif" font-size="10.00">GPU: 20&#45;23</text>
</g>
<!-- decode_expert_route2&#45;&gt;decode_expert2_2 -->
<g id="edge106" class="edge">
<title>decode_expert_route2&#45;&gt;decode_expert2_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1339.4,-3214.28C1323.85,-3203.06 1307.02,-3190.93 1291.76,-3179.93"/>
<polygon fill="black" stroke="black" points="1293.62,-3176.95 1283.46,-3173.94 1289.53,-3182.63 1293.62,-3176.95"/>
</g>
<!-- decode_expert2_3 -->
<g id="node96" class="node">
<title>decode_expert2_3</title>
<polygon fill="lightgreen" stroke="black" points="1578.5,-3173.82 1365.5,-3173.82 1365.5,-3110.82 1578.5,-3110.82 1578.5,-3173.82"/>
<text text-anchor="middle" x="1472" y="-3161.82" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="1472" y="-3150.82" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1472" y="-3139.82" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1472" y="-3128.82" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1472" y="-3117.82" font-family="Times,serif" font-size="10.00">GPU: 24&#45;27</text>
</g>
<!-- decode_expert_route2&#45;&gt;decode_expert2_3 -->
<g id="edge107" class="edge">
<title>decode_expert_route2&#45;&gt;decode_expert2_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1422.8,-3214.28C1430,-3203.89 1437.75,-3192.73 1444.91,-3182.39"/>
<polygon fill="black" stroke="black" points="1447.95,-3184.16 1450.77,-3173.94 1442.19,-3180.17 1447.95,-3184.16"/>
</g>
<!-- decode_expert2_4 -->
<g id="node97" class="node">
<title>decode_expert2_4</title>
<polygon fill="lightgreen" stroke="black" points="1809.5,-3173.82 1596.5,-3173.82 1596.5,-3110.82 1809.5,-3110.82 1809.5,-3173.82"/>
<text text-anchor="middle" x="1703" y="-3161.82" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1703" y="-3150.82" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1703" y="-3139.82" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1703" y="-3128.82" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1703" y="-3117.82" font-family="Times,serif" font-size="10.00">GPU: 28&#45;31</text>
</g>
<!-- decode_expert_route2&#45;&gt;decode_expert2_4 -->
<g id="edge108" class="edge">
<title>decode_expert_route2&#45;&gt;decode_expert2_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1459.94,-3230.96C1503.13,-3215.39 1560.55,-3194.68 1608.74,-3177.31"/>
<polygon fill="black" stroke="black" points="1610.02,-3180.57 1618.24,-3173.88 1607.65,-3173.98 1610.02,-3180.57"/>
</g>
<!-- decode_expert_all2all2 -->
<g id="node98" class="node">
<title>decode_expert_all2all2</title>
<ellipse fill="lightblue" stroke="black" cx="1363" cy="-3029.28" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1363" y="-3048.78" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="1363" y="-3037.78" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="1363" y="-3026.78" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1363" y="-3015.78" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1363" y="-3004.78" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- decode_expert2_1&#45;&gt;decode_expert_all2all2 -->
<g id="edge109" class="edge">
<title>decode_expert2_1&#45;&gt;decode_expert_all2all2</title>
<path fill="none" stroke="black" d="M1107.39,-3110.69C1152.07,-3096.63 1205.27,-3079.89 1251.54,-3065.34"/>
<polygon fill="black" stroke="black" points="1252.82,-3068.61 1261.31,-3062.27 1250.72,-3061.93 1252.82,-3068.61"/>
</g>
<!-- decode_expert2_2&#45;&gt;decode_expert_all2all2 -->
<g id="edge110" class="edge">
<title>decode_expert2_2&#45;&gt;decode_expert_all2all2</title>
<path fill="none" stroke="black" d="M1274.66,-3110.69C1285.42,-3100.89 1297.61,-3089.79 1309.43,-3079.04"/>
<polygon fill="black" stroke="black" points="1312.08,-3081.36 1317.12,-3072.04 1307.37,-3076.18 1312.08,-3081.36"/>
</g>
<!-- decode_expert2_3&#45;&gt;decode_expert_all2all2 -->
<g id="edge111" class="edge">
<title>decode_expert2_3&#45;&gt;decode_expert_all2all2</title>
<path fill="none" stroke="black" d="M1441.93,-3110.69C1432.51,-3101.09 1421.86,-3090.24 1411.5,-3079.69"/>
<polygon fill="black" stroke="black" points="1413.9,-3077.14 1404.4,-3072.45 1408.9,-3082.04 1413.9,-3077.14"/>
</g>
<!-- decode_expert2_4&#45;&gt;decode_expert_all2all2 -->
<g id="edge112" class="edge">
<title>decode_expert2_4&#45;&gt;decode_expert_all2all2</title>
<path fill="none" stroke="black" d="M1609.19,-3110.69C1566.71,-3096.81 1516.22,-3080.32 1472.06,-3065.9"/>
<polygon fill="black" stroke="black" points="1473.03,-3062.53 1462.44,-3062.76 1470.86,-3069.19 1473.03,-3062.53"/>
</g>
<!-- decode_stage2_output -->
<g id="node99" class="node">
<title>decode_stage2_output</title>
<ellipse fill="lightcyan" stroke="black" cx="1363" cy="-2910.96" rx="150.73" ry="36.54"/>
<text text-anchor="middle" x="1363" y="-2924.96" font-family="Times,serif" font-size="10.00">DECODE STAGE 2 OUTPUT</text>
<text text-anchor="middle" x="1363" y="-2913.96" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1363" y="-2902.96" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1363" y="-2891.96" font-family="Times,serif" font-size="10.00">GPU: 16&#45;31</text>
</g>
<!-- decode_expert_all2all2&#45;&gt;decode_stage2_output -->
<g id="edge113" class="edge">
<title>decode_expert_all2all2&#45;&gt;decode_stage2_output</title>
<path fill="none" stroke="black" d="M1363,-2984.63C1363,-2975.92 1363,-2966.75 1363,-2957.96"/>
<polygon fill="black" stroke="black" points="1366.5,-2957.87 1363,-2947.87 1359.5,-2957.87 1366.5,-2957.87"/>
</g>
<!-- decode_layernorm3 -->
<g id="node101" class="node">
<title>decode_layernorm3</title>
<polygon fill="lightgreen" stroke="black" points="1469.5,-2789.64 1256.5,-2789.64 1256.5,-2737.64 1469.5,-2737.64 1469.5,-2789.64"/>
<text text-anchor="middle" x="1363" y="-2777.64" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="1363" y="-2766.64" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1363" y="-2755.64" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1363" y="-2744.64" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- decode_stage2_output&#45;&gt;decode_layernorm3 -->
<g id="edge114" class="edge">
<title>decode_stage2_output&#45;&gt;decode_layernorm3</title>
<path fill="none" stroke="black" stroke-width="2" d="M1363,-2874.04C1363,-2851.4 1363,-2822.31 1363,-2799.81"/>
<polygon fill="black" stroke="black" stroke-width="2" points="1366.5,-2799.67 1363,-2789.67 1359.5,-2799.67 1366.5,-2799.67"/>
<text text-anchor="middle" x="1429.5" y="-2844.99" font-family="Times,serif" font-size="14.00">Pipeline</text>
<text text-anchor="middle" x="1429.5" y="-2829.99" font-family="Times,serif" font-size="14.00">Decode Stage 2→3</text>
</g>
<!-- decode_stage3 -->
<g id="node100" class="node">
<title>decode_stage3</title>
<polygon fill="purple" stroke="black" points="2221.5,-5146.67 2092.5,-5146.67 2092.5,-5099.67 2221.5,-5099.67 2221.5,-5146.67"/>
<text text-anchor="middle" x="2157" y="-5133.07" font-family="Times,serif" font-size="12.00">DECODE STAGE 3</text>
<text text-anchor="middle" x="2157" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 9&#45;12</text>
<text text-anchor="middle" x="2157" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 32&#45;47</text>
</g>
<!-- decode_attn_qkv3_1 -->
<g id="node102" class="node">
<title>decode_attn_qkv3_1</title>
<polygon fill="lightgreen" stroke="black" points="1377.5,-2661.59 1164.5,-2661.59 1164.5,-2598.59 1377.5,-2598.59 1377.5,-2661.59"/>
<text text-anchor="middle" x="1271" y="-2649.59" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1271" y="-2638.59" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1271" y="-2627.59" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1271" y="-2616.59" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1271" y="-2605.59" font-family="Times,serif" font-size="10.00">GPU: 32&#45;39</text>
</g>
<!-- decode_layernorm3&#45;&gt;decode_attn_qkv3_1 -->
<g id="edge115" class="edge">
<title>decode_layernorm3&#45;&gt;decode_attn_qkv3_1</title>
<path fill="none" stroke="black" d="M1345.48,-2737.59C1332.13,-2718.5 1313.51,-2691.88 1298.23,-2670.03"/>
<polygon fill="black" stroke="black" points="1300.94,-2667.79 1292.34,-2661.6 1295.2,-2671.8 1300.94,-2667.79"/>
</g>
<!-- decode_attn_qkv3_2 -->
<g id="node103" class="node">
<title>decode_attn_qkv3_2</title>
<polygon fill="lightgreen" stroke="black" points="1608.5,-2661.59 1395.5,-2661.59 1395.5,-2598.59 1608.5,-2598.59 1608.5,-2661.59"/>
<text text-anchor="middle" x="1502" y="-2649.59" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1502" y="-2638.59" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1502" y="-2627.59" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1502" y="-2616.59" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1502" y="-2605.59" font-family="Times,serif" font-size="10.00">GPU: 40&#45;47</text>
</g>
<!-- decode_layernorm3&#45;&gt;decode_attn_qkv3_2 -->
<g id="edge116" class="edge">
<title>decode_layernorm3&#45;&gt;decode_attn_qkv3_2</title>
<path fill="none" stroke="black" d="M1389.47,-2737.59C1410.08,-2718.08 1439.02,-2690.7 1462.39,-2668.58"/>
<polygon fill="black" stroke="black" points="1464.91,-2671.02 1469.76,-2661.6 1460.09,-2665.94 1464.91,-2671.02"/>
</g>
<!-- decode_attn3_1 -->
<g id="node104" class="node">
<title>decode_attn3_1</title>
<polygon fill="lightgreen" stroke="black" points="1377.5,-2491.59 1164.5,-2491.59 1164.5,-2428.59 1377.5,-2428.59 1377.5,-2491.59"/>
<text text-anchor="middle" x="1271" y="-2479.59" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1271" y="-2468.59" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1271" y="-2457.59" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1271" y="-2446.59" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1271" y="-2435.59" font-family="Times,serif" font-size="10.00">GPU: 32&#45;39</text>
</g>
<!-- decode_attn_qkv3_1&#45;&gt;decode_attn3_1 -->
<g id="edge117" class="edge">
<title>decode_attn_qkv3_1&#45;&gt;decode_attn3_1</title>
<path fill="none" stroke="black" d="M1271,-2598.28C1271,-2571.17 1271,-2531.49 1271,-2501.77"/>
<polygon fill="black" stroke="black" points="1274.5,-2501.71 1271,-2491.71 1267.5,-2501.71 1274.5,-2501.71"/>
</g>
<!-- decode_attn3_2 -->
<g id="node105" class="node">
<title>decode_attn3_2</title>
<polygon fill="lightgreen" stroke="black" points="1608.5,-2491.59 1395.5,-2491.59 1395.5,-2428.59 1608.5,-2428.59 1608.5,-2491.59"/>
<text text-anchor="middle" x="1502" y="-2479.59" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1502" y="-2468.59" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1502" y="-2457.59" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1502" y="-2446.59" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1502" y="-2435.59" font-family="Times,serif" font-size="10.00">GPU: 40&#45;47</text>
</g>
<!-- decode_attn_qkv3_2&#45;&gt;decode_attn3_2 -->
<g id="edge118" class="edge">
<title>decode_attn_qkv3_2&#45;&gt;decode_attn3_2</title>
<path fill="none" stroke="black" d="M1502,-2598.28C1502,-2571.17 1502,-2531.49 1502,-2501.77"/>
<polygon fill="black" stroke="black" points="1505.5,-2501.71 1502,-2491.71 1498.5,-2501.71 1505.5,-2501.71"/>
</g>
<!-- decode_attn_gather3 -->
<g id="node106" class="node">
<title>decode_attn_gather3</title>
<ellipse fill="lightblue" stroke="black" cx="1380" cy="-2326.55" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1380" y="-2346.05" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="1380" y="-2335.05" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="1380" y="-2324.05" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1380" y="-2313.05" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1380" y="-2302.05" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- decode_attn3_1&#45;&gt;decode_attn_gather3 -->
<g id="edge119" class="edge">
<title>decode_attn3_1&#45;&gt;decode_attn_gather3</title>
<path fill="none" stroke="black" d="M1296.28,-2428.58C1308.72,-2413.58 1324.03,-2395.09 1338.15,-2378.06"/>
<polygon fill="black" stroke="black" points="1340.85,-2380.28 1344.54,-2370.35 1335.46,-2375.81 1340.85,-2380.28"/>
</g>
<!-- decode_attn3_2&#45;&gt;decode_attn_gather3 -->
<g id="edge120" class="edge">
<title>decode_attn3_2&#45;&gt;decode_attn_gather3</title>
<path fill="none" stroke="black" d="M1473.7,-2428.58C1459.66,-2413.45 1442.34,-2394.77 1426.43,-2377.61"/>
<polygon fill="black" stroke="black" points="1428.6,-2374.8 1419.23,-2369.85 1423.46,-2379.56 1428.6,-2374.8"/>
</g>
<!-- decode_mlp_gate3 -->
<g id="node107" class="node">
<title>decode_mlp_gate3</title>
<polygon fill="lightgreen" stroke="black" points="1499,-2239.5 1261,-2239.5 1261,-2187.5 1499,-2187.5 1499,-2239.5"/>
<text text-anchor="middle" x="1380" y="-2227.5" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="1380" y="-2216.5" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1380" y="-2205.5" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, num_experts=16]</text>
<text text-anchor="middle" x="1380" y="-2194.5" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- decode_attn_gather3&#45;&gt;decode_mlp_gate3 -->
<g id="edge121" class="edge">
<title>decode_attn_gather3&#45;&gt;decode_mlp_gate3</title>
<path fill="none" stroke="black" d="M1380,-2281.98C1380,-2271.33 1380,-2260.08 1380,-2249.87"/>
<polygon fill="black" stroke="black" points="1383.5,-2249.68 1380,-2239.68 1376.5,-2249.68 1383.5,-2249.68"/>
</g>
<!-- decode_expert_route3 -->
<g id="node108" class="node">
<title>decode_expert_route3</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="1476.34,-2145 1323.09,-2145 1283.66,-2063 1436.91,-2063 1476.34,-2145"/>
<text text-anchor="middle" x="1380" y="-2112.5" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="1380" y="-2101.5" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="1380" y="-2090.5" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- decode_mlp_gate3&#45;&gt;decode_expert_route3 -->
<g id="edge122" class="edge">
<title>decode_mlp_gate3&#45;&gt;decode_expert_route3</title>
<path fill="none" stroke="black" d="M1380,-2187.3C1380,-2177.7 1380,-2166.39 1380,-2155.28"/>
<polygon fill="black" stroke="black" points="1383.5,-2155.19 1380,-2145.19 1376.5,-2155.19 1383.5,-2155.19"/>
</g>
<!-- decode_expert3_1 -->
<g id="node109" class="node">
<title>decode_expert3_1</title>
<polygon fill="lightgreen" stroke="black" points="1137.5,-2012.95 924.5,-2012.95 924.5,-1949.95 1137.5,-1949.95 1137.5,-2012.95"/>
<text text-anchor="middle" x="1031" y="-2000.95" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="1031" y="-1989.95" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1031" y="-1978.95" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1031" y="-1967.95" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1031" y="-1956.95" font-family="Times,serif" font-size="10.00">GPU: 32&#45;35</text>
</g>
<!-- decode_expert_route3&#45;&gt;decode_expert3_1 -->
<g id="edge123" class="edge">
<title>decode_expert_route3&#45;&gt;decode_expert3_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1288.84,-2074.03C1245.43,-2059.98 1192.87,-2042.58 1146,-2026 1137.5,-2022.99 1128.68,-2019.79 1119.87,-2016.55"/>
<polygon fill="black" stroke="black" points="1120.92,-2013.21 1110.33,-2013.01 1118.49,-2019.77 1120.92,-2013.21"/>
</g>
<!-- decode_expert3_2 -->
<g id="node110" class="node">
<title>decode_expert3_2</title>
<polygon fill="lightgreen" stroke="black" points="1368.5,-2012.95 1155.5,-2012.95 1155.5,-1949.95 1368.5,-1949.95 1368.5,-2012.95"/>
<text text-anchor="middle" x="1262" y="-2000.95" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="1262" y="-1989.95" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1262" y="-1978.95" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1262" y="-1967.95" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1262" y="-1956.95" font-family="Times,serif" font-size="10.00">GPU: 36&#45;39</text>
</g>
<!-- decode_expert_route3&#45;&gt;decode_expert3_2 -->
<g id="edge124" class="edge">
<title>decode_expert_route3&#45;&gt;decode_expert3_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1340.71,-2062.86C1327.36,-2049.22 1312.49,-2034.03 1299.3,-2020.55"/>
<polygon fill="black" stroke="black" points="1301.66,-2017.96 1292.16,-2013.27 1296.66,-2022.86 1301.66,-2017.96"/>
</g>
<!-- decode_expert3_3 -->
<g id="node111" class="node">
<title>decode_expert3_3</title>
<polygon fill="lightgreen" stroke="black" points="1599.5,-2012.95 1386.5,-2012.95 1386.5,-1949.95 1599.5,-1949.95 1599.5,-2012.95"/>
<text text-anchor="middle" x="1493" y="-2000.95" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="1493" y="-1989.95" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1493" y="-1978.95" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1493" y="-1967.95" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1493" y="-1956.95" font-family="Times,serif" font-size="10.00">GPU: 40&#45;43</text>
</g>
<!-- decode_expert_route3&#45;&gt;decode_expert3_3 -->
<g id="edge125" class="edge">
<title>decode_expert_route3&#45;&gt;decode_expert3_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1417.63,-2062.86C1430.29,-2049.35 1444.39,-2034.31 1456.93,-2020.93"/>
<polygon fill="black" stroke="black" points="1459.83,-2022.96 1464.12,-2013.27 1454.72,-2018.17 1459.83,-2022.96"/>
</g>
<!-- decode_expert3_4 -->
<g id="node112" class="node">
<title>decode_expert3_4</title>
<polygon fill="lightgreen" stroke="black" points="1830.5,-2012.95 1617.5,-2012.95 1617.5,-1949.95 1830.5,-1949.95 1830.5,-2012.95"/>
<text text-anchor="middle" x="1724" y="-2000.95" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1724" y="-1989.95" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1724" y="-1978.95" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1724" y="-1967.95" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1724" y="-1956.95" font-family="Times,serif" font-size="10.00">GPU: 44&#45;47</text>
</g>
<!-- decode_expert_route3&#45;&gt;decode_expert3_4 -->
<g id="edge126" class="edge">
<title>decode_expert_route3&#45;&gt;decode_expert3_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1446.05,-2081.34C1491.68,-2066.22 1553.69,-2045.36 1608,-2026 1616.48,-2022.98 1625.29,-2019.78 1634.09,-2016.54"/>
<polygon fill="black" stroke="black" points="1635.46,-2019.77 1643.63,-2013.02 1633.04,-2013.2 1635.46,-2019.77"/>
</g>
<!-- decode_expert_all2all3 -->
<g id="node113" class="node">
<title>decode_expert_all2all3</title>
<ellipse fill="lightblue" stroke="black" cx="1328" cy="-1855.36" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1328" y="-1874.86" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="1328" y="-1863.86" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="1328" y="-1852.86" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1328" y="-1841.86" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1328" y="-1830.86" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- decode_expert3_1&#45;&gt;decode_expert_all2all3 -->
<g id="edge127" class="edge">
<title>decode_expert3_1&#45;&gt;decode_expert_all2all3</title>
<path fill="none" stroke="black" d="M1104.03,-1949.94C1142.92,-1933.69 1191.2,-1913.52 1232.97,-1896.06"/>
<polygon fill="black" stroke="black" points="1234.45,-1899.24 1242.33,-1892.15 1231.75,-1892.78 1234.45,-1899.24"/>
</g>
<!-- decode_expert3_2&#45;&gt;decode_expert_all2all3 -->
<g id="edge128" class="edge">
<title>decode_expert3_2&#45;&gt;decode_expert_all2all3</title>
<path fill="none" stroke="black" d="M1278.31,-1949.78C1284.89,-1937.41 1292.67,-1922.79 1300.09,-1908.83"/>
<polygon fill="black" stroke="black" points="1303.29,-1910.26 1304.9,-1899.79 1297.11,-1906.97 1303.29,-1910.26"/>
</g>
<!-- decode_expert3_3&#45;&gt;decode_expert_all2all3 -->
<g id="edge129" class="edge">
<title>decode_expert3_3&#45;&gt;decode_expert_all2all3</title>
<path fill="none" stroke="black" d="M1452.21,-1949.78C1433.51,-1935.71 1410.93,-1918.72 1390.17,-1903.11"/>
<polygon fill="black" stroke="black" points="1392.11,-1900.19 1382.02,-1896.98 1387.9,-1905.79 1392.11,-1900.19"/>
</g>
<!-- decode_expert3_4&#45;&gt;decode_expert_all2all3 -->
<g id="edge130" class="edge">
<title>decode_expert3_4&#45;&gt;decode_expert_all2all3</title>
<path fill="none" stroke="black" d="M1645.05,-1949.86C1632.71,-1945.35 1620.05,-1940.89 1608,-1936.9 1555.89,-1919.66 1497.65,-1902.56 1447.83,-1888.58"/>
<polygon fill="black" stroke="black" points="1448.56,-1885.15 1437.99,-1885.83 1446.68,-1891.89 1448.56,-1885.15"/>
</g>
<!-- decode_stage3_output -->
<g id="node114" class="node">
<title>decode_stage3_output</title>
<ellipse fill="lightcyan" stroke="black" cx="1328" cy="-1732.81" rx="150.73" ry="36.54"/>
<text text-anchor="middle" x="1328" y="-1746.81" font-family="Times,serif" font-size="10.00">DECODE STAGE 3 OUTPUT</text>
<text text-anchor="middle" x="1328" y="-1735.81" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1328" y="-1724.81" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1328" y="-1713.81" font-family="Times,serif" font-size="10.00">GPU: 32&#45;47</text>
</g>
<!-- decode_expert_all2all3&#45;&gt;decode_stage3_output -->
<g id="edge131" class="edge">
<title>decode_expert_all2all3&#45;&gt;decode_stage3_output</title>
<path fill="none" stroke="black" d="M1328,-1810.49C1328,-1800.6 1328,-1790.07 1328,-1780.08"/>
<polygon fill="black" stroke="black" points="1331.5,-1779.92 1328,-1769.92 1324.5,-1779.92 1331.5,-1779.92"/>
</g>
<!-- decode_layernorm4 -->
<g id="node116" class="node">
<title>decode_layernorm4</title>
<polygon fill="lightgreen" stroke="black" points="1434.5,-1620.31 1221.5,-1620.31 1221.5,-1568.31 1434.5,-1568.31 1434.5,-1620.31"/>
<text text-anchor="middle" x="1328" y="-1608.31" font-family="Times,serif" font-size="10.00">LayerNorm</text>
<text text-anchor="middle" x="1328" y="-1597.31" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1328" y="-1586.31" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1328" y="-1575.31" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- decode_stage3_output&#45;&gt;decode_layernorm4 -->
<g id="edge132" class="edge">
<title>decode_stage3_output&#45;&gt;decode_layernorm4</title>
<path fill="none" stroke="black" stroke-width="2" d="M1328,-1695.94C1328,-1675.86 1328,-1650.9 1328,-1630.86"/>
<polygon fill="black" stroke="black" stroke-width="2" points="1331.5,-1630.59 1328,-1620.59 1324.5,-1630.59 1331.5,-1630.59"/>
<text text-anchor="middle" x="1394.5" y="-1662.61" font-family="Times,serif" font-size="14.00">Pipeline</text>
<text text-anchor="middle" x="1394.5" y="-1647.61" font-family="Times,serif" font-size="14.00">Decode Stage 3→4</text>
</g>
<!-- decode_stage4 -->
<g id="node115" class="node">
<title>decode_stage4</title>
<polygon fill="purple" stroke="black" points="2368.5,-5146.67 2239.5,-5146.67 2239.5,-5099.67 2368.5,-5099.67 2368.5,-5146.67"/>
<text text-anchor="middle" x="2304" y="-5133.07" font-family="Times,serif" font-size="12.00">DECODE STAGE 4</text>
<text text-anchor="middle" x="2304" y="-5120.07" font-family="Times,serif" font-size="12.00">Layers 13&#45;16</text>
<text text-anchor="middle" x="2304" y="-5107.07" font-family="Times,serif" font-size="12.00">GPUs: 48&#45;63</text>
</g>
<!-- decode_attn_qkv4_1 -->
<g id="node117" class="node">
<title>decode_attn_qkv4_1</title>
<polygon fill="lightgreen" stroke="black" points="1292.5,-1512.76 1079.5,-1512.76 1079.5,-1449.76 1292.5,-1449.76 1292.5,-1512.76"/>
<text text-anchor="middle" x="1186" y="-1500.76" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1186" y="-1489.76" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1186" y="-1478.76" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1186" y="-1467.76" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1186" y="-1456.76" font-family="Times,serif" font-size="10.00">GPU: 48&#45;55</text>
</g>
<!-- decode_layernorm4&#45;&gt;decode_attn_qkv4_1 -->
<g id="edge133" class="edge">
<title>decode_layernorm4&#45;&gt;decode_attn_qkv4_1</title>
<path fill="none" stroke="black" d="M1295.78,-1568.11C1277.28,-1553.65 1253.73,-1535.23 1233.18,-1519.16"/>
<polygon fill="black" stroke="black" points="1235.21,-1516.3 1225.18,-1512.9 1230.9,-1521.82 1235.21,-1516.3"/>
</g>
<!-- decode_attn_qkv4_2 -->
<g id="node118" class="node">
<title>decode_attn_qkv4_2</title>
<polygon fill="lightgreen" stroke="black" points="1523.5,-1512.76 1310.5,-1512.76 1310.5,-1449.76 1523.5,-1449.76 1523.5,-1512.76"/>
<text text-anchor="middle" x="1417" y="-1500.76" font-family="Times,serif" font-size="10.00">Attention QKV Proj</text>
<text text-anchor="middle" x="1417" y="-1489.76" font-family="Times,serif" font-size="10.00">TP=2</text>
<text text-anchor="middle" x="1417" y="-1478.76" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1417" y="-1467.76" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1417" y="-1456.76" font-family="Times,serif" font-size="10.00">GPU: 56&#45;63</text>
</g>
<!-- decode_layernorm4&#45;&gt;decode_attn_qkv4_2 -->
<g id="edge134" class="edge">
<title>decode_layernorm4&#45;&gt;decode_attn_qkv4_2</title>
<path fill="none" stroke="black" d="M1348.2,-1568.11C1359.38,-1554.16 1373.51,-1536.53 1386.05,-1520.87"/>
<polygon fill="black" stroke="black" points="1388.92,-1522.89 1392.44,-1512.9 1383.46,-1518.51 1388.92,-1522.89"/>
</g>
<!-- decode_attn4_1 -->
<g id="node119" class="node">
<title>decode_attn4_1</title>
<polygon fill="lightgreen" stroke="black" points="1292.5,-1379.21 1079.5,-1379.21 1079.5,-1316.21 1292.5,-1316.21 1292.5,-1379.21"/>
<text text-anchor="middle" x="1186" y="-1367.21" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1186" y="-1356.21" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1186" y="-1345.21" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1186" y="-1334.21" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1186" y="-1323.21" font-family="Times,serif" font-size="10.00">GPU: 48&#45;55</text>
</g>
<!-- decode_attn_qkv4_1&#45;&gt;decode_attn4_1 -->
<g id="edge135" class="edge">
<title>decode_attn_qkv4_1&#45;&gt;decode_attn4_1</title>
<path fill="none" stroke="black" d="M1186,-1449.75C1186,-1431.86 1186,-1409.04 1186,-1389.61"/>
<polygon fill="black" stroke="black" points="1189.5,-1389.51 1186,-1379.51 1182.5,-1389.51 1189.5,-1389.51"/>
</g>
<!-- decode_attn4_2 -->
<g id="node120" class="node">
<title>decode_attn4_2</title>
<polygon fill="lightgreen" stroke="black" points="1523.5,-1379.21 1310.5,-1379.21 1310.5,-1316.21 1523.5,-1316.21 1523.5,-1379.21"/>
<text text-anchor="middle" x="1417" y="-1367.21" font-family="Times,serif" font-size="10.00">Attention Compute</text>
<text text-anchor="middle" x="1417" y="-1356.21" font-family="Times,serif" font-size="10.00">No SP</text>
<text text-anchor="middle" x="1417" y="-1345.21" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1417" y="-1334.21" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1417" y="-1323.21" font-family="Times,serif" font-size="10.00">GPU: 56&#45;63</text>
</g>
<!-- decode_attn_qkv4_2&#45;&gt;decode_attn4_2 -->
<g id="edge136" class="edge">
<title>decode_attn_qkv4_2&#45;&gt;decode_attn4_2</title>
<path fill="none" stroke="black" d="M1417,-1449.75C1417,-1431.86 1417,-1409.04 1417,-1389.61"/>
<polygon fill="black" stroke="black" points="1420.5,-1389.51 1417,-1379.51 1413.5,-1389.51 1420.5,-1389.51"/>
</g>
<!-- decode_attn_gather4 -->
<g id="node121" class="node">
<title>decode_attn_gather4</title>
<ellipse fill="lightblue" stroke="black" cx="1277" cy="-1177.71" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1277" y="-1197.21" font-family="Times,serif" font-size="10.00">All&#45;Gather</text>
<text text-anchor="middle" x="1277" y="-1186.21" font-family="Times,serif" font-size="10.00">TP Attention</text>
<text text-anchor="middle" x="1277" y="-1175.21" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=256]</text>
<text text-anchor="middle" x="1277" y="-1164.21" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1277" y="-1153.21" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- decode_attn4_1&#45;&gt;decode_attn_gather4 -->
<g id="edge137" class="edge">
<title>decode_attn4_1&#45;&gt;decode_attn_gather4</title>
<path fill="none" stroke="black" d="M1202.69,-1315.9C1215.56,-1292.14 1233.66,-1258.73 1248.77,-1230.83"/>
<polygon fill="black" stroke="black" points="1251.88,-1232.44 1253.56,-1221.98 1245.72,-1229.11 1251.88,-1232.44"/>
</g>
<!-- decode_attn4_2&#45;&gt;decode_attn_gather4 -->
<g id="edge138" class="edge">
<title>decode_attn4_2&#45;&gt;decode_attn_gather4</title>
<path fill="none" stroke="black" d="M1391.32,-1315.9C1371.05,-1291.57 1342.34,-1257.12 1318.77,-1228.84"/>
<polygon fill="black" stroke="black" points="1321.36,-1226.48 1312.27,-1221.04 1315.98,-1230.96 1321.36,-1226.48"/>
</g>
<!-- decode_mlp_gate4 -->
<g id="node122" class="node">
<title>decode_mlp_gate4</title>
<polygon fill="lightgreen" stroke="black" points="1396,-1088.71 1158,-1088.71 1158,-1036.71 1396,-1036.71 1396,-1088.71"/>
<text text-anchor="middle" x="1277" y="-1076.71" font-family="Times,serif" font-size="10.00">MLP Gate</text>
<text text-anchor="middle" x="1277" y="-1065.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1277" y="-1054.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, num_experts=16]</text>
<text text-anchor="middle" x="1277" y="-1043.71" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- decode_attn_gather4&#45;&gt;decode_mlp_gate4 -->
<g id="edge139" class="edge">
<title>decode_attn_gather4&#45;&gt;decode_mlp_gate4</title>
<path fill="none" stroke="black" d="M1277,-1133.02C1277,-1121.84 1277,-1109.96 1277,-1099.25"/>
<polygon fill="black" stroke="black" points="1280.5,-1098.99 1277,-1088.99 1273.5,-1098.99 1280.5,-1098.99"/>
</g>
<!-- decode_expert_route4 -->
<g id="node123" class="node">
<title>decode_expert_route4</title>
<polygon fill="orange" stroke="black" stroke-dasharray="5,2" points="1373.34,-999.71 1220.09,-999.71 1180.66,-917.71 1333.91,-917.71 1373.34,-999.71"/>
<text text-anchor="middle" x="1277" y="-967.21" font-family="Times,serif" font-size="10.00">Expert Routing</text>
<text text-anchor="middle" x="1277" y="-956.21" font-family="Times,serif" font-size="10.00">Top&#45;2 Selection</text>
<text text-anchor="middle" x="1277" y="-945.21" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- decode_mlp_gate4&#45;&gt;decode_expert_route4 -->
<g id="edge140" class="edge">
<title>decode_mlp_gate4&#45;&gt;decode_expert_route4</title>
<path fill="none" stroke="black" d="M1277,-1036.5C1277,-1028.35 1277,-1019.02 1277,-1009.73"/>
<polygon fill="black" stroke="black" points="1280.5,-1009.72 1277,-999.72 1273.5,-1009.72 1280.5,-1009.72"/>
</g>
<!-- decode_expert4_1 -->
<g id="node124" class="node">
<title>decode_expert4_1</title>
<polygon fill="lightgreen" stroke="black" points="1062.5,-880.71 849.5,-880.71 849.5,-817.71 1062.5,-817.71 1062.5,-880.71"/>
<text text-anchor="middle" x="956" y="-868.71" font-family="Times,serif" font-size="10.00">Expert 0&#45;3</text>
<text text-anchor="middle" x="956" y="-857.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="956" y="-846.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="956" y="-835.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="956" y="-824.71" font-family="Times,serif" font-size="10.00">GPU: 48&#45;51</text>
</g>
<!-- decode_expert_route4&#45;&gt;decode_expert4_1 -->
<g id="edge141" class="edge">
<title>decode_expert_route4&#45;&gt;decode_expert4_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1185.01,-926.91C1144.97,-913.5 1097.91,-897.74 1056.91,-884.01"/>
<polygon fill="black" stroke="black" points="1057.76,-880.6 1047.17,-880.74 1055.54,-887.24 1057.76,-880.6"/>
</g>
<!-- decode_expert4_2 -->
<g id="node125" class="node">
<title>decode_expert4_2</title>
<polygon fill="lightgreen" stroke="black" points="1293.5,-880.71 1080.5,-880.71 1080.5,-817.71 1293.5,-817.71 1293.5,-880.71"/>
<text text-anchor="middle" x="1187" y="-868.71" font-family="Times,serif" font-size="10.00">Expert 4&#45;7</text>
<text text-anchor="middle" x="1187" y="-857.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1187" y="-846.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1187" y="-835.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1187" y="-824.71" font-family="Times,serif" font-size="10.00">GPU: 52&#45;55</text>
</g>
<!-- decode_expert_route4&#45;&gt;decode_expert4_2 -->
<g id="edge142" class="edge">
<title>decode_expert_route4&#45;&gt;decode_expert4_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1243.49,-917.68C1235.52,-908.17 1227.04,-898.04 1219.14,-888.6"/>
<polygon fill="black" stroke="black" points="1221.77,-886.29 1212.66,-880.87 1216.4,-890.78 1221.77,-886.29"/>
</g>
<!-- decode_expert4_3 -->
<g id="node126" class="node">
<title>decode_expert4_3</title>
<polygon fill="lightgreen" stroke="black" points="1524.5,-880.71 1311.5,-880.71 1311.5,-817.71 1524.5,-817.71 1524.5,-880.71"/>
<text text-anchor="middle" x="1418" y="-868.71" font-family="Times,serif" font-size="10.00">Expert 8&#45;11</text>
<text text-anchor="middle" x="1418" y="-857.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1418" y="-846.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1418" y="-835.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1418" y="-824.71" font-family="Times,serif" font-size="10.00">GPU: 56&#45;59</text>
</g>
<!-- decode_expert_route4&#45;&gt;decode_expert4_3 -->
<g id="edge143" class="edge">
<title>decode_expert_route4&#45;&gt;decode_expert4_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1329.5,-917.68C1342.61,-907.69 1356.6,-897.03 1369.5,-887.19"/>
<polygon fill="black" stroke="black" points="1371.97,-889.71 1377.8,-880.87 1367.72,-884.14 1371.97,-889.71"/>
</g>
<!-- decode_expert4_4 -->
<g id="node127" class="node">
<title>decode_expert4_4</title>
<polygon fill="lightgreen" stroke="black" points="1755.5,-880.71 1542.5,-880.71 1542.5,-817.71 1755.5,-817.71 1755.5,-880.71"/>
<text text-anchor="middle" x="1649" y="-868.71" font-family="Times,serif" font-size="10.00">Expert 12&#45;15</text>
<text text-anchor="middle" x="1649" y="-857.71" font-family="Times,serif" font-size="10.00">EP=4</text>
<text text-anchor="middle" x="1649" y="-846.71" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1649" y="-835.71" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1649" y="-824.71" font-family="Times,serif" font-size="10.00">GPU: 60&#45;63</text>
</g>
<!-- decode_expert_route4&#45;&gt;decode_expert4_4 -->
<g id="edge144" class="edge">
<title>decode_expert_route4&#45;&gt;decode_expert4_4</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1343.94,-938.37C1396.55,-923.16 1471.1,-901.62 1533.33,-883.64"/>
<polygon fill="black" stroke="black" points="1534.58,-886.92 1543.21,-880.78 1532.63,-880.2 1534.58,-886.92"/>
</g>
<!-- decode_expert_all2all4 -->
<g id="node128" class="node">
<title>decode_expert_all2all4</title>
<ellipse fill="lightblue" stroke="black" cx="1302" cy="-736.17" rx="150.73" ry="44.6"/>
<text text-anchor="middle" x="1302" y="-755.67" font-family="Times,serif" font-size="10.00">All&#45;to&#45;All</text>
<text text-anchor="middle" x="1302" y="-744.67" font-family="Times,serif" font-size="10.00">Expert Aggregation</text>
<text text-anchor="middle" x="1302" y="-733.67" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1302" y="-722.67" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1302" y="-711.67" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- decode_expert4_1&#45;&gt;decode_expert_all2all4 -->
<g id="edge145" class="edge">
<title>decode_expert4_1&#45;&gt;decode_expert_all2all4</title>
<path fill="none" stroke="black" d="M1051.46,-817.57C1094.97,-803.61 1146.74,-787 1191.88,-772.51"/>
<polygon fill="black" stroke="black" points="1192.96,-775.84 1201.41,-769.45 1190.82,-769.17 1192.96,-775.84"/>
</g>
<!-- decode_expert4_2&#45;&gt;decode_expert_all2all4 -->
<g id="edge146" class="edge">
<title>decode_expert4_2&#45;&gt;decode_expert_all2all4</title>
<path fill="none" stroke="black" d="M1218.73,-817.57C1228.87,-807.78 1240.37,-796.68 1251.5,-785.93"/>
<polygon fill="black" stroke="black" points="1253.99,-788.39 1258.75,-778.93 1249.13,-783.35 1253.99,-788.39"/>
</g>
<!-- decode_expert4_3&#45;&gt;decode_expert_all2all4 -->
<g id="edge147" class="edge">
<title>decode_expert4_3&#45;&gt;decode_expert_all2all4</title>
<path fill="none" stroke="black" d="M1386,-817.57C1375.76,-807.78 1364.17,-796.68 1352.94,-785.93"/>
<polygon fill="black" stroke="black" points="1355.27,-783.31 1345.62,-778.93 1350.43,-788.37 1355.27,-783.31"/>
</g>
<!-- decode_expert4_4&#45;&gt;decode_expert_all2all4 -->
<g id="edge148" class="edge">
<title>decode_expert4_4&#45;&gt;decode_expert_all2all4</title>
<path fill="none" stroke="black" d="M1553.26,-817.57C1509.53,-803.58 1457.49,-786.93 1412.14,-772.41"/>
<polygon fill="black" stroke="black" points="1413.16,-769.07 1402.57,-769.35 1411.03,-775.73 1413.16,-769.07"/>
</g>
<!-- decode_final_output -->
<g id="node129" class="node">
<title>decode_final_output</title>
<ellipse fill="pink" stroke="black" stroke-width="3" cx="1302" cy="-617.85" rx="150.73" ry="36.54"/>
<text text-anchor="middle" x="1302" y="-631.85" font-family="Times,serif" font-size="10.00">DECODE FINAL OUTPUT</text>
<text text-anchor="middle" x="1302" y="-620.85" font-family="Times,serif" font-size="10.00">Input: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1302" y="-609.85" font-family="Times,serif" font-size="10.00">Output: [batch=4, seq=1, hidden=512]</text>
<text text-anchor="middle" x="1302" y="-598.85" font-family="Times,serif" font-size="10.00">GPU: 48&#45;63</text>
</g>
<!-- decode_expert_all2all4&#45;&gt;decode_final_output -->
<g id="edge149" class="edge">
<title>decode_expert_all2all4&#45;&gt;decode_final_output</title>
<path fill="none" stroke="black" d="M1302,-691.52C1302,-682.81 1302,-673.64 1302,-664.85"/>
<polygon fill="black" stroke="black" points="1305.5,-664.76 1302,-654.76 1298.5,-664.76 1305.5,-664.76"/>
</g>
</g>
</svg>
