<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: %3 Pages: 1 -->
<svg width="3187pt" height="44315pt"
 viewBox="0.00 0.00 3187.00 44315.24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 44311.24)">
<title>%3</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-44311.24 3183,-44311.24 3183,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_pipeline_stage_0</title>
<polygon fill="lightgray" stroke="black" points="8,-33320.67 8,-44299.24 3171,-44299.24 3171,-33320.67 8,-33320.67"/>
<text text-anchor="middle" x="1589.5" y="-44284.04" font-family="Times,serif" font-size="14.00">Pipeline Stage 0 (GPUs 0&#45;127)</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_pipeline_stage_1</title>
<polygon fill="lightgray" stroke="black" points="8,-22265.1 8,-33243.67 3171,-33243.67 3171,-22265.1 8,-22265.1"/>
<text text-anchor="middle" x="1589.5" y="-33228.47" font-family="Times,serif" font-size="14.00">Pipeline Stage 1 (GPUs 128&#45;255)</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_pipeline_stage_2</title>
<polygon fill="lightgray" stroke="black" points="8,-11209.52 8,-22188.1 3171,-22188.1 3171,-11209.52 8,-11209.52"/>
<text text-anchor="middle" x="1589.5" y="-22172.9" font-family="Times,serif" font-size="14.00">Pipeline Stage 2 (GPUs 256&#45;383)</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_pipeline_stage_3</title>
<polygon fill="lightgray" stroke="black" points="8,-153.95 8,-11132.52 3171,-11132.52 3171,-153.95 8,-153.95"/>
<text text-anchor="middle" x="1589.5" y="-11117.32" font-family="Times,serif" font-size="14.00">Pipeline Stage 3 (GPUs 384&#45;511)</text>
</g>
<!-- stage0_input -->
<g id="node1" class="node">
<title>stage0_input</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-44230.76" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-44242.06" font-family="Times,serif" font-size="14.00">Input</text>
<text text-anchor="middle" x="1756" y="-44227.06" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-44212.06" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_attention_start -->
<g id="node2" class="node">
<title>stage0_layer0_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-44106.28 1584,-44106.28 1584,-44038.28 1928,-44038.28 1928,-44106.28"/>
<text text-anchor="middle" x="1756" y="-44091.08" font-family="Times,serif" font-size="14.00">Attention Start (Layer 0)</text>
<text text-anchor="middle" x="1756" y="-44076.08" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-44061.08" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-44046.08" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_input&#45;&gt;stage0_layer0_attention_start -->
<g id="edge31" class="edge">
<title>stage0_input&#45;&gt;stage0_layer0_attention_start</title>
<path fill="none" stroke="black" d="M1756,-44193.2C1756,-44193.2 1756,-44116.33 1756,-44116.33"/>
<polygon fill="black" stroke="black" points="1759.5,-44116.33 1756,-44106.33 1752.5,-44116.33 1759.5,-44116.33"/>
</g>
<!-- stage0_layer0_qkv_proj -->
<g id="node3" class="node">
<title>stage0_layer0_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-43951.28 1569.5,-43951.28 1569.5,-43883.28 1942.5,-43883.28 1942.5,-43951.28"/>
<text text-anchor="middle" x="1756" y="-43936.08" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-43921.08" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-43906.08" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-43891.08" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer0_attention_start&#45;&gt;stage0_layer0_qkv_proj -->
<g id="edge19" class="edge">
<title>stage0_layer0_attention_start&#45;&gt;stage0_layer0_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-44038.27C1756,-44038.27 1756,-43961.49 1756,-43961.49"/>
<polygon fill="black" stroke="black" points="1759.5,-43961.49 1756,-43951.49 1752.5,-43961.49 1759.5,-43961.49"/>
</g>
<!-- stage0_layer0_attention_compute -->
<g id="node4" class="node">
<title>stage0_layer0_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-43796.28 1569.5,-43796.28 1569.5,-43728.28 1942.5,-43728.28 1942.5,-43796.28"/>
<text text-anchor="middle" x="1756" y="-43781.08" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-43766.08" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-43751.08" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-43736.08" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer0_qkv_proj&#45;&gt;stage0_layer0_attention_compute -->
<g id="edge20" class="edge">
<title>stage0_layer0_qkv_proj&#45;&gt;stage0_layer0_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-43883.27C1756,-43883.27 1756,-43806.49 1756,-43806.49"/>
<polygon fill="black" stroke="black" points="1759.5,-43806.49 1756,-43796.49 1752.5,-43806.49 1759.5,-43806.49"/>
</g>
<!-- stage0_layer0_attention_out -->
<g id="node5" class="node">
<title>stage0_layer0_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-43641.28 1575.5,-43641.28 1575.5,-43573.28 1936.5,-43573.28 1936.5,-43641.28"/>
<text text-anchor="middle" x="1756" y="-43626.08" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-43611.08" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-43596.08" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-43581.08" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer0_attention_compute&#45;&gt;stage0_layer0_attention_out -->
<g id="edge21" class="edge">
<title>stage0_layer0_attention_compute&#45;&gt;stage0_layer0_attention_out</title>
<path fill="none" stroke="black" d="M1756,-43728.27C1756,-43728.27 1756,-43651.49 1756,-43651.49"/>
<polygon fill="black" stroke="black" points="1759.5,-43651.49 1756,-43641.49 1752.5,-43651.49 1759.5,-43651.49"/>
</g>
<!-- stage0_layer0_attention_allreduce -->
<g id="node6" class="node">
<title>stage0_layer0_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-43438.2" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-43457" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-43442" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-43427" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-43412" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_attention_out&#45;&gt;stage0_layer0_attention_allreduce -->
<g id="edge22" class="edge">
<title>stage0_layer0_attention_out&#45;&gt;stage0_layer0_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-43573.07C1756,-43573.07 1756,-43496.46 1756,-43496.46"/>
<polygon fill="black" stroke="black" points="1759.5,-43496.46 1756,-43486.46 1752.5,-43496.46 1759.5,-43496.46"/>
</g>
<!-- stage0_layer0_attention_residual -->
<g id="node7" class="node">
<title>stage0_layer0_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-43303.12 1584,-43303.12 1584,-43235.12 1928,-43235.12 1928,-43303.12"/>
<text text-anchor="middle" x="1756" y="-43287.92" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-43272.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-43257.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-43242.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_attention_allreduce&#45;&gt;stage0_layer0_attention_residual -->
<g id="edge23" class="edge">
<title>stage0_layer0_attention_allreduce&#45;&gt;stage0_layer0_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-43389.75C1756,-43389.75 1756,-43313.35 1756,-43313.35"/>
<polygon fill="black" stroke="black" points="1759.5,-43313.35 1756,-43303.35 1752.5,-43313.35 1759.5,-43313.35"/>
</g>
<!-- stage0_layer0_layernorm2 -->
<g id="node8" class="node">
<title>stage0_layer0_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-43148.12 1584,-43148.12 1584,-43080.12 1928,-43080.12 1928,-43148.12"/>
<text text-anchor="middle" x="1756" y="-43132.92" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-43117.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-43102.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-43087.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_attention_residual&#45;&gt;stage0_layer0_layernorm2 -->
<g id="edge24" class="edge">
<title>stage0_layer0_attention_residual&#45;&gt;stage0_layer0_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-43235.1C1756,-43235.1 1756,-43158.32 1756,-43158.32"/>
<polygon fill="black" stroke="black" points="1759.5,-43158.32 1756,-43148.32 1752.5,-43158.32 1759.5,-43158.32"/>
</g>
<!-- stage0_layer0_moe_gate -->
<g id="node9" class="node">
<title>stage0_layer0_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-42993.12 1552.53,-42993.12 1411.6,-42857.12 1959.47,-42857.12 2100.4,-42993.12"/>
<text text-anchor="middle" x="1756" y="-42943.92" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-42928.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-42913.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-42898.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage0_layer0_layernorm2&#45;&gt;stage0_layer0_moe_gate -->
<g id="edge25" class="edge">
<title>stage0_layer0_layernorm2&#45;&gt;stage0_layer0_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-43079.89C1756,-43079.89 1756,-43003.15 1756,-43003.15"/>
<polygon fill="black" stroke="black" points="1759.5,-43003.15 1756,-42993.15 1752.5,-43003.15 1759.5,-43003.15"/>
</g>
<!-- stage0_layer0_expert_dispatch -->
<g id="node10" class="node">
<title>stage0_layer0_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-42722.03" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-42740.83" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-42725.83" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-42710.83" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-42695.83" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_moe_gate&#45;&gt;stage0_layer0_expert_dispatch -->
<g id="edge1" class="edge">
<title>stage0_layer0_moe_gate&#45;&gt;stage0_layer0_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-42856.93C1756,-42856.93 1756,-42780.16 1756,-42780.16"/>
<polygon fill="black" stroke="black" points="1759.5,-42780.16 1756,-42770.16 1752.5,-42780.16 1759.5,-42780.16"/>
</g>
<!-- stage0_layer0_experts_group0 -->
<g id="node11" class="node">
<title>stage0_layer0_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-42586.95 16.5,-42586.95 16.5,-42503.95 351.5,-42503.95 351.5,-42586.95"/>
<text text-anchor="middle" x="184" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;3</text>
<text text-anchor="middle" x="184" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group0 -->
<g id="edge3" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group0</title>
<path fill="none" stroke="black" d="M1550.49,-42746C1124.38,-42746 184,-42746 184,-42746 184,-42746 184,-42597 184,-42597"/>
<polygon fill="black" stroke="black" points="187.5,-42597 184,-42587 180.5,-42597 187.5,-42597"/>
</g>
<!-- stage0_layer0_experts_group1 -->
<g id="node12" class="node">
<title>stage0_layer0_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-42586.95 409.5,-42586.95 409.5,-42503.95 744.5,-42503.95 744.5,-42586.95"/>
<text text-anchor="middle" x="577" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 4&#45;7</text>
<text text-anchor="middle" x="577" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group1 -->
<g id="edge5" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group1</title>
<path fill="none" stroke="black" d="M1518.83,-42722C1174.54,-42722 577,-42722 577,-42722 577,-42722 577,-42597.29 577,-42597.29"/>
<polygon fill="black" stroke="black" points="580.5,-42597.29 577,-42587.29 573.5,-42597.29 580.5,-42597.29"/>
</g>
<!-- stage0_layer0_experts_group2 -->
<g id="node13" class="node">
<title>stage0_layer0_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-42586.95 802.5,-42586.95 802.5,-42503.95 1137.5,-42503.95 1137.5,-42586.95"/>
<text text-anchor="middle" x="970" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 8&#45;11</text>
<text text-anchor="middle" x="970" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group2 -->
<g id="edge7" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group2</title>
<path fill="none" stroke="black" d="M1553.59,-42697C1320.7,-42697 970,-42697 970,-42697 970,-42697 970,-42597.26 970,-42597.26"/>
<polygon fill="black" stroke="black" points="973.5,-42597.26 970,-42587.26 966.5,-42597.26 973.5,-42597.26"/>
</g>
<!-- stage0_layer0_experts_group3 -->
<g id="node14" class="node">
<title>stage0_layer0_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-42586.95 1195.5,-42586.95 1195.5,-42503.95 1530.5,-42503.95 1530.5,-42586.95"/>
<text text-anchor="middle" x="1363" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 12&#45;15</text>
<text text-anchor="middle" x="1363" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group3 -->
<g id="edge9" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-42711.52C1524.81,-42711.52 1524.81,-42597.21 1524.81,-42597.21"/>
<polygon fill="black" stroke="black" points="1528.31,-42597.21 1524.81,-42587.21 1521.31,-42597.21 1528.31,-42597.21"/>
</g>
<!-- stage0_layer0_experts_group4 -->
<g id="node15" class="node">
<title>stage0_layer0_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-42586.95 1588.5,-42586.95 1588.5,-42503.95 1923.5,-42503.95 1923.5,-42586.95"/>
<text text-anchor="middle" x="1756" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 16&#45;19</text>
<text text-anchor="middle" x="1756" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group4 -->
<g id="edge11" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-42673.78C1756,-42673.78 1756,-42597.05 1756,-42597.05"/>
<polygon fill="black" stroke="black" points="1759.5,-42597.05 1756,-42587.05 1752.5,-42597.05 1759.5,-42597.05"/>
</g>
<!-- stage0_layer0_experts_group5 -->
<g id="node16" class="node">
<title>stage0_layer0_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-42586.95 1981.5,-42586.95 1981.5,-42503.95 2316.5,-42503.95 2316.5,-42586.95"/>
<text text-anchor="middle" x="2149" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 20&#45;23</text>
<text text-anchor="middle" x="2149" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group5 -->
<g id="edge13" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-42711.52C1987.19,-42711.52 1987.19,-42597.21 1987.19,-42597.21"/>
<polygon fill="black" stroke="black" points="1990.69,-42597.21 1987.19,-42587.21 1983.69,-42597.21 1990.69,-42597.21"/>
</g>
<!-- stage0_layer0_experts_group6 -->
<g id="node17" class="node">
<title>stage0_layer0_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-42586.95 2374.5,-42586.95 2374.5,-42503.95 2709.5,-42503.95 2709.5,-42586.95"/>
<text text-anchor="middle" x="2542" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 24&#45;27</text>
<text text-anchor="middle" x="2542" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group6 -->
<g id="edge15" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group6</title>
<path fill="none" stroke="black" d="M1979.4,-42706C2211.76,-42706 2542,-42706 2542,-42706 2542,-42706 2542,-42597.21 2542,-42597.21"/>
<polygon fill="black" stroke="black" points="2545.5,-42597.21 2542,-42587.21 2538.5,-42597.21 2545.5,-42597.21"/>
</g>
<!-- stage0_layer0_experts_group7 -->
<g id="node18" class="node">
<title>stage0_layer0_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-42586.95 2767.5,-42586.95 2767.5,-42503.95 3102.5,-42503.95 3102.5,-42586.95"/>
<text text-anchor="middle" x="2935" y="-42571.75" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-42556.75" font-family="Times,serif" font-size="14.00">GPU 28&#45;31</text>
<text text-anchor="middle" x="2935" y="-42541.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-42526.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-42511.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group7 -->
<g id="edge17" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_experts_group7</title>
<path fill="none" stroke="black" d="M1979.49,-42738C2321.37,-42738 2935,-42738 2935,-42738 2935,-42738 2935,-42597.23 2935,-42597.23"/>
<polygon fill="black" stroke="black" points="2938.5,-42597.23 2935,-42587.23 2931.5,-42597.23 2938.5,-42597.23"/>
</g>
<!-- stage0_layer0_expert_combine -->
<g id="node19" class="node">
<title>stage0_layer0_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-42368.87" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-42387.67" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-42372.67" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-42357.67" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-42342.67" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge2" class="edge">
<title>stage0_layer0_expert_dispatch&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-42694.91C1559.5,-42694.91 1559.5,-42407.56 1559.5,-42407.56"/>
<polygon fill="black" stroke="black" points="1563,-42407.56 1559.5,-42397.56 1556,-42407.56 1563,-42407.56"/>
</g>
<!-- stage0_layer0_experts_group0&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge4" class="edge">
<title>stage0_layer0_experts_group0&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-42503.71C239.83,-42444.7 239.83,-42344 239.83,-42344 239.83,-42344 1537.57,-42344 1537.57,-42344"/>
<polygon fill="black" stroke="black" points="1537.57,-42347.5 1547.57,-42344 1537.57,-42340.5 1537.57,-42347.5"/>
</g>
<!-- stage0_layer0_experts_group1&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge6" class="edge">
<title>stage0_layer0_experts_group1&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-42503.85C632.83,-42451.4 632.83,-42368 632.83,-42368 632.83,-42368 1502.64,-42368 1502.64,-42368"/>
<polygon fill="black" stroke="black" points="1502.64,-42371.5 1512.64,-42368 1502.64,-42364.5 1502.64,-42371.5"/>
</g>
<!-- stage0_layer0_experts_group2&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge8" class="edge">
<title>stage0_layer0_experts_group2&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-42503.92C1025.83,-42458.48 1025.83,-42392 1025.83,-42392 1025.83,-42392 1532.35,-42392 1532.35,-42392"/>
<polygon fill="black" stroke="black" points="1532.35,-42395.5 1542.35,-42392 1532.35,-42388.5 1532.35,-42395.5"/>
</g>
<!-- stage0_layer0_experts_group3&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge10" class="edge">
<title>stage0_layer0_experts_group3&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-42503.6C1521.63,-42503.6 1521.63,-42391.79 1521.63,-42391.79"/>
<polygon fill="black" stroke="black" points="1525.13,-42391.79 1521.63,-42381.79 1518.13,-42391.79 1525.13,-42391.79"/>
</g>
<!-- stage0_layer0_experts_group4&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge12" class="edge">
<title>stage0_layer0_experts_group4&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-42503.6C1756,-42503.6 1756,-42426.97 1756,-42426.97"/>
<polygon fill="black" stroke="black" points="1759.5,-42426.97 1756,-42416.97 1752.5,-42426.97 1759.5,-42426.97"/>
</g>
<!-- stage0_layer0_experts_group5&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge14" class="edge">
<title>stage0_layer0_experts_group5&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-42503.6C1990.37,-42503.6 1990.37,-42391.79 1990.37,-42391.79"/>
<polygon fill="black" stroke="black" points="1993.87,-42391.79 1990.37,-42381.79 1986.87,-42391.79 1993.87,-42391.79"/>
</g>
<!-- stage0_layer0_experts_group6&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge16" class="edge">
<title>stage0_layer0_experts_group6&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-42503.87C2597.83,-42456.04 2597.83,-42384 2597.83,-42384 2597.83,-42384 1997.15,-42384 1997.15,-42384"/>
<polygon fill="black" stroke="black" points="1997.15,-42380.5 1987.15,-42384 1997.15,-42387.5 1997.15,-42380.5"/>
</g>
<!-- stage0_layer0_experts_group7&#45;&gt;stage0_layer0_expert_combine -->
<g id="edge18" class="edge">
<title>stage0_layer0_experts_group7&#45;&gt;stage0_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-42503.95C2990.83,-42447.11 2990.83,-42352 2990.83,-42352 2990.83,-42352 1993.93,-42352 1993.93,-42352"/>
<polygon fill="black" stroke="black" points="1993.93,-42348.5 1983.93,-42352 1993.93,-42355.5 1993.93,-42348.5"/>
</g>
<!-- stage0_layer0_mlp_fc1 -->
<g id="node20" class="node">
<title>stage0_layer0_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-42233.78 1590,-42233.78 1590,-42165.78 1922,-42165.78 1922,-42233.78"/>
<text text-anchor="middle" x="1756" y="-42218.58" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-42203.58" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-42188.58" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-42173.58" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer0_expert_combine&#45;&gt;stage0_layer0_mlp_fc1 -->
<g id="edge26" class="edge">
<title>stage0_layer0_expert_combine&#45;&gt;stage0_layer0_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-42320.42C1756,-42320.42 1756,-42244.02 1756,-42244.02"/>
<polygon fill="black" stroke="black" points="1759.5,-42244.02 1756,-42234.02 1752.5,-42244.02 1759.5,-42244.02"/>
</g>
<!-- stage0_layer0_mlp_gelu -->
<g id="node21" class="node">
<title>stage0_layer0_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-42078.78 1603.5,-42078.78 1603.5,-42010.78 1908.5,-42010.78 1908.5,-42078.78"/>
<text text-anchor="middle" x="1756" y="-42063.58" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-42048.58" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-42033.58" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-42018.58" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer0_mlp_fc1&#45;&gt;stage0_layer0_mlp_gelu -->
<g id="edge27" class="edge">
<title>stage0_layer0_mlp_fc1&#45;&gt;stage0_layer0_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-42165.77C1756,-42165.77 1756,-42088.99 1756,-42088.99"/>
<polygon fill="black" stroke="black" points="1759.5,-42088.99 1756,-42078.99 1752.5,-42088.99 1759.5,-42088.99"/>
</g>
<!-- stage0_layer0_mlp_fc2 -->
<g id="node22" class="node">
<title>stage0_layer0_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-41923.78 1588.5,-41923.78 1588.5,-41855.78 1923.5,-41855.78 1923.5,-41923.78"/>
<text text-anchor="middle" x="1756" y="-41908.58" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-41893.58" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-41878.58" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-41863.58" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer0_mlp_gelu&#45;&gt;stage0_layer0_mlp_fc2 -->
<g id="edge28" class="edge">
<title>stage0_layer0_mlp_gelu&#45;&gt;stage0_layer0_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-42010.77C1756,-42010.77 1756,-41933.99 1756,-41933.99"/>
<polygon fill="black" stroke="black" points="1759.5,-41933.99 1756,-41923.99 1752.5,-41933.99 1759.5,-41933.99"/>
</g>
<!-- stage0_layer0_mlp_allreduce -->
<g id="node23" class="node">
<title>stage0_layer0_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-41720.7" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-41739.5" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-41724.5" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-41709.5" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-41694.5" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_mlp_fc2&#45;&gt;stage0_layer0_mlp_allreduce -->
<g id="edge29" class="edge">
<title>stage0_layer0_mlp_fc2&#45;&gt;stage0_layer0_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-41855.57C1756,-41855.57 1756,-41778.96 1756,-41778.96"/>
<polygon fill="black" stroke="black" points="1759.5,-41778.96 1756,-41768.96 1752.5,-41778.96 1759.5,-41778.96"/>
</g>
<!-- stage0_layer0_mlp_end -->
<g id="node24" class="node">
<title>stage0_layer0_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-41585.62 1584,-41585.62 1584,-41517.62 1928,-41517.62 1928,-41585.62"/>
<text text-anchor="middle" x="1756" y="-41570.42" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-41555.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-41540.42" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-41525.42" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_mlp_allreduce&#45;&gt;stage0_layer0_mlp_end -->
<g id="edge30" class="edge">
<title>stage0_layer0_mlp_allreduce&#45;&gt;stage0_layer0_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-41672.25C1756,-41672.25 1756,-41595.85 1756,-41595.85"/>
<polygon fill="black" stroke="black" points="1759.5,-41595.85 1756,-41585.85 1752.5,-41595.85 1759.5,-41595.85"/>
</g>
<!-- stage0_layer1_attention_start -->
<g id="node25" class="node">
<title>stage0_layer1_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-41430.62 1584,-41430.62 1584,-41362.62 1928,-41362.62 1928,-41430.62"/>
<text text-anchor="middle" x="1756" y="-41415.42" font-family="Times,serif" font-size="14.00">Attention Start (Layer 1)</text>
<text text-anchor="middle" x="1756" y="-41400.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-41385.42" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-41370.42" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer0_mlp_end&#45;&gt;stage0_layer1_attention_start -->
<g id="edge62" class="edge">
<title>stage0_layer0_mlp_end&#45;&gt;stage0_layer1_attention_start</title>
<path fill="none" stroke="black" d="M1756,-41517.6C1756,-41517.6 1756,-41440.82 1756,-41440.82"/>
<polygon fill="black" stroke="black" points="1759.5,-41440.82 1756,-41430.82 1752.5,-41440.82 1759.5,-41440.82"/>
</g>
<!-- stage0_layer1_qkv_proj -->
<g id="node26" class="node">
<title>stage0_layer1_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-41275.62 1569.5,-41275.62 1569.5,-41207.62 1942.5,-41207.62 1942.5,-41275.62"/>
<text text-anchor="middle" x="1756" y="-41260.42" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-41245.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-41230.42" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-41215.42" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer1_attention_start&#45;&gt;stage0_layer1_qkv_proj -->
<g id="edge50" class="edge">
<title>stage0_layer1_attention_start&#45;&gt;stage0_layer1_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-41362.6C1756,-41362.6 1756,-41285.82 1756,-41285.82"/>
<polygon fill="black" stroke="black" points="1759.5,-41285.82 1756,-41275.82 1752.5,-41285.82 1759.5,-41285.82"/>
</g>
<!-- stage0_layer1_attention_compute -->
<g id="node27" class="node">
<title>stage0_layer1_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-41120.62 1569.5,-41120.62 1569.5,-41052.62 1942.5,-41052.62 1942.5,-41120.62"/>
<text text-anchor="middle" x="1756" y="-41105.42" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-41090.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-41075.42" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-41060.42" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer1_qkv_proj&#45;&gt;stage0_layer1_attention_compute -->
<g id="edge51" class="edge">
<title>stage0_layer1_qkv_proj&#45;&gt;stage0_layer1_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-41207.6C1756,-41207.6 1756,-41130.82 1756,-41130.82"/>
<polygon fill="black" stroke="black" points="1759.5,-41130.82 1756,-41120.82 1752.5,-41130.82 1759.5,-41130.82"/>
</g>
<!-- stage0_layer1_attention_out -->
<g id="node28" class="node">
<title>stage0_layer1_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-40965.62 1575.5,-40965.62 1575.5,-40897.62 1936.5,-40897.62 1936.5,-40965.62"/>
<text text-anchor="middle" x="1756" y="-40950.42" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-40935.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-40920.42" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-40905.42" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer1_attention_compute&#45;&gt;stage0_layer1_attention_out -->
<g id="edge52" class="edge">
<title>stage0_layer1_attention_compute&#45;&gt;stage0_layer1_attention_out</title>
<path fill="none" stroke="black" d="M1756,-41052.6C1756,-41052.6 1756,-40975.82 1756,-40975.82"/>
<polygon fill="black" stroke="black" points="1759.5,-40975.82 1756,-40965.82 1752.5,-40975.82 1759.5,-40975.82"/>
</g>
<!-- stage0_layer1_attention_allreduce -->
<g id="node29" class="node">
<title>stage0_layer1_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-40762.53" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-40781.33" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-40766.33" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-40751.33" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-40736.33" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_attention_out&#45;&gt;stage0_layer1_attention_allreduce -->
<g id="edge53" class="edge">
<title>stage0_layer1_attention_out&#45;&gt;stage0_layer1_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-40897.4C1756,-40897.4 1756,-40820.8 1756,-40820.8"/>
<polygon fill="black" stroke="black" points="1759.5,-40820.8 1756,-40810.8 1752.5,-40820.8 1759.5,-40820.8"/>
</g>
<!-- stage0_layer1_attention_residual -->
<g id="node30" class="node">
<title>stage0_layer1_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-40627.45 1584,-40627.45 1584,-40559.45 1928,-40559.45 1928,-40627.45"/>
<text text-anchor="middle" x="1756" y="-40612.25" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-40597.25" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-40582.25" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-40567.25" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_attention_allreduce&#45;&gt;stage0_layer1_attention_residual -->
<g id="edge54" class="edge">
<title>stage0_layer1_attention_allreduce&#45;&gt;stage0_layer1_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-40714.08C1756,-40714.08 1756,-40637.69 1756,-40637.69"/>
<polygon fill="black" stroke="black" points="1759.5,-40637.69 1756,-40627.69 1752.5,-40637.69 1759.5,-40637.69"/>
</g>
<!-- stage0_layer1_layernorm2 -->
<g id="node31" class="node">
<title>stage0_layer1_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-40472.45 1584,-40472.45 1584,-40404.45 1928,-40404.45 1928,-40472.45"/>
<text text-anchor="middle" x="1756" y="-40457.25" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-40442.25" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-40427.25" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-40412.25" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_attention_residual&#45;&gt;stage0_layer1_layernorm2 -->
<g id="edge55" class="edge">
<title>stage0_layer1_attention_residual&#45;&gt;stage0_layer1_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-40559.44C1756,-40559.44 1756,-40482.65 1756,-40482.65"/>
<polygon fill="black" stroke="black" points="1759.5,-40482.65 1756,-40472.65 1752.5,-40482.65 1759.5,-40482.65"/>
</g>
<!-- stage0_layer1_moe_gate -->
<g id="node32" class="node">
<title>stage0_layer1_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-40317.45 1552.53,-40317.45 1411.6,-40181.45 1959.47,-40181.45 2100.4,-40317.45"/>
<text text-anchor="middle" x="1756" y="-40268.25" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-40253.25" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-40238.25" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-40223.25" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage0_layer1_layernorm2&#45;&gt;stage0_layer1_moe_gate -->
<g id="edge56" class="edge">
<title>stage0_layer1_layernorm2&#45;&gt;stage0_layer1_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-40404.22C1756,-40404.22 1756,-40327.49 1756,-40327.49"/>
<polygon fill="black" stroke="black" points="1759.5,-40327.49 1756,-40317.49 1752.5,-40327.49 1759.5,-40327.49"/>
</g>
<!-- stage0_layer1_expert_dispatch -->
<g id="node33" class="node">
<title>stage0_layer1_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-40046.37" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-40065.17" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-40050.17" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-40035.17" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-40020.17" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_moe_gate&#45;&gt;stage0_layer1_expert_dispatch -->
<g id="edge32" class="edge">
<title>stage0_layer1_moe_gate&#45;&gt;stage0_layer1_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-40181.26C1756,-40181.26 1756,-40104.5 1756,-40104.5"/>
<polygon fill="black" stroke="black" points="1759.5,-40104.5 1756,-40094.5 1752.5,-40104.5 1759.5,-40104.5"/>
</g>
<!-- stage0_layer1_experts_group0 -->
<g id="node34" class="node">
<title>stage0_layer1_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-39911.28 16.5,-39911.28 16.5,-39828.28 351.5,-39828.28 351.5,-39911.28"/>
<text text-anchor="middle" x="184" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 0&#45;3</text>
<text text-anchor="middle" x="184" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group0 -->
<g id="edge34" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group0</title>
<path fill="none" stroke="black" d="M1549.42,-40070C1111.19,-40070 128.17,-40070 128.17,-40070 128.17,-40070 128.17,-39921.76 128.17,-39921.76"/>
<polygon fill="black" stroke="black" points="131.67,-39921.76 128.17,-39911.76 124.67,-39921.76 131.67,-39921.76"/>
</g>
<!-- stage0_layer1_experts_group1 -->
<g id="node35" class="node">
<title>stage0_layer1_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-39911.28 409.5,-39911.28 409.5,-39828.28 744.5,-39828.28 744.5,-39911.28"/>
<text text-anchor="middle" x="577" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 4&#45;7</text>
<text text-anchor="middle" x="577" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group1 -->
<g id="edge36" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-40046C1160.38,-40046 521.17,-40046 521.17,-40046 521.17,-40046 521.17,-39921.55 521.17,-39921.55"/>
<polygon fill="black" stroke="black" points="524.67,-39921.55 521.17,-39911.55 517.67,-39921.55 524.67,-39921.55"/>
</g>
<!-- stage0_layer1_experts_group2 -->
<g id="node36" class="node">
<title>stage0_layer1_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-39911.28 802.5,-39911.28 802.5,-39828.28 1137.5,-39828.28 1137.5,-39911.28"/>
<text text-anchor="middle" x="970" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 8&#45;11</text>
<text text-anchor="middle" x="970" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group2 -->
<g id="edge38" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group2</title>
<path fill="none" stroke="black" d="M1551.68,-40022C1302.51,-40022 914.17,-40022 914.17,-40022 914.17,-40022 914.17,-39921.38 914.17,-39921.38"/>
<polygon fill="black" stroke="black" points="917.67,-39921.38 914.17,-39911.38 910.67,-39921.38 917.67,-39921.38"/>
</g>
<!-- stage0_layer1_experts_group3 -->
<g id="node37" class="node">
<title>stage0_layer1_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-39911.28 1195.5,-39911.28 1195.5,-39828.28 1530.5,-39828.28 1530.5,-39911.28"/>
<text text-anchor="middle" x="1363" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 12&#45;15</text>
<text text-anchor="middle" x="1363" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group3 -->
<g id="edge40" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-40035.85C1524.81,-40035.85 1524.81,-39921.54 1524.81,-39921.54"/>
<polygon fill="black" stroke="black" points="1528.31,-39921.54 1524.81,-39911.54 1521.31,-39921.54 1528.31,-39921.54"/>
</g>
<!-- stage0_layer1_experts_group4 -->
<g id="node38" class="node">
<title>stage0_layer1_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-39911.28 1588.5,-39911.28 1588.5,-39828.28 1923.5,-39828.28 1923.5,-39911.28"/>
<text text-anchor="middle" x="1756" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 16&#45;19</text>
<text text-anchor="middle" x="1756" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group4 -->
<g id="edge42" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-39998.12C1756,-39998.12 1756,-39921.38 1756,-39921.38"/>
<polygon fill="black" stroke="black" points="1759.5,-39921.38 1756,-39911.38 1752.5,-39921.38 1759.5,-39921.38"/>
</g>
<!-- stage0_layer1_experts_group5 -->
<g id="node39" class="node">
<title>stage0_layer1_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-39911.28 1981.5,-39911.28 1981.5,-39828.28 2316.5,-39828.28 2316.5,-39911.28"/>
<text text-anchor="middle" x="2149" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 20&#45;23</text>
<text text-anchor="middle" x="2149" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group5 -->
<g id="edge44" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-40035.85C1987.19,-40035.85 1987.19,-39921.54 1987.19,-39921.54"/>
<polygon fill="black" stroke="black" points="1990.69,-39921.54 1987.19,-39911.54 1983.69,-39921.54 1990.69,-39921.54"/>
</g>
<!-- stage0_layer1_experts_group6 -->
<g id="node40" class="node">
<title>stage0_layer1_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-39911.28 2374.5,-39911.28 2374.5,-39828.28 2709.5,-39828.28 2709.5,-39911.28"/>
<text text-anchor="middle" x="2542" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 24&#45;27</text>
<text text-anchor="middle" x="2542" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group6 -->
<g id="edge46" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group6</title>
<path fill="none" stroke="black" d="M1979.04,-40030C2193.77,-40030 2486.17,-40030 2486.17,-40030 2486.17,-40030 2486.17,-39921.46 2486.17,-39921.46"/>
<polygon fill="black" stroke="black" points="2489.67,-39921.46 2486.17,-39911.46 2482.67,-39921.46 2489.67,-39921.46"/>
</g>
<!-- stage0_layer1_experts_group7 -->
<g id="node41" class="node">
<title>stage0_layer1_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-39911.28 2767.5,-39911.28 2767.5,-39828.28 3102.5,-39828.28 3102.5,-39911.28"/>
<text text-anchor="middle" x="2935" y="-39896.08" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-39881.08" font-family="Times,serif" font-size="14.00">GPU 28&#45;31</text>
<text text-anchor="middle" x="2935" y="-39866.08" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-39851.08" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-39836.08" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group7 -->
<g id="edge48" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_experts_group7</title>
<path fill="none" stroke="black" d="M1980.25,-40062C2307.97,-40062 2879.17,-40062 2879.17,-40062 2879.17,-40062 2879.17,-39921.49 2879.17,-39921.49"/>
<polygon fill="black" stroke="black" points="2882.67,-39921.49 2879.17,-39911.49 2875.67,-39921.49 2882.67,-39921.49"/>
</g>
<!-- stage0_layer1_expert_combine -->
<g id="node42" class="node">
<title>stage0_layer1_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-39693.2" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-39712" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-39697" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-39682" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-39667" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge33" class="edge">
<title>stage0_layer1_expert_dispatch&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-40019.24C1559.5,-40019.24 1559.5,-39731.89 1559.5,-39731.89"/>
<polygon fill="black" stroke="black" points="1563,-39731.89 1559.5,-39721.89 1556,-39731.89 1563,-39731.89"/>
</g>
<!-- stage0_layer1_experts_group0&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge35" class="edge">
<title>stage0_layer1_experts_group0&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-39828.18C239.83,-39769.37 239.83,-39669 239.83,-39669 239.83,-39669 1535.58,-39669 1535.58,-39669"/>
<polygon fill="black" stroke="black" points="1535.58,-39672.5 1545.58,-39669 1535.58,-39665.5 1535.58,-39672.5"/>
</g>
<!-- stage0_layer1_experts_group1&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge37" class="edge">
<title>stage0_layer1_experts_group1&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-39827.89C632.83,-39775.61 632.83,-39693 632.83,-39693 632.83,-39693 1502.64,-39693 1502.64,-39693"/>
<polygon fill="black" stroke="black" points="1502.64,-39696.5 1512.64,-39693 1502.64,-39689.5 1502.64,-39696.5"/>
</g>
<!-- stage0_layer1_experts_group2&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge39" class="edge">
<title>stage0_layer1_experts_group2&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-39828.04C1025.83,-39782.8 1025.83,-39717 1025.83,-39717 1025.83,-39717 1534.32,-39717 1534.32,-39717"/>
<polygon fill="black" stroke="black" points="1534.32,-39720.5 1544.32,-39717 1534.32,-39713.5 1534.32,-39720.5"/>
</g>
<!-- stage0_layer1_experts_group3&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge41" class="edge">
<title>stage0_layer1_experts_group3&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-39827.94C1521.63,-39827.94 1521.63,-39716.12 1521.63,-39716.12"/>
<polygon fill="black" stroke="black" points="1525.13,-39716.12 1521.63,-39706.12 1518.13,-39716.12 1525.13,-39716.12"/>
</g>
<!-- stage0_layer1_experts_group4&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge43" class="edge">
<title>stage0_layer1_experts_group4&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-39827.94C1756,-39827.94 1756,-39751.31 1756,-39751.31"/>
<polygon fill="black" stroke="black" points="1759.5,-39751.31 1756,-39741.31 1752.5,-39751.31 1759.5,-39751.31"/>
</g>
<!-- stage0_layer1_experts_group5&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge45" class="edge">
<title>stage0_layer1_experts_group5&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-39827.94C1990.37,-39827.94 1990.37,-39716.12 1990.37,-39716.12"/>
<polygon fill="black" stroke="black" points="1993.87,-39716.12 1990.37,-39706.12 1986.87,-39716.12 1993.87,-39716.12"/>
</g>
<!-- stage0_layer1_experts_group6&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge47" class="edge">
<title>stage0_layer1_experts_group6&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-39827.96C2597.83,-39780.32 2597.83,-39709 2597.83,-39709 2597.83,-39709 1995.76,-39709 1995.76,-39709"/>
<polygon fill="black" stroke="black" points="1995.76,-39705.5 1985.76,-39709 1995.76,-39712.5 1995.76,-39705.5"/>
</g>
<!-- stage0_layer1_experts_group7&#45;&gt;stage0_layer1_expert_combine -->
<g id="edge49" class="edge">
<title>stage0_layer1_experts_group7&#45;&gt;stage0_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-39827.95C2990.83,-39771.25 2990.83,-39677 2990.83,-39677 2990.83,-39677 1995.37,-39677 1995.37,-39677"/>
<polygon fill="black" stroke="black" points="1995.37,-39673.5 1985.37,-39677 1995.37,-39680.5 1995.37,-39673.5"/>
</g>
<!-- stage0_layer1_mlp_fc1 -->
<g id="node43" class="node">
<title>stage0_layer1_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-39558.12 1590,-39558.12 1590,-39490.12 1922,-39490.12 1922,-39558.12"/>
<text text-anchor="middle" x="1756" y="-39542.92" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-39527.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-39512.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-39497.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer1_expert_combine&#45;&gt;stage0_layer1_mlp_fc1 -->
<g id="edge57" class="edge">
<title>stage0_layer1_expert_combine&#45;&gt;stage0_layer1_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-39644.75C1756,-39644.75 1756,-39568.35 1756,-39568.35"/>
<polygon fill="black" stroke="black" points="1759.5,-39568.35 1756,-39558.35 1752.5,-39568.35 1759.5,-39568.35"/>
</g>
<!-- stage0_layer1_mlp_gelu -->
<g id="node44" class="node">
<title>stage0_layer1_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-39403.12 1603.5,-39403.12 1603.5,-39335.12 1908.5,-39335.12 1908.5,-39403.12"/>
<text text-anchor="middle" x="1756" y="-39387.92" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-39372.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-39357.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-39342.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer1_mlp_fc1&#45;&gt;stage0_layer1_mlp_gelu -->
<g id="edge58" class="edge">
<title>stage0_layer1_mlp_fc1&#45;&gt;stage0_layer1_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-39490.1C1756,-39490.1 1756,-39413.32 1756,-39413.32"/>
<polygon fill="black" stroke="black" points="1759.5,-39413.32 1756,-39403.32 1752.5,-39413.32 1759.5,-39413.32"/>
</g>
<!-- stage0_layer1_mlp_fc2 -->
<g id="node45" class="node">
<title>stage0_layer1_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-39248.12 1588.5,-39248.12 1588.5,-39180.12 1923.5,-39180.12 1923.5,-39248.12"/>
<text text-anchor="middle" x="1756" y="-39232.92" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-39217.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-39202.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-39187.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer1_mlp_gelu&#45;&gt;stage0_layer1_mlp_fc2 -->
<g id="edge59" class="edge">
<title>stage0_layer1_mlp_gelu&#45;&gt;stage0_layer1_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-39335.1C1756,-39335.1 1756,-39258.32 1756,-39258.32"/>
<polygon fill="black" stroke="black" points="1759.5,-39258.32 1756,-39248.32 1752.5,-39258.32 1759.5,-39258.32"/>
</g>
<!-- stage0_layer1_mlp_allreduce -->
<g id="node46" class="node">
<title>stage0_layer1_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-39045.04" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-39063.84" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-39048.84" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-39033.84" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-39018.84" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_mlp_fc2&#45;&gt;stage0_layer1_mlp_allreduce -->
<g id="edge60" class="edge">
<title>stage0_layer1_mlp_fc2&#45;&gt;stage0_layer1_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-39179.9C1756,-39179.9 1756,-39103.3 1756,-39103.3"/>
<polygon fill="black" stroke="black" points="1759.5,-39103.3 1756,-39093.3 1752.5,-39103.3 1759.5,-39103.3"/>
</g>
<!-- stage0_layer1_mlp_end -->
<g id="node47" class="node">
<title>stage0_layer1_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-38909.95 1584,-38909.95 1584,-38841.95 1928,-38841.95 1928,-38909.95"/>
<text text-anchor="middle" x="1756" y="-38894.75" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-38879.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-38864.75" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-38849.75" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_mlp_allreduce&#45;&gt;stage0_layer1_mlp_end -->
<g id="edge61" class="edge">
<title>stage0_layer1_mlp_allreduce&#45;&gt;stage0_layer1_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-38996.58C1756,-38996.58 1756,-38920.19 1756,-38920.19"/>
<polygon fill="black" stroke="black" points="1759.5,-38920.19 1756,-38910.19 1752.5,-38920.19 1759.5,-38920.19"/>
</g>
<!-- stage0_layer2_attention_start -->
<g id="node48" class="node">
<title>stage0_layer2_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-38754.95 1584,-38754.95 1584,-38686.95 1928,-38686.95 1928,-38754.95"/>
<text text-anchor="middle" x="1756" y="-38739.75" font-family="Times,serif" font-size="14.00">Attention Start (Layer 2)</text>
<text text-anchor="middle" x="1756" y="-38724.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-38709.75" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-38694.75" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer1_mlp_end&#45;&gt;stage0_layer2_attention_start -->
<g id="edge93" class="edge">
<title>stage0_layer1_mlp_end&#45;&gt;stage0_layer2_attention_start</title>
<path fill="none" stroke="black" d="M1756,-38841.94C1756,-38841.94 1756,-38765.16 1756,-38765.16"/>
<polygon fill="black" stroke="black" points="1759.5,-38765.16 1756,-38755.16 1752.5,-38765.16 1759.5,-38765.16"/>
</g>
<!-- stage0_layer2_qkv_proj -->
<g id="node49" class="node">
<title>stage0_layer2_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-38599.95 1569.5,-38599.95 1569.5,-38531.95 1942.5,-38531.95 1942.5,-38599.95"/>
<text text-anchor="middle" x="1756" y="-38584.75" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-38569.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-38554.75" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-38539.75" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer2_attention_start&#45;&gt;stage0_layer2_qkv_proj -->
<g id="edge81" class="edge">
<title>stage0_layer2_attention_start&#45;&gt;stage0_layer2_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-38686.94C1756,-38686.94 1756,-38610.16 1756,-38610.16"/>
<polygon fill="black" stroke="black" points="1759.5,-38610.16 1756,-38600.16 1752.5,-38610.16 1759.5,-38610.16"/>
</g>
<!-- stage0_layer2_attention_compute -->
<g id="node50" class="node">
<title>stage0_layer2_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-38444.95 1569.5,-38444.95 1569.5,-38376.95 1942.5,-38376.95 1942.5,-38444.95"/>
<text text-anchor="middle" x="1756" y="-38429.75" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-38414.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-38399.75" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-38384.75" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer2_qkv_proj&#45;&gt;stage0_layer2_attention_compute -->
<g id="edge82" class="edge">
<title>stage0_layer2_qkv_proj&#45;&gt;stage0_layer2_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-38531.94C1756,-38531.94 1756,-38455.16 1756,-38455.16"/>
<polygon fill="black" stroke="black" points="1759.5,-38455.16 1756,-38445.16 1752.5,-38455.16 1759.5,-38455.16"/>
</g>
<!-- stage0_layer2_attention_out -->
<g id="node51" class="node">
<title>stage0_layer2_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-38289.95 1575.5,-38289.95 1575.5,-38221.95 1936.5,-38221.95 1936.5,-38289.95"/>
<text text-anchor="middle" x="1756" y="-38274.75" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-38259.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-38244.75" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-38229.75" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer2_attention_compute&#45;&gt;stage0_layer2_attention_out -->
<g id="edge83" class="edge">
<title>stage0_layer2_attention_compute&#45;&gt;stage0_layer2_attention_out</title>
<path fill="none" stroke="black" d="M1756,-38376.94C1756,-38376.94 1756,-38300.16 1756,-38300.16"/>
<polygon fill="black" stroke="black" points="1759.5,-38300.16 1756,-38290.16 1752.5,-38300.16 1759.5,-38300.16"/>
</g>
<!-- stage0_layer2_attention_allreduce -->
<g id="node52" class="node">
<title>stage0_layer2_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-38086.87" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-38105.67" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-38090.67" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-38075.67" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-38060.67" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_attention_out&#45;&gt;stage0_layer2_attention_allreduce -->
<g id="edge84" class="edge">
<title>stage0_layer2_attention_out&#45;&gt;stage0_layer2_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-38221.74C1756,-38221.74 1756,-38145.13 1756,-38145.13"/>
<polygon fill="black" stroke="black" points="1759.5,-38145.13 1756,-38135.13 1752.5,-38145.13 1759.5,-38145.13"/>
</g>
<!-- stage0_layer2_attention_residual -->
<g id="node53" class="node">
<title>stage0_layer2_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-37951.79 1584,-37951.79 1584,-37883.79 1928,-37883.79 1928,-37951.79"/>
<text text-anchor="middle" x="1756" y="-37936.59" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-37921.59" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-37906.59" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-37891.59" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_attention_allreduce&#45;&gt;stage0_layer2_attention_residual -->
<g id="edge85" class="edge">
<title>stage0_layer2_attention_allreduce&#45;&gt;stage0_layer2_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-38038.42C1756,-38038.42 1756,-37962.02 1756,-37962.02"/>
<polygon fill="black" stroke="black" points="1759.5,-37962.02 1756,-37952.02 1752.5,-37962.02 1759.5,-37962.02"/>
</g>
<!-- stage0_layer2_layernorm2 -->
<g id="node54" class="node">
<title>stage0_layer2_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-37796.79 1584,-37796.79 1584,-37728.79 1928,-37728.79 1928,-37796.79"/>
<text text-anchor="middle" x="1756" y="-37781.59" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-37766.59" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-37751.59" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-37736.59" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_attention_residual&#45;&gt;stage0_layer2_layernorm2 -->
<g id="edge86" class="edge">
<title>stage0_layer2_attention_residual&#45;&gt;stage0_layer2_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-37883.77C1756,-37883.77 1756,-37806.99 1756,-37806.99"/>
<polygon fill="black" stroke="black" points="1759.5,-37806.99 1756,-37796.99 1752.5,-37806.99 1759.5,-37806.99"/>
</g>
<!-- stage0_layer2_moe_gate -->
<g id="node55" class="node">
<title>stage0_layer2_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-37641.79 1552.53,-37641.79 1411.6,-37505.79 1959.47,-37505.79 2100.4,-37641.79"/>
<text text-anchor="middle" x="1756" y="-37592.59" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-37577.59" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-37562.59" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-37547.59" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage0_layer2_layernorm2&#45;&gt;stage0_layer2_moe_gate -->
<g id="edge87" class="edge">
<title>stage0_layer2_layernorm2&#45;&gt;stage0_layer2_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-37728.56C1756,-37728.56 1756,-37651.82 1756,-37651.82"/>
<polygon fill="black" stroke="black" points="1759.5,-37651.82 1756,-37641.82 1752.5,-37651.82 1759.5,-37651.82"/>
</g>
<!-- stage0_layer2_expert_dispatch -->
<g id="node56" class="node">
<title>stage0_layer2_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-37370.7" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-37389.5" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-37374.5" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-37359.5" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-37344.5" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_moe_gate&#45;&gt;stage0_layer2_expert_dispatch -->
<g id="edge63" class="edge">
<title>stage0_layer2_moe_gate&#45;&gt;stage0_layer2_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-37505.6C1756,-37505.6 1756,-37428.83 1756,-37428.83"/>
<polygon fill="black" stroke="black" points="1759.5,-37428.83 1756,-37418.83 1752.5,-37428.83 1759.5,-37428.83"/>
</g>
<!-- stage0_layer2_experts_group0 -->
<g id="node57" class="node">
<title>stage0_layer2_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-37235.62 16.5,-37235.62 16.5,-37152.62 351.5,-37152.62 351.5,-37235.62"/>
<text text-anchor="middle" x="184" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;3</text>
<text text-anchor="middle" x="184" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group0 -->
<g id="edge65" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group0</title>
<path fill="none" stroke="black" d="M1548.59,-37394C1109.95,-37394 128.17,-37394 128.17,-37394 128.17,-37394 128.17,-37246.02 128.17,-37246.02"/>
<polygon fill="black" stroke="black" points="131.67,-37246.02 128.17,-37236.02 124.67,-37246.02 131.67,-37246.02"/>
</g>
<!-- stage0_layer2_experts_group1 -->
<g id="node58" class="node">
<title>stage0_layer2_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-37235.62 409.5,-37235.62 409.5,-37152.62 744.5,-37152.62 744.5,-37235.62"/>
<text text-anchor="middle" x="577" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 4&#45;7</text>
<text text-anchor="middle" x="577" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group1 -->
<g id="edge67" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-37370C1160.38,-37370 521.17,-37370 521.17,-37370 521.17,-37370 521.17,-37245.8 521.17,-37245.8"/>
<polygon fill="black" stroke="black" points="524.67,-37245.8 521.17,-37235.8 517.67,-37245.8 524.67,-37245.8"/>
</g>
<!-- stage0_layer2_experts_group2 -->
<g id="node59" class="node">
<title>stage0_layer2_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-37235.62 802.5,-37235.62 802.5,-37152.62 1137.5,-37152.62 1137.5,-37235.62"/>
<text text-anchor="middle" x="970" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 8&#45;11</text>
<text text-anchor="middle" x="970" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group2 -->
<g id="edge69" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group2</title>
<path fill="none" stroke="black" d="M1552.75,-37346C1303.63,-37346 914.17,-37346 914.17,-37346 914.17,-37346 914.17,-37245.62 914.17,-37245.62"/>
<polygon fill="black" stroke="black" points="917.67,-37245.62 914.17,-37235.62 910.67,-37245.62 917.67,-37245.62"/>
</g>
<!-- stage0_layer2_experts_group3 -->
<g id="node60" class="node">
<title>stage0_layer2_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-37235.62 1195.5,-37235.62 1195.5,-37152.62 1530.5,-37152.62 1530.5,-37235.62"/>
<text text-anchor="middle" x="1363" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 12&#45;15</text>
<text text-anchor="middle" x="1363" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group3 -->
<g id="edge71" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-37360.18C1524.81,-37360.18 1524.81,-37245.88 1524.81,-37245.88"/>
<polygon fill="black" stroke="black" points="1528.31,-37245.88 1524.81,-37235.88 1521.31,-37245.88 1528.31,-37245.88"/>
</g>
<!-- stage0_layer2_experts_group4 -->
<g id="node61" class="node">
<title>stage0_layer2_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-37235.62 1588.5,-37235.62 1588.5,-37152.62 1923.5,-37152.62 1923.5,-37235.62"/>
<text text-anchor="middle" x="1756" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 16&#45;19</text>
<text text-anchor="middle" x="1756" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group4 -->
<g id="edge73" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-37322.45C1756,-37322.45 1756,-37245.71 1756,-37245.71"/>
<polygon fill="black" stroke="black" points="1759.5,-37245.71 1756,-37235.71 1752.5,-37245.72 1759.5,-37245.71"/>
</g>
<!-- stage0_layer2_experts_group5 -->
<g id="node62" class="node">
<title>stage0_layer2_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-37235.62 1981.5,-37235.62 1981.5,-37152.62 2316.5,-37152.62 2316.5,-37235.62"/>
<text text-anchor="middle" x="2149" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 20&#45;23</text>
<text text-anchor="middle" x="2149" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group5 -->
<g id="edge75" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-37360.18C1987.19,-37360.18 1987.19,-37245.88 1987.19,-37245.88"/>
<polygon fill="black" stroke="black" points="1990.69,-37245.88 1987.19,-37235.88 1983.69,-37245.88 1990.69,-37245.88"/>
</g>
<!-- stage0_layer2_experts_group6 -->
<g id="node63" class="node">
<title>stage0_layer2_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-37235.62 2374.5,-37235.62 2374.5,-37152.62 2709.5,-37152.62 2709.5,-37235.62"/>
<text text-anchor="middle" x="2542" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 24&#45;27</text>
<text text-anchor="middle" x="2542" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group6 -->
<g id="edge77" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group6</title>
<path fill="none" stroke="black" d="M1978.54,-37354C2193.32,-37354 2486.17,-37354 2486.17,-37354 2486.17,-37354 2486.17,-37245.71 2486.17,-37245.71"/>
<polygon fill="black" stroke="black" points="2489.67,-37245.71 2486.17,-37235.71 2482.67,-37245.71 2489.67,-37245.71"/>
</g>
<!-- stage0_layer2_experts_group7 -->
<g id="node64" class="node">
<title>stage0_layer2_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-37235.62 2767.5,-37235.62 2767.5,-37152.62 3102.5,-37152.62 3102.5,-37235.62"/>
<text text-anchor="middle" x="2935" y="-37220.42" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-37205.42" font-family="Times,serif" font-size="14.00">GPU 28&#45;31</text>
<text text-anchor="middle" x="2935" y="-37190.42" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-37175.42" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-37160.42" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group7 -->
<g id="edge79" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_experts_group7</title>
<path fill="none" stroke="black" d="M1980.59,-37386C2308.36,-37386 2879.17,-37386 2879.17,-37386 2879.17,-37386 2879.17,-37245.75 2879.17,-37245.75"/>
<polygon fill="black" stroke="black" points="2882.67,-37245.75 2879.17,-37235.75 2875.67,-37245.75 2882.67,-37245.75"/>
</g>
<!-- stage0_layer2_expert_combine -->
<g id="node65" class="node">
<title>stage0_layer2_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-37017.54" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-37036.34" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-37021.34" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-37006.34" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-36991.34" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge64" class="edge">
<title>stage0_layer2_expert_dispatch&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-37343.58C1559.5,-37343.58 1559.5,-37056.23 1559.5,-37056.23"/>
<polygon fill="black" stroke="black" points="1563,-37056.23 1559.5,-37046.23 1556,-37056.23 1563,-37056.23"/>
</g>
<!-- stage0_layer2_experts_group0&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge66" class="edge">
<title>stage0_layer2_experts_group0&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-37152.45C239.83,-37093.54 239.83,-36993 239.83,-36993 239.83,-36993 1536.78,-36993 1536.78,-36993"/>
<polygon fill="black" stroke="black" points="1536.78,-36996.5 1546.78,-36993 1536.78,-36989.5 1536.78,-36996.5"/>
</g>
<!-- stage0_layer2_experts_group1&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge68" class="edge">
<title>stage0_layer2_experts_group1&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-37152.59C632.83,-37100.24 632.83,-37017 632.83,-37017 632.83,-37017 1502.64,-37017 1502.64,-37017"/>
<polygon fill="black" stroke="black" points="1502.64,-37020.5 1512.64,-37017 1502.64,-37013.5 1502.64,-37020.5"/>
</g>
<!-- stage0_layer2_experts_group2&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge70" class="edge">
<title>stage0_layer2_experts_group2&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-37152.28C1025.83,-37106.94 1025.83,-37041 1025.83,-37041 1025.83,-37041 1533.33,-37041 1533.33,-37041"/>
<polygon fill="black" stroke="black" points="1533.33,-37044.5 1543.33,-37041 1533.33,-37037.5 1533.33,-37044.5"/>
</g>
<!-- stage0_layer2_experts_group3&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge72" class="edge">
<title>stage0_layer2_experts_group3&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-37152.27C1521.63,-37152.27 1521.63,-37040.45 1521.63,-37040.45"/>
<polygon fill="black" stroke="black" points="1525.13,-37040.45 1521.63,-37030.45 1518.13,-37040.45 1525.13,-37040.45"/>
</g>
<!-- stage0_layer2_experts_group4&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge74" class="edge">
<title>stage0_layer2_experts_group4&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-37152.27C1756,-37152.27 1756,-37075.64 1756,-37075.64"/>
<polygon fill="black" stroke="black" points="1759.5,-37075.64 1756,-37065.64 1752.5,-37075.64 1759.5,-37075.64"/>
</g>
<!-- stage0_layer2_experts_group5&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge76" class="edge">
<title>stage0_layer2_experts_group5&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-37152.27C1990.37,-37152.27 1990.37,-37040.45 1990.37,-37040.45"/>
<polygon fill="black" stroke="black" points="1993.87,-37040.45 1990.37,-37030.45 1986.87,-37040.45 1993.87,-37040.45"/>
</g>
<!-- stage0_layer2_experts_group6&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge78" class="edge">
<title>stage0_layer2_experts_group6&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-37152.21C2597.83,-37104.47 2597.83,-37033 2597.83,-37033 2597.83,-37033 1996.59,-37033 1996.59,-37033"/>
<polygon fill="black" stroke="black" points="1996.59,-37029.5 1986.59,-37033 1996.59,-37036.5 1996.59,-37029.5"/>
</g>
<!-- stage0_layer2_experts_group7&#45;&gt;stage0_layer2_expert_combine -->
<g id="edge80" class="edge">
<title>stage0_layer2_experts_group7&#45;&gt;stage0_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-37152.21C2990.83,-37095.42 2990.83,-37001 2990.83,-37001 2990.83,-37001 1994.65,-37001 1994.65,-37001"/>
<polygon fill="black" stroke="black" points="1994.65,-36997.5 1984.65,-37001 1994.65,-37004.5 1994.65,-36997.5"/>
</g>
<!-- stage0_layer2_mlp_fc1 -->
<g id="node66" class="node">
<title>stage0_layer2_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-36882.45 1590,-36882.45 1590,-36814.45 1922,-36814.45 1922,-36882.45"/>
<text text-anchor="middle" x="1756" y="-36867.25" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-36852.25" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-36837.25" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-36822.25" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer2_expert_combine&#45;&gt;stage0_layer2_mlp_fc1 -->
<g id="edge88" class="edge">
<title>stage0_layer2_expert_combine&#45;&gt;stage0_layer2_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-36969.08C1756,-36969.08 1756,-36892.69 1756,-36892.69"/>
<polygon fill="black" stroke="black" points="1759.5,-36892.69 1756,-36882.69 1752.5,-36892.69 1759.5,-36892.69"/>
</g>
<!-- stage0_layer2_mlp_gelu -->
<g id="node67" class="node">
<title>stage0_layer2_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-36727.45 1603.5,-36727.45 1603.5,-36659.45 1908.5,-36659.45 1908.5,-36727.45"/>
<text text-anchor="middle" x="1756" y="-36712.25" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-36697.25" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-36682.25" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-36667.25" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer2_mlp_fc1&#45;&gt;stage0_layer2_mlp_gelu -->
<g id="edge89" class="edge">
<title>stage0_layer2_mlp_fc1&#45;&gt;stage0_layer2_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-36814.44C1756,-36814.44 1756,-36737.66 1756,-36737.66"/>
<polygon fill="black" stroke="black" points="1759.5,-36737.66 1756,-36727.66 1752.5,-36737.66 1759.5,-36737.66"/>
</g>
<!-- stage0_layer2_mlp_fc2 -->
<g id="node68" class="node">
<title>stage0_layer2_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-36572.45 1588.5,-36572.45 1588.5,-36504.45 1923.5,-36504.45 1923.5,-36572.45"/>
<text text-anchor="middle" x="1756" y="-36557.25" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-36542.25" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-36527.25" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-36512.25" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer2_mlp_gelu&#45;&gt;stage0_layer2_mlp_fc2 -->
<g id="edge90" class="edge">
<title>stage0_layer2_mlp_gelu&#45;&gt;stage0_layer2_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-36659.44C1756,-36659.44 1756,-36582.66 1756,-36582.66"/>
<polygon fill="black" stroke="black" points="1759.5,-36582.66 1756,-36572.66 1752.5,-36582.66 1759.5,-36582.66"/>
</g>
<!-- stage0_layer2_mlp_allreduce -->
<g id="node69" class="node">
<title>stage0_layer2_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-36369.37" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-36388.17" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-36373.17" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-36358.17" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-36343.17" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_mlp_fc2&#45;&gt;stage0_layer2_mlp_allreduce -->
<g id="edge91" class="edge">
<title>stage0_layer2_mlp_fc2&#45;&gt;stage0_layer2_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-36504.24C1756,-36504.24 1756,-36427.63 1756,-36427.63"/>
<polygon fill="black" stroke="black" points="1759.5,-36427.63 1756,-36417.63 1752.5,-36427.63 1759.5,-36427.63"/>
</g>
<!-- stage0_layer2_mlp_end -->
<g id="node70" class="node">
<title>stage0_layer2_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-36234.29 1584,-36234.29 1584,-36166.29 1928,-36166.29 1928,-36234.29"/>
<text text-anchor="middle" x="1756" y="-36219.09" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-36204.09" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-36189.09" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-36174.09" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_mlp_allreduce&#45;&gt;stage0_layer2_mlp_end -->
<g id="edge92" class="edge">
<title>stage0_layer2_mlp_allreduce&#45;&gt;stage0_layer2_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-36320.92C1756,-36320.92 1756,-36244.52 1756,-36244.52"/>
<polygon fill="black" stroke="black" points="1759.5,-36244.52 1756,-36234.52 1752.5,-36244.52 1759.5,-36244.52"/>
</g>
<!-- stage0_layer3_attention_start -->
<g id="node71" class="node">
<title>stage0_layer3_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-36079.29 1584,-36079.29 1584,-36011.29 1928,-36011.29 1928,-36079.29"/>
<text text-anchor="middle" x="1756" y="-36064.09" font-family="Times,serif" font-size="14.00">Attention Start (Layer 3)</text>
<text text-anchor="middle" x="1756" y="-36049.09" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-36034.09" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-36019.09" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer2_mlp_end&#45;&gt;stage0_layer3_attention_start -->
<g id="edge124" class="edge">
<title>stage0_layer2_mlp_end&#45;&gt;stage0_layer3_attention_start</title>
<path fill="none" stroke="black" d="M1756,-36166.27C1756,-36166.27 1756,-36089.49 1756,-36089.49"/>
<polygon fill="black" stroke="black" points="1759.5,-36089.49 1756,-36079.49 1752.5,-36089.49 1759.5,-36089.49"/>
</g>
<!-- stage0_layer3_qkv_proj -->
<g id="node72" class="node">
<title>stage0_layer3_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-35924.29 1569.5,-35924.29 1569.5,-35856.29 1942.5,-35856.29 1942.5,-35924.29"/>
<text text-anchor="middle" x="1756" y="-35909.09" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-35894.09" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-35879.09" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-35864.09" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer3_attention_start&#45;&gt;stage0_layer3_qkv_proj -->
<g id="edge112" class="edge">
<title>stage0_layer3_attention_start&#45;&gt;stage0_layer3_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-36011.27C1756,-36011.27 1756,-35934.49 1756,-35934.49"/>
<polygon fill="black" stroke="black" points="1759.5,-35934.49 1756,-35924.49 1752.5,-35934.49 1759.5,-35934.49"/>
</g>
<!-- stage0_layer3_attention_compute -->
<g id="node73" class="node">
<title>stage0_layer3_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-35769.29 1569.5,-35769.29 1569.5,-35701.29 1942.5,-35701.29 1942.5,-35769.29"/>
<text text-anchor="middle" x="1756" y="-35754.09" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-35739.09" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-35724.09" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-35709.09" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage0_layer3_qkv_proj&#45;&gt;stage0_layer3_attention_compute -->
<g id="edge113" class="edge">
<title>stage0_layer3_qkv_proj&#45;&gt;stage0_layer3_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-35856.27C1756,-35856.27 1756,-35779.49 1756,-35779.49"/>
<polygon fill="black" stroke="black" points="1759.5,-35779.49 1756,-35769.49 1752.5,-35779.49 1759.5,-35779.49"/>
</g>
<!-- stage0_layer3_attention_out -->
<g id="node74" class="node">
<title>stage0_layer3_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-35614.29 1575.5,-35614.29 1575.5,-35546.29 1936.5,-35546.29 1936.5,-35614.29"/>
<text text-anchor="middle" x="1756" y="-35599.09" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-35584.09" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-35569.09" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-35554.09" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer3_attention_compute&#45;&gt;stage0_layer3_attention_out -->
<g id="edge114" class="edge">
<title>stage0_layer3_attention_compute&#45;&gt;stage0_layer3_attention_out</title>
<path fill="none" stroke="black" d="M1756,-35701.27C1756,-35701.27 1756,-35624.49 1756,-35624.49"/>
<polygon fill="black" stroke="black" points="1759.5,-35624.49 1756,-35614.49 1752.5,-35624.49 1759.5,-35624.49"/>
</g>
<!-- stage0_layer3_attention_allreduce -->
<g id="node75" class="node">
<title>stage0_layer3_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-35411.2" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-35430" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-35415" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-35400" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-35385" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_attention_out&#45;&gt;stage0_layer3_attention_allreduce -->
<g id="edge115" class="edge">
<title>stage0_layer3_attention_out&#45;&gt;stage0_layer3_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-35546.07C1756,-35546.07 1756,-35469.46 1756,-35469.46"/>
<polygon fill="black" stroke="black" points="1759.5,-35469.46 1756,-35459.46 1752.5,-35469.46 1759.5,-35469.46"/>
</g>
<!-- stage0_layer3_attention_residual -->
<g id="node76" class="node">
<title>stage0_layer3_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-35276.12 1584,-35276.12 1584,-35208.12 1928,-35208.12 1928,-35276.12"/>
<text text-anchor="middle" x="1756" y="-35260.92" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-35245.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-35230.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-35215.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_attention_allreduce&#45;&gt;stage0_layer3_attention_residual -->
<g id="edge116" class="edge">
<title>stage0_layer3_attention_allreduce&#45;&gt;stage0_layer3_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-35362.75C1756,-35362.75 1756,-35286.35 1756,-35286.35"/>
<polygon fill="black" stroke="black" points="1759.5,-35286.35 1756,-35276.35 1752.5,-35286.35 1759.5,-35286.35"/>
</g>
<!-- stage0_layer3_layernorm2 -->
<g id="node77" class="node">
<title>stage0_layer3_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-35121.12 1584,-35121.12 1584,-35053.12 1928,-35053.12 1928,-35121.12"/>
<text text-anchor="middle" x="1756" y="-35105.92" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-35090.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-35075.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-35060.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_attention_residual&#45;&gt;stage0_layer3_layernorm2 -->
<g id="edge117" class="edge">
<title>stage0_layer3_attention_residual&#45;&gt;stage0_layer3_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-35208.1C1756,-35208.1 1756,-35131.32 1756,-35131.32"/>
<polygon fill="black" stroke="black" points="1759.5,-35131.32 1756,-35121.32 1752.5,-35131.32 1759.5,-35131.32"/>
</g>
<!-- stage0_layer3_moe_gate -->
<g id="node78" class="node">
<title>stage0_layer3_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-34966.12 1552.53,-34966.12 1411.6,-34830.12 1959.47,-34830.12 2100.4,-34966.12"/>
<text text-anchor="middle" x="1756" y="-34916.92" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-34901.92" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-34886.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-34871.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage0_layer3_layernorm2&#45;&gt;stage0_layer3_moe_gate -->
<g id="edge118" class="edge">
<title>stage0_layer3_layernorm2&#45;&gt;stage0_layer3_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-35052.89C1756,-35052.89 1756,-34976.15 1756,-34976.15"/>
<polygon fill="black" stroke="black" points="1759.5,-34976.15 1756,-34966.15 1752.5,-34976.15 1759.5,-34976.15"/>
</g>
<!-- stage0_layer3_expert_dispatch -->
<g id="node79" class="node">
<title>stage0_layer3_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-34695.04" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-34713.84" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-34698.84" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-34683.84" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-34668.84" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_moe_gate&#45;&gt;stage0_layer3_expert_dispatch -->
<g id="edge94" class="edge">
<title>stage0_layer3_moe_gate&#45;&gt;stage0_layer3_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-34829.93C1756,-34829.93 1756,-34753.16 1756,-34753.16"/>
<polygon fill="black" stroke="black" points="1759.5,-34753.16 1756,-34743.16 1752.5,-34753.16 1759.5,-34753.16"/>
</g>
<!-- stage0_layer3_experts_group0 -->
<g id="node80" class="node">
<title>stage0_layer3_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-34559.95 16.5,-34559.95 16.5,-34476.95 351.5,-34476.95 351.5,-34559.95"/>
<text text-anchor="middle" x="184" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 0&#45;3</text>
<text text-anchor="middle" x="184" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group0 -->
<g id="edge96" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group0</title>
<path fill="none" stroke="black" d="M1550.25,-34719C1112.42,-34719 128.17,-34719 128.17,-34719 128.17,-34719 128.17,-34570.01 128.17,-34570.01"/>
<polygon fill="black" stroke="black" points="131.67,-34570.01 128.17,-34560.01 124.67,-34570.01 131.67,-34570.01"/>
</g>
<!-- stage0_layer3_experts_group1 -->
<g id="node81" class="node">
<title>stage0_layer3_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-34559.95 409.5,-34559.95 409.5,-34476.95 744.5,-34476.95 744.5,-34559.95"/>
<text text-anchor="middle" x="577" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 4&#45;7</text>
<text text-anchor="middle" x="577" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group1 -->
<g id="edge98" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-34695C1160.38,-34695 521.17,-34695 521.17,-34695 521.17,-34695 521.17,-34570.29 521.17,-34570.29"/>
<polygon fill="black" stroke="black" points="524.67,-34570.29 521.17,-34560.29 517.67,-34570.29 524.67,-34570.29"/>
</g>
<!-- stage0_layer3_experts_group2 -->
<g id="node82" class="node">
<title>stage0_layer3_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-34559.95 802.5,-34559.95 802.5,-34476.95 1137.5,-34476.95 1137.5,-34559.95"/>
<text text-anchor="middle" x="970" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 8&#45;11</text>
<text text-anchor="middle" x="970" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group2 -->
<g id="edge100" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group2</title>
<path fill="none" stroke="black" d="M1553.56,-34670C1304.47,-34670 914.17,-34670 914.17,-34670 914.17,-34670 914.17,-34570.26 914.17,-34570.26"/>
<polygon fill="black" stroke="black" points="917.67,-34570.26 914.17,-34560.26 910.67,-34570.26 917.67,-34570.26"/>
</g>
<!-- stage0_layer3_experts_group3 -->
<g id="node83" class="node">
<title>stage0_layer3_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-34559.95 1195.5,-34559.95 1195.5,-34476.95 1530.5,-34476.95 1530.5,-34559.95"/>
<text text-anchor="middle" x="1363" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 12&#45;15</text>
<text text-anchor="middle" x="1363" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group3 -->
<g id="edge102" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-34684.52C1524.81,-34684.52 1524.81,-34570.21 1524.81,-34570.21"/>
<polygon fill="black" stroke="black" points="1528.31,-34570.21 1524.81,-34560.21 1521.31,-34570.21 1528.31,-34570.21"/>
</g>
<!-- stage0_layer3_experts_group4 -->
<g id="node84" class="node">
<title>stage0_layer3_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-34559.95 1588.5,-34559.95 1588.5,-34476.95 1923.5,-34476.95 1923.5,-34559.95"/>
<text text-anchor="middle" x="1756" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 16&#45;19</text>
<text text-anchor="middle" x="1756" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group4 -->
<g id="edge104" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-34646.78C1756,-34646.78 1756,-34570.05 1756,-34570.05"/>
<polygon fill="black" stroke="black" points="1759.5,-34570.05 1756,-34560.05 1752.5,-34570.05 1759.5,-34570.05"/>
</g>
<!-- stage0_layer3_experts_group5 -->
<g id="node85" class="node">
<title>stage0_layer3_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-34559.95 1981.5,-34559.95 1981.5,-34476.95 2316.5,-34476.95 2316.5,-34559.95"/>
<text text-anchor="middle" x="2149" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 20&#45;23</text>
<text text-anchor="middle" x="2149" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group5 -->
<g id="edge106" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-34684.52C1987.19,-34684.52 1987.19,-34570.21 1987.19,-34570.21"/>
<polygon fill="black" stroke="black" points="1990.69,-34570.21 1987.19,-34560.21 1983.69,-34570.21 1990.69,-34570.21"/>
</g>
<!-- stage0_layer3_experts_group6 -->
<g id="node86" class="node">
<title>stage0_layer3_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-34559.95 2374.5,-34559.95 2374.5,-34476.95 2709.5,-34476.95 2709.5,-34559.95"/>
<text text-anchor="middle" x="2542" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 24&#45;27</text>
<text text-anchor="middle" x="2542" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group6 -->
<g id="edge108" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group6</title>
<path fill="none" stroke="black" d="M1979.54,-34679C2194.22,-34679 2486.17,-34679 2486.17,-34679 2486.17,-34679 2486.17,-34570.22 2486.17,-34570.22"/>
<polygon fill="black" stroke="black" points="2489.67,-34570.22 2486.17,-34560.22 2482.67,-34570.22 2489.67,-34570.22"/>
</g>
<!-- stage0_layer3_experts_group7 -->
<g id="node87" class="node">
<title>stage0_layer3_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-34559.95 2767.5,-34559.95 2767.5,-34476.95 3102.5,-34476.95 3102.5,-34559.95"/>
<text text-anchor="middle" x="2935" y="-34544.75" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-34529.75" font-family="Times,serif" font-size="14.00">GPU 28&#45;31</text>
<text text-anchor="middle" x="2935" y="-34514.75" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-34499.75" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-34484.75" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group7 -->
<g id="edge110" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_experts_group7</title>
<path fill="none" stroke="black" d="M1979.58,-34711C2307.19,-34711 2879.17,-34711 2879.17,-34711 2879.17,-34711 2879.17,-34570.23 2879.17,-34570.23"/>
<polygon fill="black" stroke="black" points="2882.67,-34570.23 2879.17,-34560.23 2875.67,-34570.23 2882.67,-34570.23"/>
</g>
<!-- stage0_layer3_expert_combine -->
<g id="node88" class="node">
<title>stage0_layer3_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-34341.87" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-34360.67" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-34345.67" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-34330.67" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-34315.67" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge95" class="edge">
<title>stage0_layer3_expert_dispatch&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-34667.91C1559.5,-34667.91 1559.5,-34380.56 1559.5,-34380.56"/>
<polygon fill="black" stroke="black" points="1563,-34380.56 1559.5,-34370.56 1556,-34380.56 1563,-34380.56"/>
</g>
<!-- stage0_layer3_experts_group0&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge97" class="edge">
<title>stage0_layer3_experts_group0&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-34476.71C239.83,-34417.7 239.83,-34317 239.83,-34317 239.83,-34317 1537.57,-34317 1537.57,-34317"/>
<polygon fill="black" stroke="black" points="1537.57,-34320.5 1547.57,-34317 1537.57,-34313.5 1537.57,-34320.5"/>
</g>
<!-- stage0_layer3_experts_group1&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge99" class="edge">
<title>stage0_layer3_experts_group1&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-34476.85C632.83,-34424.4 632.83,-34341 632.83,-34341 632.83,-34341 1502.64,-34341 1502.64,-34341"/>
<polygon fill="black" stroke="black" points="1502.64,-34344.5 1512.64,-34341 1502.64,-34337.5 1502.64,-34344.5"/>
</g>
<!-- stage0_layer3_experts_group2&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge101" class="edge">
<title>stage0_layer3_experts_group2&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-34476.93C1025.83,-34431.48 1025.83,-34365 1025.83,-34365 1025.83,-34365 1532.35,-34365 1532.35,-34365"/>
<polygon fill="black" stroke="black" points="1532.35,-34368.5 1542.35,-34365 1532.35,-34361.5 1532.35,-34368.5"/>
</g>
<!-- stage0_layer3_experts_group3&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge103" class="edge">
<title>stage0_layer3_experts_group3&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-34476.6C1521.63,-34476.6 1521.63,-34364.79 1521.63,-34364.79"/>
<polygon fill="black" stroke="black" points="1525.13,-34364.79 1521.63,-34354.79 1518.13,-34364.79 1525.13,-34364.79"/>
</g>
<!-- stage0_layer3_experts_group4&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge105" class="edge">
<title>stage0_layer3_experts_group4&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-34476.6C1756,-34476.6 1756,-34399.97 1756,-34399.97"/>
<polygon fill="black" stroke="black" points="1759.5,-34399.97 1756,-34389.97 1752.5,-34399.97 1759.5,-34399.97"/>
</g>
<!-- stage0_layer3_experts_group5&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge107" class="edge">
<title>stage0_layer3_experts_group5&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-34476.6C1990.37,-34476.6 1990.37,-34364.79 1990.37,-34364.79"/>
<polygon fill="black" stroke="black" points="1993.87,-34364.79 1990.37,-34354.79 1986.87,-34364.79 1993.87,-34364.79"/>
</g>
<!-- stage0_layer3_experts_group6&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge109" class="edge">
<title>stage0_layer3_experts_group6&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-34476.87C2597.83,-34429.04 2597.83,-34357 2597.83,-34357 2597.83,-34357 1997.15,-34357 1997.15,-34357"/>
<polygon fill="black" stroke="black" points="1997.15,-34353.5 1987.15,-34357 1997.15,-34360.5 1997.15,-34353.5"/>
</g>
<!-- stage0_layer3_experts_group7&#45;&gt;stage0_layer3_expert_combine -->
<g id="edge111" class="edge">
<title>stage0_layer3_experts_group7&#45;&gt;stage0_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-34476.95C2990.83,-34420.11 2990.83,-34325 2990.83,-34325 2990.83,-34325 1993.93,-34325 1993.93,-34325"/>
<polygon fill="black" stroke="black" points="1993.93,-34321.5 1983.93,-34325 1993.93,-34328.5 1993.93,-34321.5"/>
</g>
<!-- stage0_layer3_mlp_fc1 -->
<g id="node89" class="node">
<title>stage0_layer3_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-34206.79 1590,-34206.79 1590,-34138.79 1922,-34138.79 1922,-34206.79"/>
<text text-anchor="middle" x="1756" y="-34191.59" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-34176.59" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-34161.59" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-34146.59" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer3_expert_combine&#45;&gt;stage0_layer3_mlp_fc1 -->
<g id="edge119" class="edge">
<title>stage0_layer3_expert_combine&#45;&gt;stage0_layer3_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-34293.42C1756,-34293.42 1756,-34217.02 1756,-34217.02"/>
<polygon fill="black" stroke="black" points="1759.5,-34217.02 1756,-34207.02 1752.5,-34217.02 1759.5,-34217.02"/>
</g>
<!-- stage0_layer3_mlp_gelu -->
<g id="node90" class="node">
<title>stage0_layer3_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-34051.79 1603.5,-34051.79 1603.5,-33983.79 1908.5,-33983.79 1908.5,-34051.79"/>
<text text-anchor="middle" x="1756" y="-34036.59" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-34021.59" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-34006.59" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-33991.59" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage0_layer3_mlp_fc1&#45;&gt;stage0_layer3_mlp_gelu -->
<g id="edge120" class="edge">
<title>stage0_layer3_mlp_fc1&#45;&gt;stage0_layer3_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-34138.77C1756,-34138.77 1756,-34061.99 1756,-34061.99"/>
<polygon fill="black" stroke="black" points="1759.5,-34061.99 1756,-34051.99 1752.5,-34061.99 1759.5,-34061.99"/>
</g>
<!-- stage0_layer3_mlp_fc2 -->
<g id="node91" class="node">
<title>stage0_layer3_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-33896.79 1588.5,-33896.79 1588.5,-33828.79 1923.5,-33828.79 1923.5,-33896.79"/>
<text text-anchor="middle" x="1756" y="-33881.59" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-33866.59" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-33851.59" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-33836.59" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage0_layer3_mlp_gelu&#45;&gt;stage0_layer3_mlp_fc2 -->
<g id="edge121" class="edge">
<title>stage0_layer3_mlp_gelu&#45;&gt;stage0_layer3_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-33983.77C1756,-33983.77 1756,-33906.99 1756,-33906.99"/>
<polygon fill="black" stroke="black" points="1759.5,-33906.99 1756,-33896.99 1752.5,-33906.99 1759.5,-33906.99"/>
</g>
<!-- stage0_layer3_mlp_allreduce -->
<g id="node92" class="node">
<title>stage0_layer3_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-33693.7" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-33712.5" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-33697.5" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-33682.5" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-33667.5" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_mlp_fc2&#45;&gt;stage0_layer3_mlp_allreduce -->
<g id="edge122" class="edge">
<title>stage0_layer3_mlp_fc2&#45;&gt;stage0_layer3_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-33828.57C1756,-33828.57 1756,-33751.96 1756,-33751.96"/>
<polygon fill="black" stroke="black" points="1759.5,-33751.96 1756,-33741.96 1752.5,-33751.96 1759.5,-33751.96"/>
</g>
<!-- stage0_layer3_mlp_end -->
<g id="node93" class="node">
<title>stage0_layer3_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-33558.62 1584,-33558.62 1584,-33490.62 1928,-33490.62 1928,-33558.62"/>
<text text-anchor="middle" x="1756" y="-33543.42" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-33528.42" font-family="Times,serif" font-size="14.00">GPU 0&#45;31</text>
<text text-anchor="middle" x="1756" y="-33513.42" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-33498.42" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_mlp_allreduce&#45;&gt;stage0_layer3_mlp_end -->
<g id="edge123" class="edge">
<title>stage0_layer3_mlp_allreduce&#45;&gt;stage0_layer3_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-33645.25C1756,-33645.25 1756,-33568.85 1756,-33568.85"/>
<polygon fill="black" stroke="black" points="1759.5,-33568.85 1756,-33558.85 1752.5,-33568.85 1759.5,-33568.85"/>
</g>
<!-- stage0_output -->
<g id="node94" class="node">
<title>stage0_output</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-33366.14" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-33377.44" font-family="Times,serif" font-size="14.00">Stage Output</text>
<text text-anchor="middle" x="1756" y="-33362.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-33347.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_layer3_mlp_end&#45;&gt;stage0_output -->
<g id="edge125" class="edge">
<title>stage0_layer3_mlp_end&#45;&gt;stage0_output</title>
<path fill="none" stroke="black" d="M1756,-33490.23C1756,-33490.23 1756,-33413.79 1756,-33413.79"/>
<polygon fill="black" stroke="black" points="1759.5,-33413.79 1756,-33403.79 1752.5,-33413.79 1759.5,-33413.79"/>
</g>
<!-- stage1_input -->
<g id="node95" class="node">
<title>stage1_input</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-33175.19" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-33186.49" font-family="Times,serif" font-size="14.00">Input</text>
<text text-anchor="middle" x="1756" y="-33171.49" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-33156.49" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage0_output&#45;&gt;stage1_input -->
<g id="edge501" class="edge">
<title>stage0_output&#45;&gt;stage1_input</title>
<path fill="none" stroke="black" d="M1756,-33328.42C1756,-33328.42 1756,-33222.84 1756,-33222.84"/>
<polygon fill="black" stroke="black" points="1759.5,-33222.84 1756,-33212.84 1752.5,-33222.84 1759.5,-33222.84"/>
<text text-anchor="middle" x="1890" y="-33274.47" font-family="Times,serif" font-size="14.00">Pipeline Communication</text>
<text text-anchor="middle" x="1890" y="-33259.47" font-family="Times,serif" font-size="14.00">[batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_attention_start -->
<g id="node96" class="node">
<title>stage1_layer0_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-33050.71 1584,-33050.71 1584,-32982.71 1928,-32982.71 1928,-33050.71"/>
<text text-anchor="middle" x="1756" y="-33035.51" font-family="Times,serif" font-size="14.00">Attention Start (Layer 0)</text>
<text text-anchor="middle" x="1756" y="-33020.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-33005.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-32990.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_input&#45;&gt;stage1_layer0_attention_start -->
<g id="edge156" class="edge">
<title>stage1_input&#45;&gt;stage1_layer0_attention_start</title>
<path fill="none" stroke="black" d="M1756,-33137.63C1756,-33137.63 1756,-33060.76 1756,-33060.76"/>
<polygon fill="black" stroke="black" points="1759.5,-33060.76 1756,-33050.76 1752.5,-33060.76 1759.5,-33060.76"/>
</g>
<!-- stage1_layer0_qkv_proj -->
<g id="node97" class="node">
<title>stage1_layer0_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-32895.71 1569.5,-32895.71 1569.5,-32827.71 1942.5,-32827.71 1942.5,-32895.71"/>
<text text-anchor="middle" x="1756" y="-32880.51" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-32865.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-32850.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-32835.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer0_attention_start&#45;&gt;stage1_layer0_qkv_proj -->
<g id="edge144" class="edge">
<title>stage1_layer0_attention_start&#45;&gt;stage1_layer0_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-32982.7C1756,-32982.7 1756,-32905.92 1756,-32905.92"/>
<polygon fill="black" stroke="black" points="1759.5,-32905.92 1756,-32895.92 1752.5,-32905.92 1759.5,-32905.92"/>
</g>
<!-- stage1_layer0_attention_compute -->
<g id="node98" class="node">
<title>stage1_layer0_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-32740.71 1569.5,-32740.71 1569.5,-32672.71 1942.5,-32672.71 1942.5,-32740.71"/>
<text text-anchor="middle" x="1756" y="-32725.51" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-32710.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-32695.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-32680.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer0_qkv_proj&#45;&gt;stage1_layer0_attention_compute -->
<g id="edge145" class="edge">
<title>stage1_layer0_qkv_proj&#45;&gt;stage1_layer0_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-32827.7C1756,-32827.7 1756,-32750.92 1756,-32750.92"/>
<polygon fill="black" stroke="black" points="1759.5,-32750.92 1756,-32740.92 1752.5,-32750.92 1759.5,-32750.92"/>
</g>
<!-- stage1_layer0_attention_out -->
<g id="node99" class="node">
<title>stage1_layer0_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-32585.71 1575.5,-32585.71 1575.5,-32517.71 1936.5,-32517.71 1936.5,-32585.71"/>
<text text-anchor="middle" x="1756" y="-32570.51" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-32555.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-32540.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-32525.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer0_attention_compute&#45;&gt;stage1_layer0_attention_out -->
<g id="edge146" class="edge">
<title>stage1_layer0_attention_compute&#45;&gt;stage1_layer0_attention_out</title>
<path fill="none" stroke="black" d="M1756,-32672.7C1756,-32672.7 1756,-32595.92 1756,-32595.92"/>
<polygon fill="black" stroke="black" points="1759.5,-32595.92 1756,-32585.92 1752.5,-32595.92 1759.5,-32595.92"/>
</g>
<!-- stage1_layer0_attention_allreduce -->
<g id="node100" class="node">
<title>stage1_layer0_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-32382.63" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-32401.43" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-32386.43" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-32371.43" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-32356.43" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_attention_out&#45;&gt;stage1_layer0_attention_allreduce -->
<g id="edge147" class="edge">
<title>stage1_layer0_attention_out&#45;&gt;stage1_layer0_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-32517.5C1756,-32517.5 1756,-32440.89 1756,-32440.89"/>
<polygon fill="black" stroke="black" points="1759.5,-32440.89 1756,-32430.89 1752.5,-32440.89 1759.5,-32440.89"/>
</g>
<!-- stage1_layer0_attention_residual -->
<g id="node101" class="node">
<title>stage1_layer0_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-32247.55 1584,-32247.55 1584,-32179.55 1928,-32179.55 1928,-32247.55"/>
<text text-anchor="middle" x="1756" y="-32232.35" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-32217.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-32202.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-32187.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_attention_allreduce&#45;&gt;stage1_layer0_attention_residual -->
<g id="edge148" class="edge">
<title>stage1_layer0_attention_allreduce&#45;&gt;stage1_layer0_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-32334.18C1756,-32334.18 1756,-32257.78 1756,-32257.78"/>
<polygon fill="black" stroke="black" points="1759.5,-32257.78 1756,-32247.78 1752.5,-32257.78 1759.5,-32257.78"/>
</g>
<!-- stage1_layer0_layernorm2 -->
<g id="node102" class="node">
<title>stage1_layer0_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-32092.55 1584,-32092.55 1584,-32024.55 1928,-32024.55 1928,-32092.55"/>
<text text-anchor="middle" x="1756" y="-32077.35" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-32062.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-32047.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-32032.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_attention_residual&#45;&gt;stage1_layer0_layernorm2 -->
<g id="edge149" class="edge">
<title>stage1_layer0_attention_residual&#45;&gt;stage1_layer0_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-32179.53C1756,-32179.53 1756,-32102.75 1756,-32102.75"/>
<polygon fill="black" stroke="black" points="1759.5,-32102.75 1756,-32092.75 1752.5,-32102.75 1759.5,-32102.75"/>
</g>
<!-- stage1_layer0_moe_gate -->
<g id="node103" class="node">
<title>stage1_layer0_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-31937.55 1552.53,-31937.55 1411.6,-31801.55 1959.47,-31801.55 2100.4,-31937.55"/>
<text text-anchor="middle" x="1756" y="-31888.35" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-31873.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-31858.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-31843.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage1_layer0_layernorm2&#45;&gt;stage1_layer0_moe_gate -->
<g id="edge150" class="edge">
<title>stage1_layer0_layernorm2&#45;&gt;stage1_layer0_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-32024.32C1756,-32024.32 1756,-31947.58 1756,-31947.58"/>
<polygon fill="black" stroke="black" points="1759.5,-31947.58 1756,-31937.58 1752.5,-31947.58 1759.5,-31947.58"/>
</g>
<!-- stage1_layer0_expert_dispatch -->
<g id="node104" class="node">
<title>stage1_layer0_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-31666.46" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-31685.26" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-31670.26" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-31655.26" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-31640.26" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_moe_gate&#45;&gt;stage1_layer0_expert_dispatch -->
<g id="edge126" class="edge">
<title>stage1_layer0_moe_gate&#45;&gt;stage1_layer0_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-31801.36C1756,-31801.36 1756,-31724.59 1756,-31724.59"/>
<polygon fill="black" stroke="black" points="1759.5,-31724.59 1756,-31714.59 1752.5,-31724.59 1759.5,-31724.59"/>
</g>
<!-- stage1_layer0_experts_group0 -->
<g id="node105" class="node">
<title>stage1_layer0_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-31531.38 16.5,-31531.38 16.5,-31448.38 351.5,-31448.38 351.5,-31531.38"/>
<text text-anchor="middle" x="184" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;131</text>
<text text-anchor="middle" x="184" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group0 -->
<g id="edge128" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group0</title>
<path fill="none" stroke="black" d="M1549.42,-31690C1111.19,-31690 128.17,-31690 128.17,-31690 128.17,-31690 128.17,-31541.83 128.17,-31541.83"/>
<polygon fill="black" stroke="black" points="131.67,-31541.83 128.17,-31531.83 124.67,-31541.83 131.67,-31541.83"/>
</g>
<!-- stage1_layer0_experts_group1 -->
<g id="node106" class="node">
<title>stage1_layer0_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-31531.38 409.5,-31531.38 409.5,-31448.38 744.5,-31448.38 744.5,-31531.38"/>
<text text-anchor="middle" x="577" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 132&#45;135</text>
<text text-anchor="middle" x="577" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group1 -->
<g id="edge130" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-31666C1160.38,-31666 521.17,-31666 521.17,-31666 521.17,-31666 521.17,-31541.62 521.17,-31541.62"/>
<polygon fill="black" stroke="black" points="524.67,-31541.62 521.17,-31531.62 517.67,-31541.62 524.67,-31541.62"/>
</g>
<!-- stage1_layer0_experts_group2 -->
<g id="node107" class="node">
<title>stage1_layer0_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-31531.38 802.5,-31531.38 802.5,-31448.38 1137.5,-31448.38 1137.5,-31531.38"/>
<text text-anchor="middle" x="970" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 136&#45;139</text>
<text text-anchor="middle" x="970" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group2 -->
<g id="edge132" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group2</title>
<path fill="none" stroke="black" d="M1551.95,-31642C1302.79,-31642 914.17,-31642 914.17,-31642 914.17,-31642 914.17,-31541.45 914.17,-31541.45"/>
<polygon fill="black" stroke="black" points="917.67,-31541.45 914.17,-31531.45 910.67,-31541.45 917.67,-31541.45"/>
</g>
<!-- stage1_layer0_experts_group3 -->
<g id="node108" class="node">
<title>stage1_layer0_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-31531.38 1195.5,-31531.38 1195.5,-31448.38 1530.5,-31448.38 1530.5,-31531.38"/>
<text text-anchor="middle" x="1363" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 140&#45;143</text>
<text text-anchor="middle" x="1363" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group3 -->
<g id="edge134" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-31655.95C1524.81,-31655.95 1524.81,-31541.64 1524.81,-31541.64"/>
<polygon fill="black" stroke="black" points="1528.31,-31541.64 1524.81,-31531.64 1521.31,-31541.64 1528.31,-31541.64"/>
</g>
<!-- stage1_layer0_experts_group4 -->
<g id="node109" class="node">
<title>stage1_layer0_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-31531.38 1588.5,-31531.38 1588.5,-31448.38 1923.5,-31448.38 1923.5,-31531.38"/>
<text text-anchor="middle" x="1756" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 144&#45;147</text>
<text text-anchor="middle" x="1756" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group4 -->
<g id="edge136" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-31618.21C1756,-31618.21 1756,-31541.48 1756,-31541.48"/>
<polygon fill="black" stroke="black" points="1759.5,-31541.48 1756,-31531.48 1752.5,-31541.48 1759.5,-31541.48"/>
</g>
<!-- stage1_layer0_experts_group5 -->
<g id="node110" class="node">
<title>stage1_layer0_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-31531.38 1981.5,-31531.38 1981.5,-31448.38 2316.5,-31448.38 2316.5,-31531.38"/>
<text text-anchor="middle" x="2149" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 148&#45;151</text>
<text text-anchor="middle" x="2149" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group5 -->
<g id="edge138" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-31655.95C1987.19,-31655.95 1987.19,-31541.64 1987.19,-31541.64"/>
<polygon fill="black" stroke="black" points="1990.69,-31541.64 1987.19,-31531.64 1983.69,-31541.64 1990.69,-31541.64"/>
</g>
<!-- stage1_layer0_experts_group6 -->
<g id="node111" class="node">
<title>stage1_layer0_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-31531.38 2374.5,-31531.38 2374.5,-31448.38 2709.5,-31448.38 2709.5,-31531.38"/>
<text text-anchor="middle" x="2542" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 152&#45;155</text>
<text text-anchor="middle" x="2542" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group6 -->
<g id="edge140" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group6</title>
<path fill="none" stroke="black" d="M1979.04,-31650C2193.77,-31650 2486.17,-31650 2486.17,-31650 2486.17,-31650 2486.17,-31541.53 2486.17,-31541.53"/>
<polygon fill="black" stroke="black" points="2489.67,-31541.53 2486.17,-31531.53 2482.67,-31541.53 2489.67,-31541.53"/>
</g>
<!-- stage1_layer0_experts_group7 -->
<g id="node112" class="node">
<title>stage1_layer0_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-31531.38 2767.5,-31531.38 2767.5,-31448.38 3102.5,-31448.38 3102.5,-31531.38"/>
<text text-anchor="middle" x="2935" y="-31516.18" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-31501.18" font-family="Times,serif" font-size="14.00">GPU 156&#45;159</text>
<text text-anchor="middle" x="2935" y="-31486.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-31471.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-31456.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group7 -->
<g id="edge142" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_experts_group7</title>
<path fill="none" stroke="black" d="M1980.25,-31682C2307.97,-31682 2879.17,-31682 2879.17,-31682 2879.17,-31682 2879.17,-31541.57 2879.17,-31541.57"/>
<polygon fill="black" stroke="black" points="2882.67,-31541.57 2879.17,-31531.57 2875.67,-31541.57 2882.67,-31541.57"/>
</g>
<!-- stage1_layer0_expert_combine -->
<g id="node113" class="node">
<title>stage1_layer0_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-31313.3" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-31332.1" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-31317.1" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-31302.1" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-31287.1" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge127" class="edge">
<title>stage1_layer0_expert_dispatch&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-31639.34C1559.5,-31639.34 1559.5,-31351.99 1559.5,-31351.99"/>
<polygon fill="black" stroke="black" points="1563,-31351.99 1559.5,-31341.99 1556,-31351.99 1563,-31351.99"/>
</g>
<!-- stage1_layer0_experts_group0&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge129" class="edge">
<title>stage1_layer0_experts_group0&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-31448.26C239.83,-31389.42 239.83,-31289 239.83,-31289 239.83,-31289 1535.98,-31289 1535.98,-31289"/>
<polygon fill="black" stroke="black" points="1535.98,-31292.5 1545.98,-31289 1535.98,-31285.5 1535.98,-31292.5"/>
</g>
<!-- stage1_layer0_experts_group1&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge131" class="edge">
<title>stage1_layer0_experts_group1&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-31447.96C632.83,-31395.66 632.83,-31313 632.83,-31313 632.83,-31313 1502.64,-31313 1502.64,-31313"/>
<polygon fill="black" stroke="black" points="1502.64,-31316.5 1512.64,-31313 1502.64,-31309.5 1502.64,-31316.5"/>
</g>
<!-- stage1_layer0_experts_group2&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge133" class="edge">
<title>stage1_layer0_experts_group2&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-31448.1C1025.83,-31402.84 1025.83,-31337 1025.83,-31337 1025.83,-31337 1534.32,-31337 1534.32,-31337"/>
<polygon fill="black" stroke="black" points="1534.32,-31340.5 1544.32,-31337 1534.32,-31333.5 1534.32,-31340.5"/>
</g>
<!-- stage1_layer0_experts_group3&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge135" class="edge">
<title>stage1_layer0_experts_group3&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-31448.03C1521.63,-31448.03 1521.63,-31336.21 1521.63,-31336.21"/>
<polygon fill="black" stroke="black" points="1525.13,-31336.21 1521.63,-31326.21 1518.13,-31336.21 1525.13,-31336.21"/>
</g>
<!-- stage1_layer0_experts_group4&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge137" class="edge">
<title>stage1_layer0_experts_group4&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-31448.03C1756,-31448.03 1756,-31371.4 1756,-31371.4"/>
<polygon fill="black" stroke="black" points="1759.5,-31371.4 1756,-31361.4 1752.5,-31371.4 1759.5,-31371.4"/>
</g>
<!-- stage1_layer0_experts_group5&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge139" class="edge">
<title>stage1_layer0_experts_group5&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-31448.03C1990.37,-31448.03 1990.37,-31336.21 1990.37,-31336.21"/>
<polygon fill="black" stroke="black" points="1993.87,-31336.21 1990.37,-31326.21 1986.87,-31336.21 1993.87,-31336.21"/>
</g>
<!-- stage1_layer0_experts_group6&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge141" class="edge">
<title>stage1_layer0_experts_group6&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-31448.03C2597.83,-31400.36 2597.83,-31329 2597.83,-31329 2597.83,-31329 1996.03,-31329 1996.03,-31329"/>
<polygon fill="black" stroke="black" points="1996.03,-31325.5 1986.03,-31329 1996.03,-31332.5 1996.03,-31325.5"/>
</g>
<!-- stage1_layer0_experts_group7&#45;&gt;stage1_layer0_expert_combine -->
<g id="edge143" class="edge">
<title>stage1_layer0_experts_group7&#45;&gt;stage1_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-31448.03C2990.83,-31391.3 2990.83,-31297 2990.83,-31297 2990.83,-31297 1995.01,-31297 1995.01,-31297"/>
<polygon fill="black" stroke="black" points="1995.01,-31293.5 1985.01,-31297 1995.01,-31300.5 1995.01,-31293.5"/>
</g>
<!-- stage1_layer0_mlp_fc1 -->
<g id="node114" class="node">
<title>stage1_layer0_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-31178.21 1590,-31178.21 1590,-31110.21 1922,-31110.21 1922,-31178.21"/>
<text text-anchor="middle" x="1756" y="-31163.01" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-31148.01" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-31133.01" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-31118.01" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer0_expert_combine&#45;&gt;stage1_layer0_mlp_fc1 -->
<g id="edge151" class="edge">
<title>stage1_layer0_expert_combine&#45;&gt;stage1_layer0_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-31264.84C1756,-31264.84 1756,-31188.45 1756,-31188.45"/>
<polygon fill="black" stroke="black" points="1759.5,-31188.45 1756,-31178.45 1752.5,-31188.45 1759.5,-31188.45"/>
</g>
<!-- stage1_layer0_mlp_gelu -->
<g id="node115" class="node">
<title>stage1_layer0_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-31023.21 1603.5,-31023.21 1603.5,-30955.21 1908.5,-30955.21 1908.5,-31023.21"/>
<text text-anchor="middle" x="1756" y="-31008.01" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-30993.01" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30978.01" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-30963.01" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer0_mlp_fc1&#45;&gt;stage1_layer0_mlp_gelu -->
<g id="edge152" class="edge">
<title>stage1_layer0_mlp_fc1&#45;&gt;stage1_layer0_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-31110.2C1756,-31110.2 1756,-31033.42 1756,-31033.42"/>
<polygon fill="black" stroke="black" points="1759.5,-31033.42 1756,-31023.42 1752.5,-31033.42 1759.5,-31033.42"/>
</g>
<!-- stage1_layer0_mlp_fc2 -->
<g id="node116" class="node">
<title>stage1_layer0_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-30868.21 1588.5,-30868.21 1588.5,-30800.21 1923.5,-30800.21 1923.5,-30868.21"/>
<text text-anchor="middle" x="1756" y="-30853.01" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-30838.01" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30823.01" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-30808.01" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer0_mlp_gelu&#45;&gt;stage1_layer0_mlp_fc2 -->
<g id="edge153" class="edge">
<title>stage1_layer0_mlp_gelu&#45;&gt;stage1_layer0_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-30955.2C1756,-30955.2 1756,-30878.42 1756,-30878.42"/>
<polygon fill="black" stroke="black" points="1759.5,-30878.42 1756,-30868.42 1752.5,-30878.42 1759.5,-30878.42"/>
</g>
<!-- stage1_layer0_mlp_allreduce -->
<g id="node117" class="node">
<title>stage1_layer0_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-30665.13" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-30683.93" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-30668.93" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30653.93" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-30638.93" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_mlp_fc2&#45;&gt;stage1_layer0_mlp_allreduce -->
<g id="edge154" class="edge">
<title>stage1_layer0_mlp_fc2&#45;&gt;stage1_layer0_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-30800C1756,-30800 1756,-30723.39 1756,-30723.39"/>
<polygon fill="black" stroke="black" points="1759.5,-30723.39 1756,-30713.39 1752.5,-30723.39 1759.5,-30723.39"/>
</g>
<!-- stage1_layer0_mlp_end -->
<g id="node118" class="node">
<title>stage1_layer0_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-30530.05 1584,-30530.05 1584,-30462.05 1928,-30462.05 1928,-30530.05"/>
<text text-anchor="middle" x="1756" y="-30514.85" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-30499.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30484.85" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-30469.85" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_mlp_allreduce&#45;&gt;stage1_layer0_mlp_end -->
<g id="edge155" class="edge">
<title>stage1_layer0_mlp_allreduce&#45;&gt;stage1_layer0_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-30616.68C1756,-30616.68 1756,-30540.28 1756,-30540.28"/>
<polygon fill="black" stroke="black" points="1759.5,-30540.28 1756,-30530.28 1752.5,-30540.28 1759.5,-30540.28"/>
</g>
<!-- stage1_layer1_attention_start -->
<g id="node119" class="node">
<title>stage1_layer1_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-30375.05 1584,-30375.05 1584,-30307.05 1928,-30307.05 1928,-30375.05"/>
<text text-anchor="middle" x="1756" y="-30359.85" font-family="Times,serif" font-size="14.00">Attention Start (Layer 1)</text>
<text text-anchor="middle" x="1756" y="-30344.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30329.85" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-30314.85" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer0_mlp_end&#45;&gt;stage1_layer1_attention_start -->
<g id="edge187" class="edge">
<title>stage1_layer0_mlp_end&#45;&gt;stage1_layer1_attention_start</title>
<path fill="none" stroke="black" d="M1756,-30462.03C1756,-30462.03 1756,-30385.25 1756,-30385.25"/>
<polygon fill="black" stroke="black" points="1759.5,-30385.25 1756,-30375.25 1752.5,-30385.25 1759.5,-30385.25"/>
</g>
<!-- stage1_layer1_qkv_proj -->
<g id="node120" class="node">
<title>stage1_layer1_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-30220.05 1569.5,-30220.05 1569.5,-30152.05 1942.5,-30152.05 1942.5,-30220.05"/>
<text text-anchor="middle" x="1756" y="-30204.85" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-30189.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30174.85" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-30159.85" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer1_attention_start&#45;&gt;stage1_layer1_qkv_proj -->
<g id="edge175" class="edge">
<title>stage1_layer1_attention_start&#45;&gt;stage1_layer1_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-30307.03C1756,-30307.03 1756,-30230.25 1756,-30230.25"/>
<polygon fill="black" stroke="black" points="1759.5,-30230.25 1756,-30220.25 1752.5,-30230.25 1759.5,-30230.25"/>
</g>
<!-- stage1_layer1_attention_compute -->
<g id="node121" class="node">
<title>stage1_layer1_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-30065.05 1569.5,-30065.05 1569.5,-29997.05 1942.5,-29997.05 1942.5,-30065.05"/>
<text text-anchor="middle" x="1756" y="-30049.85" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-30034.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-30019.85" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-30004.85" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer1_qkv_proj&#45;&gt;stage1_layer1_attention_compute -->
<g id="edge176" class="edge">
<title>stage1_layer1_qkv_proj&#45;&gt;stage1_layer1_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-30152.03C1756,-30152.03 1756,-30075.25 1756,-30075.25"/>
<polygon fill="black" stroke="black" points="1759.5,-30075.25 1756,-30065.25 1752.5,-30075.25 1759.5,-30075.25"/>
</g>
<!-- stage1_layer1_attention_out -->
<g id="node122" class="node">
<title>stage1_layer1_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-29910.05 1575.5,-29910.05 1575.5,-29842.05 1936.5,-29842.05 1936.5,-29910.05"/>
<text text-anchor="middle" x="1756" y="-29894.85" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-29879.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-29864.85" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-29849.85" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer1_attention_compute&#45;&gt;stage1_layer1_attention_out -->
<g id="edge177" class="edge">
<title>stage1_layer1_attention_compute&#45;&gt;stage1_layer1_attention_out</title>
<path fill="none" stroke="black" d="M1756,-29997.03C1756,-29997.03 1756,-29920.25 1756,-29920.25"/>
<polygon fill="black" stroke="black" points="1759.5,-29920.25 1756,-29910.25 1752.5,-29920.25 1759.5,-29920.25"/>
</g>
<!-- stage1_layer1_attention_allreduce -->
<g id="node123" class="node">
<title>stage1_layer1_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-29706.96" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-29725.76" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-29710.76" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-29695.76" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-29680.76" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_attention_out&#45;&gt;stage1_layer1_attention_allreduce -->
<g id="edge178" class="edge">
<title>stage1_layer1_attention_out&#45;&gt;stage1_layer1_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-29841.83C1756,-29841.83 1756,-29765.23 1756,-29765.23"/>
<polygon fill="black" stroke="black" points="1759.5,-29765.23 1756,-29755.23 1752.5,-29765.23 1759.5,-29765.23"/>
</g>
<!-- stage1_layer1_attention_residual -->
<g id="node124" class="node">
<title>stage1_layer1_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-29571.88 1584,-29571.88 1584,-29503.88 1928,-29503.88 1928,-29571.88"/>
<text text-anchor="middle" x="1756" y="-29556.68" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-29541.68" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-29526.68" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-29511.68" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_attention_allreduce&#45;&gt;stage1_layer1_attention_residual -->
<g id="edge179" class="edge">
<title>stage1_layer1_attention_allreduce&#45;&gt;stage1_layer1_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-29658.51C1756,-29658.51 1756,-29582.12 1756,-29582.12"/>
<polygon fill="black" stroke="black" points="1759.5,-29582.12 1756,-29572.12 1752.5,-29582.12 1759.5,-29582.12"/>
</g>
<!-- stage1_layer1_layernorm2 -->
<g id="node125" class="node">
<title>stage1_layer1_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-29416.88 1584,-29416.88 1584,-29348.88 1928,-29348.88 1928,-29416.88"/>
<text text-anchor="middle" x="1756" y="-29401.68" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-29386.68" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-29371.68" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-29356.68" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_attention_residual&#45;&gt;stage1_layer1_layernorm2 -->
<g id="edge180" class="edge">
<title>stage1_layer1_attention_residual&#45;&gt;stage1_layer1_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-29503.86C1756,-29503.86 1756,-29427.08 1756,-29427.08"/>
<polygon fill="black" stroke="black" points="1759.5,-29427.08 1756,-29417.08 1752.5,-29427.08 1759.5,-29427.08"/>
</g>
<!-- stage1_layer1_moe_gate -->
<g id="node126" class="node">
<title>stage1_layer1_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-29261.88 1552.53,-29261.88 1411.6,-29125.88 1959.47,-29125.88 2100.4,-29261.88"/>
<text text-anchor="middle" x="1756" y="-29212.68" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-29197.68" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-29182.68" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-29167.68" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage1_layer1_layernorm2&#45;&gt;stage1_layer1_moe_gate -->
<g id="edge181" class="edge">
<title>stage1_layer1_layernorm2&#45;&gt;stage1_layer1_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-29348.65C1756,-29348.65 1756,-29271.91 1756,-29271.91"/>
<polygon fill="black" stroke="black" points="1759.5,-29271.91 1756,-29261.91 1752.5,-29271.91 1759.5,-29271.91"/>
</g>
<!-- stage1_layer1_expert_dispatch -->
<g id="node127" class="node">
<title>stage1_layer1_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-28990.8" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-29009.6" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-28994.6" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-28979.6" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-28964.6" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_moe_gate&#45;&gt;stage1_layer1_expert_dispatch -->
<g id="edge157" class="edge">
<title>stage1_layer1_moe_gate&#45;&gt;stage1_layer1_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-29125.69C1756,-29125.69 1756,-29048.93 1756,-29048.93"/>
<polygon fill="black" stroke="black" points="1759.5,-29048.93 1756,-29038.93 1752.5,-29048.93 1759.5,-29048.93"/>
</g>
<!-- stage1_layer1_experts_group0 -->
<g id="node128" class="node">
<title>stage1_layer1_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-28855.71 16.5,-28855.71 16.5,-28772.71 351.5,-28772.71 351.5,-28855.71"/>
<text text-anchor="middle" x="184" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;131</text>
<text text-anchor="middle" x="184" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group0 -->
<g id="edge159" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group0</title>
<path fill="none" stroke="black" d="M1548.18,-29014C1109.34,-29014 128.17,-29014 128.17,-29014 128.17,-29014 128.17,-28866.1 128.17,-28866.1"/>
<polygon fill="black" stroke="black" points="131.67,-28866.1 128.17,-28856.1 124.67,-28866.1 131.67,-28866.1"/>
</g>
<!-- stage1_layer1_experts_group1 -->
<g id="node129" class="node">
<title>stage1_layer1_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-28855.71 409.5,-28855.71 409.5,-28772.71 744.5,-28772.71 744.5,-28855.71"/>
<text text-anchor="middle" x="577" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 132&#45;135</text>
<text text-anchor="middle" x="577" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group1 -->
<g id="edge161" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-28990C1160.38,-28990 521.17,-28990 521.17,-28990 521.17,-28990 521.17,-28865.87 521.17,-28865.87"/>
<polygon fill="black" stroke="black" points="524.67,-28865.87 521.17,-28855.87 517.67,-28865.87 524.67,-28865.87"/>
</g>
<!-- stage1_layer1_experts_group2 -->
<g id="node130" class="node">
<title>stage1_layer1_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-28855.71 802.5,-28855.71 802.5,-28772.71 1137.5,-28772.71 1137.5,-28855.71"/>
<text text-anchor="middle" x="970" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 136&#45;139</text>
<text text-anchor="middle" x="970" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group2 -->
<g id="edge163" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group2</title>
<path fill="none" stroke="black" d="M1553.02,-28966C1303.91,-28966 914.17,-28966 914.17,-28966 914.17,-28966 914.17,-28866.09 914.17,-28866.09"/>
<polygon fill="black" stroke="black" points="917.67,-28866.09 914.17,-28856.09 910.67,-28866.09 917.67,-28866.09"/>
</g>
<!-- stage1_layer1_experts_group3 -->
<g id="node131" class="node">
<title>stage1_layer1_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-28855.71 1195.5,-28855.71 1195.5,-28772.71 1530.5,-28772.71 1530.5,-28855.71"/>
<text text-anchor="middle" x="1363" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 140&#45;143</text>
<text text-anchor="middle" x="1363" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group3 -->
<g id="edge165" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-28980.28C1524.81,-28980.28 1524.81,-28865.97 1524.81,-28865.97"/>
<polygon fill="black" stroke="black" points="1528.31,-28865.97 1524.81,-28855.97 1521.31,-28865.97 1528.31,-28865.97"/>
</g>
<!-- stage1_layer1_experts_group4 -->
<g id="node132" class="node">
<title>stage1_layer1_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-28855.71 1588.5,-28855.71 1588.5,-28772.71 1923.5,-28772.71 1923.5,-28855.71"/>
<text text-anchor="middle" x="1756" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 144&#45;147</text>
<text text-anchor="middle" x="1756" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group4 -->
<g id="edge167" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-28942.54C1756,-28942.54 1756,-28865.81 1756,-28865.81"/>
<polygon fill="black" stroke="black" points="1759.5,-28865.81 1756,-28855.81 1752.5,-28865.81 1759.5,-28865.81"/>
</g>
<!-- stage1_layer1_experts_group5 -->
<g id="node133" class="node">
<title>stage1_layer1_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-28855.71 1981.5,-28855.71 1981.5,-28772.71 2316.5,-28772.71 2316.5,-28855.71"/>
<text text-anchor="middle" x="2149" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 148&#45;151</text>
<text text-anchor="middle" x="2149" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group5 -->
<g id="edge169" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-28980.28C1987.19,-28980.28 1987.19,-28865.97 1987.19,-28865.97"/>
<polygon fill="black" stroke="black" points="1990.69,-28865.97 1987.19,-28855.97 1983.69,-28865.97 1990.69,-28865.97"/>
</g>
<!-- stage1_layer1_experts_group6 -->
<g id="node134" class="node">
<title>stage1_layer1_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-28855.71 2374.5,-28855.71 2374.5,-28772.71 2709.5,-28772.71 2709.5,-28855.71"/>
<text text-anchor="middle" x="2542" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 152&#45;155</text>
<text text-anchor="middle" x="2542" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group6 -->
<g id="edge171" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group6</title>
<path fill="none" stroke="black" d="M1978.05,-28974C2192.87,-28974 2486.17,-28974 2486.17,-28974 2486.17,-28974 2486.17,-28865.78 2486.17,-28865.78"/>
<polygon fill="black" stroke="black" points="2489.67,-28865.78 2486.17,-28855.78 2482.67,-28865.78 2489.67,-28865.78"/>
</g>
<!-- stage1_layer1_experts_group7 -->
<g id="node135" class="node">
<title>stage1_layer1_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-28855.71 2767.5,-28855.71 2767.5,-28772.71 3102.5,-28772.71 3102.5,-28855.71"/>
<text text-anchor="middle" x="2935" y="-28840.51" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-28825.51" font-family="Times,serif" font-size="14.00">GPU 156&#45;159</text>
<text text-anchor="middle" x="2935" y="-28810.51" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-28795.51" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-28780.51" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group7 -->
<g id="edge173" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_experts_group7</title>
<path fill="none" stroke="black" d="M1980.93,-29006C2308.75,-29006 2879.17,-29006 2879.17,-29006 2879.17,-29006 2879.17,-28865.83 2879.17,-28865.83"/>
<polygon fill="black" stroke="black" points="2882.67,-28865.83 2879.17,-28855.83 2875.67,-28865.83 2882.67,-28865.83"/>
</g>
<!-- stage1_layer1_expert_combine -->
<g id="node136" class="node">
<title>stage1_layer1_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-28637.63" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-28656.43" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-28641.43" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-28626.43" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-28611.43" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge158" class="edge">
<title>stage1_layer1_expert_dispatch&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-28963.67C1559.5,-28963.67 1559.5,-28676.32 1559.5,-28676.32"/>
<polygon fill="black" stroke="black" points="1563,-28676.32 1559.5,-28666.32 1556,-28676.32 1563,-28676.32"/>
</g>
<!-- stage1_layer1_experts_group0&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge160" class="edge">
<title>stage1_layer1_experts_group0&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-28772.52C239.83,-28713.59 239.83,-28613 239.83,-28613 239.83,-28613 1536.78,-28613 1536.78,-28613"/>
<polygon fill="black" stroke="black" points="1536.78,-28616.5 1546.78,-28613 1536.78,-28609.5 1536.78,-28616.5"/>
</g>
<!-- stage1_layer1_experts_group1&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge162" class="edge">
<title>stage1_layer1_experts_group1&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-28772.67C632.83,-28720.29 632.83,-28637 632.83,-28637 632.83,-28637 1502.64,-28637 1502.64,-28637"/>
<polygon fill="black" stroke="black" points="1502.64,-28640.5 1512.64,-28637 1502.64,-28633.5 1502.64,-28640.5"/>
</g>
<!-- stage1_layer1_experts_group2&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge164" class="edge">
<title>stage1_layer1_experts_group2&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-28772.35C1025.83,-28726.98 1025.83,-28661 1025.83,-28661 1025.83,-28661 1533.33,-28661 1533.33,-28661"/>
<polygon fill="black" stroke="black" points="1533.33,-28664.5 1543.33,-28661 1533.33,-28657.5 1533.33,-28664.5"/>
</g>
<!-- stage1_layer1_experts_group3&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge166" class="edge">
<title>stage1_layer1_experts_group3&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-28772.37C1521.63,-28772.37 1521.63,-28660.55 1521.63,-28660.55"/>
<polygon fill="black" stroke="black" points="1525.13,-28660.55 1521.63,-28650.55 1518.13,-28660.55 1525.13,-28660.55"/>
</g>
<!-- stage1_layer1_experts_group4&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge168" class="edge">
<title>stage1_layer1_experts_group4&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-28772.37C1756,-28772.37 1756,-28695.74 1756,-28695.74"/>
<polygon fill="black" stroke="black" points="1759.5,-28695.74 1756,-28685.74 1752.5,-28695.74 1759.5,-28695.74"/>
</g>
<!-- stage1_layer1_experts_group5&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge170" class="edge">
<title>stage1_layer1_experts_group5&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-28772.37C1990.37,-28772.37 1990.37,-28660.55 1990.37,-28660.55"/>
<polygon fill="black" stroke="black" points="1993.87,-28660.55 1990.37,-28650.55 1986.87,-28660.55 1993.87,-28660.55"/>
</g>
<!-- stage1_layer1_experts_group6&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge172" class="edge">
<title>stage1_layer1_experts_group6&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-28772.7C2597.83,-28724.93 2597.83,-28653 2597.83,-28653 2597.83,-28653 1996.59,-28653 1996.59,-28653"/>
<polygon fill="black" stroke="black" points="1996.59,-28649.5 1986.59,-28653 1996.59,-28656.5 1996.59,-28649.5"/>
</g>
<!-- stage1_layer1_experts_group7&#45;&gt;stage1_layer1_expert_combine -->
<g id="edge174" class="edge">
<title>stage1_layer1_experts_group7&#45;&gt;stage1_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-28772.29C2990.83,-28715.46 2990.83,-28621 2990.83,-28621 2990.83,-28621 1994.29,-28621 1994.29,-28621"/>
<polygon fill="black" stroke="black" points="1994.29,-28617.5 1984.29,-28621 1994.29,-28624.5 1994.29,-28617.5"/>
</g>
<!-- stage1_layer1_mlp_fc1 -->
<g id="node137" class="node">
<title>stage1_layer1_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-28502.55 1590,-28502.55 1590,-28434.55 1922,-28434.55 1922,-28502.55"/>
<text text-anchor="middle" x="1756" y="-28487.35" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-28472.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-28457.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-28442.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer1_expert_combine&#45;&gt;stage1_layer1_mlp_fc1 -->
<g id="edge182" class="edge">
<title>stage1_layer1_expert_combine&#45;&gt;stage1_layer1_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-28589.18C1756,-28589.18 1756,-28512.78 1756,-28512.78"/>
<polygon fill="black" stroke="black" points="1759.5,-28512.78 1756,-28502.78 1752.5,-28512.78 1759.5,-28512.78"/>
</g>
<!-- stage1_layer1_mlp_gelu -->
<g id="node138" class="node">
<title>stage1_layer1_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-28347.55 1603.5,-28347.55 1603.5,-28279.55 1908.5,-28279.55 1908.5,-28347.55"/>
<text text-anchor="middle" x="1756" y="-28332.35" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-28317.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-28302.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-28287.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer1_mlp_fc1&#45;&gt;stage1_layer1_mlp_gelu -->
<g id="edge183" class="edge">
<title>stage1_layer1_mlp_fc1&#45;&gt;stage1_layer1_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-28434.53C1756,-28434.53 1756,-28357.75 1756,-28357.75"/>
<polygon fill="black" stroke="black" points="1759.5,-28357.75 1756,-28347.75 1752.5,-28357.75 1759.5,-28357.75"/>
</g>
<!-- stage1_layer1_mlp_fc2 -->
<g id="node139" class="node">
<title>stage1_layer1_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-28192.55 1588.5,-28192.55 1588.5,-28124.55 1923.5,-28124.55 1923.5,-28192.55"/>
<text text-anchor="middle" x="1756" y="-28177.35" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-28162.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-28147.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-28132.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer1_mlp_gelu&#45;&gt;stage1_layer1_mlp_fc2 -->
<g id="edge184" class="edge">
<title>stage1_layer1_mlp_gelu&#45;&gt;stage1_layer1_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-28279.53C1756,-28279.53 1756,-28202.75 1756,-28202.75"/>
<polygon fill="black" stroke="black" points="1759.5,-28202.75 1756,-28192.75 1752.5,-28202.75 1759.5,-28202.75"/>
</g>
<!-- stage1_layer1_mlp_allreduce -->
<g id="node140" class="node">
<title>stage1_layer1_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-27989.46" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-28008.26" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-27993.26" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27978.26" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-27963.26" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_mlp_fc2&#45;&gt;stage1_layer1_mlp_allreduce -->
<g id="edge185" class="edge">
<title>stage1_layer1_mlp_fc2&#45;&gt;stage1_layer1_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-28124.33C1756,-28124.33 1756,-28047.73 1756,-28047.73"/>
<polygon fill="black" stroke="black" points="1759.5,-28047.73 1756,-28037.73 1752.5,-28047.73 1759.5,-28047.73"/>
</g>
<!-- stage1_layer1_mlp_end -->
<g id="node141" class="node">
<title>stage1_layer1_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-27854.38 1584,-27854.38 1584,-27786.38 1928,-27786.38 1928,-27854.38"/>
<text text-anchor="middle" x="1756" y="-27839.18" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-27824.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27809.18" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-27794.18" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_mlp_allreduce&#45;&gt;stage1_layer1_mlp_end -->
<g id="edge186" class="edge">
<title>stage1_layer1_mlp_allreduce&#45;&gt;stage1_layer1_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-27941.01C1756,-27941.01 1756,-27864.62 1756,-27864.62"/>
<polygon fill="black" stroke="black" points="1759.5,-27864.62 1756,-27854.62 1752.5,-27864.62 1759.5,-27864.62"/>
</g>
<!-- stage1_layer2_attention_start -->
<g id="node142" class="node">
<title>stage1_layer2_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-27699.38 1584,-27699.38 1584,-27631.38 1928,-27631.38 1928,-27699.38"/>
<text text-anchor="middle" x="1756" y="-27684.18" font-family="Times,serif" font-size="14.00">Attention Start (Layer 2)</text>
<text text-anchor="middle" x="1756" y="-27669.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27654.18" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-27639.18" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer1_mlp_end&#45;&gt;stage1_layer2_attention_start -->
<g id="edge218" class="edge">
<title>stage1_layer1_mlp_end&#45;&gt;stage1_layer2_attention_start</title>
<path fill="none" stroke="black" d="M1756,-27786.37C1756,-27786.37 1756,-27709.58 1756,-27709.58"/>
<polygon fill="black" stroke="black" points="1759.5,-27709.58 1756,-27699.58 1752.5,-27709.58 1759.5,-27709.58"/>
</g>
<!-- stage1_layer2_qkv_proj -->
<g id="node143" class="node">
<title>stage1_layer2_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-27544.38 1569.5,-27544.38 1569.5,-27476.38 1942.5,-27476.38 1942.5,-27544.38"/>
<text text-anchor="middle" x="1756" y="-27529.18" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-27514.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27499.18" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-27484.18" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer2_attention_start&#45;&gt;stage1_layer2_qkv_proj -->
<g id="edge206" class="edge">
<title>stage1_layer2_attention_start&#45;&gt;stage1_layer2_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-27631.37C1756,-27631.37 1756,-27554.58 1756,-27554.58"/>
<polygon fill="black" stroke="black" points="1759.5,-27554.58 1756,-27544.58 1752.5,-27554.58 1759.5,-27554.58"/>
</g>
<!-- stage1_layer2_attention_compute -->
<g id="node144" class="node">
<title>stage1_layer2_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-27389.38 1569.5,-27389.38 1569.5,-27321.38 1942.5,-27321.38 1942.5,-27389.38"/>
<text text-anchor="middle" x="1756" y="-27374.18" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-27359.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27344.18" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-27329.18" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer2_qkv_proj&#45;&gt;stage1_layer2_attention_compute -->
<g id="edge207" class="edge">
<title>stage1_layer2_qkv_proj&#45;&gt;stage1_layer2_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-27476.37C1756,-27476.37 1756,-27399.58 1756,-27399.58"/>
<polygon fill="black" stroke="black" points="1759.5,-27399.58 1756,-27389.58 1752.5,-27399.58 1759.5,-27399.58"/>
</g>
<!-- stage1_layer2_attention_out -->
<g id="node145" class="node">
<title>stage1_layer2_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-27234.38 1575.5,-27234.38 1575.5,-27166.38 1936.5,-27166.38 1936.5,-27234.38"/>
<text text-anchor="middle" x="1756" y="-27219.18" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-27204.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27189.18" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-27174.18" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer2_attention_compute&#45;&gt;stage1_layer2_attention_out -->
<g id="edge208" class="edge">
<title>stage1_layer2_attention_compute&#45;&gt;stage1_layer2_attention_out</title>
<path fill="none" stroke="black" d="M1756,-27321.37C1756,-27321.37 1756,-27244.58 1756,-27244.58"/>
<polygon fill="black" stroke="black" points="1759.5,-27244.58 1756,-27234.58 1752.5,-27244.58 1759.5,-27244.58"/>
</g>
<!-- stage1_layer2_attention_allreduce -->
<g id="node146" class="node">
<title>stage1_layer2_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-27031.3" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-27050.1" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-27035.1" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-27020.1" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-27005.1" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_attention_out&#45;&gt;stage1_layer2_attention_allreduce -->
<g id="edge209" class="edge">
<title>stage1_layer2_attention_out&#45;&gt;stage1_layer2_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-27166.16C1756,-27166.16 1756,-27089.56 1756,-27089.56"/>
<polygon fill="black" stroke="black" points="1759.5,-27089.56 1756,-27079.56 1752.5,-27089.56 1759.5,-27089.56"/>
</g>
<!-- stage1_layer2_attention_residual -->
<g id="node147" class="node">
<title>stage1_layer2_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-26896.21 1584,-26896.21 1584,-26828.21 1928,-26828.21 1928,-26896.21"/>
<text text-anchor="middle" x="1756" y="-26881.01" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-26866.01" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-26851.01" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-26836.01" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_attention_allreduce&#45;&gt;stage1_layer2_attention_residual -->
<g id="edge210" class="edge">
<title>stage1_layer2_attention_allreduce&#45;&gt;stage1_layer2_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-26982.85C1756,-26982.85 1756,-26906.45 1756,-26906.45"/>
<polygon fill="black" stroke="black" points="1759.5,-26906.45 1756,-26896.45 1752.5,-26906.45 1759.5,-26906.45"/>
</g>
<!-- stage1_layer2_layernorm2 -->
<g id="node148" class="node">
<title>stage1_layer2_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-26741.21 1584,-26741.21 1584,-26673.21 1928,-26673.21 1928,-26741.21"/>
<text text-anchor="middle" x="1756" y="-26726.01" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-26711.01" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-26696.01" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-26681.01" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_attention_residual&#45;&gt;stage1_layer2_layernorm2 -->
<g id="edge211" class="edge">
<title>stage1_layer2_attention_residual&#45;&gt;stage1_layer2_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-26828.2C1756,-26828.2 1756,-26751.42 1756,-26751.42"/>
<polygon fill="black" stroke="black" points="1759.5,-26751.42 1756,-26741.42 1752.5,-26751.42 1759.5,-26751.42"/>
</g>
<!-- stage1_layer2_moe_gate -->
<g id="node149" class="node">
<title>stage1_layer2_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-26586.21 1552.53,-26586.21 1411.6,-26450.21 1959.47,-26450.21 2100.4,-26586.21"/>
<text text-anchor="middle" x="1756" y="-26537.01" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-26522.01" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-26507.01" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-26492.01" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage1_layer2_layernorm2&#45;&gt;stage1_layer2_moe_gate -->
<g id="edge212" class="edge">
<title>stage1_layer2_layernorm2&#45;&gt;stage1_layer2_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-26672.99C1756,-26672.99 1756,-26596.25 1756,-26596.25"/>
<polygon fill="black" stroke="black" points="1759.5,-26596.25 1756,-26586.25 1752.5,-26596.25 1759.5,-26596.25"/>
</g>
<!-- stage1_layer2_expert_dispatch -->
<g id="node150" class="node">
<title>stage1_layer2_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-26315.13" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-26333.93" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-26318.93" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-26303.93" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-26288.93" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_moe_gate&#45;&gt;stage1_layer2_expert_dispatch -->
<g id="edge188" class="edge">
<title>stage1_layer2_moe_gate&#45;&gt;stage1_layer2_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-26450.03C1756,-26450.03 1756,-26373.26 1756,-26373.26"/>
<polygon fill="black" stroke="black" points="1759.5,-26373.26 1756,-26363.26 1752.5,-26373.26 1759.5,-26373.26"/>
</g>
<!-- stage1_layer2_experts_group0 -->
<g id="node151" class="node">
<title>stage1_layer2_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-26180.05 16.5,-26180.05 16.5,-26097.05 351.5,-26097.05 351.5,-26180.05"/>
<text text-anchor="middle" x="184" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;131</text>
<text text-anchor="middle" x="184" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group0 -->
<g id="edge190" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group0</title>
<path fill="none" stroke="black" d="M1550.25,-26339C1112.42,-26339 128.17,-26339 128.17,-26339 128.17,-26339 128.17,-26190.08 128.17,-26190.08"/>
<polygon fill="black" stroke="black" points="131.67,-26190.08 128.17,-26180.08 124.67,-26190.08 131.67,-26190.08"/>
</g>
<!-- stage1_layer2_experts_group1 -->
<g id="node152" class="node">
<title>stage1_layer2_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-26180.05 409.5,-26180.05 409.5,-26097.05 744.5,-26097.05 744.5,-26180.05"/>
<text text-anchor="middle" x="577" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 132&#45;135</text>
<text text-anchor="middle" x="577" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group1 -->
<g id="edge192" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-26315C1160.38,-26315 521.17,-26315 521.17,-26315 521.17,-26315 521.17,-26190.36 521.17,-26190.36"/>
<polygon fill="black" stroke="black" points="524.67,-26190.36 521.17,-26180.36 517.67,-26190.36 524.67,-26190.36"/>
</g>
<!-- stage1_layer2_experts_group2 -->
<g id="node153" class="node">
<title>stage1_layer2_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-26180.05 802.5,-26180.05 802.5,-26097.05 1137.5,-26097.05 1137.5,-26180.05"/>
<text text-anchor="middle" x="970" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 136&#45;139</text>
<text text-anchor="middle" x="970" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group2 -->
<g id="edge194" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group2</title>
<path fill="none" stroke="black" d="M1550.87,-26291C1301.68,-26291 914.17,-26291 914.17,-26291 914.17,-26291 914.17,-26190.21 914.17,-26190.21"/>
<polygon fill="black" stroke="black" points="917.67,-26190.21 914.17,-26180.21 910.67,-26190.21 917.67,-26190.21"/>
</g>
<!-- stage1_layer2_experts_group3 -->
<g id="node154" class="node">
<title>stage1_layer2_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-26180.05 1195.5,-26180.05 1195.5,-26097.05 1530.5,-26097.05 1530.5,-26180.05"/>
<text text-anchor="middle" x="1363" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 140&#45;143</text>
<text text-anchor="middle" x="1363" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group3 -->
<g id="edge196" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-26304.61C1524.81,-26304.61 1524.81,-26190.3 1524.81,-26190.3"/>
<polygon fill="black" stroke="black" points="1528.31,-26190.3 1524.81,-26180.3 1521.31,-26190.3 1528.31,-26190.3"/>
</g>
<!-- stage1_layer2_experts_group4 -->
<g id="node155" class="node">
<title>stage1_layer2_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-26180.05 1588.5,-26180.05 1588.5,-26097.05 1923.5,-26097.05 1923.5,-26180.05"/>
<text text-anchor="middle" x="1756" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 144&#45;147</text>
<text text-anchor="middle" x="1756" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group4 -->
<g id="edge198" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-26266.88C1756,-26266.88 1756,-26190.14 1756,-26190.14"/>
<polygon fill="black" stroke="black" points="1759.5,-26190.14 1756,-26180.14 1752.5,-26190.14 1759.5,-26190.14"/>
</g>
<!-- stage1_layer2_experts_group5 -->
<g id="node156" class="node">
<title>stage1_layer2_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-26180.05 1981.5,-26180.05 1981.5,-26097.05 2316.5,-26097.05 2316.5,-26180.05"/>
<text text-anchor="middle" x="2149" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 148&#45;151</text>
<text text-anchor="middle" x="2149" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group5 -->
<g id="edge200" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-26304.61C1987.19,-26304.61 1987.19,-26190.3 1987.19,-26190.3"/>
<polygon fill="black" stroke="black" points="1990.69,-26190.3 1987.19,-26180.3 1983.69,-26190.3 1990.69,-26190.3"/>
</g>
<!-- stage1_layer2_experts_group6 -->
<g id="node157" class="node">
<title>stage1_layer2_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-26180.05 2374.5,-26180.05 2374.5,-26097.05 2709.5,-26097.05 2709.5,-26180.05"/>
<text text-anchor="middle" x="2542" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 152&#45;155</text>
<text text-anchor="middle" x="2542" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group6 -->
<g id="edge202" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group6</title>
<path fill="none" stroke="black" d="M1979.54,-26299C2194.22,-26299 2486.17,-26299 2486.17,-26299 2486.17,-26299 2486.17,-26190.29 2486.17,-26190.29"/>
<polygon fill="black" stroke="black" points="2489.67,-26190.29 2486.17,-26180.29 2482.67,-26190.29 2489.67,-26190.29"/>
</g>
<!-- stage1_layer2_experts_group7 -->
<g id="node158" class="node">
<title>stage1_layer2_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-26180.05 2767.5,-26180.05 2767.5,-26097.05 3102.5,-26097.05 3102.5,-26180.05"/>
<text text-anchor="middle" x="2935" y="-26164.85" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-26149.85" font-family="Times,serif" font-size="14.00">GPU 156&#45;159</text>
<text text-anchor="middle" x="2935" y="-26134.85" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-26119.85" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-26104.85" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group7 -->
<g id="edge204" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_experts_group7</title>
<path fill="none" stroke="black" d="M1979.92,-26331C2307.58,-26331 2879.17,-26331 2879.17,-26331 2879.17,-26331 2879.17,-26190.31 2879.17,-26190.31"/>
<polygon fill="black" stroke="black" points="2882.67,-26190.31 2879.17,-26180.31 2875.67,-26190.31 2882.67,-26190.31"/>
</g>
<!-- stage1_layer2_expert_combine -->
<g id="node159" class="node">
<title>stage1_layer2_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-25961.96" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-25980.76" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-25965.76" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-25950.76" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-25935.76" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge189" class="edge">
<title>stage1_layer2_expert_dispatch&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-26288.01C1559.5,-26288.01 1559.5,-26000.66 1559.5,-26000.66"/>
<polygon fill="black" stroke="black" points="1563,-26000.66 1559.5,-25990.66 1556,-26000.66 1563,-26000.66"/>
</g>
<!-- stage1_layer2_experts_group0&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge191" class="edge">
<title>stage1_layer2_experts_group0&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-26096.79C239.83,-26037.75 239.83,-25937 239.83,-25937 239.83,-25937 1537.97,-25937 1537.97,-25937"/>
<polygon fill="black" stroke="black" points="1537.97,-25940.5 1547.97,-25937 1537.97,-25933.5 1537.97,-25940.5"/>
</g>
<!-- stage1_layer2_experts_group1&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge193" class="edge">
<title>stage1_layer2_experts_group1&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-26096.92C632.83,-26044.44 632.83,-25961 632.83,-25961 632.83,-25961 1502.64,-25961 1502.64,-25961"/>
<polygon fill="black" stroke="black" points="1502.64,-25964.5 1512.64,-25961 1502.64,-25957.5 1502.64,-25964.5"/>
</g>
<!-- stage1_layer2_experts_group2&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge195" class="edge">
<title>stage1_layer2_experts_group2&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-26096.86C1025.83,-26051.7 1025.83,-25986 1025.83,-25986 1025.83,-25986 1535.3,-25986 1535.3,-25986"/>
<polygon fill="black" stroke="black" points="1535.3,-25989.5 1545.3,-25986 1535.3,-25982.5 1535.3,-25989.5"/>
</g>
<!-- stage1_layer2_experts_group3&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge197" class="edge">
<title>stage1_layer2_experts_group3&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-26096.7C1521.63,-26096.7 1521.63,-25984.88 1521.63,-25984.88"/>
<polygon fill="black" stroke="black" points="1525.13,-25984.88 1521.63,-25974.88 1518.13,-25984.88 1525.13,-25984.88"/>
</g>
<!-- stage1_layer2_experts_group4&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge199" class="edge">
<title>stage1_layer2_experts_group4&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-26096.7C1756,-26096.7 1756,-26020.07 1756,-26020.07"/>
<polygon fill="black" stroke="black" points="1759.5,-26020.07 1756,-26010.07 1752.5,-26020.07 1759.5,-26020.07"/>
</g>
<!-- stage1_layer2_experts_group5&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge201" class="edge">
<title>stage1_layer2_experts_group5&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-26096.7C1990.37,-26096.7 1990.37,-25984.88 1990.37,-25984.88"/>
<polygon fill="black" stroke="black" points="1993.87,-25984.88 1990.37,-25974.88 1986.87,-25984.88 1993.87,-25984.88"/>
</g>
<!-- stage1_layer2_experts_group6&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge203" class="edge">
<title>stage1_layer2_experts_group6&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-26096.95C2597.83,-26049.08 2597.83,-25977 2597.83,-25977 2597.83,-25977 1997.15,-25977 1997.15,-25977"/>
<polygon fill="black" stroke="black" points="1997.15,-25973.5 1987.15,-25977 1997.15,-25980.5 1997.15,-25973.5"/>
</g>
<!-- stage1_layer2_experts_group7&#45;&gt;stage1_layer2_expert_combine -->
<g id="edge205" class="edge">
<title>stage1_layer2_experts_group7&#45;&gt;stage1_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-26097.03C2990.83,-26040.16 2990.83,-25945 2990.83,-25945 2990.83,-25945 1993.93,-25945 1993.93,-25945"/>
<polygon fill="black" stroke="black" points="1993.93,-25941.5 1983.93,-25945 1993.93,-25948.5 1993.93,-25941.5"/>
</g>
<!-- stage1_layer2_mlp_fc1 -->
<g id="node160" class="node">
<title>stage1_layer2_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-25826.88 1590,-25826.88 1590,-25758.88 1922,-25758.88 1922,-25826.88"/>
<text text-anchor="middle" x="1756" y="-25811.68" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-25796.68" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-25781.68" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-25766.68" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer2_expert_combine&#45;&gt;stage1_layer2_mlp_fc1 -->
<g id="edge213" class="edge">
<title>stage1_layer2_expert_combine&#45;&gt;stage1_layer2_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-25913.51C1756,-25913.51 1756,-25837.12 1756,-25837.12"/>
<polygon fill="black" stroke="black" points="1759.5,-25837.12 1756,-25827.12 1752.5,-25837.12 1759.5,-25837.12"/>
</g>
<!-- stage1_layer2_mlp_gelu -->
<g id="node161" class="node">
<title>stage1_layer2_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-25671.88 1603.5,-25671.88 1603.5,-25603.88 1908.5,-25603.88 1908.5,-25671.88"/>
<text text-anchor="middle" x="1756" y="-25656.68" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-25641.68" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-25626.68" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-25611.68" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer2_mlp_fc1&#45;&gt;stage1_layer2_mlp_gelu -->
<g id="edge214" class="edge">
<title>stage1_layer2_mlp_fc1&#45;&gt;stage1_layer2_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-25758.87C1756,-25758.87 1756,-25682.08 1756,-25682.08"/>
<polygon fill="black" stroke="black" points="1759.5,-25682.08 1756,-25672.08 1752.5,-25682.08 1759.5,-25682.08"/>
</g>
<!-- stage1_layer2_mlp_fc2 -->
<g id="node162" class="node">
<title>stage1_layer2_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-25516.88 1588.5,-25516.88 1588.5,-25448.88 1923.5,-25448.88 1923.5,-25516.88"/>
<text text-anchor="middle" x="1756" y="-25501.68" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-25486.68" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-25471.68" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-25456.68" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer2_mlp_gelu&#45;&gt;stage1_layer2_mlp_fc2 -->
<g id="edge215" class="edge">
<title>stage1_layer2_mlp_gelu&#45;&gt;stage1_layer2_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-25603.87C1756,-25603.87 1756,-25527.08 1756,-25527.08"/>
<polygon fill="black" stroke="black" points="1759.5,-25527.08 1756,-25517.08 1752.5,-25527.08 1759.5,-25527.08"/>
</g>
<!-- stage1_layer2_mlp_allreduce -->
<g id="node163" class="node">
<title>stage1_layer2_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-25313.8" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-25332.6" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-25317.6" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-25302.6" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-25287.6" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_mlp_fc2&#45;&gt;stage1_layer2_mlp_allreduce -->
<g id="edge216" class="edge">
<title>stage1_layer2_mlp_fc2&#45;&gt;stage1_layer2_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-25448.66C1756,-25448.66 1756,-25372.06 1756,-25372.06"/>
<polygon fill="black" stroke="black" points="1759.5,-25372.06 1756,-25362.06 1752.5,-25372.06 1759.5,-25372.06"/>
</g>
<!-- stage1_layer2_mlp_end -->
<g id="node164" class="node">
<title>stage1_layer2_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-25178.71 1584,-25178.71 1584,-25110.71 1928,-25110.71 1928,-25178.71"/>
<text text-anchor="middle" x="1756" y="-25163.51" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-25148.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-25133.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-25118.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_mlp_allreduce&#45;&gt;stage1_layer2_mlp_end -->
<g id="edge217" class="edge">
<title>stage1_layer2_mlp_allreduce&#45;&gt;stage1_layer2_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-25265.35C1756,-25265.35 1756,-25188.95 1756,-25188.95"/>
<polygon fill="black" stroke="black" points="1759.5,-25188.95 1756,-25178.95 1752.5,-25188.95 1759.5,-25188.95"/>
</g>
<!-- stage1_layer3_attention_start -->
<g id="node165" class="node">
<title>stage1_layer3_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-25023.71 1584,-25023.71 1584,-24955.71 1928,-24955.71 1928,-25023.71"/>
<text text-anchor="middle" x="1756" y="-25008.51" font-family="Times,serif" font-size="14.00">Attention Start (Layer 3)</text>
<text text-anchor="middle" x="1756" y="-24993.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24978.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-24963.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer2_mlp_end&#45;&gt;stage1_layer3_attention_start -->
<g id="edge249" class="edge">
<title>stage1_layer2_mlp_end&#45;&gt;stage1_layer3_attention_start</title>
<path fill="none" stroke="black" d="M1756,-25110.7C1756,-25110.7 1756,-25033.92 1756,-25033.92"/>
<polygon fill="black" stroke="black" points="1759.5,-25033.92 1756,-25023.92 1752.5,-25033.92 1759.5,-25033.92"/>
</g>
<!-- stage1_layer3_qkv_proj -->
<g id="node166" class="node">
<title>stage1_layer3_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-24868.71 1569.5,-24868.71 1569.5,-24800.71 1942.5,-24800.71 1942.5,-24868.71"/>
<text text-anchor="middle" x="1756" y="-24853.51" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-24838.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24823.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-24808.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer3_attention_start&#45;&gt;stage1_layer3_qkv_proj -->
<g id="edge237" class="edge">
<title>stage1_layer3_attention_start&#45;&gt;stage1_layer3_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-24955.7C1756,-24955.7 1756,-24878.92 1756,-24878.92"/>
<polygon fill="black" stroke="black" points="1759.5,-24878.92 1756,-24868.92 1752.5,-24878.92 1759.5,-24878.92"/>
</g>
<!-- stage1_layer3_attention_compute -->
<g id="node167" class="node">
<title>stage1_layer3_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-24713.71 1569.5,-24713.71 1569.5,-24645.71 1942.5,-24645.71 1942.5,-24713.71"/>
<text text-anchor="middle" x="1756" y="-24698.51" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-24683.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24668.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-24653.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage1_layer3_qkv_proj&#45;&gt;stage1_layer3_attention_compute -->
<g id="edge238" class="edge">
<title>stage1_layer3_qkv_proj&#45;&gt;stage1_layer3_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-24800.7C1756,-24800.7 1756,-24723.92 1756,-24723.92"/>
<polygon fill="black" stroke="black" points="1759.5,-24723.92 1756,-24713.92 1752.5,-24723.92 1759.5,-24723.92"/>
</g>
<!-- stage1_layer3_attention_out -->
<g id="node168" class="node">
<title>stage1_layer3_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-24558.71 1575.5,-24558.71 1575.5,-24490.71 1936.5,-24490.71 1936.5,-24558.71"/>
<text text-anchor="middle" x="1756" y="-24543.51" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-24528.51" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24513.51" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-24498.51" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer3_attention_compute&#45;&gt;stage1_layer3_attention_out -->
<g id="edge239" class="edge">
<title>stage1_layer3_attention_compute&#45;&gt;stage1_layer3_attention_out</title>
<path fill="none" stroke="black" d="M1756,-24645.7C1756,-24645.7 1756,-24568.92 1756,-24568.92"/>
<polygon fill="black" stroke="black" points="1759.5,-24568.92 1756,-24558.92 1752.5,-24568.92 1759.5,-24568.92"/>
</g>
<!-- stage1_layer3_attention_allreduce -->
<g id="node169" class="node">
<title>stage1_layer3_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-24355.63" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-24374.43" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-24359.43" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24344.43" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-24329.43" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_attention_out&#45;&gt;stage1_layer3_attention_allreduce -->
<g id="edge240" class="edge">
<title>stage1_layer3_attention_out&#45;&gt;stage1_layer3_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-24490.5C1756,-24490.5 1756,-24413.89 1756,-24413.89"/>
<polygon fill="black" stroke="black" points="1759.5,-24413.89 1756,-24403.89 1752.5,-24413.89 1759.5,-24413.89"/>
</g>
<!-- stage1_layer3_attention_residual -->
<g id="node170" class="node">
<title>stage1_layer3_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-24220.55 1584,-24220.55 1584,-24152.55 1928,-24152.55 1928,-24220.55"/>
<text text-anchor="middle" x="1756" y="-24205.35" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-24190.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24175.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-24160.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_attention_allreduce&#45;&gt;stage1_layer3_attention_residual -->
<g id="edge241" class="edge">
<title>stage1_layer3_attention_allreduce&#45;&gt;stage1_layer3_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-24307.18C1756,-24307.18 1756,-24230.78 1756,-24230.78"/>
<polygon fill="black" stroke="black" points="1759.5,-24230.78 1756,-24220.78 1752.5,-24230.78 1759.5,-24230.78"/>
</g>
<!-- stage1_layer3_layernorm2 -->
<g id="node171" class="node">
<title>stage1_layer3_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-24065.55 1584,-24065.55 1584,-23997.55 1928,-23997.55 1928,-24065.55"/>
<text text-anchor="middle" x="1756" y="-24050.35" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-24035.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-24020.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-24005.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_attention_residual&#45;&gt;stage1_layer3_layernorm2 -->
<g id="edge242" class="edge">
<title>stage1_layer3_attention_residual&#45;&gt;stage1_layer3_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-24152.53C1756,-24152.53 1756,-24075.75 1756,-24075.75"/>
<polygon fill="black" stroke="black" points="1759.5,-24075.75 1756,-24065.75 1752.5,-24075.75 1759.5,-24075.75"/>
</g>
<!-- stage1_layer3_moe_gate -->
<g id="node172" class="node">
<title>stage1_layer3_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-23910.55 1552.53,-23910.55 1411.6,-23774.55 1959.47,-23774.55 2100.4,-23910.55"/>
<text text-anchor="middle" x="1756" y="-23861.35" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-23846.35" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-23831.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-23816.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage1_layer3_layernorm2&#45;&gt;stage1_layer3_moe_gate -->
<g id="edge243" class="edge">
<title>stage1_layer3_layernorm2&#45;&gt;stage1_layer3_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-23997.32C1756,-23997.32 1756,-23920.58 1756,-23920.58"/>
<polygon fill="black" stroke="black" points="1759.5,-23920.58 1756,-23910.58 1752.5,-23920.58 1759.5,-23920.58"/>
</g>
<!-- stage1_layer3_expert_dispatch -->
<g id="node173" class="node">
<title>stage1_layer3_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-23639.46" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-23658.26" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-23643.26" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-23628.26" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-23613.26" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_moe_gate&#45;&gt;stage1_layer3_expert_dispatch -->
<g id="edge219" class="edge">
<title>stage1_layer3_moe_gate&#45;&gt;stage1_layer3_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-23774.36C1756,-23774.36 1756,-23697.59 1756,-23697.59"/>
<polygon fill="black" stroke="black" points="1759.5,-23697.59 1756,-23687.59 1752.5,-23697.59 1759.5,-23697.59"/>
</g>
<!-- stage1_layer3_experts_group0 -->
<g id="node174" class="node">
<title>stage1_layer3_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-23504.38 16.5,-23504.38 16.5,-23421.38 351.5,-23421.38 351.5,-23504.38"/>
<text text-anchor="middle" x="184" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 128&#45;131</text>
<text text-anchor="middle" x="184" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group0 -->
<g id="edge221" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group0</title>
<path fill="none" stroke="black" d="M1549.42,-23663C1111.19,-23663 128.17,-23663 128.17,-23663 128.17,-23663 128.17,-23514.83 128.17,-23514.83"/>
<polygon fill="black" stroke="black" points="131.67,-23514.83 128.17,-23504.83 124.67,-23514.83 131.67,-23514.83"/>
</g>
<!-- stage1_layer3_experts_group1 -->
<g id="node175" class="node">
<title>stage1_layer3_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-23504.38 409.5,-23504.38 409.5,-23421.38 744.5,-23421.38 744.5,-23504.38"/>
<text text-anchor="middle" x="577" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 132&#45;135</text>
<text text-anchor="middle" x="577" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group1 -->
<g id="edge223" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-23639C1160.38,-23639 521.17,-23639 521.17,-23639 521.17,-23639 521.17,-23514.62 521.17,-23514.62"/>
<polygon fill="black" stroke="black" points="524.67,-23514.62 521.17,-23504.62 517.67,-23514.62 524.67,-23514.62"/>
</g>
<!-- stage1_layer3_experts_group2 -->
<g id="node176" class="node">
<title>stage1_layer3_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-23504.38 802.5,-23504.38 802.5,-23421.38 1137.5,-23421.38 1137.5,-23504.38"/>
<text text-anchor="middle" x="970" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 136&#45;139</text>
<text text-anchor="middle" x="970" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group2 -->
<g id="edge225" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group2</title>
<path fill="none" stroke="black" d="M1551.95,-23615C1302.79,-23615 914.17,-23615 914.17,-23615 914.17,-23615 914.17,-23514.45 914.17,-23514.45"/>
<polygon fill="black" stroke="black" points="917.67,-23514.45 914.17,-23504.45 910.67,-23514.45 917.67,-23514.45"/>
</g>
<!-- stage1_layer3_experts_group3 -->
<g id="node177" class="node">
<title>stage1_layer3_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-23504.38 1195.5,-23504.38 1195.5,-23421.38 1530.5,-23421.38 1530.5,-23504.38"/>
<text text-anchor="middle" x="1363" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 140&#45;143</text>
<text text-anchor="middle" x="1363" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group3 -->
<g id="edge227" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-23628.95C1524.81,-23628.95 1524.81,-23514.64 1524.81,-23514.64"/>
<polygon fill="black" stroke="black" points="1528.31,-23514.64 1524.81,-23504.64 1521.31,-23514.64 1528.31,-23514.64"/>
</g>
<!-- stage1_layer3_experts_group4 -->
<g id="node178" class="node">
<title>stage1_layer3_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-23504.38 1588.5,-23504.38 1588.5,-23421.38 1923.5,-23421.38 1923.5,-23504.38"/>
<text text-anchor="middle" x="1756" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 144&#45;147</text>
<text text-anchor="middle" x="1756" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group4 -->
<g id="edge229" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-23591.21C1756,-23591.21 1756,-23514.48 1756,-23514.48"/>
<polygon fill="black" stroke="black" points="1759.5,-23514.48 1756,-23504.48 1752.5,-23514.48 1759.5,-23514.48"/>
</g>
<!-- stage1_layer3_experts_group5 -->
<g id="node179" class="node">
<title>stage1_layer3_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-23504.38 1981.5,-23504.38 1981.5,-23421.38 2316.5,-23421.38 2316.5,-23504.38"/>
<text text-anchor="middle" x="2149" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 148&#45;151</text>
<text text-anchor="middle" x="2149" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group5 -->
<g id="edge231" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-23628.95C1987.19,-23628.95 1987.19,-23514.64 1987.19,-23514.64"/>
<polygon fill="black" stroke="black" points="1990.69,-23514.64 1987.19,-23504.64 1983.69,-23514.64 1990.69,-23514.64"/>
</g>
<!-- stage1_layer3_experts_group6 -->
<g id="node180" class="node">
<title>stage1_layer3_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-23504.38 2374.5,-23504.38 2374.5,-23421.38 2709.5,-23421.38 2709.5,-23504.38"/>
<text text-anchor="middle" x="2542" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 152&#45;155</text>
<text text-anchor="middle" x="2542" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group6 -->
<g id="edge233" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group6</title>
<path fill="none" stroke="black" d="M1979.04,-23623C2193.77,-23623 2486.17,-23623 2486.17,-23623 2486.17,-23623 2486.17,-23514.53 2486.17,-23514.53"/>
<polygon fill="black" stroke="black" points="2489.67,-23514.53 2486.17,-23504.53 2482.67,-23514.53 2489.67,-23514.53"/>
</g>
<!-- stage1_layer3_experts_group7 -->
<g id="node181" class="node">
<title>stage1_layer3_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-23504.38 2767.5,-23504.38 2767.5,-23421.38 3102.5,-23421.38 3102.5,-23504.38"/>
<text text-anchor="middle" x="2935" y="-23489.18" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-23474.18" font-family="Times,serif" font-size="14.00">GPU 156&#45;159</text>
<text text-anchor="middle" x="2935" y="-23459.18" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-23444.18" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-23429.18" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group7 -->
<g id="edge235" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_experts_group7</title>
<path fill="none" stroke="black" d="M1980.25,-23655C2307.97,-23655 2879.17,-23655 2879.17,-23655 2879.17,-23655 2879.17,-23514.57 2879.17,-23514.57"/>
<polygon fill="black" stroke="black" points="2882.67,-23514.57 2879.17,-23504.57 2875.67,-23514.57 2882.67,-23514.57"/>
</g>
<!-- stage1_layer3_expert_combine -->
<g id="node182" class="node">
<title>stage1_layer3_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-23286.3" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-23305.1" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-23290.1" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-23275.1" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-23260.1" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge220" class="edge">
<title>stage1_layer3_expert_dispatch&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-23612.34C1559.5,-23612.34 1559.5,-23324.99 1559.5,-23324.99"/>
<polygon fill="black" stroke="black" points="1563,-23324.99 1559.5,-23314.99 1556,-23324.99 1563,-23324.99"/>
</g>
<!-- stage1_layer3_experts_group0&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge222" class="edge">
<title>stage1_layer3_experts_group0&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-23421.26C239.83,-23362.42 239.83,-23262 239.83,-23262 239.83,-23262 1535.98,-23262 1535.98,-23262"/>
<polygon fill="black" stroke="black" points="1535.98,-23265.5 1545.98,-23262 1535.98,-23258.5 1535.98,-23265.5"/>
</g>
<!-- stage1_layer3_experts_group1&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge224" class="edge">
<title>stage1_layer3_experts_group1&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-23420.96C632.83,-23368.66 632.83,-23286 632.83,-23286 632.83,-23286 1502.64,-23286 1502.64,-23286"/>
<polygon fill="black" stroke="black" points="1502.64,-23289.5 1512.64,-23286 1502.64,-23282.5 1502.64,-23289.5"/>
</g>
<!-- stage1_layer3_experts_group2&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge226" class="edge">
<title>stage1_layer3_experts_group2&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-23421.11C1025.83,-23375.84 1025.83,-23310 1025.83,-23310 1025.83,-23310 1534.32,-23310 1534.32,-23310"/>
<polygon fill="black" stroke="black" points="1534.32,-23313.5 1544.32,-23310 1534.32,-23306.5 1534.32,-23313.5"/>
</g>
<!-- stage1_layer3_experts_group3&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge228" class="edge">
<title>stage1_layer3_experts_group3&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-23421.03C1521.63,-23421.03 1521.63,-23309.22 1521.63,-23309.22"/>
<polygon fill="black" stroke="black" points="1525.13,-23309.22 1521.63,-23299.22 1518.13,-23309.22 1525.13,-23309.22"/>
</g>
<!-- stage1_layer3_experts_group4&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge230" class="edge">
<title>stage1_layer3_experts_group4&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-23421.03C1756,-23421.03 1756,-23344.4 1756,-23344.4"/>
<polygon fill="black" stroke="black" points="1759.5,-23344.4 1756,-23334.4 1752.5,-23344.4 1759.5,-23344.4"/>
</g>
<!-- stage1_layer3_experts_group5&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge232" class="edge">
<title>stage1_layer3_experts_group5&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-23421.03C1990.37,-23421.03 1990.37,-23309.22 1990.37,-23309.22"/>
<polygon fill="black" stroke="black" points="1993.87,-23309.22 1990.37,-23299.22 1986.87,-23309.22 1993.87,-23309.22"/>
</g>
<!-- stage1_layer3_experts_group6&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge234" class="edge">
<title>stage1_layer3_experts_group6&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-23421.03C2597.83,-23373.36 2597.83,-23302 2597.83,-23302 2597.83,-23302 1996.03,-23302 1996.03,-23302"/>
<polygon fill="black" stroke="black" points="1996.03,-23298.5 1986.03,-23302 1996.03,-23305.5 1996.03,-23298.5"/>
</g>
<!-- stage1_layer3_experts_group7&#45;&gt;stage1_layer3_expert_combine -->
<g id="edge236" class="edge">
<title>stage1_layer3_experts_group7&#45;&gt;stage1_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-23421.03C2990.83,-23364.3 2990.83,-23270 2990.83,-23270 2990.83,-23270 1995.01,-23270 1995.01,-23270"/>
<polygon fill="black" stroke="black" points="1995.01,-23266.5 1985.01,-23270 1995.01,-23273.5 1995.01,-23266.5"/>
</g>
<!-- stage1_layer3_mlp_fc1 -->
<g id="node183" class="node">
<title>stage1_layer3_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-23151.22 1590,-23151.22 1590,-23083.22 1922,-23083.22 1922,-23151.22"/>
<text text-anchor="middle" x="1756" y="-23136.02" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-23121.02" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-23106.02" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-23091.02" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer3_expert_combine&#45;&gt;stage1_layer3_mlp_fc1 -->
<g id="edge244" class="edge">
<title>stage1_layer3_expert_combine&#45;&gt;stage1_layer3_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-23237.85C1756,-23237.85 1756,-23161.45 1756,-23161.45"/>
<polygon fill="black" stroke="black" points="1759.5,-23161.45 1756,-23151.45 1752.5,-23161.45 1759.5,-23161.45"/>
</g>
<!-- stage1_layer3_mlp_gelu -->
<g id="node184" class="node">
<title>stage1_layer3_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-22996.22 1603.5,-22996.22 1603.5,-22928.22 1908.5,-22928.22 1908.5,-22996.22"/>
<text text-anchor="middle" x="1756" y="-22981.02" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-22966.02" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-22951.02" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-22936.02" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage1_layer3_mlp_fc1&#45;&gt;stage1_layer3_mlp_gelu -->
<g id="edge245" class="edge">
<title>stage1_layer3_mlp_fc1&#45;&gt;stage1_layer3_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-23083.2C1756,-23083.2 1756,-23006.42 1756,-23006.42"/>
<polygon fill="black" stroke="black" points="1759.5,-23006.42 1756,-22996.42 1752.5,-23006.42 1759.5,-23006.42"/>
</g>
<!-- stage1_layer3_mlp_fc2 -->
<g id="node185" class="node">
<title>stage1_layer3_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-22841.22 1588.5,-22841.22 1588.5,-22773.22 1923.5,-22773.22 1923.5,-22841.22"/>
<text text-anchor="middle" x="1756" y="-22826.02" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-22811.02" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-22796.02" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-22781.02" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage1_layer3_mlp_gelu&#45;&gt;stage1_layer3_mlp_fc2 -->
<g id="edge246" class="edge">
<title>stage1_layer3_mlp_gelu&#45;&gt;stage1_layer3_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-22928.2C1756,-22928.2 1756,-22851.42 1756,-22851.42"/>
<polygon fill="black" stroke="black" points="1759.5,-22851.42 1756,-22841.42 1752.5,-22851.42 1759.5,-22851.42"/>
</g>
<!-- stage1_layer3_mlp_allreduce -->
<g id="node186" class="node">
<title>stage1_layer3_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-22638.13" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-22656.93" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-22641.93" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-22626.93" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-22611.93" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_mlp_fc2&#45;&gt;stage1_layer3_mlp_allreduce -->
<g id="edge247" class="edge">
<title>stage1_layer3_mlp_fc2&#45;&gt;stage1_layer3_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-22773C1756,-22773 1756,-22696.39 1756,-22696.39"/>
<polygon fill="black" stroke="black" points="1759.5,-22696.39 1756,-22686.39 1752.5,-22696.39 1759.5,-22696.39"/>
</g>
<!-- stage1_layer3_mlp_end -->
<g id="node187" class="node">
<title>stage1_layer3_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-22503.05 1584,-22503.05 1584,-22435.05 1928,-22435.05 1928,-22503.05"/>
<text text-anchor="middle" x="1756" y="-22487.85" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-22472.85" font-family="Times,serif" font-size="14.00">GPU 128&#45;159</text>
<text text-anchor="middle" x="1756" y="-22457.85" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-22442.85" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_mlp_allreduce&#45;&gt;stage1_layer3_mlp_end -->
<g id="edge248" class="edge">
<title>stage1_layer3_mlp_allreduce&#45;&gt;stage1_layer3_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-22589.68C1756,-22589.68 1756,-22513.28 1756,-22513.28"/>
<polygon fill="black" stroke="black" points="1759.5,-22513.28 1756,-22503.28 1752.5,-22513.28 1759.5,-22513.28"/>
</g>
<!-- stage1_output -->
<g id="node188" class="node">
<title>stage1_output</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-22310.57" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-22321.87" font-family="Times,serif" font-size="14.00">Stage Output</text>
<text text-anchor="middle" x="1756" y="-22306.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-22291.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_layer3_mlp_end&#45;&gt;stage1_output -->
<g id="edge250" class="edge">
<title>stage1_layer3_mlp_end&#45;&gt;stage1_output</title>
<path fill="none" stroke="black" d="M1756,-22434.66C1756,-22434.66 1756,-22358.22 1756,-22358.22"/>
<polygon fill="black" stroke="black" points="1759.5,-22358.22 1756,-22348.22 1752.5,-22358.22 1759.5,-22358.22"/>
</g>
<!-- stage2_input -->
<g id="node189" class="node">
<title>stage2_input</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-22119.62" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-22130.92" font-family="Times,serif" font-size="14.00">Input</text>
<text text-anchor="middle" x="1756" y="-22115.92" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-22100.92" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage1_output&#45;&gt;stage2_input -->
<g id="edge502" class="edge">
<title>stage1_output&#45;&gt;stage2_input</title>
<path fill="none" stroke="black" d="M1756,-22272.85C1756,-22272.85 1756,-22167.27 1756,-22167.27"/>
<polygon fill="black" stroke="black" points="1759.5,-22167.27 1756,-22157.27 1752.5,-22167.27 1759.5,-22167.27"/>
<text text-anchor="middle" x="1890" y="-22218.9" font-family="Times,serif" font-size="14.00">Pipeline Communication</text>
<text text-anchor="middle" x="1890" y="-22203.9" font-family="Times,serif" font-size="14.00">[batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_attention_start -->
<g id="node190" class="node">
<title>stage2_layer0_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-21995.14 1584,-21995.14 1584,-21927.14 1928,-21927.14 1928,-21995.14"/>
<text text-anchor="middle" x="1756" y="-21979.94" font-family="Times,serif" font-size="14.00">Attention Start (Layer 0)</text>
<text text-anchor="middle" x="1756" y="-21964.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-21949.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-21934.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_input&#45;&gt;stage2_layer0_attention_start -->
<g id="edge281" class="edge">
<title>stage2_input&#45;&gt;stage2_layer0_attention_start</title>
<path fill="none" stroke="black" d="M1756,-22082.06C1756,-22082.06 1756,-22005.19 1756,-22005.19"/>
<polygon fill="black" stroke="black" points="1759.5,-22005.19 1756,-21995.19 1752.5,-22005.19 1759.5,-22005.19"/>
</g>
<!-- stage2_layer0_qkv_proj -->
<g id="node191" class="node">
<title>stage2_layer0_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-21840.14 1569.5,-21840.14 1569.5,-21772.14 1942.5,-21772.14 1942.5,-21840.14"/>
<text text-anchor="middle" x="1756" y="-21824.94" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-21809.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-21794.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-21779.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer0_attention_start&#45;&gt;stage2_layer0_qkv_proj -->
<g id="edge269" class="edge">
<title>stage2_layer0_attention_start&#45;&gt;stage2_layer0_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-21927.13C1756,-21927.13 1756,-21850.35 1756,-21850.35"/>
<polygon fill="black" stroke="black" points="1759.5,-21850.35 1756,-21840.35 1752.5,-21850.35 1759.5,-21850.35"/>
</g>
<!-- stage2_layer0_attention_compute -->
<g id="node192" class="node">
<title>stage2_layer0_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-21685.14 1569.5,-21685.14 1569.5,-21617.14 1942.5,-21617.14 1942.5,-21685.14"/>
<text text-anchor="middle" x="1756" y="-21669.94" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-21654.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-21639.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-21624.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer0_qkv_proj&#45;&gt;stage2_layer0_attention_compute -->
<g id="edge270" class="edge">
<title>stage2_layer0_qkv_proj&#45;&gt;stage2_layer0_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-21772.13C1756,-21772.13 1756,-21695.35 1756,-21695.35"/>
<polygon fill="black" stroke="black" points="1759.5,-21695.35 1756,-21685.35 1752.5,-21695.35 1759.5,-21695.35"/>
</g>
<!-- stage2_layer0_attention_out -->
<g id="node193" class="node">
<title>stage2_layer0_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-21530.14 1575.5,-21530.14 1575.5,-21462.14 1936.5,-21462.14 1936.5,-21530.14"/>
<text text-anchor="middle" x="1756" y="-21514.94" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-21499.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-21484.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-21469.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer0_attention_compute&#45;&gt;stage2_layer0_attention_out -->
<g id="edge271" class="edge">
<title>stage2_layer0_attention_compute&#45;&gt;stage2_layer0_attention_out</title>
<path fill="none" stroke="black" d="M1756,-21617.13C1756,-21617.13 1756,-21540.35 1756,-21540.35"/>
<polygon fill="black" stroke="black" points="1759.5,-21540.35 1756,-21530.35 1752.5,-21540.35 1759.5,-21540.35"/>
</g>
<!-- stage2_layer0_attention_allreduce -->
<g id="node194" class="node">
<title>stage2_layer0_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-21327.06" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-21345.86" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-21330.86" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-21315.86" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-21300.86" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_attention_out&#45;&gt;stage2_layer0_attention_allreduce -->
<g id="edge272" class="edge">
<title>stage2_layer0_attention_out&#45;&gt;stage2_layer0_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-21461.93C1756,-21461.93 1756,-21385.32 1756,-21385.32"/>
<polygon fill="black" stroke="black" points="1759.5,-21385.32 1756,-21375.32 1752.5,-21385.32 1759.5,-21385.32"/>
</g>
<!-- stage2_layer0_attention_residual -->
<g id="node195" class="node">
<title>stage2_layer0_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-21191.98 1584,-21191.98 1584,-21123.98 1928,-21123.98 1928,-21191.98"/>
<text text-anchor="middle" x="1756" y="-21176.78" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-21161.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-21146.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-21131.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_attention_allreduce&#45;&gt;stage2_layer0_attention_residual -->
<g id="edge273" class="edge">
<title>stage2_layer0_attention_allreduce&#45;&gt;stage2_layer0_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-21278.61C1756,-21278.61 1756,-21202.21 1756,-21202.21"/>
<polygon fill="black" stroke="black" points="1759.5,-21202.21 1756,-21192.21 1752.5,-21202.21 1759.5,-21202.21"/>
</g>
<!-- stage2_layer0_layernorm2 -->
<g id="node196" class="node">
<title>stage2_layer0_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-21036.98 1584,-21036.98 1584,-20968.98 1928,-20968.98 1928,-21036.98"/>
<text text-anchor="middle" x="1756" y="-21021.78" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-21006.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-20991.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-20976.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_attention_residual&#45;&gt;stage2_layer0_layernorm2 -->
<g id="edge274" class="edge">
<title>stage2_layer0_attention_residual&#45;&gt;stage2_layer0_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-21123.96C1756,-21123.96 1756,-21047.18 1756,-21047.18"/>
<polygon fill="black" stroke="black" points="1759.5,-21047.18 1756,-21037.18 1752.5,-21047.18 1759.5,-21047.18"/>
</g>
<!-- stage2_layer0_moe_gate -->
<g id="node197" class="node">
<title>stage2_layer0_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-20881.98 1552.53,-20881.98 1411.6,-20745.98 1959.47,-20745.98 2100.4,-20881.98"/>
<text text-anchor="middle" x="1756" y="-20832.78" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-20817.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-20802.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-20787.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage2_layer0_layernorm2&#45;&gt;stage2_layer0_moe_gate -->
<g id="edge275" class="edge">
<title>stage2_layer0_layernorm2&#45;&gt;stage2_layer0_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-20968.75C1756,-20968.75 1756,-20892.01 1756,-20892.01"/>
<polygon fill="black" stroke="black" points="1759.5,-20892.01 1756,-20882.01 1752.5,-20892.01 1759.5,-20892.01"/>
</g>
<!-- stage2_layer0_expert_dispatch -->
<g id="node198" class="node">
<title>stage2_layer0_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-20610.89" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-20629.69" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-20614.69" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-20599.69" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-20584.69" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_moe_gate&#45;&gt;stage2_layer0_expert_dispatch -->
<g id="edge251" class="edge">
<title>stage2_layer0_moe_gate&#45;&gt;stage2_layer0_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-20745.79C1756,-20745.79 1756,-20669.02 1756,-20669.02"/>
<polygon fill="black" stroke="black" points="1759.5,-20669.02 1756,-20659.02 1752.5,-20669.02 1759.5,-20669.02"/>
</g>
<!-- stage2_layer0_experts_group0 -->
<g id="node199" class="node">
<title>stage2_layer0_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-20475.81 16.5,-20475.81 16.5,-20392.81 351.5,-20392.81 351.5,-20475.81"/>
<text text-anchor="middle" x="184" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;259</text>
<text text-anchor="middle" x="184" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group0 -->
<g id="edge253" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group0</title>
<path fill="none" stroke="black" d="M1548.18,-20634C1109.34,-20634 128.17,-20634 128.17,-20634 128.17,-20634 128.17,-20486.17 128.17,-20486.17"/>
<polygon fill="black" stroke="black" points="131.67,-20486.17 128.17,-20476.17 124.67,-20486.17 131.67,-20486.17"/>
</g>
<!-- stage2_layer0_experts_group1 -->
<g id="node200" class="node">
<title>stage2_layer0_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-20475.81 409.5,-20475.81 409.5,-20392.81 744.5,-20392.81 744.5,-20475.81"/>
<text text-anchor="middle" x="577" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 260&#45;263</text>
<text text-anchor="middle" x="577" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group1 -->
<g id="edge255" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-20610C1160.38,-20610 521.17,-20610 521.17,-20610 521.17,-20610 521.17,-20485.95 521.17,-20485.95"/>
<polygon fill="black" stroke="black" points="524.67,-20485.95 521.17,-20475.95 517.67,-20485.95 524.67,-20485.95"/>
</g>
<!-- stage2_layer0_experts_group2 -->
<g id="node201" class="node">
<title>stage2_layer0_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-20475.81 802.5,-20475.81 802.5,-20392.81 1137.5,-20392.81 1137.5,-20475.81"/>
<text text-anchor="middle" x="970" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 264&#45;267</text>
<text text-anchor="middle" x="970" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group2 -->
<g id="edge257" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group2</title>
<path fill="none" stroke="black" d="M1553.29,-20586C1304.19,-20586 914.17,-20586 914.17,-20586 914.17,-20586 914.17,-20486.16 914.17,-20486.16"/>
<polygon fill="black" stroke="black" points="917.67,-20486.16 914.17,-20476.16 910.67,-20486.16 917.67,-20486.16"/>
</g>
<!-- stage2_layer0_experts_group3 -->
<g id="node202" class="node">
<title>stage2_layer0_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-20475.81 1195.5,-20475.81 1195.5,-20392.81 1530.5,-20392.81 1530.5,-20475.81"/>
<text text-anchor="middle" x="1363" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 268&#45;271</text>
<text text-anchor="middle" x="1363" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group3 -->
<g id="edge259" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-20600.37C1524.81,-20600.37 1524.81,-20486.07 1524.81,-20486.07"/>
<polygon fill="black" stroke="black" points="1528.31,-20486.07 1524.81,-20476.07 1521.31,-20486.07 1528.31,-20486.07"/>
</g>
<!-- stage2_layer0_experts_group4 -->
<g id="node203" class="node">
<title>stage2_layer0_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-20475.81 1588.5,-20475.81 1588.5,-20392.81 1923.5,-20392.81 1923.5,-20475.81"/>
<text text-anchor="middle" x="1756" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 272&#45;275</text>
<text text-anchor="middle" x="1756" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group4 -->
<g id="edge261" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-20562.64C1756,-20562.64 1756,-20485.91 1756,-20485.91"/>
<polygon fill="black" stroke="black" points="1759.5,-20485.91 1756,-20475.91 1752.5,-20485.91 1759.5,-20485.91"/>
</g>
<!-- stage2_layer0_experts_group5 -->
<g id="node204" class="node">
<title>stage2_layer0_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-20475.81 1981.5,-20475.81 1981.5,-20392.81 2316.5,-20392.81 2316.5,-20475.81"/>
<text text-anchor="middle" x="2149" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 276&#45;279</text>
<text text-anchor="middle" x="2149" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group5 -->
<g id="edge263" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-20600.37C1987.19,-20600.37 1987.19,-20486.07 1987.19,-20486.07"/>
<polygon fill="black" stroke="black" points="1990.69,-20486.07 1987.19,-20476.07 1983.69,-20486.07 1990.69,-20486.07"/>
</g>
<!-- stage2_layer0_experts_group6 -->
<g id="node205" class="node">
<title>stage2_layer0_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-20475.81 2374.5,-20475.81 2374.5,-20392.81 2709.5,-20392.81 2709.5,-20475.81"/>
<text text-anchor="middle" x="2542" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 280&#45;283</text>
<text text-anchor="middle" x="2542" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group6 -->
<g id="edge265" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group6</title>
<path fill="none" stroke="black" d="M1978.05,-20594C2192.87,-20594 2486.17,-20594 2486.17,-20594 2486.17,-20594 2486.17,-20485.85 2486.17,-20485.85"/>
<polygon fill="black" stroke="black" points="2489.67,-20485.85 2486.17,-20475.85 2482.67,-20485.85 2489.67,-20485.85"/>
</g>
<!-- stage2_layer0_experts_group7 -->
<g id="node206" class="node">
<title>stage2_layer0_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-20475.81 2767.5,-20475.81 2767.5,-20392.81 3102.5,-20392.81 3102.5,-20475.81"/>
<text text-anchor="middle" x="2935" y="-20460.61" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-20445.61" font-family="Times,serif" font-size="14.00">GPU 284&#45;287</text>
<text text-anchor="middle" x="2935" y="-20430.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-20415.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-20400.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group7 -->
<g id="edge267" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_experts_group7</title>
<path fill="none" stroke="black" d="M1980.93,-20626C2308.75,-20626 2879.17,-20626 2879.17,-20626 2879.17,-20626 2879.17,-20485.9 2879.17,-20485.9"/>
<polygon fill="black" stroke="black" points="2882.67,-20485.9 2879.17,-20475.9 2875.67,-20485.9 2882.67,-20485.9"/>
</g>
<!-- stage2_layer0_expert_combine -->
<g id="node207" class="node">
<title>stage2_layer0_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-20257.73" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-20276.53" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-20261.53" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-20246.53" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-20231.53" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge252" class="edge">
<title>stage2_layer0_expert_dispatch&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-20583.77C1559.5,-20583.77 1559.5,-20296.42 1559.5,-20296.42"/>
<polygon fill="black" stroke="black" points="1563,-20296.42 1559.5,-20286.42 1556,-20296.42 1563,-20296.42"/>
</g>
<!-- stage2_layer0_experts_group0&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge254" class="edge">
<title>stage2_layer0_experts_group0&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-20392.6C239.83,-20333.63 239.83,-20233 239.83,-20233 239.83,-20233 1537.17,-20233 1537.17,-20233"/>
<polygon fill="black" stroke="black" points="1537.17,-20236.5 1547.17,-20233 1537.17,-20229.5 1537.17,-20236.5"/>
</g>
<!-- stage2_layer0_experts_group1&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge256" class="edge">
<title>stage2_layer0_experts_group1&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-20392.74C632.83,-20340.33 632.83,-20257 632.83,-20257 632.83,-20257 1502.64,-20257 1502.64,-20257"/>
<polygon fill="black" stroke="black" points="1502.64,-20260.5 1512.64,-20257 1502.64,-20253.5 1502.64,-20260.5"/>
</g>
<!-- stage2_layer0_experts_group2&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge258" class="edge">
<title>stage2_layer0_experts_group2&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-20392.42C1025.83,-20347.02 1025.83,-20281 1025.83,-20281 1025.83,-20281 1532.84,-20281 1532.84,-20281"/>
<polygon fill="black" stroke="black" points="1532.84,-20284.5 1542.84,-20281 1532.84,-20277.5 1532.84,-20284.5"/>
</g>
<!-- stage2_layer0_experts_group3&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge260" class="edge">
<title>stage2_layer0_experts_group3&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-20392.46C1521.63,-20392.46 1521.63,-20280.64 1521.63,-20280.64"/>
<polygon fill="black" stroke="black" points="1525.13,-20280.64 1521.63,-20270.64 1518.13,-20280.64 1525.13,-20280.64"/>
</g>
<!-- stage2_layer0_experts_group4&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge262" class="edge">
<title>stage2_layer0_experts_group4&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-20392.46C1756,-20392.46 1756,-20315.83 1756,-20315.83"/>
<polygon fill="black" stroke="black" points="1759.5,-20315.83 1756,-20305.83 1752.5,-20315.83 1759.5,-20315.83"/>
</g>
<!-- stage2_layer0_experts_group5&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge264" class="edge">
<title>stage2_layer0_experts_group5&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-20392.46C1990.37,-20392.46 1990.37,-20280.64 1990.37,-20280.64"/>
<polygon fill="black" stroke="black" points="1993.87,-20280.64 1990.37,-20270.64 1986.87,-20280.64 1993.87,-20280.64"/>
</g>
<!-- stage2_layer0_experts_group6&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge266" class="edge">
<title>stage2_layer0_experts_group6&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-20392.77C2597.83,-20344.97 2597.83,-20273 2597.83,-20273 2597.83,-20273 1996.87,-20273 1996.87,-20273"/>
<polygon fill="black" stroke="black" points="1996.87,-20269.5 1986.87,-20273 1996.87,-20276.5 1996.87,-20269.5"/>
</g>
<!-- stage2_layer0_experts_group7&#45;&gt;stage2_layer0_expert_combine -->
<g id="edge268" class="edge">
<title>stage2_layer0_experts_group7&#45;&gt;stage2_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-20392.36C2990.83,-20335.51 2990.83,-20241 2990.83,-20241 2990.83,-20241 1994.29,-20241 1994.29,-20241"/>
<polygon fill="black" stroke="black" points="1994.29,-20237.5 1984.29,-20241 1994.29,-20244.5 1994.29,-20237.5"/>
</g>
<!-- stage2_layer0_mlp_fc1 -->
<g id="node208" class="node">
<title>stage2_layer0_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-20122.64 1590,-20122.64 1590,-20054.64 1922,-20054.64 1922,-20122.64"/>
<text text-anchor="middle" x="1756" y="-20107.44" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-20092.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-20077.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-20062.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer0_expert_combine&#45;&gt;stage2_layer0_mlp_fc1 -->
<g id="edge276" class="edge">
<title>stage2_layer0_expert_combine&#45;&gt;stage2_layer0_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-20209.27C1756,-20209.27 1756,-20132.88 1756,-20132.88"/>
<polygon fill="black" stroke="black" points="1759.5,-20132.88 1756,-20122.88 1752.5,-20132.88 1759.5,-20132.88"/>
</g>
<!-- stage2_layer0_mlp_gelu -->
<g id="node209" class="node">
<title>stage2_layer0_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-19967.64 1603.5,-19967.64 1603.5,-19899.64 1908.5,-19899.64 1908.5,-19967.64"/>
<text text-anchor="middle" x="1756" y="-19952.44" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-19937.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-19922.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-19907.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer0_mlp_fc1&#45;&gt;stage2_layer0_mlp_gelu -->
<g id="edge277" class="edge">
<title>stage2_layer0_mlp_fc1&#45;&gt;stage2_layer0_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-20054.63C1756,-20054.63 1756,-19977.85 1756,-19977.85"/>
<polygon fill="black" stroke="black" points="1759.5,-19977.85 1756,-19967.85 1752.5,-19977.85 1759.5,-19977.85"/>
</g>
<!-- stage2_layer0_mlp_fc2 -->
<g id="node210" class="node">
<title>stage2_layer0_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-19812.64 1588.5,-19812.64 1588.5,-19744.64 1923.5,-19744.64 1923.5,-19812.64"/>
<text text-anchor="middle" x="1756" y="-19797.44" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-19782.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-19767.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-19752.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer0_mlp_gelu&#45;&gt;stage2_layer0_mlp_fc2 -->
<g id="edge278" class="edge">
<title>stage2_layer0_mlp_gelu&#45;&gt;stage2_layer0_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-19899.63C1756,-19899.63 1756,-19822.85 1756,-19822.85"/>
<polygon fill="black" stroke="black" points="1759.5,-19822.85 1756,-19812.85 1752.5,-19822.85 1759.5,-19822.85"/>
</g>
<!-- stage2_layer0_mlp_allreduce -->
<g id="node211" class="node">
<title>stage2_layer0_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-19609.56" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-19628.36" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-19613.36" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-19598.36" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-19583.36" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_mlp_fc2&#45;&gt;stage2_layer0_mlp_allreduce -->
<g id="edge279" class="edge">
<title>stage2_layer0_mlp_fc2&#45;&gt;stage2_layer0_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-19744.43C1756,-19744.43 1756,-19667.82 1756,-19667.82"/>
<polygon fill="black" stroke="black" points="1759.5,-19667.82 1756,-19657.82 1752.5,-19667.82 1759.5,-19667.82"/>
</g>
<!-- stage2_layer0_mlp_end -->
<g id="node212" class="node">
<title>stage2_layer0_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-19474.48 1584,-19474.48 1584,-19406.48 1928,-19406.48 1928,-19474.48"/>
<text text-anchor="middle" x="1756" y="-19459.28" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-19444.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-19429.28" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-19414.28" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_mlp_allreduce&#45;&gt;stage2_layer0_mlp_end -->
<g id="edge280" class="edge">
<title>stage2_layer0_mlp_allreduce&#45;&gt;stage2_layer0_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-19561.11C1756,-19561.11 1756,-19484.71 1756,-19484.71"/>
<polygon fill="black" stroke="black" points="1759.5,-19484.71 1756,-19474.71 1752.5,-19484.71 1759.5,-19484.71"/>
</g>
<!-- stage2_layer1_attention_start -->
<g id="node213" class="node">
<title>stage2_layer1_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-19319.48 1584,-19319.48 1584,-19251.48 1928,-19251.48 1928,-19319.48"/>
<text text-anchor="middle" x="1756" y="-19304.28" font-family="Times,serif" font-size="14.00">Attention Start (Layer 1)</text>
<text text-anchor="middle" x="1756" y="-19289.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-19274.28" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-19259.28" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer0_mlp_end&#45;&gt;stage2_layer1_attention_start -->
<g id="edge312" class="edge">
<title>stage2_layer0_mlp_end&#45;&gt;stage2_layer1_attention_start</title>
<path fill="none" stroke="black" d="M1756,-19406.46C1756,-19406.46 1756,-19329.68 1756,-19329.68"/>
<polygon fill="black" stroke="black" points="1759.5,-19329.68 1756,-19319.68 1752.5,-19329.68 1759.5,-19329.68"/>
</g>
<!-- stage2_layer1_qkv_proj -->
<g id="node214" class="node">
<title>stage2_layer1_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-19164.48 1569.5,-19164.48 1569.5,-19096.48 1942.5,-19096.48 1942.5,-19164.48"/>
<text text-anchor="middle" x="1756" y="-19149.28" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-19134.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-19119.28" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-19104.28" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer1_attention_start&#45;&gt;stage2_layer1_qkv_proj -->
<g id="edge300" class="edge">
<title>stage2_layer1_attention_start&#45;&gt;stage2_layer1_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-19251.46C1756,-19251.46 1756,-19174.68 1756,-19174.68"/>
<polygon fill="black" stroke="black" points="1759.5,-19174.68 1756,-19164.68 1752.5,-19174.68 1759.5,-19174.68"/>
</g>
<!-- stage2_layer1_attention_compute -->
<g id="node215" class="node">
<title>stage2_layer1_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-19009.48 1569.5,-19009.48 1569.5,-18941.48 1942.5,-18941.48 1942.5,-19009.48"/>
<text text-anchor="middle" x="1756" y="-18994.28" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-18979.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-18964.28" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-18949.28" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer1_qkv_proj&#45;&gt;stage2_layer1_attention_compute -->
<g id="edge301" class="edge">
<title>stage2_layer1_qkv_proj&#45;&gt;stage2_layer1_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-19096.46C1756,-19096.46 1756,-19019.68 1756,-19019.68"/>
<polygon fill="black" stroke="black" points="1759.5,-19019.68 1756,-19009.68 1752.5,-19019.68 1759.5,-19019.68"/>
</g>
<!-- stage2_layer1_attention_out -->
<g id="node216" class="node">
<title>stage2_layer1_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-18854.48 1575.5,-18854.48 1575.5,-18786.48 1936.5,-18786.48 1936.5,-18854.48"/>
<text text-anchor="middle" x="1756" y="-18839.28" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-18824.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-18809.28" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-18794.28" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer1_attention_compute&#45;&gt;stage2_layer1_attention_out -->
<g id="edge302" class="edge">
<title>stage2_layer1_attention_compute&#45;&gt;stage2_layer1_attention_out</title>
<path fill="none" stroke="black" d="M1756,-18941.46C1756,-18941.46 1756,-18864.68 1756,-18864.68"/>
<polygon fill="black" stroke="black" points="1759.5,-18864.68 1756,-18854.68 1752.5,-18864.68 1759.5,-18864.68"/>
</g>
<!-- stage2_layer1_attention_allreduce -->
<g id="node217" class="node">
<title>stage2_layer1_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-18651.39" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-18670.19" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-18655.19" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-18640.19" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-18625.19" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_attention_out&#45;&gt;stage2_layer1_attention_allreduce -->
<g id="edge303" class="edge">
<title>stage2_layer1_attention_out&#45;&gt;stage2_layer1_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-18786.26C1756,-18786.26 1756,-18709.65 1756,-18709.65"/>
<polygon fill="black" stroke="black" points="1759.5,-18709.65 1756,-18699.65 1752.5,-18709.65 1759.5,-18709.65"/>
</g>
<!-- stage2_layer1_attention_residual -->
<g id="node218" class="node">
<title>stage2_layer1_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-18516.31 1584,-18516.31 1584,-18448.31 1928,-18448.31 1928,-18516.31"/>
<text text-anchor="middle" x="1756" y="-18501.11" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-18486.11" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-18471.11" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-18456.11" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_attention_allreduce&#45;&gt;stage2_layer1_attention_residual -->
<g id="edge304" class="edge">
<title>stage2_layer1_attention_allreduce&#45;&gt;stage2_layer1_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-18602.94C1756,-18602.94 1756,-18526.54 1756,-18526.54"/>
<polygon fill="black" stroke="black" points="1759.5,-18526.54 1756,-18516.54 1752.5,-18526.54 1759.5,-18526.54"/>
</g>
<!-- stage2_layer1_layernorm2 -->
<g id="node219" class="node">
<title>stage2_layer1_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-18361.31 1584,-18361.31 1584,-18293.31 1928,-18293.31 1928,-18361.31"/>
<text text-anchor="middle" x="1756" y="-18346.11" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-18331.11" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-18316.11" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-18301.11" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_attention_residual&#45;&gt;stage2_layer1_layernorm2 -->
<g id="edge305" class="edge">
<title>stage2_layer1_attention_residual&#45;&gt;stage2_layer1_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-18448.29C1756,-18448.29 1756,-18371.51 1756,-18371.51"/>
<polygon fill="black" stroke="black" points="1759.5,-18371.51 1756,-18361.51 1752.5,-18371.51 1759.5,-18371.51"/>
</g>
<!-- stage2_layer1_moe_gate -->
<g id="node220" class="node">
<title>stage2_layer1_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-18206.31 1552.53,-18206.31 1411.6,-18070.31 1959.47,-18070.31 2100.4,-18206.31"/>
<text text-anchor="middle" x="1756" y="-18157.11" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-18142.11" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-18127.11" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-18112.11" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage2_layer1_layernorm2&#45;&gt;stage2_layer1_moe_gate -->
<g id="edge306" class="edge">
<title>stage2_layer1_layernorm2&#45;&gt;stage2_layer1_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-18293.08C1756,-18293.08 1756,-18216.34 1756,-18216.34"/>
<polygon fill="black" stroke="black" points="1759.5,-18216.34 1756,-18206.34 1752.5,-18216.34 1759.5,-18216.34"/>
</g>
<!-- stage2_layer1_expert_dispatch -->
<g id="node221" class="node">
<title>stage2_layer1_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-17935.23" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-17954.03" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-17939.03" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-17924.03" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-17909.03" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_moe_gate&#45;&gt;stage2_layer1_expert_dispatch -->
<g id="edge282" class="edge">
<title>stage2_layer1_moe_gate&#45;&gt;stage2_layer1_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-18070.12C1756,-18070.12 1756,-17993.36 1756,-17993.36"/>
<polygon fill="black" stroke="black" points="1759.5,-17993.35 1756,-17983.36 1752.5,-17993.36 1759.5,-17993.35"/>
</g>
<!-- stage2_layer1_experts_group0 -->
<g id="node222" class="node">
<title>stage2_layer1_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-17800.14 16.5,-17800.14 16.5,-17717.14 351.5,-17717.14 351.5,-17800.14"/>
<text text-anchor="middle" x="184" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;259</text>
<text text-anchor="middle" x="184" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group0 -->
<g id="edge284" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group0</title>
<path fill="none" stroke="black" d="M1549.83,-17959C1111.81,-17959 128.17,-17959 128.17,-17959 128.17,-17959 128.17,-17810.16 128.17,-17810.16"/>
<polygon fill="black" stroke="black" points="131.67,-17810.16 128.17,-17800.16 124.67,-17810.16 131.67,-17810.16"/>
</g>
<!-- stage2_layer1_experts_group1 -->
<g id="node223" class="node">
<title>stage2_layer1_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-17800.14 409.5,-17800.14 409.5,-17717.14 744.5,-17717.14 744.5,-17800.14"/>
<text text-anchor="middle" x="577" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 260&#45;263</text>
<text text-anchor="middle" x="577" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group1 -->
<g id="edge286" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-17935C1160.38,-17935 521.17,-17935 521.17,-17935 521.17,-17935 521.17,-17810.44 521.17,-17810.44"/>
<polygon fill="black" stroke="black" points="524.67,-17810.44 521.17,-17800.44 517.67,-17810.44 524.67,-17810.44"/>
</g>
<!-- stage2_layer1_experts_group2 -->
<g id="node224" class="node">
<title>stage2_layer1_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-17800.14 802.5,-17800.14 802.5,-17717.14 1137.5,-17717.14 1137.5,-17800.14"/>
<text text-anchor="middle" x="970" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 264&#45;267</text>
<text text-anchor="middle" x="970" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group2 -->
<g id="edge288" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group2</title>
<path fill="none" stroke="black" d="M1551.14,-17911C1301.96,-17911 914.17,-17911 914.17,-17911 914.17,-17911 914.17,-17810.28 914.17,-17810.28"/>
<polygon fill="black" stroke="black" points="917.67,-17810.28 914.17,-17800.28 910.67,-17810.28 917.67,-17810.28"/>
</g>
<!-- stage2_layer1_experts_group3 -->
<g id="node225" class="node">
<title>stage2_layer1_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-17800.14 1195.5,-17800.14 1195.5,-17717.14 1530.5,-17717.14 1530.5,-17800.14"/>
<text text-anchor="middle" x="1363" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 268&#45;271</text>
<text text-anchor="middle" x="1363" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group3 -->
<g id="edge290" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-17924.71C1524.81,-17924.71 1524.81,-17810.4 1524.81,-17810.4"/>
<polygon fill="black" stroke="black" points="1528.31,-17810.4 1524.81,-17800.4 1521.31,-17810.4 1528.31,-17810.4"/>
</g>
<!-- stage2_layer1_experts_group4 -->
<g id="node226" class="node">
<title>stage2_layer1_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-17800.14 1588.5,-17800.14 1588.5,-17717.14 1923.5,-17717.14 1923.5,-17800.14"/>
<text text-anchor="middle" x="1756" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 272&#45;275</text>
<text text-anchor="middle" x="1756" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group4 -->
<g id="edge292" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-17886.97C1756,-17886.97 1756,-17810.24 1756,-17810.24"/>
<polygon fill="black" stroke="black" points="1759.5,-17810.24 1756,-17800.24 1752.5,-17810.24 1759.5,-17810.24"/>
</g>
<!-- stage2_layer1_experts_group5 -->
<g id="node227" class="node">
<title>stage2_layer1_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-17800.14 1981.5,-17800.14 1981.5,-17717.14 2316.5,-17717.14 2316.5,-17800.14"/>
<text text-anchor="middle" x="2149" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 276&#45;279</text>
<text text-anchor="middle" x="2149" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group5 -->
<g id="edge294" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-17924.71C1987.19,-17924.71 1987.19,-17810.4 1987.19,-17810.4"/>
<polygon fill="black" stroke="black" points="1990.69,-17810.4 1987.19,-17800.4 1983.69,-17810.4 1990.69,-17810.4"/>
</g>
<!-- stage2_layer1_experts_group6 -->
<g id="node228" class="node">
<title>stage2_layer1_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-17800.14 2374.5,-17800.14 2374.5,-17717.14 2709.5,-17717.14 2709.5,-17800.14"/>
<text text-anchor="middle" x="2542" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 280&#45;283</text>
<text text-anchor="middle" x="2542" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group6 -->
<g id="edge296" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group6</title>
<path fill="none" stroke="black" d="M1979.04,-17919C2193.77,-17919 2486.17,-17919 2486.17,-17919 2486.17,-17919 2486.17,-17810.36 2486.17,-17810.36"/>
<polygon fill="black" stroke="black" points="2489.67,-17810.36 2486.17,-17800.36 2482.67,-17810.36 2489.67,-17810.36"/>
</g>
<!-- stage2_layer1_experts_group7 -->
<g id="node229" class="node">
<title>stage2_layer1_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-17800.14 2767.5,-17800.14 2767.5,-17717.14 3102.5,-17717.14 3102.5,-17800.14"/>
<text text-anchor="middle" x="2935" y="-17784.94" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-17769.94" font-family="Times,serif" font-size="14.00">GPU 284&#45;287</text>
<text text-anchor="middle" x="2935" y="-17754.94" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-17739.94" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-17724.94" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group7 -->
<g id="edge298" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_experts_group7</title>
<path fill="none" stroke="black" d="M1979.92,-17951C2307.58,-17951 2879.17,-17951 2879.17,-17951 2879.17,-17951 2879.17,-17810.38 2879.17,-17810.38"/>
<polygon fill="black" stroke="black" points="2882.67,-17810.38 2879.17,-17800.38 2875.67,-17810.38 2882.67,-17810.38"/>
</g>
<!-- stage2_layer1_expert_combine -->
<g id="node230" class="node">
<title>stage2_layer1_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-17582.06" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-17600.86" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-17585.86" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-17570.86" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-17555.86" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge283" class="edge">
<title>stage2_layer1_expert_dispatch&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-17908.1C1559.5,-17908.1 1559.5,-17620.75 1559.5,-17620.75"/>
<polygon fill="black" stroke="black" points="1563,-17620.75 1559.5,-17610.75 1556,-17620.75 1563,-17620.75"/>
</g>
<!-- stage2_layer1_experts_group0&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge285" class="edge">
<title>stage2_layer1_experts_group0&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-17717.07C239.83,-17658.3 239.83,-17558 239.83,-17558 239.83,-17558 1535.18,-17558 1535.18,-17558"/>
<polygon fill="black" stroke="black" points="1535.18,-17561.5 1545.18,-17558 1535.18,-17554.5 1535.18,-17561.5"/>
</g>
<!-- stage2_layer1_experts_group1&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge287" class="edge">
<title>stage2_layer1_experts_group1&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-17716.78C632.83,-17664.55 632.83,-17582 632.83,-17582 632.83,-17582 1502.64,-17582 1502.64,-17582"/>
<polygon fill="black" stroke="black" points="1502.64,-17585.5 1512.64,-17582 1502.64,-17578.5 1502.64,-17585.5"/>
</g>
<!-- stage2_layer1_experts_group2&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge289" class="edge">
<title>stage2_layer1_experts_group2&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-17716.93C1025.83,-17671.74 1025.83,-17606 1025.83,-17606 1025.83,-17606 1534.81,-17606 1534.81,-17606"/>
<polygon fill="black" stroke="black" points="1534.81,-17609.5 1544.81,-17606 1534.81,-17602.5 1534.81,-17609.5"/>
</g>
<!-- stage2_layer1_experts_group3&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge291" class="edge">
<title>stage2_layer1_experts_group3&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-17716.8C1521.63,-17716.8 1521.63,-17604.98 1521.63,-17604.98"/>
<polygon fill="black" stroke="black" points="1525.13,-17604.98 1521.63,-17594.98 1518.13,-17604.98 1525.13,-17604.98"/>
</g>
<!-- stage2_layer1_experts_group4&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge293" class="edge">
<title>stage2_layer1_experts_group4&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-17716.8C1756,-17716.8 1756,-17640.16 1756,-17640.16"/>
<polygon fill="black" stroke="black" points="1759.5,-17640.16 1756,-17630.16 1752.5,-17640.16 1759.5,-17640.16"/>
</g>
<!-- stage2_layer1_experts_group5&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge295" class="edge">
<title>stage2_layer1_experts_group5&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-17716.8C1990.37,-17716.8 1990.37,-17604.98 1990.37,-17604.98"/>
<polygon fill="black" stroke="black" points="1993.87,-17604.98 1990.37,-17594.98 1986.87,-17604.98 1993.87,-17604.98"/>
</g>
<!-- stage2_layer1_experts_group6&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge297" class="edge">
<title>stage2_layer1_experts_group6&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-17716.86C2597.83,-17669.26 2597.83,-17598 2597.83,-17598 2597.83,-17598 1995.76,-17598 1995.76,-17598"/>
<polygon fill="black" stroke="black" points="1995.76,-17594.5 1985.76,-17598 1995.76,-17601.5 1995.76,-17594.5"/>
</g>
<!-- stage2_layer1_experts_group7&#45;&gt;stage2_layer1_expert_combine -->
<g id="edge299" class="edge">
<title>stage2_layer1_experts_group7&#45;&gt;stage2_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-17716.84C2990.83,-17660.18 2990.83,-17566 2990.83,-17566 2990.83,-17566 1995.37,-17566 1995.37,-17566"/>
<polygon fill="black" stroke="black" points="1995.37,-17562.5 1985.37,-17566 1995.37,-17569.5 1995.37,-17562.5"/>
</g>
<!-- stage2_layer1_mlp_fc1 -->
<g id="node231" class="node">
<title>stage2_layer1_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-17446.98 1590,-17446.98 1590,-17378.98 1922,-17378.98 1922,-17446.98"/>
<text text-anchor="middle" x="1756" y="-17431.78" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-17416.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-17401.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-17386.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer1_expert_combine&#45;&gt;stage2_layer1_mlp_fc1 -->
<g id="edge307" class="edge">
<title>stage2_layer1_expert_combine&#45;&gt;stage2_layer1_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-17533.61C1756,-17533.61 1756,-17457.21 1756,-17457.21"/>
<polygon fill="black" stroke="black" points="1759.5,-17457.21 1756,-17447.21 1752.5,-17457.21 1759.5,-17457.21"/>
</g>
<!-- stage2_layer1_mlp_gelu -->
<g id="node232" class="node">
<title>stage2_layer1_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-17291.98 1603.5,-17291.98 1603.5,-17223.98 1908.5,-17223.98 1908.5,-17291.98"/>
<text text-anchor="middle" x="1756" y="-17276.78" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-17261.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-17246.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-17231.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer1_mlp_fc1&#45;&gt;stage2_layer1_mlp_gelu -->
<g id="edge308" class="edge">
<title>stage2_layer1_mlp_fc1&#45;&gt;stage2_layer1_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-17378.96C1756,-17378.96 1756,-17302.18 1756,-17302.18"/>
<polygon fill="black" stroke="black" points="1759.5,-17302.18 1756,-17292.18 1752.5,-17302.18 1759.5,-17302.18"/>
</g>
<!-- stage2_layer1_mlp_fc2 -->
<g id="node233" class="node">
<title>stage2_layer1_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-17136.98 1588.5,-17136.98 1588.5,-17068.98 1923.5,-17068.98 1923.5,-17136.98"/>
<text text-anchor="middle" x="1756" y="-17121.78" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-17106.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-17091.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-17076.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer1_mlp_gelu&#45;&gt;stage2_layer1_mlp_fc2 -->
<g id="edge309" class="edge">
<title>stage2_layer1_mlp_gelu&#45;&gt;stage2_layer1_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-17223.96C1756,-17223.96 1756,-17147.18 1756,-17147.18"/>
<polygon fill="black" stroke="black" points="1759.5,-17147.18 1756,-17137.18 1752.5,-17147.18 1759.5,-17147.18"/>
</g>
<!-- stage2_layer1_mlp_allreduce -->
<g id="node234" class="node">
<title>stage2_layer1_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-16933.89" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-16952.69" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-16937.69" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-16922.69" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-16907.69" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_mlp_fc2&#45;&gt;stage2_layer1_mlp_allreduce -->
<g id="edge310" class="edge">
<title>stage2_layer1_mlp_fc2&#45;&gt;stage2_layer1_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-17068.76C1756,-17068.76 1756,-16992.15 1756,-16992.15"/>
<polygon fill="black" stroke="black" points="1759.5,-16992.15 1756,-16982.15 1752.5,-16992.15 1759.5,-16992.15"/>
</g>
<!-- stage2_layer1_mlp_end -->
<g id="node235" class="node">
<title>stage2_layer1_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-16798.81 1584,-16798.81 1584,-16730.81 1928,-16730.81 1928,-16798.81"/>
<text text-anchor="middle" x="1756" y="-16783.61" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-16768.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-16753.61" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-16738.61" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_mlp_allreduce&#45;&gt;stage2_layer1_mlp_end -->
<g id="edge311" class="edge">
<title>stage2_layer1_mlp_allreduce&#45;&gt;stage2_layer1_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-16885.44C1756,-16885.44 1756,-16809.04 1756,-16809.04"/>
<polygon fill="black" stroke="black" points="1759.5,-16809.04 1756,-16799.04 1752.5,-16809.04 1759.5,-16809.04"/>
</g>
<!-- stage2_layer2_attention_start -->
<g id="node236" class="node">
<title>stage2_layer2_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-16643.81 1584,-16643.81 1584,-16575.81 1928,-16575.81 1928,-16643.81"/>
<text text-anchor="middle" x="1756" y="-16628.61" font-family="Times,serif" font-size="14.00">Attention Start (Layer 2)</text>
<text text-anchor="middle" x="1756" y="-16613.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-16598.61" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-16583.61" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer1_mlp_end&#45;&gt;stage2_layer2_attention_start -->
<g id="edge343" class="edge">
<title>stage2_layer1_mlp_end&#45;&gt;stage2_layer2_attention_start</title>
<path fill="none" stroke="black" d="M1756,-16730.79C1756,-16730.79 1756,-16654.01 1756,-16654.01"/>
<polygon fill="black" stroke="black" points="1759.5,-16654.01 1756,-16644.01 1752.5,-16654.01 1759.5,-16654.01"/>
</g>
<!-- stage2_layer2_qkv_proj -->
<g id="node237" class="node">
<title>stage2_layer2_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-16488.81 1569.5,-16488.81 1569.5,-16420.81 1942.5,-16420.81 1942.5,-16488.81"/>
<text text-anchor="middle" x="1756" y="-16473.61" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-16458.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-16443.61" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-16428.61" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer2_attention_start&#45;&gt;stage2_layer2_qkv_proj -->
<g id="edge331" class="edge">
<title>stage2_layer2_attention_start&#45;&gt;stage2_layer2_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-16575.79C1756,-16575.79 1756,-16499.01 1756,-16499.01"/>
<polygon fill="black" stroke="black" points="1759.5,-16499.01 1756,-16489.01 1752.5,-16499.01 1759.5,-16499.01"/>
</g>
<!-- stage2_layer2_attention_compute -->
<g id="node238" class="node">
<title>stage2_layer2_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-16333.81 1569.5,-16333.81 1569.5,-16265.81 1942.5,-16265.81 1942.5,-16333.81"/>
<text text-anchor="middle" x="1756" y="-16318.61" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-16303.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-16288.61" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-16273.61" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer2_qkv_proj&#45;&gt;stage2_layer2_attention_compute -->
<g id="edge332" class="edge">
<title>stage2_layer2_qkv_proj&#45;&gt;stage2_layer2_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-16420.79C1756,-16420.79 1756,-16344.01 1756,-16344.01"/>
<polygon fill="black" stroke="black" points="1759.5,-16344.01 1756,-16334.01 1752.5,-16344.01 1759.5,-16344.01"/>
</g>
<!-- stage2_layer2_attention_out -->
<g id="node239" class="node">
<title>stage2_layer2_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-16178.81 1575.5,-16178.81 1575.5,-16110.81 1936.5,-16110.81 1936.5,-16178.81"/>
<text text-anchor="middle" x="1756" y="-16163.61" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-16148.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-16133.61" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-16118.61" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer2_attention_compute&#45;&gt;stage2_layer2_attention_out -->
<g id="edge333" class="edge">
<title>stage2_layer2_attention_compute&#45;&gt;stage2_layer2_attention_out</title>
<path fill="none" stroke="black" d="M1756,-16265.79C1756,-16265.79 1756,-16189.01 1756,-16189.01"/>
<polygon fill="black" stroke="black" points="1759.5,-16189.01 1756,-16179.01 1752.5,-16189.01 1759.5,-16189.01"/>
</g>
<!-- stage2_layer2_attention_allreduce -->
<g id="node240" class="node">
<title>stage2_layer2_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-15975.73" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-15994.53" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-15979.53" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-15964.53" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-15949.53" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_attention_out&#45;&gt;stage2_layer2_attention_allreduce -->
<g id="edge334" class="edge">
<title>stage2_layer2_attention_out&#45;&gt;stage2_layer2_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-16110.59C1756,-16110.59 1756,-16033.99 1756,-16033.99"/>
<polygon fill="black" stroke="black" points="1759.5,-16033.99 1756,-16023.99 1752.5,-16033.99 1759.5,-16033.99"/>
</g>
<!-- stage2_layer2_attention_residual -->
<g id="node241" class="node">
<title>stage2_layer2_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-15840.64 1584,-15840.64 1584,-15772.64 1928,-15772.64 1928,-15840.64"/>
<text text-anchor="middle" x="1756" y="-15825.44" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-15810.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-15795.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-15780.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_attention_allreduce&#45;&gt;stage2_layer2_attention_residual -->
<g id="edge335" class="edge">
<title>stage2_layer2_attention_allreduce&#45;&gt;stage2_layer2_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-15927.27C1756,-15927.27 1756,-15850.88 1756,-15850.88"/>
<polygon fill="black" stroke="black" points="1759.5,-15850.88 1756,-15840.88 1752.5,-15850.88 1759.5,-15850.88"/>
</g>
<!-- stage2_layer2_layernorm2 -->
<g id="node242" class="node">
<title>stage2_layer2_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-15685.64 1584,-15685.64 1584,-15617.64 1928,-15617.64 1928,-15685.64"/>
<text text-anchor="middle" x="1756" y="-15670.44" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-15655.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-15640.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-15625.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_attention_residual&#45;&gt;stage2_layer2_layernorm2 -->
<g id="edge336" class="edge">
<title>stage2_layer2_attention_residual&#45;&gt;stage2_layer2_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-15772.63C1756,-15772.63 1756,-15695.85 1756,-15695.85"/>
<polygon fill="black" stroke="black" points="1759.5,-15695.85 1756,-15685.85 1752.5,-15695.85 1759.5,-15695.85"/>
</g>
<!-- stage2_layer2_moe_gate -->
<g id="node243" class="node">
<title>stage2_layer2_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-15530.64 1552.53,-15530.64 1411.6,-15394.64 1959.47,-15394.64 2100.4,-15530.64"/>
<text text-anchor="middle" x="1756" y="-15481.44" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-15466.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-15451.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-15436.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage2_layer2_layernorm2&#45;&gt;stage2_layer2_moe_gate -->
<g id="edge337" class="edge">
<title>stage2_layer2_layernorm2&#45;&gt;stage2_layer2_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-15617.42C1756,-15617.42 1756,-15540.68 1756,-15540.68"/>
<polygon fill="black" stroke="black" points="1759.5,-15540.68 1756,-15530.68 1752.5,-15540.68 1759.5,-15540.68"/>
</g>
<!-- stage2_layer2_expert_dispatch -->
<g id="node244" class="node">
<title>stage2_layer2_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-15259.56" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-15278.36" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-15263.36" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-15248.36" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-15233.36" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_moe_gate&#45;&gt;stage2_layer2_expert_dispatch -->
<g id="edge313" class="edge">
<title>stage2_layer2_moe_gate&#45;&gt;stage2_layer2_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-15394.45C1756,-15394.45 1756,-15317.69 1756,-15317.69"/>
<polygon fill="black" stroke="black" points="1759.5,-15317.69 1756,-15307.69 1752.5,-15317.69 1759.5,-15317.69"/>
</g>
<!-- stage2_layer2_experts_group0 -->
<g id="node245" class="node">
<title>stage2_layer2_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-15124.48 16.5,-15124.48 16.5,-15041.48 351.5,-15041.48 351.5,-15124.48"/>
<text text-anchor="middle" x="184" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;259</text>
<text text-anchor="middle" x="184" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group0 -->
<g id="edge315" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group0</title>
<path fill="none" stroke="black" d="M1549.01,-15283C1110.57,-15283 128.17,-15283 128.17,-15283 128.17,-15283 128.17,-15134.91 128.17,-15134.91"/>
<polygon fill="black" stroke="black" points="131.67,-15134.91 128.17,-15124.91 124.67,-15134.91 131.67,-15134.91"/>
</g>
<!-- stage2_layer2_experts_group1 -->
<g id="node246" class="node">
<title>stage2_layer2_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-15124.48 409.5,-15124.48 409.5,-15041.48 744.5,-15041.48 744.5,-15124.48"/>
<text text-anchor="middle" x="577" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 260&#45;263</text>
<text text-anchor="middle" x="577" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group1 -->
<g id="edge317" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-15259C1160.38,-15259 521.17,-15259 521.17,-15259 521.17,-15259 521.17,-15134.69 521.17,-15134.69"/>
<polygon fill="black" stroke="black" points="524.67,-15134.69 521.17,-15124.69 517.67,-15134.69 524.67,-15134.69"/>
</g>
<!-- stage2_layer2_experts_group2 -->
<g id="node247" class="node">
<title>stage2_layer2_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-15124.48 802.5,-15124.48 802.5,-15041.48 1137.5,-15041.48 1137.5,-15124.48"/>
<text text-anchor="middle" x="970" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 264&#45;267</text>
<text text-anchor="middle" x="970" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group2 -->
<g id="edge319" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group2</title>
<path fill="none" stroke="black" d="M1552.22,-15235C1303.07,-15235 914.17,-15235 914.17,-15235 914.17,-15235 914.17,-15134.52 914.17,-15134.52"/>
<polygon fill="black" stroke="black" points="917.67,-15134.52 914.17,-15124.52 910.67,-15134.52 917.67,-15134.52"/>
</g>
<!-- stage2_layer2_experts_group3 -->
<g id="node248" class="node">
<title>stage2_layer2_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-15124.48 1195.5,-15124.48 1195.5,-15041.48 1530.5,-15041.48 1530.5,-15124.48"/>
<text text-anchor="middle" x="1363" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 268&#45;271</text>
<text text-anchor="middle" x="1363" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group3 -->
<g id="edge321" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-15249.04C1524.81,-15249.04 1524.81,-15134.73 1524.81,-15134.73"/>
<polygon fill="black" stroke="black" points="1528.31,-15134.73 1524.81,-15124.73 1521.31,-15134.73 1528.31,-15134.73"/>
</g>
<!-- stage2_layer2_experts_group4 -->
<g id="node249" class="node">
<title>stage2_layer2_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-15124.48 1588.5,-15124.48 1588.5,-15041.48 1923.5,-15041.48 1923.5,-15124.48"/>
<text text-anchor="middle" x="1756" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 272&#45;275</text>
<text text-anchor="middle" x="1756" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group4 -->
<g id="edge323" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-15211.31C1756,-15211.31 1756,-15134.57 1756,-15134.57"/>
<polygon fill="black" stroke="black" points="1759.5,-15134.57 1756,-15124.57 1752.5,-15134.57 1759.5,-15134.57"/>
</g>
<!-- stage2_layer2_experts_group5 -->
<g id="node250" class="node">
<title>stage2_layer2_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-15124.48 1981.5,-15124.48 1981.5,-15041.48 2316.5,-15041.48 2316.5,-15124.48"/>
<text text-anchor="middle" x="2149" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 276&#45;279</text>
<text text-anchor="middle" x="2149" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group5 -->
<g id="edge325" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-15249.04C1987.19,-15249.04 1987.19,-15134.73 1987.19,-15134.73"/>
<polygon fill="black" stroke="black" points="1990.69,-15134.73 1987.19,-15124.73 1983.69,-15134.73 1990.69,-15134.73"/>
</g>
<!-- stage2_layer2_experts_group6 -->
<g id="node251" class="node">
<title>stage2_layer2_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-15124.48 2374.5,-15124.48 2374.5,-15041.48 2709.5,-15041.48 2709.5,-15124.48"/>
<text text-anchor="middle" x="2542" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 280&#45;283</text>
<text text-anchor="middle" x="2542" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group6 -->
<g id="edge327" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group6</title>
<path fill="none" stroke="black" d="M1978.54,-15243C2193.32,-15243 2486.17,-15243 2486.17,-15243 2486.17,-15243 2486.17,-15134.6 2486.17,-15134.6"/>
<polygon fill="black" stroke="black" points="2489.67,-15134.6 2486.17,-15124.6 2482.67,-15134.6 2489.67,-15134.6"/>
</g>
<!-- stage2_layer2_experts_group7 -->
<g id="node252" class="node">
<title>stage2_layer2_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-15124.48 2767.5,-15124.48 2767.5,-15041.48 3102.5,-15041.48 3102.5,-15124.48"/>
<text text-anchor="middle" x="2935" y="-15109.28" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-15094.28" font-family="Times,serif" font-size="14.00">GPU 284&#45;287</text>
<text text-anchor="middle" x="2935" y="-15079.28" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-15064.28" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-15049.28" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group7 -->
<g id="edge329" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_experts_group7</title>
<path fill="none" stroke="black" d="M1980.59,-15275C2308.36,-15275 2879.17,-15275 2879.17,-15275 2879.17,-15275 2879.17,-15134.64 2879.17,-15134.64"/>
<polygon fill="black" stroke="black" points="2882.67,-15134.64 2879.17,-15124.64 2875.67,-15134.64 2882.67,-15134.64"/>
</g>
<!-- stage2_layer2_expert_combine -->
<g id="node253" class="node">
<title>stage2_layer2_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-14906.39" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-14925.19" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-14910.19" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-14895.19" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-14880.19" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge314" class="edge">
<title>stage2_layer2_expert_dispatch&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-15232.43C1559.5,-15232.43 1559.5,-14945.08 1559.5,-14945.08"/>
<polygon fill="black" stroke="black" points="1563,-14945.08 1559.5,-14935.08 1556,-14945.08 1563,-14945.08"/>
</g>
<!-- stage2_layer2_experts_group0&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge316" class="edge">
<title>stage2_layer2_experts_group0&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-15041.33C239.83,-14982.47 239.83,-14882 239.83,-14882 239.83,-14882 1536.38,-14882 1536.38,-14882"/>
<polygon fill="black" stroke="black" points="1536.38,-14885.5 1546.38,-14882 1536.38,-14878.5 1536.38,-14885.5"/>
</g>
<!-- stage2_layer2_experts_group1&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge318" class="edge">
<title>stage2_layer2_experts_group1&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-15041.04C632.83,-14988.7 632.83,-14906 632.83,-14906 632.83,-14906 1502.64,-14906 1502.64,-14906"/>
<polygon fill="black" stroke="black" points="1502.64,-14909.5 1512.64,-14906 1502.64,-14902.5 1502.64,-14909.5"/>
</g>
<!-- stage2_layer2_experts_group2&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge320" class="edge">
<title>stage2_layer2_experts_group2&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-15041.18C1025.83,-14995.88 1025.83,-14930 1025.83,-14930 1025.83,-14930 1533.82,-14930 1533.82,-14930"/>
<polygon fill="black" stroke="black" points="1533.82,-14933.5 1543.82,-14930 1533.82,-14926.5 1533.82,-14933.5"/>
</g>
<!-- stage2_layer2_experts_group3&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge322" class="edge">
<title>stage2_layer2_experts_group3&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-15041.13C1521.63,-15041.13 1521.63,-14929.31 1521.63,-14929.31"/>
<polygon fill="black" stroke="black" points="1525.13,-14929.31 1521.63,-14919.31 1518.13,-14929.31 1525.13,-14929.31"/>
</g>
<!-- stage2_layer2_experts_group4&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge324" class="edge">
<title>stage2_layer2_experts_group4&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-15041.13C1756,-15041.13 1756,-14964.5 1756,-14964.5"/>
<polygon fill="black" stroke="black" points="1759.5,-14964.5 1756,-14954.5 1752.5,-14964.5 1759.5,-14964.5"/>
</g>
<!-- stage2_layer2_experts_group5&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge326" class="edge">
<title>stage2_layer2_experts_group5&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-15041.13C1990.37,-15041.13 1990.37,-14929.31 1990.37,-14929.31"/>
<polygon fill="black" stroke="black" points="1993.87,-14929.31 1990.37,-14919.31 1986.87,-14929.31 1993.87,-14929.31"/>
</g>
<!-- stage2_layer2_experts_group6&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge328" class="edge">
<title>stage2_layer2_experts_group6&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-15041.1C2597.83,-14993.41 2597.83,-14922 2597.83,-14922 2597.83,-14922 1996.31,-14922 1996.31,-14922"/>
<polygon fill="black" stroke="black" points="1996.31,-14918.5 1986.31,-14922 1996.31,-14925.5 1996.31,-14918.5"/>
</g>
<!-- stage2_layer2_experts_group7&#45;&gt;stage2_layer2_expert_combine -->
<g id="edge330" class="edge">
<title>stage2_layer2_experts_group7&#45;&gt;stage2_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-15041.1C2990.83,-14984.35 2990.83,-14890 2990.83,-14890 2990.83,-14890 1995.01,-14890 1995.01,-14890"/>
<polygon fill="black" stroke="black" points="1995.01,-14886.5 1985.01,-14890 1995.01,-14893.5 1995.01,-14886.5"/>
</g>
<!-- stage2_layer2_mlp_fc1 -->
<g id="node254" class="node">
<title>stage2_layer2_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-14771.31 1590,-14771.31 1590,-14703.31 1922,-14703.31 1922,-14771.31"/>
<text text-anchor="middle" x="1756" y="-14756.11" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-14741.11" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-14726.11" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-14711.11" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer2_expert_combine&#45;&gt;stage2_layer2_mlp_fc1 -->
<g id="edge338" class="edge">
<title>stage2_layer2_expert_combine&#45;&gt;stage2_layer2_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-14857.94C1756,-14857.94 1756,-14781.55 1756,-14781.55"/>
<polygon fill="black" stroke="black" points="1759.5,-14781.55 1756,-14771.55 1752.5,-14781.55 1759.5,-14781.55"/>
</g>
<!-- stage2_layer2_mlp_gelu -->
<g id="node255" class="node">
<title>stage2_layer2_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-14616.31 1603.5,-14616.31 1603.5,-14548.31 1908.5,-14548.31 1908.5,-14616.31"/>
<text text-anchor="middle" x="1756" y="-14601.11" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-14586.11" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-14571.11" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-14556.11" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer2_mlp_fc1&#45;&gt;stage2_layer2_mlp_gelu -->
<g id="edge339" class="edge">
<title>stage2_layer2_mlp_fc1&#45;&gt;stage2_layer2_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-14703.29C1756,-14703.29 1756,-14626.51 1756,-14626.51"/>
<polygon fill="black" stroke="black" points="1759.5,-14626.51 1756,-14616.51 1752.5,-14626.51 1759.5,-14626.51"/>
</g>
<!-- stage2_layer2_mlp_fc2 -->
<g id="node256" class="node">
<title>stage2_layer2_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-14461.31 1588.5,-14461.31 1588.5,-14393.31 1923.5,-14393.31 1923.5,-14461.31"/>
<text text-anchor="middle" x="1756" y="-14446.11" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-14431.11" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-14416.11" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-14401.11" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer2_mlp_gelu&#45;&gt;stage2_layer2_mlp_fc2 -->
<g id="edge340" class="edge">
<title>stage2_layer2_mlp_gelu&#45;&gt;stage2_layer2_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-14548.29C1756,-14548.29 1756,-14471.51 1756,-14471.51"/>
<polygon fill="black" stroke="black" points="1759.5,-14471.51 1756,-14461.51 1752.5,-14471.51 1759.5,-14471.51"/>
</g>
<!-- stage2_layer2_mlp_allreduce -->
<g id="node257" class="node">
<title>stage2_layer2_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-14258.23" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-14277.03" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-14262.03" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-14247.03" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-14232.03" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_mlp_fc2&#45;&gt;stage2_layer2_mlp_allreduce -->
<g id="edge341" class="edge">
<title>stage2_layer2_mlp_fc2&#45;&gt;stage2_layer2_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-14393.09C1756,-14393.09 1756,-14316.49 1756,-14316.49"/>
<polygon fill="black" stroke="black" points="1759.5,-14316.49 1756,-14306.49 1752.5,-14316.49 1759.5,-14316.49"/>
</g>
<!-- stage2_layer2_mlp_end -->
<g id="node258" class="node">
<title>stage2_layer2_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-14123.14 1584,-14123.14 1584,-14055.14 1928,-14055.14 1928,-14123.14"/>
<text text-anchor="middle" x="1756" y="-14107.94" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-14092.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-14077.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-14062.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_mlp_allreduce&#45;&gt;stage2_layer2_mlp_end -->
<g id="edge342" class="edge">
<title>stage2_layer2_mlp_allreduce&#45;&gt;stage2_layer2_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-14209.77C1756,-14209.77 1756,-14133.38 1756,-14133.38"/>
<polygon fill="black" stroke="black" points="1759.5,-14133.38 1756,-14123.38 1752.5,-14133.38 1759.5,-14133.38"/>
</g>
<!-- stage2_layer3_attention_start -->
<g id="node259" class="node">
<title>stage2_layer3_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-13968.14 1584,-13968.14 1584,-13900.14 1928,-13900.14 1928,-13968.14"/>
<text text-anchor="middle" x="1756" y="-13952.94" font-family="Times,serif" font-size="14.00">Attention Start (Layer 3)</text>
<text text-anchor="middle" x="1756" y="-13937.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-13922.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-13907.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer2_mlp_end&#45;&gt;stage2_layer3_attention_start -->
<g id="edge374" class="edge">
<title>stage2_layer2_mlp_end&#45;&gt;stage2_layer3_attention_start</title>
<path fill="none" stroke="black" d="M1756,-14055.13C1756,-14055.13 1756,-13978.35 1756,-13978.35"/>
<polygon fill="black" stroke="black" points="1759.5,-13978.35 1756,-13968.35 1752.5,-13978.35 1759.5,-13978.35"/>
</g>
<!-- stage2_layer3_qkv_proj -->
<g id="node260" class="node">
<title>stage2_layer3_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-13813.14 1569.5,-13813.14 1569.5,-13745.14 1942.5,-13745.14 1942.5,-13813.14"/>
<text text-anchor="middle" x="1756" y="-13797.94" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-13782.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-13767.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-13752.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer3_attention_start&#45;&gt;stage2_layer3_qkv_proj -->
<g id="edge362" class="edge">
<title>stage2_layer3_attention_start&#45;&gt;stage2_layer3_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-13900.13C1756,-13900.13 1756,-13823.35 1756,-13823.35"/>
<polygon fill="black" stroke="black" points="1759.5,-13823.35 1756,-13813.35 1752.5,-13823.35 1759.5,-13823.35"/>
</g>
<!-- stage2_layer3_attention_compute -->
<g id="node261" class="node">
<title>stage2_layer3_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-13658.14 1569.5,-13658.14 1569.5,-13590.14 1942.5,-13590.14 1942.5,-13658.14"/>
<text text-anchor="middle" x="1756" y="-13642.94" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-13627.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-13612.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-13597.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage2_layer3_qkv_proj&#45;&gt;stage2_layer3_attention_compute -->
<g id="edge363" class="edge">
<title>stage2_layer3_qkv_proj&#45;&gt;stage2_layer3_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-13745.13C1756,-13745.13 1756,-13668.35 1756,-13668.35"/>
<polygon fill="black" stroke="black" points="1759.5,-13668.35 1756,-13658.35 1752.5,-13668.35 1759.5,-13668.35"/>
</g>
<!-- stage2_layer3_attention_out -->
<g id="node262" class="node">
<title>stage2_layer3_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-13503.14 1575.5,-13503.14 1575.5,-13435.14 1936.5,-13435.14 1936.5,-13503.14"/>
<text text-anchor="middle" x="1756" y="-13487.94" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-13472.94" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-13457.94" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-13442.94" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer3_attention_compute&#45;&gt;stage2_layer3_attention_out -->
<g id="edge364" class="edge">
<title>stage2_layer3_attention_compute&#45;&gt;stage2_layer3_attention_out</title>
<path fill="none" stroke="black" d="M1756,-13590.13C1756,-13590.13 1756,-13513.35 1756,-13513.35"/>
<polygon fill="black" stroke="black" points="1759.5,-13513.35 1756,-13503.35 1752.5,-13513.35 1759.5,-13513.35"/>
</g>
<!-- stage2_layer3_attention_allreduce -->
<g id="node263" class="node">
<title>stage2_layer3_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-13300.06" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-13318.86" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-13303.86" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-13288.86" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-13273.86" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_attention_out&#45;&gt;stage2_layer3_attention_allreduce -->
<g id="edge365" class="edge">
<title>stage2_layer3_attention_out&#45;&gt;stage2_layer3_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-13434.93C1756,-13434.93 1756,-13358.32 1756,-13358.32"/>
<polygon fill="black" stroke="black" points="1759.5,-13358.32 1756,-13348.32 1752.5,-13358.32 1759.5,-13358.32"/>
</g>
<!-- stage2_layer3_attention_residual -->
<g id="node264" class="node">
<title>stage2_layer3_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-13164.98 1584,-13164.98 1584,-13096.98 1928,-13096.98 1928,-13164.98"/>
<text text-anchor="middle" x="1756" y="-13149.78" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-13134.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-13119.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-13104.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_attention_allreduce&#45;&gt;stage2_layer3_attention_residual -->
<g id="edge366" class="edge">
<title>stage2_layer3_attention_allreduce&#45;&gt;stage2_layer3_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-13251.61C1756,-13251.61 1756,-13175.21 1756,-13175.21"/>
<polygon fill="black" stroke="black" points="1759.5,-13175.21 1756,-13165.21 1752.5,-13175.21 1759.5,-13175.21"/>
</g>
<!-- stage2_layer3_layernorm2 -->
<g id="node265" class="node">
<title>stage2_layer3_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-13009.98 1584,-13009.98 1584,-12941.98 1928,-12941.98 1928,-13009.98"/>
<text text-anchor="middle" x="1756" y="-12994.78" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-12979.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-12964.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-12949.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_attention_residual&#45;&gt;stage2_layer3_layernorm2 -->
<g id="edge367" class="edge">
<title>stage2_layer3_attention_residual&#45;&gt;stage2_layer3_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-13096.96C1756,-13096.96 1756,-13020.18 1756,-13020.18"/>
<polygon fill="black" stroke="black" points="1759.5,-13020.18 1756,-13010.18 1752.5,-13020.18 1759.5,-13020.18"/>
</g>
<!-- stage2_layer3_moe_gate -->
<g id="node266" class="node">
<title>stage2_layer3_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-12854.98 1552.53,-12854.98 1411.6,-12718.98 1959.47,-12718.98 2100.4,-12854.98"/>
<text text-anchor="middle" x="1756" y="-12805.78" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-12790.78" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-12775.78" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-12760.78" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage2_layer3_layernorm2&#45;&gt;stage2_layer3_moe_gate -->
<g id="edge368" class="edge">
<title>stage2_layer3_layernorm2&#45;&gt;stage2_layer3_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-12941.75C1756,-12941.75 1756,-12865.01 1756,-12865.01"/>
<polygon fill="black" stroke="black" points="1759.5,-12865.01 1756,-12855.01 1752.5,-12865.01 1759.5,-12865.01"/>
</g>
<!-- stage2_layer3_expert_dispatch -->
<g id="node267" class="node">
<title>stage2_layer3_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-12583.89" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-12602.69" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-12587.69" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-12572.69" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-12557.69" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_moe_gate&#45;&gt;stage2_layer3_expert_dispatch -->
<g id="edge344" class="edge">
<title>stage2_layer3_moe_gate&#45;&gt;stage2_layer3_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-12718.79C1756,-12718.79 1756,-12642.02 1756,-12642.02"/>
<polygon fill="black" stroke="black" points="1759.5,-12642.02 1756,-12632.02 1752.5,-12642.02 1759.5,-12642.02"/>
</g>
<!-- stage2_layer3_experts_group0 -->
<g id="node268" class="node">
<title>stage2_layer3_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-12448.81 16.5,-12448.81 16.5,-12365.81 351.5,-12365.81 351.5,-12448.81"/>
<text text-anchor="middle" x="184" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 256&#45;259</text>
<text text-anchor="middle" x="184" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group0 -->
<g id="edge346" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group0</title>
<path fill="none" stroke="black" d="M1548.18,-12607C1109.34,-12607 128.17,-12607 128.17,-12607 128.17,-12607 128.17,-12459.17 128.17,-12459.17"/>
<polygon fill="black" stroke="black" points="131.67,-12459.17 128.17,-12449.17 124.67,-12459.17 131.67,-12459.17"/>
</g>
<!-- stage2_layer3_experts_group1 -->
<g id="node269" class="node">
<title>stage2_layer3_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-12448.81 409.5,-12448.81 409.5,-12365.81 744.5,-12365.81 744.5,-12448.81"/>
<text text-anchor="middle" x="577" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 260&#45;263</text>
<text text-anchor="middle" x="577" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group1 -->
<g id="edge348" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-12583C1160.38,-12583 521.17,-12583 521.17,-12583 521.17,-12583 521.17,-12458.95 521.17,-12458.95"/>
<polygon fill="black" stroke="black" points="524.67,-12458.95 521.17,-12448.95 517.67,-12458.95 524.67,-12458.95"/>
</g>
<!-- stage2_layer3_experts_group2 -->
<g id="node270" class="node">
<title>stage2_layer3_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-12448.81 802.5,-12448.81 802.5,-12365.81 1137.5,-12365.81 1137.5,-12448.81"/>
<text text-anchor="middle" x="970" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 264&#45;267</text>
<text text-anchor="middle" x="970" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group2 -->
<g id="edge350" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group2</title>
<path fill="none" stroke="black" d="M1553.29,-12559C1304.19,-12559 914.17,-12559 914.17,-12559 914.17,-12559 914.17,-12459.16 914.17,-12459.16"/>
<polygon fill="black" stroke="black" points="917.67,-12459.16 914.17,-12449.16 910.67,-12459.16 917.67,-12459.16"/>
</g>
<!-- stage2_layer3_experts_group3 -->
<g id="node271" class="node">
<title>stage2_layer3_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-12448.81 1195.5,-12448.81 1195.5,-12365.81 1530.5,-12365.81 1530.5,-12448.81"/>
<text text-anchor="middle" x="1363" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 268&#45;271</text>
<text text-anchor="middle" x="1363" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group3 -->
<g id="edge352" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-12573.38C1524.81,-12573.38 1524.81,-12459.07 1524.81,-12459.07"/>
<polygon fill="black" stroke="black" points="1528.31,-12459.07 1524.81,-12449.07 1521.31,-12459.07 1528.31,-12459.07"/>
</g>
<!-- stage2_layer3_experts_group4 -->
<g id="node272" class="node">
<title>stage2_layer3_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-12448.81 1588.5,-12448.81 1588.5,-12365.81 1923.5,-12365.81 1923.5,-12448.81"/>
<text text-anchor="middle" x="1756" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 272&#45;275</text>
<text text-anchor="middle" x="1756" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group4 -->
<g id="edge354" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-12535.64C1756,-12535.64 1756,-12458.91 1756,-12458.91"/>
<polygon fill="black" stroke="black" points="1759.5,-12458.91 1756,-12448.91 1752.5,-12458.91 1759.5,-12458.91"/>
</g>
<!-- stage2_layer3_experts_group5 -->
<g id="node273" class="node">
<title>stage2_layer3_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-12448.81 1981.5,-12448.81 1981.5,-12365.81 2316.5,-12365.81 2316.5,-12448.81"/>
<text text-anchor="middle" x="2149" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 276&#45;279</text>
<text text-anchor="middle" x="2149" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group5 -->
<g id="edge356" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-12573.38C1987.19,-12573.38 1987.19,-12459.07 1987.19,-12459.07"/>
<polygon fill="black" stroke="black" points="1990.69,-12459.07 1987.19,-12449.07 1983.69,-12459.07 1990.69,-12459.07"/>
</g>
<!-- stage2_layer3_experts_group6 -->
<g id="node274" class="node">
<title>stage2_layer3_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-12448.81 2374.5,-12448.81 2374.5,-12365.81 2709.5,-12365.81 2709.5,-12448.81"/>
<text text-anchor="middle" x="2542" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 280&#45;283</text>
<text text-anchor="middle" x="2542" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group6 -->
<g id="edge358" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group6</title>
<path fill="none" stroke="black" d="M1978.05,-12567C2192.87,-12567 2486.17,-12567 2486.17,-12567 2486.17,-12567 2486.17,-12458.85 2486.17,-12458.85"/>
<polygon fill="black" stroke="black" points="2489.67,-12458.85 2486.17,-12448.85 2482.67,-12458.85 2489.67,-12458.85"/>
</g>
<!-- stage2_layer3_experts_group7 -->
<g id="node275" class="node">
<title>stage2_layer3_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-12448.81 2767.5,-12448.81 2767.5,-12365.81 3102.5,-12365.81 3102.5,-12448.81"/>
<text text-anchor="middle" x="2935" y="-12433.61" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-12418.61" font-family="Times,serif" font-size="14.00">GPU 284&#45;287</text>
<text text-anchor="middle" x="2935" y="-12403.61" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-12388.61" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-12373.61" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group7 -->
<g id="edge360" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_experts_group7</title>
<path fill="none" stroke="black" d="M1980.93,-12599C2308.75,-12599 2879.17,-12599 2879.17,-12599 2879.17,-12599 2879.17,-12458.9 2879.17,-12458.9"/>
<polygon fill="black" stroke="black" points="2882.67,-12458.9 2879.17,-12448.9 2875.67,-12458.9 2882.67,-12458.9"/>
</g>
<!-- stage2_layer3_expert_combine -->
<g id="node276" class="node">
<title>stage2_layer3_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-12230.73" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-12249.53" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-12234.53" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-12219.53" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-12204.53" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge345" class="edge">
<title>stage2_layer3_expert_dispatch&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-12556.77C1559.5,-12556.77 1559.5,-12269.42 1559.5,-12269.42"/>
<polygon fill="black" stroke="black" points="1563,-12269.42 1559.5,-12259.42 1556,-12269.42 1563,-12269.42"/>
</g>
<!-- stage2_layer3_experts_group0&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge347" class="edge">
<title>stage2_layer3_experts_group0&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-12365.6C239.83,-12306.63 239.83,-12206 239.83,-12206 239.83,-12206 1537.17,-12206 1537.17,-12206"/>
<polygon fill="black" stroke="black" points="1537.17,-12209.5 1547.17,-12206 1537.17,-12202.5 1537.17,-12209.5"/>
</g>
<!-- stage2_layer3_experts_group1&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge349" class="edge">
<title>stage2_layer3_experts_group1&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-12365.74C632.83,-12313.33 632.83,-12230 632.83,-12230 632.83,-12230 1502.64,-12230 1502.64,-12230"/>
<polygon fill="black" stroke="black" points="1502.64,-12233.5 1512.64,-12230 1502.64,-12226.5 1502.64,-12233.5"/>
</g>
<!-- stage2_layer3_experts_group2&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge351" class="edge">
<title>stage2_layer3_experts_group2&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-12365.42C1025.83,-12320.03 1025.83,-12254 1025.83,-12254 1025.83,-12254 1532.84,-12254 1532.84,-12254"/>
<polygon fill="black" stroke="black" points="1532.84,-12257.5 1542.84,-12254 1532.84,-12250.5 1532.84,-12257.5"/>
</g>
<!-- stage2_layer3_experts_group3&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge353" class="edge">
<title>stage2_layer3_experts_group3&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-12365.46C1521.63,-12365.46 1521.63,-12253.64 1521.63,-12253.64"/>
<polygon fill="black" stroke="black" points="1525.13,-12253.64 1521.63,-12243.64 1518.13,-12253.64 1525.13,-12253.64"/>
</g>
<!-- stage2_layer3_experts_group4&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge355" class="edge">
<title>stage2_layer3_experts_group4&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-12365.46C1756,-12365.46 1756,-12288.83 1756,-12288.83"/>
<polygon fill="black" stroke="black" points="1759.5,-12288.83 1756,-12278.83 1752.5,-12288.83 1759.5,-12288.83"/>
</g>
<!-- stage2_layer3_experts_group5&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge357" class="edge">
<title>stage2_layer3_experts_group5&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-12365.46C1990.37,-12365.46 1990.37,-12253.64 1990.37,-12253.64"/>
<polygon fill="black" stroke="black" points="1993.87,-12253.64 1990.37,-12243.64 1986.87,-12253.64 1993.87,-12253.64"/>
</g>
<!-- stage2_layer3_experts_group6&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge359" class="edge">
<title>stage2_layer3_experts_group6&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-12365.77C2597.83,-12317.97 2597.83,-12246 2597.83,-12246 2597.83,-12246 1996.87,-12246 1996.87,-12246"/>
<polygon fill="black" stroke="black" points="1996.87,-12242.5 1986.87,-12246 1996.87,-12249.5 1996.87,-12242.5"/>
</g>
<!-- stage2_layer3_experts_group7&#45;&gt;stage2_layer3_expert_combine -->
<g id="edge361" class="edge">
<title>stage2_layer3_experts_group7&#45;&gt;stage2_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-12365.37C2990.83,-12308.51 2990.83,-12214 2990.83,-12214 2990.83,-12214 1994.29,-12214 1994.29,-12214"/>
<polygon fill="black" stroke="black" points="1994.29,-12210.5 1984.29,-12214 1994.29,-12217.5 1994.29,-12210.5"/>
</g>
<!-- stage2_layer3_mlp_fc1 -->
<g id="node277" class="node">
<title>stage2_layer3_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-12095.64 1590,-12095.64 1590,-12027.64 1922,-12027.64 1922,-12095.64"/>
<text text-anchor="middle" x="1756" y="-12080.44" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-12065.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-12050.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-12035.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer3_expert_combine&#45;&gt;stage2_layer3_mlp_fc1 -->
<g id="edge369" class="edge">
<title>stage2_layer3_expert_combine&#45;&gt;stage2_layer3_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-12182.27C1756,-12182.27 1756,-12105.88 1756,-12105.88"/>
<polygon fill="black" stroke="black" points="1759.5,-12105.88 1756,-12095.88 1752.5,-12105.88 1759.5,-12105.88"/>
</g>
<!-- stage2_layer3_mlp_gelu -->
<g id="node278" class="node">
<title>stage2_layer3_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-11940.64 1603.5,-11940.64 1603.5,-11872.64 1908.5,-11872.64 1908.5,-11940.64"/>
<text text-anchor="middle" x="1756" y="-11925.44" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-11910.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-11895.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-11880.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage2_layer3_mlp_fc1&#45;&gt;stage2_layer3_mlp_gelu -->
<g id="edge370" class="edge">
<title>stage2_layer3_mlp_fc1&#45;&gt;stage2_layer3_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-12027.63C1756,-12027.63 1756,-11950.85 1756,-11950.85"/>
<polygon fill="black" stroke="black" points="1759.5,-11950.85 1756,-11940.85 1752.5,-11950.85 1759.5,-11950.85"/>
</g>
<!-- stage2_layer3_mlp_fc2 -->
<g id="node279" class="node">
<title>stage2_layer3_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-11785.64 1588.5,-11785.64 1588.5,-11717.64 1923.5,-11717.64 1923.5,-11785.64"/>
<text text-anchor="middle" x="1756" y="-11770.44" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-11755.44" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-11740.44" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-11725.44" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage2_layer3_mlp_gelu&#45;&gt;stage2_layer3_mlp_fc2 -->
<g id="edge371" class="edge">
<title>stage2_layer3_mlp_gelu&#45;&gt;stage2_layer3_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-11872.63C1756,-11872.63 1756,-11795.85 1756,-11795.85"/>
<polygon fill="black" stroke="black" points="1759.5,-11795.85 1756,-11785.85 1752.5,-11795.85 1759.5,-11795.85"/>
</g>
<!-- stage2_layer3_mlp_allreduce -->
<g id="node280" class="node">
<title>stage2_layer3_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-11582.56" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-11601.36" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-11586.36" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-11571.36" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-11556.36" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_mlp_fc2&#45;&gt;stage2_layer3_mlp_allreduce -->
<g id="edge372" class="edge">
<title>stage2_layer3_mlp_fc2&#45;&gt;stage2_layer3_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-11717.43C1756,-11717.43 1756,-11640.82 1756,-11640.82"/>
<polygon fill="black" stroke="black" points="1759.5,-11640.82 1756,-11630.82 1752.5,-11640.82 1759.5,-11640.82"/>
</g>
<!-- stage2_layer3_mlp_end -->
<g id="node281" class="node">
<title>stage2_layer3_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-11447.48 1584,-11447.48 1584,-11379.48 1928,-11379.48 1928,-11447.48"/>
<text text-anchor="middle" x="1756" y="-11432.28" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-11417.28" font-family="Times,serif" font-size="14.00">GPU 256&#45;287</text>
<text text-anchor="middle" x="1756" y="-11402.28" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-11387.28" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_mlp_allreduce&#45;&gt;stage2_layer3_mlp_end -->
<g id="edge373" class="edge">
<title>stage2_layer3_mlp_allreduce&#45;&gt;stage2_layer3_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-11534.11C1756,-11534.11 1756,-11457.71 1756,-11457.71"/>
<polygon fill="black" stroke="black" points="1759.5,-11457.71 1756,-11447.71 1752.5,-11457.71 1759.5,-11457.71"/>
</g>
<!-- stage2_output -->
<g id="node282" class="node">
<title>stage2_output</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-11255" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-11266.3" font-family="Times,serif" font-size="14.00">Stage Output</text>
<text text-anchor="middle" x="1756" y="-11251.3" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-11236.3" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_layer3_mlp_end&#45;&gt;stage2_output -->
<g id="edge375" class="edge">
<title>stage2_layer3_mlp_end&#45;&gt;stage2_output</title>
<path fill="none" stroke="black" d="M1756,-11379.09C1756,-11379.09 1756,-11302.65 1756,-11302.65"/>
<polygon fill="black" stroke="black" points="1759.5,-11302.65 1756,-11292.65 1752.5,-11302.65 1759.5,-11302.65"/>
</g>
<!-- stage3_input -->
<g id="node283" class="node">
<title>stage3_input</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-11064.05" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-11075.35" font-family="Times,serif" font-size="14.00">Input</text>
<text text-anchor="middle" x="1756" y="-11060.35" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-11045.35" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage2_output&#45;&gt;stage3_input -->
<g id="edge503" class="edge">
<title>stage2_output&#45;&gt;stage3_input</title>
<path fill="none" stroke="black" d="M1756,-11217.27C1756,-11217.27 1756,-11111.7 1756,-11111.7"/>
<polygon fill="black" stroke="black" points="1759.5,-11111.7 1756,-11101.7 1752.5,-11111.7 1759.5,-11111.7"/>
<text text-anchor="middle" x="1890" y="-11163.32" font-family="Times,serif" font-size="14.00">Pipeline Communication</text>
<text text-anchor="middle" x="1890" y="-11148.32" font-family="Times,serif" font-size="14.00">[batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_attention_start -->
<g id="node284" class="node">
<title>stage3_layer0_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-10939.57 1584,-10939.57 1584,-10871.57 1928,-10871.57 1928,-10939.57"/>
<text text-anchor="middle" x="1756" y="-10924.37" font-family="Times,serif" font-size="14.00">Attention Start (Layer 0)</text>
<text text-anchor="middle" x="1756" y="-10909.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-10894.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-10879.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_input&#45;&gt;stage3_layer0_attention_start -->
<g id="edge406" class="edge">
<title>stage3_input&#45;&gt;stage3_layer0_attention_start</title>
<path fill="none" stroke="black" d="M1756,-11026.49C1756,-11026.49 1756,-10949.62 1756,-10949.62"/>
<polygon fill="black" stroke="black" points="1759.5,-10949.62 1756,-10939.62 1752.5,-10949.62 1759.5,-10949.62"/>
</g>
<!-- stage3_layer0_qkv_proj -->
<g id="node285" class="node">
<title>stage3_layer0_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-10784.57 1569.5,-10784.57 1569.5,-10716.57 1942.5,-10716.57 1942.5,-10784.57"/>
<text text-anchor="middle" x="1756" y="-10769.37" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-10754.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-10739.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-10724.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer0_attention_start&#45;&gt;stage3_layer0_qkv_proj -->
<g id="edge394" class="edge">
<title>stage3_layer0_attention_start&#45;&gt;stage3_layer0_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-10871.56C1756,-10871.56 1756,-10794.77 1756,-10794.77"/>
<polygon fill="black" stroke="black" points="1759.5,-10794.77 1756,-10784.77 1752.5,-10794.77 1759.5,-10794.77"/>
</g>
<!-- stage3_layer0_attention_compute -->
<g id="node286" class="node">
<title>stage3_layer0_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-10629.57 1569.5,-10629.57 1569.5,-10561.57 1942.5,-10561.57 1942.5,-10629.57"/>
<text text-anchor="middle" x="1756" y="-10614.37" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-10599.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-10584.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-10569.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer0_qkv_proj&#45;&gt;stage3_layer0_attention_compute -->
<g id="edge395" class="edge">
<title>stage3_layer0_qkv_proj&#45;&gt;stage3_layer0_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-10716.56C1756,-10716.56 1756,-10639.77 1756,-10639.77"/>
<polygon fill="black" stroke="black" points="1759.5,-10639.77 1756,-10629.77 1752.5,-10639.77 1759.5,-10639.77"/>
</g>
<!-- stage3_layer0_attention_out -->
<g id="node287" class="node">
<title>stage3_layer0_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-10474.57 1575.5,-10474.57 1575.5,-10406.57 1936.5,-10406.57 1936.5,-10474.57"/>
<text text-anchor="middle" x="1756" y="-10459.37" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-10444.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-10429.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-10414.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer0_attention_compute&#45;&gt;stage3_layer0_attention_out -->
<g id="edge396" class="edge">
<title>stage3_layer0_attention_compute&#45;&gt;stage3_layer0_attention_out</title>
<path fill="none" stroke="black" d="M1756,-10561.56C1756,-10561.56 1756,-10484.77 1756,-10484.77"/>
<polygon fill="black" stroke="black" points="1759.5,-10484.77 1756,-10474.77 1752.5,-10484.77 1759.5,-10484.77"/>
</g>
<!-- stage3_layer0_attention_allreduce -->
<g id="node288" class="node">
<title>stage3_layer0_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-10271.49" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-10290.29" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-10275.29" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-10260.29" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-10245.29" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_attention_out&#45;&gt;stage3_layer0_attention_allreduce -->
<g id="edge397" class="edge">
<title>stage3_layer0_attention_out&#45;&gt;stage3_layer0_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-10406.35C1756,-10406.35 1756,-10329.75 1756,-10329.75"/>
<polygon fill="black" stroke="black" points="1759.5,-10329.75 1756,-10319.75 1752.5,-10329.75 1759.5,-10329.75"/>
</g>
<!-- stage3_layer0_attention_residual -->
<g id="node289" class="node">
<title>stage3_layer0_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-10136.4 1584,-10136.4 1584,-10068.4 1928,-10068.4 1928,-10136.4"/>
<text text-anchor="middle" x="1756" y="-10121.2" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-10106.2" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-10091.2" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-10076.2" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_attention_allreduce&#45;&gt;stage3_layer0_attention_residual -->
<g id="edge398" class="edge">
<title>stage3_layer0_attention_allreduce&#45;&gt;stage3_layer0_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-10223.04C1756,-10223.04 1756,-10146.64 1756,-10146.64"/>
<polygon fill="black" stroke="black" points="1759.5,-10146.64 1756,-10136.64 1752.5,-10146.64 1759.5,-10146.64"/>
</g>
<!-- stage3_layer0_layernorm2 -->
<g id="node290" class="node">
<title>stage3_layer0_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-9981.4 1584,-9981.4 1584,-9913.4 1928,-9913.4 1928,-9981.4"/>
<text text-anchor="middle" x="1756" y="-9966.2" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-9951.2" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-9936.2" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-9921.2" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_attention_residual&#45;&gt;stage3_layer0_layernorm2 -->
<g id="edge399" class="edge">
<title>stage3_layer0_attention_residual&#45;&gt;stage3_layer0_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-10068.39C1756,-10068.39 1756,-9991.61 1756,-9991.61"/>
<polygon fill="black" stroke="black" points="1759.5,-9991.61 1756,-9981.61 1752.5,-9991.61 1759.5,-9991.61"/>
</g>
<!-- stage3_layer0_moe_gate -->
<g id="node291" class="node">
<title>stage3_layer0_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-9826.4 1552.53,-9826.4 1411.6,-9690.4 1959.47,-9690.4 2100.4,-9826.4"/>
<text text-anchor="middle" x="1756" y="-9777.2" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-9762.2" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-9747.2" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-9732.2" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage3_layer0_layernorm2&#45;&gt;stage3_layer0_moe_gate -->
<g id="edge400" class="edge">
<title>stage3_layer0_layernorm2&#45;&gt;stage3_layer0_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-9913.18C1756,-9913.18 1756,-9836.44 1756,-9836.44"/>
<polygon fill="black" stroke="black" points="1759.5,-9836.44 1756,-9826.44 1752.5,-9836.44 1759.5,-9836.44"/>
</g>
<!-- stage3_layer0_expert_dispatch -->
<g id="node292" class="node">
<title>stage3_layer0_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-9555.32" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-9574.12" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-9559.12" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-9544.12" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-9529.12" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_moe_gate&#45;&gt;stage3_layer0_expert_dispatch -->
<g id="edge376" class="edge">
<title>stage3_layer0_moe_gate&#45;&gt;stage3_layer0_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-9690.22C1756,-9690.22 1756,-9613.45 1756,-9613.45"/>
<polygon fill="black" stroke="black" points="1759.5,-9613.45 1756,-9603.45 1752.5,-9613.45 1759.5,-9613.45"/>
</g>
<!-- stage3_layer0_experts_group0 -->
<g id="node293" class="node">
<title>stage3_layer0_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-9420.24 16.5,-9420.24 16.5,-9337.24 351.5,-9337.24 351.5,-9420.24"/>
<text text-anchor="middle" x="184" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;387</text>
<text text-anchor="middle" x="184" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group0 -->
<g id="edge378" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group0</title>
<path fill="none" stroke="black" d="M1549.42,-9579C1111.19,-9579 128.17,-9579 128.17,-9579 128.17,-9579 128.17,-9430.72 128.17,-9430.72"/>
<polygon fill="black" stroke="black" points="131.67,-9430.72 128.17,-9420.72 124.67,-9430.72 131.67,-9430.72"/>
</g>
<!-- stage3_layer0_experts_group1 -->
<g id="node294" class="node">
<title>stage3_layer0_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-9420.24 409.5,-9420.24 409.5,-9337.24 744.5,-9337.24 744.5,-9420.24"/>
<text text-anchor="middle" x="577" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 388&#45;391</text>
<text text-anchor="middle" x="577" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group1 -->
<g id="edge380" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-9555C1160.38,-9555 521.17,-9555 521.17,-9555 521.17,-9555 521.17,-9430.51 521.17,-9430.51"/>
<polygon fill="black" stroke="black" points="524.67,-9430.51 521.17,-9420.51 517.67,-9430.51 524.67,-9430.51"/>
</g>
<!-- stage3_layer0_experts_group2 -->
<g id="node295" class="node">
<title>stage3_layer0_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-9420.24 802.5,-9420.24 802.5,-9337.24 1137.5,-9337.24 1137.5,-9420.24"/>
<text text-anchor="middle" x="970" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 392&#45;395</text>
<text text-anchor="middle" x="970" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group2 -->
<g id="edge382" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group2</title>
<path fill="none" stroke="black" d="M1551.41,-9531C1302.23,-9531 914.17,-9531 914.17,-9531 914.17,-9531 914.17,-9430.34 914.17,-9430.34"/>
<polygon fill="black" stroke="black" points="917.67,-9430.34 914.17,-9420.34 910.67,-9430.34 917.67,-9430.34"/>
</g>
<!-- stage3_layer0_experts_group3 -->
<g id="node296" class="node">
<title>stage3_layer0_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-9420.24 1195.5,-9420.24 1195.5,-9337.24 1530.5,-9337.24 1530.5,-9420.24"/>
<text text-anchor="middle" x="1363" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 396&#45;399</text>
<text text-anchor="middle" x="1363" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group3 -->
<g id="edge384" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-9544.8C1524.81,-9544.8 1524.81,-9430.49 1524.81,-9430.49"/>
<polygon fill="black" stroke="black" points="1528.31,-9430.49 1524.81,-9420.49 1521.31,-9430.49 1528.31,-9430.49"/>
</g>
<!-- stage3_layer0_experts_group4 -->
<g id="node297" class="node">
<title>stage3_layer0_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-9420.24 1588.5,-9420.24 1588.5,-9337.24 1923.5,-9337.24 1923.5,-9420.24"/>
<text text-anchor="middle" x="1756" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 400&#45;403</text>
<text text-anchor="middle" x="1756" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group4 -->
<g id="edge386" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-9507.07C1756,-9507.07 1756,-9430.33 1756,-9430.33"/>
<polygon fill="black" stroke="black" points="1759.5,-9430.33 1756,-9420.33 1752.5,-9430.33 1759.5,-9430.33"/>
</g>
<!-- stage3_layer0_experts_group5 -->
<g id="node298" class="node">
<title>stage3_layer0_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-9420.24 1981.5,-9420.24 1981.5,-9337.24 2316.5,-9337.24 2316.5,-9420.24"/>
<text text-anchor="middle" x="2149" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 404&#45;407</text>
<text text-anchor="middle" x="2149" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group5 -->
<g id="edge388" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-9544.8C1987.19,-9544.8 1987.19,-9430.49 1987.19,-9430.49"/>
<polygon fill="black" stroke="black" points="1990.69,-9430.49 1987.19,-9420.49 1983.69,-9430.49 1990.69,-9430.49"/>
</g>
<!-- stage3_layer0_experts_group6 -->
<g id="node299" class="node">
<title>stage3_layer0_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-9420.24 2374.5,-9420.24 2374.5,-9337.24 2709.5,-9337.24 2709.5,-9420.24"/>
<text text-anchor="middle" x="2542" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 408&#45;411</text>
<text text-anchor="middle" x="2542" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group6 -->
<g id="edge390" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group6</title>
<path fill="none" stroke="black" d="M1979.04,-9539C2193.77,-9539 2486.17,-9539 2486.17,-9539 2486.17,-9539 2486.17,-9430.43 2486.17,-9430.43"/>
<polygon fill="black" stroke="black" points="2489.67,-9430.43 2486.17,-9420.43 2482.67,-9430.43 2489.67,-9430.43"/>
</g>
<!-- stage3_layer0_experts_group7 -->
<g id="node300" class="node">
<title>stage3_layer0_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-9420.24 2767.5,-9420.24 2767.5,-9337.24 3102.5,-9337.24 3102.5,-9420.24"/>
<text text-anchor="middle" x="2935" y="-9405.04" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-9390.04" font-family="Times,serif" font-size="14.00">GPU 412&#45;415</text>
<text text-anchor="middle" x="2935" y="-9375.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-9360.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-9345.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group7 -->
<g id="edge392" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_experts_group7</title>
<path fill="none" stroke="black" d="M1980.25,-9571C2307.97,-9571 2879.17,-9571 2879.17,-9571 2879.17,-9571 2879.17,-9430.46 2879.17,-9430.46"/>
<polygon fill="black" stroke="black" points="2882.67,-9430.46 2879.17,-9420.46 2875.67,-9430.46 2882.67,-9430.46"/>
</g>
<!-- stage3_layer0_expert_combine -->
<g id="node301" class="node">
<title>stage3_layer0_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-9202.15" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-9220.95" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-9205.95" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-9190.95" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-9175.95" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge377" class="edge">
<title>stage3_layer0_expert_dispatch&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-9528.2C1559.5,-9528.2 1559.5,-9240.85 1559.5,-9240.85"/>
<polygon fill="black" stroke="black" points="1563,-9240.85 1559.5,-9230.85 1556,-9240.85 1563,-9240.85"/>
</g>
<!-- stage3_layer0_experts_group0&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge379" class="edge">
<title>stage3_layer0_experts_group0&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-9337.14C239.83,-9278.35 239.83,-9178 239.83,-9178 239.83,-9178 1535.58,-9178 1535.58,-9178"/>
<polygon fill="black" stroke="black" points="1535.58,-9181.5 1545.58,-9178 1535.58,-9174.5 1535.58,-9181.5"/>
</g>
<!-- stage3_layer0_experts_group1&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge381" class="edge">
<title>stage3_layer0_experts_group1&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-9336.85C632.83,-9284.59 632.83,-9202 632.83,-9202 632.83,-9202 1502.64,-9202 1502.64,-9202"/>
<polygon fill="black" stroke="black" points="1502.64,-9205.5 1512.64,-9202 1502.64,-9198.5 1502.64,-9205.5"/>
</g>
<!-- stage3_layer0_experts_group2&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge383" class="edge">
<title>stage3_layer0_experts_group2&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-9337C1025.83,-9291.78 1025.83,-9226 1025.83,-9226 1025.83,-9226 1534.32,-9226 1534.32,-9226"/>
<polygon fill="black" stroke="black" points="1534.32,-9229.5 1544.32,-9226 1534.32,-9222.5 1534.32,-9229.5"/>
</g>
<!-- stage3_layer0_experts_group3&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge385" class="edge">
<title>stage3_layer0_experts_group3&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-9336.89C1521.63,-9336.89 1521.63,-9225.07 1521.63,-9225.07"/>
<polygon fill="black" stroke="black" points="1525.13,-9225.07 1521.63,-9215.07 1518.13,-9225.07 1525.13,-9225.07"/>
</g>
<!-- stage3_layer0_experts_group4&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge387" class="edge">
<title>stage3_layer0_experts_group4&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-9336.89C1756,-9336.89 1756,-9260.26 1756,-9260.26"/>
<polygon fill="black" stroke="black" points="1759.5,-9260.26 1756,-9250.26 1752.5,-9260.26 1759.5,-9260.26"/>
</g>
<!-- stage3_layer0_experts_group5&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge389" class="edge">
<title>stage3_layer0_experts_group5&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-9336.89C1990.37,-9336.89 1990.37,-9225.07 1990.37,-9225.07"/>
<polygon fill="black" stroke="black" points="1993.87,-9225.07 1990.37,-9215.07 1986.87,-9225.07 1993.87,-9225.07"/>
</g>
<!-- stage3_layer0_experts_group6&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge391" class="edge">
<title>stage3_layer0_experts_group6&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-9336.93C2597.83,-9289.3 2597.83,-9218 2597.83,-9218 2597.83,-9218 1995.76,-9218 1995.76,-9218"/>
<polygon fill="black" stroke="black" points="1995.76,-9214.5 1985.76,-9218 1995.76,-9221.5 1995.76,-9214.5"/>
</g>
<!-- stage3_layer0_experts_group7&#45;&gt;stage3_layer0_expert_combine -->
<g id="edge393" class="edge">
<title>stage3_layer0_experts_group7&#45;&gt;stage3_layer0_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-9336.92C2990.83,-9280.23 2990.83,-9186 2990.83,-9186 2990.83,-9186 1995.37,-9186 1995.37,-9186"/>
<polygon fill="black" stroke="black" points="1995.37,-9182.5 1985.37,-9186 1995.37,-9189.5 1995.37,-9182.5"/>
</g>
<!-- stage3_layer0_mlp_fc1 -->
<g id="node302" class="node">
<title>stage3_layer0_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-9067.07 1590,-9067.07 1590,-8999.07 1922,-8999.07 1922,-9067.07"/>
<text text-anchor="middle" x="1756" y="-9051.87" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-9036.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-9021.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-9006.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer0_expert_combine&#45;&gt;stage3_layer0_mlp_fc1 -->
<g id="edge401" class="edge">
<title>stage3_layer0_expert_combine&#45;&gt;stage3_layer0_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-9153.7C1756,-9153.7 1756,-9077.31 1756,-9077.31"/>
<polygon fill="black" stroke="black" points="1759.5,-9077.31 1756,-9067.31 1752.5,-9077.31 1759.5,-9077.31"/>
</g>
<!-- stage3_layer0_mlp_gelu -->
<g id="node303" class="node">
<title>stage3_layer0_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-8912.07 1603.5,-8912.07 1603.5,-8844.07 1908.5,-8844.07 1908.5,-8912.07"/>
<text text-anchor="middle" x="1756" y="-8896.87" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-8881.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-8866.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-8851.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer0_mlp_fc1&#45;&gt;stage3_layer0_mlp_gelu -->
<g id="edge402" class="edge">
<title>stage3_layer0_mlp_fc1&#45;&gt;stage3_layer0_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-8999.06C1756,-8999.06 1756,-8922.27 1756,-8922.27"/>
<polygon fill="black" stroke="black" points="1759.5,-8922.27 1756,-8912.27 1752.5,-8922.28 1759.5,-8922.27"/>
</g>
<!-- stage3_layer0_mlp_fc2 -->
<g id="node304" class="node">
<title>stage3_layer0_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-8757.07 1588.5,-8757.07 1588.5,-8689.07 1923.5,-8689.07 1923.5,-8757.07"/>
<text text-anchor="middle" x="1756" y="-8741.87" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-8726.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-8711.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-8696.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer0_mlp_gelu&#45;&gt;stage3_layer0_mlp_fc2 -->
<g id="edge403" class="edge">
<title>stage3_layer0_mlp_gelu&#45;&gt;stage3_layer0_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-8844.06C1756,-8844.06 1756,-8767.27 1756,-8767.27"/>
<polygon fill="black" stroke="black" points="1759.5,-8767.27 1756,-8757.27 1752.5,-8767.28 1759.5,-8767.27"/>
</g>
<!-- stage3_layer0_mlp_allreduce -->
<g id="node305" class="node">
<title>stage3_layer0_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-8553.99" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-8572.79" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-8557.79" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-8542.79" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-8527.79" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_mlp_fc2&#45;&gt;stage3_layer0_mlp_allreduce -->
<g id="edge404" class="edge">
<title>stage3_layer0_mlp_fc2&#45;&gt;stage3_layer0_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-8688.85C1756,-8688.85 1756,-8612.25 1756,-8612.25"/>
<polygon fill="black" stroke="black" points="1759.5,-8612.25 1756,-8602.25 1752.5,-8612.25 1759.5,-8612.25"/>
</g>
<!-- stage3_layer0_mlp_end -->
<g id="node306" class="node">
<title>stage3_layer0_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-8418.9 1584,-8418.9 1584,-8350.9 1928,-8350.9 1928,-8418.9"/>
<text text-anchor="middle" x="1756" y="-8403.7" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-8388.7" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-8373.7" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-8358.7" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_mlp_allreduce&#45;&gt;stage3_layer0_mlp_end -->
<g id="edge405" class="edge">
<title>stage3_layer0_mlp_allreduce&#45;&gt;stage3_layer0_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-8505.54C1756,-8505.54 1756,-8429.14 1756,-8429.14"/>
<polygon fill="black" stroke="black" points="1759.5,-8429.14 1756,-8419.14 1752.5,-8429.14 1759.5,-8429.14"/>
</g>
<!-- stage3_layer1_attention_start -->
<g id="node307" class="node">
<title>stage3_layer1_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-8263.9 1584,-8263.9 1584,-8195.9 1928,-8195.9 1928,-8263.9"/>
<text text-anchor="middle" x="1756" y="-8248.7" font-family="Times,serif" font-size="14.00">Attention Start (Layer 1)</text>
<text text-anchor="middle" x="1756" y="-8233.7" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-8218.7" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-8203.7" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer0_mlp_end&#45;&gt;stage3_layer1_attention_start -->
<g id="edge437" class="edge">
<title>stage3_layer0_mlp_end&#45;&gt;stage3_layer1_attention_start</title>
<path fill="none" stroke="black" d="M1756,-8350.89C1756,-8350.89 1756,-8274.11 1756,-8274.11"/>
<polygon fill="black" stroke="black" points="1759.5,-8274.11 1756,-8264.11 1752.5,-8274.11 1759.5,-8274.11"/>
</g>
<!-- stage3_layer1_qkv_proj -->
<g id="node308" class="node">
<title>stage3_layer1_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-8108.9 1569.5,-8108.9 1569.5,-8040.9 1942.5,-8040.9 1942.5,-8108.9"/>
<text text-anchor="middle" x="1756" y="-8093.7" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-8078.7" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-8063.7" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-8048.7" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer1_attention_start&#45;&gt;stage3_layer1_qkv_proj -->
<g id="edge425" class="edge">
<title>stage3_layer1_attention_start&#45;&gt;stage3_layer1_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-8195.89C1756,-8195.89 1756,-8119.11 1756,-8119.11"/>
<polygon fill="black" stroke="black" points="1759.5,-8119.11 1756,-8109.11 1752.5,-8119.11 1759.5,-8119.11"/>
</g>
<!-- stage3_layer1_attention_compute -->
<g id="node309" class="node">
<title>stage3_layer1_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-7953.9 1569.5,-7953.9 1569.5,-7885.9 1942.5,-7885.9 1942.5,-7953.9"/>
<text text-anchor="middle" x="1756" y="-7938.7" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-7923.7" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-7908.7" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-7893.7" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer1_qkv_proj&#45;&gt;stage3_layer1_attention_compute -->
<g id="edge426" class="edge">
<title>stage3_layer1_qkv_proj&#45;&gt;stage3_layer1_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-8040.89C1756,-8040.89 1756,-7964.11 1756,-7964.11"/>
<polygon fill="black" stroke="black" points="1759.5,-7964.11 1756,-7954.11 1752.5,-7964.11 1759.5,-7964.11"/>
</g>
<!-- stage3_layer1_attention_out -->
<g id="node310" class="node">
<title>stage3_layer1_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-7798.9 1575.5,-7798.9 1575.5,-7730.9 1936.5,-7730.9 1936.5,-7798.9"/>
<text text-anchor="middle" x="1756" y="-7783.7" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-7768.7" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-7753.7" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-7738.7" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer1_attention_compute&#45;&gt;stage3_layer1_attention_out -->
<g id="edge427" class="edge">
<title>stage3_layer1_attention_compute&#45;&gt;stage3_layer1_attention_out</title>
<path fill="none" stroke="black" d="M1756,-7885.89C1756,-7885.89 1756,-7809.11 1756,-7809.11"/>
<polygon fill="black" stroke="black" points="1759.5,-7809.11 1756,-7799.11 1752.5,-7809.11 1759.5,-7809.11"/>
</g>
<!-- stage3_layer1_attention_allreduce -->
<g id="node311" class="node">
<title>stage3_layer1_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-7595.82" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-7614.62" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-7599.62" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-7584.62" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-7569.62" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_attention_out&#45;&gt;stage3_layer1_attention_allreduce -->
<g id="edge428" class="edge">
<title>stage3_layer1_attention_out&#45;&gt;stage3_layer1_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-7730.69C1756,-7730.69 1756,-7654.08 1756,-7654.08"/>
<polygon fill="black" stroke="black" points="1759.5,-7654.08 1756,-7644.08 1752.5,-7654.08 1759.5,-7654.08"/>
</g>
<!-- stage3_layer1_attention_residual -->
<g id="node312" class="node">
<title>stage3_layer1_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-7460.74 1584,-7460.74 1584,-7392.74 1928,-7392.74 1928,-7460.74"/>
<text text-anchor="middle" x="1756" y="-7445.54" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-7430.54" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-7415.54" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-7400.54" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_attention_allreduce&#45;&gt;stage3_layer1_attention_residual -->
<g id="edge429" class="edge">
<title>stage3_layer1_attention_allreduce&#45;&gt;stage3_layer1_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-7547.37C1756,-7547.37 1756,-7470.97 1756,-7470.97"/>
<polygon fill="black" stroke="black" points="1759.5,-7470.97 1756,-7460.97 1752.5,-7470.97 1759.5,-7470.97"/>
</g>
<!-- stage3_layer1_layernorm2 -->
<g id="node313" class="node">
<title>stage3_layer1_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-7305.74 1584,-7305.74 1584,-7237.74 1928,-7237.74 1928,-7305.74"/>
<text text-anchor="middle" x="1756" y="-7290.54" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-7275.54" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-7260.54" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-7245.54" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_attention_residual&#45;&gt;stage3_layer1_layernorm2 -->
<g id="edge430" class="edge">
<title>stage3_layer1_attention_residual&#45;&gt;stage3_layer1_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-7392.72C1756,-7392.72 1756,-7315.94 1756,-7315.94"/>
<polygon fill="black" stroke="black" points="1759.5,-7315.94 1756,-7305.94 1752.5,-7315.94 1759.5,-7315.94"/>
</g>
<!-- stage3_layer1_moe_gate -->
<g id="node314" class="node">
<title>stage3_layer1_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-7150.74 1552.53,-7150.74 1411.6,-7014.74 1959.47,-7014.74 2100.4,-7150.74"/>
<text text-anchor="middle" x="1756" y="-7101.54" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-7086.54" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-7071.54" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-7056.54" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage3_layer1_layernorm2&#45;&gt;stage3_layer1_moe_gate -->
<g id="edge431" class="edge">
<title>stage3_layer1_layernorm2&#45;&gt;stage3_layer1_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-7237.51C1756,-7237.51 1756,-7160.77 1756,-7160.77"/>
<polygon fill="black" stroke="black" points="1759.5,-7160.77 1756,-7150.77 1752.5,-7160.77 1759.5,-7160.77"/>
</g>
<!-- stage3_layer1_expert_dispatch -->
<g id="node315" class="node">
<title>stage3_layer1_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-6879.66" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-6898.46" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-6883.46" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-6868.46" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-6853.46" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_moe_gate&#45;&gt;stage3_layer1_expert_dispatch -->
<g id="edge407" class="edge">
<title>stage3_layer1_moe_gate&#45;&gt;stage3_layer1_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-7014.55C1756,-7014.55 1756,-6937.78 1756,-6937.78"/>
<polygon fill="black" stroke="black" points="1759.5,-6937.78 1756,-6927.78 1752.5,-6937.78 1759.5,-6937.78"/>
</g>
<!-- stage3_layer1_experts_group0 -->
<g id="node316" class="node">
<title>stage3_layer1_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-6744.57 16.5,-6744.57 16.5,-6661.57 351.5,-6661.57 351.5,-6744.57"/>
<text text-anchor="middle" x="184" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;387</text>
<text text-anchor="middle" x="184" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group0 -->
<g id="edge409" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group0</title>
<path fill="none" stroke="black" d="M1548.59,-6903C1109.95,-6903 128.17,-6903 128.17,-6903 128.17,-6903 128.17,-6754.98 128.17,-6754.98"/>
<polygon fill="black" stroke="black" points="131.67,-6754.98 128.17,-6744.98 124.67,-6754.98 131.67,-6754.98"/>
</g>
<!-- stage3_layer1_experts_group1 -->
<g id="node317" class="node">
<title>stage3_layer1_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-6744.57 409.5,-6744.57 409.5,-6661.57 744.5,-6661.57 744.5,-6744.57"/>
<text text-anchor="middle" x="577" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 388&#45;391</text>
<text text-anchor="middle" x="577" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group1 -->
<g id="edge411" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-6879C1160.38,-6879 521.17,-6879 521.17,-6879 521.17,-6879 521.17,-6754.76 521.17,-6754.76"/>
<polygon fill="black" stroke="black" points="524.67,-6754.76 521.17,-6744.76 517.67,-6754.76 524.67,-6754.76"/>
</g>
<!-- stage3_layer1_experts_group2 -->
<g id="node318" class="node">
<title>stage3_layer1_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-6744.57 802.5,-6744.57 802.5,-6661.57 1137.5,-6661.57 1137.5,-6744.57"/>
<text text-anchor="middle" x="970" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 392&#45;395</text>
<text text-anchor="middle" x="970" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group2 -->
<g id="edge413" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group2</title>
<path fill="none" stroke="black" d="M1552.48,-6855C1303.35,-6855 914.17,-6855 914.17,-6855 914.17,-6855 914.17,-6754.59 914.17,-6754.59"/>
<polygon fill="black" stroke="black" points="917.67,-6754.59 914.17,-6744.59 910.67,-6754.59 917.67,-6754.59"/>
</g>
<!-- stage3_layer1_experts_group3 -->
<g id="node319" class="node">
<title>stage3_layer1_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-6744.57 1195.5,-6744.57 1195.5,-6661.57 1530.5,-6661.57 1530.5,-6744.57"/>
<text text-anchor="middle" x="1363" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 396&#45;399</text>
<text text-anchor="middle" x="1363" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group3 -->
<g id="edge415" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-6869.14C1524.81,-6869.14 1524.81,-6754.83 1524.81,-6754.83"/>
<polygon fill="black" stroke="black" points="1528.31,-6754.83 1524.81,-6744.83 1521.31,-6754.83 1528.31,-6754.83"/>
</g>
<!-- stage3_layer1_experts_group4 -->
<g id="node320" class="node">
<title>stage3_layer1_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-6744.57 1588.5,-6744.57 1588.5,-6661.57 1923.5,-6661.57 1923.5,-6744.57"/>
<text text-anchor="middle" x="1756" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 400&#45;403</text>
<text text-anchor="middle" x="1756" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group4 -->
<g id="edge417" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-6831.4C1756,-6831.4 1756,-6754.67 1756,-6754.67"/>
<polygon fill="black" stroke="black" points="1759.5,-6754.67 1756,-6744.67 1752.5,-6754.67 1759.5,-6754.67"/>
</g>
<!-- stage3_layer1_experts_group5 -->
<g id="node321" class="node">
<title>stage3_layer1_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-6744.57 1981.5,-6744.57 1981.5,-6661.57 2316.5,-6661.57 2316.5,-6744.57"/>
<text text-anchor="middle" x="2149" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 404&#45;407</text>
<text text-anchor="middle" x="2149" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group5 -->
<g id="edge419" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-6869.14C1987.19,-6869.14 1987.19,-6754.83 1987.19,-6754.83"/>
<polygon fill="black" stroke="black" points="1990.69,-6754.83 1987.19,-6744.83 1983.69,-6754.83 1990.69,-6754.83"/>
</g>
<!-- stage3_layer1_experts_group6 -->
<g id="node322" class="node">
<title>stage3_layer1_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-6744.57 2374.5,-6744.57 2374.5,-6661.57 2709.5,-6661.57 2709.5,-6744.57"/>
<text text-anchor="middle" x="2542" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 408&#45;411</text>
<text text-anchor="middle" x="2542" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group6 -->
<g id="edge421" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group6</title>
<path fill="none" stroke="black" d="M1978.54,-6863C2193.32,-6863 2486.17,-6863 2486.17,-6863 2486.17,-6863 2486.17,-6754.67 2486.17,-6754.67"/>
<polygon fill="black" stroke="black" points="2489.67,-6754.67 2486.17,-6744.67 2482.67,-6754.67 2489.67,-6754.67"/>
</g>
<!-- stage3_layer1_experts_group7 -->
<g id="node323" class="node">
<title>stage3_layer1_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-6744.57 2767.5,-6744.57 2767.5,-6661.57 3102.5,-6661.57 3102.5,-6744.57"/>
<text text-anchor="middle" x="2935" y="-6729.37" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-6714.37" font-family="Times,serif" font-size="14.00">GPU 412&#45;415</text>
<text text-anchor="middle" x="2935" y="-6699.37" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-6684.37" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-6669.37" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group7 -->
<g id="edge423" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_experts_group7</title>
<path fill="none" stroke="black" d="M1980.59,-6895C2308.36,-6895 2879.17,-6895 2879.17,-6895 2879.17,-6895 2879.17,-6754.72 2879.17,-6754.72"/>
<polygon fill="black" stroke="black" points="2882.67,-6754.72 2879.17,-6744.72 2875.67,-6754.72 2882.67,-6754.72"/>
</g>
<!-- stage3_layer1_expert_combine -->
<g id="node324" class="node">
<title>stage3_layer1_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-6526.49" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-6545.29" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-6530.29" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-6515.29" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-6500.29" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge408" class="edge">
<title>stage3_layer1_expert_dispatch&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-6852.53C1559.5,-6852.53 1559.5,-6565.18 1559.5,-6565.18"/>
<polygon fill="black" stroke="black" points="1563,-6565.18 1559.5,-6555.18 1556,-6565.18 1563,-6565.18"/>
</g>
<!-- stage3_layer1_experts_group0&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge410" class="edge">
<title>stage3_layer1_experts_group0&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-6661.41C239.83,-6602.51 239.83,-6502 239.83,-6502 239.83,-6502 1536.38,-6502 1536.38,-6502"/>
<polygon fill="black" stroke="black" points="1536.38,-6505.5 1546.38,-6502 1536.38,-6498.5 1536.38,-6505.5"/>
</g>
<!-- stage3_layer1_experts_group1&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge412" class="edge">
<title>stage3_layer1_experts_group1&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-6661.56C632.83,-6609.22 632.83,-6526 632.83,-6526 632.83,-6526 1502.64,-6526 1502.64,-6526"/>
<polygon fill="black" stroke="black" points="1502.64,-6529.5 1512.64,-6526 1502.64,-6522.5 1502.64,-6529.5"/>
</g>
<!-- stage3_layer1_experts_group2&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge414" class="edge">
<title>stage3_layer1_experts_group2&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-6661.24C1025.83,-6615.92 1025.83,-6550 1025.83,-6550 1025.83,-6550 1533.33,-6550 1533.33,-6550"/>
<polygon fill="black" stroke="black" points="1533.33,-6553.5 1543.33,-6550 1533.33,-6546.5 1533.33,-6553.5"/>
</g>
<!-- stage3_layer1_experts_group3&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge416" class="edge">
<title>stage3_layer1_experts_group3&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-6661.22C1521.63,-6661.22 1521.63,-6549.41 1521.63,-6549.41"/>
<polygon fill="black" stroke="black" points="1525.13,-6549.41 1521.63,-6539.41 1518.13,-6549.41 1525.13,-6549.41"/>
</g>
<!-- stage3_layer1_experts_group4&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge418" class="edge">
<title>stage3_layer1_experts_group4&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-6661.22C1756,-6661.22 1756,-6584.59 1756,-6584.59"/>
<polygon fill="black" stroke="black" points="1759.5,-6584.59 1756,-6574.59 1752.5,-6584.59 1759.5,-6584.59"/>
</g>
<!-- stage3_layer1_experts_group5&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge420" class="edge">
<title>stage3_layer1_experts_group5&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-6661.22C1990.37,-6661.22 1990.37,-6549.41 1990.37,-6549.41"/>
<polygon fill="black" stroke="black" points="1993.87,-6549.41 1990.37,-6539.41 1986.87,-6549.41 1993.87,-6549.41"/>
</g>
<!-- stage3_layer1_experts_group6&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge422" class="edge">
<title>stage3_layer1_experts_group6&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-6661.17C2597.83,-6613.45 2597.83,-6542 2597.83,-6542 2597.83,-6542 1996.31,-6542 1996.31,-6542"/>
<polygon fill="black" stroke="black" points="1996.31,-6538.5 1986.31,-6542 1996.31,-6545.5 1996.31,-6538.5"/>
</g>
<!-- stage3_layer1_experts_group7&#45;&gt;stage3_layer1_expert_combine -->
<g id="edge424" class="edge">
<title>stage3_layer1_experts_group7&#45;&gt;stage3_layer1_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-6661.18C2990.83,-6604.39 2990.83,-6510 2990.83,-6510 2990.83,-6510 1994.65,-6510 1994.65,-6510"/>
<polygon fill="black" stroke="black" points="1994.65,-6506.5 1984.65,-6510 1994.65,-6513.5 1994.65,-6506.5"/>
</g>
<!-- stage3_layer1_mlp_fc1 -->
<g id="node325" class="node">
<title>stage3_layer1_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-6391.41 1590,-6391.41 1590,-6323.41 1922,-6323.41 1922,-6391.41"/>
<text text-anchor="middle" x="1756" y="-6376.21" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-6361.21" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-6346.21" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-6331.21" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer1_expert_combine&#45;&gt;stage3_layer1_mlp_fc1 -->
<g id="edge432" class="edge">
<title>stage3_layer1_expert_combine&#45;&gt;stage3_layer1_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-6478.04C1756,-6478.04 1756,-6401.64 1756,-6401.64"/>
<polygon fill="black" stroke="black" points="1759.5,-6401.64 1756,-6391.64 1752.5,-6401.64 1759.5,-6401.64"/>
</g>
<!-- stage3_layer1_mlp_gelu -->
<g id="node326" class="node">
<title>stage3_layer1_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-6236.41 1603.5,-6236.41 1603.5,-6168.41 1908.5,-6168.41 1908.5,-6236.41"/>
<text text-anchor="middle" x="1756" y="-6221.21" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-6206.21" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-6191.21" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-6176.21" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer1_mlp_fc1&#45;&gt;stage3_layer1_mlp_gelu -->
<g id="edge433" class="edge">
<title>stage3_layer1_mlp_fc1&#45;&gt;stage3_layer1_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-6323.39C1756,-6323.39 1756,-6246.61 1756,-6246.61"/>
<polygon fill="black" stroke="black" points="1759.5,-6246.61 1756,-6236.61 1752.5,-6246.61 1759.5,-6246.61"/>
</g>
<!-- stage3_layer1_mlp_fc2 -->
<g id="node327" class="node">
<title>stage3_layer1_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-6081.41 1588.5,-6081.41 1588.5,-6013.41 1923.5,-6013.41 1923.5,-6081.41"/>
<text text-anchor="middle" x="1756" y="-6066.21" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-6051.21" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-6036.21" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-6021.21" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer1_mlp_gelu&#45;&gt;stage3_layer1_mlp_fc2 -->
<g id="edge434" class="edge">
<title>stage3_layer1_mlp_gelu&#45;&gt;stage3_layer1_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-6168.39C1756,-6168.39 1756,-6091.61 1756,-6091.61"/>
<polygon fill="black" stroke="black" points="1759.5,-6091.61 1756,-6081.61 1752.5,-6091.61 1759.5,-6091.61"/>
</g>
<!-- stage3_layer1_mlp_allreduce -->
<g id="node328" class="node">
<title>stage3_layer1_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-5878.32" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-5897.12" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-5882.12" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-5867.12" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-5852.12" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_mlp_fc2&#45;&gt;stage3_layer1_mlp_allreduce -->
<g id="edge435" class="edge">
<title>stage3_layer1_mlp_fc2&#45;&gt;stage3_layer1_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-6013.19C1756,-6013.19 1756,-5936.58 1756,-5936.58"/>
<polygon fill="black" stroke="black" points="1759.5,-5936.58 1756,-5926.58 1752.5,-5936.58 1759.5,-5936.58"/>
</g>
<!-- stage3_layer1_mlp_end -->
<g id="node329" class="node">
<title>stage3_layer1_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-5743.24 1584,-5743.24 1584,-5675.24 1928,-5675.24 1928,-5743.24"/>
<text text-anchor="middle" x="1756" y="-5728.04" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-5713.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-5698.04" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-5683.04" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_mlp_allreduce&#45;&gt;stage3_layer1_mlp_end -->
<g id="edge436" class="edge">
<title>stage3_layer1_mlp_allreduce&#45;&gt;stage3_layer1_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-5829.87C1756,-5829.87 1756,-5753.47 1756,-5753.47"/>
<polygon fill="black" stroke="black" points="1759.5,-5753.47 1756,-5743.47 1752.5,-5753.47 1759.5,-5753.47"/>
</g>
<!-- stage3_layer2_attention_start -->
<g id="node330" class="node">
<title>stage3_layer2_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-5588.24 1584,-5588.24 1584,-5520.24 1928,-5520.24 1928,-5588.24"/>
<text text-anchor="middle" x="1756" y="-5573.04" font-family="Times,serif" font-size="14.00">Attention Start (Layer 2)</text>
<text text-anchor="middle" x="1756" y="-5558.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-5543.04" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-5528.04" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer1_mlp_end&#45;&gt;stage3_layer2_attention_start -->
<g id="edge468" class="edge">
<title>stage3_layer1_mlp_end&#45;&gt;stage3_layer2_attention_start</title>
<path fill="none" stroke="black" d="M1756,-5675.22C1756,-5675.22 1756,-5598.44 1756,-5598.44"/>
<polygon fill="black" stroke="black" points="1759.5,-5598.44 1756,-5588.44 1752.5,-5598.44 1759.5,-5598.44"/>
</g>
<!-- stage3_layer2_qkv_proj -->
<g id="node331" class="node">
<title>stage3_layer2_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-5433.24 1569.5,-5433.24 1569.5,-5365.24 1942.5,-5365.24 1942.5,-5433.24"/>
<text text-anchor="middle" x="1756" y="-5418.04" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-5403.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-5388.04" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-5373.04" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer2_attention_start&#45;&gt;stage3_layer2_qkv_proj -->
<g id="edge456" class="edge">
<title>stage3_layer2_attention_start&#45;&gt;stage3_layer2_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-5520.22C1756,-5520.22 1756,-5443.44 1756,-5443.44"/>
<polygon fill="black" stroke="black" points="1759.5,-5443.44 1756,-5433.44 1752.5,-5443.44 1759.5,-5443.44"/>
</g>
<!-- stage3_layer2_attention_compute -->
<g id="node332" class="node">
<title>stage3_layer2_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-5278.24 1569.5,-5278.24 1569.5,-5210.24 1942.5,-5210.24 1942.5,-5278.24"/>
<text text-anchor="middle" x="1756" y="-5263.04" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-5248.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-5233.04" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-5218.04" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer2_qkv_proj&#45;&gt;stage3_layer2_attention_compute -->
<g id="edge457" class="edge">
<title>stage3_layer2_qkv_proj&#45;&gt;stage3_layer2_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-5365.22C1756,-5365.22 1756,-5288.44 1756,-5288.44"/>
<polygon fill="black" stroke="black" points="1759.5,-5288.44 1756,-5278.44 1752.5,-5288.44 1759.5,-5288.44"/>
</g>
<!-- stage3_layer2_attention_out -->
<g id="node333" class="node">
<title>stage3_layer2_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-5123.24 1575.5,-5123.24 1575.5,-5055.24 1936.5,-5055.24 1936.5,-5123.24"/>
<text text-anchor="middle" x="1756" y="-5108.04" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-5093.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-5078.04" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-5063.04" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer2_attention_compute&#45;&gt;stage3_layer2_attention_out -->
<g id="edge458" class="edge">
<title>stage3_layer2_attention_compute&#45;&gt;stage3_layer2_attention_out</title>
<path fill="none" stroke="black" d="M1756,-5210.22C1756,-5210.22 1756,-5133.44 1756,-5133.44"/>
<polygon fill="black" stroke="black" points="1759.5,-5133.44 1756,-5123.44 1752.5,-5133.44 1759.5,-5133.44"/>
</g>
<!-- stage3_layer2_attention_allreduce -->
<g id="node334" class="node">
<title>stage3_layer2_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-4920.16" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-4938.96" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-4923.96" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-4908.96" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-4893.96" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_attention_out&#45;&gt;stage3_layer2_attention_allreduce -->
<g id="edge459" class="edge">
<title>stage3_layer2_attention_out&#45;&gt;stage3_layer2_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-5055.02C1756,-5055.02 1756,-4978.42 1756,-4978.42"/>
<polygon fill="black" stroke="black" points="1759.5,-4978.42 1756,-4968.42 1752.5,-4978.42 1759.5,-4978.42"/>
</g>
<!-- stage3_layer2_attention_residual -->
<g id="node335" class="node">
<title>stage3_layer2_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-4785.07 1584,-4785.07 1584,-4717.07 1928,-4717.07 1928,-4785.07"/>
<text text-anchor="middle" x="1756" y="-4769.87" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-4754.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-4739.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-4724.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_attention_allreduce&#45;&gt;stage3_layer2_attention_residual -->
<g id="edge460" class="edge">
<title>stage3_layer2_attention_allreduce&#45;&gt;stage3_layer2_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-4871.7C1756,-4871.7 1756,-4795.31 1756,-4795.31"/>
<polygon fill="black" stroke="black" points="1759.5,-4795.31 1756,-4785.31 1752.5,-4795.31 1759.5,-4795.31"/>
</g>
<!-- stage3_layer2_layernorm2 -->
<g id="node336" class="node">
<title>stage3_layer2_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-4630.07 1584,-4630.07 1584,-4562.07 1928,-4562.07 1928,-4630.07"/>
<text text-anchor="middle" x="1756" y="-4614.87" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-4599.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-4584.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-4569.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_attention_residual&#45;&gt;stage3_layer2_layernorm2 -->
<g id="edge461" class="edge">
<title>stage3_layer2_attention_residual&#45;&gt;stage3_layer2_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-4717.06C1756,-4717.06 1756,-4640.28 1756,-4640.28"/>
<polygon fill="black" stroke="black" points="1759.5,-4640.28 1756,-4630.28 1752.5,-4640.28 1759.5,-4640.28"/>
</g>
<!-- stage3_layer2_moe_gate -->
<g id="node337" class="node">
<title>stage3_layer2_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-4475.07 1552.53,-4475.07 1411.6,-4339.07 1959.47,-4339.07 2100.4,-4475.07"/>
<text text-anchor="middle" x="1756" y="-4425.87" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-4410.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-4395.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-4380.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage3_layer2_layernorm2&#45;&gt;stage3_layer2_moe_gate -->
<g id="edge462" class="edge">
<title>stage3_layer2_layernorm2&#45;&gt;stage3_layer2_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-4561.85C1756,-4561.85 1756,-4485.11 1756,-4485.11"/>
<polygon fill="black" stroke="black" points="1759.5,-4485.11 1756,-4475.11 1752.5,-4485.11 1759.5,-4485.11"/>
</g>
<!-- stage3_layer2_expert_dispatch -->
<g id="node338" class="node">
<title>stage3_layer2_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-4203.99" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-4222.79" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-4207.79" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-4192.79" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-4177.79" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_moe_gate&#45;&gt;stage3_layer2_expert_dispatch -->
<g id="edge438" class="edge">
<title>stage3_layer2_moe_gate&#45;&gt;stage3_layer2_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-4338.88C1756,-4338.88 1756,-4262.12 1756,-4262.12"/>
<polygon fill="black" stroke="black" points="1759.5,-4262.12 1756,-4252.12 1752.5,-4262.12 1759.5,-4262.12"/>
</g>
<!-- stage3_layer2_experts_group0 -->
<g id="node339" class="node">
<title>stage3_layer2_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-4068.91 16.5,-4068.91 16.5,-3985.91 351.5,-3985.91 351.5,-4068.91"/>
<text text-anchor="middle" x="184" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 384&#45;387</text>
<text text-anchor="middle" x="184" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group0 -->
<g id="edge440" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group0</title>
<path fill="none" stroke="black" d="M1550.66,-4228C1113.04,-4228 128.17,-4228 128.17,-4228 128.17,-4228 128.17,-4078.97 128.17,-4078.97"/>
<polygon fill="black" stroke="black" points="131.67,-4078.97 128.17,-4068.97 124.67,-4078.97 131.67,-4078.97"/>
</g>
<!-- stage3_layer2_experts_group1 -->
<g id="node340" class="node">
<title>stage3_layer2_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-4068.91 409.5,-4068.91 409.5,-3985.91 744.5,-3985.91 744.5,-4068.91"/>
<text text-anchor="middle" x="577" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 388&#45;391</text>
<text text-anchor="middle" x="577" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group1 -->
<g id="edge442" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-4203C1160.38,-4203 521.17,-4203 521.17,-4203 521.17,-4203 521.17,-4079.02 521.17,-4079.02"/>
<polygon fill="black" stroke="black" points="524.67,-4079.02 521.17,-4069.02 517.67,-4079.02 524.67,-4079.02"/>
</g>
<!-- stage3_layer2_experts_group2 -->
<g id="node341" class="node">
<title>stage3_layer2_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-4068.91 802.5,-4068.91 802.5,-3985.91 1137.5,-3985.91 1137.5,-4068.91"/>
<text text-anchor="middle" x="970" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 392&#45;395</text>
<text text-anchor="middle" x="970" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group2 -->
<g id="edge444" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group2</title>
<path fill="none" stroke="black" d="M1553.56,-4179C1304.47,-4179 914.17,-4179 914.17,-4179 914.17,-4179 914.17,-4079.23 914.17,-4079.23"/>
<polygon fill="black" stroke="black" points="917.67,-4079.23 914.17,-4069.23 910.67,-4079.23 917.67,-4079.23"/>
</g>
<!-- stage3_layer2_experts_group3 -->
<g id="node342" class="node">
<title>stage3_layer2_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-4068.91 1195.5,-4068.91 1195.5,-3985.91 1530.5,-3985.91 1530.5,-4068.91"/>
<text text-anchor="middle" x="1363" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 396&#45;399</text>
<text text-anchor="middle" x="1363" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group3 -->
<g id="edge446" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-4193.47C1524.81,-4193.47 1524.81,-4079.16 1524.81,-4079.16"/>
<polygon fill="black" stroke="black" points="1528.31,-4079.16 1524.81,-4069.16 1521.31,-4079.16 1528.31,-4079.16"/>
</g>
<!-- stage3_layer2_experts_group4 -->
<g id="node343" class="node">
<title>stage3_layer2_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-4068.91 1588.5,-4068.91 1588.5,-3985.91 1923.5,-3985.91 1923.5,-4068.91"/>
<text text-anchor="middle" x="1756" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 400&#45;403</text>
<text text-anchor="middle" x="1756" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group4 -->
<g id="edge448" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-4155.74C1756,-4155.74 1756,-4079 1756,-4079"/>
<polygon fill="black" stroke="black" points="1759.5,-4079 1756,-4069 1752.5,-4079 1759.5,-4079"/>
</g>
<!-- stage3_layer2_experts_group5 -->
<g id="node344" class="node">
<title>stage3_layer2_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-4068.91 1981.5,-4068.91 1981.5,-3985.91 2316.5,-3985.91 2316.5,-4068.91"/>
<text text-anchor="middle" x="2149" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 404&#45;407</text>
<text text-anchor="middle" x="2149" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group5 -->
<g id="edge450" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-4193.47C1987.19,-4193.47 1987.19,-4079.16 1987.19,-4079.16"/>
<polygon fill="black" stroke="black" points="1990.69,-4079.16 1987.19,-4069.16 1983.69,-4079.16 1990.69,-4079.16"/>
</g>
<!-- stage3_layer2_experts_group6 -->
<g id="node345" class="node">
<title>stage3_layer2_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-4068.91 2374.5,-4068.91 2374.5,-3985.91 2709.5,-3985.91 2709.5,-4068.91"/>
<text text-anchor="middle" x="2542" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 408&#45;411</text>
<text text-anchor="middle" x="2542" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group6 -->
<g id="edge452" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group6</title>
<path fill="none" stroke="black" d="M1978.05,-4187C2192.87,-4187 2486.17,-4187 2486.17,-4187 2486.17,-4187 2486.17,-4078.92 2486.17,-4078.92"/>
<polygon fill="black" stroke="black" points="2489.67,-4078.92 2486.17,-4068.92 2482.67,-4078.92 2489.67,-4078.92"/>
</g>
<!-- stage3_layer2_experts_group7 -->
<g id="node346" class="node">
<title>stage3_layer2_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-4068.91 2767.5,-4068.91 2767.5,-3985.91 3102.5,-3985.91 3102.5,-4068.91"/>
<text text-anchor="middle" x="2935" y="-4053.71" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-4038.71" font-family="Times,serif" font-size="14.00">GPU 412&#45;415</text>
<text text-anchor="middle" x="2935" y="-4023.71" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-4008.71" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-3993.71" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group7 -->
<g id="edge454" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_experts_group7</title>
<path fill="none" stroke="black" d="M1979.58,-4220C2307.19,-4220 2879.17,-4220 2879.17,-4220 2879.17,-4220 2879.17,-4079.2 2879.17,-4079.2"/>
<polygon fill="black" stroke="black" points="2882.67,-4079.2 2879.17,-4069.2 2875.67,-4079.2 2882.67,-4079.2"/>
</g>
<!-- stage3_layer2_expert_combine -->
<g id="node347" class="node">
<title>stage3_layer2_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-3850.82" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-3869.62" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-3854.62" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-3839.62" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-3824.62" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge439" class="edge">
<title>stage3_layer2_expert_dispatch&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-4176.86C1559.5,-4176.86 1559.5,-3889.51 1559.5,-3889.51"/>
<polygon fill="black" stroke="black" points="1563,-3889.51 1559.5,-3879.51 1556,-3889.51 1563,-3889.51"/>
</g>
<!-- stage3_layer2_experts_group0&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge441" class="edge">
<title>stage3_layer2_experts_group0&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M239.83,-3985.67C239.83,-3926.68 239.83,-3826 239.83,-3826 239.83,-3826 1537.57,-3826 1537.57,-3826"/>
<polygon fill="black" stroke="black" points="1537.57,-3829.5 1547.57,-3826 1537.57,-3822.5 1537.57,-3829.5"/>
</g>
<!-- stage3_layer2_experts_group1&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge443" class="edge">
<title>stage3_layer2_experts_group1&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M632.83,-3985.81C632.83,-3933.38 632.83,-3850 632.83,-3850 632.83,-3850 1502.64,-3850 1502.64,-3850"/>
<polygon fill="black" stroke="black" points="1502.64,-3853.5 1512.64,-3850 1502.64,-3846.5 1502.64,-3853.5"/>
</g>
<!-- stage3_layer2_experts_group2&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge445" class="edge">
<title>stage3_layer2_experts_group2&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1025.83,-3985.89C1025.83,-3940.46 1025.83,-3874 1025.83,-3874 1025.83,-3874 1532.84,-3874 1532.84,-3874"/>
<polygon fill="black" stroke="black" points="1532.84,-3877.5 1542.84,-3874 1532.84,-3870.5 1532.84,-3877.5"/>
</g>
<!-- stage3_layer2_experts_group3&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge447" class="edge">
<title>stage3_layer2_experts_group3&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-3985.56C1521.63,-3985.56 1521.63,-3873.74 1521.63,-3873.74"/>
<polygon fill="black" stroke="black" points="1525.13,-3873.74 1521.63,-3863.74 1518.13,-3873.74 1525.13,-3873.74"/>
</g>
<!-- stage3_layer2_experts_group4&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge449" class="edge">
<title>stage3_layer2_experts_group4&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-3985.56C1756,-3985.56 1756,-3908.93 1756,-3908.93"/>
<polygon fill="black" stroke="black" points="1759.5,-3908.93 1756,-3898.93 1752.5,-3908.93 1759.5,-3908.93"/>
</g>
<!-- stage3_layer2_experts_group5&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge451" class="edge">
<title>stage3_layer2_experts_group5&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-3985.56C1990.37,-3985.56 1990.37,-3873.74 1990.37,-3873.74"/>
<polygon fill="black" stroke="black" points="1993.87,-3873.74 1990.37,-3863.74 1986.87,-3873.74 1993.87,-3873.74"/>
</g>
<!-- stage3_layer2_experts_group6&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge453" class="edge">
<title>stage3_layer2_experts_group6&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2597.83,-3985.84C2597.83,-3938.02 2597.83,-3866 2597.83,-3866 2597.83,-3866 1996.87,-3866 1996.87,-3866"/>
<polygon fill="black" stroke="black" points="1996.87,-3862.5 1986.87,-3866 1996.87,-3869.5 1996.87,-3862.5"/>
</g>
<!-- stage3_layer2_experts_group7&#45;&gt;stage3_layer2_expert_combine -->
<g id="edge455" class="edge">
<title>stage3_layer2_experts_group7&#45;&gt;stage3_layer2_expert_combine</title>
<path fill="none" stroke="black" d="M2990.83,-3985.44C2990.83,-3928.56 2990.83,-3834 2990.83,-3834 2990.83,-3834 1993.93,-3834 1993.93,-3834"/>
<polygon fill="black" stroke="black" points="1993.93,-3830.5 1983.93,-3834 1993.93,-3837.5 1993.93,-3830.5"/>
</g>
<!-- stage3_layer2_mlp_fc1 -->
<g id="node348" class="node">
<title>stage3_layer2_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-3715.74 1590,-3715.74 1590,-3647.74 1922,-3647.74 1922,-3715.74"/>
<text text-anchor="middle" x="1756" y="-3700.54" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-3685.54" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-3670.54" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-3655.54" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer2_expert_combine&#45;&gt;stage3_layer2_mlp_fc1 -->
<g id="edge463" class="edge">
<title>stage3_layer2_expert_combine&#45;&gt;stage3_layer2_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-3802.37C1756,-3802.37 1756,-3725.97 1756,-3725.97"/>
<polygon fill="black" stroke="black" points="1759.5,-3725.97 1756,-3715.97 1752.5,-3725.97 1759.5,-3725.97"/>
</g>
<!-- stage3_layer2_mlp_gelu -->
<g id="node349" class="node">
<title>stage3_layer2_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-3560.74 1603.5,-3560.74 1603.5,-3492.74 1908.5,-3492.74 1908.5,-3560.74"/>
<text text-anchor="middle" x="1756" y="-3545.54" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-3530.54" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-3515.54" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-3500.54" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer2_mlp_fc1&#45;&gt;stage3_layer2_mlp_gelu -->
<g id="edge464" class="edge">
<title>stage3_layer2_mlp_fc1&#45;&gt;stage3_layer2_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-3647.72C1756,-3647.72 1756,-3570.94 1756,-3570.94"/>
<polygon fill="black" stroke="black" points="1759.5,-3570.94 1756,-3560.94 1752.5,-3570.94 1759.5,-3570.94"/>
</g>
<!-- stage3_layer2_mlp_fc2 -->
<g id="node350" class="node">
<title>stage3_layer2_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-3405.74 1588.5,-3405.74 1588.5,-3337.74 1923.5,-3337.74 1923.5,-3405.74"/>
<text text-anchor="middle" x="1756" y="-3390.54" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-3375.54" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-3360.54" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-3345.54" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer2_mlp_gelu&#45;&gt;stage3_layer2_mlp_fc2 -->
<g id="edge465" class="edge">
<title>stage3_layer2_mlp_gelu&#45;&gt;stage3_layer2_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-3492.72C1756,-3492.72 1756,-3415.94 1756,-3415.94"/>
<polygon fill="black" stroke="black" points="1759.5,-3415.94 1756,-3405.94 1752.5,-3415.94 1759.5,-3415.94"/>
</g>
<!-- stage3_layer2_mlp_allreduce -->
<g id="node351" class="node">
<title>stage3_layer2_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-3202.66" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-3221.46" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-3206.46" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-3191.46" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-3176.46" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_mlp_fc2&#45;&gt;stage3_layer2_mlp_allreduce -->
<g id="edge466" class="edge">
<title>stage3_layer2_mlp_fc2&#45;&gt;stage3_layer2_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-3337.52C1756,-3337.52 1756,-3260.92 1756,-3260.92"/>
<polygon fill="black" stroke="black" points="1759.5,-3260.92 1756,-3250.92 1752.5,-3260.92 1759.5,-3260.92"/>
</g>
<!-- stage3_layer2_mlp_end -->
<g id="node352" class="node">
<title>stage3_layer2_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-3067.57 1584,-3067.57 1584,-2999.57 1928,-2999.57 1928,-3067.57"/>
<text text-anchor="middle" x="1756" y="-3052.37" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-3037.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-3022.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-3007.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_mlp_allreduce&#45;&gt;stage3_layer2_mlp_end -->
<g id="edge467" class="edge">
<title>stage3_layer2_mlp_allreduce&#45;&gt;stage3_layer2_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-3154.2C1756,-3154.2 1756,-3077.81 1756,-3077.81"/>
<polygon fill="black" stroke="black" points="1759.5,-3077.81 1756,-3067.81 1752.5,-3077.81 1759.5,-3077.81"/>
</g>
<!-- stage3_layer3_attention_start -->
<g id="node353" class="node">
<title>stage3_layer3_attention_start</title>
<polygon fill="lightblue" stroke="black" points="1928,-2912.57 1584,-2912.57 1584,-2844.57 1928,-2844.57 1928,-2912.57"/>
<text text-anchor="middle" x="1756" y="-2897.37" font-family="Times,serif" font-size="14.00">Attention Start (Layer 3)</text>
<text text-anchor="middle" x="1756" y="-2882.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-2867.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-2852.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer2_mlp_end&#45;&gt;stage3_layer3_attention_start -->
<g id="edge499" class="edge">
<title>stage3_layer2_mlp_end&#45;&gt;stage3_layer3_attention_start</title>
<path fill="none" stroke="black" d="M1756,-2999.56C1756,-2999.56 1756,-2922.78 1756,-2922.78"/>
<polygon fill="black" stroke="black" points="1759.5,-2922.78 1756,-2912.78 1752.5,-2922.78 1759.5,-2922.78"/>
</g>
<!-- stage3_layer3_qkv_proj -->
<g id="node354" class="node">
<title>stage3_layer3_qkv_proj</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-2757.57 1569.5,-2757.57 1569.5,-2689.57 1942.5,-2689.57 1942.5,-2757.57"/>
<text text-anchor="middle" x="1756" y="-2742.37" font-family="Times,serif" font-size="14.00">QKV Projection (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-2727.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-2712.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-2697.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer3_attention_start&#45;&gt;stage3_layer3_qkv_proj -->
<g id="edge487" class="edge">
<title>stage3_layer3_attention_start&#45;&gt;stage3_layer3_qkv_proj</title>
<path fill="none" stroke="black" d="M1756,-2844.56C1756,-2844.56 1756,-2767.78 1756,-2767.78"/>
<polygon fill="black" stroke="black" points="1759.5,-2767.78 1756,-2757.78 1752.5,-2767.78 1759.5,-2767.78"/>
</g>
<!-- stage3_layer3_attention_compute -->
<g id="node355" class="node">
<title>stage3_layer3_attention_compute</title>
<polygon fill="lightblue" stroke="black" points="1942.5,-2602.57 1569.5,-2602.57 1569.5,-2534.57 1942.5,-2534.57 1942.5,-2602.57"/>
<text text-anchor="middle" x="1756" y="-2587.37" font-family="Times,serif" font-size="14.00">Attention Compute (TP)</text>
<text text-anchor="middle" x="1756" y="-2572.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-2557.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-2542.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, heads=4, d_k=64]</text>
</g>
<!-- stage3_layer3_qkv_proj&#45;&gt;stage3_layer3_attention_compute -->
<g id="edge488" class="edge">
<title>stage3_layer3_qkv_proj&#45;&gt;stage3_layer3_attention_compute</title>
<path fill="none" stroke="black" d="M1756,-2689.56C1756,-2689.56 1756,-2612.78 1756,-2612.78"/>
<polygon fill="black" stroke="black" points="1759.5,-2612.78 1756,-2602.78 1752.5,-2612.78 1759.5,-2612.78"/>
</g>
<!-- stage3_layer3_attention_out -->
<g id="node356" class="node">
<title>stage3_layer3_attention_out</title>
<polygon fill="lightblue" stroke="black" points="1936.5,-2447.57 1575.5,-2447.57 1575.5,-2379.57 1936.5,-2379.57 1936.5,-2447.57"/>
<text text-anchor="middle" x="1756" y="-2432.37" font-family="Times,serif" font-size="14.00">Attention Output (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-2417.37" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-2402.37" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, heads=4, d_k=64]</text>
<text text-anchor="middle" x="1756" y="-2387.37" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer3_attention_compute&#45;&gt;stage3_layer3_attention_out -->
<g id="edge489" class="edge">
<title>stage3_layer3_attention_compute&#45;&gt;stage3_layer3_attention_out</title>
<path fill="none" stroke="black" d="M1756,-2534.56C1756,-2534.56 1756,-2457.78 1756,-2457.78"/>
<polygon fill="black" stroke="black" points="1759.5,-2457.78 1756,-2447.78 1752.5,-2457.78 1759.5,-2457.78"/>
</g>
<!-- stage3_layer3_attention_allreduce -->
<g id="node357" class="node">
<title>stage3_layer3_attention_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-2244.49" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-2263.29" font-family="Times,serif" font-size="14.00">Attention All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-2248.29" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-2233.29" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-2218.29" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_attention_out&#45;&gt;stage3_layer3_attention_allreduce -->
<g id="edge490" class="edge">
<title>stage3_layer3_attention_out&#45;&gt;stage3_layer3_attention_allreduce</title>
<path fill="none" stroke="black" d="M1756,-2379.36C1756,-2379.36 1756,-2302.75 1756,-2302.75"/>
<polygon fill="black" stroke="black" points="1759.5,-2302.75 1756,-2292.75 1752.5,-2302.75 1759.5,-2302.75"/>
</g>
<!-- stage3_layer3_attention_residual -->
<g id="node358" class="node">
<title>stage3_layer3_attention_residual</title>
<polygon fill="lightblue" stroke="black" points="1928,-2109.41 1584,-2109.41 1584,-2041.41 1928,-2041.41 1928,-2109.41"/>
<text text-anchor="middle" x="1756" y="-2094.21" font-family="Times,serif" font-size="14.00">Attention + Residual</text>
<text text-anchor="middle" x="1756" y="-2079.21" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-2064.21" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-2049.21" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_attention_allreduce&#45;&gt;stage3_layer3_attention_residual -->
<g id="edge491" class="edge">
<title>stage3_layer3_attention_allreduce&#45;&gt;stage3_layer3_attention_residual</title>
<path fill="none" stroke="black" d="M1756,-2196.04C1756,-2196.04 1756,-2119.64 1756,-2119.64"/>
<polygon fill="black" stroke="black" points="1759.5,-2119.64 1756,-2109.64 1752.5,-2119.64 1759.5,-2119.64"/>
</g>
<!-- stage3_layer3_layernorm2 -->
<g id="node359" class="node">
<title>stage3_layer3_layernorm2</title>
<polygon fill="lightblue" stroke="black" points="1928,-1954.41 1584,-1954.41 1584,-1886.41 1928,-1886.41 1928,-1954.41"/>
<text text-anchor="middle" x="1756" y="-1939.21" font-family="Times,serif" font-size="14.00">Layer Norm 2</text>
<text text-anchor="middle" x="1756" y="-1924.21" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-1909.21" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-1894.21" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_attention_residual&#45;&gt;stage3_layer3_layernorm2 -->
<g id="edge492" class="edge">
<title>stage3_layer3_attention_residual&#45;&gt;stage3_layer3_layernorm2</title>
<path fill="none" stroke="black" d="M1756,-2041.39C1756,-2041.39 1756,-1964.61 1756,-1964.61"/>
<polygon fill="black" stroke="black" points="1759.5,-1964.61 1756,-1954.61 1752.5,-1964.61 1759.5,-1964.61"/>
</g>
<!-- stage3_layer3_moe_gate -->
<g id="node360" class="node">
<title>stage3_layer3_moe_gate</title>
<polygon fill="yellow" stroke="black" points="2100.4,-1799.41 1552.53,-1799.41 1411.6,-1663.41 1959.47,-1663.41 2100.4,-1799.41"/>
<text text-anchor="middle" x="1756" y="-1750.21" font-family="Times,serif" font-size="14.00">MoE Gate (Routing Decision)</text>
<text text-anchor="middle" x="1756" y="-1735.21" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-1720.21" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-1705.21" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, top_k=2]</text>
</g>
<!-- stage3_layer3_layernorm2&#45;&gt;stage3_layer3_moe_gate -->
<g id="edge493" class="edge">
<title>stage3_layer3_layernorm2&#45;&gt;stage3_layer3_moe_gate</title>
<path fill="none" stroke="black" d="M1756,-1886.18C1756,-1886.18 1756,-1809.44 1756,-1809.44"/>
<polygon fill="black" stroke="black" points="1759.5,-1809.44 1756,-1799.44 1752.5,-1809.44 1759.5,-1809.44"/>
</g>
<!-- stage3_layer3_expert_dispatch -->
<g id="node361" class="node">
<title>stage3_layer3_expert_dispatch</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-1528.32" rx="236.76" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-1547.12" font-family="Times,serif" font-size="14.00">Expert Dispatch (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-1532.12" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-1517.12" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-1502.12" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_moe_gate&#45;&gt;stage3_layer3_expert_dispatch -->
<g id="edge469" class="edge">
<title>stage3_layer3_moe_gate&#45;&gt;stage3_layer3_expert_dispatch</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M1756,-1663.22C1756,-1663.22 1756,-1586.45 1756,-1586.45"/>
<polygon fill="black" stroke="black" points="1759.5,-1586.45 1756,-1576.45 1752.5,-1586.45 1759.5,-1586.45"/>
</g>
<!-- stage3_layer3_experts_group0 -->
<g id="node362" class="node">
<title>stage3_layer3_experts_group0</title>
<polygon fill="lightblue" stroke="black" points="351.5,-1393.24 16.5,-1393.24 16.5,-1310.24 351.5,-1310.24 351.5,-1393.24"/>
<text text-anchor="middle" x="184" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 0</text>
<text text-anchor="middle" x="184" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 384&#45;387</text>
<text text-anchor="middle" x="184" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="184" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="184" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group0 -->
<g id="edge471" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group0</title>
<path fill="none" stroke="black" d="M1549.42,-1552C1111.19,-1552 128.17,-1552 128.17,-1552 128.17,-1552 128.17,-1403.72 128.17,-1403.72"/>
<polygon fill="black" stroke="black" points="131.67,-1403.72 128.17,-1393.72 124.67,-1403.72 131.67,-1403.72"/>
</g>
<!-- stage3_layer3_experts_group1 -->
<g id="node363" class="node">
<title>stage3_layer3_experts_group1</title>
<polygon fill="lightblue" stroke="black" points="744.5,-1393.24 409.5,-1393.24 409.5,-1310.24 744.5,-1310.24 744.5,-1393.24"/>
<text text-anchor="middle" x="577" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 1</text>
<text text-anchor="middle" x="577" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 388&#45;391</text>
<text text-anchor="middle" x="577" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="577" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="577" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group1 -->
<g id="edge473" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group1</title>
<path fill="none" stroke="black" d="M1519.01,-1528C1160.38,-1528 521.17,-1528 521.17,-1528 521.17,-1528 521.17,-1403.51 521.17,-1403.51"/>
<polygon fill="black" stroke="black" points="524.67,-1403.51 521.17,-1393.51 517.67,-1403.51 524.67,-1403.51"/>
</g>
<!-- stage3_layer3_experts_group2 -->
<g id="node364" class="node">
<title>stage3_layer3_experts_group2</title>
<polygon fill="lightblue" stroke="black" points="1137.5,-1393.24 802.5,-1393.24 802.5,-1310.24 1137.5,-1310.24 1137.5,-1393.24"/>
<text text-anchor="middle" x="970" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 2</text>
<text text-anchor="middle" x="970" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 392&#45;395</text>
<text text-anchor="middle" x="970" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="970" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="970" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group2 -->
<g id="edge475" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group2</title>
<path fill="none" stroke="black" d="M1551.41,-1504C1302.23,-1504 914.17,-1504 914.17,-1504 914.17,-1504 914.17,-1403.35 914.17,-1403.35"/>
<polygon fill="black" stroke="black" points="917.67,-1403.35 914.17,-1393.35 910.67,-1403.35 917.67,-1403.35"/>
</g>
<!-- stage3_layer3_experts_group3 -->
<g id="node365" class="node">
<title>stage3_layer3_experts_group3</title>
<polygon fill="lightblue" stroke="black" points="1530.5,-1393.24 1195.5,-1393.24 1195.5,-1310.24 1530.5,-1310.24 1530.5,-1393.24"/>
<text text-anchor="middle" x="1363" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 3</text>
<text text-anchor="middle" x="1363" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 396&#45;399</text>
<text text-anchor="middle" x="1363" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1363" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1363" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group3 -->
<g id="edge477" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group3</title>
<path fill="none" stroke="black" d="M1524.81,-1517.81C1524.81,-1517.81 1524.81,-1403.5 1524.81,-1403.5"/>
<polygon fill="black" stroke="black" points="1528.31,-1403.5 1524.81,-1393.5 1521.31,-1403.5 1528.31,-1403.5"/>
</g>
<!-- stage3_layer3_experts_group4 -->
<g id="node366" class="node">
<title>stage3_layer3_experts_group4</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-1393.24 1588.5,-1393.24 1588.5,-1310.24 1923.5,-1310.24 1923.5,-1393.24"/>
<text text-anchor="middle" x="1756" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 4</text>
<text text-anchor="middle" x="1756" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 400&#45;403</text>
<text text-anchor="middle" x="1756" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="1756" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group4 -->
<g id="edge479" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group4</title>
<path fill="none" stroke="black" d="M1756,-1480.07C1756,-1480.07 1756,-1403.34 1756,-1403.34"/>
<polygon fill="black" stroke="black" points="1759.5,-1403.34 1756,-1393.34 1752.5,-1403.34 1759.5,-1403.34"/>
</g>
<!-- stage3_layer3_experts_group5 -->
<g id="node367" class="node">
<title>stage3_layer3_experts_group5</title>
<polygon fill="lightblue" stroke="black" points="2316.5,-1393.24 1981.5,-1393.24 1981.5,-1310.24 2316.5,-1310.24 2316.5,-1393.24"/>
<text text-anchor="middle" x="2149" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 5</text>
<text text-anchor="middle" x="2149" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 404&#45;407</text>
<text text-anchor="middle" x="2149" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2149" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2149" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group5 -->
<g id="edge481" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group5</title>
<path fill="none" stroke="black" d="M1987.19,-1517.81C1987.19,-1517.81 1987.19,-1403.5 1987.19,-1403.5"/>
<polygon fill="black" stroke="black" points="1990.69,-1403.5 1987.19,-1393.5 1983.69,-1403.5 1990.69,-1403.5"/>
</g>
<!-- stage3_layer3_experts_group6 -->
<g id="node368" class="node">
<title>stage3_layer3_experts_group6</title>
<polygon fill="lightblue" stroke="black" points="2709.5,-1393.24 2374.5,-1393.24 2374.5,-1310.24 2709.5,-1310.24 2709.5,-1393.24"/>
<text text-anchor="middle" x="2542" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 6</text>
<text text-anchor="middle" x="2542" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 408&#45;411</text>
<text text-anchor="middle" x="2542" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2542" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2542" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group6 -->
<g id="edge483" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group6</title>
<path fill="none" stroke="black" d="M1979.04,-1512C2193.77,-1512 2486.17,-1512 2486.17,-1512 2486.17,-1512 2486.17,-1403.43 2486.17,-1403.43"/>
<polygon fill="black" stroke="black" points="2489.67,-1403.43 2486.17,-1393.43 2482.67,-1403.43 2489.67,-1403.43"/>
</g>
<!-- stage3_layer3_experts_group7 -->
<g id="node369" class="node">
<title>stage3_layer3_experts_group7</title>
<polygon fill="lightblue" stroke="black" points="3102.5,-1393.24 2767.5,-1393.24 2767.5,-1310.24 3102.5,-1310.24 3102.5,-1393.24"/>
<text text-anchor="middle" x="2935" y="-1378.04" font-family="Times,serif" font-size="14.00">Experts Group 7</text>
<text text-anchor="middle" x="2935" y="-1363.04" font-family="Times,serif" font-size="14.00">GPU 412&#45;415</text>
<text text-anchor="middle" x="2935" y="-1348.04" font-family="Times,serif" font-size="14.00">8 Experts per GPU</text>
<text text-anchor="middle" x="2935" y="-1333.04" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="2935" y="-1318.04" font-family="Times,serif" font-size="14.00">Output: [batch=4, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group7 -->
<g id="edge485" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_experts_group7</title>
<path fill="none" stroke="black" d="M1980.25,-1544C2307.97,-1544 2879.17,-1544 2879.17,-1544 2879.17,-1544 2879.17,-1403.46 2879.17,-1403.46"/>
<polygon fill="black" stroke="black" points="2882.67,-1403.46 2879.17,-1393.46 2875.67,-1403.46 2882.67,-1403.46"/>
</g>
<!-- stage3_layer3_expert_combine -->
<g id="node370" class="node">
<title>stage3_layer3_expert_combine</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-1175.16" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-1193.96" font-family="Times,serif" font-size="14.00">Expert Combine (EP All&#45;to&#45;All)</text>
<text text-anchor="middle" x="1756" y="-1178.96" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-1163.96" font-family="Times,serif" font-size="14.00">Input: [batch=4, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-1148.96" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge470" class="edge">
<title>stage3_layer3_expert_dispatch&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1559.5,-1501.2C1559.5,-1501.2 1559.5,-1213.85 1559.5,-1213.85"/>
<polygon fill="black" stroke="black" points="1563,-1213.85 1559.5,-1203.85 1556,-1213.85 1563,-1213.85"/>
</g>
<!-- stage3_layer3_experts_group0&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge472" class="edge">
<title>stage3_layer3_experts_group0&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M184,-1310.15C184,-1251.35 184,-1151 184,-1151 184,-1151 1535.62,-1151 1535.62,-1151"/>
<polygon fill="black" stroke="black" points="1535.62,-1154.5 1545.62,-1151 1535.62,-1147.5 1535.62,-1154.5"/>
</g>
<!-- stage3_layer3_experts_group1&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge474" class="edge">
<title>stage3_layer3_experts_group1&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M577,-1309.85C577,-1257.59 577,-1175 577,-1175 577,-1175 1502.43,-1175 1502.43,-1175"/>
<polygon fill="black" stroke="black" points="1502.43,-1178.5 1512.43,-1175 1502.43,-1171.5 1502.43,-1178.5"/>
</g>
<!-- stage3_layer3_experts_group2&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge476" class="edge">
<title>stage3_layer3_experts_group2&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M970,-1310C970,-1264.78 970,-1199 970,-1199 970,-1199 1534.59,-1199 1534.59,-1199"/>
<polygon fill="black" stroke="black" points="1534.59,-1202.5 1544.59,-1199 1534.59,-1195.5 1534.59,-1202.5"/>
</g>
<!-- stage3_layer3_experts_group3&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge478" class="edge">
<title>stage3_layer3_experts_group3&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1521.63,-1309.89C1521.63,-1309.89 1521.63,-1198.07 1521.63,-1198.07"/>
<polygon fill="black" stroke="black" points="1525.13,-1198.07 1521.63,-1188.07 1518.13,-1198.07 1525.13,-1198.07"/>
</g>
<!-- stage3_layer3_experts_group4&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge480" class="edge">
<title>stage3_layer3_experts_group4&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1756,-1309.89C1756,-1309.89 1756,-1233.26 1756,-1233.26"/>
<polygon fill="black" stroke="black" points="1759.5,-1233.26 1756,-1223.26 1752.5,-1233.26 1759.5,-1233.26"/>
</g>
<!-- stage3_layer3_experts_group5&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge482" class="edge">
<title>stage3_layer3_experts_group5&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M1990.37,-1309.89C1990.37,-1309.89 1990.37,-1198.07 1990.37,-1198.07"/>
<polygon fill="black" stroke="black" points="1993.87,-1198.07 1990.37,-1188.07 1986.87,-1198.07 1993.87,-1198.07"/>
</g>
<!-- stage3_layer3_experts_group6&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge484" class="edge">
<title>stage3_layer3_experts_group6&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2542,-1309.93C2542,-1262.3 2542,-1191 2542,-1191 2542,-1191 1995.72,-1191 1995.72,-1191"/>
<polygon fill="black" stroke="black" points="1995.72,-1187.5 1985.72,-1191 1995.72,-1194.5 1995.72,-1187.5"/>
</g>
<!-- stage3_layer3_experts_group7&#45;&gt;stage3_layer3_expert_combine -->
<g id="edge486" class="edge">
<title>stage3_layer3_experts_group7&#45;&gt;stage3_layer3_expert_combine</title>
<path fill="none" stroke="black" d="M2935,-1309.92C2935,-1253.23 2935,-1159 2935,-1159 2935,-1159 1995.42,-1159 1995.42,-1159"/>
<polygon fill="black" stroke="black" points="1995.42,-1155.5 1985.42,-1159 1995.42,-1162.5 1995.42,-1155.5"/>
</g>
<!-- stage3_layer3_mlp_fc1 -->
<g id="node371" class="node">
<title>stage3_layer3_mlp_fc1</title>
<polygon fill="lightblue" stroke="black" points="1922,-1040.07 1590,-1040.07 1590,-972.07 1922,-972.07 1922,-1040.07"/>
<text text-anchor="middle" x="1756" y="-1024.87" font-family="Times,serif" font-size="14.00">MLP FC1 (TP&#45;Column)</text>
<text text-anchor="middle" x="1756" y="-1009.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-994.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-979.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer3_expert_combine&#45;&gt;stage3_layer3_mlp_fc1 -->
<g id="edge494" class="edge">
<title>stage3_layer3_expert_combine&#45;&gt;stage3_layer3_mlp_fc1</title>
<path fill="none" stroke="black" d="M1756,-1126.7C1756,-1126.7 1756,-1050.31 1756,-1050.31"/>
<polygon fill="black" stroke="black" points="1759.5,-1050.31 1756,-1040.31 1752.5,-1050.31 1759.5,-1050.31"/>
</g>
<!-- stage3_layer3_mlp_gelu -->
<g id="node372" class="node">
<title>stage3_layer3_mlp_gelu</title>
<polygon fill="lightblue" stroke="black" points="1908.5,-885.07 1603.5,-885.07 1603.5,-817.07 1908.5,-817.07 1908.5,-885.07"/>
<text text-anchor="middle" x="1756" y="-869.87" font-family="Times,serif" font-size="14.00">MLP GELU</text>
<text text-anchor="middle" x="1756" y="-854.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-839.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-824.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, ffn=512]</text>
</g>
<!-- stage3_layer3_mlp_fc1&#45;&gt;stage3_layer3_mlp_gelu -->
<g id="edge495" class="edge">
<title>stage3_layer3_mlp_fc1&#45;&gt;stage3_layer3_mlp_gelu</title>
<path fill="none" stroke="black" d="M1756,-972.06C1756,-972.06 1756,-895.28 1756,-895.28"/>
<polygon fill="black" stroke="black" points="1759.5,-895.28 1756,-885.28 1752.5,-895.28 1759.5,-895.28"/>
</g>
<!-- stage3_layer3_mlp_fc2 -->
<g id="node373" class="node">
<title>stage3_layer3_mlp_fc2</title>
<polygon fill="lightblue" stroke="black" points="1923.5,-730.07 1588.5,-730.07 1588.5,-662.07 1923.5,-662.07 1923.5,-730.07"/>
<text text-anchor="middle" x="1756" y="-714.87" font-family="Times,serif" font-size="14.00">MLP FC2 (TP&#45;Row)</text>
<text text-anchor="middle" x="1756" y="-699.87" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-684.87" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, ffn=512]</text>
<text text-anchor="middle" x="1756" y="-669.87" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=256]</text>
</g>
<!-- stage3_layer3_mlp_gelu&#45;&gt;stage3_layer3_mlp_fc2 -->
<g id="edge496" class="edge">
<title>stage3_layer3_mlp_gelu&#45;&gt;stage3_layer3_mlp_fc2</title>
<path fill="none" stroke="black" d="M1756,-817.06C1756,-817.06 1756,-740.28 1756,-740.28"/>
<polygon fill="black" stroke="black" points="1759.5,-740.28 1756,-730.28 1752.5,-740.28 1759.5,-740.28"/>
</g>
<!-- stage3_layer3_mlp_allreduce -->
<g id="node374" class="node">
<title>stage3_layer3_mlp_allreduce</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-526.99" rx="243.49" ry="48.17"/>
<text text-anchor="middle" x="1756" y="-545.79" font-family="Times,serif" font-size="14.00">MLP All&#45;Reduce (TP)</text>
<text text-anchor="middle" x="1756" y="-530.79" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-515.79" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=256]</text>
<text text-anchor="middle" x="1756" y="-500.79" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_mlp_fc2&#45;&gt;stage3_layer3_mlp_allreduce -->
<g id="edge497" class="edge">
<title>stage3_layer3_mlp_fc2&#45;&gt;stage3_layer3_mlp_allreduce</title>
<path fill="none" stroke="black" d="M1756,-661.86C1756,-661.86 1756,-585.25 1756,-585.25"/>
<polygon fill="black" stroke="black" points="1759.5,-585.25 1756,-575.25 1752.5,-585.25 1759.5,-585.25"/>
</g>
<!-- stage3_layer3_mlp_end -->
<g id="node375" class="node">
<title>stage3_layer3_mlp_end</title>
<polygon fill="lightblue" stroke="black" points="1928,-391.91 1584,-391.91 1584,-323.91 1928,-323.91 1928,-391.91"/>
<text text-anchor="middle" x="1756" y="-376.71" font-family="Times,serif" font-size="14.00">MLP + Residual</text>
<text text-anchor="middle" x="1756" y="-361.71" font-family="Times,serif" font-size="14.00">GPU 384&#45;415</text>
<text text-anchor="middle" x="1756" y="-346.71" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-331.71" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_mlp_allreduce&#45;&gt;stage3_layer3_mlp_end -->
<g id="edge498" class="edge">
<title>stage3_layer3_mlp_allreduce&#45;&gt;stage3_layer3_mlp_end</title>
<path fill="none" stroke="black" d="M1756,-478.54C1756,-478.54 1756,-402.14 1756,-402.14"/>
<polygon fill="black" stroke="black" points="1759.5,-402.14 1756,-392.14 1752.5,-402.14 1759.5,-402.14"/>
</g>
<!-- stage3_output -->
<g id="node376" class="node">
<title>stage3_output</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-199.43" rx="243.49" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-210.73" font-family="Times,serif" font-size="14.00">Stage Output</text>
<text text-anchor="middle" x="1756" y="-195.73" font-family="Times,serif" font-size="14.00">Input: [batch=32, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-180.73" font-family="Times,serif" font-size="14.00">Output: [batch=32, seq=1024, hidden=1024]</text>
</g>
<!-- stage3_layer3_mlp_end&#45;&gt;stage3_output -->
<g id="edge500" class="edge">
<title>stage3_layer3_mlp_end&#45;&gt;stage3_output</title>
<path fill="none" stroke="black" d="M1756,-323.52C1756,-323.52 1756,-247.07 1756,-247.07"/>
<polygon fill="black" stroke="black" points="1759.5,-247.07 1756,-237.07 1752.5,-247.07 1759.5,-247.07"/>
</g>
<!-- final_output -->
<g id="node377" class="node">
<title>final_output</title>
<ellipse fill="lightgreen" stroke="black" cx="1756" cy="-37.48" rx="250.13" ry="37.45"/>
<text text-anchor="middle" x="1756" y="-48.78" font-family="Times,serif" font-size="14.00">Final Output</text>
<text text-anchor="middle" x="1756" y="-33.78" font-family="Times,serif" font-size="14.00">Input: [batch=128, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="1756" y="-18.78" font-family="Times,serif" font-size="14.00">Output: [batch=128, seq=1024, vocab=51200]</text>
</g>
<!-- stage3_output&#45;&gt;final_output -->
<g id="edge504" class="edge">
<title>stage3_output&#45;&gt;final_output</title>
<path fill="none" stroke="black" d="M1756,-161.87C1756,-161.87 1756,-85.12 1756,-85.12"/>
<polygon fill="black" stroke="black" points="1759.5,-85.12 1756,-75.12 1752.5,-85.12 1759.5,-85.12"/>
</g>
</g>
</svg>
