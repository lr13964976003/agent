digraph MoE_EP8_TP4_PP4_Layer {\nrankdir=TB;\nbgcolor=white;\nnode [fontsize=10, margin=0.04];\ninp [shape=rectangle, label="LayerInput\nGPU 0-127\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\nln_0 [shape=rectangle, label="LayerNorm\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> ln_0;\nln_1 [shape=rectangle, label="LayerNorm\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> ln_1;\nln_2 [shape=rectangle, label="LayerNorm\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> ln_2;\nln_3 [shape=rectangle, label="LayerNorm\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> ln_3;\nqkv_0 [shape=rectangle, label="QKV_Proj(col)\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,3h/4=768]"];\nln_0 -> qkv_0;\nqkv_1 [shape=rectangle, label="QKV_Proj(col)\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,3h/4=768]"];\nln_1 -> qkv_1;\nqkv_2 [shape=rectangle, label="QKV_Proj(col)\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,3h/4=768]"];\nln_2 -> qkv_2;\nqkv_3 [shape=rectangle, label="QKV_Proj(col)\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,3h/4=768]"];\nln_3 -> qkv_3;\nag_qkv [shape=ellipse, label="AllGather(QKV)\nIn: [b,s,3h/4=768]\nOut: [b,s,3h=3072]"];\nqkv_0 -> ag_qkv;\nag_qkv -> 0_qkv_full;\n0_qkv_full [shape=rectangle, label="QKV_full\nGPU 0\nIn: [b,s,3h=3072]\nOut: [b,s,3h=3072]"];\nqkv_1 -> ag_qkv;\nag_qkv -> 1_qkv_full;\n1_qkv_full [shape=rectangle, label="QKV_full\nGPU 1\nIn: [b,s,3h=3072]\nOut: [b,s,3h=3072]"];\nqkv_2 -> ag_qkv;\nag_qkv -> 2_qkv_full;\n2_qkv_full [shape=rectangle, label="QKV_full\nGPU 2\nIn: [b,s,3h=3072]\nOut: [b,s,3h=3072]"];\nqkv_3 -> ag_qkv;\nag_qkv -> 3_qkv_full;\n3_qkv_full [shape=rectangle, label="QKV_full\nGPU 3\nIn: [b,s,3h=3072]\nOut: [b,s,3h=3072]"];\nattn_0 [shape=rectangle, label="Attention(heads=16/4=4)\nGPU 0\nIn: [b,s,3h=3072]\nOut: [b,s,h=1024]"];\n0_qkv_full -> attn_0;\nattn_1 [shape=rectangle, label="Attention(heads=16/4=4)\nGPU 1\nIn: [b,s,3h=3072]\nOut: [b,s,h=1024]"];\n1_qkv_full -> attn_1;\nattn_2 [shape=rectangle, label="Attention(heads=16/4=4)\nGPU 2\nIn: [b,s,3h=3072]\nOut: [b,s,h=1024]"];\n2_qkv_full -> attn_2;\nattn_3 [shape=rectangle, label="Attention(heads=16/4=4)\nGPU 3\nIn: [b,s,3h=3072]\nOut: [b,s,h=1024]"];\n3_qkv_full -> attn_3;\nattn_out_0 [shape=rectangle, label="AttnOut(row)\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,h/4=256]"];\nattn_0 -> attn_out_0;\nattn_out_1 [shape=rectangle, label="AttnOut(row)\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,h/4=256]"];\nattn_1 -> attn_out_1;\nattn_out_2 [shape=rectangle, label="AttnOut(row)\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,h/4=256]"];\nattn_2 -> attn_out_2;\nattn_out_3 [shape=rectangle, label="AttnOut(row)\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,h/4=256]"];\nattn_3 -> attn_out_3;\nar_attn [shape=ellipse, label="AllReduce(AttnOut)\nIn: [b,s,h/4=256]\nOut: [b,s,h=1024]"];\nattn_out_0 -> ar_attn;\nar_attn -> 0_attn_resid;\n0_attn_resid [shape=rectangle, label="Attn+Residual\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> 0_attn_resid [style=dashed, color=gray];\nattn_out_1 -> ar_attn;\nar_attn -> 1_attn_resid;\n1_attn_resid [shape=rectangle, label="Attn+Residual\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> 1_attn_resid [style=dashed, color=gray];\nattn_out_2 -> ar_attn;\nar_attn -> 2_attn_resid;\n2_attn_resid [shape=rectangle, label="Attn+Residual\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> 2_attn_resid [style=dashed, color=gray];\nattn_out_3 -> ar_attn;\nar_attn -> 3_attn_resid;\n3_attn_resid [shape=rectangle, label="Attn+Residual\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\ninp -> 3_attn_resid [style=dashed, color=gray];\nln_moe_0 [shape=rectangle, label="LayerNorm\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n0_attn_resid -> ln_moe_0;\nln_moe_1 [shape=rectangle, label="LayerNorm\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n1_attn_resid -> ln_moe_1;\nln_moe_2 [shape=rectangle, label="LayerNorm\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n2_attn_resid -> ln_moe_2;\nln_moe_3 [shape=rectangle, label="LayerNorm\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n3_attn_resid -> ln_moe_3;\ngate_0 [shape=rectangle, label="Gate(h->64E)\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,64E=64*64]"];\nln_moe_0 -> gate_0;\ngate_1 [shape=rectangle, label="Gate(h->64E)\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,64E=64*64]"];\nln_moe_1 -> gate_1;\ngate_2 [shape=rectangle, label="Gate(h->64E)\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,64E=64*64]"];\nln_moe_2 -> gate_2;\ngate_3 [shape=rectangle, label="Gate(h->64E)\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,64E=64*64]"];\nln_moe_3 -> gate_3;\ntop2_0 [shape=rectangle, label="Top2ExpertSelect\nGPU 0\nIn: [b,s,64E]\nOut: [b,s,2] (indices+weight)"];\ngate_0 -> top2_0;\ntop2_1 [shape=rectangle, label="Top2ExpertSelect\nGPU 1\nIn: [b,s,64E]\nOut: [b,s,2] (indices+weight)"];\ngate_1 -> top2_1;\ntop2_2 [shape=rectangle, label="Top2ExpertSelect\nGPU 2\nIn: [b,s,64E]\nOut: [b,s,2] (indices+weight)"];\ngate_2 -> top2_2;\ntop2_3 [shape=rectangle, label="Top2ExpertSelect\nGPU 3\nIn: [b,s,64E]\nOut: [b,s,2] (indices+weight)"];\ngate_3 -> top2_3;\na2a_disp [shape=ellipse, label="AllToAll(Dispatch)\nIn: [b,s,h=1024] + indices\nOut: [b,s,h=1024] (routed)"];\nln_moe_0 -> a2a_disp;\ntop2_0 -> a2a_disp [style=dashed];\na2a_disp -> 0_disp;\n0_disp [shape=rectangle, label="DispatchedTokens\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s_per_expert,h=1024]"];\nln_moe_1 -> a2a_disp;\ntop2_1 -> a2a_disp [style=dashed];\na2a_disp -> 1_disp;\n1_disp [shape=rectangle, label="DispatchedTokens\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s_per_expert,h=1024]"];\nln_moe_2 -> a2a_disp;\ntop2_2 -> a2a_disp [style=dashed];\na2a_disp -> 2_disp;\n2_disp [shape=rectangle, label="DispatchedTokens\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s_per_expert,h=1024]"];\nln_moe_3 -> a2a_disp;\ntop2_3 -> a2a_disp [style=dashed];\na2a_disp -> 3_disp;\n3_disp [shape=rectangle, label="DispatchedTokens\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s_per_expert,h=1024]"];\nexp0_1 [shape=rectangle, label="Expert0MLP1(col)\nGPU 0\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n0_disp -> exp0_1;\nexp0_2 [shape=rectangle, label="Expert0MLP2(row)\nGPU 0\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp0_1 -> exp0_2;\nexp1_1 [shape=rectangle, label="Expert1MLP1(col)\nGPU 0\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n0_disp -> exp1_1;\nexp1_2 [shape=rectangle, label="Expert1MLP2(row)\nGPU 0\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp1_1 -> exp1_2;\nexp2_1 [shape=rectangle, label="Expert2MLP1(col)\nGPU 1\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n1_disp -> exp2_1;\nexp2_2 [shape=rectangle, label="Expert2MLP2(row)\nGPU 1\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp2_1 -> exp2_2;\nexp3_1 [shape=rectangle, label="Expert3MLP1(col)\nGPU 1\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n1_disp -> exp3_1;\nexp3_2 [shape=rectangle, label="Expert3MLP2(row)\nGPU 1\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp3_1 -> exp3_2;\nexp4_1 [shape=rectangle, label="Expert4MLP1(col)\nGPU 2\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n2_disp -> exp4_1;\nexp4_2 [shape=rectangle, label="Expert4MLP2(row)\nGPU 2\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp4_1 -> exp4_2;\nexp5_1 [shape=rectangle, label="Expert5MLP1(col)\nGPU 2\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n2_disp -> exp5_1;\nexp5_2 [shape=rectangle, label="Expert5MLP2(row)\nGPU 2\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp5_1 -> exp5_2;\nexp6_1 [shape=rectangle, label="Expert6MLP1(col)\nGPU 3\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n3_disp -> exp6_1;\nexp6_2 [shape=rectangle, label="Expert6MLP2(row)\nGPU 3\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp6_1 -> exp6_2;\nexp7_1 [shape=rectangle, label="Expert7MLP1(col)\nGPU 3\nIn: [b,s_e,h=1024]\nOut: [b,s_e,ffn/4=1024]"];\n3_disp -> exp7_1;\nexp7_2 [shape=rectangle, label="Expert7MLP2(row)\nGPU 3\nIn: [b,s_e,ffn/4=1024]\nOut: [b,s_e,h/4=256]"];\nexp7_1 -> exp7_2;\nar_exp_0 [shape=ellipse, label="AllReduce(ExpertOut)\nIn: [b,s_e,h/4=256]\nOut: [b,s_e,h=1024]"];\nexp0_2 -> ar_exp_0;\nexp1_2 -> ar_exp_0;\nar_exp_0 -> 0_exp_aggr;\n0_exp_aggr [shape=parallelogram, label="AggregateExpertOut\nIn: [b,s_e,h=1024]\nOut: [b,s,h=1024]"];\nar_exp_1 [shape=ellipse, label="AllReduce(ExpertOut)\nIn: [b,s_e,h/4=256]\nOut: [b,s_e,h=1024]"];\nexp2_2 -> ar_exp_1;\nexp3_2 -> ar_exp_1;\nar_exp_1 -> 1_exp_aggr;\n1_exp_aggr [shape=parallelogram, label="AggregateExpertOut\nIn: [b,s_e,h=1024]\nOut: [b,s,h=1024]"];\nar_exp_2 [shape=ellipse, label="AllReduce(ExpertOut)\nIn: [b,s_e,h/4=256]\nOut: [b,s_e,h=1024]"];\nexp4_2 -> ar_exp_2;\nexp5_2 -> ar_exp_2;\nar_exp_2 -> 2_exp_aggr;\n2_exp_aggr [shape=parallelogram, label="AggregateExpertOut\nIn: [b,s_e,h=1024]\nOut: [b,s,h=1024]"];\nar_exp_3 [shape=ellipse, label="AllReduce(ExpertOut)\nIn: [b,s_e,h/4=256]\nOut: [b,s_e,h=1024]"];\nexp6_2 -> ar_exp_3;\nexp7_2 -> ar_exp_3;\nar_exp_3 -> 3_exp_aggr;\n3_exp_aggr [shape=parallelogram, label="AggregateExpertOut\nIn: [b,s_e,h=1024]\nOut: [b,s,h=1024]"];\na2a_comb [shape=ellipse, label="AllToAll(Combine)\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n0_exp_aggr -> a2a_comb;\na2a_comb -> 0_comb;\n0_comb [shape=rectangle, label="CombinedTokens\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n1_exp_aggr -> a2a_comb;\na2a_comb -> 1_comb;\n1_comb [shape=rectangle, label="CombinedTokens\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n2_exp_aggr -> a2a_comb;\na2a_comb -> 2_comb;\n2_comb [shape=rectangle, label="CombinedTokens\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n3_exp_aggr -> a2a_comb;\na2a_comb -> 3_comb;\n3_comb [shape=rectangle, label="CombinedTokens\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\nout_0 [shape=rectangle, label="MoE+Residual\nGPU 0\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n0_attn_resid -> out_0 [style=dashed, color=gray];\n0_comb -> out_0;\nout_1 [shape=rectangle, label="MoE+Residual\nGPU 1\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n1_attn_resid -> out_1 [style=dashed, color=gray];\n1_comb -> out_1;\nout_2 [shape=rectangle, label="MoE+Residual\nGPU 2\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n2_attn_resid -> out_2 [style=dashed, color=gray];\n2_comb -> out_2;\nout_3 [shape=rectangle, label="MoE+Residual\nGPU 3\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\n3_attn_resid -> out_3 [style=dashed, color=gray];\n3_comb -> out_3;\noutput [shape=parallelogram, label="LayerOutput\nIn: [b,s,h=1024]\nOut: [b,s,h=1024]"];\nout_0 -> output;\nout_1 -> output;\nout_2 -> output;\nout_3 -> output;\n}