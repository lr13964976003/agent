// Simplified 128-GPU MoE Deployment DAG
digraph MoE_128GPU_Simplified {
	graph [bgcolor=white fontname=Arial fontsize=14 nodesep=0.8 rankdir=TB ranksep=1.5 splines=ortho]
	node [fillcolor=lightblue fontname=Arial shape=rectangle style=filled]
	edge [fontname=Arial fontsize=12]
	input [label="Input Tokens\n[batch_size, seq_len]" fillcolor=lightgreen shape=ellipse style="filled,bold"]
	subgraph cluster_stage_0 {
		color=blue fillcolor=lightyellow label="Pipeline Stage 0\nLayers 0-3\nGPUs 0-31" penwidth=3 style="rounded,filled"
		expert_0_stage_0 [label="Expert 0\nGPUs 0-1\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_1_stage_0 [label="Expert 1\nGPUs 2-3\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_2_stage_0 [label="Expert 2\nGPUs 4-5\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_3_stage_0 [label="Expert 3\nGPUs 6-7\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_4_stage_0 [label="Expert 4\nGPUs 8-9\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_5_stage_0 [label="Expert 5\nGPUs 10-11\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_6_stage_0 [label="Expert 6\nGPUs 12-13\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_7_stage_0 [label="Expert 7\nGPUs 14-15\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_8_stage_0 [label="Expert 8\nGPUs 16-17\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_9_stage_0 [label="Expert 9\nGPUs 18-19\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_10_stage_0 [label="Expert 10\nGPUs 20-21\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_11_stage_0 [label="Expert 11\nGPUs 22-23\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_12_stage_0 [label="Expert 12\nGPUs 24-25\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_13_stage_0 [label="Expert 13\nGPUs 26-27\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_14_stage_0 [label="Expert 14\nGPUs 28-29\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_15_stage_0 [label="Expert 15\nGPUs 30-31\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
	}
	subgraph cluster_stage_1 {
		color=blue fillcolor=lightyellow label="Pipeline Stage 1\nLayers 4-7\nGPUs 32-63" penwidth=3 style="rounded,filled"
		expert_16_stage_1 [label="Expert 16\nGPUs 32-33\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_17_stage_1 [label="Expert 17\nGPUs 34-35\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_18_stage_1 [label="Expert 18\nGPUs 36-37\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_19_stage_1 [label="Expert 19\nGPUs 38-39\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_20_stage_1 [label="Expert 20\nGPUs 40-41\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_21_stage_1 [label="Expert 21\nGPUs 42-43\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_22_stage_1 [label="Expert 22\nGPUs 44-45\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_23_stage_1 [label="Expert 23\nGPUs 46-47\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_24_stage_1 [label="Expert 24\nGPUs 48-49\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_25_stage_1 [label="Expert 25\nGPUs 50-51\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_26_stage_1 [label="Expert 26\nGPUs 52-53\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_27_stage_1 [label="Expert 27\nGPUs 54-55\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_28_stage_1 [label="Expert 28\nGPUs 56-57\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_29_stage_1 [label="Expert 29\nGPUs 58-59\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_30_stage_1 [label="Expert 30\nGPUs 60-61\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_31_stage_1 [label="Expert 31\nGPUs 62-63\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
	}
	subgraph cluster_stage_2 {
		color=blue fillcolor=lightyellow label="Pipeline Stage 2\nLayers 8-11\nGPUs 64-95" penwidth=3 style="rounded,filled"
		expert_32_stage_2 [label="Expert 32\nGPUs 64-65\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_33_stage_2 [label="Expert 33\nGPUs 66-67\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_34_stage_2 [label="Expert 34\nGPUs 68-69\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_35_stage_2 [label="Expert 35\nGPUs 70-71\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_36_stage_2 [label="Expert 36\nGPUs 72-73\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_37_stage_2 [label="Expert 37\nGPUs 74-75\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_38_stage_2 [label="Expert 38\nGPUs 76-77\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_39_stage_2 [label="Expert 39\nGPUs 78-79\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_40_stage_2 [label="Expert 40\nGPUs 80-81\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_41_stage_2 [label="Expert 41\nGPUs 82-83\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_42_stage_2 [label="Expert 42\nGPUs 84-85\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_43_stage_2 [label="Expert 43\nGPUs 86-87\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_44_stage_2 [label="Expert 44\nGPUs 88-89\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_45_stage_2 [label="Expert 45\nGPUs 90-91\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_46_stage_2 [label="Expert 46\nGPUs 92-93\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_47_stage_2 [label="Expert 47\nGPUs 94-95\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
	}
	subgraph cluster_stage_3 {
		color=blue fillcolor=lightyellow label="Pipeline Stage 3\nLayers 12-15\nGPUs 96-127" penwidth=3 style="rounded,filled"
		expert_48_stage_3 [label="Expert 48\nGPUs 96-97\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_49_stage_3 [label="Expert 49\nGPUs 98-99\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_50_stage_3 [label="Expert 50\nGPUs 100-101\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_51_stage_3 [label="Expert 51\nGPUs 102-103\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_52_stage_3 [label="Expert 52\nGPUs 104-105\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_53_stage_3 [label="Expert 53\nGPUs 106-107\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_54_stage_3 [label="Expert 54\nGPUs 108-109\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_55_stage_3 [label="Expert 55\nGPUs 110-111\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_56_stage_3 [label="Expert 56\nGPUs 112-113\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_57_stage_3 [label="Expert 57\nGPUs 114-115\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_58_stage_3 [label="Expert 58\nGPUs 116-117\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_59_stage_3 [label="Expert 59\nGPUs 118-119\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_60_stage_3 [label="Expert 60\nGPUs 120-121\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_61_stage_3 [label="Expert 61\nGPUs 122-123\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_62_stage_3 [label="Expert 62\nGPUs 124-125\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
		expert_63_stage_3 [label="Expert 63\nGPUs 126-127\n(Tensor Parallel)\n4 Layers" fillcolor=lightcyan penwidth=2]
	}
	moe_gate [label="MoE Gate\nExpert Routing\n[64 experts, top-2 selection]" fillcolor=orange penwidth=3 shape=parallelogram style="filled,dashed"]
	allreduce_attn [label="All-Reduce\nAttention Outputs" fillcolor=yellow penwidth=2 shape=ellipse style="filled,dashed"]
	allreduce_mlp [label="All-Reduce\nMLP Outputs" fillcolor=yellow penwidth=2 shape=ellipse style="filled,dashed"]
	expert_agg [label="Expert Aggregation\nTop-2 Expert Combination" fillcolor=orange penwidth=3 shape=parallelogram style="filled,dashed"]
	output [label="Output Logits\n[vocab_size]" fillcolor=lightgreen shape=ellipse style="filled,bold"]
	input -> moe_gate [penwidth=2 style=solid]
	moe_gate -> expert_0_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_1_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_2_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_3_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_4_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_5_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_6_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_7_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_8_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_9_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_10_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_11_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_12_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_13_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_14_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_15_stage_0 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_16_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_17_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_18_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_19_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_20_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_21_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_22_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_23_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_24_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_25_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_26_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_27_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_28_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_29_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_30_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_31_stage_1 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_32_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_33_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_34_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_35_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_36_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_37_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_38_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_39_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_40_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_41_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_42_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_43_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_44_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_45_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_46_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_47_stage_2 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_48_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_49_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_50_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_51_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_52_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_53_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_54_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_55_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_56_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_57_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_58_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_59_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_60_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_61_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_62_stage_3 [color=red penwidth=2 style=dashed]
	moe_gate -> expert_63_stage_3 [color=red penwidth=2 style=dashed]
	allreduce_attn -> allreduce_mlp [color=blue penwidth=2 style=dashed]
	allreduce_mlp -> expert_agg [penwidth=2 style=solid]
	expert_agg -> output [penwidth=3 style=solid]
}
