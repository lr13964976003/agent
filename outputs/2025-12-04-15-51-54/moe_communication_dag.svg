<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: MoE_128GPU_Communication Pages: 1 -->
<svg width="3274pt" height="724pt"
 viewBox="0.00 0.00 3274.14 724.24" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 720.24)">
<title>MoE_128GPU_Communication</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-720.24 3270.14,-720.24 3270.14,4 -4,4"/>
<!-- input_data -->
<g id="node1" class="node">
<title>input_data</title>
<ellipse fill="lightgreen" stroke="black" stroke-width="2" cx="157.68" cy="-165.74" rx="157.87" ry="26.74"/>
<text text-anchor="middle" x="157.68" y="-169.54" font-family="Arial" font-size="14.00">Input Data</text>
<text text-anchor="middle" x="157.68" y="-154.54" font-family="Arial" font-size="14.00">[batch_size, seq_len, hidden_size]</text>
</g>
<!-- expert_parallel -->
<g id="node2" class="node">
<title>expert_parallel</title>
<polygon fill="orange" stroke="black" stroke-width="3" stroke-dasharray="5,2" points="731.81,-203.74 516.06,-203.74 460.55,-127.74 676.31,-127.74 731.81,-203.74"/>
<text text-anchor="middle" x="596.18" y="-169.54" font-family="Arial" font-size="14.00">Expert Parallelism</text>
<text text-anchor="middle" x="596.18" y="-154.54" font-family="Arial" font-size="14.00">64&#45;way Partitioning</text>
</g>
<!-- input_data&#45;&gt;expert_parallel -->
<g id="edge1" class="edge">
<title>input_data&#45;&gt;expert_parallel</title>
<path fill="none" stroke="black" stroke-width="2" d="M304.06,-155.63C343.11,-155.39 392.53,-156.99 474.47,-160.44"/>
<polygon fill="black" stroke="black" stroke-width="2" points="474.48,-163.94 484.62,-160.87 474.78,-156.95 474.48,-163.94"/>
</g>
<!-- tensor_parallel -->
<g id="node3" class="node">
<title>tensor_parallel</title>
<polygon fill="purple" stroke="black" stroke-width="3" stroke-dasharray="5,2" points="1142.61,-378.74 931.18,-378.74 876.79,-302.74 1088.22,-302.74 1142.61,-378.74"/>
<text text-anchor="middle" x="1009.7" y="-344.54" font-family="Arial" font-size="14.00">Tensor Parallelism</text>
<text text-anchor="middle" x="1009.7" y="-329.54" font-family="Arial" font-size="14.00">2&#45;way Partitioning</text>
</g>
<!-- expert_parallel&#45;&gt;tensor_parallel -->
<g id="edge2" class="edge">
<title>expert_parallel&#45;&gt;tensor_parallel</title>
<path fill="none" stroke="red" stroke-width="2" stroke-dasharray="5,2" d="M656.3,-203.75C711.66,-237.08 753.07,-253.98 886.78,-299.39"/>
<polygon fill="red" stroke="red" stroke-width="2" points="885.98,-302.82 896.57,-302.71 888.23,-296.19 885.98,-302.82"/>
</g>
<!-- allgather_expert -->
<g id="node6" class="node">
<title>allgather_expert</title>
<ellipse fill="yellow" stroke="black" stroke-width="2" stroke-dasharray="5,2" cx="1792.23" cy="-33.74" rx="73.58" ry="26.74"/>
<text text-anchor="middle" x="1792.23" y="-37.54" font-family="Arial" font-size="14.00">All&#45;Gather</text>
<text text-anchor="middle" x="1792.23" y="-22.54" font-family="Arial" font-size="14.00">Expert Parallel</text>
</g>
<!-- expert_parallel&#45;&gt;allgather_expert -->
<g id="edge5" class="edge">
<title>expert_parallel&#45;&gt;allgather_expert</title>
<path fill="none" stroke="orange" stroke-width="2" stroke-dasharray="5,2" d="M675.1,-127.74C979.59,17.48 1040.98,19.5 1709.47,-27.86"/>
<polygon fill="orange" stroke="orange" stroke-width="2" points="1709.63,-31.38 1719.85,-28.59 1710.12,-24.39 1709.63,-31.38"/>
</g>
<!-- pipeline_parallel -->
<g id="node4" class="node">
<title>pipeline_parallel</title>
<polygon fill="green" stroke="black" stroke-width="3" stroke-dasharray="5,2" points="1567.29,-592.74 1344.71,-592.74 1287.45,-516.74 1510.03,-516.74 1567.29,-592.74"/>
<text text-anchor="middle" x="1427.37" y="-558.54" font-family="Arial" font-size="14.00">Pipeline Parallelism</text>
<text text-anchor="middle" x="1427.37" y="-543.54" font-family="Arial" font-size="14.00">4&#45;stage Pipeline</text>
</g>
<!-- tensor_parallel&#45;&gt;pipeline_parallel -->
<g id="edge3" class="edge">
<title>tensor_parallel&#45;&gt;pipeline_parallel</title>
<path fill="none" stroke="blue" stroke-width="2" stroke-dasharray="5,2" d="M1045.27,-378.76C1112.74,-449.42 1145.57,-469.6 1289.01,-513.73"/>
<polygon fill="blue" stroke="blue" stroke-width="2" points="1288.04,-517.09 1298.62,-516.67 1290.09,-510.39 1288.04,-517.09"/>
</g>
<!-- allreduce_tensor -->
<g id="node5" class="node">
<title>allreduce_tensor</title>
<ellipse fill="yellow" stroke="black" stroke-width="2" stroke-dasharray="5,2" cx="1792.23" cy="-340.74" rx="74.91" ry="26.74"/>
<text text-anchor="middle" x="1792.23" y="-344.54" font-family="Arial" font-size="14.00">All&#45;Reduce</text>
<text text-anchor="middle" x="1792.23" y="-329.54" font-family="Arial" font-size="14.00">Tensor Parallel</text>
</g>
<!-- tensor_parallel&#45;&gt;allreduce_tensor -->
<g id="edge4" class="edge">
<title>tensor_parallel&#45;&gt;allreduce_tensor</title>
<path fill="none" stroke="purple" stroke-width="2" stroke-dasharray="5,2" d="M1111.32,-334.92C1250.48,-327.66 1325.9,-328.88 1707.19,-338.57"/>
<polygon fill="purple" stroke="purple" stroke-width="2" points="1707.32,-342.08 1717.41,-338.83 1707.5,-335.08 1707.32,-342.08"/>
</g>
<!-- sendrecv_pipeline -->
<g id="node7" class="node">
<title>sendrecv_pipeline</title>
<ellipse fill="yellow" stroke="black" stroke-width="2" stroke-dasharray="5,2" cx="1792.23" cy="-597.74" rx="79.81" ry="26.74"/>
<text text-anchor="middle" x="1792.23" y="-601.54" font-family="Arial" font-size="14.00">Send/Recv</text>
<text text-anchor="middle" x="1792.23" y="-586.54" font-family="Arial" font-size="14.00">Pipeline Parallel</text>
</g>
<!-- pipeline_parallel&#45;&gt;sendrecv_pipeline -->
<g id="edge6" class="edge">
<title>pipeline_parallel&#45;&gt;sendrecv_pipeline</title>
<path fill="none" stroke="green" stroke-width="2" stroke-dasharray="5,2" d="M1498.91,-592.88C1587.94,-638.39 1620.82,-641.61 1719.73,-616.93"/>
<polygon fill="green" stroke="green" stroke-width="2" points="1720.68,-620.3 1729.51,-614.46 1718.96,-613.52 1720.68,-620.3"/>
</g>
<!-- gpu_group_0 -->
<g id="node8" class="node">
<title>gpu_group_0</title>
<polygon fill="lightcyan" stroke="black" stroke-width="2" points="2141.14,-342.24 2017.14,-342.24 2017.14,-289.24 2141.14,-289.24 2141.14,-342.24"/>
<text text-anchor="middle" x="2079.14" y="-327.04" font-family="Arial" font-size="14.00">GPU Group 0</text>
<text text-anchor="middle" x="2079.14" y="-312.04" font-family="Arial" font-size="14.00">GPUs 0&#45;31</text>
<text text-anchor="middle" x="2079.14" y="-297.04" font-family="Arial" font-size="14.00">(Pipeline Stage 0)</text>
</g>
<!-- allreduce_tensor&#45;&gt;gpu_group_0 -->
<g id="edge7" class="edge">
<title>allreduce_tensor&#45;&gt;gpu_group_0</title>
<path fill="none" stroke="black" stroke-width="2" d="M1864.92,-333.94C1940.69,-326.86 1975.71,-323.66 2006.53,-321.16"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2007.19,-324.62 2016.88,-320.34 2006.63,-317.64 2007.19,-324.62"/>
</g>
<!-- gpu_group_1 -->
<g id="node9" class="node">
<title>gpu_group_1</title>
<polygon fill="lightcyan" stroke="black" stroke-width="2" points="2516.14,-395.24 2392.14,-395.24 2392.14,-342.24 2516.14,-342.24 2516.14,-395.24"/>
<text text-anchor="middle" x="2454.14" y="-380.04" font-family="Arial" font-size="14.00">GPU Group 1</text>
<text text-anchor="middle" x="2454.14" y="-365.04" font-family="Arial" font-size="14.00">GPUs 32&#45;63</text>
<text text-anchor="middle" x="2454.14" y="-350.04" font-family="Arial" font-size="14.00">(Pipeline Stage 1)</text>
</g>
<!-- allreduce_tensor&#45;&gt;gpu_group_1 -->
<g id="edge10" class="edge">
<title>allreduce_tensor&#45;&gt;gpu_group_1</title>
<path fill="none" stroke="black" stroke-width="2" d="M1867.25,-342.71C2199.78,-351.46 2255.91,-353.36 2382.04,-363.05"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2381.8,-366.54 2392.04,-363.82 2382.34,-359.56 2381.8,-366.54"/>
</g>
<!-- gpu_group_2 -->
<g id="node10" class="node">
<title>gpu_group_2</title>
<polygon fill="lightcyan" stroke="black" stroke-width="2" points="2891.14,-395.24 2767.14,-395.24 2767.14,-342.24 2891.14,-342.24 2891.14,-395.24"/>
<text text-anchor="middle" x="2829.14" y="-380.04" font-family="Arial" font-size="14.00">GPU Group 2</text>
<text text-anchor="middle" x="2829.14" y="-365.04" font-family="Arial" font-size="14.00">GPUs 64&#45;95</text>
<text text-anchor="middle" x="2829.14" y="-350.04" font-family="Arial" font-size="14.00">(Pipeline Stage 2)</text>
</g>
<!-- allreduce_tensor&#45;&gt;gpu_group_2 -->
<g id="edge13" class="edge">
<title>allreduce_tensor&#45;&gt;gpu_group_2</title>
<path fill="none" stroke="black" stroke-width="2" d="M1867.14,-341.97C2461.64,-351.74 2522.46,-353.05 2756.56,-365"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2756.59,-368.51 2766.76,-365.52 2756.95,-361.52 2756.59,-368.51"/>
</g>
<!-- gpu_group_3 -->
<g id="node11" class="node">
<title>gpu_group_3</title>
<polygon fill="lightcyan" stroke="black" stroke-width="2" points="3266.14,-716.24 3142.14,-716.24 3142.14,-663.24 3266.14,-663.24 3266.14,-716.24"/>
<text text-anchor="middle" x="3204.14" y="-701.04" font-family="Arial" font-size="14.00">GPU Group 3</text>
<text text-anchor="middle" x="3204.14" y="-686.04" font-family="Arial" font-size="14.00">GPUs 96&#45;127</text>
<text text-anchor="middle" x="3204.14" y="-671.04" font-family="Arial" font-size="14.00">(Pipeline Stage 3)</text>
</g>
<!-- allreduce_tensor&#45;&gt;gpu_group_3 -->
<g id="edge16" class="edge">
<title>allreduce_tensor&#45;&gt;gpu_group_3</title>
<path fill="none" stroke="black" stroke-width="2" d="M1855.52,-355.19C2727.2,-554.18 2788.89,-568.76 3132.34,-668.8"/>
<polygon fill="black" stroke="black" stroke-width="2" points="3131.48,-672.19 3142.06,-671.63 3133.44,-665.47 3131.48,-672.19"/>
</g>
<!-- allgather_expert&#45;&gt;gpu_group_0 -->
<g id="edge8" class="edge">
<title>allgather_expert&#45;&gt;gpu_group_0</title>
<path fill="none" stroke="black" stroke-width="2" d="M1837.63,-54.96C1991.76,-127.52 2008.16,-144.22 2064.21,-279.4"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2061.08,-281 2068.14,-288.91 2067.55,-278.33 2061.08,-281"/>
</g>
<!-- allgather_expert&#45;&gt;gpu_group_1 -->
<g id="edge11" class="edge">
<title>allgather_expert&#45;&gt;gpu_group_1</title>
<path fill="none" stroke="black" stroke-width="2" d="M1852.41,-49.23C2240.29,-149.27 2270.29,-163.2 2423.74,-334.63"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2421.16,-336.99 2430.43,-342.11 2426.38,-332.32 2421.16,-336.99"/>
</g>
<!-- allgather_expert&#45;&gt;gpu_group_2 -->
<g id="edge14" class="edge">
<title>allgather_expert&#45;&gt;gpu_group_2</title>
<path fill="none" stroke="black" stroke-width="2" d="M1859.64,-44.66C2487.33,-146.47 2529.78,-157.94 2783.31,-336.36"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2781.45,-339.34 2791.64,-342.23 2785.48,-333.61 2781.45,-339.34"/>
</g>
<!-- allgather_expert&#45;&gt;gpu_group_3 -->
<g id="edge17" class="edge">
<title>allgather_expert&#45;&gt;gpu_group_3</title>
<path fill="none" stroke="black" stroke-width="2" d="M1847.46,-51.62C2775.59,-352.11 2815.12,-368.26 3164.33,-656.81"/>
<polygon fill="black" stroke="black" stroke-width="2" points="3162.18,-659.57 3172.12,-663.24 3166.64,-654.17 3162.18,-659.57"/>
</g>
<!-- sendrecv_pipeline&#45;&gt;gpu_group_0 -->
<g id="edge9" class="edge">
<title>sendrecv_pipeline&#45;&gt;gpu_group_0</title>
<path fill="none" stroke="black" stroke-width="2" d="M1834.96,-575.02C1997.58,-488.19 2015.06,-471.86 2064.36,-352.11"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2067.73,-353.12 2068.28,-342.54 2061.25,-350.46 2067.73,-353.12"/>
</g>
<!-- sendrecv_pipeline&#45;&gt;gpu_group_1 -->
<g id="edge12" class="edge">
<title>sendrecv_pipeline&#45;&gt;gpu_group_1</title>
<path fill="none" stroke="black" stroke-width="2" d="M1863.53,-585.39C2226.15,-522.4 2265.16,-510.75 2410.67,-401.64"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2413.15,-404.16 2419.04,-395.35 2408.95,-398.56 2413.15,-404.16"/>
</g>
<!-- sendrecv_pipeline&#45;&gt;gpu_group_2 -->
<g id="edge15" class="edge">
<title>sendrecv_pipeline&#45;&gt;gpu_group_2</title>
<path fill="none" stroke="black" stroke-width="2" d="M1868.77,-589.74C2470.85,-526.74 2525.52,-517.4 2766.16,-399.76"/>
<polygon fill="black" stroke="black" stroke-width="2" points="2767.73,-402.89 2775.17,-395.35 2764.65,-396.61 2767.73,-402.89"/>
</g>
<!-- sendrecv_pipeline&#45;&gt;gpu_group_3 -->
<g id="edge18" class="edge">
<title>sendrecv_pipeline&#45;&gt;gpu_group_3</title>
<path fill="none" stroke="black" stroke-width="2" d="M1866.31,-607.98C2713.3,-724.98 2773.76,-731.03 3131.87,-696.75"/>
<polygon fill="black" stroke="black" stroke-width="2" points="3132.39,-700.22 3142.01,-695.78 3131.72,-693.25 3132.39,-700.22"/>
</g>
<!-- gpu_group_0&#45;&gt;gpu_group_1 -->
<g id="edge19" class="edge">
<title>gpu_group_0&#45;&gt;gpu_group_1</title>
<path fill="none" stroke="green" stroke-width="2" stroke-dasharray="5,2" d="M2141.4,-321.47C2284.68,-334.73 2330.64,-339.72 2381.84,-350.92"/>
<polygon fill="green" stroke="green" stroke-width="2" points="2381.31,-354.39 2391.83,-353.17 2382.84,-347.56 2381.31,-354.39"/>
<text text-anchor="middle" x="2266.64" y="-319.14" font-family="Arial" font-size="12.00">Pipeline Send/Recv</text>
</g>
<!-- gpu_group_1&#45;&gt;gpu_group_2 -->
<g id="edge20" class="edge">
<title>gpu_group_1&#45;&gt;gpu_group_2</title>
<path fill="none" stroke="green" stroke-width="2" stroke-dasharray="5,2" d="M2516.23,-368.87C2659.5,-369.15 2705.25,-369.22 2756.82,-369.05"/>
<polygon fill="green" stroke="green" stroke-width="2" points="2756.91,-372.55 2766.89,-369.02 2756.88,-365.55 2756.91,-372.55"/>
<text text-anchor="middle" x="2641.64" y="-372.14" font-family="Arial" font-size="12.00">Pipeline Send/Recv</text>
</g>
<!-- gpu_group_2&#45;&gt;gpu_group_3 -->
<g id="edge21" class="edge">
<title>gpu_group_2&#45;&gt;gpu_group_3</title>
<path fill="none" stroke="green" stroke-width="2" stroke-dasharray="5,2" d="M2873.1,-395.3C3092.89,-528.24 3116.69,-546.64 3182.77,-654.44"/>
<polygon fill="green" stroke="green" stroke-width="2" points="3179.82,-656.34 3188.02,-663.05 3185.8,-652.69 3179.82,-656.34"/>
<text text-anchor="middle" x="3016.64" y="-479.14" font-family="Arial" font-size="12.00">Pipeline Send/Recv</text>
</g>
</g>
</svg>
