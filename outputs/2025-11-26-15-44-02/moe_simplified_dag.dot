digraph {
	graph [bb="0,0,570.02,801.26",
		bgcolor=white,
		rankdir=TB,
		splines=ortho
	];
	node [fontname=Arial,
		fontsize=10,
		label="\N"
	];
	input	[fillcolor=lightgreen,
		height=0.58926,
		label="INPUT\n[batch_size=B, seq_len=S, hidden_dim=7168]",
		pos="274.5,772.27",
		shape=ellipse,
		style=filled,
		width=4.2819];
	mha	[fillcolor=lightblue,
		height=0.56944,
		label="Multi-Head Attention\nGPU: 0\n[batch_size=B, seq_len=S, heads=128, d_k=128]",
		pos="274.5,686.78",
		shape=rectangle,
		style=filled,
		width=3.2361];
	input -> mha	[pos="e,274.5,707.46 274.5,750.7 274.5,750.7 274.5,717.46 274.5,717.46"];
	gate	[fillcolor=lightyellow,
		height=1.1389,
		label="Gate (Router)\nGPU: 0\n[batch_size=B, seq_len=S, num_experts=16]",
		pos="274.5,589.28",
		shape=parallelogram,
		style=filled,
		width=6.1629];
	mha -> gate	[pos="e,274.5,630.41 274.5,666.1 274.5,666.1 274.5,640.41 274.5,640.41"];
	split	[fillcolor=lightcoral,
		height=1.1389,
		label="Token Split\nGPU: 0\nRoute tokens to experts",
		pos="274.5,471.28",
		shape=parallelogram,
		style=filled,
		width=3.5134];
	gate -> split	[pos="e,274.5,512.33 274.5,548.01 274.5,548.01 274.5,522.33 274.5,522.33"];
	comm_to0	[fillcolor=lightgreen,
		height=0.58926,
		label="Send Tokens\nGPU: 0",
		pos="81.5,373.07",
		shape=ellipse,
		style="filled,dashed",
		width=1.4339];
	split -> comm_to0	[pos="e,133.26,373 155.45,471.21 155.45,468.23 155.45,373 155.45,373 155.45,373 143.26,373 143.26,373",
		style=dashed];
	comm_to1	[fillcolor=lightgreen,
		height=0.58926,
		label="Send Tokens\nGPU: 1",
		pos="214.5,373.07",
		shape=ellipse,
		style="filled,dashed",
		width=1.4339];
	split -> comm_to1	[pos="e,214.5,394.43 214.5,430.2 214.5,430.2 214.5,404.43 214.5,404.43",
		style=dashed];
	comm_to2	[fillcolor=lightgreen,
		height=0.58926,
		label="Send Tokens\nGPU: 2",
		pos="347.5,373.07",
		shape=ellipse,
		style="filled,dashed",
		width=1.4339];
	split -> comm_to2	[pos="e,347.5,394.43 347.5,430.2 347.5,430.2 347.5,404.43 347.5,404.43",
		style=dashed];
	comm_to3	[fillcolor=lightgreen,
		height=0.58926,
		label="Send Tokens\nGPU: 3",
		pos="486.5,373.07",
		shape=ellipse,
		style="filled,dashed",
		width=1.4339];
	split -> comm_to3	[pos="e,465.62,392.88 375.1,471 421.14,471 465.62,471 465.62,471 465.62,471 465.62,402.88 465.62,402.88",
		style=dashed];
	expert0	[fillcolor=lightblue,
		height=0.56944,
		label="Expert 0\nGPU: 0\nMLP Expert Computation",
		pos="63.5,295.35",
		shape=rectangle,
		style=filled,
		width=1.7639];
	comm_from0	[fillcolor=lightgreen,
		height=0.58926,
		label="Receive Output\nGPU: 0",
		pos="69.5,217.64",
		shape=ellipse,
		style=filled,
		width=1.6696];
	expert0 -> comm_from0	[pos="e,68.198,239.06 68.198,274.53 68.198,274.53 68.198,249.06 68.198,249.06"];
	comm_to0 -> expert0	[pos="e,78.441,316.03 78.441,351.83 78.441,351.83 78.441,326.03 78.441,326.03"];
	expert1	[fillcolor=lightblue,
		height=0.56944,
		label="Expert 1\nGPU: 1\nMLP Expert Computation",
		pos="208.5,295.35",
		shape=rectangle,
		style=filled,
		width=1.7639];
	comm_from1	[fillcolor=lightgreen,
		height=0.58926,
		label="Receive Output\nGPU: 0",
		pos="210.5,217.64",
		shape=ellipse,
		style=filled,
		width=1.6696];
	expert1 -> comm_from1	[pos="e,210.5,239.06 210.5,274.53 210.5,274.53 210.5,249.06 210.5,249.06"];
	comm_to1 -> expert1	[pos="e,214.5,316.03 214.5,351.83 214.5,351.83 214.5,326.03 214.5,326.03"];
	expert2	[fillcolor=lightblue,
		height=0.56944,
		label="Expert 2\nGPU: 2\nMLP Expert Computation",
		pos="353.5,295.35",
		shape=rectangle,
		style=filled,
		width=1.7639];
	comm_from2	[fillcolor=lightgreen,
		height=0.58926,
		label="Receive Output\nGPU: 0",
		pos="351.5,217.64",
		shape=ellipse,
		style=filled,
		width=1.6696];
	expert2 -> comm_from2	[pos="e,351.5,239.06 351.5,274.53 351.5,274.53 351.5,249.06 351.5,249.06"];
	comm_to2 -> expert2	[pos="e,347.5,316.03 347.5,351.83 347.5,351.83 347.5,326.03 347.5,326.03"];
	expert3	[fillcolor=lightblue,
		height=0.56944,
		label="Expert 3\nGPU: 3\nMLP Expert Computation",
		pos="498.5,295.35",
		shape=rectangle,
		style=filled,
		width=1.7639];
	comm_from3	[fillcolor=lightgreen,
		height=0.58926,
		label="Receive Output\nGPU: 0",
		pos="494.5,217.64",
		shape=ellipse,
		style=filled,
		width=1.6696];
	expert3 -> comm_from3	[pos="e,494.8,239.06 494.8,274.53 494.8,274.53 494.8,249.06 494.8,249.06"];
	comm_to3 -> expert3	[pos="e,486.56,316.03 486.56,351.83 486.56,351.83 486.56,326.03 486.56,326.03"];
	ellipsis1	[fillcolor=white,
		height=0.80532,
		label="...\n12 more experts\nGPUs 4-15",
		pos="508.5,772.27",
		shape=ellipse,
		style=dashed,
		width=1.7088];
	aggregate	[fillcolor=lightcoral,
		height=1.1389,
		label="Aggregate Experts\nGPU: 0\nCombine expert outputs",
		pos="280.5,119.43",
		shape=parallelogram,
		style=filled,
		width=3.4846];
	output	[fillcolor=lightgreen,
		height=0.58926,
		label="OUTPUT\n[batch_size=B, seq_len=S, hidden_dim=7168]",
		pos="280.5,21.213",
		shape=ellipse,
		style=filled,
		width=4.2819];
	aggregate -> output	[pos="e,280.5,42.573 280.5,78.344 280.5,78.344 280.5,52.573 280.5,52.573"];
	comm_from0 -> aggregate	[pos="e,180.41,119 67.873,196.24 67.873,167.23 67.873,119 67.873,119 67.873,119 170.41,119 170.41,119"];
	comm_from1 -> aggregate	[pos="e,212.83,160.49 212.83,196.33 212.83,196.33 212.83,170.49 212.83,170.49"];
	comm_from2 -> aggregate	[pos="e,348.67,160.49 348.67,196.33 348.67,196.33 348.67,170.49 348.67,170.49"];
	comm_from3 -> aggregate	[pos="e,380.04,119 494.63,196.24 494.63,167.23 494.63,119 494.63,119 494.63,119 390.04,119 390.04,119"];
}
