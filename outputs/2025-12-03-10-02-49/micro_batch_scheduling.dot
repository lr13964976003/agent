// Micro-Batch Pipeline Scheduling
digraph {
	dpi=300 rankdir=LR size="15,10"
	node [fontname=Arial fontsize=10]
	gpu0_input_0 -> gpu1_expert_1 [label=pipeline style=dashed]
	subgraph cluster_T0 {
		fillcolor=lightgray label="Time Step T0" style="rounded,filled"
		gpu0_input_0 [label="GPU 0
Input Proc
Micro-batch 0" fillcolor=lightgreen shape=rectangle]
	}
	gpu1_expert_1 -> comm_tp_1
	gpu2_expert_1 -> comm_tp_1
	gpu0_input_1 -> gpu1_expert_2 [label=pipeline style=dashed]
	subgraph cluster_T1 {
		fillcolor=lightgray label="Time Step T1" style="rounded,filled"
		gpu0_input_1 [label="GPU 0
Input Proc
Micro-batch 1" fillcolor=lightgreen shape=rectangle]
		gpu1_expert_1 [label="GPU 1
Expert TP
Micro-batch 0" fillcolor=lightcyan shape=rectangle]
		gpu2_expert_1 [label="GPU 2
Expert TP
Micro-batch 0" fillcolor=lightcyan shape=rectangle]
		comm_tp_1 [label="All-Reduce
Micro-batch 0" fillcolor=lightblue shape=ellipse]
	}
	gpu1_expert_2 -> comm_tp_2
	gpu2_expert_2 -> comm_tp_2
	gpu0_input_2 -> gpu1_expert_3 [label=pipeline style=dashed]
	subgraph cluster_T2 {
		fillcolor=lightgray label="Time Step T2" style="rounded,filled"
		gpu0_output_2 [label="GPU 0
Output Proc
Micro-batch 0" fillcolor=lightgreen shape=rectangle]
		gpu1_expert_2 [label="GPU 1
Expert TP
Micro-batch 1" fillcolor=lightcyan shape=rectangle]
		gpu2_expert_2 [label="GPU 2
Expert TP
Micro-batch 1" fillcolor=lightcyan shape=rectangle]
		comm_tp_2 [label="All-Reduce
Micro-batch 1" fillcolor=lightblue shape=ellipse]
	}
	gpu1_expert_3 -> comm_tp_3
	gpu2_expert_3 -> comm_tp_3
	gpu0_input_3 -> gpu1_expert_4 [label=pipeline style=dashed]
	subgraph cluster_T3 {
		fillcolor=lightgray label="Time Step T3" style="rounded,filled"
		gpu0_output_3 [label="GPU 0
Output Proc
Micro-batch 1" fillcolor=lightgreen shape=rectangle]
		gpu1_expert_3 [label="GPU 1
Expert TP
Micro-batch 2" fillcolor=lightcyan shape=rectangle]
		gpu2_expert_3 [label="GPU 2
Expert TP
Micro-batch 2" fillcolor=lightcyan shape=rectangle]
		comm_tp_3 [label="All-Reduce
Micro-batch 2" fillcolor=lightblue shape=ellipse]
	}
	gpu1_expert_4 -> comm_tp_4
	gpu2_expert_4 -> comm_tp_4
	gpu0_input_4 -> gpu1_expert_5 [label=pipeline style=dashed]
	subgraph cluster_T4 {
		fillcolor=lightgray label="Time Step T4" style="rounded,filled"
		gpu0_final_4 [label="GPU 0
Final
Micro-batch 2" fillcolor=lightgreen shape=rectangle]
		gpu1_expert_4 [label="GPU 1
Expert TP
Micro-batch 3" fillcolor=lightcyan shape=rectangle]
		gpu2_expert_4 [label="GPU 2
Expert TP
Micro-batch 3" fillcolor=lightcyan shape=rectangle]
		comm_tp_4 [label="All-Reduce
Micro-batch 3" fillcolor=lightblue shape=ellipse]
	}
	gpu1_expert_5 -> comm_tp_5
	gpu2_expert_5 -> comm_tp_5
	gpu0_input_5 -> gpu1_expert_6 [label=pipeline style=dashed]
	subgraph cluster_T5 {
		fillcolor=lightgray label="Time Step T5" style="rounded,filled"
		gpu0_final_5 [label="GPU 0
Final
Micro-batch 3" fillcolor=lightgreen shape=rectangle]
		gpu1_expert_5 [label="GPU 1
Expert TP
Micro-batch 4" fillcolor=lightcyan shape=rectangle]
		gpu2_expert_5 [label="GPU 2
Expert TP
Micro-batch 4" fillcolor=lightcyan shape=rectangle]
		comm_tp_5 [label="All-Reduce
Micro-batch 4" fillcolor=lightblue shape=ellipse]
	}
	subgraph cluster_T6 {
		fillcolor=lightgray label="Time Step T6" style="rounded,filled"
	}
	subgraph cluster_T7 {
		fillcolor=lightgray label="Time Step T7" style="rounded,filled"
	}
	subgraph cluster_T8 {
		fillcolor=lightgray label="Time Step T8" style="rounded,filled"
	}
}
