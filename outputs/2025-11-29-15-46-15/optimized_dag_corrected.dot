// Optimized DAG: Layer-wise Partitioning (Corrected - No Cycles)
digraph {
    nodesep=0.5 rankdir=TB ranksep=1.0 size="30,20"
    node [fontname=Arial fontsize=10]
    edge [fontname=Arial fontsize=8]
    
    // Input node
    input [label="Input\nBatch:128, Seq:10000\nDim:4096" fillcolor=lightcoral shape=ellipse]
    
    // GPU 0: Layers 0-3
    subgraph cluster_gpu0 {
        fillcolor=lightblue label="GPU 0: Layers 0-3 (Cache Optimized)" style=rounded
        
        // Layer 0
        attn_l0_g0 [label="Attention L0\nGPU 0\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l0_g0 [label="MLP L0\nGPU 0\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l0_g0 [label="LayerNorm L0\nGPU 0" fillcolor=lightgreen shape=rectangle]
        resid_l0_g0 [label="ResidAdd L0\nGPU 0" fillcolor=orange shape=parallelogram]
        
        // Layer 1
        attn_l1_g0 [label="Attention L1\nGPU 0\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l1_g0 [label="MLP L1\nGPU 0\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l1_g0 [label="LayerNorm L1\nGPU 0" fillcolor=lightgreen shape=rectangle]
        resid_l1_g0 [label="ResidAdd L1\nGPU 0" fillcolor=orange shape=parallelogram]
        
        // Layer 2
        attn_l2_g0 [label="Attention L2\nGPU 0\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l2_g0 [label="MLP L2\nGPU 0\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l2_g0 [label="LayerNorm L2\nGPU 0" fillcolor=lightgreen shape=rectangle]
        resid_l2_g0 [label="ResidAdd L2\nGPU 0" fillcolor=orange shape=parallelogram]
        
        // Layer 3
        attn_l3_g0 [label="Attention L3\nGPU 0\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l3_g0 [label="MLP L3\nGPU 0\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l3_g0 [label="LayerNorm L3\nGPU 0" fillcolor=lightgreen shape=rectangle]
        resid_l3_g0 [label="ResidAdd L3\nGPU 0" fillcolor=orange shape=parallelogram]
    }
    
    // GPU 1: Layers 4-7
    subgraph cluster_gpu1 {
        fillcolor=lightblue label="GPU 1: Layers 4-7 (Cache Optimized)" style=rounded
        
        // Layer 4
        attn_l4_g1 [label="Attention L4\nGPU 1\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l4_g1 [label="MLP L4\nGPU 1\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l4_g1 [label="LayerNorm L4\nGPU 1" fillcolor=lightgreen shape=rectangle]
        resid_l4_g1 [label="ResidAdd L4\nGPU 1" fillcolor=orange shape=parallelogram]
        
        // Layer 5
        attn_l5_g1 [label="Attention L5\nGPU 1\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l5_g1 [label="MLP L5\nGPU 1\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l5_g1 [label="LayerNorm L5\nGPU 1" fillcolor=lightgreen shape=rectangle]
        resid_l5_g1 [label="ResidAdd L5\nGPU 1" fillcolor=orange shape=parallelogram]
        
        // Layer 6
        attn_l6_g1 [label="Attention L6\nGPU 1\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l6_g1 [label="MLP L6\nGPU 1\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l6_g1 [label="LayerNorm L6\nGPU 1" fillcolor=lightgreen shape=rectangle]
        resid_l6_g1 [label="ResidAdd L6\nGPU 1" fillcolor=orange shape=parallelogram]
        
        // Layer 7
        attn_l7_g1 [label="Attention L7\nGPU 1\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l7_g1 [label="MLP L7\nGPU 1\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l7_g1 [label="LayerNorm L7\nGPU 1" fillcolor=lightgreen shape=rectangle]
        resid_l7_g1 [label="ResidAdd L7\nGPU 1" fillcolor=orange shape=parallelogram]
    }
    
    // GPU 2: Layers 8-11
    subgraph cluster_gpu2 {
        fillcolor=lightblue label="GPU 2: Layers 8-11 (Cache Optimized)" style=rounded
        
        // Layer 8
        attn_l8_g2 [label="Attention L8\nGPU 2\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l8_g2 [label="MLP L8\nGPU 2\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l8_g2 [label="LayerNorm L8\nGPU 2" fillcolor=lightgreen shape=rectangle]
        resid_l8_g2 [label="ResidAdd L8\nGPU 2" fillcolor=orange shape=parallelogram]
        
        // Layer 9
        attn_l9_g2 [label="Attention L9\nGPU 2\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l9_g2 [label="MLP L9\nGPU 2\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l9_g2 [label="LayerNorm L9\nGPU 2" fillcolor=lightgreen shape=rectangle]
        resid_l9_g2 [label="ResidAdd L9\nGPU 2" fillcolor=orange shape=parallelogram]
        
        // Layer 10
        attn_l10_g2 [label="Attention L10\nGPU 2\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l10_g2 [label="MLP L10\nGPU 2\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l10_g2 [label="LayerNorm L10\nGPU 2" fillcolor=lightgreen shape=rectangle]
        resid_l10_g2 [label="ResidAdd L10\nGPU 2" fillcolor=orange shape=parallelogram]
        
        // Layer 11
        attn_l11_g2 [label="Attention L11\nGPU 2\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l11_g2 [label="MLP L11\nGPU 2\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l11_g2 [label="LayerNorm L11\nGPU 2" fillcolor=lightgreen shape=rectangle]
        resid_l11_g2 [label="ResidAdd L11\nGPU 2" fillcolor=orange shape=parallelogram]
    }
    
    // GPU 3: Layers 12-15
    subgraph cluster_gpu3 {
        fillcolor=lightblue label="GPU 3: Layers 12-15 (Cache Optimized)" style=rounded
        
        // Layer 12
        attn_l12_g3 [label="Attention L12\nGPU 3\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l12_g3 [label="MLP L12\nGPU 3\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l12_g3 [label="LayerNorm L12\nGPU 3" fillcolor=lightgreen shape=rectangle]
        resid_l12_g3 [label="ResidAdd L12\nGPU 3" fillcolor=orange shape=parallelogram]
        
        // Layer 13
        attn_l13_g3 [label="Attention L13\nGPU 3\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l13_g3 [label="MLP L13\nGPU 3\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l13_g3 [label="LayerNorm L13\nGPU 3" fillcolor=lightgreen shape=rectangle]
        resid_l13_g3 [label="ResidAdd L13\nGPU 3" fillcolor=orange shape=parallelogram]
        
        // Layer 14
        attn_l14_g3 [label="Attention L14\nGPU 3\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l14_g3 [label="MLP L14\nGPU 3\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l14_g3 [label="LayerNorm L14\nGPU 3" fillcolor=lightgreen shape=rectangle]
        resid_l14_g3 [label="ResidAdd L14\nGPU 3" fillcolor=orange shape=parallelogram]
        
        // Layer 15
        attn_l15_g3 [label="Attention L15\nGPU 3\nQKV Proj+Attn+Output\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        mlp_l15_g3 [label="MLP L15\nGPU 3\n16384->16384\nComplete Layer" fillcolor=lightgreen shape=rectangle]
        norm_l15_g3 [label="LayerNorm L15\nGPU 3" fillcolor=lightgreen shape=rectangle]
        resid_l15_g3 [label="ResidAdd L15\nGPU 3" fillcolor=orange shape=parallelogram]
    }
    
    // Transfer nodes
    transfer_g0_g1 [label="Transfer\nGPU0->GPU1\n819.2MB" fillcolor=red shape=ellipse]
    transfer_g1_g2 [label="Transfer\nGPU1->GPU2\n819.2MB" fillcolor=red shape=ellipse]
    transfer_g2_g3 [label="Transfer\nGPU2->GPU3\n819.2MB" fillcolor=red shape=ellipse]
    
    // Output node
    output [label="Output\nBatch:128, Seq:10000\nDim:4096" fillcolor=lightcoral shape=ellipse]
    
    // Connections - Fixed to avoid cycles
    // Layer 0
    input -> attn_l0_g0
    attn_l0_g0 -> mlp_l0_g0
    mlp_l0_g0 -> norm_l0_g0
    norm_l0_g0 -> resid_l0_g0
    input -> resid_l0_g0
    resid_l0_g0 -> attn_l1_g0
    
    // Layer 1
    attn_l1_g0 -> mlp_l1_g0
    mlp_l1_g0 -> norm_l1_g0
    norm_l1_g0 -> resid_l1_g0
    resid_l0_g0 -> resid_l1_g0
    resid_l1_g0 -> attn_l2_g0
    
    // Layer 2
    attn_l2_g0 -> mlp_l2_g0
    mlp_l2_g0 -> norm_l2_g0
    norm_l2_g0 -> resid_l2_g0
    resid_l1_g0 -> resid_l2_g0
    resid_l2_g0 -> attn_l3_g0
    
    // Layer 3
    attn_l3_g0 -> mlp_l3_g0
    mlp_l3_g0 -> norm_l3_g0
    norm_l3_g0 -> resid_l3_g0
    resid_l2_g0 -> resid_l3_g0
    resid_l3_g0 -> transfer_g0_g1
    
    // Transfer to GPU 1
    transfer_g0_g1 -> attn_l4_g1
    
    // Layer 4
    attn_l4_g1 -> mlp_l4_g1
    mlp_l4_g1 -> norm_l4_g1
    norm_l4_g1 -> resid_l4_g1
    transfer_g0_g1 -> resid_l4_g1
    resid_l4_g1 -> attn_l5_g1
    
    // Layer 5
    attn_l5_g1 -> mlp_l5_g1
    mlp_l5_g1 -> norm_l5_g1
    norm_l5_g1 -> resid_l5_g1
    resid_l4_g1 -> resid_l5_g1
    resid_l5_g1 -> attn_l6_g1
    
    // Layer 6
    attn_l6_g1 -> mlp_l6_g1
    mlp_l6_g1 -> norm_l6_g1
    norm_l6_g1 -> resid_l6_g1
    resid_l5_g1 -> resid_l6_g1
    resid_l6_g1 -> attn_l7_g1
    
    // Layer 7
    attn_l7_g1 -> mlp_l7_g1
    mlp_l7_g1 -> norm_l7_g1
    norm_l7_g1 -> resid_l7_g1
    resid_l6_g1 -> resid_l7_g1
    resid_l7_g1 -> transfer_g1_g2
    
    // Transfer to GPU 2
    transfer_g1_g2 -> attn_l8_g2
    
    // Layer 8
    attn_l8_g2 -> mlp_l8_g2
    mlp_l8_g2 -> norm_l8_g2
    norm_l8_g2 -> resid_l8_g2
    transfer_g1_g2 -> resid_l8_g2
    resid_l8_g2 -> attn_l9_g2
    
    // Layer 9
    attn_l9_g2 -> mlp_l9_g2
    mlp_l9_g2 -> norm_l9_g2
    norm_l9_g2 -> resid_l9_g2
    resid_l8_g2 -> resid_l9_g2
    resid_l9_g2 -> attn_l10_g2
    
    // Layer 10
    attn_l10_g2 -> mlp_l10_g2
    mlp_l10_g2 -> norm_l10_g2
    norm_l10_g2 -> resid_l10_g2
    resid_l9_g2 -> resid_l10_g2
    resid_l10_g2 -> attn_l11_g2
    
    // Layer 11
    attn_l11_g2 -> mlp_l11_g2
    mlp_l11_g2 -> norm_l11_g2
    norm_l11_g2 -> resid_l11_g2
    resid_l10_g2 -> resid_l11_g2
    resid_l11_g2 -> transfer_g2_g3
    
    // Transfer to GPU 3
    transfer_g2_g3 -> attn_l12_g3
    
    // Layer 12
    attn_l12_g3 -> mlp_l12_g3
    mlp_l12_g3 -> norm_l12_g3
    norm_l12_g3 -> resid_l12_g3
    transfer_g2_g3 -> resid_l12_g3
    resid_l12_g3 -> attn_l13_g3
    
    // Layer 13
    attn_l13_g3 -> mlp_l13_g3
    mlp_l13_g3 -> norm_l13_g3
    norm_l13_g3 -> resid_l13_g3
    resid_l12_g3 -> resid_l13_g3
    resid_l13_g3 -> attn_l14_g3
    
    // Layer 14
    attn_l14_g3 -> mlp_l14_g3
    mlp_l14_g3 -> norm_l14_g3
    norm_l14_g3 -> resid_l14_g3
    resid_l13_g3 -> resid_l14_g3
    resid_l14_g3 -> attn_l15_g3
    
    // Layer 15
    attn_l15_g3 -> mlp_l15_g3
    mlp_l15_g3 -> norm_l15_g3
    norm_l15_g3 -> resid_l15_g3
    resid_l14_g3 -> resid_l15_g3
    resid_l15_g3 -> output
}
