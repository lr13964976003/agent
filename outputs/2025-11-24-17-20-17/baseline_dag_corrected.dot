digraph baseline_dag_corrected {
    rankdir=TB;
    splines=ortho;
    nodesep=0.5;
    ranksep=1.2;
    
    node [shape=ellipse, style=filled, fillcolor=lightblue];
    input [label="Model Input\nGPU: 0-15\nInput: [batch_size=128, seq_len=10000, hidden_dim=4096]"];
    output [label="Model Output\nGPU: 15\nOutput: [batch_size=128, seq_len=10000, hidden_dim=4096]"];
    
    subgraph cluster_stage_0 {
        label="Pipeline Stage 0\nGPUs: 0,1,2,3,4,5,6,7\nTensor Parallel Group: TP0\nLayers: 0-1";
        style=rounded,filled;
        fillcolor=lightgrey;
        
        /* Layer 0 */
        subgraph cluster_layer0 {
            label="Layer 0";
            style=dotted;
            
            /* MHA Layer 0 */
            subgraph cluster_layer0_mha {
                label="Multi-Head Attention Layer 0";
                
                node [shape=rectangle, style=filled, fillcolor=lightgreen];
                layer0_q_proj_0 [label="Q Projection\nGPU: 0\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_1 [label="Q Projection\nGPU: 1\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_2 [label="Q Projection\nGPU: 2\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_3 [label="Q Projection\nGPU: 3\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_4 [label="Q Projection\nGPU: 4\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_5 [label="Q Projection\nGPU: 5\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_6 [label="Q Projection\nGPU: 6\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_q_proj_7 [label="Q Projection\nGPU: 7\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer0_k_proj_0 [label="K Projection\nGPU: 0\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_1 [label="K Projection\nGPU: 1\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_2 [label="K Projection\nGPU: 2\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_3 [label="K Projection\nGPU: 3\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_4 [label="K Projection\nGPU: 4\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_5 [label="K Projection\nGPU: 5\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_6 [label="K Projection\nGPU: 6\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_k_proj_7 [label="K Projection\nGPU: 7\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer0_v_proj_0 [label="V Projection\nGPU: 0\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_1 [label="V Projection\nGPU: 1\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_2 [label="V Projection\nGPU: 2\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_3 [label="V Projection\nGPU: 3\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_4 [label="V Projection\nGPU: 4\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_5 [label="V Projection\nGPU: 5\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_6 [label="V Projection\nGPU: 6\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer0_v_proj_7 [label="V Projection\nGPU: 7\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer0_attention_0 [label="Attention Compute\nGPU: 0\nHeads: 0-3\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_1 [label="Attention Compute\nGPU: 1\nHeads: 4-7\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_2 [label="Attention Compute\nGPU: 2\nHeads: 8-11\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_3 [label="Attention Compute\nGPU: 3\nHeads: 12-15\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_4 [label="Attention Compute\nGPU: 4\nHeads: 16-19\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_5 [label="Attention Compute\nGPU: 5\nHeads: 20-23\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_6 [label="Attention Compute\nGPU: 6\nHeads: 24-27\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer0_attention_7 [label="Attention Compute\nGPU: 7\nHeads: 28-31\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                
                node [shape=parallelogram, style=filled, fillcolor=yellow];
                layer0_allreduce_0 [label="All-Reduce\nGPU: 0\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_1 [label="All-Reduce\nGPU: 1\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_2 [label="All-Reduce\nGPU: 2\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_3 [label="All-Reduce\nGPU: 3\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_4 [label="All-Reduce\nGPU: 4\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_5 [label="All-Reduce\nGPU: 5\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_6 [label="All-Reduce\nGPU: 6\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer0_allreduce_7 [label="All-Reduce\nGPU: 7\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                
                node [shape=hexagon, style=filled, fillcolor=lightcoral];
                layer0_concat [label="Concatenate\nGPU: [0,1,2,3,4,5,6,7]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                layer0_residual [label="Residual Add\nGPU: 0\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
            }
            
            /* MLP Layer 0 */
            subgraph cluster_layer0_mlp {
                label="MLP Layer 0";
                
                node [shape=rectangle, style=filled, fillcolor=lightgreen];
                layer0_mlp_fc1_0 [label="MLP FC1\nGPU: 0\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_1 [label="MLP FC1\nGPU: 1\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_2 [label="MLP FC1\nGPU: 2\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_3 [label="MLP FC1\nGPU: 3\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_4 [label="MLP FC1\nGPU: 4\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_5 [label="MLP FC1\nGPU: 5\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_6 [label="MLP FC1\nGPU: 6\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer0_mlp_fc1_7 [label="MLP FC1\nGPU: 7\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                
                layer0_mlp_fc2_0 [label="MLP FC2\nGPU: 0\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_1 [label="MLP FC2\nGPU: 1\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_2 [label="MLP FC2\nGPU: 2\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_3 [label="MLP FC2\nGPU: 3\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_4 [label="MLP FC2\nGPU: 4\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_5 [label="MLP FC2\nGPU: 5\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_6 [label="MLP FC2\nGPU: 6\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer0_mlp_fc2_7 [label="MLP FC2\nGPU: 7\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                
                node [shape=parallelogram, style=filled, fillcolor=yellow];
                layer0_mlp_allreduce_0 [label="All-Reduce\nGPU: 0\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_1 [label="All-Reduce\nGPU: 1\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_2 [label="All-Reduce\nGPU: 2\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_3 [label="All-Reduce\nGPU: 3\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_4 [label="All-Reduce\nGPU: 4\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_5 [label="All-Reduce\nGPU: 5\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_6 [label="All-Reduce\nGPU: 6\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer0_mlp_allreduce_7 [label="All-Reduce\nGPU: 7\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                
                node [shape=hexagon, style=filled, fillcolor=lightcoral];
                layer0_mlp_concat [label="Concatenate\nGPU: [0,1,2,3,4,5,6,7]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                layer0_mlp_residual [label="Residual Add\nGPU: 0\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
            }
        }
        
        /* Layer 1 (same structure as Layer 0) */
        subgraph cluster_layer1 {
            label="Layer 1";
            style=dotted;
            
            /* MHA Layer 1 */
            subgraph cluster_layer1_mha {
                label="Multi-Head Attention Layer 1";
                
                node [shape=rectangle, style=filled, fillcolor=lightgreen];
                layer1_q_proj_0 [label="Q Projection\nGPU: 0\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_1 [label="Q Projection\nGPU: 1\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_2 [label="Q Projection\nGPU: 2\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_3 [label="Q Projection\nGPU: 3\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_4 [label="Q Projection\nGPU: 4\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_5 [label="Q Projection\nGPU: 5\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_6 [label="Q Projection\nGPU: 6\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_q_proj_7 [label="Q Projection\nGPU: 7\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer1_k_proj_0 [label="K Projection\nGPU: 0\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_1 [label="K Projection\nGPU: 1\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_2 [label="K Projection\nGPU: 2\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_3 [label="K Projection\nGPU: 3\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_4 [label="K Projection\nGPU: 4\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_5 [label="K Projection\nGPU: 5\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_6 [label="K Projection\nGPU: 6\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_k_proj_7 [label="K Projection\nGPU: 7\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer1_v_proj_0 [label="V Projection\nGPU: 0\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_1 [label="V Projection\nGPU: 1\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_2 [label="V Projection\nGPU: 2\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_3 [label="V Projection\nGPU: 3\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_4 [label="V Projection\nGPU: 4\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_5 [label="V Projection\nGPU: 5\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_6 [label="V Projection\nGPU: 6\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer1_v_proj_7 [label="V Projection\nGPU: 7\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer1_attention_0 [label="Attention Compute\nGPU: 0\nHeads: 0-3\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_1 [label="Attention Compute\nGPU: 1\nHeads: 4-7\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_2 [label="Attention Compute\nGPU: 2\nHeads: 8-11\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_3 [label="Attention Compute\nGPU: 3\nHeads: 12-15\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_4 [label="Attention Compute\nGPU: 4\nHeads: 16-19\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_5 [label="Attention Compute\nGPU: 5\nHeads: 20-23\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_6 [label="Attention Compute\nGPU: 6\nHeads: 24-27\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer1_attention_7 [label="Attention Compute\nGPU: 7\nHeads: 28-31\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                
                node [shape=parallelogram, style=filled, fillcolor=yellow];
                layer1_allreduce_0 [label="All-Reduce\nGPU: 0\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_1 [label="All-Reduce\nGPU: 1\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_2 [label="All-Reduce\nGPU: 2\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_3 [label="All-Reduce\nGPU: 3\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_4 [label="All-Reduce\nGPU: 4\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_5 [label="All-Reduce\nGPU: 5\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_6 [label="All-Reduce\nGPU: 6\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer1_allreduce_7 [label="All-Reduce\nGPU: 7\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                
                node [shape=hexagon, style=filled, fillcolor=lightcoral];
                layer1_concat [label="Concatenate\nGPU: [0,1,2,3,4,5,6,7]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                layer1_residual [label="Residual Add\nGPU: 0\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
            }
            
            /* MLP Layer 1 */
            subgraph cluster_layer1_mlp {
                label="MLP Layer 1";
                
                node [shape=rectangle, style=filled, fillcolor=lightgreen];
                layer1_mlp_fc1_0 [label="MLP FC1\nGPU: 0\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_1 [label="MLP FC1\nGPU: 1\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_2 [label="MLP FC1\nGPU: 2\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_3 [label="MLP FC1\nGPU: 3\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_4 [label="MLP FC1\nGPU: 4\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_5 [label="MLP FC1\nGPU: 5\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_6 [label="MLP FC1\nGPU: 6\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer1_mlp_fc1_7 [label="MLP FC1\nGPU: 7\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                
                layer1_mlp_fc2_0 [label="MLP FC2\nGPU: 0\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_1 [label="MLP FC2\nGPU: 1\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_2 [label="MLP FC2\nGPU: 2\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_3 [label="MLP FC2\nGPU: 3\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_4 [label="MLP FC2\nGPU: 4\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_5 [label="MLP FC2\nGPU: 5\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_6 [label="MLP FC2\nGPU: 6\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer1_mlp_fc2_7 [label="MLP FC2\nGPU: 7\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                
                node [shape=parallelogram, style=filled, fillcolor=yellow];
                layer1_mlp_allreduce_0 [label="All-Reduce\nGPU: 0\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_1 [label="All-Reduce\nGPU: 1\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_2 [label="All-Reduce\nGPU: 2\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_3 [label="All-Reduce\nGPU: 3\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_4 [label="All-Reduce\nGPU: 4\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_5 [label="All-Reduce\nGPU: 5\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_6 [label="All-Reduce\nGPU: 6\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer1_mlp_allreduce_7 [label="All-Reduce\nGPU: 7\nCollective: [0,1,2,3,4,5,6,7]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                
                node [shape=hexagon, style=filled, fillcolor=lightcoral];
                layer1_mlp_concat [label="Concatenate\nGPU: [0,1,2,3,4,5,6,7]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                layer1_mlp_residual [label="Residual Add\nGPU: 0\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
            }
        }
    }
    
    subgraph cluster_stage_1 {
        label="Pipeline Stage 1\nGPUs: 8,9,10,11,12,13,14,15\nTensor Parallel Group: TP1\nLayers: 2-3";
        style=rounded,filled;
        fillcolor=lightgrey;
        
        /* Layer 2 */
        subgraph cluster_layer2 {
            label="Layer 2";
            style=dotted;
            
            /* MHA Layer 2 */
            subgraph cluster_layer2_mha {
                label="Multi-Head Attention Layer 2";
                
                node [shape=rectangle, style=filled, fillcolor=lightgreen];
                layer2_q_proj_0 [label="Q Projection\nGPU: 8\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_1 [label="Q Projection\nGPU: 9\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_2 [label="Q Projection\nGPU: 10\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_3 [label="Q Projection\nGPU: 11\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_4 [label="Q Projection\nGPU: 12\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_5 [label="Q Projection\nGPU: 13\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_6 [label="Q Projection\nGPU: 14\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_q_proj_7 [label="Q Projection\nGPU: 15\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer2_k_proj_0 [label="K Projection\nGPU: 8\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_1 [label="K Projection\nGPU: 9\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_2 [label="K Projection\nGPU: 10\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_3 [label="K Projection\nGPU: 11\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_4 [label="K Projection\nGPU: 12\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_5 [label="K Projection\nGPU: 13\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_6 [label="K Projection\nGPU: 14\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_k_proj_7 [label="K Projection\nGPU: 15\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer2_v_proj_0 [label="V Projection\nGPU: 8\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_1 [label="V Projection\nGPU: 9\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_2 [label="V Projection\nGPU: 10\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_3 [label="V Projection\nGPU: 11\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_4 [label="V Projection\nGPU: 12\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_5 [label="V Projection\nGPU: 13\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_6 [label="V Projection\nGPU: 14\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                layer2_v_proj_7 [label="V Projection\nGPU: 15\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                
                layer2_attention_0 [label="Attention Compute\nGPU: 8\nHeads: 0-3\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_1 [label="Attention Compute\nGPU: 9\nHeads: 4-7\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_2 [label="Attention Compute\nGPU: 10\nHeads: 8-11\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_3 [label="Attention Compute\nGPU: 11\nHeads: 12-15\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_4 [label="Attention Compute\nGPU: 12\nHeads: 16-19\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_5 [label="Attention Compute\nGPU: 13\nHeads: 20-23\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_6 [label="Attention Compute\nGPU: 14\nHeads: 24-27\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                layer2_attention_7 [label="Attention Compute\nGPU: 15\nHeads: 28-31\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                
                node [shape=parallelogram, style=filled, fillcolor=yellow];
                layer2_allreduce_0 [label="All-Reduce\nGPU: 8\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_1 [label="All-Reduce\nGPU: 9\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_2 [label="All-Reduce\nGPU: 10\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_3 [label="All-Reduce\nGPU: 11\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_4 [label="All-Reduce\nGPU: 12\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_5 [label="All-Reduce\nGPU: 13\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_6 [label="All-Reduce\nGPU: 14\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                layer2_allreduce_7 [label="All-Reduce\nGPU: 15\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                
                node [shape=hexagon, style=filled, fillcolor=lightcoral];
                layer2_concat [label="Concatenate\nGPU: [8,9,10,11,12,13,14,15]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                layer2_residual [label="Residual Add\nGPU: 8\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
            }
            
            /* MLP Layer 2 */
            subgraph cluster_layer2_mlp {
                label="MLP Layer 2";
                
                node [shape=rectangle, style=filled, fillcolor=lightgreen];
                layer2_mlp_fc1_0 [label="MLP FC1\nGPU: 8\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_1 [label="MLP FC1\nGPU: 9\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_2 [label="MLP FC1\nGPU: 10\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_3 [label="MLP FC1\nGPU: 11\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_4 [label="MLP FC1\nGPU: 12\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_5 [label="MLP FC1\nGPU: 13\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_6 [label="MLP FC1\nGPU: 14\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                layer2_mlp_fc1_7 [label="MLP FC1\nGPU: 15\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                
                layer2_mlp_fc2_0 [label="MLP FC2\nGPU: 8\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_1 [label="MLP FC2\nGPU: 9\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_2 [label="MLP FC2\nGPU: 10\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_3 [label="MLP FC2\nGPU: 11\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_4 [label="MLP FC2\nGPU: 12\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_5 [label="MLP FC2\nGPU: 13\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_6 [label="MLP FC2\nGPU: 14\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                layer2_mlp_fc2_7 [label="MLP FC2\nGPU: 15\nWeight: [2048,4096]\nInput: [128,10000,2048]\nOutput: [128,10000,4096]"];
                
                node [shape=parallelogram, style=filled, fillcolor=yellow];
                layer2_mlp_allreduce_0 [label="All-Reduce\nGPU: 8\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_1 [label="All-Reduce\nGPU: 9\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_2 [label="All-Reduce\nGPU: 10\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_3 [label="All-Reduce\nGPU: 11\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_4 [label="All-Reduce\nGPU: 12\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_5 [label="All-Reduce\nGPU: 13\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_6 [label="All-Reduce\nGPU: 14\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                layer2_mlp_allreduce_7 [label="All-Reduce\nGPU: 15\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,4096]\nOutput: [128,10000,4096]"];
                
                node [shape=hexagon, style=filled, fillcolor=lightcoral];
                layer2_mlp_concat [label="Concatenate\nGPU: [8,9,10,11,12,13,14,15]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                layer2_mlp_residual [label="Residual Add\nGPU: 8\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
            }
            
            /* Layer 3 */
            subgraph cluster_layer3 {
                label="Layer 3";
                style=dotted;
                
                /* MHA Layer 3 */
                subgraph cluster_layer3_mha {
                    label="Multi-Head Attention Layer 3";
                    
                    node [shape=rectangle, style=filled, fillcolor=lightgreen];
                    layer3_q_proj_0 [label="Q Projection\nGPU: 8\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_1 [label="Q Projection\nGPU: 9\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_2 [label="Q Projection\nGPU: 10\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_3 [label="Q Projection\nGPU: 11\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_4 [label="Q Projection\nGPU: 12\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_5 [label="Q Projection\nGPU: 13\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_6 [label="Q Projection\nGPU: 14\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_q_proj_7 [label="Q Projection\nGPU: 15\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    
                    layer3_k_proj_0 [label="K Projection\nGPU: 8\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_1 [label="K Projection\nGPU: 9\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_2 [label="K Projection\nGPU: 10\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_3 [label="K Projection\nGPU: 11\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_4 [label="K Projection\nGPU: 12\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_5 [label="K Projection\nGPU: 13\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_6 [label="K Projection\nGPU: 14\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_k_proj_7 [label="K Projection\nGPU: 15\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    
                    layer3_v_proj_0 [label="V Projection\nGPU: 8\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_1 [label="V Projection\nGPU: 9\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_2 [label="V Projection\nGPU: 10\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_3 [label="V Projection\nGPU: 11\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_4 [label="V Projection\nGPU: 12\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_5 [label="V Projection\nGPU: 13\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_6 [label="V Projection\nGPU: 14\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    layer3_v_proj_7 [label="V Projection\nGPU: 15\nWeight: [4096,512]\nInput: [128,10000,4096]\nOutput: [128,10000,512]"];
                    
                    layer3_attention_0 [label="Attention Compute\nGPU: 8\nHeads: 0-3\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_1 [label="Attention Compute\nGPU: 9\nHeads: 4-7\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_2 [label="Attention Compute\nGPU: 10\nHeads: 8-11\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_3 [label="Attention Compute\nGPU: 11\nHeads: 12-15\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_4 [label="Attention Compute\nGPU: 12\nHeads: 16-19\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_5 [label="Attention Compute\nGPU: 13\nHeads: 20-23\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_6 [label="Attention Compute\nGPU: 14\nHeads: 24-27\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    layer3_attention_7 [label="Attention Compute\nGPU: 15\nHeads: 28-31\nInput: [128,10000,512]×3\nOutput: [128,10000,512]"];
                    
                    node [shape=parallelogram, style=filled, fillcolor=yellow];
                    layer3_allreduce_0 [label="All-Reduce\nGPU: 8\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_1 [label="All-Reduce\nGPU: 9\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_2 [label="All-Reduce\nGPU: 10\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_3 [label="All-Reduce\nGPU: 11\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_4 [label="All-Reduce\nGPU: 12\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_5 [label="All-Reduce\nGPU: 13\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_6 [label="All-Reduce\nGPU: 14\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    layer3_allreduce_7 [label="All-Reduce\nGPU: 15\nCollective: [8,9,10,11,12,13,14,15]\nInput: [128,10000,512]\nOutput: [128,10000,512]"];
                    
                    node [shape=hexagon, style=filled, fillcolor=lightcoral];
                    layer3_concat [label="Concatenate\nGPU: [8,9,10,11,12,13,14,15]\nInput: 8×[128,10000,512]\nOutput: [128,10000,4096]"];
                    layer3_residual [label="Residual Add\nGPU: 8\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
                }
                
                /* MLP Layer 3 */
                subgraph cluster_layer3_mlp {
                    label="MLP Layer 3";
                    
                    node [shape=rectangle, style=filled, fillcolor=lightgreen];
                    layer3_mlp_fc1_0 [label="MLP FC1\nGPU: 8\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                    layer3_mlp_fc1_1 [label="MLP FC1\nGPU: 9\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                    layer3_mlp_fc1_2 [label="MLP FC1\nGPU: 10\nWeight: [4096,2048]\nInput: [128,10000,4096]\nOutput: [128,10000,2048]"];
                    layer3_mlp