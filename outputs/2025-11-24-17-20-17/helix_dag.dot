digraph helix_dag {
    rankdir=TB;
    splines=ortho;
    nodesep=0.3;
    ranksep=0.8;
    
    node [shape=ellipse, style=filled, fillcolor=lightblue];
    input [label="Model Input\n[B=128, L=10000, D=4096]\nBroadcast to all 16 GPUs"];
    output [label="Model Output\n[B=128, L=10000, D=4096]"];
    
    subgraph cluster_layer0 {
        label="Layer 0 - Helix 4×4 Partitioning";
        style=rounded,filled;
        fillcolor=lightgrey;
        
        /* Head Group 0: GPUs 0-3 */
        subgraph cluster_hg0_0 {
            label="Head Group 0\nGPUs [0-3]";
            
            node [shape=rectangle, style=filled, fillcolor=lightgreen];
            layer0_q_0_0 [label="Layer0 Q Proj\nGPU:0\nPartition(0,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_0_0 [label="Layer0 K Proj\nGPU:0\nPartition(0,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_0_0 [label="Layer0 V Proj\nGPU:0\nPartition(0,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_0_0 [label="Layer0 Attention\nGPU:0\nPartition(0,0)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_0_1 [label="Layer0 Q Proj\nGPU:1\nPartition(0,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_0_1 [label="Layer0 K Proj\nGPU:1\nPartition(0,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_0_1 [label="Layer0 V Proj\nGPU:1\nPartition(0,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_0_1 [label="Layer0 Attention\nGPU:1\nPartition(0,1)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_0_2 [label="Layer0 Q Proj\nGPU:2\nPartition(0,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_0_2 [label="Layer0 K Proj\nGPU:2\nPartition(0,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_0_2 [label="Layer0 V Proj\nGPU:2\nPartition(0,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_0_2 [label="Layer0 Attention\nGPU:2\nPartition(0,2)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_0_3 [label="Layer0 Q Proj\nGPU:3\nPartition(0,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_0_3 [label="Layer0 K Proj\nGPU:3\nPartition(0,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_0_3 [label="Layer0 V Proj\nGPU:3\nPartition(0,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_0_3 [label="Layer0 Attention\nGPU:3\nPartition(0,3)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
        }
        
        /* Head Group 1: GPUs 4-7 */
        subgraph cluster_hg0_1 {
            label="Head Group 1\nGPUs [4-7]";
            
            node [shape=rectangle, style=filled, fillcolor=lightgreen];
            layer0_q_1_0 [label="Layer0 Q Proj\nGPU:4\nPartition(1,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_1_0 [label="Layer0 K Proj\nGPU:4\nPartition(1,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_1_0 [label="Layer0 V Proj\nGPU:4\nPartition(1,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_1_0 [label="Layer0 Attention\nGPU:4\nPartition(1,0)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_1_1 [label="Layer0 Q Proj\nGPU:5\nPartition(1,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_1_1 [label="Layer0 K Proj\nGPU:5\nPartition(1,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_1_1 [label="Layer0 V Proj\nGPU:5\nPartition(1,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_1_1 [label="Layer0 Attention\nGPU:5\nPartition(1,1)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_1_2 [label="Layer0 Q Proj\nGPU:6\nPartition(1,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_1_2 [label="Layer0 K Proj\nGPU:6\nPartition(1,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_1_2 [label="Layer0 V Proj\nGPU:6\nPartition(1,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_1_2 [label="Layer0 Attention\nGPU:6\nPartition(1,2)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_1_3 [label="Layer0 Q Proj\nGPU:7\nPartition(1,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_1_3 [label="Layer0 K Proj\nGPU:7\nPartition(1,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_1_3 [label="Layer0 V Proj\nGPU:7\nPartition(1,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_1_3 [label="Layer0 Attention\nGPU:7\nPartition(1,3)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
        }
        
        /* Head Group 2: GPUs 8-11 */
        subgraph cluster_hg0_2 {
            label="Head Group 2\nGPUs [8-11]";
            
            node [shape=rectangle, style=filled, fillcolor=lightgreen];
            layer0_q_2_0 [label="Layer0 Q Proj\nGPU:8\nPartition(2,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_2_0 [label="Layer0 K Proj\nGPU:8\nPartition(2,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_2_0 [label="Layer0 V Proj\nGPU:8\nPartition(2,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_2_0 [label="Layer0 Attention\nGPU:8\nPartition(2,0)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_2_1 [label="Layer0 Q Proj\nGPU:9\nPartition(2,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_2_1 [label="Layer0 K Proj\nGPU:9\nPartition(2,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_2_1 [label="Layer0 V Proj\nGPU:9\nPartition(2,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_2_1 [label="Layer0 Attention\nGPU:9\nPartition(2,1)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_2_2 [label="Layer0 Q Proj\nGPU:10\nPartition(2,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_2_2 [label="Layer0 K Proj\nGPU:10\nPartition(2,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_2_2 [label="Layer0 V Proj\nGPU:10\nPartition(2,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_2_2 [label="Layer0 Attention\nGPU:10\nPartition(2,2)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_2_3 [label="Layer0 Q Proj\nGPU:11\nPartition(2,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_2_3 [label="Layer0 K Proj\nGPU:11\nPartition(2,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_2_3 [label="Layer0 V Proj\nGPU:11\nPartition(2,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_2_3 [label="Layer0 Attention\nGPU:11\nPartition(2,3)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
        }
        
        /* Head Group 3: GPUs 12-15 */
        subgraph cluster_hg0_3 {
            label="Head Group 3\nGPUs [12-15]";
            
            node [shape=rectangle, style=filled, fillcolor=lightgreen];
            layer0_q_3_0 [label="Layer0 Q Proj\nGPU:12\nPartition(3,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_3_0 [label="Layer0 K Proj\nGPU:12\nPartition(3,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_3_0 [label="Layer0 V Proj\nGPU:12\nPartition(3,0)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_3_0 [label="Layer0 Attention\nGPU:12\nPartition(3,0)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_3_1 [label="Layer0 Q Proj\nGPU:13\nPartition(3,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_3_1 [label="Layer0 K Proj\nGPU:13\nPartition(3,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_3_1 [label="Layer0 V Proj\nGPU:13\nPartition(3,1)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_3_1 [label="Layer0 Attention\nGPU:13\nPartition(3,1)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_3_2 [label="Layer0 Q Proj\nGPU:14\nPartition(3,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_3_2 [label="Layer0 K Proj\nGPU:14\nPartition(3,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_3_2 [label="Layer0 V Proj\nGPU:14\nPartition(3,2)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_3_2 [label="Layer0 Attention\nGPU:14\nPartition(3,2)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
            
            layer0_q_3_3 [label="Layer0 Q Proj\nGPU:15\nPartition(3,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_k_3_3 [label="Layer0 K Proj\nGPU:15\nPartition(3,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_v_3_3 [label="Layer0 V Proj\nGPU:15\nPartition(3,3)\nInput: [128,10000,4096]\nOutput: [128,10000,32,8]"];
            layer0_attn_3_3 [label="Layer0 Attention\nGPU:15\nPartition(3,3)\nInput: [128,10000,32,8]×3\nOutput: [128,10000,32,8]"];
        }
        
        /* Intra-group concatenation nodes */
        node [shape=hexagon, style=filled, fillcolor=lightcoral];
        layer0_hg_concat_0 [label="Intra-Group Concat\nHead Group 0\nGPUs: 0-3\nInput: 4×[128,10000,32,8]\nOutput: [128,10000,128,8]"];
        layer0_hg_concat_1 [label="Intra-Group Concat\nHead Group 1\nGPUs: 4-7\nInput: 4×[128,10000,32,8]\nOutput: [128,10000,128,8]"];
        layer0_hg_concat_2 [label="Intra-Group Concat\nHead Group 2\nGPUs: 8-11\nInput: 4×[128,10000,32,8]\nOutput: [128,10000,128,8]"];
        layer0_hg_concat_3 [label="Intra-Group Concat\nHead Group 3\nGPUs: 12-15\nInput: 4×[128,10000,32,8]\nOutput: [128,10000,128,8]"];
        
        /* Inter-group concatenation */
        layer0_final_concat [label="Inter-Group Concat\nAll Head Groups\nGPUs: 0,4,8,12\nInput: 4×[128,10000,128,8]\nOutput: [128,10000,4096]"];
        
        /* MLP (after concatenation) */
        node [shape=rectangle, style=filled, fillcolor=lightgreen];
        layer0_mlp_fc1 [label="Layer0 MLP FC1\nAll GPUs\nInput: [128,10000,4096]\nOutput: [128,10000,16384]"];
        layer0_mlp_fc2 [label="Layer0 MLP FC2\nAll GPUs\nInput: [128,10000,16384]\nOutput: [128,10000,4096]"];
        
        node [shape=hexagon, style=filled, fillcolor=lightcoral];
        layer0_mha_residual [label="Layer0 MHA Residual\nAll GPUs\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
        layer0_mlp_residual [label="Layer0 MLP Residual\nAll GPUs\nInput1: [128,10000,4096]\nInput2: [128,10000,4096]\nOutput: [128,10000,4096]"];
    }
    
    /* Simplified representation for layers 1-3 */
    subgraph cluster_layers_1_3 {
        label="Layers 1-3 (Repeated 3×)";
        style=dashed;
        
        node [shape=rectangle, style=filled, fillcolor=lightgrey];
        layer1_helix [label="Layer 1: 16×(32×8) partitions\nSame structure as Layer 0"];
        layer2_helix [label="Layer 2: 16×(32×8) partitions\nSame structure as Layer 0"];
        layer3_helix [label="Layer 3: 16×(32×8) partitions\nSame structure as Layer 0"];
    }
    
    /* Connect layer 0 to layer 1 */
    layer0_mlp_residual -> layer1_helix;
    layer1_helix -> layer2_helix;
    layer2_helix -> layer3_helix;
    layer3_helix -> output;
    
    /* Detailed connections for Layer 0 */
    /* Input to all partitions */
    input -> layer0_q_0_0;
    input -> layer0_k_0_0;
    input -> layer0_v_0_0;
    input -> layer0_q_0_1;
    input -> layer0_k_0_1;
    input -> layer0_v_0_1;
    input -> layer0_q_0_2;
    input -> layer0_k_0_2;
    input -> layer0_v_0_2;
    input -> layer0_q_0_3;
    input -> layer0_k_0_3;
    input -> layer0_v_0_3;
    
    input -> layer0_q_1_0;
    input -> layer0_k_1_0;
    input -> layer0_v_1_0;
    input -> layer0_q_1_1;
    input -> layer0_k_1_1;
    input -> layer0_v_1_1;
    input -> layer0_q_1_2;
    input -> layer0_k_1_2;
    input -> layer0_v_1_2;
    input -> layer0_q_1_3;
    input -> layer0_k_1_3;
    input -> layer0_v_1_3;
    
    input -> layer0_q_2_0;
    input -> layer0_k_2_0;
    input -> layer0_v_2_0;
    input -> layer0_q_2_1;
    input -> layer0_k_2_1;
    input -> layer0_v_2_1;
    input -> layer0_q_2_2;
    input -> layer0_k_2_2;
    input -> layer0_v_2_2;
    input -> layer0_q_2_3;
    input -> layer0_k_2_3;
    input -> layer0_v_2_3;
    
    input -> layer0_q_3_0;
    input -> layer0_k_3_0;
    input -> layer0_v_3_0;
    input -> layer0_q_3_1;
    input -> layer0_k_3_1;
    input -> layer0_v_3_1;
    input -> layer0_q_3_2;
    input -> layer0_k_3_2;
    input -> layer0_v_3_2;
    input -> layer0_q_3_3;
    input -> layer0_k_3_3;
    input -> layer0_v_3_3;
    
    /* Projections to attention */
    layer0_q_0_0 -> layer0_attn_0_0;
    layer0_k_0_0 -> layer0_attn_0_0;
    layer0_v_0_0 -> layer0_attn_0_0;
    
    layer0_q_0_1 -> layer0_attn_0_1;
    layer0_k_0_1 -> layer0_attn_0_1;
    layer0_v_0_1 -> layer0_attn_0_1;
    
    layer0_q_0_2 -> layer0_attn_0_2;
    layer0_k_0_2 -> layer0_attn_0_2;
    layer0_v_0_2 -> layer0_attn_0_2;
    
    layer0_q_0_3 -> layer0_attn_0_3;
    layer0_k_0_3 -> layer0_attn_0_3;
    layer0_v_0_3 -> layer0_attn_0_3;
    
    layer0_q_1_0 -> layer0_attn_1_0;
    layer0_k_1_0 -> layer0_attn_1_0;
    layer0_v_1_0 -> layer0_attn_1_0;
    
    layer0_q_1_1 -> layer0_attn_1_1;
    layer0_k_1_1 -> layer0_attn_1_1;
    layer0_v_1_1 -> layer0_attn_1_1;
    
    layer0_q_1_2 -> layer0_attn_1_2;
    layer0_k_1_2 -> layer0_attn_1_2;
    layer0_v_1_2 -> layer0_attn_1_2;
    
    layer0_q_1_3 -> layer0_attn_1_3;
    layer0_k_1_3 -> layer0_attn_1_3;
    layer0_v_1_3 -> layer0_attn_1_3;
    
    layer0_q_2_0 -> layer0_attn_2_0;
    layer0_k_2_0 -> layer0_attn_2_0;
    layer0_v_2_0 -> layer0_attn_2_0;
    
    layer0_q_2_1 -> layer0_attn_2_1;
    layer0_k_2_1 -> layer0_attn_2_1;
    layer0_v_2_1 -> layer0_attn_2_1;
    
    layer0_q_2_2 -> layer0_attn_2_2;
    layer0_k_2_2 -> layer0_attn_2_2;
    layer0_v_2_2 -> layer0_attn_2_2;
    
    layer0_q_2_3 -> layer0_attn_2_3;
    layer0_k_2_3 -> layer0_attn_2_3;
    layer0_v_2_3 -> layer0_attn_2_3;
    
    layer0_q_3_0 -> layer0_attn_3_0;
    layer0_k_3_0 -> layer0_attn_3_0;
    layer0_v_3_0 -> layer0_attn_3_0;
    
    layer0_q_3_1 -> layer0_attn_3_1;
    layer0_k_3_1 -> layer0_attn_3_1;
    layer0_v_3_1 -> layer0_attn_3_1;
    
    layer0_q_3_2 -> layer0_attn_3_2;
    layer0_k_3_2 -> layer0_attn_3_2;
    layer0_v_3_2 -> layer0_attn_3_2;
    
    layer0_q_3_3 -> layer0_attn_3_3;
    layer0_k_3_3 -> layer0_attn_3_3;
    layer0_v_3_3 -> layer0_attn_3_3;
    
    /* Attention to intra-group concatenation */
    layer0_attn_0_0 -> layer0_hg_concat_0;
    layer0_attn_0_1 -> layer0_hg_concat_0;
    layer0_attn_0_2 -> layer0_hg_concat_0;
    layer0_attn_0_3 -> layer0_hg_concat_0;
    
    layer0_attn_1_0 -> layer0_hg_concat_1;
    layer0_attn_1_1 -> layer0_hg_concat_1;
    layer0_attn_1_2 -> layer0_hg_concat_1;
    layer0_attn_1_3 -> layer0_hg_concat_1;
    
    layer0_attn_2_0 -> layer0_hg_concat_2;
    layer0_attn_2_1 -> layer0_hg_concat_2;
    layer0_attn_2_2 -> layer0_hg_concat_2;
    layer0_attn_2_3 -> layer0_hg_concat_2;
    
    layer0_attn_3_0 -> layer0_hg_concat_3;
    layer0_attn_3_1 -> layer0_hg_concat_3;
    layer0_attn_3_2 -> layer0_hg_concat_3;
    layer0_attn_3_3 -> layer0_hg_concat_3;
    
    /* Intra-group to inter-group concatenation */
    layer0_hg_concat_0 -> layer0_final_concat;
    layer0_hg_concat_1 -> layer0_final_concat;
    layer0_hg_concat_2 -> layer0_final_concat;
    layer0_hg_concat_3 -> layer0_final_concat;
    
    /* MLP flow */
    input -> layer0_mha_residual;
    layer0_final_concat -> layer0_mha_residual;
    layer0_mha_residual -> layer0_mlp_fc1;
    layer0_mlp_fc1 -> layer0_mlp_fc2;
    layer0_mha_residual -> layer0_mlp_residual;
    layer0_mlp_fc2 -> layer0_mlp_residual;
}