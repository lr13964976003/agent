<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="1554pt" height="33350pt"
 viewBox="0.00 0.00 1554.14 33349.52" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 33345.52)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-33345.52 1550.14,-33345.52 1550.14,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_legend</title>
<polygon fill="white" stroke="black" stroke-dasharray="1,5" points="8,-33258.52 8,-33333.52 682,-33333.52 682,-33258.52 8,-33258.52"/>
<text text-anchor="middle" x="345" y="-33318.32" font-family="Times,serif" font-size="14.00">Legend</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_pp0</title>
<path fill="white" stroke="blue" d="M902,-25009.64C902,-25009.64 1336,-25009.64 1336,-25009.64 1342,-25009.64 1348,-25015.64 1348,-25021.64 1348,-25021.64 1348,-33139.52 1348,-33139.52 1348,-33145.52 1342,-33151.52 1336,-33151.52 1336,-33151.52 902,-33151.52 902,-33151.52 896,-33151.52 890,-33145.52 890,-33139.52 890,-33139.52 890,-25021.64 890,-25021.64 890,-25015.64 896,-25009.64 902,-25009.64"/>
<text text-anchor="middle" x="1119" y="-33136.32" font-family="Times,serif" font-size="14.00">PP Stage 0 (Layers 0&#45;3) – GPUs 0&#45;15</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_pp1</title>
<path fill="white" stroke="green" d="M890,-16717.76C890,-16717.76 1348,-16717.76 1348,-16717.76 1354,-16717.76 1360,-16723.76 1360,-16729.76 1360,-16729.76 1360,-24989.64 1360,-24989.64 1360,-24995.64 1354,-25001.64 1348,-25001.64 1348,-25001.64 890,-25001.64 890,-25001.64 884,-25001.64 878,-24995.64 878,-24989.64 878,-24989.64 878,-16729.76 878,-16729.76 878,-16723.76 884,-16717.76 890,-16717.76"/>
<text text-anchor="middle" x="1119" y="-24986.44" font-family="Times,serif" font-size="14.00">PP Stage 1 (Layers 4&#45;7) – GPUs 16&#45;31</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_pp2</title>
<path fill="white" stroke="orange" d="M890,-8425.88C890,-8425.88 1348,-8425.88 1348,-8425.88 1354,-8425.88 1360,-8431.88 1360,-8437.88 1360,-8437.88 1360,-16697.76 1360,-16697.76 1360,-16703.76 1354,-16709.76 1348,-16709.76 1348,-16709.76 890,-16709.76 890,-16709.76 884,-16709.76 878,-16703.76 878,-16697.76 878,-16697.76 878,-8437.88 878,-8437.88 878,-8431.88 884,-8425.88 890,-8425.88"/>
<text text-anchor="middle" x="1119" y="-16694.56" font-family="Times,serif" font-size="14.00">PP Stage 2 (Layers 8&#45;11) – GPUs 32&#45;47</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_pp3</title>
<path fill="white" stroke="red" d="M890,-134C890,-134 1348,-134 1348,-134 1354,-134 1360,-140 1360,-146 1360,-146 1360,-8405.88 1360,-8405.88 1360,-8411.88 1354,-8417.88 1348,-8417.88 1348,-8417.88 890,-8417.88 890,-8417.88 884,-8417.88 878,-8411.88 878,-8405.88 878,-8405.88 878,-146 878,-146 878,-140 884,-134 890,-134"/>
<text text-anchor="middle" x="1119" y="-8402.68" font-family="Times,serif" font-size="14.00">PP Stage 3 (Layers 12&#45;15) – GPUs 48&#45;63</text>
</g>
<!-- comp -->
<g id="node1" class="node">
<title>comp</title>
<path fill="none" stroke="black" d="M662,-33302.52C662,-33302.52 580,-33302.52 580,-33302.52 574,-33302.52 568,-33296.52 568,-33290.52 568,-33290.52 568,-33278.52 568,-33278.52 568,-33272.52 574,-33266.52 580,-33266.52 580,-33266.52 662,-33266.52 662,-33266.52 668,-33266.52 674,-33272.52 674,-33278.52 674,-33278.52 674,-33290.52 674,-33290.52 674,-33296.52 668,-33302.52 662,-33302.52"/>
<text text-anchor="middle" x="621" y="-33280.82" font-family="Helvetica,sans-Serif" font-size="14.00">Computation</text>
</g>
<!-- comm -->
<g id="node2" class="node">
<title>comm</title>
<ellipse fill="none" stroke="black" cx="469" cy="-33284.52" rx="81.49" ry="18"/>
<text text-anchor="middle" x="469" y="-33280.82" font-family="Helvetica,sans-Serif" font-size="14.00">Communication</text>
</g>
<!-- route -->
<g id="node3" class="node">
<title>route</title>
<path fill="none" stroke="black" d="M358.49,-33302.52C358.49,-33302.52 100.14,-33302.52 100.14,-33302.52 94.14,-33302.52 82.77,-33299.85 77.39,-33297.19 77.39,-33297.19 26.26,-33271.85 26.26,-33271.85 20.88,-33269.18 21.51,-33266.52 27.51,-33266.52 27.51,-33266.52 285.86,-33266.52 285.86,-33266.52 291.86,-33266.52 303.23,-33269.18 308.61,-33271.85 308.61,-33271.85 359.74,-33297.19 359.74,-33297.19 365.12,-33299.85 364.49,-33302.52 358.49,-33302.52"/>
<text text-anchor="middle" x="193" y="-33280.82" font-family="Helvetica,sans-Serif" font-size="14.00">Split / Route / Aggregate</text>
</g>
<!-- input -->
<g id="node4" class="node">
<title>input</title>
<path fill="none" stroke="black" d="M1534.28,-33337.52C1534.28,-33337.52 878.57,-33337.52 878.57,-33337.52 872.57,-33337.52 861.44,-33334.41 856.31,-33331.3 856.31,-33331.3 701.98,-33237.74 701.98,-33237.74 696.85,-33234.63 697.72,-33231.52 703.72,-33231.52 703.72,-33231.52 1359.43,-33231.52 1359.43,-33231.52 1365.43,-33231.52 1376.56,-33234.63 1381.69,-33237.74 1381.69,-33237.74 1536.02,-33331.3 1536.02,-33331.3 1541.15,-33334.41 1540.28,-33337.52 1534.28,-33337.52"/>
<text text-anchor="start" x="770.2" y="-33295.82" font-family="Helvetica,sans-Serif" font-size="14.00">Input</text>
<text text-anchor="start" x="770.2" y="-33280.82" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [batch_size=128, seq_len=10240, hidden=1024]</text>
<text text-anchor="start" x="770.2" y="-33265.82" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- split0 -->
<g id="node313" class="node">
<title>split0</title>
<path fill="none" stroke="black" d="M1134.5,-33195.52C1134.5,-33195.52 1103.5,-33195.52 1103.5,-33195.52 1097.5,-33195.52 1091.5,-33189.52 1091.5,-33183.52 1091.5,-33183.52 1091.5,-33171.52 1091.5,-33171.52 1091.5,-33165.52 1097.5,-33159.52 1103.5,-33159.52 1103.5,-33159.52 1134.5,-33159.52 1134.5,-33159.52 1140.5,-33159.52 1146.5,-33165.52 1146.5,-33171.52 1146.5,-33171.52 1146.5,-33183.52 1146.5,-33183.52 1146.5,-33189.52 1140.5,-33195.52 1134.5,-33195.52"/>
<text text-anchor="middle" x="1119" y="-33173.82" font-family="Helvetica,sans-Serif" font-size="14.00">split0</text>
</g>
<!-- input&#45;&gt;split0 -->
<g id="edge1" class="edge">
<title>input&#45;&gt;split0</title>
<path fill="none" stroke="black" d="M1119,-33231.33C1119,-33222.65 1119,-33213.96 1119,-33206.21"/>
<polygon fill="black" stroke="black" points="1122.5,-33205.98 1119,-33195.98 1115.5,-33205.98 1122.5,-33205.98"/>
</g>
<!-- qkv_c0 -->
<g id="node5" class="node">
<title>qkv_c0</title>
<path fill="none" stroke="black" d="M1241,-33120.52C1241,-33120.52 997,-33120.52 997,-33120.52 991,-33120.52 985,-33114.52 985,-33108.52 985,-33108.52 985,-33079.52 985,-33079.52 985,-33073.52 991,-33067.52 997,-33067.52 997,-33067.52 1241,-33067.52 1241,-33067.52 1247,-33067.52 1253,-33073.52 1253,-33079.52 1253,-33079.52 1253,-33108.52 1253,-33108.52 1253,-33114.52 1247,-33120.52 1241,-33120.52"/>
<text text-anchor="start" x="993" y="-33105.32" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-33090.32" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-33075.32" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- qkv_ar0 -->
<g id="node6" class="node">
<title>qkv_ar0</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-32994.04" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-33005.34" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-32990.34" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-32975.34" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c0&#45;&gt;qkv_ar0 -->
<g id="edge3" class="edge">
<title>qkv_c0&#45;&gt;qkv_ar0</title>
<path fill="none" stroke="black" d="M1119,-33067.28C1119,-33059.45 1119,-33050.6 1119,-33041.84"/>
<polygon fill="black" stroke="black" points="1122.5,-33041.66 1119,-33031.66 1115.5,-33041.66 1122.5,-33041.66"/>
</g>
<!-- sph0 -->
<g id="node7" class="node">
<title>sph0</title>
<path fill="none" stroke="black" d="M1327.66,-32920.57C1327.66,-32920.57 1000.64,-32920.57 1000.64,-32920.57 994.64,-32920.57 984.75,-32916 980.86,-32911.43 980.86,-32911.43 906.12,-32823.7 906.12,-32823.7 902.23,-32819.13 904.34,-32814.57 910.34,-32814.57 910.34,-32814.57 1237.36,-32814.57 1237.36,-32814.57 1243.36,-32814.57 1253.25,-32819.13 1257.14,-32823.7 1257.14,-32823.7 1331.88,-32911.43 1331.88,-32911.43 1335.77,-32916 1333.66,-32920.57 1327.66,-32920.57"/>
<text text-anchor="start" x="942.54" y="-32878.87" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-32863.87" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-32848.87" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar0&#45;&gt;sph0 -->
<g id="edge4" class="edge">
<title>qkv_ar0&#45;&gt;sph0</title>
<path fill="none" stroke="black" d="M1119,-32956.37C1119,-32948.33 1119,-32939.6 1119,-32930.87"/>
<polygon fill="black" stroke="black" points="1122.5,-32930.66 1119,-32920.66 1115.5,-32930.66 1122.5,-32930.66"/>
</g>
<!-- sdp0 -->
<g id="node8" class="node">
<title>sdp0</title>
<path fill="none" stroke="black" d="M1220,-32778.57C1220,-32778.57 1018,-32778.57 1018,-32778.57 1012,-32778.57 1006,-32772.57 1006,-32766.57 1006,-32766.57 1006,-32737.57 1006,-32737.57 1006,-32731.57 1012,-32725.57 1018,-32725.57 1018,-32725.57 1220,-32725.57 1220,-32725.57 1226,-32725.57 1232,-32731.57 1232,-32737.57 1232,-32737.57 1232,-32766.57 1232,-32766.57 1232,-32772.57 1226,-32778.57 1220,-32778.57"/>
<text text-anchor="start" x="1014" y="-32763.37" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-32748.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-32733.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph0&#45;&gt;sdp0 -->
<g id="edge5" class="edge">
<title>sph0&#45;&gt;sdp0</title>
<path fill="none" stroke="black" d="M1119,-32814.47C1119,-32805.79 1119,-32796.98 1119,-32788.83"/>
<polygon fill="black" stroke="black" points="1122.5,-32788.58 1119,-32778.58 1115.5,-32788.58 1122.5,-32788.58"/>
</g>
<!-- sm0 -->
<g id="node9" class="node">
<title>sm0</title>
<path fill="none" stroke="black" d="M1182.5,-32689.57C1182.5,-32689.57 1055.5,-32689.57 1055.5,-32689.57 1049.5,-32689.57 1043.5,-32683.57 1043.5,-32677.57 1043.5,-32677.57 1043.5,-32648.57 1043.5,-32648.57 1043.5,-32642.57 1049.5,-32636.57 1055.5,-32636.57 1055.5,-32636.57 1182.5,-32636.57 1182.5,-32636.57 1188.5,-32636.57 1194.5,-32642.57 1194.5,-32648.57 1194.5,-32648.57 1194.5,-32677.57 1194.5,-32677.57 1194.5,-32683.57 1188.5,-32689.57 1182.5,-32689.57"/>
<text text-anchor="start" x="1051.5" y="-32674.37" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-32659.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-32644.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp0&#45;&gt;sm0 -->
<g id="edge6" class="edge">
<title>sdp0&#45;&gt;sm0</title>
<path fill="none" stroke="black" d="M1119,-32725.43C1119,-32717.45 1119,-32708.5 1119,-32699.95"/>
<polygon fill="black" stroke="black" points="1122.5,-32699.81 1119,-32689.82 1115.5,-32699.82 1122.5,-32699.81"/>
</g>
<!-- do0 -->
<g id="node10" class="node">
<title>do0</title>
<path fill="none" stroke="black" d="M1166.5,-32600.57C1166.5,-32600.57 1071.5,-32600.57 1071.5,-32600.57 1065.5,-32600.57 1059.5,-32594.57 1059.5,-32588.57 1059.5,-32588.57 1059.5,-32559.57 1059.5,-32559.57 1059.5,-32553.57 1065.5,-32547.57 1071.5,-32547.57 1071.5,-32547.57 1166.5,-32547.57 1166.5,-32547.57 1172.5,-32547.57 1178.5,-32553.57 1178.5,-32559.57 1178.5,-32559.57 1178.5,-32588.57 1178.5,-32588.57 1178.5,-32594.57 1172.5,-32600.57 1166.5,-32600.57"/>
<text text-anchor="start" x="1067.5" y="-32585.37" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-32570.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-32555.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm0&#45;&gt;do0 -->
<g id="edge7" class="edge">
<title>sm0&#45;&gt;do0</title>
<path fill="none" stroke="black" d="M1119,-32636.43C1119,-32628.45 1119,-32619.5 1119,-32610.95"/>
<polygon fill="black" stroke="black" points="1122.5,-32610.81 1119,-32600.82 1115.5,-32610.82 1122.5,-32610.81"/>
</g>
<!-- mgh0 -->
<g id="node11" class="node">
<title>mgh0</title>
<path fill="none" stroke="black" d="M1323.86,-32511.57C1323.86,-32511.57 1002.88,-32511.57 1002.88,-32511.57 996.88,-32511.57 987.03,-32506.96 983.18,-32502.36 983.18,-32502.36 909.84,-32414.77 909.84,-32414.77 905.99,-32410.17 908.14,-32405.57 914.14,-32405.57 914.14,-32405.57 1235.12,-32405.57 1235.12,-32405.57 1241.12,-32405.57 1250.97,-32410.17 1254.82,-32414.77 1254.82,-32414.77 1328.16,-32502.36 1328.16,-32502.36 1332.01,-32506.96 1329.86,-32511.57 1323.86,-32511.57"/>
<text text-anchor="start" x="946" y="-32469.87" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-32454.87" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-32439.87" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do0&#45;&gt;mgh0 -->
<g id="edge8" class="edge">
<title>do0&#45;&gt;mgh0</title>
<path fill="none" stroke="black" d="M1119,-32547.31C1119,-32539.61 1119,-32530.82 1119,-32521.83"/>
<polygon fill="black" stroke="black" points="1122.5,-32521.66 1119,-32511.66 1115.5,-32521.66 1122.5,-32521.66"/>
</g>
<!-- proj_r0 -->
<g id="node12" class="node">
<title>proj_r0</title>
<path fill="none" stroke="black" d="M1219,-32369.57C1219,-32369.57 1019,-32369.57 1019,-32369.57 1013,-32369.57 1007,-32363.57 1007,-32357.57 1007,-32357.57 1007,-32328.57 1007,-32328.57 1007,-32322.57 1013,-32316.57 1019,-32316.57 1019,-32316.57 1219,-32316.57 1219,-32316.57 1225,-32316.57 1231,-32322.57 1231,-32328.57 1231,-32328.57 1231,-32357.57 1231,-32357.57 1231,-32363.57 1225,-32369.57 1219,-32369.57"/>
<text text-anchor="start" x="1015" y="-32354.37" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-32339.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-32324.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh0&#45;&gt;proj_r0 -->
<g id="edge9" class="edge">
<title>mgh0&#45;&gt;proj_r0</title>
<path fill="none" stroke="black" d="M1119,-32405.47C1119,-32396.79 1119,-32387.98 1119,-32379.83"/>
<polygon fill="black" stroke="black" points="1122.5,-32379.58 1119,-32369.58 1115.5,-32379.58 1122.5,-32379.58"/>
</g>
<!-- proj_ar0 -->
<g id="node13" class="node">
<title>proj_ar0</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-32243.09" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-32254.39" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-32239.39" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-32224.39" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r0&#45;&gt;proj_ar0 -->
<g id="edge10" class="edge">
<title>proj_r0&#45;&gt;proj_ar0</title>
<path fill="none" stroke="black" d="M1119,-32316.32C1119,-32308.5 1119,-32299.64 1119,-32290.88"/>
<polygon fill="black" stroke="black" points="1122.5,-32290.71 1119,-32280.71 1115.5,-32290.71 1122.5,-32290.71"/>
</g>
<!-- norm0 -->
<g id="node14" class="node">
<title>norm0</title>
<path fill="none" stroke="black" d="M1204,-32169.61C1204,-32169.61 1034,-32169.61 1034,-32169.61 1028,-32169.61 1022,-32163.61 1022,-32157.61 1022,-32157.61 1022,-32128.61 1022,-32128.61 1022,-32122.61 1028,-32116.61 1034,-32116.61 1034,-32116.61 1204,-32116.61 1204,-32116.61 1210,-32116.61 1216,-32122.61 1216,-32128.61 1216,-32128.61 1216,-32157.61 1216,-32157.61 1216,-32163.61 1210,-32169.61 1204,-32169.61"/>
<text text-anchor="start" x="1030" y="-32154.41" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-32139.41" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-32124.41" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar0&#45;&gt;norm0 -->
<g id="edge11" class="edge">
<title>proj_ar0&#45;&gt;norm0</title>
<path fill="none" stroke="black" d="M1119,-32205.61C1119,-32197.19 1119,-32188.25 1119,-32179.86"/>
<polygon fill="black" stroke="black" points="1122.5,-32179.62 1119,-32169.62 1115.5,-32179.62 1122.5,-32179.62"/>
</g>
<!-- gate_c0 -->
<g id="node15" class="node">
<title>gate_c0</title>
<path fill="none" stroke="black" d="M1218.5,-32080.61C1218.5,-32080.61 1019.5,-32080.61 1019.5,-32080.61 1013.5,-32080.61 1007.5,-32074.61 1007.5,-32068.61 1007.5,-32068.61 1007.5,-32039.61 1007.5,-32039.61 1007.5,-32033.61 1013.5,-32027.61 1019.5,-32027.61 1019.5,-32027.61 1218.5,-32027.61 1218.5,-32027.61 1224.5,-32027.61 1230.5,-32033.61 1230.5,-32039.61 1230.5,-32039.61 1230.5,-32068.61 1230.5,-32068.61 1230.5,-32074.61 1224.5,-32080.61 1218.5,-32080.61"/>
<text text-anchor="start" x="1015.5" y="-32065.41" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-32050.41" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-32035.41" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm0&#45;&gt;gate_c0 -->
<g id="edge12" class="edge">
<title>norm0&#45;&gt;gate_c0</title>
<path fill="none" stroke="black" d="M1119,-32116.48C1119,-32108.5 1119,-32099.54 1119,-32091"/>
<polygon fill="black" stroke="black" points="1122.5,-32090.86 1119,-32080.86 1115.5,-32090.86 1122.5,-32090.86"/>
</g>
<!-- gate_ar0 -->
<g id="node16" class="node">
<title>gate_ar0</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-31954.14" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-31965.44" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-31950.44" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-31935.44" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c0&#45;&gt;gate_ar0 -->
<g id="edge13" class="edge">
<title>gate_c0&#45;&gt;gate_ar0</title>
<path fill="none" stroke="black" d="M1119,-32027.37C1119,-32019.55 1119,-32010.69 1119,-32001.93"/>
<polygon fill="black" stroke="black" points="1122.5,-32001.76 1119,-31991.76 1115.5,-32001.76 1122.5,-32001.76"/>
</g>
<!-- route0 -->
<g id="node17" class="node">
<title>route0</title>
<path fill="none" stroke="black" d="M1310.41,-31880.66C1310.41,-31880.66 1010.83,-31880.66 1010.83,-31880.66 1004.83,-31880.66 995.13,-31875.94 991.42,-31871.22 991.42,-31871.22 923,-31784.1 923,-31784.1 919.3,-31779.38 921.59,-31774.66 927.59,-31774.66 927.59,-31774.66 1227.17,-31774.66 1227.17,-31774.66 1233.17,-31774.66 1242.87,-31779.38 1246.58,-31784.1 1246.58,-31784.1 1315,-31871.22 1315,-31871.22 1318.7,-31875.94 1316.41,-31880.66 1310.41,-31880.66"/>
<text text-anchor="start" x="957.26" y="-31838.96" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-31823.96" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-31808.96" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar0&#45;&gt;route0 -->
<g id="edge14" class="edge">
<title>gate_ar0&#45;&gt;route0</title>
<path fill="none" stroke="black" d="M1119,-31916.46C1119,-31908.42 1119,-31899.69 1119,-31890.96"/>
<polygon fill="black" stroke="black" points="1122.5,-31890.75 1119,-31880.75 1115.5,-31890.75 1122.5,-31890.75"/>
</g>
<!-- a2a_s0 -->
<g id="node18" class="node">
<title>a2a_s0</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-31701.18" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-31712.48" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-31697.48" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-31682.48" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route0&#45;&gt;a2a_s0 -->
<g id="edge15" class="edge">
<title>route0&#45;&gt;a2a_s0</title>
<path fill="none" stroke="black" d="M1119,-31774.59C1119,-31766.16 1119,-31757.47 1119,-31749.17"/>
<polygon fill="black" stroke="black" points="1122.5,-31748.91 1119,-31738.91 1115.5,-31748.91 1122.5,-31748.91"/>
</g>
<!-- exp0 -->
<g id="node19" class="node">
<title>exp0</title>
<path fill="none" stroke="black" d="M1233.5,-31627.71C1233.5,-31627.71 1004.5,-31627.71 1004.5,-31627.71 998.5,-31627.71 992.5,-31621.71 992.5,-31615.71 992.5,-31615.71 992.5,-31586.71 992.5,-31586.71 992.5,-31580.71 998.5,-31574.71 1004.5,-31574.71 1004.5,-31574.71 1233.5,-31574.71 1233.5,-31574.71 1239.5,-31574.71 1245.5,-31580.71 1245.5,-31586.71 1245.5,-31586.71 1245.5,-31615.71 1245.5,-31615.71 1245.5,-31621.71 1239.5,-31627.71 1233.5,-31627.71"/>
<text text-anchor="start" x="1000.5" y="-31612.51" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-31597.51" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-31582.51" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s0&#45;&gt;exp0 -->
<g id="edge16" class="edge">
<title>a2a_s0&#45;&gt;exp0</title>
<path fill="none" stroke="black" d="M1119,-31663.7C1119,-31655.28 1119,-31646.34 1119,-31637.95"/>
<polygon fill="black" stroke="black" points="1122.5,-31637.72 1119,-31627.72 1115.5,-31637.72 1122.5,-31637.72"/>
</g>
<!-- exp_ar0 -->
<g id="node20" class="node">
<title>exp_ar0</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-31501.23" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-31512.53" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-31497.53" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-31482.53" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp0&#45;&gt;exp_ar0 -->
<g id="edge17" class="edge">
<title>exp0&#45;&gt;exp_ar0</title>
<path fill="none" stroke="black" d="M1119,-31574.46C1119,-31566.64 1119,-31557.78 1119,-31549.02"/>
<polygon fill="black" stroke="black" points="1122.5,-31548.85 1119,-31538.85 1115.5,-31548.85 1122.5,-31548.85"/>
</g>
<!-- a2a_r0 -->
<g id="node21" class="node">
<title>a2a_r0</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-31390.28" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-31401.58" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-31386.58" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-31371.58" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar0&#45;&gt;a2a_r0 -->
<g id="edge18" class="edge">
<title>exp_ar0&#45;&gt;a2a_r0</title>
<path fill="none" stroke="black" d="M1119,-31463.65C1119,-31455.47 1119,-31446.69 1119,-31438.16"/>
<polygon fill="black" stroke="black" points="1122.5,-31437.95 1119,-31427.95 1115.5,-31437.95 1122.5,-31437.95"/>
</g>
<!-- agg0 -->
<g id="node22" class="node">
<title>agg0</title>
<path fill="none" stroke="black" d="M1308.26,-31316.8C1308.26,-31316.8 1012.1,-31316.8 1012.1,-31316.8 1006.1,-31316.8 996.42,-31312.06 992.74,-31307.32 992.74,-31307.32 925.1,-31220.27 925.1,-31220.27 921.42,-31215.54 923.74,-31210.8 929.74,-31210.8 929.74,-31210.8 1225.9,-31210.8 1225.9,-31210.8 1231.9,-31210.8 1241.58,-31215.54 1245.26,-31220.27 1245.26,-31220.27 1312.9,-31307.32 1312.9,-31307.32 1316.58,-31312.06 1314.26,-31316.8 1308.26,-31316.8"/>
<text text-anchor="start" x="958.99" y="-31275.1" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-31260.1" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-31245.1" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r0&#45;&gt;agg0 -->
<g id="edge19" class="edge">
<title>a2a_r0&#45;&gt;agg0</title>
<path fill="none" stroke="black" d="M1119,-31352.6C1119,-31344.56 1119,-31335.83 1119,-31327.1"/>
<polygon fill="black" stroke="black" points="1122.5,-31326.89 1119,-31316.89 1115.5,-31326.89 1122.5,-31326.89"/>
</g>
<!-- norm_m0 -->
<g id="node23" class="node">
<title>norm_m0</title>
<path fill="none" stroke="black" d="M1199,-31174.8C1199,-31174.8 1039,-31174.8 1039,-31174.8 1033,-31174.8 1027,-31168.8 1027,-31162.8 1027,-31162.8 1027,-31133.8 1027,-31133.8 1027,-31127.8 1033,-31121.8 1039,-31121.8 1039,-31121.8 1199,-31121.8 1199,-31121.8 1205,-31121.8 1211,-31127.8 1211,-31133.8 1211,-31133.8 1211,-31162.8 1211,-31162.8 1211,-31168.8 1205,-31174.8 1199,-31174.8"/>
<text text-anchor="start" x="1035" y="-31159.6" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-31144.6" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-31129.6" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg0&#45;&gt;norm_m0 -->
<g id="edge20" class="edge">
<title>agg0&#45;&gt;norm_m0</title>
<path fill="none" stroke="black" d="M1119,-31210.7C1119,-31202.03 1119,-31193.21 1119,-31185.07"/>
<polygon fill="black" stroke="black" points="1122.5,-31184.81 1119,-31174.81 1115.5,-31184.81 1122.5,-31184.81"/>
</g>
<!-- qkv_c1 -->
<g id="node24" class="node">
<title>qkv_c1</title>
<path fill="none" stroke="black" d="M1241,-31085.8C1241,-31085.8 997,-31085.8 997,-31085.8 991,-31085.8 985,-31079.8 985,-31073.8 985,-31073.8 985,-31044.8 985,-31044.8 985,-31038.8 991,-31032.8 997,-31032.8 997,-31032.8 1241,-31032.8 1241,-31032.8 1247,-31032.8 1253,-31038.8 1253,-31044.8 1253,-31044.8 1253,-31073.8 1253,-31073.8 1253,-31079.8 1247,-31085.8 1241,-31085.8"/>
<text text-anchor="start" x="993" y="-31070.6" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-31055.6" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-31040.6" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m0&#45;&gt;qkv_c1 -->
<g id="edge21" class="edge">
<title>norm_m0&#45;&gt;qkv_c1</title>
<path fill="none" stroke="black" d="M1119,-31121.67C1119,-31113.68 1119,-31104.73 1119,-31096.18"/>
<polygon fill="black" stroke="black" points="1122.5,-31096.05 1119,-31086.05 1115.5,-31096.05 1122.5,-31096.05"/>
</g>
<!-- qkv_ar1 -->
<g id="node25" class="node">
<title>qkv_ar1</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-30959.32" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-30970.62" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-30955.62" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-30940.62" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c1&#45;&gt;qkv_ar1 -->
<g id="edge22" class="edge">
<title>qkv_c1&#45;&gt;qkv_ar1</title>
<path fill="none" stroke="black" d="M1119,-31032.56C1119,-31024.73 1119,-31015.88 1119,-31007.12"/>
<polygon fill="black" stroke="black" points="1122.5,-31006.94 1119,-30996.94 1115.5,-31006.94 1122.5,-31006.94"/>
</g>
<!-- sph1 -->
<g id="node26" class="node">
<title>sph1</title>
<path fill="none" stroke="black" d="M1327.66,-30885.85C1327.66,-30885.85 1000.64,-30885.85 1000.64,-30885.85 994.64,-30885.85 984.75,-30881.28 980.86,-30876.71 980.86,-30876.71 906.12,-30788.98 906.12,-30788.98 902.23,-30784.41 904.34,-30779.85 910.34,-30779.85 910.34,-30779.85 1237.36,-30779.85 1237.36,-30779.85 1243.36,-30779.85 1253.25,-30784.41 1257.14,-30788.98 1257.14,-30788.98 1331.88,-30876.71 1331.88,-30876.71 1335.77,-30881.28 1333.66,-30885.85 1327.66,-30885.85"/>
<text text-anchor="start" x="942.54" y="-30844.15" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-30829.15" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-30814.15" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar1&#45;&gt;sph1 -->
<g id="edge23" class="edge">
<title>qkv_ar1&#45;&gt;sph1</title>
<path fill="none" stroke="black" d="M1119,-30921.65C1119,-30913.61 1119,-30904.88 1119,-30896.15"/>
<polygon fill="black" stroke="black" points="1122.5,-30895.94 1119,-30885.94 1115.5,-30895.94 1122.5,-30895.94"/>
</g>
<!-- sdp1 -->
<g id="node27" class="node">
<title>sdp1</title>
<path fill="none" stroke="black" d="M1220,-30743.85C1220,-30743.85 1018,-30743.85 1018,-30743.85 1012,-30743.85 1006,-30737.85 1006,-30731.85 1006,-30731.85 1006,-30702.85 1006,-30702.85 1006,-30696.85 1012,-30690.85 1018,-30690.85 1018,-30690.85 1220,-30690.85 1220,-30690.85 1226,-30690.85 1232,-30696.85 1232,-30702.85 1232,-30702.85 1232,-30731.85 1232,-30731.85 1232,-30737.85 1226,-30743.85 1220,-30743.85"/>
<text text-anchor="start" x="1014" y="-30728.65" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-30713.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-30698.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph1&#45;&gt;sdp1 -->
<g id="edge24" class="edge">
<title>sph1&#45;&gt;sdp1</title>
<path fill="none" stroke="black" d="M1119,-30779.75C1119,-30771.07 1119,-30762.26 1119,-30754.11"/>
<polygon fill="black" stroke="black" points="1122.5,-30753.86 1119,-30743.86 1115.5,-30753.86 1122.5,-30753.86"/>
</g>
<!-- sm1 -->
<g id="node28" class="node">
<title>sm1</title>
<path fill="none" stroke="black" d="M1182.5,-30654.85C1182.5,-30654.85 1055.5,-30654.85 1055.5,-30654.85 1049.5,-30654.85 1043.5,-30648.85 1043.5,-30642.85 1043.5,-30642.85 1043.5,-30613.85 1043.5,-30613.85 1043.5,-30607.85 1049.5,-30601.85 1055.5,-30601.85 1055.5,-30601.85 1182.5,-30601.85 1182.5,-30601.85 1188.5,-30601.85 1194.5,-30607.85 1194.5,-30613.85 1194.5,-30613.85 1194.5,-30642.85 1194.5,-30642.85 1194.5,-30648.85 1188.5,-30654.85 1182.5,-30654.85"/>
<text text-anchor="start" x="1051.5" y="-30639.65" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-30624.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-30609.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp1&#45;&gt;sm1 -->
<g id="edge25" class="edge">
<title>sdp1&#45;&gt;sm1</title>
<path fill="none" stroke="black" d="M1119,-30690.71C1119,-30682.73 1119,-30673.78 1119,-30665.23"/>
<polygon fill="black" stroke="black" points="1122.5,-30665.1 1119,-30655.1 1115.5,-30665.1 1122.5,-30665.1"/>
</g>
<!-- do1 -->
<g id="node29" class="node">
<title>do1</title>
<path fill="none" stroke="black" d="M1166.5,-30565.85C1166.5,-30565.85 1071.5,-30565.85 1071.5,-30565.85 1065.5,-30565.85 1059.5,-30559.85 1059.5,-30553.85 1059.5,-30553.85 1059.5,-30524.85 1059.5,-30524.85 1059.5,-30518.85 1065.5,-30512.85 1071.5,-30512.85 1071.5,-30512.85 1166.5,-30512.85 1166.5,-30512.85 1172.5,-30512.85 1178.5,-30518.85 1178.5,-30524.85 1178.5,-30524.85 1178.5,-30553.85 1178.5,-30553.85 1178.5,-30559.85 1172.5,-30565.85 1166.5,-30565.85"/>
<text text-anchor="start" x="1067.5" y="-30550.65" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-30535.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-30520.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm1&#45;&gt;do1 -->
<g id="edge26" class="edge">
<title>sm1&#45;&gt;do1</title>
<path fill="none" stroke="black" d="M1119,-30601.71C1119,-30593.73 1119,-30584.78 1119,-30576.23"/>
<polygon fill="black" stroke="black" points="1122.5,-30576.1 1119,-30566.1 1115.5,-30576.1 1122.5,-30576.1"/>
</g>
<!-- mgh1 -->
<g id="node30" class="node">
<title>mgh1</title>
<path fill="none" stroke="black" d="M1323.86,-30476.85C1323.86,-30476.85 1002.88,-30476.85 1002.88,-30476.85 996.88,-30476.85 987.03,-30472.24 983.18,-30467.64 983.18,-30467.64 909.84,-30380.05 909.84,-30380.05 905.99,-30375.45 908.14,-30370.85 914.14,-30370.85 914.14,-30370.85 1235.12,-30370.85 1235.12,-30370.85 1241.12,-30370.85 1250.97,-30375.45 1254.82,-30380.05 1254.82,-30380.05 1328.16,-30467.64 1328.16,-30467.64 1332.01,-30472.24 1329.86,-30476.85 1323.86,-30476.85"/>
<text text-anchor="start" x="946" y="-30435.15" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-30420.15" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-30405.15" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do1&#45;&gt;mgh1 -->
<g id="edge27" class="edge">
<title>do1&#45;&gt;mgh1</title>
<path fill="none" stroke="black" d="M1119,-30512.59C1119,-30504.89 1119,-30496.1 1119,-30487.11"/>
<polygon fill="black" stroke="black" points="1122.5,-30486.94 1119,-30476.94 1115.5,-30486.94 1122.5,-30486.94"/>
</g>
<!-- proj_r1 -->
<g id="node31" class="node">
<title>proj_r1</title>
<path fill="none" stroke="black" d="M1219,-30334.85C1219,-30334.85 1019,-30334.85 1019,-30334.85 1013,-30334.85 1007,-30328.85 1007,-30322.85 1007,-30322.85 1007,-30293.85 1007,-30293.85 1007,-30287.85 1013,-30281.85 1019,-30281.85 1019,-30281.85 1219,-30281.85 1219,-30281.85 1225,-30281.85 1231,-30287.85 1231,-30293.85 1231,-30293.85 1231,-30322.85 1231,-30322.85 1231,-30328.85 1225,-30334.85 1219,-30334.85"/>
<text text-anchor="start" x="1015" y="-30319.65" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-30304.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-30289.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh1&#45;&gt;proj_r1 -->
<g id="edge28" class="edge">
<title>mgh1&#45;&gt;proj_r1</title>
<path fill="none" stroke="black" d="M1119,-30370.75C1119,-30362.07 1119,-30353.26 1119,-30345.11"/>
<polygon fill="black" stroke="black" points="1122.5,-30344.86 1119,-30334.86 1115.5,-30344.86 1122.5,-30344.86"/>
</g>
<!-- proj_ar1 -->
<g id="node32" class="node">
<title>proj_ar1</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-30208.37" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-30219.67" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-30204.67" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-30189.67" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r1&#45;&gt;proj_ar1 -->
<g id="edge29" class="edge">
<title>proj_r1&#45;&gt;proj_ar1</title>
<path fill="none" stroke="black" d="M1119,-30281.6C1119,-30273.78 1119,-30264.92 1119,-30256.16"/>
<polygon fill="black" stroke="black" points="1122.5,-30255.99 1119,-30245.99 1115.5,-30255.99 1122.5,-30255.99"/>
</g>
<!-- norm1 -->
<g id="node33" class="node">
<title>norm1</title>
<path fill="none" stroke="black" d="M1204,-30134.89C1204,-30134.89 1034,-30134.89 1034,-30134.89 1028,-30134.89 1022,-30128.89 1022,-30122.89 1022,-30122.89 1022,-30093.89 1022,-30093.89 1022,-30087.89 1028,-30081.89 1034,-30081.89 1034,-30081.89 1204,-30081.89 1204,-30081.89 1210,-30081.89 1216,-30087.89 1216,-30093.89 1216,-30093.89 1216,-30122.89 1216,-30122.89 1216,-30128.89 1210,-30134.89 1204,-30134.89"/>
<text text-anchor="start" x="1030" y="-30119.69" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-30104.69" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-30089.69" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar1&#45;&gt;norm1 -->
<g id="edge30" class="edge">
<title>proj_ar1&#45;&gt;norm1</title>
<path fill="none" stroke="black" d="M1119,-30170.89C1119,-30162.47 1119,-30153.53 1119,-30145.14"/>
<polygon fill="black" stroke="black" points="1122.5,-30144.9 1119,-30134.9 1115.5,-30144.9 1122.5,-30144.9"/>
</g>
<!-- gate_c1 -->
<g id="node34" class="node">
<title>gate_c1</title>
<path fill="none" stroke="black" d="M1218.5,-30045.89C1218.5,-30045.89 1019.5,-30045.89 1019.5,-30045.89 1013.5,-30045.89 1007.5,-30039.89 1007.5,-30033.89 1007.5,-30033.89 1007.5,-30004.89 1007.5,-30004.89 1007.5,-29998.89 1013.5,-29992.89 1019.5,-29992.89 1019.5,-29992.89 1218.5,-29992.89 1218.5,-29992.89 1224.5,-29992.89 1230.5,-29998.89 1230.5,-30004.89 1230.5,-30004.89 1230.5,-30033.89 1230.5,-30033.89 1230.5,-30039.89 1224.5,-30045.89 1218.5,-30045.89"/>
<text text-anchor="start" x="1015.5" y="-30030.69" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-30015.69" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-30000.69" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm1&#45;&gt;gate_c1 -->
<g id="edge31" class="edge">
<title>norm1&#45;&gt;gate_c1</title>
<path fill="none" stroke="black" d="M1119,-30081.76C1119,-30073.78 1119,-30064.82 1119,-30056.28"/>
<polygon fill="black" stroke="black" points="1122.5,-30056.14 1119,-30046.14 1115.5,-30056.14 1122.5,-30056.14"/>
</g>
<!-- gate_ar1 -->
<g id="node35" class="node">
<title>gate_ar1</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-29919.42" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-29930.72" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-29915.72" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-29900.72" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c1&#45;&gt;gate_ar1 -->
<g id="edge32" class="edge">
<title>gate_c1&#45;&gt;gate_ar1</title>
<path fill="none" stroke="black" d="M1119,-29992.65C1119,-29984.83 1119,-29975.97 1119,-29967.21"/>
<polygon fill="black" stroke="black" points="1122.5,-29967.04 1119,-29957.04 1115.5,-29967.04 1122.5,-29967.04"/>
</g>
<!-- route1 -->
<g id="node36" class="node">
<title>route1</title>
<path fill="none" stroke="black" d="M1310.41,-29845.94C1310.41,-29845.94 1010.83,-29845.94 1010.83,-29845.94 1004.83,-29845.94 995.13,-29841.22 991.42,-29836.5 991.42,-29836.5 923,-29749.38 923,-29749.38 919.3,-29744.66 921.59,-29739.94 927.59,-29739.94 927.59,-29739.94 1227.17,-29739.94 1227.17,-29739.94 1233.17,-29739.94 1242.87,-29744.66 1246.58,-29749.38 1246.58,-29749.38 1315,-29836.5 1315,-29836.5 1318.7,-29841.22 1316.41,-29845.94 1310.41,-29845.94"/>
<text text-anchor="start" x="957.26" y="-29804.24" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-29789.24" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-29774.24" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar1&#45;&gt;route1 -->
<g id="edge33" class="edge">
<title>gate_ar1&#45;&gt;route1</title>
<path fill="none" stroke="black" d="M1119,-29881.74C1119,-29873.7 1119,-29864.97 1119,-29856.24"/>
<polygon fill="black" stroke="black" points="1122.5,-29856.03 1119,-29846.03 1115.5,-29856.03 1122.5,-29856.03"/>
</g>
<!-- a2a_s1 -->
<g id="node37" class="node">
<title>a2a_s1</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-29666.46" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-29677.76" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-29662.76" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-29647.76" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route1&#45;&gt;a2a_s1 -->
<g id="edge34" class="edge">
<title>route1&#45;&gt;a2a_s1</title>
<path fill="none" stroke="black" d="M1119,-29739.87C1119,-29731.44 1119,-29722.75 1119,-29714.45"/>
<polygon fill="black" stroke="black" points="1122.5,-29714.19 1119,-29704.19 1115.5,-29714.19 1122.5,-29714.19"/>
</g>
<!-- exp1 -->
<g id="node38" class="node">
<title>exp1</title>
<path fill="none" stroke="black" d="M1233.5,-29592.99C1233.5,-29592.99 1004.5,-29592.99 1004.5,-29592.99 998.5,-29592.99 992.5,-29586.99 992.5,-29580.99 992.5,-29580.99 992.5,-29551.99 992.5,-29551.99 992.5,-29545.99 998.5,-29539.99 1004.5,-29539.99 1004.5,-29539.99 1233.5,-29539.99 1233.5,-29539.99 1239.5,-29539.99 1245.5,-29545.99 1245.5,-29551.99 1245.5,-29551.99 1245.5,-29580.99 1245.5,-29580.99 1245.5,-29586.99 1239.5,-29592.99 1233.5,-29592.99"/>
<text text-anchor="start" x="1000.5" y="-29577.79" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-29562.79" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-29547.79" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s1&#45;&gt;exp1 -->
<g id="edge35" class="edge">
<title>a2a_s1&#45;&gt;exp1</title>
<path fill="none" stroke="black" d="M1119,-29628.98C1119,-29620.56 1119,-29611.62 1119,-29603.24"/>
<polygon fill="black" stroke="black" points="1122.5,-29603 1119,-29593 1115.5,-29603 1122.5,-29603"/>
</g>
<!-- exp_ar1 -->
<g id="node39" class="node">
<title>exp_ar1</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-29466.51" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-29477.81" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-29462.81" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-29447.81" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp1&#45;&gt;exp_ar1 -->
<g id="edge36" class="edge">
<title>exp1&#45;&gt;exp_ar1</title>
<path fill="none" stroke="black" d="M1119,-29539.74C1119,-29531.92 1119,-29523.06 1119,-29514.3"/>
<polygon fill="black" stroke="black" points="1122.5,-29514.13 1119,-29504.13 1115.5,-29514.13 1122.5,-29514.13"/>
</g>
<!-- a2a_r1 -->
<g id="node40" class="node">
<title>a2a_r1</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-29355.56" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-29366.86" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-29351.86" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-29336.86" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar1&#45;&gt;a2a_r1 -->
<g id="edge37" class="edge">
<title>exp_ar1&#45;&gt;a2a_r1</title>
<path fill="none" stroke="black" d="M1119,-29428.93C1119,-29420.75 1119,-29411.97 1119,-29403.44"/>
<polygon fill="black" stroke="black" points="1122.5,-29403.23 1119,-29393.23 1115.5,-29403.23 1122.5,-29403.23"/>
</g>
<!-- agg1 -->
<g id="node41" class="node">
<title>agg1</title>
<path fill="none" stroke="black" d="M1308.26,-29282.08C1308.26,-29282.08 1012.1,-29282.08 1012.1,-29282.08 1006.1,-29282.08 996.42,-29277.34 992.74,-29272.6 992.74,-29272.6 925.1,-29185.55 925.1,-29185.55 921.42,-29180.82 923.74,-29176.08 929.74,-29176.08 929.74,-29176.08 1225.9,-29176.08 1225.9,-29176.08 1231.9,-29176.08 1241.58,-29180.82 1245.26,-29185.55 1245.26,-29185.55 1312.9,-29272.6 1312.9,-29272.6 1316.58,-29277.34 1314.26,-29282.08 1308.26,-29282.08"/>
<text text-anchor="start" x="958.99" y="-29240.38" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-29225.38" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-29210.38" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r1&#45;&gt;agg1 -->
<g id="edge38" class="edge">
<title>a2a_r1&#45;&gt;agg1</title>
<path fill="none" stroke="black" d="M1119,-29317.88C1119,-29309.84 1119,-29301.11 1119,-29292.38"/>
<polygon fill="black" stroke="black" points="1122.5,-29292.17 1119,-29282.17 1115.5,-29292.17 1122.5,-29292.17"/>
</g>
<!-- norm_m1 -->
<g id="node42" class="node">
<title>norm_m1</title>
<path fill="none" stroke="black" d="M1199,-29140.08C1199,-29140.08 1039,-29140.08 1039,-29140.08 1033,-29140.08 1027,-29134.08 1027,-29128.08 1027,-29128.08 1027,-29099.08 1027,-29099.08 1027,-29093.08 1033,-29087.08 1039,-29087.08 1039,-29087.08 1199,-29087.08 1199,-29087.08 1205,-29087.08 1211,-29093.08 1211,-29099.08 1211,-29099.08 1211,-29128.08 1211,-29128.08 1211,-29134.08 1205,-29140.08 1199,-29140.08"/>
<text text-anchor="start" x="1035" y="-29124.88" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-29109.88" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-29094.88" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg1&#45;&gt;norm_m1 -->
<g id="edge39" class="edge">
<title>agg1&#45;&gt;norm_m1</title>
<path fill="none" stroke="black" d="M1119,-29175.98C1119,-29167.31 1119,-29158.49 1119,-29150.35"/>
<polygon fill="black" stroke="black" points="1122.5,-29150.09 1119,-29140.09 1115.5,-29150.09 1122.5,-29150.09"/>
</g>
<!-- qkv_c2 -->
<g id="node43" class="node">
<title>qkv_c2</title>
<path fill="none" stroke="black" d="M1241,-29051.08C1241,-29051.08 997,-29051.08 997,-29051.08 991,-29051.08 985,-29045.08 985,-29039.08 985,-29039.08 985,-29010.08 985,-29010.08 985,-29004.08 991,-28998.08 997,-28998.08 997,-28998.08 1241,-28998.08 1241,-28998.08 1247,-28998.08 1253,-29004.08 1253,-29010.08 1253,-29010.08 1253,-29039.08 1253,-29039.08 1253,-29045.08 1247,-29051.08 1241,-29051.08"/>
<text text-anchor="start" x="993" y="-29035.88" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-29020.88" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-29005.88" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m1&#45;&gt;qkv_c2 -->
<g id="edge40" class="edge">
<title>norm_m1&#45;&gt;qkv_c2</title>
<path fill="none" stroke="black" d="M1119,-29086.95C1119,-29078.96 1119,-29070.01 1119,-29061.46"/>
<polygon fill="black" stroke="black" points="1122.5,-29061.33 1119,-29051.33 1115.5,-29061.33 1122.5,-29061.33"/>
</g>
<!-- qkv_ar2 -->
<g id="node44" class="node">
<title>qkv_ar2</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-28924.6" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-28935.9" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-28920.9" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-28905.9" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c2&#45;&gt;qkv_ar2 -->
<g id="edge41" class="edge">
<title>qkv_c2&#45;&gt;qkv_ar2</title>
<path fill="none" stroke="black" d="M1119,-28997.84C1119,-28990.01 1119,-28981.16 1119,-28972.4"/>
<polygon fill="black" stroke="black" points="1122.5,-28972.22 1119,-28962.22 1115.5,-28972.22 1122.5,-28972.22"/>
</g>
<!-- sph2 -->
<g id="node45" class="node">
<title>sph2</title>
<path fill="none" stroke="black" d="M1327.66,-28851.13C1327.66,-28851.13 1000.64,-28851.13 1000.64,-28851.13 994.64,-28851.13 984.75,-28846.56 980.86,-28841.99 980.86,-28841.99 906.12,-28754.26 906.12,-28754.26 902.23,-28749.69 904.34,-28745.13 910.34,-28745.13 910.34,-28745.13 1237.36,-28745.13 1237.36,-28745.13 1243.36,-28745.13 1253.25,-28749.69 1257.14,-28754.26 1257.14,-28754.26 1331.88,-28841.99 1331.88,-28841.99 1335.77,-28846.56 1333.66,-28851.13 1327.66,-28851.13"/>
<text text-anchor="start" x="942.54" y="-28809.43" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-28794.43" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-28779.43" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar2&#45;&gt;sph2 -->
<g id="edge42" class="edge">
<title>qkv_ar2&#45;&gt;sph2</title>
<path fill="none" stroke="black" d="M1119,-28886.93C1119,-28878.89 1119,-28870.16 1119,-28861.43"/>
<polygon fill="black" stroke="black" points="1122.5,-28861.22 1119,-28851.22 1115.5,-28861.22 1122.5,-28861.22"/>
</g>
<!-- sdp2 -->
<g id="node46" class="node">
<title>sdp2</title>
<path fill="none" stroke="black" d="M1220,-28709.13C1220,-28709.13 1018,-28709.13 1018,-28709.13 1012,-28709.13 1006,-28703.13 1006,-28697.13 1006,-28697.13 1006,-28668.13 1006,-28668.13 1006,-28662.13 1012,-28656.13 1018,-28656.13 1018,-28656.13 1220,-28656.13 1220,-28656.13 1226,-28656.13 1232,-28662.13 1232,-28668.13 1232,-28668.13 1232,-28697.13 1232,-28697.13 1232,-28703.13 1226,-28709.13 1220,-28709.13"/>
<text text-anchor="start" x="1014" y="-28693.93" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-28678.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-28663.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph2&#45;&gt;sdp2 -->
<g id="edge43" class="edge">
<title>sph2&#45;&gt;sdp2</title>
<path fill="none" stroke="black" d="M1119,-28745.03C1119,-28736.35 1119,-28727.54 1119,-28719.39"/>
<polygon fill="black" stroke="black" points="1122.5,-28719.14 1119,-28709.14 1115.5,-28719.14 1122.5,-28719.14"/>
</g>
<!-- sm2 -->
<g id="node47" class="node">
<title>sm2</title>
<path fill="none" stroke="black" d="M1182.5,-28620.13C1182.5,-28620.13 1055.5,-28620.13 1055.5,-28620.13 1049.5,-28620.13 1043.5,-28614.13 1043.5,-28608.13 1043.5,-28608.13 1043.5,-28579.13 1043.5,-28579.13 1043.5,-28573.13 1049.5,-28567.13 1055.5,-28567.13 1055.5,-28567.13 1182.5,-28567.13 1182.5,-28567.13 1188.5,-28567.13 1194.5,-28573.13 1194.5,-28579.13 1194.5,-28579.13 1194.5,-28608.13 1194.5,-28608.13 1194.5,-28614.13 1188.5,-28620.13 1182.5,-28620.13"/>
<text text-anchor="start" x="1051.5" y="-28604.93" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-28589.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-28574.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp2&#45;&gt;sm2 -->
<g id="edge44" class="edge">
<title>sdp2&#45;&gt;sm2</title>
<path fill="none" stroke="black" d="M1119,-28655.99C1119,-28648.01 1119,-28639.06 1119,-28630.51"/>
<polygon fill="black" stroke="black" points="1122.5,-28630.38 1119,-28620.38 1115.5,-28630.38 1122.5,-28630.38"/>
</g>
<!-- do2 -->
<g id="node48" class="node">
<title>do2</title>
<path fill="none" stroke="black" d="M1166.5,-28531.13C1166.5,-28531.13 1071.5,-28531.13 1071.5,-28531.13 1065.5,-28531.13 1059.5,-28525.13 1059.5,-28519.13 1059.5,-28519.13 1059.5,-28490.13 1059.5,-28490.13 1059.5,-28484.13 1065.5,-28478.13 1071.5,-28478.13 1071.5,-28478.13 1166.5,-28478.13 1166.5,-28478.13 1172.5,-28478.13 1178.5,-28484.13 1178.5,-28490.13 1178.5,-28490.13 1178.5,-28519.13 1178.5,-28519.13 1178.5,-28525.13 1172.5,-28531.13 1166.5,-28531.13"/>
<text text-anchor="start" x="1067.5" y="-28515.93" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-28500.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-28485.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm2&#45;&gt;do2 -->
<g id="edge45" class="edge">
<title>sm2&#45;&gt;do2</title>
<path fill="none" stroke="black" d="M1119,-28566.99C1119,-28559.01 1119,-28550.06 1119,-28541.51"/>
<polygon fill="black" stroke="black" points="1122.5,-28541.38 1119,-28531.38 1115.5,-28541.38 1122.5,-28541.38"/>
</g>
<!-- mgh2 -->
<g id="node49" class="node">
<title>mgh2</title>
<path fill="none" stroke="black" d="M1323.86,-28442.13C1323.86,-28442.13 1002.88,-28442.13 1002.88,-28442.13 996.88,-28442.13 987.03,-28437.52 983.18,-28432.92 983.18,-28432.92 909.84,-28345.33 909.84,-28345.33 905.99,-28340.73 908.14,-28336.13 914.14,-28336.13 914.14,-28336.13 1235.12,-28336.13 1235.12,-28336.13 1241.12,-28336.13 1250.97,-28340.73 1254.82,-28345.33 1254.82,-28345.33 1328.16,-28432.92 1328.16,-28432.92 1332.01,-28437.52 1329.86,-28442.13 1323.86,-28442.13"/>
<text text-anchor="start" x="946" y="-28400.43" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-28385.43" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-28370.43" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do2&#45;&gt;mgh2 -->
<g id="edge46" class="edge">
<title>do2&#45;&gt;mgh2</title>
<path fill="none" stroke="black" d="M1119,-28477.87C1119,-28470.17 1119,-28461.38 1119,-28452.39"/>
<polygon fill="black" stroke="black" points="1122.5,-28452.22 1119,-28442.22 1115.5,-28452.22 1122.5,-28452.22"/>
</g>
<!-- proj_r2 -->
<g id="node50" class="node">
<title>proj_r2</title>
<path fill="none" stroke="black" d="M1219,-28300.13C1219,-28300.13 1019,-28300.13 1019,-28300.13 1013,-28300.13 1007,-28294.13 1007,-28288.13 1007,-28288.13 1007,-28259.13 1007,-28259.13 1007,-28253.13 1013,-28247.13 1019,-28247.13 1019,-28247.13 1219,-28247.13 1219,-28247.13 1225,-28247.13 1231,-28253.13 1231,-28259.13 1231,-28259.13 1231,-28288.13 1231,-28288.13 1231,-28294.13 1225,-28300.13 1219,-28300.13"/>
<text text-anchor="start" x="1015" y="-28284.93" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-28269.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-28254.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh2&#45;&gt;proj_r2 -->
<g id="edge47" class="edge">
<title>mgh2&#45;&gt;proj_r2</title>
<path fill="none" stroke="black" d="M1119,-28336.03C1119,-28327.35 1119,-28318.54 1119,-28310.39"/>
<polygon fill="black" stroke="black" points="1122.5,-28310.14 1119,-28300.14 1115.5,-28310.14 1122.5,-28310.14"/>
</g>
<!-- proj_ar2 -->
<g id="node51" class="node">
<title>proj_ar2</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-28173.65" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-28184.95" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-28169.95" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-28154.95" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r2&#45;&gt;proj_ar2 -->
<g id="edge48" class="edge">
<title>proj_r2&#45;&gt;proj_ar2</title>
<path fill="none" stroke="black" d="M1119,-28246.88C1119,-28239.06 1119,-28230.21 1119,-28221.44"/>
<polygon fill="black" stroke="black" points="1122.5,-28221.27 1119,-28211.27 1115.5,-28221.27 1122.5,-28221.27"/>
</g>
<!-- norm2 -->
<g id="node52" class="node">
<title>norm2</title>
<path fill="none" stroke="black" d="M1204,-28100.17C1204,-28100.17 1034,-28100.17 1034,-28100.17 1028,-28100.17 1022,-28094.17 1022,-28088.17 1022,-28088.17 1022,-28059.17 1022,-28059.17 1022,-28053.17 1028,-28047.17 1034,-28047.17 1034,-28047.17 1204,-28047.17 1204,-28047.17 1210,-28047.17 1216,-28053.17 1216,-28059.17 1216,-28059.17 1216,-28088.17 1216,-28088.17 1216,-28094.17 1210,-28100.17 1204,-28100.17"/>
<text text-anchor="start" x="1030" y="-28084.97" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-28069.97" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-28054.97" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar2&#45;&gt;norm2 -->
<g id="edge49" class="edge">
<title>proj_ar2&#45;&gt;norm2</title>
<path fill="none" stroke="black" d="M1119,-28136.17C1119,-28127.75 1119,-28118.81 1119,-28110.42"/>
<polygon fill="black" stroke="black" points="1122.5,-28110.18 1119,-28100.18 1115.5,-28110.18 1122.5,-28110.18"/>
</g>
<!-- gate_c2 -->
<g id="node53" class="node">
<title>gate_c2</title>
<path fill="none" stroke="black" d="M1218.5,-28011.17C1218.5,-28011.17 1019.5,-28011.17 1019.5,-28011.17 1013.5,-28011.17 1007.5,-28005.17 1007.5,-27999.17 1007.5,-27999.17 1007.5,-27970.17 1007.5,-27970.17 1007.5,-27964.17 1013.5,-27958.17 1019.5,-27958.17 1019.5,-27958.17 1218.5,-27958.17 1218.5,-27958.17 1224.5,-27958.17 1230.5,-27964.17 1230.5,-27970.17 1230.5,-27970.17 1230.5,-27999.17 1230.5,-27999.17 1230.5,-28005.17 1224.5,-28011.17 1218.5,-28011.17"/>
<text text-anchor="start" x="1015.5" y="-27995.97" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-27980.97" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-27965.97" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm2&#45;&gt;gate_c2 -->
<g id="edge50" class="edge">
<title>norm2&#45;&gt;gate_c2</title>
<path fill="none" stroke="black" d="M1119,-28047.04C1119,-28039.06 1119,-28030.1 1119,-28021.56"/>
<polygon fill="black" stroke="black" points="1122.5,-28021.42 1119,-28011.42 1115.5,-28021.42 1122.5,-28021.42"/>
</g>
<!-- gate_ar2 -->
<g id="node54" class="node">
<title>gate_ar2</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-27884.7" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-27896" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-27881" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-27866" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c2&#45;&gt;gate_ar2 -->
<g id="edge51" class="edge">
<title>gate_c2&#45;&gt;gate_ar2</title>
<path fill="none" stroke="black" d="M1119,-27957.93C1119,-27950.11 1119,-27941.25 1119,-27932.49"/>
<polygon fill="black" stroke="black" points="1122.5,-27932.32 1119,-27922.32 1115.5,-27932.32 1122.5,-27932.32"/>
</g>
<!-- route2 -->
<g id="node55" class="node">
<title>route2</title>
<path fill="none" stroke="black" d="M1310.41,-27811.22C1310.41,-27811.22 1010.83,-27811.22 1010.83,-27811.22 1004.83,-27811.22 995.13,-27806.5 991.42,-27801.78 991.42,-27801.78 923,-27714.66 923,-27714.66 919.3,-27709.94 921.59,-27705.22 927.59,-27705.22 927.59,-27705.22 1227.17,-27705.22 1227.17,-27705.22 1233.17,-27705.22 1242.87,-27709.94 1246.58,-27714.66 1246.58,-27714.66 1315,-27801.78 1315,-27801.78 1318.7,-27806.5 1316.41,-27811.22 1310.41,-27811.22"/>
<text text-anchor="start" x="957.26" y="-27769.52" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-27754.52" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-27739.52" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar2&#45;&gt;route2 -->
<g id="edge52" class="edge">
<title>gate_ar2&#45;&gt;route2</title>
<path fill="none" stroke="black" d="M1119,-27847.02C1119,-27838.98 1119,-27830.25 1119,-27821.52"/>
<polygon fill="black" stroke="black" points="1122.5,-27821.31 1119,-27811.31 1115.5,-27821.31 1122.5,-27821.31"/>
</g>
<!-- a2a_s2 -->
<g id="node56" class="node">
<title>a2a_s2</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-27631.74" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-27643.04" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-27628.04" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-27613.04" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route2&#45;&gt;a2a_s2 -->
<g id="edge53" class="edge">
<title>route2&#45;&gt;a2a_s2</title>
<path fill="none" stroke="black" d="M1119,-27705.15C1119,-27696.72 1119,-27688.03 1119,-27679.73"/>
<polygon fill="black" stroke="black" points="1122.5,-27679.47 1119,-27669.47 1115.5,-27679.47 1122.5,-27679.47"/>
</g>
<!-- exp2 -->
<g id="node57" class="node">
<title>exp2</title>
<path fill="none" stroke="black" d="M1233.5,-27558.27C1233.5,-27558.27 1004.5,-27558.27 1004.5,-27558.27 998.5,-27558.27 992.5,-27552.27 992.5,-27546.27 992.5,-27546.27 992.5,-27517.27 992.5,-27517.27 992.5,-27511.27 998.5,-27505.27 1004.5,-27505.27 1004.5,-27505.27 1233.5,-27505.27 1233.5,-27505.27 1239.5,-27505.27 1245.5,-27511.27 1245.5,-27517.27 1245.5,-27517.27 1245.5,-27546.27 1245.5,-27546.27 1245.5,-27552.27 1239.5,-27558.27 1233.5,-27558.27"/>
<text text-anchor="start" x="1000.5" y="-27543.07" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-27528.07" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-27513.07" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s2&#45;&gt;exp2 -->
<g id="edge54" class="edge">
<title>a2a_s2&#45;&gt;exp2</title>
<path fill="none" stroke="black" d="M1119,-27594.26C1119,-27585.84 1119,-27576.9 1119,-27568.52"/>
<polygon fill="black" stroke="black" points="1122.5,-27568.28 1119,-27558.28 1115.5,-27568.28 1122.5,-27568.28"/>
</g>
<!-- exp_ar2 -->
<g id="node58" class="node">
<title>exp_ar2</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-27431.79" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-27443.09" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-27428.09" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-27413.09" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp2&#45;&gt;exp_ar2 -->
<g id="edge55" class="edge">
<title>exp2&#45;&gt;exp_ar2</title>
<path fill="none" stroke="black" d="M1119,-27505.02C1119,-27497.2 1119,-27488.35 1119,-27479.58"/>
<polygon fill="black" stroke="black" points="1122.5,-27479.41 1119,-27469.41 1115.5,-27479.41 1122.5,-27479.41"/>
</g>
<!-- a2a_r2 -->
<g id="node59" class="node">
<title>a2a_r2</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-27320.84" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-27332.14" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-27317.14" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-27302.14" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar2&#45;&gt;a2a_r2 -->
<g id="edge56" class="edge">
<title>exp_ar2&#45;&gt;a2a_r2</title>
<path fill="none" stroke="black" d="M1119,-27394.21C1119,-27386.03 1119,-27377.25 1119,-27368.72"/>
<polygon fill="black" stroke="black" points="1122.5,-27368.51 1119,-27358.51 1115.5,-27368.51 1122.5,-27368.51"/>
</g>
<!-- agg2 -->
<g id="node60" class="node">
<title>agg2</title>
<path fill="none" stroke="black" d="M1308.26,-27247.36C1308.26,-27247.36 1012.1,-27247.36 1012.1,-27247.36 1006.1,-27247.36 996.42,-27242.62 992.74,-27237.88 992.74,-27237.88 925.1,-27150.83 925.1,-27150.83 921.42,-27146.1 923.74,-27141.36 929.74,-27141.36 929.74,-27141.36 1225.9,-27141.36 1225.9,-27141.36 1231.9,-27141.36 1241.58,-27146.1 1245.26,-27150.83 1245.26,-27150.83 1312.9,-27237.88 1312.9,-27237.88 1316.58,-27242.62 1314.26,-27247.36 1308.26,-27247.36"/>
<text text-anchor="start" x="958.99" y="-27205.66" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-27190.66" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-27175.66" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r2&#45;&gt;agg2 -->
<g id="edge57" class="edge">
<title>a2a_r2&#45;&gt;agg2</title>
<path fill="none" stroke="black" d="M1119,-27283.16C1119,-27275.12 1119,-27266.39 1119,-27257.66"/>
<polygon fill="black" stroke="black" points="1122.5,-27257.45 1119,-27247.45 1115.5,-27257.45 1122.5,-27257.45"/>
</g>
<!-- norm_m2 -->
<g id="node61" class="node">
<title>norm_m2</title>
<path fill="none" stroke="black" d="M1199,-27105.36C1199,-27105.36 1039,-27105.36 1039,-27105.36 1033,-27105.36 1027,-27099.36 1027,-27093.36 1027,-27093.36 1027,-27064.36 1027,-27064.36 1027,-27058.36 1033,-27052.36 1039,-27052.36 1039,-27052.36 1199,-27052.36 1199,-27052.36 1205,-27052.36 1211,-27058.36 1211,-27064.36 1211,-27064.36 1211,-27093.36 1211,-27093.36 1211,-27099.36 1205,-27105.36 1199,-27105.36"/>
<text text-anchor="start" x="1035" y="-27090.16" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-27075.16" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-27060.16" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg2&#45;&gt;norm_m2 -->
<g id="edge58" class="edge">
<title>agg2&#45;&gt;norm_m2</title>
<path fill="none" stroke="black" d="M1119,-27141.26C1119,-27132.59 1119,-27123.77 1119,-27115.63"/>
<polygon fill="black" stroke="black" points="1122.5,-27115.37 1119,-27105.37 1115.5,-27115.37 1122.5,-27115.37"/>
</g>
<!-- qkv_c3 -->
<g id="node62" class="node">
<title>qkv_c3</title>
<path fill="none" stroke="black" d="M1241,-27016.36C1241,-27016.36 997,-27016.36 997,-27016.36 991,-27016.36 985,-27010.36 985,-27004.36 985,-27004.36 985,-26975.36 985,-26975.36 985,-26969.36 991,-26963.36 997,-26963.36 997,-26963.36 1241,-26963.36 1241,-26963.36 1247,-26963.36 1253,-26969.36 1253,-26975.36 1253,-26975.36 1253,-27004.36 1253,-27004.36 1253,-27010.36 1247,-27016.36 1241,-27016.36"/>
<text text-anchor="start" x="993" y="-27001.16" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-26986.16" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-26971.16" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m2&#45;&gt;qkv_c3 -->
<g id="edge59" class="edge">
<title>norm_m2&#45;&gt;qkv_c3</title>
<path fill="none" stroke="black" d="M1119,-27052.23C1119,-27044.24 1119,-27035.29 1119,-27026.74"/>
<polygon fill="black" stroke="black" points="1122.5,-27026.61 1119,-27016.61 1115.5,-27026.61 1122.5,-27026.61"/>
</g>
<!-- qkv_ar3 -->
<g id="node63" class="node">
<title>qkv_ar3</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-26889.88" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-26901.18" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-26886.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-26871.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c3&#45;&gt;qkv_ar3 -->
<g id="edge60" class="edge">
<title>qkv_c3&#45;&gt;qkv_ar3</title>
<path fill="none" stroke="black" d="M1119,-26963.12C1119,-26955.29 1119,-26946.44 1119,-26937.68"/>
<polygon fill="black" stroke="black" points="1122.5,-26937.5 1119,-26927.5 1115.5,-26937.5 1122.5,-26937.5"/>
</g>
<!-- sph3 -->
<g id="node64" class="node">
<title>sph3</title>
<path fill="none" stroke="black" d="M1327.66,-26816.41C1327.66,-26816.41 1000.64,-26816.41 1000.64,-26816.41 994.64,-26816.41 984.75,-26811.84 980.86,-26807.27 980.86,-26807.27 906.12,-26719.54 906.12,-26719.54 902.23,-26714.97 904.34,-26710.41 910.34,-26710.41 910.34,-26710.41 1237.36,-26710.41 1237.36,-26710.41 1243.36,-26710.41 1253.25,-26714.97 1257.14,-26719.54 1257.14,-26719.54 1331.88,-26807.27 1331.88,-26807.27 1335.77,-26811.84 1333.66,-26816.41 1327.66,-26816.41"/>
<text text-anchor="start" x="942.54" y="-26774.71" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-26759.71" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-26744.71" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar3&#45;&gt;sph3 -->
<g id="edge61" class="edge">
<title>qkv_ar3&#45;&gt;sph3</title>
<path fill="none" stroke="black" d="M1119,-26852.21C1119,-26844.17 1119,-26835.44 1119,-26826.71"/>
<polygon fill="black" stroke="black" points="1122.5,-26826.5 1119,-26816.5 1115.5,-26826.5 1122.5,-26826.5"/>
</g>
<!-- sdp3 -->
<g id="node65" class="node">
<title>sdp3</title>
<path fill="none" stroke="black" d="M1220,-26674.41C1220,-26674.41 1018,-26674.41 1018,-26674.41 1012,-26674.41 1006,-26668.41 1006,-26662.41 1006,-26662.41 1006,-26633.41 1006,-26633.41 1006,-26627.41 1012,-26621.41 1018,-26621.41 1018,-26621.41 1220,-26621.41 1220,-26621.41 1226,-26621.41 1232,-26627.41 1232,-26633.41 1232,-26633.41 1232,-26662.41 1232,-26662.41 1232,-26668.41 1226,-26674.41 1220,-26674.41"/>
<text text-anchor="start" x="1014" y="-26659.21" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-26644.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-26629.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph3&#45;&gt;sdp3 -->
<g id="edge62" class="edge">
<title>sph3&#45;&gt;sdp3</title>
<path fill="none" stroke="black" d="M1119,-26710.31C1119,-26701.63 1119,-26692.82 1119,-26684.67"/>
<polygon fill="black" stroke="black" points="1122.5,-26684.42 1119,-26674.42 1115.5,-26684.42 1122.5,-26684.42"/>
</g>
<!-- sm3 -->
<g id="node66" class="node">
<title>sm3</title>
<path fill="none" stroke="black" d="M1182.5,-26585.41C1182.5,-26585.41 1055.5,-26585.41 1055.5,-26585.41 1049.5,-26585.41 1043.5,-26579.41 1043.5,-26573.41 1043.5,-26573.41 1043.5,-26544.41 1043.5,-26544.41 1043.5,-26538.41 1049.5,-26532.41 1055.5,-26532.41 1055.5,-26532.41 1182.5,-26532.41 1182.5,-26532.41 1188.5,-26532.41 1194.5,-26538.41 1194.5,-26544.41 1194.5,-26544.41 1194.5,-26573.41 1194.5,-26573.41 1194.5,-26579.41 1188.5,-26585.41 1182.5,-26585.41"/>
<text text-anchor="start" x="1051.5" y="-26570.21" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-26555.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-26540.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp3&#45;&gt;sm3 -->
<g id="edge63" class="edge">
<title>sdp3&#45;&gt;sm3</title>
<path fill="none" stroke="black" d="M1119,-26621.27C1119,-26613.29 1119,-26604.34 1119,-26595.79"/>
<polygon fill="black" stroke="black" points="1122.5,-26595.66 1119,-26585.66 1115.5,-26595.66 1122.5,-26595.66"/>
</g>
<!-- do3 -->
<g id="node67" class="node">
<title>do3</title>
<path fill="none" stroke="black" d="M1166.5,-26496.41C1166.5,-26496.41 1071.5,-26496.41 1071.5,-26496.41 1065.5,-26496.41 1059.5,-26490.41 1059.5,-26484.41 1059.5,-26484.41 1059.5,-26455.41 1059.5,-26455.41 1059.5,-26449.41 1065.5,-26443.41 1071.5,-26443.41 1071.5,-26443.41 1166.5,-26443.41 1166.5,-26443.41 1172.5,-26443.41 1178.5,-26449.41 1178.5,-26455.41 1178.5,-26455.41 1178.5,-26484.41 1178.5,-26484.41 1178.5,-26490.41 1172.5,-26496.41 1166.5,-26496.41"/>
<text text-anchor="start" x="1067.5" y="-26481.21" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-26466.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-26451.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm3&#45;&gt;do3 -->
<g id="edge64" class="edge">
<title>sm3&#45;&gt;do3</title>
<path fill="none" stroke="black" d="M1119,-26532.27C1119,-26524.29 1119,-26515.34 1119,-26506.79"/>
<polygon fill="black" stroke="black" points="1122.5,-26506.66 1119,-26496.66 1115.5,-26506.66 1122.5,-26506.66"/>
</g>
<!-- mgh3 -->
<g id="node68" class="node">
<title>mgh3</title>
<path fill="none" stroke="black" d="M1323.86,-26407.41C1323.86,-26407.41 1002.88,-26407.41 1002.88,-26407.41 996.88,-26407.41 987.03,-26402.81 983.18,-26398.2 983.18,-26398.2 909.84,-26310.61 909.84,-26310.61 905.99,-26306.01 908.14,-26301.41 914.14,-26301.41 914.14,-26301.41 1235.12,-26301.41 1235.12,-26301.41 1241.12,-26301.41 1250.97,-26306.01 1254.82,-26310.61 1254.82,-26310.61 1328.16,-26398.2 1328.16,-26398.2 1332.01,-26402.81 1329.86,-26407.41 1323.86,-26407.41"/>
<text text-anchor="start" x="946" y="-26365.71" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-26350.71" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-26335.71" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do3&#45;&gt;mgh3 -->
<g id="edge65" class="edge">
<title>do3&#45;&gt;mgh3</title>
<path fill="none" stroke="black" d="M1119,-26443.15C1119,-26435.45 1119,-26426.66 1119,-26417.67"/>
<polygon fill="black" stroke="black" points="1122.5,-26417.5 1119,-26407.5 1115.5,-26417.5 1122.5,-26417.5"/>
</g>
<!-- proj_r3 -->
<g id="node69" class="node">
<title>proj_r3</title>
<path fill="none" stroke="black" d="M1219,-26265.41C1219,-26265.41 1019,-26265.41 1019,-26265.41 1013,-26265.41 1007,-26259.41 1007,-26253.41 1007,-26253.41 1007,-26224.41 1007,-26224.41 1007,-26218.41 1013,-26212.41 1019,-26212.41 1019,-26212.41 1219,-26212.41 1219,-26212.41 1225,-26212.41 1231,-26218.41 1231,-26224.41 1231,-26224.41 1231,-26253.41 1231,-26253.41 1231,-26259.41 1225,-26265.41 1219,-26265.41"/>
<text text-anchor="start" x="1015" y="-26250.21" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-26235.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-26220.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh3&#45;&gt;proj_r3 -->
<g id="edge66" class="edge">
<title>mgh3&#45;&gt;proj_r3</title>
<path fill="none" stroke="black" d="M1119,-26301.31C1119,-26292.63 1119,-26283.82 1119,-26275.67"/>
<polygon fill="black" stroke="black" points="1122.5,-26275.42 1119,-26265.42 1115.5,-26275.42 1122.5,-26275.42"/>
</g>
<!-- proj_ar3 -->
<g id="node70" class="node">
<title>proj_ar3</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-26138.93" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-26150.23" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-26135.23" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-26120.23" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r3&#45;&gt;proj_ar3 -->
<g id="edge67" class="edge">
<title>proj_r3&#45;&gt;proj_ar3</title>
<path fill="none" stroke="black" d="M1119,-26212.16C1119,-26204.34 1119,-26195.49 1119,-26186.72"/>
<polygon fill="black" stroke="black" points="1122.5,-26186.55 1119,-26176.55 1115.5,-26186.55 1122.5,-26186.55"/>
</g>
<!-- norm3 -->
<g id="node71" class="node">
<title>norm3</title>
<path fill="none" stroke="black" d="M1204,-26065.45C1204,-26065.45 1034,-26065.45 1034,-26065.45 1028,-26065.45 1022,-26059.45 1022,-26053.45 1022,-26053.45 1022,-26024.45 1022,-26024.45 1022,-26018.45 1028,-26012.45 1034,-26012.45 1034,-26012.45 1204,-26012.45 1204,-26012.45 1210,-26012.45 1216,-26018.45 1216,-26024.45 1216,-26024.45 1216,-26053.45 1216,-26053.45 1216,-26059.45 1210,-26065.45 1204,-26065.45"/>
<text text-anchor="start" x="1030" y="-26050.25" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-26035.25" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-26020.25" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar3&#45;&gt;norm3 -->
<g id="edge68" class="edge">
<title>proj_ar3&#45;&gt;norm3</title>
<path fill="none" stroke="black" d="M1119,-26101.45C1119,-26093.03 1119,-26084.09 1119,-26075.7"/>
<polygon fill="black" stroke="black" points="1122.5,-26075.46 1119,-26065.46 1115.5,-26075.46 1122.5,-26075.46"/>
</g>
<!-- gate_c3 -->
<g id="node72" class="node">
<title>gate_c3</title>
<path fill="none" stroke="black" d="M1218.5,-25976.45C1218.5,-25976.45 1019.5,-25976.45 1019.5,-25976.45 1013.5,-25976.45 1007.5,-25970.45 1007.5,-25964.45 1007.5,-25964.45 1007.5,-25935.45 1007.5,-25935.45 1007.5,-25929.45 1013.5,-25923.45 1019.5,-25923.45 1019.5,-25923.45 1218.5,-25923.45 1218.5,-25923.45 1224.5,-25923.45 1230.5,-25929.45 1230.5,-25935.45 1230.5,-25935.45 1230.5,-25964.45 1230.5,-25964.45 1230.5,-25970.45 1224.5,-25976.45 1218.5,-25976.45"/>
<text text-anchor="start" x="1015.5" y="-25961.25" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-25946.25" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-25931.25" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm3&#45;&gt;gate_c3 -->
<g id="edge69" class="edge">
<title>norm3&#45;&gt;gate_c3</title>
<path fill="none" stroke="black" d="M1119,-26012.32C1119,-26004.34 1119,-25995.38 1119,-25986.84"/>
<polygon fill="black" stroke="black" points="1122.5,-25986.7 1119,-25976.7 1115.5,-25986.7 1122.5,-25986.7"/>
</g>
<!-- gate_ar3 -->
<g id="node73" class="node">
<title>gate_ar3</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-25849.98" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-25861.28" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-25846.28" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-25831.28" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c3&#45;&gt;gate_ar3 -->
<g id="edge70" class="edge">
<title>gate_c3&#45;&gt;gate_ar3</title>
<path fill="none" stroke="black" d="M1119,-25923.21C1119,-25915.39 1119,-25906.53 1119,-25897.77"/>
<polygon fill="black" stroke="black" points="1122.5,-25897.6 1119,-25887.6 1115.5,-25897.6 1122.5,-25897.6"/>
</g>
<!-- route3 -->
<g id="node74" class="node">
<title>route3</title>
<path fill="none" stroke="black" d="M1310.41,-25776.5C1310.41,-25776.5 1010.83,-25776.5 1010.83,-25776.5 1004.83,-25776.5 995.13,-25771.78 991.42,-25767.06 991.42,-25767.06 923,-25679.94 923,-25679.94 919.3,-25675.22 921.59,-25670.5 927.59,-25670.5 927.59,-25670.5 1227.17,-25670.5 1227.17,-25670.5 1233.17,-25670.5 1242.87,-25675.22 1246.58,-25679.94 1246.58,-25679.94 1315,-25767.06 1315,-25767.06 1318.7,-25771.78 1316.41,-25776.5 1310.41,-25776.5"/>
<text text-anchor="start" x="957.26" y="-25734.8" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-25719.8" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-25704.8" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar3&#45;&gt;route3 -->
<g id="edge71" class="edge">
<title>gate_ar3&#45;&gt;route3</title>
<path fill="none" stroke="black" d="M1119,-25812.3C1119,-25804.26 1119,-25795.53 1119,-25786.8"/>
<polygon fill="black" stroke="black" points="1122.5,-25786.59 1119,-25776.59 1115.5,-25786.59 1122.5,-25786.59"/>
</g>
<!-- a2a_s3 -->
<g id="node75" class="node">
<title>a2a_s3</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-25597.02" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-25608.32" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-25593.32" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-25578.32" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route3&#45;&gt;a2a_s3 -->
<g id="edge72" class="edge">
<title>route3&#45;&gt;a2a_s3</title>
<path fill="none" stroke="black" d="M1119,-25670.43C1119,-25662 1119,-25653.31 1119,-25645.01"/>
<polygon fill="black" stroke="black" points="1122.5,-25644.75 1119,-25634.75 1115.5,-25644.75 1122.5,-25644.75"/>
</g>
<!-- exp3 -->
<g id="node76" class="node">
<title>exp3</title>
<path fill="none" stroke="black" d="M1233.5,-25523.55C1233.5,-25523.55 1004.5,-25523.55 1004.5,-25523.55 998.5,-25523.55 992.5,-25517.55 992.5,-25511.55 992.5,-25511.55 992.5,-25482.55 992.5,-25482.55 992.5,-25476.55 998.5,-25470.55 1004.5,-25470.55 1004.5,-25470.55 1233.5,-25470.55 1233.5,-25470.55 1239.5,-25470.55 1245.5,-25476.55 1245.5,-25482.55 1245.5,-25482.55 1245.5,-25511.55 1245.5,-25511.55 1245.5,-25517.55 1239.5,-25523.55 1233.5,-25523.55"/>
<text text-anchor="start" x="1000.5" y="-25508.35" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-25493.35" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-25478.35" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s3&#45;&gt;exp3 -->
<g id="edge73" class="edge">
<title>a2a_s3&#45;&gt;exp3</title>
<path fill="none" stroke="black" d="M1119,-25559.54C1119,-25551.12 1119,-25542.18 1119,-25533.8"/>
<polygon fill="black" stroke="black" points="1122.5,-25533.56 1119,-25523.56 1115.5,-25533.56 1122.5,-25533.56"/>
</g>
<!-- exp_ar3 -->
<g id="node77" class="node">
<title>exp_ar3</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-25397.07" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-25408.37" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-25393.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-25378.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp3&#45;&gt;exp_ar3 -->
<g id="edge74" class="edge">
<title>exp3&#45;&gt;exp_ar3</title>
<path fill="none" stroke="black" d="M1119,-25470.3C1119,-25462.48 1119,-25453.63 1119,-25444.86"/>
<polygon fill="black" stroke="black" points="1122.5,-25444.69 1119,-25434.69 1115.5,-25444.69 1122.5,-25444.69"/>
</g>
<!-- a2a_r3 -->
<g id="node78" class="node">
<title>a2a_r3</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-25286.12" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-25297.42" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-25282.42" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-25267.42" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar3&#45;&gt;a2a_r3 -->
<g id="edge75" class="edge">
<title>exp_ar3&#45;&gt;a2a_r3</title>
<path fill="none" stroke="black" d="M1119,-25359.49C1119,-25351.31 1119,-25342.53 1119,-25334.01"/>
<polygon fill="black" stroke="black" points="1122.5,-25333.79 1119,-25323.79 1115.5,-25333.79 1122.5,-25333.79"/>
</g>
<!-- agg3 -->
<g id="node79" class="node">
<title>agg3</title>
<path fill="none" stroke="black" d="M1308.26,-25212.64C1308.26,-25212.64 1012.1,-25212.64 1012.1,-25212.64 1006.1,-25212.64 996.42,-25207.9 992.74,-25203.16 992.74,-25203.16 925.1,-25116.11 925.1,-25116.11 921.42,-25111.38 923.74,-25106.64 929.74,-25106.64 929.74,-25106.64 1225.9,-25106.64 1225.9,-25106.64 1231.9,-25106.64 1241.58,-25111.38 1245.26,-25116.11 1245.26,-25116.11 1312.9,-25203.16 1312.9,-25203.16 1316.58,-25207.9 1314.26,-25212.64 1308.26,-25212.64"/>
<text text-anchor="start" x="958.99" y="-25170.94" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-25155.94" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-25140.94" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r3&#45;&gt;agg3 -->
<g id="edge76" class="edge">
<title>a2a_r3&#45;&gt;agg3</title>
<path fill="none" stroke="black" d="M1119,-25248.44C1119,-25240.4 1119,-25231.67 1119,-25222.94"/>
<polygon fill="black" stroke="black" points="1122.5,-25222.73 1119,-25212.73 1115.5,-25222.73 1122.5,-25222.73"/>
</g>
<!-- norm_m3 -->
<g id="node80" class="node">
<title>norm_m3</title>
<path fill="none" stroke="black" d="M1199,-25070.64C1199,-25070.64 1039,-25070.64 1039,-25070.64 1033,-25070.64 1027,-25064.64 1027,-25058.64 1027,-25058.64 1027,-25029.64 1027,-25029.64 1027,-25023.64 1033,-25017.64 1039,-25017.64 1039,-25017.64 1199,-25017.64 1199,-25017.64 1205,-25017.64 1211,-25023.64 1211,-25029.64 1211,-25029.64 1211,-25058.64 1211,-25058.64 1211,-25064.64 1205,-25070.64 1199,-25070.64"/>
<text text-anchor="start" x="1035" y="-25055.44" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-25040.44" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-25025.44" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg3&#45;&gt;norm_m3 -->
<g id="edge77" class="edge">
<title>agg3&#45;&gt;norm_m3</title>
<path fill="none" stroke="black" d="M1119,-25106.54C1119,-25097.87 1119,-25089.05 1119,-25080.91"/>
<polygon fill="black" stroke="black" points="1122.5,-25080.65 1119,-25070.65 1115.5,-25080.65 1122.5,-25080.65"/>
</g>
<!-- split1 -->
<g id="node81" class="node">
<title>split1</title>
<path fill="none" stroke="black" d="M1340.04,-24970.64C1340.04,-24970.64 993.33,-24970.64 993.33,-24970.64 987.33,-24970.64 977.31,-24966.18 973.3,-24961.72 973.3,-24961.72 893.99,-24873.56 893.99,-24873.56 889.97,-24869.1 891.96,-24864.64 897.96,-24864.64 897.96,-24864.64 1244.67,-24864.64 1244.67,-24864.64 1250.67,-24864.64 1260.69,-24869.1 1264.7,-24873.56 1264.7,-24873.56 1344.01,-24961.72 1344.01,-24961.72 1348.03,-24966.18 1346.04,-24970.64 1340.04,-24970.64"/>
<text text-anchor="start" x="932.14" y="-24928.94" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="932.14" y="-24913.94" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="932.14" y="-24898.94" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- norm_m3&#45;&gt;split1 -->
<g id="edge306" class="edge">
<title>norm_m3&#45;&gt;split1</title>
<path fill="none" stroke="black" d="M1119,-25017.34C1119,-25006.72 1119,-24993.91 1119,-24981.09"/>
<polygon fill="black" stroke="black" points="1122.5,-24980.85 1119,-24970.85 1115.5,-24980.85 1122.5,-24980.85"/>
</g>
<!-- qkv_c4 -->
<g id="node82" class="node">
<title>qkv_c4</title>
<path fill="none" stroke="black" d="M1241,-24828.64C1241,-24828.64 997,-24828.64 997,-24828.64 991,-24828.64 985,-24822.64 985,-24816.64 985,-24816.64 985,-24787.64 985,-24787.64 985,-24781.64 991,-24775.64 997,-24775.64 997,-24775.64 1241,-24775.64 1241,-24775.64 1247,-24775.64 1253,-24781.64 1253,-24787.64 1253,-24787.64 1253,-24816.64 1253,-24816.64 1253,-24822.64 1247,-24828.64 1241,-24828.64"/>
<text text-anchor="start" x="993" y="-24813.44" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-24798.44" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-24783.44" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- split1&#45;&gt;qkv_c4 -->
<g id="edge78" class="edge">
<title>split1&#45;&gt;qkv_c4</title>
<path fill="none" stroke="black" d="M1119,-24864.54C1119,-24855.87 1119,-24847.05 1119,-24838.91"/>
<polygon fill="black" stroke="black" points="1122.5,-24838.65 1119,-24828.65 1115.5,-24838.65 1122.5,-24838.65"/>
</g>
<!-- qkv_ar4 -->
<g id="node83" class="node">
<title>qkv_ar4</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-24702.16" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-24713.46" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-24698.46" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-24683.46" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c4&#45;&gt;qkv_ar4 -->
<g id="edge79" class="edge">
<title>qkv_c4&#45;&gt;qkv_ar4</title>
<path fill="none" stroke="black" d="M1119,-24775.4C1119,-24767.57 1119,-24758.72 1119,-24749.96"/>
<polygon fill="black" stroke="black" points="1122.5,-24749.78 1119,-24739.78 1115.5,-24749.78 1122.5,-24749.78"/>
</g>
<!-- sph4 -->
<g id="node84" class="node">
<title>sph4</title>
<path fill="none" stroke="black" d="M1327.66,-24628.69C1327.66,-24628.69 1000.64,-24628.69 1000.64,-24628.69 994.64,-24628.69 984.75,-24624.12 980.86,-24619.55 980.86,-24619.55 906.12,-24531.82 906.12,-24531.82 902.23,-24527.25 904.34,-24522.69 910.34,-24522.69 910.34,-24522.69 1237.36,-24522.69 1237.36,-24522.69 1243.36,-24522.69 1253.25,-24527.25 1257.14,-24531.82 1257.14,-24531.82 1331.88,-24619.55 1331.88,-24619.55 1335.77,-24624.12 1333.66,-24628.69 1327.66,-24628.69"/>
<text text-anchor="start" x="942.54" y="-24586.99" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-24571.99" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-24556.99" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar4&#45;&gt;sph4 -->
<g id="edge80" class="edge">
<title>qkv_ar4&#45;&gt;sph4</title>
<path fill="none" stroke="black" d="M1119,-24664.49C1119,-24656.45 1119,-24647.72 1119,-24638.99"/>
<polygon fill="black" stroke="black" points="1122.5,-24638.78 1119,-24628.78 1115.5,-24638.78 1122.5,-24638.78"/>
</g>
<!-- sdp4 -->
<g id="node85" class="node">
<title>sdp4</title>
<path fill="none" stroke="black" d="M1220,-24486.69C1220,-24486.69 1018,-24486.69 1018,-24486.69 1012,-24486.69 1006,-24480.69 1006,-24474.69 1006,-24474.69 1006,-24445.69 1006,-24445.69 1006,-24439.69 1012,-24433.69 1018,-24433.69 1018,-24433.69 1220,-24433.69 1220,-24433.69 1226,-24433.69 1232,-24439.69 1232,-24445.69 1232,-24445.69 1232,-24474.69 1232,-24474.69 1232,-24480.69 1226,-24486.69 1220,-24486.69"/>
<text text-anchor="start" x="1014" y="-24471.49" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-24456.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-24441.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph4&#45;&gt;sdp4 -->
<g id="edge81" class="edge">
<title>sph4&#45;&gt;sdp4</title>
<path fill="none" stroke="black" d="M1119,-24522.59C1119,-24513.91 1119,-24505.1 1119,-24496.95"/>
<polygon fill="black" stroke="black" points="1122.5,-24496.7 1119,-24486.7 1115.5,-24496.7 1122.5,-24496.7"/>
</g>
<!-- sm4 -->
<g id="node86" class="node">
<title>sm4</title>
<path fill="none" stroke="black" d="M1182.5,-24397.69C1182.5,-24397.69 1055.5,-24397.69 1055.5,-24397.69 1049.5,-24397.69 1043.5,-24391.69 1043.5,-24385.69 1043.5,-24385.69 1043.5,-24356.69 1043.5,-24356.69 1043.5,-24350.69 1049.5,-24344.69 1055.5,-24344.69 1055.5,-24344.69 1182.5,-24344.69 1182.5,-24344.69 1188.5,-24344.69 1194.5,-24350.69 1194.5,-24356.69 1194.5,-24356.69 1194.5,-24385.69 1194.5,-24385.69 1194.5,-24391.69 1188.5,-24397.69 1182.5,-24397.69"/>
<text text-anchor="start" x="1051.5" y="-24382.49" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-24367.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-24352.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp4&#45;&gt;sm4 -->
<g id="edge82" class="edge">
<title>sdp4&#45;&gt;sm4</title>
<path fill="none" stroke="black" d="M1119,-24433.55C1119,-24425.57 1119,-24416.62 1119,-24408.07"/>
<polygon fill="black" stroke="black" points="1122.5,-24407.94 1119,-24397.94 1115.5,-24407.94 1122.5,-24407.94"/>
</g>
<!-- do4 -->
<g id="node87" class="node">
<title>do4</title>
<path fill="none" stroke="black" d="M1166.5,-24308.69C1166.5,-24308.69 1071.5,-24308.69 1071.5,-24308.69 1065.5,-24308.69 1059.5,-24302.69 1059.5,-24296.69 1059.5,-24296.69 1059.5,-24267.69 1059.5,-24267.69 1059.5,-24261.69 1065.5,-24255.69 1071.5,-24255.69 1071.5,-24255.69 1166.5,-24255.69 1166.5,-24255.69 1172.5,-24255.69 1178.5,-24261.69 1178.5,-24267.69 1178.5,-24267.69 1178.5,-24296.69 1178.5,-24296.69 1178.5,-24302.69 1172.5,-24308.69 1166.5,-24308.69"/>
<text text-anchor="start" x="1067.5" y="-24293.49" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-24278.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-24263.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm4&#45;&gt;do4 -->
<g id="edge83" class="edge">
<title>sm4&#45;&gt;do4</title>
<path fill="none" stroke="black" d="M1119,-24344.55C1119,-24336.57 1119,-24327.62 1119,-24319.07"/>
<polygon fill="black" stroke="black" points="1122.5,-24318.94 1119,-24308.94 1115.5,-24318.94 1122.5,-24318.94"/>
</g>
<!-- mgh4 -->
<g id="node88" class="node">
<title>mgh4</title>
<path fill="none" stroke="black" d="M1323.86,-24219.69C1323.86,-24219.69 1002.88,-24219.69 1002.88,-24219.69 996.88,-24219.69 987.03,-24215.09 983.18,-24210.48 983.18,-24210.48 909.84,-24122.89 909.84,-24122.89 905.99,-24118.29 908.14,-24113.69 914.14,-24113.69 914.14,-24113.69 1235.12,-24113.69 1235.12,-24113.69 1241.12,-24113.69 1250.97,-24118.29 1254.82,-24122.89 1254.82,-24122.89 1328.16,-24210.48 1328.16,-24210.48 1332.01,-24215.09 1329.86,-24219.69 1323.86,-24219.69"/>
<text text-anchor="start" x="946" y="-24177.99" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-24162.99" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-24147.99" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do4&#45;&gt;mgh4 -->
<g id="edge84" class="edge">
<title>do4&#45;&gt;mgh4</title>
<path fill="none" stroke="black" d="M1119,-24255.43C1119,-24247.73 1119,-24238.94 1119,-24229.95"/>
<polygon fill="black" stroke="black" points="1122.5,-24229.78 1119,-24219.78 1115.5,-24229.78 1122.5,-24229.78"/>
</g>
<!-- proj_r4 -->
<g id="node89" class="node">
<title>proj_r4</title>
<path fill="none" stroke="black" d="M1219,-24077.69C1219,-24077.69 1019,-24077.69 1019,-24077.69 1013,-24077.69 1007,-24071.69 1007,-24065.69 1007,-24065.69 1007,-24036.69 1007,-24036.69 1007,-24030.69 1013,-24024.69 1019,-24024.69 1019,-24024.69 1219,-24024.69 1219,-24024.69 1225,-24024.69 1231,-24030.69 1231,-24036.69 1231,-24036.69 1231,-24065.69 1231,-24065.69 1231,-24071.69 1225,-24077.69 1219,-24077.69"/>
<text text-anchor="start" x="1015" y="-24062.49" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-24047.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-24032.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh4&#45;&gt;proj_r4 -->
<g id="edge85" class="edge">
<title>mgh4&#45;&gt;proj_r4</title>
<path fill="none" stroke="black" d="M1119,-24113.59C1119,-24104.91 1119,-24096.1 1119,-24087.95"/>
<polygon fill="black" stroke="black" points="1122.5,-24087.7 1119,-24077.7 1115.5,-24087.7 1122.5,-24087.7"/>
</g>
<!-- proj_ar4 -->
<g id="node90" class="node">
<title>proj_ar4</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-23951.21" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-23962.51" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-23947.51" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-23932.51" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r4&#45;&gt;proj_ar4 -->
<g id="edge86" class="edge">
<title>proj_r4&#45;&gt;proj_ar4</title>
<path fill="none" stroke="black" d="M1119,-24024.44C1119,-24016.62 1119,-24007.77 1119,-23999"/>
<polygon fill="black" stroke="black" points="1122.5,-23998.83 1119,-23988.83 1115.5,-23998.83 1122.5,-23998.83"/>
</g>
<!-- norm4 -->
<g id="node91" class="node">
<title>norm4</title>
<path fill="none" stroke="black" d="M1204,-23877.73C1204,-23877.73 1034,-23877.73 1034,-23877.73 1028,-23877.73 1022,-23871.73 1022,-23865.73 1022,-23865.73 1022,-23836.73 1022,-23836.73 1022,-23830.73 1028,-23824.73 1034,-23824.73 1034,-23824.73 1204,-23824.73 1204,-23824.73 1210,-23824.73 1216,-23830.73 1216,-23836.73 1216,-23836.73 1216,-23865.73 1216,-23865.73 1216,-23871.73 1210,-23877.73 1204,-23877.73"/>
<text text-anchor="start" x="1030" y="-23862.53" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-23847.53" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-23832.53" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar4&#45;&gt;norm4 -->
<g id="edge87" class="edge">
<title>proj_ar4&#45;&gt;norm4</title>
<path fill="none" stroke="black" d="M1119,-23913.73C1119,-23905.31 1119,-23896.37 1119,-23887.98"/>
<polygon fill="black" stroke="black" points="1122.5,-23887.74 1119,-23877.74 1115.5,-23887.74 1122.5,-23887.74"/>
</g>
<!-- gate_c4 -->
<g id="node92" class="node">
<title>gate_c4</title>
<path fill="none" stroke="black" d="M1218.5,-23788.73C1218.5,-23788.73 1019.5,-23788.73 1019.5,-23788.73 1013.5,-23788.73 1007.5,-23782.73 1007.5,-23776.73 1007.5,-23776.73 1007.5,-23747.73 1007.5,-23747.73 1007.5,-23741.73 1013.5,-23735.73 1019.5,-23735.73 1019.5,-23735.73 1218.5,-23735.73 1218.5,-23735.73 1224.5,-23735.73 1230.5,-23741.73 1230.5,-23747.73 1230.5,-23747.73 1230.5,-23776.73 1230.5,-23776.73 1230.5,-23782.73 1224.5,-23788.73 1218.5,-23788.73"/>
<text text-anchor="start" x="1015.5" y="-23773.53" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-23758.53" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-23743.53" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm4&#45;&gt;gate_c4 -->
<g id="edge88" class="edge">
<title>norm4&#45;&gt;gate_c4</title>
<path fill="none" stroke="black" d="M1119,-23824.6C1119,-23816.62 1119,-23807.66 1119,-23799.12"/>
<polygon fill="black" stroke="black" points="1122.5,-23798.98 1119,-23788.98 1115.5,-23798.98 1122.5,-23798.98"/>
</g>
<!-- gate_ar4 -->
<g id="node93" class="node">
<title>gate_ar4</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-23662.26" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-23673.56" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-23658.56" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-23643.56" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c4&#45;&gt;gate_ar4 -->
<g id="edge89" class="edge">
<title>gate_c4&#45;&gt;gate_ar4</title>
<path fill="none" stroke="black" d="M1119,-23735.49C1119,-23727.67 1119,-23718.81 1119,-23710.05"/>
<polygon fill="black" stroke="black" points="1122.5,-23709.88 1119,-23699.88 1115.5,-23709.88 1122.5,-23709.88"/>
</g>
<!-- route4 -->
<g id="node94" class="node">
<title>route4</title>
<path fill="none" stroke="black" d="M1310.41,-23588.78C1310.41,-23588.78 1010.83,-23588.78 1010.83,-23588.78 1004.83,-23588.78 995.13,-23584.06 991.42,-23579.34 991.42,-23579.34 923,-23492.22 923,-23492.22 919.3,-23487.5 921.59,-23482.78 927.59,-23482.78 927.59,-23482.78 1227.17,-23482.78 1227.17,-23482.78 1233.17,-23482.78 1242.87,-23487.5 1246.58,-23492.22 1246.58,-23492.22 1315,-23579.34 1315,-23579.34 1318.7,-23584.06 1316.41,-23588.78 1310.41,-23588.78"/>
<text text-anchor="start" x="957.26" y="-23547.08" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-23532.08" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-23517.08" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar4&#45;&gt;route4 -->
<g id="edge90" class="edge">
<title>gate_ar4&#45;&gt;route4</title>
<path fill="none" stroke="black" d="M1119,-23624.58C1119,-23616.54 1119,-23607.81 1119,-23599.08"/>
<polygon fill="black" stroke="black" points="1122.5,-23598.87 1119,-23588.87 1115.5,-23598.87 1122.5,-23598.87"/>
</g>
<!-- a2a_s4 -->
<g id="node95" class="node">
<title>a2a_s4</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-23409.3" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-23420.6" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-23405.6" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-23390.6" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route4&#45;&gt;a2a_s4 -->
<g id="edge91" class="edge">
<title>route4&#45;&gt;a2a_s4</title>
<path fill="none" stroke="black" d="M1119,-23482.71C1119,-23474.28 1119,-23465.59 1119,-23457.29"/>
<polygon fill="black" stroke="black" points="1122.5,-23457.03 1119,-23447.03 1115.5,-23457.03 1122.5,-23457.03"/>
</g>
<!-- exp4 -->
<g id="node96" class="node">
<title>exp4</title>
<path fill="none" stroke="black" d="M1233.5,-23335.83C1233.5,-23335.83 1004.5,-23335.83 1004.5,-23335.83 998.5,-23335.83 992.5,-23329.83 992.5,-23323.83 992.5,-23323.83 992.5,-23294.83 992.5,-23294.83 992.5,-23288.83 998.5,-23282.83 1004.5,-23282.83 1004.5,-23282.83 1233.5,-23282.83 1233.5,-23282.83 1239.5,-23282.83 1245.5,-23288.83 1245.5,-23294.83 1245.5,-23294.83 1245.5,-23323.83 1245.5,-23323.83 1245.5,-23329.83 1239.5,-23335.83 1233.5,-23335.83"/>
<text text-anchor="start" x="1000.5" y="-23320.63" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-23305.63" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-23290.63" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s4&#45;&gt;exp4 -->
<g id="edge92" class="edge">
<title>a2a_s4&#45;&gt;exp4</title>
<path fill="none" stroke="black" d="M1119,-23371.82C1119,-23363.4 1119,-23354.46 1119,-23346.08"/>
<polygon fill="black" stroke="black" points="1122.5,-23345.84 1119,-23335.84 1115.5,-23345.84 1122.5,-23345.84"/>
</g>
<!-- exp_ar4 -->
<g id="node97" class="node">
<title>exp_ar4</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-23209.35" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-23220.65" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-23205.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-23190.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp4&#45;&gt;exp_ar4 -->
<g id="edge93" class="edge">
<title>exp4&#45;&gt;exp_ar4</title>
<path fill="none" stroke="black" d="M1119,-23282.58C1119,-23274.76 1119,-23265.91 1119,-23257.14"/>
<polygon fill="black" stroke="black" points="1122.5,-23256.97 1119,-23246.97 1115.5,-23256.97 1122.5,-23256.97"/>
</g>
<!-- a2a_r4 -->
<g id="node98" class="node">
<title>a2a_r4</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-23098.4" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-23109.7" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-23094.7" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-23079.7" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar4&#45;&gt;a2a_r4 -->
<g id="edge94" class="edge">
<title>exp_ar4&#45;&gt;a2a_r4</title>
<path fill="none" stroke="black" d="M1119,-23171.77C1119,-23163.59 1119,-23154.81 1119,-23146.29"/>
<polygon fill="black" stroke="black" points="1122.5,-23146.07 1119,-23136.07 1115.5,-23146.07 1122.5,-23146.07"/>
</g>
<!-- agg4 -->
<g id="node99" class="node">
<title>agg4</title>
<path fill="none" stroke="black" d="M1308.26,-23024.92C1308.26,-23024.92 1012.1,-23024.92 1012.1,-23024.92 1006.1,-23024.92 996.42,-23020.18 992.74,-23015.44 992.74,-23015.44 925.1,-22928.39 925.1,-22928.39 921.42,-22923.66 923.74,-22918.92 929.74,-22918.92 929.74,-22918.92 1225.9,-22918.92 1225.9,-22918.92 1231.9,-22918.92 1241.58,-22923.66 1245.26,-22928.39 1245.26,-22928.39 1312.9,-23015.44 1312.9,-23015.44 1316.58,-23020.18 1314.26,-23024.92 1308.26,-23024.92"/>
<text text-anchor="start" x="958.99" y="-22983.22" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-22968.22" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-22953.22" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r4&#45;&gt;agg4 -->
<g id="edge95" class="edge">
<title>a2a_r4&#45;&gt;agg4</title>
<path fill="none" stroke="black" d="M1119,-23060.72C1119,-23052.68 1119,-23043.95 1119,-23035.22"/>
<polygon fill="black" stroke="black" points="1122.5,-23035.01 1119,-23025.01 1115.5,-23035.01 1122.5,-23035.01"/>
</g>
<!-- norm_m4 -->
<g id="node100" class="node">
<title>norm_m4</title>
<path fill="none" stroke="black" d="M1199,-22882.92C1199,-22882.92 1039,-22882.92 1039,-22882.92 1033,-22882.92 1027,-22876.92 1027,-22870.92 1027,-22870.92 1027,-22841.92 1027,-22841.92 1027,-22835.92 1033,-22829.92 1039,-22829.92 1039,-22829.92 1199,-22829.92 1199,-22829.92 1205,-22829.92 1211,-22835.92 1211,-22841.92 1211,-22841.92 1211,-22870.92 1211,-22870.92 1211,-22876.92 1205,-22882.92 1199,-22882.92"/>
<text text-anchor="start" x="1035" y="-22867.72" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-22852.72" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-22837.72" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg4&#45;&gt;norm_m4 -->
<g id="edge96" class="edge">
<title>agg4&#45;&gt;norm_m4</title>
<path fill="none" stroke="black" d="M1119,-22918.82C1119,-22910.15 1119,-22901.33 1119,-22893.19"/>
<polygon fill="black" stroke="black" points="1122.5,-22892.93 1119,-22882.93 1115.5,-22892.93 1122.5,-22892.93"/>
</g>
<!-- qkv_c5 -->
<g id="node101" class="node">
<title>qkv_c5</title>
<path fill="none" stroke="black" d="M1241,-22793.92C1241,-22793.92 997,-22793.92 997,-22793.92 991,-22793.92 985,-22787.92 985,-22781.92 985,-22781.92 985,-22752.92 985,-22752.92 985,-22746.92 991,-22740.92 997,-22740.92 997,-22740.92 1241,-22740.92 1241,-22740.92 1247,-22740.92 1253,-22746.92 1253,-22752.92 1253,-22752.92 1253,-22781.92 1253,-22781.92 1253,-22787.92 1247,-22793.92 1241,-22793.92"/>
<text text-anchor="start" x="993" y="-22778.72" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-22763.72" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-22748.72" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m4&#45;&gt;qkv_c5 -->
<g id="edge97" class="edge">
<title>norm_m4&#45;&gt;qkv_c5</title>
<path fill="none" stroke="black" d="M1119,-22829.79C1119,-22821.8 1119,-22812.85 1119,-22804.3"/>
<polygon fill="black" stroke="black" points="1122.5,-22804.17 1119,-22794.17 1115.5,-22804.17 1122.5,-22804.17"/>
</g>
<!-- qkv_ar5 -->
<g id="node102" class="node">
<title>qkv_ar5</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-22667.44" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-22678.74" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-22663.74" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-22648.74" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c5&#45;&gt;qkv_ar5 -->
<g id="edge98" class="edge">
<title>qkv_c5&#45;&gt;qkv_ar5</title>
<path fill="none" stroke="black" d="M1119,-22740.68C1119,-22732.85 1119,-22724 1119,-22715.24"/>
<polygon fill="black" stroke="black" points="1122.5,-22715.06 1119,-22705.06 1115.5,-22715.06 1122.5,-22715.06"/>
</g>
<!-- sph5 -->
<g id="node103" class="node">
<title>sph5</title>
<path fill="none" stroke="black" d="M1327.66,-22593.97C1327.66,-22593.97 1000.64,-22593.97 1000.64,-22593.97 994.64,-22593.97 984.75,-22589.4 980.86,-22584.83 980.86,-22584.83 906.12,-22497.1 906.12,-22497.1 902.23,-22492.53 904.34,-22487.97 910.34,-22487.97 910.34,-22487.97 1237.36,-22487.97 1237.36,-22487.97 1243.36,-22487.97 1253.25,-22492.53 1257.14,-22497.1 1257.14,-22497.1 1331.88,-22584.83 1331.88,-22584.83 1335.77,-22589.4 1333.66,-22593.97 1327.66,-22593.97"/>
<text text-anchor="start" x="942.54" y="-22552.27" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-22537.27" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-22522.27" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar5&#45;&gt;sph5 -->
<g id="edge99" class="edge">
<title>qkv_ar5&#45;&gt;sph5</title>
<path fill="none" stroke="black" d="M1119,-22629.77C1119,-22621.73 1119,-22613 1119,-22604.27"/>
<polygon fill="black" stroke="black" points="1122.5,-22604.06 1119,-22594.06 1115.5,-22604.06 1122.5,-22604.06"/>
</g>
<!-- sdp5 -->
<g id="node104" class="node">
<title>sdp5</title>
<path fill="none" stroke="black" d="M1220,-22451.97C1220,-22451.97 1018,-22451.97 1018,-22451.97 1012,-22451.97 1006,-22445.97 1006,-22439.97 1006,-22439.97 1006,-22410.97 1006,-22410.97 1006,-22404.97 1012,-22398.97 1018,-22398.97 1018,-22398.97 1220,-22398.97 1220,-22398.97 1226,-22398.97 1232,-22404.97 1232,-22410.97 1232,-22410.97 1232,-22439.97 1232,-22439.97 1232,-22445.97 1226,-22451.97 1220,-22451.97"/>
<text text-anchor="start" x="1014" y="-22436.77" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-22421.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-22406.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph5&#45;&gt;sdp5 -->
<g id="edge100" class="edge">
<title>sph5&#45;&gt;sdp5</title>
<path fill="none" stroke="black" d="M1119,-22487.87C1119,-22479.2 1119,-22470.38 1119,-22462.23"/>
<polygon fill="black" stroke="black" points="1122.5,-22461.98 1119,-22451.98 1115.5,-22461.98 1122.5,-22461.98"/>
</g>
<!-- sm5 -->
<g id="node105" class="node">
<title>sm5</title>
<path fill="none" stroke="black" d="M1182.5,-22362.97C1182.5,-22362.97 1055.5,-22362.97 1055.5,-22362.97 1049.5,-22362.97 1043.5,-22356.97 1043.5,-22350.97 1043.5,-22350.97 1043.5,-22321.97 1043.5,-22321.97 1043.5,-22315.97 1049.5,-22309.97 1055.5,-22309.97 1055.5,-22309.97 1182.5,-22309.97 1182.5,-22309.97 1188.5,-22309.97 1194.5,-22315.97 1194.5,-22321.97 1194.5,-22321.97 1194.5,-22350.97 1194.5,-22350.97 1194.5,-22356.97 1188.5,-22362.97 1182.5,-22362.97"/>
<text text-anchor="start" x="1051.5" y="-22347.77" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-22332.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-22317.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp5&#45;&gt;sm5 -->
<g id="edge101" class="edge">
<title>sdp5&#45;&gt;sm5</title>
<path fill="none" stroke="black" d="M1119,-22398.83C1119,-22390.85 1119,-22381.9 1119,-22373.35"/>
<polygon fill="black" stroke="black" points="1122.5,-22373.22 1119,-22363.22 1115.5,-22373.22 1122.5,-22373.22"/>
</g>
<!-- do5 -->
<g id="node106" class="node">
<title>do5</title>
<path fill="none" stroke="black" d="M1166.5,-22273.97C1166.5,-22273.97 1071.5,-22273.97 1071.5,-22273.97 1065.5,-22273.97 1059.5,-22267.97 1059.5,-22261.97 1059.5,-22261.97 1059.5,-22232.97 1059.5,-22232.97 1059.5,-22226.97 1065.5,-22220.97 1071.5,-22220.97 1071.5,-22220.97 1166.5,-22220.97 1166.5,-22220.97 1172.5,-22220.97 1178.5,-22226.97 1178.5,-22232.97 1178.5,-22232.97 1178.5,-22261.97 1178.5,-22261.97 1178.5,-22267.97 1172.5,-22273.97 1166.5,-22273.97"/>
<text text-anchor="start" x="1067.5" y="-22258.77" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-22243.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-22228.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm5&#45;&gt;do5 -->
<g id="edge102" class="edge">
<title>sm5&#45;&gt;do5</title>
<path fill="none" stroke="black" d="M1119,-22309.83C1119,-22301.85 1119,-22292.9 1119,-22284.35"/>
<polygon fill="black" stroke="black" points="1122.5,-22284.22 1119,-22274.22 1115.5,-22284.22 1122.5,-22284.22"/>
</g>
<!-- mgh5 -->
<g id="node107" class="node">
<title>mgh5</title>
<path fill="none" stroke="black" d="M1323.86,-22184.97C1323.86,-22184.97 1002.88,-22184.97 1002.88,-22184.97 996.88,-22184.97 987.03,-22180.37 983.18,-22175.76 983.18,-22175.76 909.84,-22088.17 909.84,-22088.17 905.99,-22083.57 908.14,-22078.97 914.14,-22078.97 914.14,-22078.97 1235.12,-22078.97 1235.12,-22078.97 1241.12,-22078.97 1250.97,-22083.57 1254.82,-22088.17 1254.82,-22088.17 1328.16,-22175.76 1328.16,-22175.76 1332.01,-22180.37 1329.86,-22184.97 1323.86,-22184.97"/>
<text text-anchor="start" x="946" y="-22143.27" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-22128.27" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-22113.27" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do5&#45;&gt;mgh5 -->
<g id="edge103" class="edge">
<title>do5&#45;&gt;mgh5</title>
<path fill="none" stroke="black" d="M1119,-22220.71C1119,-22213.01 1119,-22204.22 1119,-22195.23"/>
<polygon fill="black" stroke="black" points="1122.5,-22195.06 1119,-22185.06 1115.5,-22195.06 1122.5,-22195.06"/>
</g>
<!-- proj_r5 -->
<g id="node108" class="node">
<title>proj_r5</title>
<path fill="none" stroke="black" d="M1219,-22042.97C1219,-22042.97 1019,-22042.97 1019,-22042.97 1013,-22042.97 1007,-22036.97 1007,-22030.97 1007,-22030.97 1007,-22001.97 1007,-22001.97 1007,-21995.97 1013,-21989.97 1019,-21989.97 1019,-21989.97 1219,-21989.97 1219,-21989.97 1225,-21989.97 1231,-21995.97 1231,-22001.97 1231,-22001.97 1231,-22030.97 1231,-22030.97 1231,-22036.97 1225,-22042.97 1219,-22042.97"/>
<text text-anchor="start" x="1015" y="-22027.77" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-22012.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-21997.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh5&#45;&gt;proj_r5 -->
<g id="edge104" class="edge">
<title>mgh5&#45;&gt;proj_r5</title>
<path fill="none" stroke="black" d="M1119,-22078.87C1119,-22070.2 1119,-22061.38 1119,-22053.23"/>
<polygon fill="black" stroke="black" points="1122.5,-22052.98 1119,-22042.98 1115.5,-22052.98 1122.5,-22052.98"/>
</g>
<!-- proj_ar5 -->
<g id="node109" class="node">
<title>proj_ar5</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-21916.49" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-21927.79" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-21912.79" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-21897.79" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r5&#45;&gt;proj_ar5 -->
<g id="edge105" class="edge">
<title>proj_r5&#45;&gt;proj_ar5</title>
<path fill="none" stroke="black" d="M1119,-21989.72C1119,-21981.9 1119,-21973.05 1119,-21964.28"/>
<polygon fill="black" stroke="black" points="1122.5,-21964.11 1119,-21954.11 1115.5,-21964.11 1122.5,-21964.11"/>
</g>
<!-- norm5 -->
<g id="node110" class="node">
<title>norm5</title>
<path fill="none" stroke="black" d="M1204,-21843.01C1204,-21843.01 1034,-21843.01 1034,-21843.01 1028,-21843.01 1022,-21837.01 1022,-21831.01 1022,-21831.01 1022,-21802.01 1022,-21802.01 1022,-21796.01 1028,-21790.01 1034,-21790.01 1034,-21790.01 1204,-21790.01 1204,-21790.01 1210,-21790.01 1216,-21796.01 1216,-21802.01 1216,-21802.01 1216,-21831.01 1216,-21831.01 1216,-21837.01 1210,-21843.01 1204,-21843.01"/>
<text text-anchor="start" x="1030" y="-21827.81" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-21812.81" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-21797.81" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar5&#45;&gt;norm5 -->
<g id="edge106" class="edge">
<title>proj_ar5&#45;&gt;norm5</title>
<path fill="none" stroke="black" d="M1119,-21879.01C1119,-21870.59 1119,-21861.65 1119,-21853.26"/>
<polygon fill="black" stroke="black" points="1122.5,-21853.02 1119,-21843.02 1115.5,-21853.02 1122.5,-21853.02"/>
</g>
<!-- gate_c5 -->
<g id="node111" class="node">
<title>gate_c5</title>
<path fill="none" stroke="black" d="M1218.5,-21754.01C1218.5,-21754.01 1019.5,-21754.01 1019.5,-21754.01 1013.5,-21754.01 1007.5,-21748.01 1007.5,-21742.01 1007.5,-21742.01 1007.5,-21713.01 1007.5,-21713.01 1007.5,-21707.01 1013.5,-21701.01 1019.5,-21701.01 1019.5,-21701.01 1218.5,-21701.01 1218.5,-21701.01 1224.5,-21701.01 1230.5,-21707.01 1230.5,-21713.01 1230.5,-21713.01 1230.5,-21742.01 1230.5,-21742.01 1230.5,-21748.01 1224.5,-21754.01 1218.5,-21754.01"/>
<text text-anchor="start" x="1015.5" y="-21738.81" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-21723.81" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-21708.81" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm5&#45;&gt;gate_c5 -->
<g id="edge107" class="edge">
<title>norm5&#45;&gt;gate_c5</title>
<path fill="none" stroke="black" d="M1119,-21789.88C1119,-21781.9 1119,-21772.94 1119,-21764.4"/>
<polygon fill="black" stroke="black" points="1122.5,-21764.26 1119,-21754.26 1115.5,-21764.26 1122.5,-21764.26"/>
</g>
<!-- gate_ar5 -->
<g id="node112" class="node">
<title>gate_ar5</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-21627.54" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-21638.84" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-21623.84" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-21608.84" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c5&#45;&gt;gate_ar5 -->
<g id="edge108" class="edge">
<title>gate_c5&#45;&gt;gate_ar5</title>
<path fill="none" stroke="black" d="M1119,-21700.77C1119,-21692.95 1119,-21684.09 1119,-21675.33"/>
<polygon fill="black" stroke="black" points="1122.5,-21675.16 1119,-21665.16 1115.5,-21675.16 1122.5,-21675.16"/>
</g>
<!-- route5 -->
<g id="node113" class="node">
<title>route5</title>
<path fill="none" stroke="black" d="M1310.41,-21554.06C1310.41,-21554.06 1010.83,-21554.06 1010.83,-21554.06 1004.83,-21554.06 995.13,-21549.34 991.42,-21544.62 991.42,-21544.62 923,-21457.5 923,-21457.5 919.3,-21452.78 921.59,-21448.06 927.59,-21448.06 927.59,-21448.06 1227.17,-21448.06 1227.17,-21448.06 1233.17,-21448.06 1242.87,-21452.78 1246.58,-21457.5 1246.58,-21457.5 1315,-21544.62 1315,-21544.62 1318.7,-21549.34 1316.41,-21554.06 1310.41,-21554.06"/>
<text text-anchor="start" x="957.26" y="-21512.36" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-21497.36" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-21482.36" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar5&#45;&gt;route5 -->
<g id="edge109" class="edge">
<title>gate_ar5&#45;&gt;route5</title>
<path fill="none" stroke="black" d="M1119,-21589.86C1119,-21581.82 1119,-21573.09 1119,-21564.36"/>
<polygon fill="black" stroke="black" points="1122.5,-21564.15 1119,-21554.15 1115.5,-21564.15 1122.5,-21564.15"/>
</g>
<!-- a2a_s5 -->
<g id="node114" class="node">
<title>a2a_s5</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-21374.58" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-21385.88" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-21370.88" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-21355.88" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route5&#45;&gt;a2a_s5 -->
<g id="edge110" class="edge">
<title>route5&#45;&gt;a2a_s5</title>
<path fill="none" stroke="black" d="M1119,-21447.99C1119,-21439.56 1119,-21430.87 1119,-21422.57"/>
<polygon fill="black" stroke="black" points="1122.5,-21422.31 1119,-21412.31 1115.5,-21422.31 1122.5,-21422.31"/>
</g>
<!-- exp5 -->
<g id="node115" class="node">
<title>exp5</title>
<path fill="none" stroke="black" d="M1233.5,-21301.11C1233.5,-21301.11 1004.5,-21301.11 1004.5,-21301.11 998.5,-21301.11 992.5,-21295.11 992.5,-21289.11 992.5,-21289.11 992.5,-21260.11 992.5,-21260.11 992.5,-21254.11 998.5,-21248.11 1004.5,-21248.11 1004.5,-21248.11 1233.5,-21248.11 1233.5,-21248.11 1239.5,-21248.11 1245.5,-21254.11 1245.5,-21260.11 1245.5,-21260.11 1245.5,-21289.11 1245.5,-21289.11 1245.5,-21295.11 1239.5,-21301.11 1233.5,-21301.11"/>
<text text-anchor="start" x="1000.5" y="-21285.91" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-21270.91" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-21255.91" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s5&#45;&gt;exp5 -->
<g id="edge111" class="edge">
<title>a2a_s5&#45;&gt;exp5</title>
<path fill="none" stroke="black" d="M1119,-21337.1C1119,-21328.68 1119,-21319.74 1119,-21311.36"/>
<polygon fill="black" stroke="black" points="1122.5,-21311.12 1119,-21301.12 1115.5,-21311.12 1122.5,-21311.12"/>
</g>
<!-- exp_ar5 -->
<g id="node116" class="node">
<title>exp_ar5</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-21174.63" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-21185.93" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-21170.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-21155.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp5&#45;&gt;exp_ar5 -->
<g id="edge112" class="edge">
<title>exp5&#45;&gt;exp_ar5</title>
<path fill="none" stroke="black" d="M1119,-21247.86C1119,-21240.04 1119,-21231.19 1119,-21222.42"/>
<polygon fill="black" stroke="black" points="1122.5,-21222.25 1119,-21212.25 1115.5,-21222.25 1122.5,-21222.25"/>
</g>
<!-- a2a_r5 -->
<g id="node117" class="node">
<title>a2a_r5</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-21063.68" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-21074.98" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-21059.98" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-21044.98" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar5&#45;&gt;a2a_r5 -->
<g id="edge113" class="edge">
<title>exp_ar5&#45;&gt;a2a_r5</title>
<path fill="none" stroke="black" d="M1119,-21137.05C1119,-21128.87 1119,-21120.09 1119,-21111.57"/>
<polygon fill="black" stroke="black" points="1122.5,-21111.35 1119,-21101.35 1115.5,-21111.35 1122.5,-21111.35"/>
</g>
<!-- agg5 -->
<g id="node118" class="node">
<title>agg5</title>
<path fill="none" stroke="black" d="M1308.26,-20990.2C1308.26,-20990.2 1012.1,-20990.2 1012.1,-20990.2 1006.1,-20990.2 996.42,-20985.46 992.74,-20980.72 992.74,-20980.72 925.1,-20893.67 925.1,-20893.67 921.42,-20888.94 923.74,-20884.2 929.74,-20884.2 929.74,-20884.2 1225.9,-20884.2 1225.9,-20884.2 1231.9,-20884.2 1241.58,-20888.94 1245.26,-20893.67 1245.26,-20893.67 1312.9,-20980.72 1312.9,-20980.72 1316.58,-20985.46 1314.26,-20990.2 1308.26,-20990.2"/>
<text text-anchor="start" x="958.99" y="-20948.5" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-20933.5" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-20918.5" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r5&#45;&gt;agg5 -->
<g id="edge114" class="edge">
<title>a2a_r5&#45;&gt;agg5</title>
<path fill="none" stroke="black" d="M1119,-21026C1119,-21017.96 1119,-21009.23 1119,-21000.5"/>
<polygon fill="black" stroke="black" points="1122.5,-21000.29 1119,-20990.29 1115.5,-21000.29 1122.5,-21000.29"/>
</g>
<!-- norm_m5 -->
<g id="node119" class="node">
<title>norm_m5</title>
<path fill="none" stroke="black" d="M1199,-20848.2C1199,-20848.2 1039,-20848.2 1039,-20848.2 1033,-20848.2 1027,-20842.2 1027,-20836.2 1027,-20836.2 1027,-20807.2 1027,-20807.2 1027,-20801.2 1033,-20795.2 1039,-20795.2 1039,-20795.2 1199,-20795.2 1199,-20795.2 1205,-20795.2 1211,-20801.2 1211,-20807.2 1211,-20807.2 1211,-20836.2 1211,-20836.2 1211,-20842.2 1205,-20848.2 1199,-20848.2"/>
<text text-anchor="start" x="1035" y="-20833" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-20818" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-20803" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg5&#45;&gt;norm_m5 -->
<g id="edge115" class="edge">
<title>agg5&#45;&gt;norm_m5</title>
<path fill="none" stroke="black" d="M1119,-20884.1C1119,-20875.43 1119,-20866.61 1119,-20858.47"/>
<polygon fill="black" stroke="black" points="1122.5,-20858.21 1119,-20848.21 1115.5,-20858.21 1122.5,-20858.21"/>
</g>
<!-- qkv_c6 -->
<g id="node120" class="node">
<title>qkv_c6</title>
<path fill="none" stroke="black" d="M1241,-20759.2C1241,-20759.2 997,-20759.2 997,-20759.2 991,-20759.2 985,-20753.2 985,-20747.2 985,-20747.2 985,-20718.2 985,-20718.2 985,-20712.2 991,-20706.2 997,-20706.2 997,-20706.2 1241,-20706.2 1241,-20706.2 1247,-20706.2 1253,-20712.2 1253,-20718.2 1253,-20718.2 1253,-20747.2 1253,-20747.2 1253,-20753.2 1247,-20759.2 1241,-20759.2"/>
<text text-anchor="start" x="993" y="-20744" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-20729" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-20714" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m5&#45;&gt;qkv_c6 -->
<g id="edge116" class="edge">
<title>norm_m5&#45;&gt;qkv_c6</title>
<path fill="none" stroke="black" d="M1119,-20795.07C1119,-20787.08 1119,-20778.13 1119,-20769.58"/>
<polygon fill="black" stroke="black" points="1122.5,-20769.45 1119,-20759.45 1115.5,-20769.45 1122.5,-20769.45"/>
</g>
<!-- qkv_ar6 -->
<g id="node121" class="node">
<title>qkv_ar6</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-20632.72" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-20644.02" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-20629.02" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-20614.02" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c6&#45;&gt;qkv_ar6 -->
<g id="edge117" class="edge">
<title>qkv_c6&#45;&gt;qkv_ar6</title>
<path fill="none" stroke="black" d="M1119,-20705.96C1119,-20698.13 1119,-20689.28 1119,-20680.52"/>
<polygon fill="black" stroke="black" points="1122.5,-20680.34 1119,-20670.34 1115.5,-20680.34 1122.5,-20680.34"/>
</g>
<!-- sph6 -->
<g id="node122" class="node">
<title>sph6</title>
<path fill="none" stroke="black" d="M1327.66,-20559.25C1327.66,-20559.25 1000.64,-20559.25 1000.64,-20559.25 994.64,-20559.25 984.75,-20554.68 980.86,-20550.11 980.86,-20550.11 906.12,-20462.38 906.12,-20462.38 902.23,-20457.81 904.34,-20453.25 910.34,-20453.25 910.34,-20453.25 1237.36,-20453.25 1237.36,-20453.25 1243.36,-20453.25 1253.25,-20457.81 1257.14,-20462.38 1257.14,-20462.38 1331.88,-20550.11 1331.88,-20550.11 1335.77,-20554.68 1333.66,-20559.25 1327.66,-20559.25"/>
<text text-anchor="start" x="942.54" y="-20517.55" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-20502.55" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-20487.55" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar6&#45;&gt;sph6 -->
<g id="edge118" class="edge">
<title>qkv_ar6&#45;&gt;sph6</title>
<path fill="none" stroke="black" d="M1119,-20595.05C1119,-20587.01 1119,-20578.28 1119,-20569.55"/>
<polygon fill="black" stroke="black" points="1122.5,-20569.34 1119,-20559.34 1115.5,-20569.34 1122.5,-20569.34"/>
</g>
<!-- sdp6 -->
<g id="node123" class="node">
<title>sdp6</title>
<path fill="none" stroke="black" d="M1220,-20417.25C1220,-20417.25 1018,-20417.25 1018,-20417.25 1012,-20417.25 1006,-20411.25 1006,-20405.25 1006,-20405.25 1006,-20376.25 1006,-20376.25 1006,-20370.25 1012,-20364.25 1018,-20364.25 1018,-20364.25 1220,-20364.25 1220,-20364.25 1226,-20364.25 1232,-20370.25 1232,-20376.25 1232,-20376.25 1232,-20405.25 1232,-20405.25 1232,-20411.25 1226,-20417.25 1220,-20417.25"/>
<text text-anchor="start" x="1014" y="-20402.05" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-20387.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-20372.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph6&#45;&gt;sdp6 -->
<g id="edge119" class="edge">
<title>sph6&#45;&gt;sdp6</title>
<path fill="none" stroke="black" d="M1119,-20453.15C1119,-20444.48 1119,-20435.66 1119,-20427.51"/>
<polygon fill="black" stroke="black" points="1122.5,-20427.26 1119,-20417.26 1115.5,-20427.26 1122.5,-20427.26"/>
</g>
<!-- sm6 -->
<g id="node124" class="node">
<title>sm6</title>
<path fill="none" stroke="black" d="M1182.5,-20328.25C1182.5,-20328.25 1055.5,-20328.25 1055.5,-20328.25 1049.5,-20328.25 1043.5,-20322.25 1043.5,-20316.25 1043.5,-20316.25 1043.5,-20287.25 1043.5,-20287.25 1043.5,-20281.25 1049.5,-20275.25 1055.5,-20275.25 1055.5,-20275.25 1182.5,-20275.25 1182.5,-20275.25 1188.5,-20275.25 1194.5,-20281.25 1194.5,-20287.25 1194.5,-20287.25 1194.5,-20316.25 1194.5,-20316.25 1194.5,-20322.25 1188.5,-20328.25 1182.5,-20328.25"/>
<text text-anchor="start" x="1051.5" y="-20313.05" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-20298.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-20283.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp6&#45;&gt;sm6 -->
<g id="edge120" class="edge">
<title>sdp6&#45;&gt;sm6</title>
<path fill="none" stroke="black" d="M1119,-20364.11C1119,-20356.13 1119,-20347.18 1119,-20338.63"/>
<polygon fill="black" stroke="black" points="1122.5,-20338.5 1119,-20328.5 1115.5,-20338.5 1122.5,-20338.5"/>
</g>
<!-- do6 -->
<g id="node125" class="node">
<title>do6</title>
<path fill="none" stroke="black" d="M1166.5,-20239.25C1166.5,-20239.25 1071.5,-20239.25 1071.5,-20239.25 1065.5,-20239.25 1059.5,-20233.25 1059.5,-20227.25 1059.5,-20227.25 1059.5,-20198.25 1059.5,-20198.25 1059.5,-20192.25 1065.5,-20186.25 1071.5,-20186.25 1071.5,-20186.25 1166.5,-20186.25 1166.5,-20186.25 1172.5,-20186.25 1178.5,-20192.25 1178.5,-20198.25 1178.5,-20198.25 1178.5,-20227.25 1178.5,-20227.25 1178.5,-20233.25 1172.5,-20239.25 1166.5,-20239.25"/>
<text text-anchor="start" x="1067.5" y="-20224.05" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-20209.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-20194.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm6&#45;&gt;do6 -->
<g id="edge121" class="edge">
<title>sm6&#45;&gt;do6</title>
<path fill="none" stroke="black" d="M1119,-20275.11C1119,-20267.13 1119,-20258.18 1119,-20249.63"/>
<polygon fill="black" stroke="black" points="1122.5,-20249.5 1119,-20239.5 1115.5,-20249.5 1122.5,-20249.5"/>
</g>
<!-- mgh6 -->
<g id="node126" class="node">
<title>mgh6</title>
<path fill="none" stroke="black" d="M1323.86,-20150.25C1323.86,-20150.25 1002.88,-20150.25 1002.88,-20150.25 996.88,-20150.25 987.03,-20145.65 983.18,-20141.04 983.18,-20141.04 909.84,-20053.45 909.84,-20053.45 905.99,-20048.85 908.14,-20044.25 914.14,-20044.25 914.14,-20044.25 1235.12,-20044.25 1235.12,-20044.25 1241.12,-20044.25 1250.97,-20048.85 1254.82,-20053.45 1254.82,-20053.45 1328.16,-20141.04 1328.16,-20141.04 1332.01,-20145.65 1329.86,-20150.25 1323.86,-20150.25"/>
<text text-anchor="start" x="946" y="-20108.55" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-20093.55" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-20078.55" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do6&#45;&gt;mgh6 -->
<g id="edge122" class="edge">
<title>do6&#45;&gt;mgh6</title>
<path fill="none" stroke="black" d="M1119,-20185.99C1119,-20178.29 1119,-20169.5 1119,-20160.51"/>
<polygon fill="black" stroke="black" points="1122.5,-20160.34 1119,-20150.34 1115.5,-20160.34 1122.5,-20160.34"/>
</g>
<!-- proj_r6 -->
<g id="node127" class="node">
<title>proj_r6</title>
<path fill="none" stroke="black" d="M1219,-20008.25C1219,-20008.25 1019,-20008.25 1019,-20008.25 1013,-20008.25 1007,-20002.25 1007,-19996.25 1007,-19996.25 1007,-19967.25 1007,-19967.25 1007,-19961.25 1013,-19955.25 1019,-19955.25 1019,-19955.25 1219,-19955.25 1219,-19955.25 1225,-19955.25 1231,-19961.25 1231,-19967.25 1231,-19967.25 1231,-19996.25 1231,-19996.25 1231,-20002.25 1225,-20008.25 1219,-20008.25"/>
<text text-anchor="start" x="1015" y="-19993.05" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-19978.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-19963.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh6&#45;&gt;proj_r6 -->
<g id="edge123" class="edge">
<title>mgh6&#45;&gt;proj_r6</title>
<path fill="none" stroke="black" d="M1119,-20044.15C1119,-20035.48 1119,-20026.66 1119,-20018.51"/>
<polygon fill="black" stroke="black" points="1122.5,-20018.26 1119,-20008.26 1115.5,-20018.26 1122.5,-20018.26"/>
</g>
<!-- proj_ar6 -->
<g id="node128" class="node">
<title>proj_ar6</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-19881.77" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-19893.07" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-19878.07" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-19863.07" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r6&#45;&gt;proj_ar6 -->
<g id="edge124" class="edge">
<title>proj_r6&#45;&gt;proj_ar6</title>
<path fill="none" stroke="black" d="M1119,-19955C1119,-19947.18 1119,-19938.33 1119,-19929.56"/>
<polygon fill="black" stroke="black" points="1122.5,-19929.39 1119,-19919.39 1115.5,-19929.39 1122.5,-19929.39"/>
</g>
<!-- norm6 -->
<g id="node129" class="node">
<title>norm6</title>
<path fill="none" stroke="black" d="M1204,-19808.29C1204,-19808.29 1034,-19808.29 1034,-19808.29 1028,-19808.29 1022,-19802.29 1022,-19796.29 1022,-19796.29 1022,-19767.29 1022,-19767.29 1022,-19761.29 1028,-19755.29 1034,-19755.29 1034,-19755.29 1204,-19755.29 1204,-19755.29 1210,-19755.29 1216,-19761.29 1216,-19767.29 1216,-19767.29 1216,-19796.29 1216,-19796.29 1216,-19802.29 1210,-19808.29 1204,-19808.29"/>
<text text-anchor="start" x="1030" y="-19793.09" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-19778.09" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-19763.09" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar6&#45;&gt;norm6 -->
<g id="edge125" class="edge">
<title>proj_ar6&#45;&gt;norm6</title>
<path fill="none" stroke="black" d="M1119,-19844.29C1119,-19835.87 1119,-19826.93 1119,-19818.54"/>
<polygon fill="black" stroke="black" points="1122.5,-19818.3 1119,-19808.3 1115.5,-19818.3 1122.5,-19818.3"/>
</g>
<!-- gate_c6 -->
<g id="node130" class="node">
<title>gate_c6</title>
<path fill="none" stroke="black" d="M1218.5,-19719.29C1218.5,-19719.29 1019.5,-19719.29 1019.5,-19719.29 1013.5,-19719.29 1007.5,-19713.29 1007.5,-19707.29 1007.5,-19707.29 1007.5,-19678.29 1007.5,-19678.29 1007.5,-19672.29 1013.5,-19666.29 1019.5,-19666.29 1019.5,-19666.29 1218.5,-19666.29 1218.5,-19666.29 1224.5,-19666.29 1230.5,-19672.29 1230.5,-19678.29 1230.5,-19678.29 1230.5,-19707.29 1230.5,-19707.29 1230.5,-19713.29 1224.5,-19719.29 1218.5,-19719.29"/>
<text text-anchor="start" x="1015.5" y="-19704.09" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-19689.09" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-19674.09" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm6&#45;&gt;gate_c6 -->
<g id="edge126" class="edge">
<title>norm6&#45;&gt;gate_c6</title>
<path fill="none" stroke="black" d="M1119,-19755.16C1119,-19747.18 1119,-19738.22 1119,-19729.68"/>
<polygon fill="black" stroke="black" points="1122.5,-19729.54 1119,-19719.54 1115.5,-19729.54 1122.5,-19729.54"/>
</g>
<!-- gate_ar6 -->
<g id="node131" class="node">
<title>gate_ar6</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-19592.82" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-19604.12" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-19589.12" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-19574.12" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c6&#45;&gt;gate_ar6 -->
<g id="edge127" class="edge">
<title>gate_c6&#45;&gt;gate_ar6</title>
<path fill="none" stroke="black" d="M1119,-19666.05C1119,-19658.23 1119,-19649.37 1119,-19640.61"/>
<polygon fill="black" stroke="black" points="1122.5,-19640.44 1119,-19630.44 1115.5,-19640.44 1122.5,-19640.44"/>
</g>
<!-- route6 -->
<g id="node132" class="node">
<title>route6</title>
<path fill="none" stroke="black" d="M1310.41,-19519.34C1310.41,-19519.34 1010.83,-19519.34 1010.83,-19519.34 1004.83,-19519.34 995.13,-19514.62 991.42,-19509.9 991.42,-19509.9 923,-19422.78 923,-19422.78 919.3,-19418.06 921.59,-19413.34 927.59,-19413.34 927.59,-19413.34 1227.17,-19413.34 1227.17,-19413.34 1233.17,-19413.34 1242.87,-19418.06 1246.58,-19422.78 1246.58,-19422.78 1315,-19509.9 1315,-19509.9 1318.7,-19514.62 1316.41,-19519.34 1310.41,-19519.34"/>
<text text-anchor="start" x="957.26" y="-19477.64" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-19462.64" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-19447.64" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar6&#45;&gt;route6 -->
<g id="edge128" class="edge">
<title>gate_ar6&#45;&gt;route6</title>
<path fill="none" stroke="black" d="M1119,-19555.14C1119,-19547.1 1119,-19538.37 1119,-19529.64"/>
<polygon fill="black" stroke="black" points="1122.5,-19529.43 1119,-19519.43 1115.5,-19529.43 1122.5,-19529.43"/>
</g>
<!-- a2a_s6 -->
<g id="node133" class="node">
<title>a2a_s6</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-19339.86" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-19351.16" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-19336.16" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-19321.16" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route6&#45;&gt;a2a_s6 -->
<g id="edge129" class="edge">
<title>route6&#45;&gt;a2a_s6</title>
<path fill="none" stroke="black" d="M1119,-19413.27C1119,-19404.84 1119,-19396.15 1119,-19387.85"/>
<polygon fill="black" stroke="black" points="1122.5,-19387.59 1119,-19377.59 1115.5,-19387.59 1122.5,-19387.59"/>
</g>
<!-- exp6 -->
<g id="node134" class="node">
<title>exp6</title>
<path fill="none" stroke="black" d="M1233.5,-19266.39C1233.5,-19266.39 1004.5,-19266.39 1004.5,-19266.39 998.5,-19266.39 992.5,-19260.39 992.5,-19254.39 992.5,-19254.39 992.5,-19225.39 992.5,-19225.39 992.5,-19219.39 998.5,-19213.39 1004.5,-19213.39 1004.5,-19213.39 1233.5,-19213.39 1233.5,-19213.39 1239.5,-19213.39 1245.5,-19219.39 1245.5,-19225.39 1245.5,-19225.39 1245.5,-19254.39 1245.5,-19254.39 1245.5,-19260.39 1239.5,-19266.39 1233.5,-19266.39"/>
<text text-anchor="start" x="1000.5" y="-19251.19" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-19236.19" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-19221.19" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s6&#45;&gt;exp6 -->
<g id="edge130" class="edge">
<title>a2a_s6&#45;&gt;exp6</title>
<path fill="none" stroke="black" d="M1119,-19302.38C1119,-19293.96 1119,-19285.02 1119,-19276.64"/>
<polygon fill="black" stroke="black" points="1122.5,-19276.4 1119,-19266.4 1115.5,-19276.4 1122.5,-19276.4"/>
</g>
<!-- exp_ar6 -->
<g id="node135" class="node">
<title>exp_ar6</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-19139.91" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-19151.21" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-19136.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-19121.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp6&#45;&gt;exp_ar6 -->
<g id="edge131" class="edge">
<title>exp6&#45;&gt;exp_ar6</title>
<path fill="none" stroke="black" d="M1119,-19213.14C1119,-19205.32 1119,-19196.47 1119,-19187.71"/>
<polygon fill="black" stroke="black" points="1122.5,-19187.53 1119,-19177.53 1115.5,-19187.53 1122.5,-19187.53"/>
</g>
<!-- a2a_r6 -->
<g id="node136" class="node">
<title>a2a_r6</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-19028.96" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-19040.26" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-19025.26" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-19010.26" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar6&#45;&gt;a2a_r6 -->
<g id="edge132" class="edge">
<title>exp_ar6&#45;&gt;a2a_r6</title>
<path fill="none" stroke="black" d="M1119,-19102.33C1119,-19094.15 1119,-19085.37 1119,-19076.85"/>
<polygon fill="black" stroke="black" points="1122.5,-19076.63 1119,-19066.63 1115.5,-19076.63 1122.5,-19076.63"/>
</g>
<!-- agg6 -->
<g id="node137" class="node">
<title>agg6</title>
<path fill="none" stroke="black" d="M1308.26,-18955.48C1308.26,-18955.48 1012.1,-18955.48 1012.1,-18955.48 1006.1,-18955.48 996.42,-18950.74 992.74,-18946 992.74,-18946 925.1,-18858.96 925.1,-18858.96 921.42,-18854.22 923.74,-18849.48 929.74,-18849.48 929.74,-18849.48 1225.9,-18849.48 1225.9,-18849.48 1231.9,-18849.48 1241.58,-18854.22 1245.26,-18858.96 1245.26,-18858.96 1312.9,-18946 1312.9,-18946 1316.58,-18950.74 1314.26,-18955.48 1308.26,-18955.48"/>
<text text-anchor="start" x="958.99" y="-18913.78" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-18898.78" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-18883.78" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r6&#45;&gt;agg6 -->
<g id="edge133" class="edge">
<title>a2a_r6&#45;&gt;agg6</title>
<path fill="none" stroke="black" d="M1119,-18991.28C1119,-18983.24 1119,-18974.51 1119,-18965.78"/>
<polygon fill="black" stroke="black" points="1122.5,-18965.57 1119,-18955.57 1115.5,-18965.57 1122.5,-18965.57"/>
</g>
<!-- norm_m6 -->
<g id="node138" class="node">
<title>norm_m6</title>
<path fill="none" stroke="black" d="M1199,-18813.48C1199,-18813.48 1039,-18813.48 1039,-18813.48 1033,-18813.48 1027,-18807.48 1027,-18801.48 1027,-18801.48 1027,-18772.48 1027,-18772.48 1027,-18766.48 1033,-18760.48 1039,-18760.48 1039,-18760.48 1199,-18760.48 1199,-18760.48 1205,-18760.48 1211,-18766.48 1211,-18772.48 1211,-18772.48 1211,-18801.48 1211,-18801.48 1211,-18807.48 1205,-18813.48 1199,-18813.48"/>
<text text-anchor="start" x="1035" y="-18798.28" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-18783.28" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-18768.28" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg6&#45;&gt;norm_m6 -->
<g id="edge134" class="edge">
<title>agg6&#45;&gt;norm_m6</title>
<path fill="none" stroke="black" d="M1119,-18849.38C1119,-18840.71 1119,-18831.89 1119,-18823.75"/>
<polygon fill="black" stroke="black" points="1122.5,-18823.49 1119,-18813.49 1115.5,-18823.49 1122.5,-18823.49"/>
</g>
<!-- qkv_c7 -->
<g id="node139" class="node">
<title>qkv_c7</title>
<path fill="none" stroke="black" d="M1241,-18724.48C1241,-18724.48 997,-18724.48 997,-18724.48 991,-18724.48 985,-18718.48 985,-18712.48 985,-18712.48 985,-18683.48 985,-18683.48 985,-18677.48 991,-18671.48 997,-18671.48 997,-18671.48 1241,-18671.48 1241,-18671.48 1247,-18671.48 1253,-18677.48 1253,-18683.48 1253,-18683.48 1253,-18712.48 1253,-18712.48 1253,-18718.48 1247,-18724.48 1241,-18724.48"/>
<text text-anchor="start" x="993" y="-18709.28" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-18694.28" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-18679.28" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m6&#45;&gt;qkv_c7 -->
<g id="edge135" class="edge">
<title>norm_m6&#45;&gt;qkv_c7</title>
<path fill="none" stroke="black" d="M1119,-18760.35C1119,-18752.36 1119,-18743.41 1119,-18734.86"/>
<polygon fill="black" stroke="black" points="1122.5,-18734.73 1119,-18724.73 1115.5,-18734.73 1122.5,-18734.73"/>
</g>
<!-- qkv_ar7 -->
<g id="node140" class="node">
<title>qkv_ar7</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-18598" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-18609.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-18594.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-18579.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c7&#45;&gt;qkv_ar7 -->
<g id="edge136" class="edge">
<title>qkv_c7&#45;&gt;qkv_ar7</title>
<path fill="none" stroke="black" d="M1119,-18671.24C1119,-18663.41 1119,-18654.56 1119,-18645.8"/>
<polygon fill="black" stroke="black" points="1122.5,-18645.62 1119,-18635.62 1115.5,-18645.62 1122.5,-18645.62"/>
</g>
<!-- sph7 -->
<g id="node141" class="node">
<title>sph7</title>
<path fill="none" stroke="black" d="M1327.66,-18524.53C1327.66,-18524.53 1000.64,-18524.53 1000.64,-18524.53 994.64,-18524.53 984.75,-18519.96 980.86,-18515.39 980.86,-18515.39 906.12,-18427.66 906.12,-18427.66 902.23,-18423.09 904.34,-18418.53 910.34,-18418.53 910.34,-18418.53 1237.36,-18418.53 1237.36,-18418.53 1243.36,-18418.53 1253.25,-18423.09 1257.14,-18427.66 1257.14,-18427.66 1331.88,-18515.39 1331.88,-18515.39 1335.77,-18519.96 1333.66,-18524.53 1327.66,-18524.53"/>
<text text-anchor="start" x="942.54" y="-18482.83" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-18467.83" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-18452.83" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar7&#45;&gt;sph7 -->
<g id="edge137" class="edge">
<title>qkv_ar7&#45;&gt;sph7</title>
<path fill="none" stroke="black" d="M1119,-18560.33C1119,-18552.29 1119,-18543.56 1119,-18534.83"/>
<polygon fill="black" stroke="black" points="1122.5,-18534.62 1119,-18524.62 1115.5,-18534.62 1122.5,-18534.62"/>
</g>
<!-- sdp7 -->
<g id="node142" class="node">
<title>sdp7</title>
<path fill="none" stroke="black" d="M1220,-18382.53C1220,-18382.53 1018,-18382.53 1018,-18382.53 1012,-18382.53 1006,-18376.53 1006,-18370.53 1006,-18370.53 1006,-18341.53 1006,-18341.53 1006,-18335.53 1012,-18329.53 1018,-18329.53 1018,-18329.53 1220,-18329.53 1220,-18329.53 1226,-18329.53 1232,-18335.53 1232,-18341.53 1232,-18341.53 1232,-18370.53 1232,-18370.53 1232,-18376.53 1226,-18382.53 1220,-18382.53"/>
<text text-anchor="start" x="1014" y="-18367.33" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-18352.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-18337.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph7&#45;&gt;sdp7 -->
<g id="edge138" class="edge">
<title>sph7&#45;&gt;sdp7</title>
<path fill="none" stroke="black" d="M1119,-18418.43C1119,-18409.76 1119,-18400.94 1119,-18392.79"/>
<polygon fill="black" stroke="black" points="1122.5,-18392.54 1119,-18382.54 1115.5,-18392.54 1122.5,-18392.54"/>
</g>
<!-- sm7 -->
<g id="node143" class="node">
<title>sm7</title>
<path fill="none" stroke="black" d="M1182.5,-18293.53C1182.5,-18293.53 1055.5,-18293.53 1055.5,-18293.53 1049.5,-18293.53 1043.5,-18287.53 1043.5,-18281.53 1043.5,-18281.53 1043.5,-18252.53 1043.5,-18252.53 1043.5,-18246.53 1049.5,-18240.53 1055.5,-18240.53 1055.5,-18240.53 1182.5,-18240.53 1182.5,-18240.53 1188.5,-18240.53 1194.5,-18246.53 1194.5,-18252.53 1194.5,-18252.53 1194.5,-18281.53 1194.5,-18281.53 1194.5,-18287.53 1188.5,-18293.53 1182.5,-18293.53"/>
<text text-anchor="start" x="1051.5" y="-18278.33" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-18263.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-18248.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp7&#45;&gt;sm7 -->
<g id="edge139" class="edge">
<title>sdp7&#45;&gt;sm7</title>
<path fill="none" stroke="black" d="M1119,-18329.39C1119,-18321.41 1119,-18312.46 1119,-18303.91"/>
<polygon fill="black" stroke="black" points="1122.5,-18303.78 1119,-18293.78 1115.5,-18303.78 1122.5,-18303.78"/>
</g>
<!-- do7 -->
<g id="node144" class="node">
<title>do7</title>
<path fill="none" stroke="black" d="M1166.5,-18204.53C1166.5,-18204.53 1071.5,-18204.53 1071.5,-18204.53 1065.5,-18204.53 1059.5,-18198.53 1059.5,-18192.53 1059.5,-18192.53 1059.5,-18163.53 1059.5,-18163.53 1059.5,-18157.53 1065.5,-18151.53 1071.5,-18151.53 1071.5,-18151.53 1166.5,-18151.53 1166.5,-18151.53 1172.5,-18151.53 1178.5,-18157.53 1178.5,-18163.53 1178.5,-18163.53 1178.5,-18192.53 1178.5,-18192.53 1178.5,-18198.53 1172.5,-18204.53 1166.5,-18204.53"/>
<text text-anchor="start" x="1067.5" y="-18189.33" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-18174.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-18159.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm7&#45;&gt;do7 -->
<g id="edge140" class="edge">
<title>sm7&#45;&gt;do7</title>
<path fill="none" stroke="black" d="M1119,-18240.39C1119,-18232.41 1119,-18223.46 1119,-18214.91"/>
<polygon fill="black" stroke="black" points="1122.5,-18214.78 1119,-18204.78 1115.5,-18214.78 1122.5,-18214.78"/>
</g>
<!-- mgh7 -->
<g id="node145" class="node">
<title>mgh7</title>
<path fill="none" stroke="black" d="M1323.86,-18115.53C1323.86,-18115.53 1002.88,-18115.53 1002.88,-18115.53 996.88,-18115.53 987.03,-18110.93 983.18,-18106.32 983.18,-18106.32 909.84,-18018.73 909.84,-18018.73 905.99,-18014.13 908.14,-18009.53 914.14,-18009.53 914.14,-18009.53 1235.12,-18009.53 1235.12,-18009.53 1241.12,-18009.53 1250.97,-18014.13 1254.82,-18018.73 1254.82,-18018.73 1328.16,-18106.32 1328.16,-18106.32 1332.01,-18110.93 1329.86,-18115.53 1323.86,-18115.53"/>
<text text-anchor="start" x="946" y="-18073.83" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-18058.83" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-18043.83" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do7&#45;&gt;mgh7 -->
<g id="edge141" class="edge">
<title>do7&#45;&gt;mgh7</title>
<path fill="none" stroke="black" d="M1119,-18151.27C1119,-18143.57 1119,-18134.78 1119,-18125.79"/>
<polygon fill="black" stroke="black" points="1122.5,-18125.62 1119,-18115.62 1115.5,-18125.62 1122.5,-18125.62"/>
</g>
<!-- proj_r7 -->
<g id="node146" class="node">
<title>proj_r7</title>
<path fill="none" stroke="black" d="M1219,-17973.53C1219,-17973.53 1019,-17973.53 1019,-17973.53 1013,-17973.53 1007,-17967.53 1007,-17961.53 1007,-17961.53 1007,-17932.53 1007,-17932.53 1007,-17926.53 1013,-17920.53 1019,-17920.53 1019,-17920.53 1219,-17920.53 1219,-17920.53 1225,-17920.53 1231,-17926.53 1231,-17932.53 1231,-17932.53 1231,-17961.53 1231,-17961.53 1231,-17967.53 1225,-17973.53 1219,-17973.53"/>
<text text-anchor="start" x="1015" y="-17958.33" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-17943.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-17928.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh7&#45;&gt;proj_r7 -->
<g id="edge142" class="edge">
<title>mgh7&#45;&gt;proj_r7</title>
<path fill="none" stroke="black" d="M1119,-18009.43C1119,-18000.76 1119,-17991.94 1119,-17983.79"/>
<polygon fill="black" stroke="black" points="1122.5,-17983.54 1119,-17973.54 1115.5,-17983.54 1122.5,-17983.54"/>
</g>
<!-- proj_ar7 -->
<g id="node147" class="node">
<title>proj_ar7</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-17847.05" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-17858.35" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-17843.35" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-17828.35" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r7&#45;&gt;proj_ar7 -->
<g id="edge143" class="edge">
<title>proj_r7&#45;&gt;proj_ar7</title>
<path fill="none" stroke="black" d="M1119,-17920.28C1119,-17912.46 1119,-17903.61 1119,-17894.85"/>
<polygon fill="black" stroke="black" points="1122.5,-17894.67 1119,-17884.67 1115.5,-17894.67 1122.5,-17894.67"/>
</g>
<!-- norm7 -->
<g id="node148" class="node">
<title>norm7</title>
<path fill="none" stroke="black" d="M1204,-17773.57C1204,-17773.57 1034,-17773.57 1034,-17773.57 1028,-17773.57 1022,-17767.57 1022,-17761.57 1022,-17761.57 1022,-17732.57 1022,-17732.57 1022,-17726.57 1028,-17720.57 1034,-17720.57 1034,-17720.57 1204,-17720.57 1204,-17720.57 1210,-17720.57 1216,-17726.57 1216,-17732.57 1216,-17732.57 1216,-17761.57 1216,-17761.57 1216,-17767.57 1210,-17773.57 1204,-17773.57"/>
<text text-anchor="start" x="1030" y="-17758.37" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-17743.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-17728.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar7&#45;&gt;norm7 -->
<g id="edge144" class="edge">
<title>proj_ar7&#45;&gt;norm7</title>
<path fill="none" stroke="black" d="M1119,-17809.57C1119,-17801.15 1119,-17792.21 1119,-17783.82"/>
<polygon fill="black" stroke="black" points="1122.5,-17783.58 1119,-17773.58 1115.5,-17783.58 1122.5,-17783.58"/>
</g>
<!-- gate_c7 -->
<g id="node149" class="node">
<title>gate_c7</title>
<path fill="none" stroke="black" d="M1218.5,-17684.57C1218.5,-17684.57 1019.5,-17684.57 1019.5,-17684.57 1013.5,-17684.57 1007.5,-17678.57 1007.5,-17672.57 1007.5,-17672.57 1007.5,-17643.57 1007.5,-17643.57 1007.5,-17637.57 1013.5,-17631.57 1019.5,-17631.57 1019.5,-17631.57 1218.5,-17631.57 1218.5,-17631.57 1224.5,-17631.57 1230.5,-17637.57 1230.5,-17643.57 1230.5,-17643.57 1230.5,-17672.57 1230.5,-17672.57 1230.5,-17678.57 1224.5,-17684.57 1218.5,-17684.57"/>
<text text-anchor="start" x="1015.5" y="-17669.37" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-17654.37" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-17639.37" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm7&#45;&gt;gate_c7 -->
<g id="edge145" class="edge">
<title>norm7&#45;&gt;gate_c7</title>
<path fill="none" stroke="black" d="M1119,-17720.44C1119,-17712.46 1119,-17703.5 1119,-17694.96"/>
<polygon fill="black" stroke="black" points="1122.5,-17694.82 1119,-17684.82 1115.5,-17694.82 1122.5,-17694.82"/>
</g>
<!-- gate_ar7 -->
<g id="node150" class="node">
<title>gate_ar7</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-17558.1" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-17569.4" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-17554.4" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-17539.4" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c7&#45;&gt;gate_ar7 -->
<g id="edge146" class="edge">
<title>gate_c7&#45;&gt;gate_ar7</title>
<path fill="none" stroke="black" d="M1119,-17631.33C1119,-17623.51 1119,-17614.65 1119,-17605.89"/>
<polygon fill="black" stroke="black" points="1122.5,-17605.72 1119,-17595.72 1115.5,-17605.72 1122.5,-17605.72"/>
</g>
<!-- route7 -->
<g id="node151" class="node">
<title>route7</title>
<path fill="none" stroke="black" d="M1310.41,-17484.62C1310.41,-17484.62 1010.83,-17484.62 1010.83,-17484.62 1004.83,-17484.62 995.13,-17479.9 991.42,-17475.18 991.42,-17475.18 923,-17388.06 923,-17388.06 919.3,-17383.34 921.59,-17378.62 927.59,-17378.62 927.59,-17378.62 1227.17,-17378.62 1227.17,-17378.62 1233.17,-17378.62 1242.87,-17383.34 1246.58,-17388.06 1246.58,-17388.06 1315,-17475.18 1315,-17475.18 1318.7,-17479.9 1316.41,-17484.62 1310.41,-17484.62"/>
<text text-anchor="start" x="957.26" y="-17442.92" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-17427.92" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-17412.92" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar7&#45;&gt;route7 -->
<g id="edge147" class="edge">
<title>gate_ar7&#45;&gt;route7</title>
<path fill="none" stroke="black" d="M1119,-17520.42C1119,-17512.38 1119,-17503.65 1119,-17494.92"/>
<polygon fill="black" stroke="black" points="1122.5,-17494.71 1119,-17484.71 1115.5,-17494.71 1122.5,-17494.71"/>
</g>
<!-- a2a_s7 -->
<g id="node152" class="node">
<title>a2a_s7</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-17305.14" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-17316.44" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-17301.44" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-17286.44" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route7&#45;&gt;a2a_s7 -->
<g id="edge148" class="edge">
<title>route7&#45;&gt;a2a_s7</title>
<path fill="none" stroke="black" d="M1119,-17378.55C1119,-17370.12 1119,-17361.43 1119,-17353.13"/>
<polygon fill="black" stroke="black" points="1122.5,-17352.87 1119,-17342.87 1115.5,-17352.87 1122.5,-17352.87"/>
</g>
<!-- exp7 -->
<g id="node153" class="node">
<title>exp7</title>
<path fill="none" stroke="black" d="M1233.5,-17231.67C1233.5,-17231.67 1004.5,-17231.67 1004.5,-17231.67 998.5,-17231.67 992.5,-17225.67 992.5,-17219.67 992.5,-17219.67 992.5,-17190.67 992.5,-17190.67 992.5,-17184.67 998.5,-17178.67 1004.5,-17178.67 1004.5,-17178.67 1233.5,-17178.67 1233.5,-17178.67 1239.5,-17178.67 1245.5,-17184.67 1245.5,-17190.67 1245.5,-17190.67 1245.5,-17219.67 1245.5,-17219.67 1245.5,-17225.67 1239.5,-17231.67 1233.5,-17231.67"/>
<text text-anchor="start" x="1000.5" y="-17216.47" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-17201.47" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-17186.47" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s7&#45;&gt;exp7 -->
<g id="edge149" class="edge">
<title>a2a_s7&#45;&gt;exp7</title>
<path fill="none" stroke="black" d="M1119,-17267.66C1119,-17259.24 1119,-17250.3 1119,-17241.92"/>
<polygon fill="black" stroke="black" points="1122.5,-17241.68 1119,-17231.68 1115.5,-17241.68 1122.5,-17241.68"/>
</g>
<!-- exp_ar7 -->
<g id="node154" class="node">
<title>exp_ar7</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-17105.19" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-17116.49" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-17101.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-17086.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp7&#45;&gt;exp_ar7 -->
<g id="edge150" class="edge">
<title>exp7&#45;&gt;exp_ar7</title>
<path fill="none" stroke="black" d="M1119,-17178.42C1119,-17170.6 1119,-17161.75 1119,-17152.99"/>
<polygon fill="black" stroke="black" points="1122.5,-17152.81 1119,-17142.81 1115.5,-17152.81 1122.5,-17152.81"/>
</g>
<!-- a2a_r7 -->
<g id="node155" class="node">
<title>a2a_r7</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-16994.24" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-17005.54" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-16990.54" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-16975.54" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar7&#45;&gt;a2a_r7 -->
<g id="edge151" class="edge">
<title>exp_ar7&#45;&gt;a2a_r7</title>
<path fill="none" stroke="black" d="M1119,-17067.61C1119,-17059.43 1119,-17050.65 1119,-17042.13"/>
<polygon fill="black" stroke="black" points="1122.5,-17041.91 1119,-17031.91 1115.5,-17041.91 1122.5,-17041.91"/>
</g>
<!-- agg7 -->
<g id="node156" class="node">
<title>agg7</title>
<path fill="none" stroke="black" d="M1308.26,-16920.76C1308.26,-16920.76 1012.1,-16920.76 1012.1,-16920.76 1006.1,-16920.76 996.42,-16916.02 992.74,-16911.28 992.74,-16911.28 925.1,-16824.24 925.1,-16824.24 921.42,-16819.5 923.74,-16814.76 929.74,-16814.76 929.74,-16814.76 1225.9,-16814.76 1225.9,-16814.76 1231.9,-16814.76 1241.58,-16819.5 1245.26,-16824.24 1245.26,-16824.24 1312.9,-16911.28 1312.9,-16911.28 1316.58,-16916.02 1314.26,-16920.76 1308.26,-16920.76"/>
<text text-anchor="start" x="958.99" y="-16879.06" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-16864.06" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-16849.06" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r7&#45;&gt;agg7 -->
<g id="edge152" class="edge">
<title>a2a_r7&#45;&gt;agg7</title>
<path fill="none" stroke="black" d="M1119,-16956.56C1119,-16948.52 1119,-16939.79 1119,-16931.06"/>
<polygon fill="black" stroke="black" points="1122.5,-16930.85 1119,-16920.85 1115.5,-16930.85 1122.5,-16930.85"/>
</g>
<!-- norm_m7 -->
<g id="node157" class="node">
<title>norm_m7</title>
<path fill="none" stroke="black" d="M1199,-16778.76C1199,-16778.76 1039,-16778.76 1039,-16778.76 1033,-16778.76 1027,-16772.76 1027,-16766.76 1027,-16766.76 1027,-16737.76 1027,-16737.76 1027,-16731.76 1033,-16725.76 1039,-16725.76 1039,-16725.76 1199,-16725.76 1199,-16725.76 1205,-16725.76 1211,-16731.76 1211,-16737.76 1211,-16737.76 1211,-16766.76 1211,-16766.76 1211,-16772.76 1205,-16778.76 1199,-16778.76"/>
<text text-anchor="start" x="1035" y="-16763.56" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-16748.56" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-16733.56" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg7&#45;&gt;norm_m7 -->
<g id="edge153" class="edge">
<title>agg7&#45;&gt;norm_m7</title>
<path fill="none" stroke="black" d="M1119,-16814.66C1119,-16805.99 1119,-16797.17 1119,-16789.03"/>
<polygon fill="black" stroke="black" points="1122.5,-16788.77 1119,-16778.77 1115.5,-16788.77 1122.5,-16788.77"/>
</g>
<!-- split2 -->
<g id="node158" class="node">
<title>split2</title>
<path fill="none" stroke="black" d="M1340.04,-16678.76C1340.04,-16678.76 993.33,-16678.76 993.33,-16678.76 987.33,-16678.76 977.31,-16674.3 973.3,-16669.84 973.3,-16669.84 893.99,-16581.68 893.99,-16581.68 889.97,-16577.22 891.96,-16572.76 897.96,-16572.76 897.96,-16572.76 1244.67,-16572.76 1244.67,-16572.76 1250.67,-16572.76 1260.69,-16577.22 1264.7,-16581.68 1264.7,-16581.68 1344.01,-16669.84 1344.01,-16669.84 1348.03,-16674.3 1346.04,-16678.76 1340.04,-16678.76"/>
<text text-anchor="start" x="932.14" y="-16637.06" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="932.14" y="-16622.06" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="932.14" y="-16607.06" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- norm_m7&#45;&gt;split2 -->
<g id="edge307" class="edge">
<title>norm_m7&#45;&gt;split2</title>
<path fill="none" stroke="black" d="M1119,-16725.46C1119,-16714.84 1119,-16702.03 1119,-16689.21"/>
<polygon fill="black" stroke="black" points="1122.5,-16688.97 1119,-16678.97 1115.5,-16688.97 1122.5,-16688.97"/>
</g>
<!-- qkv_c8 -->
<g id="node159" class="node">
<title>qkv_c8</title>
<path fill="none" stroke="black" d="M1241,-16536.76C1241,-16536.76 997,-16536.76 997,-16536.76 991,-16536.76 985,-16530.76 985,-16524.76 985,-16524.76 985,-16495.76 985,-16495.76 985,-16489.76 991,-16483.76 997,-16483.76 997,-16483.76 1241,-16483.76 1241,-16483.76 1247,-16483.76 1253,-16489.76 1253,-16495.76 1253,-16495.76 1253,-16524.76 1253,-16524.76 1253,-16530.76 1247,-16536.76 1241,-16536.76"/>
<text text-anchor="start" x="993" y="-16521.56" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-16506.56" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-16491.56" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- split2&#45;&gt;qkv_c8 -->
<g id="edge154" class="edge">
<title>split2&#45;&gt;qkv_c8</title>
<path fill="none" stroke="black" d="M1119,-16572.66C1119,-16563.99 1119,-16555.17 1119,-16547.03"/>
<polygon fill="black" stroke="black" points="1122.5,-16546.77 1119,-16536.77 1115.5,-16546.77 1122.5,-16546.77"/>
</g>
<!-- qkv_ar8 -->
<g id="node160" class="node">
<title>qkv_ar8</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-16410.28" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-16421.58" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-16406.58" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-16391.58" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c8&#45;&gt;qkv_ar8 -->
<g id="edge155" class="edge">
<title>qkv_c8&#45;&gt;qkv_ar8</title>
<path fill="none" stroke="black" d="M1119,-16483.52C1119,-16475.69 1119,-16466.84 1119,-16458.08"/>
<polygon fill="black" stroke="black" points="1122.5,-16457.9 1119,-16447.9 1115.5,-16457.9 1122.5,-16457.9"/>
</g>
<!-- sph8 -->
<g id="node161" class="node">
<title>sph8</title>
<path fill="none" stroke="black" d="M1327.66,-16336.81C1327.66,-16336.81 1000.64,-16336.81 1000.64,-16336.81 994.64,-16336.81 984.75,-16332.24 980.86,-16327.67 980.86,-16327.67 906.12,-16239.94 906.12,-16239.94 902.23,-16235.37 904.34,-16230.81 910.34,-16230.81 910.34,-16230.81 1237.36,-16230.81 1237.36,-16230.81 1243.36,-16230.81 1253.25,-16235.37 1257.14,-16239.94 1257.14,-16239.94 1331.88,-16327.67 1331.88,-16327.67 1335.77,-16332.24 1333.66,-16336.81 1327.66,-16336.81"/>
<text text-anchor="start" x="942.54" y="-16295.11" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-16280.11" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-16265.11" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar8&#45;&gt;sph8 -->
<g id="edge156" class="edge">
<title>qkv_ar8&#45;&gt;sph8</title>
<path fill="none" stroke="black" d="M1119,-16372.61C1119,-16364.57 1119,-16355.84 1119,-16347.11"/>
<polygon fill="black" stroke="black" points="1122.5,-16346.9 1119,-16336.9 1115.5,-16346.9 1122.5,-16346.9"/>
</g>
<!-- sdp8 -->
<g id="node162" class="node">
<title>sdp8</title>
<path fill="none" stroke="black" d="M1220,-16194.81C1220,-16194.81 1018,-16194.81 1018,-16194.81 1012,-16194.81 1006,-16188.81 1006,-16182.81 1006,-16182.81 1006,-16153.81 1006,-16153.81 1006,-16147.81 1012,-16141.81 1018,-16141.81 1018,-16141.81 1220,-16141.81 1220,-16141.81 1226,-16141.81 1232,-16147.81 1232,-16153.81 1232,-16153.81 1232,-16182.81 1232,-16182.81 1232,-16188.81 1226,-16194.81 1220,-16194.81"/>
<text text-anchor="start" x="1014" y="-16179.61" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-16164.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-16149.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph8&#45;&gt;sdp8 -->
<g id="edge157" class="edge">
<title>sph8&#45;&gt;sdp8</title>
<path fill="none" stroke="black" d="M1119,-16230.71C1119,-16222.04 1119,-16213.22 1119,-16205.07"/>
<polygon fill="black" stroke="black" points="1122.5,-16204.82 1119,-16194.82 1115.5,-16204.82 1122.5,-16204.82"/>
</g>
<!-- sm8 -->
<g id="node163" class="node">
<title>sm8</title>
<path fill="none" stroke="black" d="M1182.5,-16105.81C1182.5,-16105.81 1055.5,-16105.81 1055.5,-16105.81 1049.5,-16105.81 1043.5,-16099.81 1043.5,-16093.81 1043.5,-16093.81 1043.5,-16064.81 1043.5,-16064.81 1043.5,-16058.81 1049.5,-16052.81 1055.5,-16052.81 1055.5,-16052.81 1182.5,-16052.81 1182.5,-16052.81 1188.5,-16052.81 1194.5,-16058.81 1194.5,-16064.81 1194.5,-16064.81 1194.5,-16093.81 1194.5,-16093.81 1194.5,-16099.81 1188.5,-16105.81 1182.5,-16105.81"/>
<text text-anchor="start" x="1051.5" y="-16090.61" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-16075.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-16060.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp8&#45;&gt;sm8 -->
<g id="edge158" class="edge">
<title>sdp8&#45;&gt;sm8</title>
<path fill="none" stroke="black" d="M1119,-16141.67C1119,-16133.69 1119,-16124.74 1119,-16116.19"/>
<polygon fill="black" stroke="black" points="1122.5,-16116.06 1119,-16106.06 1115.5,-16116.06 1122.5,-16116.06"/>
</g>
<!-- do8 -->
<g id="node164" class="node">
<title>do8</title>
<path fill="none" stroke="black" d="M1166.5,-16016.81C1166.5,-16016.81 1071.5,-16016.81 1071.5,-16016.81 1065.5,-16016.81 1059.5,-16010.81 1059.5,-16004.81 1059.5,-16004.81 1059.5,-15975.81 1059.5,-15975.81 1059.5,-15969.81 1065.5,-15963.81 1071.5,-15963.81 1071.5,-15963.81 1166.5,-15963.81 1166.5,-15963.81 1172.5,-15963.81 1178.5,-15969.81 1178.5,-15975.81 1178.5,-15975.81 1178.5,-16004.81 1178.5,-16004.81 1178.5,-16010.81 1172.5,-16016.81 1166.5,-16016.81"/>
<text text-anchor="start" x="1067.5" y="-16001.61" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-15986.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-15971.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm8&#45;&gt;do8 -->
<g id="edge159" class="edge">
<title>sm8&#45;&gt;do8</title>
<path fill="none" stroke="black" d="M1119,-16052.67C1119,-16044.69 1119,-16035.74 1119,-16027.19"/>
<polygon fill="black" stroke="black" points="1122.5,-16027.06 1119,-16017.06 1115.5,-16027.06 1122.5,-16027.06"/>
</g>
<!-- mgh8 -->
<g id="node165" class="node">
<title>mgh8</title>
<path fill="none" stroke="black" d="M1323.86,-15927.81C1323.86,-15927.81 1002.88,-15927.81 1002.88,-15927.81 996.88,-15927.81 987.03,-15923.21 983.18,-15918.6 983.18,-15918.6 909.84,-15831.01 909.84,-15831.01 905.99,-15826.41 908.14,-15821.81 914.14,-15821.81 914.14,-15821.81 1235.12,-15821.81 1235.12,-15821.81 1241.12,-15821.81 1250.97,-15826.41 1254.82,-15831.01 1254.82,-15831.01 1328.16,-15918.6 1328.16,-15918.6 1332.01,-15923.21 1329.86,-15927.81 1323.86,-15927.81"/>
<text text-anchor="start" x="946" y="-15886.11" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-15871.11" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-15856.11" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do8&#45;&gt;mgh8 -->
<g id="edge160" class="edge">
<title>do8&#45;&gt;mgh8</title>
<path fill="none" stroke="black" d="M1119,-15963.55C1119,-15955.85 1119,-15947.06 1119,-15938.07"/>
<polygon fill="black" stroke="black" points="1122.5,-15937.9 1119,-15927.9 1115.5,-15937.9 1122.5,-15937.9"/>
</g>
<!-- proj_r8 -->
<g id="node166" class="node">
<title>proj_r8</title>
<path fill="none" stroke="black" d="M1219,-15785.81C1219,-15785.81 1019,-15785.81 1019,-15785.81 1013,-15785.81 1007,-15779.81 1007,-15773.81 1007,-15773.81 1007,-15744.81 1007,-15744.81 1007,-15738.81 1013,-15732.81 1019,-15732.81 1019,-15732.81 1219,-15732.81 1219,-15732.81 1225,-15732.81 1231,-15738.81 1231,-15744.81 1231,-15744.81 1231,-15773.81 1231,-15773.81 1231,-15779.81 1225,-15785.81 1219,-15785.81"/>
<text text-anchor="start" x="1015" y="-15770.61" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-15755.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-15740.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh8&#45;&gt;proj_r8 -->
<g id="edge161" class="edge">
<title>mgh8&#45;&gt;proj_r8</title>
<path fill="none" stroke="black" d="M1119,-15821.71C1119,-15813.04 1119,-15804.22 1119,-15796.07"/>
<polygon fill="black" stroke="black" points="1122.5,-15795.82 1119,-15785.82 1115.5,-15795.82 1122.5,-15795.82"/>
</g>
<!-- proj_ar8 -->
<g id="node167" class="node">
<title>proj_ar8</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-15659.33" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-15670.63" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-15655.63" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-15640.63" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r8&#45;&gt;proj_ar8 -->
<g id="edge162" class="edge">
<title>proj_r8&#45;&gt;proj_ar8</title>
<path fill="none" stroke="black" d="M1119,-15732.56C1119,-15724.74 1119,-15715.89 1119,-15707.13"/>
<polygon fill="black" stroke="black" points="1122.5,-15706.95 1119,-15696.95 1115.5,-15706.95 1122.5,-15706.95"/>
</g>
<!-- norm8 -->
<g id="node168" class="node">
<title>norm8</title>
<path fill="none" stroke="black" d="M1204,-15585.85C1204,-15585.85 1034,-15585.85 1034,-15585.85 1028,-15585.85 1022,-15579.85 1022,-15573.85 1022,-15573.85 1022,-15544.85 1022,-15544.85 1022,-15538.85 1028,-15532.85 1034,-15532.85 1034,-15532.85 1204,-15532.85 1204,-15532.85 1210,-15532.85 1216,-15538.85 1216,-15544.85 1216,-15544.85 1216,-15573.85 1216,-15573.85 1216,-15579.85 1210,-15585.85 1204,-15585.85"/>
<text text-anchor="start" x="1030" y="-15570.65" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-15555.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-15540.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar8&#45;&gt;norm8 -->
<g id="edge163" class="edge">
<title>proj_ar8&#45;&gt;norm8</title>
<path fill="none" stroke="black" d="M1119,-15621.85C1119,-15613.43 1119,-15604.49 1119,-15596.1"/>
<polygon fill="black" stroke="black" points="1122.5,-15595.86 1119,-15585.86 1115.5,-15595.86 1122.5,-15595.86"/>
</g>
<!-- gate_c8 -->
<g id="node169" class="node">
<title>gate_c8</title>
<path fill="none" stroke="black" d="M1218.5,-15496.85C1218.5,-15496.85 1019.5,-15496.85 1019.5,-15496.85 1013.5,-15496.85 1007.5,-15490.85 1007.5,-15484.85 1007.5,-15484.85 1007.5,-15455.85 1007.5,-15455.85 1007.5,-15449.85 1013.5,-15443.85 1019.5,-15443.85 1019.5,-15443.85 1218.5,-15443.85 1218.5,-15443.85 1224.5,-15443.85 1230.5,-15449.85 1230.5,-15455.85 1230.5,-15455.85 1230.5,-15484.85 1230.5,-15484.85 1230.5,-15490.85 1224.5,-15496.85 1218.5,-15496.85"/>
<text text-anchor="start" x="1015.5" y="-15481.65" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-15466.65" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-15451.65" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm8&#45;&gt;gate_c8 -->
<g id="edge164" class="edge">
<title>norm8&#45;&gt;gate_c8</title>
<path fill="none" stroke="black" d="M1119,-15532.72C1119,-15524.74 1119,-15515.78 1119,-15507.24"/>
<polygon fill="black" stroke="black" points="1122.5,-15507.1 1119,-15497.1 1115.5,-15507.1 1122.5,-15507.1"/>
</g>
<!-- gate_ar8 -->
<g id="node170" class="node">
<title>gate_ar8</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-15370.38" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-15381.68" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-15366.68" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-15351.68" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c8&#45;&gt;gate_ar8 -->
<g id="edge165" class="edge">
<title>gate_c8&#45;&gt;gate_ar8</title>
<path fill="none" stroke="black" d="M1119,-15443.61C1119,-15435.79 1119,-15426.93 1119,-15418.17"/>
<polygon fill="black" stroke="black" points="1122.5,-15418 1119,-15408 1115.5,-15418 1122.5,-15418"/>
</g>
<!-- route8 -->
<g id="node171" class="node">
<title>route8</title>
<path fill="none" stroke="black" d="M1310.41,-15296.9C1310.41,-15296.9 1010.83,-15296.9 1010.83,-15296.9 1004.83,-15296.9 995.13,-15292.18 991.42,-15287.46 991.42,-15287.46 923,-15200.34 923,-15200.34 919.3,-15195.62 921.59,-15190.9 927.59,-15190.9 927.59,-15190.9 1227.17,-15190.9 1227.17,-15190.9 1233.17,-15190.9 1242.87,-15195.62 1246.58,-15200.34 1246.58,-15200.34 1315,-15287.46 1315,-15287.46 1318.7,-15292.18 1316.41,-15296.9 1310.41,-15296.9"/>
<text text-anchor="start" x="957.26" y="-15255.2" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-15240.2" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-15225.2" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar8&#45;&gt;route8 -->
<g id="edge166" class="edge">
<title>gate_ar8&#45;&gt;route8</title>
<path fill="none" stroke="black" d="M1119,-15332.7C1119,-15324.66 1119,-15315.93 1119,-15307.2"/>
<polygon fill="black" stroke="black" points="1122.5,-15306.99 1119,-15296.99 1115.5,-15306.99 1122.5,-15306.99"/>
</g>
<!-- a2a_s8 -->
<g id="node172" class="node">
<title>a2a_s8</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-15117.42" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-15128.72" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-15113.72" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-15098.72" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route8&#45;&gt;a2a_s8 -->
<g id="edge167" class="edge">
<title>route8&#45;&gt;a2a_s8</title>
<path fill="none" stroke="black" d="M1119,-15190.83C1119,-15182.4 1119,-15173.71 1119,-15165.41"/>
<polygon fill="black" stroke="black" points="1122.5,-15165.15 1119,-15155.15 1115.5,-15165.15 1122.5,-15165.15"/>
</g>
<!-- exp8 -->
<g id="node173" class="node">
<title>exp8</title>
<path fill="none" stroke="black" d="M1233.5,-15043.95C1233.5,-15043.95 1004.5,-15043.95 1004.5,-15043.95 998.5,-15043.95 992.5,-15037.95 992.5,-15031.95 992.5,-15031.95 992.5,-15002.95 992.5,-15002.95 992.5,-14996.95 998.5,-14990.95 1004.5,-14990.95 1004.5,-14990.95 1233.5,-14990.95 1233.5,-14990.95 1239.5,-14990.95 1245.5,-14996.95 1245.5,-15002.95 1245.5,-15002.95 1245.5,-15031.95 1245.5,-15031.95 1245.5,-15037.95 1239.5,-15043.95 1233.5,-15043.95"/>
<text text-anchor="start" x="1000.5" y="-15028.75" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-15013.75" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-14998.75" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s8&#45;&gt;exp8 -->
<g id="edge168" class="edge">
<title>a2a_s8&#45;&gt;exp8</title>
<path fill="none" stroke="black" d="M1119,-15079.94C1119,-15071.52 1119,-15062.58 1119,-15054.2"/>
<polygon fill="black" stroke="black" points="1122.5,-15053.96 1119,-15043.96 1115.5,-15053.96 1122.5,-15053.96"/>
</g>
<!-- exp_ar8 -->
<g id="node174" class="node">
<title>exp_ar8</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-14917.47" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-14928.77" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-14913.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-14898.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp8&#45;&gt;exp_ar8 -->
<g id="edge169" class="edge">
<title>exp8&#45;&gt;exp_ar8</title>
<path fill="none" stroke="black" d="M1119,-14990.7C1119,-14982.88 1119,-14974.03 1119,-14965.27"/>
<polygon fill="black" stroke="black" points="1122.5,-14965.09 1119,-14955.09 1115.5,-14965.09 1122.5,-14965.09"/>
</g>
<!-- a2a_r8 -->
<g id="node175" class="node">
<title>a2a_r8</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-14806.52" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-14817.82" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-14802.82" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-14787.82" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar8&#45;&gt;a2a_r8 -->
<g id="edge170" class="edge">
<title>exp_ar8&#45;&gt;a2a_r8</title>
<path fill="none" stroke="black" d="M1119,-14879.89C1119,-14871.71 1119,-14862.93 1119,-14854.41"/>
<polygon fill="black" stroke="black" points="1122.5,-14854.19 1119,-14844.19 1115.5,-14854.19 1122.5,-14854.19"/>
</g>
<!-- agg8 -->
<g id="node176" class="node">
<title>agg8</title>
<path fill="none" stroke="black" d="M1308.26,-14733.04C1308.26,-14733.04 1012.1,-14733.04 1012.1,-14733.04 1006.1,-14733.04 996.42,-14728.3 992.74,-14723.56 992.74,-14723.56 925.1,-14636.52 925.1,-14636.52 921.42,-14631.78 923.74,-14627.04 929.74,-14627.04 929.74,-14627.04 1225.9,-14627.04 1225.9,-14627.04 1231.9,-14627.04 1241.58,-14631.78 1245.26,-14636.52 1245.26,-14636.52 1312.9,-14723.56 1312.9,-14723.56 1316.58,-14728.3 1314.26,-14733.04 1308.26,-14733.04"/>
<text text-anchor="start" x="958.99" y="-14691.34" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-14676.34" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-14661.34" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r8&#45;&gt;agg8 -->
<g id="edge171" class="edge">
<title>a2a_r8&#45;&gt;agg8</title>
<path fill="none" stroke="black" d="M1119,-14768.84C1119,-14760.8 1119,-14752.07 1119,-14743.34"/>
<polygon fill="black" stroke="black" points="1122.5,-14743.13 1119,-14733.13 1115.5,-14743.13 1122.5,-14743.13"/>
</g>
<!-- norm_m8 -->
<g id="node177" class="node">
<title>norm_m8</title>
<path fill="none" stroke="black" d="M1199,-14591.04C1199,-14591.04 1039,-14591.04 1039,-14591.04 1033,-14591.04 1027,-14585.04 1027,-14579.04 1027,-14579.04 1027,-14550.04 1027,-14550.04 1027,-14544.04 1033,-14538.04 1039,-14538.04 1039,-14538.04 1199,-14538.04 1199,-14538.04 1205,-14538.04 1211,-14544.04 1211,-14550.04 1211,-14550.04 1211,-14579.04 1211,-14579.04 1211,-14585.04 1205,-14591.04 1199,-14591.04"/>
<text text-anchor="start" x="1035" y="-14575.84" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-14560.84" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-14545.84" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg8&#45;&gt;norm_m8 -->
<g id="edge172" class="edge">
<title>agg8&#45;&gt;norm_m8</title>
<path fill="none" stroke="black" d="M1119,-14626.94C1119,-14618.27 1119,-14609.45 1119,-14601.31"/>
<polygon fill="black" stroke="black" points="1122.5,-14601.05 1119,-14591.05 1115.5,-14601.05 1122.5,-14601.05"/>
</g>
<!-- qkv_c9 -->
<g id="node178" class="node">
<title>qkv_c9</title>
<path fill="none" stroke="black" d="M1241,-14502.04C1241,-14502.04 997,-14502.04 997,-14502.04 991,-14502.04 985,-14496.04 985,-14490.04 985,-14490.04 985,-14461.04 985,-14461.04 985,-14455.04 991,-14449.04 997,-14449.04 997,-14449.04 1241,-14449.04 1241,-14449.04 1247,-14449.04 1253,-14455.04 1253,-14461.04 1253,-14461.04 1253,-14490.04 1253,-14490.04 1253,-14496.04 1247,-14502.04 1241,-14502.04"/>
<text text-anchor="start" x="993" y="-14486.84" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-14471.84" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-14456.84" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m8&#45;&gt;qkv_c9 -->
<g id="edge173" class="edge">
<title>norm_m8&#45;&gt;qkv_c9</title>
<path fill="none" stroke="black" d="M1119,-14537.91C1119,-14529.93 1119,-14520.97 1119,-14512.42"/>
<polygon fill="black" stroke="black" points="1122.5,-14512.29 1119,-14502.29 1115.5,-14512.29 1122.5,-14512.29"/>
</g>
<!-- qkv_ar9 -->
<g id="node179" class="node">
<title>qkv_ar9</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-14375.56" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-14386.86" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-14371.86" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-14356.86" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c9&#45;&gt;qkv_ar9 -->
<g id="edge174" class="edge">
<title>qkv_c9&#45;&gt;qkv_ar9</title>
<path fill="none" stroke="black" d="M1119,-14448.8C1119,-14440.97 1119,-14432.12 1119,-14423.36"/>
<polygon fill="black" stroke="black" points="1122.5,-14423.18 1119,-14413.18 1115.5,-14423.18 1122.5,-14423.18"/>
</g>
<!-- sph9 -->
<g id="node180" class="node">
<title>sph9</title>
<path fill="none" stroke="black" d="M1327.66,-14302.09C1327.66,-14302.09 1000.64,-14302.09 1000.64,-14302.09 994.64,-14302.09 984.75,-14297.52 980.86,-14292.95 980.86,-14292.95 906.12,-14205.22 906.12,-14205.22 902.23,-14200.65 904.34,-14196.09 910.34,-14196.09 910.34,-14196.09 1237.36,-14196.09 1237.36,-14196.09 1243.36,-14196.09 1253.25,-14200.65 1257.14,-14205.22 1257.14,-14205.22 1331.88,-14292.95 1331.88,-14292.95 1335.77,-14297.52 1333.66,-14302.09 1327.66,-14302.09"/>
<text text-anchor="start" x="942.54" y="-14260.39" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-14245.39" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-14230.39" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar9&#45;&gt;sph9 -->
<g id="edge175" class="edge">
<title>qkv_ar9&#45;&gt;sph9</title>
<path fill="none" stroke="black" d="M1119,-14337.89C1119,-14329.85 1119,-14321.12 1119,-14312.39"/>
<polygon fill="black" stroke="black" points="1122.5,-14312.18 1119,-14302.18 1115.5,-14312.18 1122.5,-14312.18"/>
</g>
<!-- sdp9 -->
<g id="node181" class="node">
<title>sdp9</title>
<path fill="none" stroke="black" d="M1220,-14160.09C1220,-14160.09 1018,-14160.09 1018,-14160.09 1012,-14160.09 1006,-14154.09 1006,-14148.09 1006,-14148.09 1006,-14119.09 1006,-14119.09 1006,-14113.09 1012,-14107.09 1018,-14107.09 1018,-14107.09 1220,-14107.09 1220,-14107.09 1226,-14107.09 1232,-14113.09 1232,-14119.09 1232,-14119.09 1232,-14148.09 1232,-14148.09 1232,-14154.09 1226,-14160.09 1220,-14160.09"/>
<text text-anchor="start" x="1014" y="-14144.89" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-14129.89" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-14114.89" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph9&#45;&gt;sdp9 -->
<g id="edge176" class="edge">
<title>sph9&#45;&gt;sdp9</title>
<path fill="none" stroke="black" d="M1119,-14195.99C1119,-14187.32 1119,-14178.5 1119,-14170.35"/>
<polygon fill="black" stroke="black" points="1122.5,-14170.1 1119,-14160.1 1115.5,-14170.1 1122.5,-14170.1"/>
</g>
<!-- sm9 -->
<g id="node182" class="node">
<title>sm9</title>
<path fill="none" stroke="black" d="M1182.5,-14071.09C1182.5,-14071.09 1055.5,-14071.09 1055.5,-14071.09 1049.5,-14071.09 1043.5,-14065.09 1043.5,-14059.09 1043.5,-14059.09 1043.5,-14030.09 1043.5,-14030.09 1043.5,-14024.09 1049.5,-14018.09 1055.5,-14018.09 1055.5,-14018.09 1182.5,-14018.09 1182.5,-14018.09 1188.5,-14018.09 1194.5,-14024.09 1194.5,-14030.09 1194.5,-14030.09 1194.5,-14059.09 1194.5,-14059.09 1194.5,-14065.09 1188.5,-14071.09 1182.5,-14071.09"/>
<text text-anchor="start" x="1051.5" y="-14055.89" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-14040.89" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-14025.89" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp9&#45;&gt;sm9 -->
<g id="edge177" class="edge">
<title>sdp9&#45;&gt;sm9</title>
<path fill="none" stroke="black" d="M1119,-14106.95C1119,-14098.97 1119,-14090.02 1119,-14081.47"/>
<polygon fill="black" stroke="black" points="1122.5,-14081.34 1119,-14071.34 1115.5,-14081.34 1122.5,-14081.34"/>
</g>
<!-- do9 -->
<g id="node183" class="node">
<title>do9</title>
<path fill="none" stroke="black" d="M1166.5,-13982.09C1166.5,-13982.09 1071.5,-13982.09 1071.5,-13982.09 1065.5,-13982.09 1059.5,-13976.09 1059.5,-13970.09 1059.5,-13970.09 1059.5,-13941.09 1059.5,-13941.09 1059.5,-13935.09 1065.5,-13929.09 1071.5,-13929.09 1071.5,-13929.09 1166.5,-13929.09 1166.5,-13929.09 1172.5,-13929.09 1178.5,-13935.09 1178.5,-13941.09 1178.5,-13941.09 1178.5,-13970.09 1178.5,-13970.09 1178.5,-13976.09 1172.5,-13982.09 1166.5,-13982.09"/>
<text text-anchor="start" x="1067.5" y="-13966.89" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-13951.89" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-13936.89" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm9&#45;&gt;do9 -->
<g id="edge178" class="edge">
<title>sm9&#45;&gt;do9</title>
<path fill="none" stroke="black" d="M1119,-14017.95C1119,-14009.97 1119,-14001.02 1119,-13992.47"/>
<polygon fill="black" stroke="black" points="1122.5,-13992.34 1119,-13982.34 1115.5,-13992.34 1122.5,-13992.34"/>
</g>
<!-- mgh9 -->
<g id="node184" class="node">
<title>mgh9</title>
<path fill="none" stroke="black" d="M1323.86,-13893.09C1323.86,-13893.09 1002.88,-13893.09 1002.88,-13893.09 996.88,-13893.09 987.03,-13888.49 983.18,-13883.89 983.18,-13883.89 909.84,-13796.29 909.84,-13796.29 905.99,-13791.69 908.14,-13787.09 914.14,-13787.09 914.14,-13787.09 1235.12,-13787.09 1235.12,-13787.09 1241.12,-13787.09 1250.97,-13791.69 1254.82,-13796.29 1254.82,-13796.29 1328.16,-13883.89 1328.16,-13883.89 1332.01,-13888.49 1329.86,-13893.09 1323.86,-13893.09"/>
<text text-anchor="start" x="946" y="-13851.39" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-13836.39" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-13821.39" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do9&#45;&gt;mgh9 -->
<g id="edge179" class="edge">
<title>do9&#45;&gt;mgh9</title>
<path fill="none" stroke="black" d="M1119,-13928.83C1119,-13921.13 1119,-13912.34 1119,-13903.35"/>
<polygon fill="black" stroke="black" points="1122.5,-13903.18 1119,-13893.18 1115.5,-13903.18 1122.5,-13903.18"/>
</g>
<!-- proj_r9 -->
<g id="node185" class="node">
<title>proj_r9</title>
<path fill="none" stroke="black" d="M1219,-13751.09C1219,-13751.09 1019,-13751.09 1019,-13751.09 1013,-13751.09 1007,-13745.09 1007,-13739.09 1007,-13739.09 1007,-13710.09 1007,-13710.09 1007,-13704.09 1013,-13698.09 1019,-13698.09 1019,-13698.09 1219,-13698.09 1219,-13698.09 1225,-13698.09 1231,-13704.09 1231,-13710.09 1231,-13710.09 1231,-13739.09 1231,-13739.09 1231,-13745.09 1225,-13751.09 1219,-13751.09"/>
<text text-anchor="start" x="1015" y="-13735.89" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-13720.89" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-13705.89" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh9&#45;&gt;proj_r9 -->
<g id="edge180" class="edge">
<title>mgh9&#45;&gt;proj_r9</title>
<path fill="none" stroke="black" d="M1119,-13786.99C1119,-13778.32 1119,-13769.5 1119,-13761.35"/>
<polygon fill="black" stroke="black" points="1122.5,-13761.1 1119,-13751.1 1115.5,-13761.1 1122.5,-13761.1"/>
</g>
<!-- proj_ar9 -->
<g id="node186" class="node">
<title>proj_ar9</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-13624.61" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-13635.91" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-13620.91" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-13605.91" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r9&#45;&gt;proj_ar9 -->
<g id="edge181" class="edge">
<title>proj_r9&#45;&gt;proj_ar9</title>
<path fill="none" stroke="black" d="M1119,-13697.84C1119,-13690.02 1119,-13681.17 1119,-13672.41"/>
<polygon fill="black" stroke="black" points="1122.5,-13672.23 1119,-13662.23 1115.5,-13672.23 1122.5,-13672.23"/>
</g>
<!-- norm9 -->
<g id="node187" class="node">
<title>norm9</title>
<path fill="none" stroke="black" d="M1204,-13551.13C1204,-13551.13 1034,-13551.13 1034,-13551.13 1028,-13551.13 1022,-13545.13 1022,-13539.13 1022,-13539.13 1022,-13510.13 1022,-13510.13 1022,-13504.13 1028,-13498.13 1034,-13498.13 1034,-13498.13 1204,-13498.13 1204,-13498.13 1210,-13498.13 1216,-13504.13 1216,-13510.13 1216,-13510.13 1216,-13539.13 1216,-13539.13 1216,-13545.13 1210,-13551.13 1204,-13551.13"/>
<text text-anchor="start" x="1030" y="-13535.93" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-13520.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-13505.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar9&#45;&gt;norm9 -->
<g id="edge182" class="edge">
<title>proj_ar9&#45;&gt;norm9</title>
<path fill="none" stroke="black" d="M1119,-13587.13C1119,-13578.71 1119,-13569.77 1119,-13561.38"/>
<polygon fill="black" stroke="black" points="1122.5,-13561.14 1119,-13551.14 1115.5,-13561.14 1122.5,-13561.14"/>
</g>
<!-- gate_c9 -->
<g id="node188" class="node">
<title>gate_c9</title>
<path fill="none" stroke="black" d="M1218.5,-13462.13C1218.5,-13462.13 1019.5,-13462.13 1019.5,-13462.13 1013.5,-13462.13 1007.5,-13456.13 1007.5,-13450.13 1007.5,-13450.13 1007.5,-13421.13 1007.5,-13421.13 1007.5,-13415.13 1013.5,-13409.13 1019.5,-13409.13 1019.5,-13409.13 1218.5,-13409.13 1218.5,-13409.13 1224.5,-13409.13 1230.5,-13415.13 1230.5,-13421.13 1230.5,-13421.13 1230.5,-13450.13 1230.5,-13450.13 1230.5,-13456.13 1224.5,-13462.13 1218.5,-13462.13"/>
<text text-anchor="start" x="1015.5" y="-13446.93" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-13431.93" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-13416.93" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm9&#45;&gt;gate_c9 -->
<g id="edge183" class="edge">
<title>norm9&#45;&gt;gate_c9</title>
<path fill="none" stroke="black" d="M1119,-13498C1119,-13490.02 1119,-13481.06 1119,-13472.52"/>
<polygon fill="black" stroke="black" points="1122.5,-13472.38 1119,-13462.38 1115.5,-13472.38 1122.5,-13472.38"/>
</g>
<!-- gate_ar9 -->
<g id="node189" class="node">
<title>gate_ar9</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-13335.66" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-13346.96" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-13331.96" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-13316.96" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c9&#45;&gt;gate_ar9 -->
<g id="edge184" class="edge">
<title>gate_c9&#45;&gt;gate_ar9</title>
<path fill="none" stroke="black" d="M1119,-13408.89C1119,-13401.07 1119,-13392.21 1119,-13383.45"/>
<polygon fill="black" stroke="black" points="1122.5,-13383.28 1119,-13373.28 1115.5,-13383.28 1122.5,-13383.28"/>
</g>
<!-- route9 -->
<g id="node190" class="node">
<title>route9</title>
<path fill="none" stroke="black" d="M1310.41,-13262.18C1310.41,-13262.18 1010.83,-13262.18 1010.83,-13262.18 1004.83,-13262.18 995.13,-13257.46 991.42,-13252.74 991.42,-13252.74 923,-13165.62 923,-13165.62 919.3,-13160.9 921.59,-13156.18 927.59,-13156.18 927.59,-13156.18 1227.17,-13156.18 1227.17,-13156.18 1233.17,-13156.18 1242.87,-13160.9 1246.58,-13165.62 1246.58,-13165.62 1315,-13252.74 1315,-13252.74 1318.7,-13257.46 1316.41,-13262.18 1310.41,-13262.18"/>
<text text-anchor="start" x="957.26" y="-13220.48" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-13205.48" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-13190.48" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar9&#45;&gt;route9 -->
<g id="edge185" class="edge">
<title>gate_ar9&#45;&gt;route9</title>
<path fill="none" stroke="black" d="M1119,-13297.98C1119,-13289.94 1119,-13281.21 1119,-13272.48"/>
<polygon fill="black" stroke="black" points="1122.5,-13272.27 1119,-13262.27 1115.5,-13272.27 1122.5,-13272.27"/>
</g>
<!-- a2a_s9 -->
<g id="node191" class="node">
<title>a2a_s9</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-13082.7" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-13094" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-13079" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-13064" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route9&#45;&gt;a2a_s9 -->
<g id="edge186" class="edge">
<title>route9&#45;&gt;a2a_s9</title>
<path fill="none" stroke="black" d="M1119,-13156.11C1119,-13147.68 1119,-13138.99 1119,-13130.69"/>
<polygon fill="black" stroke="black" points="1122.5,-13130.43 1119,-13120.43 1115.5,-13130.43 1122.5,-13130.43"/>
</g>
<!-- exp9 -->
<g id="node192" class="node">
<title>exp9</title>
<path fill="none" stroke="black" d="M1233.5,-13009.23C1233.5,-13009.23 1004.5,-13009.23 1004.5,-13009.23 998.5,-13009.23 992.5,-13003.23 992.5,-12997.23 992.5,-12997.23 992.5,-12968.23 992.5,-12968.23 992.5,-12962.23 998.5,-12956.23 1004.5,-12956.23 1004.5,-12956.23 1233.5,-12956.23 1233.5,-12956.23 1239.5,-12956.23 1245.5,-12962.23 1245.5,-12968.23 1245.5,-12968.23 1245.5,-12997.23 1245.5,-12997.23 1245.5,-13003.23 1239.5,-13009.23 1233.5,-13009.23"/>
<text text-anchor="start" x="1000.5" y="-12994.03" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-12979.03" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-12964.03" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s9&#45;&gt;exp9 -->
<g id="edge187" class="edge">
<title>a2a_s9&#45;&gt;exp9</title>
<path fill="none" stroke="black" d="M1119,-13045.22C1119,-13036.8 1119,-13027.86 1119,-13019.48"/>
<polygon fill="black" stroke="black" points="1122.5,-13019.24 1119,-13009.24 1115.5,-13019.24 1122.5,-13019.24"/>
</g>
<!-- exp_ar9 -->
<g id="node193" class="node">
<title>exp_ar9</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-12882.75" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-12894.05" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-12879.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-12864.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp9&#45;&gt;exp_ar9 -->
<g id="edge188" class="edge">
<title>exp9&#45;&gt;exp_ar9</title>
<path fill="none" stroke="black" d="M1119,-12955.98C1119,-12948.16 1119,-12939.31 1119,-12930.55"/>
<polygon fill="black" stroke="black" points="1122.5,-12930.37 1119,-12920.37 1115.5,-12930.37 1122.5,-12930.37"/>
</g>
<!-- a2a_r9 -->
<g id="node194" class="node">
<title>a2a_r9</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-12771.8" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-12783.1" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-12768.1" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-12753.1" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar9&#45;&gt;a2a_r9 -->
<g id="edge189" class="edge">
<title>exp_ar9&#45;&gt;a2a_r9</title>
<path fill="none" stroke="black" d="M1119,-12845.17C1119,-12836.99 1119,-12828.21 1119,-12819.69"/>
<polygon fill="black" stroke="black" points="1122.5,-12819.47 1119,-12809.47 1115.5,-12819.47 1122.5,-12819.47"/>
</g>
<!-- agg9 -->
<g id="node195" class="node">
<title>agg9</title>
<path fill="none" stroke="black" d="M1308.26,-12698.32C1308.26,-12698.32 1012.1,-12698.32 1012.1,-12698.32 1006.1,-12698.32 996.42,-12693.58 992.74,-12688.84 992.74,-12688.84 925.1,-12601.8 925.1,-12601.8 921.42,-12597.06 923.74,-12592.32 929.74,-12592.32 929.74,-12592.32 1225.9,-12592.32 1225.9,-12592.32 1231.9,-12592.32 1241.58,-12597.06 1245.26,-12601.8 1245.26,-12601.8 1312.9,-12688.84 1312.9,-12688.84 1316.58,-12693.58 1314.26,-12698.32 1308.26,-12698.32"/>
<text text-anchor="start" x="958.99" y="-12656.62" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-12641.62" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-12626.62" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r9&#45;&gt;agg9 -->
<g id="edge190" class="edge">
<title>a2a_r9&#45;&gt;agg9</title>
<path fill="none" stroke="black" d="M1119,-12734.12C1119,-12726.08 1119,-12717.35 1119,-12708.62"/>
<polygon fill="black" stroke="black" points="1122.5,-12708.41 1119,-12698.41 1115.5,-12708.41 1122.5,-12708.41"/>
</g>
<!-- norm_m9 -->
<g id="node196" class="node">
<title>norm_m9</title>
<path fill="none" stroke="black" d="M1199,-12556.32C1199,-12556.32 1039,-12556.32 1039,-12556.32 1033,-12556.32 1027,-12550.32 1027,-12544.32 1027,-12544.32 1027,-12515.32 1027,-12515.32 1027,-12509.32 1033,-12503.32 1039,-12503.32 1039,-12503.32 1199,-12503.32 1199,-12503.32 1205,-12503.32 1211,-12509.32 1211,-12515.32 1211,-12515.32 1211,-12544.32 1211,-12544.32 1211,-12550.32 1205,-12556.32 1199,-12556.32"/>
<text text-anchor="start" x="1035" y="-12541.12" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-12526.12" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-12511.12" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg9&#45;&gt;norm_m9 -->
<g id="edge191" class="edge">
<title>agg9&#45;&gt;norm_m9</title>
<path fill="none" stroke="black" d="M1119,-12592.22C1119,-12583.55 1119,-12574.73 1119,-12566.59"/>
<polygon fill="black" stroke="black" points="1122.5,-12566.33 1119,-12556.33 1115.5,-12566.33 1122.5,-12566.33"/>
</g>
<!-- qkv_c10 -->
<g id="node197" class="node">
<title>qkv_c10</title>
<path fill="none" stroke="black" d="M1241,-12467.32C1241,-12467.32 997,-12467.32 997,-12467.32 991,-12467.32 985,-12461.32 985,-12455.32 985,-12455.32 985,-12426.32 985,-12426.32 985,-12420.32 991,-12414.32 997,-12414.32 997,-12414.32 1241,-12414.32 1241,-12414.32 1247,-12414.32 1253,-12420.32 1253,-12426.32 1253,-12426.32 1253,-12455.32 1253,-12455.32 1253,-12461.32 1247,-12467.32 1241,-12467.32"/>
<text text-anchor="start" x="993" y="-12452.12" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-12437.12" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-12422.12" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m9&#45;&gt;qkv_c10 -->
<g id="edge192" class="edge">
<title>norm_m9&#45;&gt;qkv_c10</title>
<path fill="none" stroke="black" d="M1119,-12503.19C1119,-12495.21 1119,-12486.25 1119,-12477.7"/>
<polygon fill="black" stroke="black" points="1122.5,-12477.57 1119,-12467.57 1115.5,-12477.57 1122.5,-12477.57"/>
</g>
<!-- qkv_ar10 -->
<g id="node198" class="node">
<title>qkv_ar10</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-12340.84" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-12352.14" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-12337.14" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-12322.14" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c10&#45;&gt;qkv_ar10 -->
<g id="edge193" class="edge">
<title>qkv_c10&#45;&gt;qkv_ar10</title>
<path fill="none" stroke="black" d="M1119,-12414.08C1119,-12406.25 1119,-12397.4 1119,-12388.64"/>
<polygon fill="black" stroke="black" points="1122.5,-12388.47 1119,-12378.47 1115.5,-12388.47 1122.5,-12388.47"/>
</g>
<!-- sph10 -->
<g id="node199" class="node">
<title>sph10</title>
<path fill="none" stroke="black" d="M1327.66,-12267.37C1327.66,-12267.37 1000.64,-12267.37 1000.64,-12267.37 994.64,-12267.37 984.75,-12262.8 980.86,-12258.23 980.86,-12258.23 906.12,-12170.5 906.12,-12170.5 902.23,-12165.93 904.34,-12161.37 910.34,-12161.37 910.34,-12161.37 1237.36,-12161.37 1237.36,-12161.37 1243.36,-12161.37 1253.25,-12165.93 1257.14,-12170.5 1257.14,-12170.5 1331.88,-12258.23 1331.88,-12258.23 1335.77,-12262.8 1333.66,-12267.37 1327.66,-12267.37"/>
<text text-anchor="start" x="942.54" y="-12225.67" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-12210.67" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-12195.67" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar10&#45;&gt;sph10 -->
<g id="edge194" class="edge">
<title>qkv_ar10&#45;&gt;sph10</title>
<path fill="none" stroke="black" d="M1119,-12303.17C1119,-12295.13 1119,-12286.4 1119,-12277.67"/>
<polygon fill="black" stroke="black" points="1122.5,-12277.46 1119,-12267.46 1115.5,-12277.46 1122.5,-12277.46"/>
</g>
<!-- sdp10 -->
<g id="node200" class="node">
<title>sdp10</title>
<path fill="none" stroke="black" d="M1220,-12125.37C1220,-12125.37 1018,-12125.37 1018,-12125.37 1012,-12125.37 1006,-12119.37 1006,-12113.37 1006,-12113.37 1006,-12084.37 1006,-12084.37 1006,-12078.37 1012,-12072.37 1018,-12072.37 1018,-12072.37 1220,-12072.37 1220,-12072.37 1226,-12072.37 1232,-12078.37 1232,-12084.37 1232,-12084.37 1232,-12113.37 1232,-12113.37 1232,-12119.37 1226,-12125.37 1220,-12125.37"/>
<text text-anchor="start" x="1014" y="-12110.17" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-12095.17" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-12080.17" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph10&#45;&gt;sdp10 -->
<g id="edge195" class="edge">
<title>sph10&#45;&gt;sdp10</title>
<path fill="none" stroke="black" d="M1119,-12161.27C1119,-12152.6 1119,-12143.78 1119,-12135.63"/>
<polygon fill="black" stroke="black" points="1122.5,-12135.38 1119,-12125.38 1115.5,-12135.38 1122.5,-12135.38"/>
</g>
<!-- sm10 -->
<g id="node201" class="node">
<title>sm10</title>
<path fill="none" stroke="black" d="M1182.5,-12036.37C1182.5,-12036.37 1055.5,-12036.37 1055.5,-12036.37 1049.5,-12036.37 1043.5,-12030.37 1043.5,-12024.37 1043.5,-12024.37 1043.5,-11995.37 1043.5,-11995.37 1043.5,-11989.37 1049.5,-11983.37 1055.5,-11983.37 1055.5,-11983.37 1182.5,-11983.37 1182.5,-11983.37 1188.5,-11983.37 1194.5,-11989.37 1194.5,-11995.37 1194.5,-11995.37 1194.5,-12024.37 1194.5,-12024.37 1194.5,-12030.37 1188.5,-12036.37 1182.5,-12036.37"/>
<text text-anchor="start" x="1051.5" y="-12021.17" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-12006.17" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-11991.17" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp10&#45;&gt;sm10 -->
<g id="edge196" class="edge">
<title>sdp10&#45;&gt;sm10</title>
<path fill="none" stroke="black" d="M1119,-12072.23C1119,-12064.25 1119,-12055.3 1119,-12046.75"/>
<polygon fill="black" stroke="black" points="1122.5,-12046.62 1119,-12036.62 1115.5,-12046.62 1122.5,-12046.62"/>
</g>
<!-- do10 -->
<g id="node202" class="node">
<title>do10</title>
<path fill="none" stroke="black" d="M1166.5,-11947.37C1166.5,-11947.37 1071.5,-11947.37 1071.5,-11947.37 1065.5,-11947.37 1059.5,-11941.37 1059.5,-11935.37 1059.5,-11935.37 1059.5,-11906.37 1059.5,-11906.37 1059.5,-11900.37 1065.5,-11894.37 1071.5,-11894.37 1071.5,-11894.37 1166.5,-11894.37 1166.5,-11894.37 1172.5,-11894.37 1178.5,-11900.37 1178.5,-11906.37 1178.5,-11906.37 1178.5,-11935.37 1178.5,-11935.37 1178.5,-11941.37 1172.5,-11947.37 1166.5,-11947.37"/>
<text text-anchor="start" x="1067.5" y="-11932.17" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-11917.17" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-11902.17" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm10&#45;&gt;do10 -->
<g id="edge197" class="edge">
<title>sm10&#45;&gt;do10</title>
<path fill="none" stroke="black" d="M1119,-11983.23C1119,-11975.25 1119,-11966.3 1119,-11957.75"/>
<polygon fill="black" stroke="black" points="1122.5,-11957.62 1119,-11947.62 1115.5,-11957.62 1122.5,-11957.62"/>
</g>
<!-- mgh10 -->
<g id="node203" class="node">
<title>mgh10</title>
<path fill="none" stroke="black" d="M1323.86,-11858.37C1323.86,-11858.37 1002.88,-11858.37 1002.88,-11858.37 996.88,-11858.37 987.03,-11853.77 983.18,-11849.17 983.18,-11849.17 909.84,-11761.57 909.84,-11761.57 905.99,-11756.97 908.14,-11752.37 914.14,-11752.37 914.14,-11752.37 1235.12,-11752.37 1235.12,-11752.37 1241.12,-11752.37 1250.97,-11756.97 1254.82,-11761.57 1254.82,-11761.57 1328.16,-11849.17 1328.16,-11849.17 1332.01,-11853.77 1329.86,-11858.37 1323.86,-11858.37"/>
<text text-anchor="start" x="946" y="-11816.67" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-11801.67" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-11786.67" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do10&#45;&gt;mgh10 -->
<g id="edge198" class="edge">
<title>do10&#45;&gt;mgh10</title>
<path fill="none" stroke="black" d="M1119,-11894.11C1119,-11886.41 1119,-11877.62 1119,-11868.63"/>
<polygon fill="black" stroke="black" points="1122.5,-11868.46 1119,-11858.46 1115.5,-11868.46 1122.5,-11868.46"/>
</g>
<!-- proj_r10 -->
<g id="node204" class="node">
<title>proj_r10</title>
<path fill="none" stroke="black" d="M1219,-11716.37C1219,-11716.37 1019,-11716.37 1019,-11716.37 1013,-11716.37 1007,-11710.37 1007,-11704.37 1007,-11704.37 1007,-11675.37 1007,-11675.37 1007,-11669.37 1013,-11663.37 1019,-11663.37 1019,-11663.37 1219,-11663.37 1219,-11663.37 1225,-11663.37 1231,-11669.37 1231,-11675.37 1231,-11675.37 1231,-11704.37 1231,-11704.37 1231,-11710.37 1225,-11716.37 1219,-11716.37"/>
<text text-anchor="start" x="1015" y="-11701.17" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-11686.17" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-11671.17" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh10&#45;&gt;proj_r10 -->
<g id="edge199" class="edge">
<title>mgh10&#45;&gt;proj_r10</title>
<path fill="none" stroke="black" d="M1119,-11752.27C1119,-11743.6 1119,-11734.78 1119,-11726.63"/>
<polygon fill="black" stroke="black" points="1122.5,-11726.38 1119,-11716.38 1115.5,-11726.38 1122.5,-11726.38"/>
</g>
<!-- proj_ar10 -->
<g id="node205" class="node">
<title>proj_ar10</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-11589.89" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-11601.19" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-11586.19" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-11571.19" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r10&#45;&gt;proj_ar10 -->
<g id="edge200" class="edge">
<title>proj_r10&#45;&gt;proj_ar10</title>
<path fill="none" stroke="black" d="M1119,-11663.12C1119,-11655.3 1119,-11646.45 1119,-11637.69"/>
<polygon fill="black" stroke="black" points="1122.5,-11637.51 1119,-11627.51 1115.5,-11637.51 1122.5,-11637.51"/>
</g>
<!-- norm10 -->
<g id="node206" class="node">
<title>norm10</title>
<path fill="none" stroke="black" d="M1204,-11516.41C1204,-11516.41 1034,-11516.41 1034,-11516.41 1028,-11516.41 1022,-11510.41 1022,-11504.41 1022,-11504.41 1022,-11475.41 1022,-11475.41 1022,-11469.41 1028,-11463.41 1034,-11463.41 1034,-11463.41 1204,-11463.41 1204,-11463.41 1210,-11463.41 1216,-11469.41 1216,-11475.41 1216,-11475.41 1216,-11504.41 1216,-11504.41 1216,-11510.41 1210,-11516.41 1204,-11516.41"/>
<text text-anchor="start" x="1030" y="-11501.21" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-11486.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-11471.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar10&#45;&gt;norm10 -->
<g id="edge201" class="edge">
<title>proj_ar10&#45;&gt;norm10</title>
<path fill="none" stroke="black" d="M1119,-11552.41C1119,-11543.99 1119,-11535.05 1119,-11526.66"/>
<polygon fill="black" stroke="black" points="1122.5,-11526.42 1119,-11516.42 1115.5,-11526.42 1122.5,-11526.42"/>
</g>
<!-- gate_c10 -->
<g id="node207" class="node">
<title>gate_c10</title>
<path fill="none" stroke="black" d="M1218.5,-11427.41C1218.5,-11427.41 1019.5,-11427.41 1019.5,-11427.41 1013.5,-11427.41 1007.5,-11421.41 1007.5,-11415.41 1007.5,-11415.41 1007.5,-11386.41 1007.5,-11386.41 1007.5,-11380.41 1013.5,-11374.41 1019.5,-11374.41 1019.5,-11374.41 1218.5,-11374.41 1218.5,-11374.41 1224.5,-11374.41 1230.5,-11380.41 1230.5,-11386.41 1230.5,-11386.41 1230.5,-11415.41 1230.5,-11415.41 1230.5,-11421.41 1224.5,-11427.41 1218.5,-11427.41"/>
<text text-anchor="start" x="1015.5" y="-11412.21" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-11397.21" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-11382.21" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm10&#45;&gt;gate_c10 -->
<g id="edge202" class="edge">
<title>norm10&#45;&gt;gate_c10</title>
<path fill="none" stroke="black" d="M1119,-11463.28C1119,-11455.3 1119,-11446.34 1119,-11437.8"/>
<polygon fill="black" stroke="black" points="1122.5,-11437.66 1119,-11427.66 1115.5,-11437.66 1122.5,-11437.66"/>
</g>
<!-- gate_ar10 -->
<g id="node208" class="node">
<title>gate_ar10</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-11300.94" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-11312.24" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-11297.24" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-11282.24" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c10&#45;&gt;gate_ar10 -->
<g id="edge203" class="edge">
<title>gate_c10&#45;&gt;gate_ar10</title>
<path fill="none" stroke="black" d="M1119,-11374.17C1119,-11366.35 1119,-11357.49 1119,-11348.73"/>
<polygon fill="black" stroke="black" points="1122.5,-11348.56 1119,-11338.56 1115.5,-11348.56 1122.5,-11348.56"/>
</g>
<!-- route10 -->
<g id="node209" class="node">
<title>route10</title>
<path fill="none" stroke="black" d="M1310.41,-11227.46C1310.41,-11227.46 1010.83,-11227.46 1010.83,-11227.46 1004.83,-11227.46 995.13,-11222.74 991.42,-11218.02 991.42,-11218.02 923,-11130.9 923,-11130.9 919.3,-11126.18 921.59,-11121.46 927.59,-11121.46 927.59,-11121.46 1227.17,-11121.46 1227.17,-11121.46 1233.17,-11121.46 1242.87,-11126.18 1246.58,-11130.9 1246.58,-11130.9 1315,-11218.02 1315,-11218.02 1318.7,-11222.74 1316.41,-11227.46 1310.41,-11227.46"/>
<text text-anchor="start" x="957.26" y="-11185.76" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-11170.76" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-11155.76" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar10&#45;&gt;route10 -->
<g id="edge204" class="edge">
<title>gate_ar10&#45;&gt;route10</title>
<path fill="none" stroke="black" d="M1119,-11263.26C1119,-11255.22 1119,-11246.49 1119,-11237.76"/>
<polygon fill="black" stroke="black" points="1122.5,-11237.55 1119,-11227.55 1115.5,-11237.55 1122.5,-11237.55"/>
</g>
<!-- a2a_s10 -->
<g id="node210" class="node">
<title>a2a_s10</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-11047.98" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-11059.28" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-11044.28" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-11029.28" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route10&#45;&gt;a2a_s10 -->
<g id="edge205" class="edge">
<title>route10&#45;&gt;a2a_s10</title>
<path fill="none" stroke="black" d="M1119,-11121.39C1119,-11112.96 1119,-11104.27 1119,-11095.97"/>
<polygon fill="black" stroke="black" points="1122.5,-11095.71 1119,-11085.71 1115.5,-11095.71 1122.5,-11095.71"/>
</g>
<!-- exp10 -->
<g id="node211" class="node">
<title>exp10</title>
<path fill="none" stroke="black" d="M1233.5,-10974.51C1233.5,-10974.51 1004.5,-10974.51 1004.5,-10974.51 998.5,-10974.51 992.5,-10968.51 992.5,-10962.51 992.5,-10962.51 992.5,-10933.51 992.5,-10933.51 992.5,-10927.51 998.5,-10921.51 1004.5,-10921.51 1004.5,-10921.51 1233.5,-10921.51 1233.5,-10921.51 1239.5,-10921.51 1245.5,-10927.51 1245.5,-10933.51 1245.5,-10933.51 1245.5,-10962.51 1245.5,-10962.51 1245.5,-10968.51 1239.5,-10974.51 1233.5,-10974.51"/>
<text text-anchor="start" x="1000.5" y="-10959.31" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-10944.31" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-10929.31" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s10&#45;&gt;exp10 -->
<g id="edge206" class="edge">
<title>a2a_s10&#45;&gt;exp10</title>
<path fill="none" stroke="black" d="M1119,-11010.5C1119,-11002.08 1119,-10993.14 1119,-10984.76"/>
<polygon fill="black" stroke="black" points="1122.5,-10984.52 1119,-10974.52 1115.5,-10984.52 1122.5,-10984.52"/>
</g>
<!-- exp_ar10 -->
<g id="node212" class="node">
<title>exp_ar10</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-10848.03" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-10859.33" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-10844.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-10829.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp10&#45;&gt;exp_ar10 -->
<g id="edge207" class="edge">
<title>exp10&#45;&gt;exp_ar10</title>
<path fill="none" stroke="black" d="M1119,-10921.26C1119,-10913.44 1119,-10904.59 1119,-10895.83"/>
<polygon fill="black" stroke="black" points="1122.5,-10895.65 1119,-10885.65 1115.5,-10895.65 1122.5,-10895.65"/>
</g>
<!-- a2a_r10 -->
<g id="node213" class="node">
<title>a2a_r10</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-10737.08" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-10748.38" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-10733.38" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-10718.38" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar10&#45;&gt;a2a_r10 -->
<g id="edge208" class="edge">
<title>exp_ar10&#45;&gt;a2a_r10</title>
<path fill="none" stroke="black" d="M1119,-10810.45C1119,-10802.27 1119,-10793.49 1119,-10784.97"/>
<polygon fill="black" stroke="black" points="1122.5,-10784.75 1119,-10774.75 1115.5,-10784.75 1122.5,-10784.75"/>
</g>
<!-- agg10 -->
<g id="node214" class="node">
<title>agg10</title>
<path fill="none" stroke="black" d="M1308.26,-10663.6C1308.26,-10663.6 1012.1,-10663.6 1012.1,-10663.6 1006.1,-10663.6 996.42,-10658.86 992.74,-10654.12 992.74,-10654.12 925.1,-10567.08 925.1,-10567.08 921.42,-10562.34 923.74,-10557.6 929.74,-10557.6 929.74,-10557.6 1225.9,-10557.6 1225.9,-10557.6 1231.9,-10557.6 1241.58,-10562.34 1245.26,-10567.08 1245.26,-10567.08 1312.9,-10654.12 1312.9,-10654.12 1316.58,-10658.86 1314.26,-10663.6 1308.26,-10663.6"/>
<text text-anchor="start" x="958.99" y="-10621.9" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-10606.9" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-10591.9" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r10&#45;&gt;agg10 -->
<g id="edge209" class="edge">
<title>a2a_r10&#45;&gt;agg10</title>
<path fill="none" stroke="black" d="M1119,-10699.4C1119,-10691.36 1119,-10682.63 1119,-10673.9"/>
<polygon fill="black" stroke="black" points="1122.5,-10673.69 1119,-10663.69 1115.5,-10673.69 1122.5,-10673.69"/>
</g>
<!-- norm_m10 -->
<g id="node215" class="node">
<title>norm_m10</title>
<path fill="none" stroke="black" d="M1199,-10521.6C1199,-10521.6 1039,-10521.6 1039,-10521.6 1033,-10521.6 1027,-10515.6 1027,-10509.6 1027,-10509.6 1027,-10480.6 1027,-10480.6 1027,-10474.6 1033,-10468.6 1039,-10468.6 1039,-10468.6 1199,-10468.6 1199,-10468.6 1205,-10468.6 1211,-10474.6 1211,-10480.6 1211,-10480.6 1211,-10509.6 1211,-10509.6 1211,-10515.6 1205,-10521.6 1199,-10521.6"/>
<text text-anchor="start" x="1035" y="-10506.4" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-10491.4" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-10476.4" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg10&#45;&gt;norm_m10 -->
<g id="edge210" class="edge">
<title>agg10&#45;&gt;norm_m10</title>
<path fill="none" stroke="black" d="M1119,-10557.5C1119,-10548.83 1119,-10540.01 1119,-10531.87"/>
<polygon fill="black" stroke="black" points="1122.5,-10531.61 1119,-10521.61 1115.5,-10531.61 1122.5,-10531.61"/>
</g>
<!-- qkv_c11 -->
<g id="node216" class="node">
<title>qkv_c11</title>
<path fill="none" stroke="black" d="M1241,-10432.6C1241,-10432.6 997,-10432.6 997,-10432.6 991,-10432.6 985,-10426.6 985,-10420.6 985,-10420.6 985,-10391.6 985,-10391.6 985,-10385.6 991,-10379.6 997,-10379.6 997,-10379.6 1241,-10379.6 1241,-10379.6 1247,-10379.6 1253,-10385.6 1253,-10391.6 1253,-10391.6 1253,-10420.6 1253,-10420.6 1253,-10426.6 1247,-10432.6 1241,-10432.6"/>
<text text-anchor="start" x="993" y="-10417.4" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-10402.4" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-10387.4" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m10&#45;&gt;qkv_c11 -->
<g id="edge211" class="edge">
<title>norm_m10&#45;&gt;qkv_c11</title>
<path fill="none" stroke="black" d="M1119,-10468.47C1119,-10460.49 1119,-10451.53 1119,-10442.98"/>
<polygon fill="black" stroke="black" points="1122.5,-10442.85 1119,-10432.85 1115.5,-10442.85 1122.5,-10442.85"/>
</g>
<!-- qkv_ar11 -->
<g id="node217" class="node">
<title>qkv_ar11</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-10306.12" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-10317.42" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-10302.42" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-10287.42" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c11&#45;&gt;qkv_ar11 -->
<g id="edge212" class="edge">
<title>qkv_c11&#45;&gt;qkv_ar11</title>
<path fill="none" stroke="black" d="M1119,-10379.36C1119,-10371.53 1119,-10362.68 1119,-10353.92"/>
<polygon fill="black" stroke="black" points="1122.5,-10353.75 1119,-10343.75 1115.5,-10353.75 1122.5,-10353.75"/>
</g>
<!-- sph11 -->
<g id="node218" class="node">
<title>sph11</title>
<path fill="none" stroke="black" d="M1327.66,-10232.65C1327.66,-10232.65 1000.64,-10232.65 1000.64,-10232.65 994.64,-10232.65 984.75,-10228.08 980.86,-10223.51 980.86,-10223.51 906.12,-10135.78 906.12,-10135.78 902.23,-10131.21 904.34,-10126.65 910.34,-10126.65 910.34,-10126.65 1237.36,-10126.65 1237.36,-10126.65 1243.36,-10126.65 1253.25,-10131.21 1257.14,-10135.78 1257.14,-10135.78 1331.88,-10223.51 1331.88,-10223.51 1335.77,-10228.08 1333.66,-10232.65 1327.66,-10232.65"/>
<text text-anchor="start" x="942.54" y="-10190.95" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-10175.95" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-10160.95" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar11&#45;&gt;sph11 -->
<g id="edge213" class="edge">
<title>qkv_ar11&#45;&gt;sph11</title>
<path fill="none" stroke="black" d="M1119,-10268.45C1119,-10260.41 1119,-10251.68 1119,-10242.95"/>
<polygon fill="black" stroke="black" points="1122.5,-10242.74 1119,-10232.74 1115.5,-10242.74 1122.5,-10242.74"/>
</g>
<!-- sdp11 -->
<g id="node219" class="node">
<title>sdp11</title>
<path fill="none" stroke="black" d="M1220,-10090.65C1220,-10090.65 1018,-10090.65 1018,-10090.65 1012,-10090.65 1006,-10084.65 1006,-10078.65 1006,-10078.65 1006,-10049.65 1006,-10049.65 1006,-10043.65 1012,-10037.65 1018,-10037.65 1018,-10037.65 1220,-10037.65 1220,-10037.65 1226,-10037.65 1232,-10043.65 1232,-10049.65 1232,-10049.65 1232,-10078.65 1232,-10078.65 1232,-10084.65 1226,-10090.65 1220,-10090.65"/>
<text text-anchor="start" x="1014" y="-10075.45" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-10060.45" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-10045.45" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph11&#45;&gt;sdp11 -->
<g id="edge214" class="edge">
<title>sph11&#45;&gt;sdp11</title>
<path fill="none" stroke="black" d="M1119,-10126.55C1119,-10117.88 1119,-10109.06 1119,-10100.91"/>
<polygon fill="black" stroke="black" points="1122.5,-10100.66 1119,-10090.66 1115.5,-10100.66 1122.5,-10100.66"/>
</g>
<!-- sm11 -->
<g id="node220" class="node">
<title>sm11</title>
<path fill="none" stroke="black" d="M1182.5,-10001.65C1182.5,-10001.65 1055.5,-10001.65 1055.5,-10001.65 1049.5,-10001.65 1043.5,-9995.65 1043.5,-9989.65 1043.5,-9989.65 1043.5,-9960.65 1043.5,-9960.65 1043.5,-9954.65 1049.5,-9948.65 1055.5,-9948.65 1055.5,-9948.65 1182.5,-9948.65 1182.5,-9948.65 1188.5,-9948.65 1194.5,-9954.65 1194.5,-9960.65 1194.5,-9960.65 1194.5,-9989.65 1194.5,-9989.65 1194.5,-9995.65 1188.5,-10001.65 1182.5,-10001.65"/>
<text text-anchor="start" x="1051.5" y="-9986.45" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-9971.45" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-9956.45" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp11&#45;&gt;sm11 -->
<g id="edge215" class="edge">
<title>sdp11&#45;&gt;sm11</title>
<path fill="none" stroke="black" d="M1119,-10037.51C1119,-10029.53 1119,-10020.58 1119,-10012.03"/>
<polygon fill="black" stroke="black" points="1122.5,-10011.9 1119,-10001.9 1115.5,-10011.9 1122.5,-10011.9"/>
</g>
<!-- do11 -->
<g id="node221" class="node">
<title>do11</title>
<path fill="none" stroke="black" d="M1166.5,-9912.65C1166.5,-9912.65 1071.5,-9912.65 1071.5,-9912.65 1065.5,-9912.65 1059.5,-9906.65 1059.5,-9900.65 1059.5,-9900.65 1059.5,-9871.65 1059.5,-9871.65 1059.5,-9865.65 1065.5,-9859.65 1071.5,-9859.65 1071.5,-9859.65 1166.5,-9859.65 1166.5,-9859.65 1172.5,-9859.65 1178.5,-9865.65 1178.5,-9871.65 1178.5,-9871.65 1178.5,-9900.65 1178.5,-9900.65 1178.5,-9906.65 1172.5,-9912.65 1166.5,-9912.65"/>
<text text-anchor="start" x="1067.5" y="-9897.45" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-9882.45" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-9867.45" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm11&#45;&gt;do11 -->
<g id="edge216" class="edge">
<title>sm11&#45;&gt;do11</title>
<path fill="none" stroke="black" d="M1119,-9948.51C1119,-9940.53 1119,-9931.58 1119,-9923.03"/>
<polygon fill="black" stroke="black" points="1122.5,-9922.9 1119,-9912.9 1115.5,-9922.9 1122.5,-9922.9"/>
</g>
<!-- mgh11 -->
<g id="node222" class="node">
<title>mgh11</title>
<path fill="none" stroke="black" d="M1323.86,-9823.65C1323.86,-9823.65 1002.88,-9823.65 1002.88,-9823.65 996.88,-9823.65 987.03,-9819.05 983.18,-9814.45 983.18,-9814.45 909.84,-9726.85 909.84,-9726.85 905.99,-9722.25 908.14,-9717.65 914.14,-9717.65 914.14,-9717.65 1235.12,-9717.65 1235.12,-9717.65 1241.12,-9717.65 1250.97,-9722.25 1254.82,-9726.85 1254.82,-9726.85 1328.16,-9814.45 1328.16,-9814.45 1332.01,-9819.05 1329.86,-9823.65 1323.86,-9823.65"/>
<text text-anchor="start" x="946" y="-9781.95" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-9766.95" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-9751.95" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do11&#45;&gt;mgh11 -->
<g id="edge217" class="edge">
<title>do11&#45;&gt;mgh11</title>
<path fill="none" stroke="black" d="M1119,-9859.39C1119,-9851.69 1119,-9842.9 1119,-9833.91"/>
<polygon fill="black" stroke="black" points="1122.5,-9833.74 1119,-9823.74 1115.5,-9833.74 1122.5,-9833.74"/>
</g>
<!-- proj_r11 -->
<g id="node223" class="node">
<title>proj_r11</title>
<path fill="none" stroke="black" d="M1219,-9681.65C1219,-9681.65 1019,-9681.65 1019,-9681.65 1013,-9681.65 1007,-9675.65 1007,-9669.65 1007,-9669.65 1007,-9640.65 1007,-9640.65 1007,-9634.65 1013,-9628.65 1019,-9628.65 1019,-9628.65 1219,-9628.65 1219,-9628.65 1225,-9628.65 1231,-9634.65 1231,-9640.65 1231,-9640.65 1231,-9669.65 1231,-9669.65 1231,-9675.65 1225,-9681.65 1219,-9681.65"/>
<text text-anchor="start" x="1015" y="-9666.45" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-9651.45" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-9636.45" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh11&#45;&gt;proj_r11 -->
<g id="edge218" class="edge">
<title>mgh11&#45;&gt;proj_r11</title>
<path fill="none" stroke="black" d="M1119,-9717.55C1119,-9708.88 1119,-9700.06 1119,-9691.91"/>
<polygon fill="black" stroke="black" points="1122.5,-9691.66 1119,-9681.66 1115.5,-9691.66 1122.5,-9691.66"/>
</g>
<!-- proj_ar11 -->
<g id="node224" class="node">
<title>proj_ar11</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-9555.17" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-9566.47" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-9551.47" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-9536.47" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r11&#45;&gt;proj_ar11 -->
<g id="edge219" class="edge">
<title>proj_r11&#45;&gt;proj_ar11</title>
<path fill="none" stroke="black" d="M1119,-9628.4C1119,-9620.58 1119,-9611.73 1119,-9602.97"/>
<polygon fill="black" stroke="black" points="1122.5,-9602.79 1119,-9592.79 1115.5,-9602.79 1122.5,-9602.79"/>
</g>
<!-- norm11 -->
<g id="node225" class="node">
<title>norm11</title>
<path fill="none" stroke="black" d="M1204,-9481.69C1204,-9481.69 1034,-9481.69 1034,-9481.69 1028,-9481.69 1022,-9475.69 1022,-9469.69 1022,-9469.69 1022,-9440.69 1022,-9440.69 1022,-9434.69 1028,-9428.69 1034,-9428.69 1034,-9428.69 1204,-9428.69 1204,-9428.69 1210,-9428.69 1216,-9434.69 1216,-9440.69 1216,-9440.69 1216,-9469.69 1216,-9469.69 1216,-9475.69 1210,-9481.69 1204,-9481.69"/>
<text text-anchor="start" x="1030" y="-9466.49" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-9451.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-9436.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar11&#45;&gt;norm11 -->
<g id="edge220" class="edge">
<title>proj_ar11&#45;&gt;norm11</title>
<path fill="none" stroke="black" d="M1119,-9517.69C1119,-9509.27 1119,-9500.33 1119,-9491.94"/>
<polygon fill="black" stroke="black" points="1122.5,-9491.7 1119,-9481.7 1115.5,-9491.7 1122.5,-9491.7"/>
</g>
<!-- gate_c11 -->
<g id="node226" class="node">
<title>gate_c11</title>
<path fill="none" stroke="black" d="M1218.5,-9392.69C1218.5,-9392.69 1019.5,-9392.69 1019.5,-9392.69 1013.5,-9392.69 1007.5,-9386.69 1007.5,-9380.69 1007.5,-9380.69 1007.5,-9351.69 1007.5,-9351.69 1007.5,-9345.69 1013.5,-9339.69 1019.5,-9339.69 1019.5,-9339.69 1218.5,-9339.69 1218.5,-9339.69 1224.5,-9339.69 1230.5,-9345.69 1230.5,-9351.69 1230.5,-9351.69 1230.5,-9380.69 1230.5,-9380.69 1230.5,-9386.69 1224.5,-9392.69 1218.5,-9392.69"/>
<text text-anchor="start" x="1015.5" y="-9377.49" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-9362.49" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-9347.49" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm11&#45;&gt;gate_c11 -->
<g id="edge221" class="edge">
<title>norm11&#45;&gt;gate_c11</title>
<path fill="none" stroke="black" d="M1119,-9428.56C1119,-9420.58 1119,-9411.63 1119,-9403.08"/>
<polygon fill="black" stroke="black" points="1122.5,-9402.94 1119,-9392.94 1115.5,-9402.94 1122.5,-9402.94"/>
</g>
<!-- gate_ar11 -->
<g id="node227" class="node">
<title>gate_ar11</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-9266.22" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-9277.52" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-9262.52" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-9247.52" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c11&#45;&gt;gate_ar11 -->
<g id="edge222" class="edge">
<title>gate_c11&#45;&gt;gate_ar11</title>
<path fill="none" stroke="black" d="M1119,-9339.45C1119,-9331.63 1119,-9322.77 1119,-9314.01"/>
<polygon fill="black" stroke="black" points="1122.5,-9313.84 1119,-9303.84 1115.5,-9313.84 1122.5,-9313.84"/>
</g>
<!-- route11 -->
<g id="node228" class="node">
<title>route11</title>
<path fill="none" stroke="black" d="M1310.41,-9192.74C1310.41,-9192.74 1010.83,-9192.74 1010.83,-9192.74 1004.83,-9192.74 995.13,-9188.02 991.42,-9183.3 991.42,-9183.3 923,-9096.18 923,-9096.18 919.3,-9091.46 921.59,-9086.74 927.59,-9086.74 927.59,-9086.74 1227.17,-9086.74 1227.17,-9086.74 1233.17,-9086.74 1242.87,-9091.46 1246.58,-9096.18 1246.58,-9096.18 1315,-9183.3 1315,-9183.3 1318.7,-9188.02 1316.41,-9192.74 1310.41,-9192.74"/>
<text text-anchor="start" x="957.26" y="-9151.04" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-9136.04" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-9121.04" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar11&#45;&gt;route11 -->
<g id="edge223" class="edge">
<title>gate_ar11&#45;&gt;route11</title>
<path fill="none" stroke="black" d="M1119,-9228.54C1119,-9220.5 1119,-9211.77 1119,-9203.04"/>
<polygon fill="black" stroke="black" points="1122.5,-9202.83 1119,-9192.83 1115.5,-9202.83 1122.5,-9202.83"/>
</g>
<!-- a2a_s11 -->
<g id="node229" class="node">
<title>a2a_s11</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-9013.26" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-9024.56" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-9009.56" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-8994.56" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route11&#45;&gt;a2a_s11 -->
<g id="edge224" class="edge">
<title>route11&#45;&gt;a2a_s11</title>
<path fill="none" stroke="black" d="M1119,-9086.67C1119,-9078.24 1119,-9069.55 1119,-9061.25"/>
<polygon fill="black" stroke="black" points="1122.5,-9060.99 1119,-9050.99 1115.5,-9060.99 1122.5,-9060.99"/>
</g>
<!-- exp11 -->
<g id="node230" class="node">
<title>exp11</title>
<path fill="none" stroke="black" d="M1233.5,-8939.79C1233.5,-8939.79 1004.5,-8939.79 1004.5,-8939.79 998.5,-8939.79 992.5,-8933.79 992.5,-8927.79 992.5,-8927.79 992.5,-8898.79 992.5,-8898.79 992.5,-8892.79 998.5,-8886.79 1004.5,-8886.79 1004.5,-8886.79 1233.5,-8886.79 1233.5,-8886.79 1239.5,-8886.79 1245.5,-8892.79 1245.5,-8898.79 1245.5,-8898.79 1245.5,-8927.79 1245.5,-8927.79 1245.5,-8933.79 1239.5,-8939.79 1233.5,-8939.79"/>
<text text-anchor="start" x="1000.5" y="-8924.59" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-8909.59" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-8894.59" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s11&#45;&gt;exp11 -->
<g id="edge225" class="edge">
<title>a2a_s11&#45;&gt;exp11</title>
<path fill="none" stroke="black" d="M1119,-8975.78C1119,-8967.36 1119,-8958.42 1119,-8950.04"/>
<polygon fill="black" stroke="black" points="1122.5,-8949.8 1119,-8939.8 1115.5,-8949.8 1122.5,-8949.8"/>
</g>
<!-- exp_ar11 -->
<g id="node231" class="node">
<title>exp_ar11</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-8813.31" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-8824.61" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-8809.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-8794.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp11&#45;&gt;exp_ar11 -->
<g id="edge226" class="edge">
<title>exp11&#45;&gt;exp_ar11</title>
<path fill="none" stroke="black" d="M1119,-8886.54C1119,-8878.72 1119,-8869.87 1119,-8861.11"/>
<polygon fill="black" stroke="black" points="1122.5,-8860.93 1119,-8850.93 1115.5,-8860.93 1122.5,-8860.93"/>
</g>
<!-- a2a_r11 -->
<g id="node232" class="node">
<title>a2a_r11</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-8702.36" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-8713.66" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-8698.66" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-8683.66" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar11&#45;&gt;a2a_r11 -->
<g id="edge227" class="edge">
<title>exp_ar11&#45;&gt;a2a_r11</title>
<path fill="none" stroke="black" d="M1119,-8775.73C1119,-8767.55 1119,-8758.77 1119,-8750.25"/>
<polygon fill="black" stroke="black" points="1122.5,-8750.03 1119,-8740.03 1115.5,-8750.03 1122.5,-8750.03"/>
</g>
<!-- agg11 -->
<g id="node233" class="node">
<title>agg11</title>
<path fill="none" stroke="black" d="M1308.26,-8628.88C1308.26,-8628.88 1012.1,-8628.88 1012.1,-8628.88 1006.1,-8628.88 996.42,-8624.14 992.74,-8619.4 992.74,-8619.4 925.1,-8532.36 925.1,-8532.36 921.42,-8527.62 923.74,-8522.88 929.74,-8522.88 929.74,-8522.88 1225.9,-8522.88 1225.9,-8522.88 1231.9,-8522.88 1241.58,-8527.62 1245.26,-8532.36 1245.26,-8532.36 1312.9,-8619.4 1312.9,-8619.4 1316.58,-8624.14 1314.26,-8628.88 1308.26,-8628.88"/>
<text text-anchor="start" x="958.99" y="-8587.18" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-8572.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-8557.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r11&#45;&gt;agg11 -->
<g id="edge228" class="edge">
<title>a2a_r11&#45;&gt;agg11</title>
<path fill="none" stroke="black" d="M1119,-8664.68C1119,-8656.64 1119,-8647.91 1119,-8639.18"/>
<polygon fill="black" stroke="black" points="1122.5,-8638.97 1119,-8628.97 1115.5,-8638.97 1122.5,-8638.97"/>
</g>
<!-- norm_m11 -->
<g id="node234" class="node">
<title>norm_m11</title>
<path fill="none" stroke="black" d="M1199,-8486.88C1199,-8486.88 1039,-8486.88 1039,-8486.88 1033,-8486.88 1027,-8480.88 1027,-8474.88 1027,-8474.88 1027,-8445.88 1027,-8445.88 1027,-8439.88 1033,-8433.88 1039,-8433.88 1039,-8433.88 1199,-8433.88 1199,-8433.88 1205,-8433.88 1211,-8439.88 1211,-8445.88 1211,-8445.88 1211,-8474.88 1211,-8474.88 1211,-8480.88 1205,-8486.88 1199,-8486.88"/>
<text text-anchor="start" x="1035" y="-8471.68" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-8456.68" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-8441.68" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg11&#45;&gt;norm_m11 -->
<g id="edge229" class="edge">
<title>agg11&#45;&gt;norm_m11</title>
<path fill="none" stroke="black" d="M1119,-8522.78C1119,-8514.11 1119,-8505.29 1119,-8497.15"/>
<polygon fill="black" stroke="black" points="1122.5,-8496.89 1119,-8486.89 1115.5,-8496.89 1122.5,-8496.89"/>
</g>
<!-- split3 -->
<g id="node235" class="node">
<title>split3</title>
<path fill="none" stroke="black" d="M1340.04,-8386.88C1340.04,-8386.88 993.33,-8386.88 993.33,-8386.88 987.33,-8386.88 977.31,-8382.42 973.3,-8377.96 973.3,-8377.96 893.99,-8289.8 893.99,-8289.8 889.97,-8285.34 891.96,-8280.88 897.96,-8280.88 897.96,-8280.88 1244.67,-8280.88 1244.67,-8280.88 1250.67,-8280.88 1260.69,-8285.34 1264.7,-8289.8 1264.7,-8289.8 1344.01,-8377.96 1344.01,-8377.96 1348.03,-8382.42 1346.04,-8386.88 1340.04,-8386.88"/>
<text text-anchor="start" x="932.14" y="-8345.18" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="932.14" y="-8330.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="932.14" y="-8315.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- norm_m11&#45;&gt;split3 -->
<g id="edge308" class="edge">
<title>norm_m11&#45;&gt;split3</title>
<path fill="none" stroke="black" d="M1119,-8433.58C1119,-8422.96 1119,-8410.15 1119,-8397.33"/>
<polygon fill="black" stroke="black" points="1122.5,-8397.09 1119,-8387.09 1115.5,-8397.09 1122.5,-8397.09"/>
</g>
<!-- qkv_c12 -->
<g id="node236" class="node">
<title>qkv_c12</title>
<path fill="none" stroke="black" d="M1241,-8244.88C1241,-8244.88 997,-8244.88 997,-8244.88 991,-8244.88 985,-8238.88 985,-8232.88 985,-8232.88 985,-8203.88 985,-8203.88 985,-8197.88 991,-8191.88 997,-8191.88 997,-8191.88 1241,-8191.88 1241,-8191.88 1247,-8191.88 1253,-8197.88 1253,-8203.88 1253,-8203.88 1253,-8232.88 1253,-8232.88 1253,-8238.88 1247,-8244.88 1241,-8244.88"/>
<text text-anchor="start" x="993" y="-8229.68" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-8214.68" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-8199.68" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- split3&#45;&gt;qkv_c12 -->
<g id="edge230" class="edge">
<title>split3&#45;&gt;qkv_c12</title>
<path fill="none" stroke="black" d="M1119,-8280.78C1119,-8272.11 1119,-8263.29 1119,-8255.15"/>
<polygon fill="black" stroke="black" points="1122.5,-8254.89 1119,-8244.89 1115.5,-8254.89 1122.5,-8254.89"/>
</g>
<!-- qkv_ar12 -->
<g id="node237" class="node">
<title>qkv_ar12</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-8118.4" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-8129.7" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-8114.7" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-8099.7" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c12&#45;&gt;qkv_ar12 -->
<g id="edge231" class="edge">
<title>qkv_c12&#45;&gt;qkv_ar12</title>
<path fill="none" stroke="black" d="M1119,-8191.64C1119,-8183.81 1119,-8174.96 1119,-8166.2"/>
<polygon fill="black" stroke="black" points="1122.5,-8166.03 1119,-8156.03 1115.5,-8166.03 1122.5,-8166.03"/>
</g>
<!-- sph12 -->
<g id="node238" class="node">
<title>sph12</title>
<path fill="none" stroke="black" d="M1327.66,-8044.93C1327.66,-8044.93 1000.64,-8044.93 1000.64,-8044.93 994.64,-8044.93 984.75,-8040.36 980.86,-8035.79 980.86,-8035.79 906.12,-7948.06 906.12,-7948.06 902.23,-7943.49 904.34,-7938.93 910.34,-7938.93 910.34,-7938.93 1237.36,-7938.93 1237.36,-7938.93 1243.36,-7938.93 1253.25,-7943.49 1257.14,-7948.06 1257.14,-7948.06 1331.88,-8035.79 1331.88,-8035.79 1335.77,-8040.36 1333.66,-8044.93 1327.66,-8044.93"/>
<text text-anchor="start" x="942.54" y="-8003.23" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-7988.23" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-7973.23" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar12&#45;&gt;sph12 -->
<g id="edge232" class="edge">
<title>qkv_ar12&#45;&gt;sph12</title>
<path fill="none" stroke="black" d="M1119,-8080.73C1119,-8072.69 1119,-8063.96 1119,-8055.23"/>
<polygon fill="black" stroke="black" points="1122.5,-8055.02 1119,-8045.02 1115.5,-8055.02 1122.5,-8055.02"/>
</g>
<!-- sdp12 -->
<g id="node239" class="node">
<title>sdp12</title>
<path fill="none" stroke="black" d="M1220,-7902.93C1220,-7902.93 1018,-7902.93 1018,-7902.93 1012,-7902.93 1006,-7896.93 1006,-7890.93 1006,-7890.93 1006,-7861.93 1006,-7861.93 1006,-7855.93 1012,-7849.93 1018,-7849.93 1018,-7849.93 1220,-7849.93 1220,-7849.93 1226,-7849.93 1232,-7855.93 1232,-7861.93 1232,-7861.93 1232,-7890.93 1232,-7890.93 1232,-7896.93 1226,-7902.93 1220,-7902.93"/>
<text text-anchor="start" x="1014" y="-7887.73" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-7872.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-7857.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph12&#45;&gt;sdp12 -->
<g id="edge233" class="edge">
<title>sph12&#45;&gt;sdp12</title>
<path fill="none" stroke="black" d="M1119,-7938.83C1119,-7930.16 1119,-7921.34 1119,-7913.19"/>
<polygon fill="black" stroke="black" points="1122.5,-7912.94 1119,-7902.94 1115.5,-7912.94 1122.5,-7912.94"/>
</g>
<!-- sm12 -->
<g id="node240" class="node">
<title>sm12</title>
<path fill="none" stroke="black" d="M1182.5,-7813.93C1182.5,-7813.93 1055.5,-7813.93 1055.5,-7813.93 1049.5,-7813.93 1043.5,-7807.93 1043.5,-7801.93 1043.5,-7801.93 1043.5,-7772.93 1043.5,-7772.93 1043.5,-7766.93 1049.5,-7760.93 1055.5,-7760.93 1055.5,-7760.93 1182.5,-7760.93 1182.5,-7760.93 1188.5,-7760.93 1194.5,-7766.93 1194.5,-7772.93 1194.5,-7772.93 1194.5,-7801.93 1194.5,-7801.93 1194.5,-7807.93 1188.5,-7813.93 1182.5,-7813.93"/>
<text text-anchor="start" x="1051.5" y="-7798.73" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-7783.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-7768.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp12&#45;&gt;sm12 -->
<g id="edge234" class="edge">
<title>sdp12&#45;&gt;sm12</title>
<path fill="none" stroke="black" d="M1119,-7849.79C1119,-7841.81 1119,-7832.86 1119,-7824.31"/>
<polygon fill="black" stroke="black" points="1122.5,-7824.18 1119,-7814.18 1115.5,-7824.18 1122.5,-7824.18"/>
</g>
<!-- do12 -->
<g id="node241" class="node">
<title>do12</title>
<path fill="none" stroke="black" d="M1166.5,-7724.93C1166.5,-7724.93 1071.5,-7724.93 1071.5,-7724.93 1065.5,-7724.93 1059.5,-7718.93 1059.5,-7712.93 1059.5,-7712.93 1059.5,-7683.93 1059.5,-7683.93 1059.5,-7677.93 1065.5,-7671.93 1071.5,-7671.93 1071.5,-7671.93 1166.5,-7671.93 1166.5,-7671.93 1172.5,-7671.93 1178.5,-7677.93 1178.5,-7683.93 1178.5,-7683.93 1178.5,-7712.93 1178.5,-7712.93 1178.5,-7718.93 1172.5,-7724.93 1166.5,-7724.93"/>
<text text-anchor="start" x="1067.5" y="-7709.73" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-7694.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-7679.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm12&#45;&gt;do12 -->
<g id="edge235" class="edge">
<title>sm12&#45;&gt;do12</title>
<path fill="none" stroke="black" d="M1119,-7760.79C1119,-7752.81 1119,-7743.86 1119,-7735.31"/>
<polygon fill="black" stroke="black" points="1122.5,-7735.18 1119,-7725.18 1115.5,-7735.18 1122.5,-7735.18"/>
</g>
<!-- mgh12 -->
<g id="node242" class="node">
<title>mgh12</title>
<path fill="none" stroke="black" d="M1323.86,-7635.93C1323.86,-7635.93 1002.88,-7635.93 1002.88,-7635.93 996.88,-7635.93 987.03,-7631.33 983.18,-7626.73 983.18,-7626.73 909.84,-7539.13 909.84,-7539.13 905.99,-7534.53 908.14,-7529.93 914.14,-7529.93 914.14,-7529.93 1235.12,-7529.93 1235.12,-7529.93 1241.12,-7529.93 1250.97,-7534.53 1254.82,-7539.13 1254.82,-7539.13 1328.16,-7626.73 1328.16,-7626.73 1332.01,-7631.33 1329.86,-7635.93 1323.86,-7635.93"/>
<text text-anchor="start" x="946" y="-7594.23" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-7579.23" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-7564.23" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do12&#45;&gt;mgh12 -->
<g id="edge236" class="edge">
<title>do12&#45;&gt;mgh12</title>
<path fill="none" stroke="black" d="M1119,-7671.67C1119,-7663.97 1119,-7655.18 1119,-7646.19"/>
<polygon fill="black" stroke="black" points="1122.5,-7646.02 1119,-7636.02 1115.5,-7646.02 1122.5,-7646.02"/>
</g>
<!-- proj_r12 -->
<g id="node243" class="node">
<title>proj_r12</title>
<path fill="none" stroke="black" d="M1219,-7493.93C1219,-7493.93 1019,-7493.93 1019,-7493.93 1013,-7493.93 1007,-7487.93 1007,-7481.93 1007,-7481.93 1007,-7452.93 1007,-7452.93 1007,-7446.93 1013,-7440.93 1019,-7440.93 1019,-7440.93 1219,-7440.93 1219,-7440.93 1225,-7440.93 1231,-7446.93 1231,-7452.93 1231,-7452.93 1231,-7481.93 1231,-7481.93 1231,-7487.93 1225,-7493.93 1219,-7493.93"/>
<text text-anchor="start" x="1015" y="-7478.73" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-7463.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-7448.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh12&#45;&gt;proj_r12 -->
<g id="edge237" class="edge">
<title>mgh12&#45;&gt;proj_r12</title>
<path fill="none" stroke="black" d="M1119,-7529.83C1119,-7521.16 1119,-7512.34 1119,-7504.19"/>
<polygon fill="black" stroke="black" points="1122.5,-7503.94 1119,-7493.94 1115.5,-7503.94 1122.5,-7503.94"/>
</g>
<!-- proj_ar12 -->
<g id="node244" class="node">
<title>proj_ar12</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-7367.45" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-7378.75" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-7363.75" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-7348.75" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r12&#45;&gt;proj_ar12 -->
<g id="edge238" class="edge">
<title>proj_r12&#45;&gt;proj_ar12</title>
<path fill="none" stroke="black" d="M1119,-7440.68C1119,-7432.86 1119,-7424.01 1119,-7415.25"/>
<polygon fill="black" stroke="black" points="1122.5,-7415.07 1119,-7405.07 1115.5,-7415.07 1122.5,-7415.07"/>
</g>
<!-- norm12 -->
<g id="node245" class="node">
<title>norm12</title>
<path fill="none" stroke="black" d="M1204,-7293.97C1204,-7293.97 1034,-7293.97 1034,-7293.97 1028,-7293.97 1022,-7287.97 1022,-7281.97 1022,-7281.97 1022,-7252.97 1022,-7252.97 1022,-7246.97 1028,-7240.97 1034,-7240.97 1034,-7240.97 1204,-7240.97 1204,-7240.97 1210,-7240.97 1216,-7246.97 1216,-7252.97 1216,-7252.97 1216,-7281.97 1216,-7281.97 1216,-7287.97 1210,-7293.97 1204,-7293.97"/>
<text text-anchor="start" x="1030" y="-7278.77" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-7263.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-7248.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar12&#45;&gt;norm12 -->
<g id="edge239" class="edge">
<title>proj_ar12&#45;&gt;norm12</title>
<path fill="none" stroke="black" d="M1119,-7329.97C1119,-7321.55 1119,-7312.61 1119,-7304.22"/>
<polygon fill="black" stroke="black" points="1122.5,-7303.98 1119,-7293.98 1115.5,-7303.98 1122.5,-7303.98"/>
</g>
<!-- gate_c12 -->
<g id="node246" class="node">
<title>gate_c12</title>
<path fill="none" stroke="black" d="M1218.5,-7204.97C1218.5,-7204.97 1019.5,-7204.97 1019.5,-7204.97 1013.5,-7204.97 1007.5,-7198.97 1007.5,-7192.97 1007.5,-7192.97 1007.5,-7163.97 1007.5,-7163.97 1007.5,-7157.97 1013.5,-7151.97 1019.5,-7151.97 1019.5,-7151.97 1218.5,-7151.97 1218.5,-7151.97 1224.5,-7151.97 1230.5,-7157.97 1230.5,-7163.97 1230.5,-7163.97 1230.5,-7192.97 1230.5,-7192.97 1230.5,-7198.97 1224.5,-7204.97 1218.5,-7204.97"/>
<text text-anchor="start" x="1015.5" y="-7189.77" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-7174.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-7159.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm12&#45;&gt;gate_c12 -->
<g id="edge240" class="edge">
<title>norm12&#45;&gt;gate_c12</title>
<path fill="none" stroke="black" d="M1119,-7240.84C1119,-7232.86 1119,-7223.91 1119,-7215.36"/>
<polygon fill="black" stroke="black" points="1122.5,-7215.22 1119,-7205.22 1115.5,-7215.22 1122.5,-7215.22"/>
</g>
<!-- gate_ar12 -->
<g id="node247" class="node">
<title>gate_ar12</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-7078.5" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-7089.8" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-7074.8" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-7059.8" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c12&#45;&gt;gate_ar12 -->
<g id="edge241" class="edge">
<title>gate_c12&#45;&gt;gate_ar12</title>
<path fill="none" stroke="black" d="M1119,-7151.73C1119,-7143.91 1119,-7135.05 1119,-7126.29"/>
<polygon fill="black" stroke="black" points="1122.5,-7126.12 1119,-7116.12 1115.5,-7126.12 1122.5,-7126.12"/>
</g>
<!-- route12 -->
<g id="node248" class="node">
<title>route12</title>
<path fill="none" stroke="black" d="M1310.41,-7005.02C1310.41,-7005.02 1010.83,-7005.02 1010.83,-7005.02 1004.83,-7005.02 995.13,-7000.3 991.42,-6995.58 991.42,-6995.58 923,-6908.46 923,-6908.46 919.3,-6903.74 921.59,-6899.02 927.59,-6899.02 927.59,-6899.02 1227.17,-6899.02 1227.17,-6899.02 1233.17,-6899.02 1242.87,-6903.74 1246.58,-6908.46 1246.58,-6908.46 1315,-6995.58 1315,-6995.58 1318.7,-7000.3 1316.41,-7005.02 1310.41,-7005.02"/>
<text text-anchor="start" x="957.26" y="-6963.32" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-6948.32" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-6933.32" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar12&#45;&gt;route12 -->
<g id="edge242" class="edge">
<title>gate_ar12&#45;&gt;route12</title>
<path fill="none" stroke="black" d="M1119,-7040.82C1119,-7032.78 1119,-7024.05 1119,-7015.32"/>
<polygon fill="black" stroke="black" points="1122.5,-7015.11 1119,-7005.11 1115.5,-7015.11 1122.5,-7015.11"/>
</g>
<!-- a2a_s12 -->
<g id="node249" class="node">
<title>a2a_s12</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-6825.54" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-6836.84" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-6821.84" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-6806.84" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route12&#45;&gt;a2a_s12 -->
<g id="edge243" class="edge">
<title>route12&#45;&gt;a2a_s12</title>
<path fill="none" stroke="black" d="M1119,-6898.95C1119,-6890.52 1119,-6881.83 1119,-6873.53"/>
<polygon fill="black" stroke="black" points="1122.5,-6873.27 1119,-6863.27 1115.5,-6873.27 1122.5,-6873.27"/>
</g>
<!-- exp12 -->
<g id="node250" class="node">
<title>exp12</title>
<path fill="none" stroke="black" d="M1233.5,-6752.07C1233.5,-6752.07 1004.5,-6752.07 1004.5,-6752.07 998.5,-6752.07 992.5,-6746.07 992.5,-6740.07 992.5,-6740.07 992.5,-6711.07 992.5,-6711.07 992.5,-6705.07 998.5,-6699.07 1004.5,-6699.07 1004.5,-6699.07 1233.5,-6699.07 1233.5,-6699.07 1239.5,-6699.07 1245.5,-6705.07 1245.5,-6711.07 1245.5,-6711.07 1245.5,-6740.07 1245.5,-6740.07 1245.5,-6746.07 1239.5,-6752.07 1233.5,-6752.07"/>
<text text-anchor="start" x="1000.5" y="-6736.87" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-6721.87" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-6706.87" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s12&#45;&gt;exp12 -->
<g id="edge244" class="edge">
<title>a2a_s12&#45;&gt;exp12</title>
<path fill="none" stroke="black" d="M1119,-6788.06C1119,-6779.64 1119,-6770.7 1119,-6762.32"/>
<polygon fill="black" stroke="black" points="1122.5,-6762.08 1119,-6752.08 1115.5,-6762.08 1122.5,-6762.08"/>
</g>
<!-- exp_ar12 -->
<g id="node251" class="node">
<title>exp_ar12</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-6625.59" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-6636.89" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-6621.89" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-6606.89" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp12&#45;&gt;exp_ar12 -->
<g id="edge245" class="edge">
<title>exp12&#45;&gt;exp_ar12</title>
<path fill="none" stroke="black" d="M1119,-6698.82C1119,-6691 1119,-6682.15 1119,-6673.39"/>
<polygon fill="black" stroke="black" points="1122.5,-6673.21 1119,-6663.21 1115.5,-6673.21 1122.5,-6673.21"/>
</g>
<!-- a2a_r12 -->
<g id="node252" class="node">
<title>a2a_r12</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-6514.64" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-6525.94" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-6510.94" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-6495.94" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar12&#45;&gt;a2a_r12 -->
<g id="edge246" class="edge">
<title>exp_ar12&#45;&gt;a2a_r12</title>
<path fill="none" stroke="black" d="M1119,-6588.01C1119,-6579.83 1119,-6571.05 1119,-6562.53"/>
<polygon fill="black" stroke="black" points="1122.5,-6562.31 1119,-6552.31 1115.5,-6562.31 1122.5,-6562.31"/>
</g>
<!-- agg12 -->
<g id="node253" class="node">
<title>agg12</title>
<path fill="none" stroke="black" d="M1308.26,-6441.16C1308.26,-6441.16 1012.1,-6441.16 1012.1,-6441.16 1006.1,-6441.16 996.42,-6436.42 992.74,-6431.68 992.74,-6431.68 925.1,-6344.64 925.1,-6344.64 921.42,-6339.9 923.74,-6335.16 929.74,-6335.16 929.74,-6335.16 1225.9,-6335.16 1225.9,-6335.16 1231.9,-6335.16 1241.58,-6339.9 1245.26,-6344.64 1245.26,-6344.64 1312.9,-6431.68 1312.9,-6431.68 1316.58,-6436.42 1314.26,-6441.16 1308.26,-6441.16"/>
<text text-anchor="start" x="958.99" y="-6399.46" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-6384.46" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-6369.46" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r12&#45;&gt;agg12 -->
<g id="edge247" class="edge">
<title>a2a_r12&#45;&gt;agg12</title>
<path fill="none" stroke="black" d="M1119,-6476.96C1119,-6468.92 1119,-6460.19 1119,-6451.46"/>
<polygon fill="black" stroke="black" points="1122.5,-6451.25 1119,-6441.25 1115.5,-6451.25 1122.5,-6451.25"/>
</g>
<!-- norm_m12 -->
<g id="node254" class="node">
<title>norm_m12</title>
<path fill="none" stroke="black" d="M1199,-6299.16C1199,-6299.16 1039,-6299.16 1039,-6299.16 1033,-6299.16 1027,-6293.16 1027,-6287.16 1027,-6287.16 1027,-6258.16 1027,-6258.16 1027,-6252.16 1033,-6246.16 1039,-6246.16 1039,-6246.16 1199,-6246.16 1199,-6246.16 1205,-6246.16 1211,-6252.16 1211,-6258.16 1211,-6258.16 1211,-6287.16 1211,-6287.16 1211,-6293.16 1205,-6299.16 1199,-6299.16"/>
<text text-anchor="start" x="1035" y="-6283.96" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-6268.96" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-6253.96" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg12&#45;&gt;norm_m12 -->
<g id="edge248" class="edge">
<title>agg12&#45;&gt;norm_m12</title>
<path fill="none" stroke="black" d="M1119,-6335.06C1119,-6326.39 1119,-6317.57 1119,-6309.43"/>
<polygon fill="black" stroke="black" points="1122.5,-6309.17 1119,-6299.17 1115.5,-6309.17 1122.5,-6309.17"/>
</g>
<!-- qkv_c13 -->
<g id="node255" class="node">
<title>qkv_c13</title>
<path fill="none" stroke="black" d="M1241,-6210.16C1241,-6210.16 997,-6210.16 997,-6210.16 991,-6210.16 985,-6204.16 985,-6198.16 985,-6198.16 985,-6169.16 985,-6169.16 985,-6163.16 991,-6157.16 997,-6157.16 997,-6157.16 1241,-6157.16 1241,-6157.16 1247,-6157.16 1253,-6163.16 1253,-6169.16 1253,-6169.16 1253,-6198.16 1253,-6198.16 1253,-6204.16 1247,-6210.16 1241,-6210.16"/>
<text text-anchor="start" x="993" y="-6194.96" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-6179.96" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-6164.96" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m12&#45;&gt;qkv_c13 -->
<g id="edge249" class="edge">
<title>norm_m12&#45;&gt;qkv_c13</title>
<path fill="none" stroke="black" d="M1119,-6246.03C1119,-6238.05 1119,-6229.09 1119,-6220.54"/>
<polygon fill="black" stroke="black" points="1122.5,-6220.41 1119,-6210.41 1115.5,-6220.41 1122.5,-6220.41"/>
</g>
<!-- qkv_ar13 -->
<g id="node256" class="node">
<title>qkv_ar13</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-6083.68" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-6094.98" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-6079.98" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-6064.98" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c13&#45;&gt;qkv_ar13 -->
<g id="edge250" class="edge">
<title>qkv_c13&#45;&gt;qkv_ar13</title>
<path fill="none" stroke="black" d="M1119,-6156.92C1119,-6149.09 1119,-6140.24 1119,-6131.48"/>
<polygon fill="black" stroke="black" points="1122.5,-6131.31 1119,-6121.31 1115.5,-6131.31 1122.5,-6131.31"/>
</g>
<!-- sph13 -->
<g id="node257" class="node">
<title>sph13</title>
<path fill="none" stroke="black" d="M1327.66,-6010.21C1327.66,-6010.21 1000.64,-6010.21 1000.64,-6010.21 994.64,-6010.21 984.75,-6005.64 980.86,-6001.07 980.86,-6001.07 906.12,-5913.34 906.12,-5913.34 902.23,-5908.77 904.34,-5904.21 910.34,-5904.21 910.34,-5904.21 1237.36,-5904.21 1237.36,-5904.21 1243.36,-5904.21 1253.25,-5908.77 1257.14,-5913.34 1257.14,-5913.34 1331.88,-6001.07 1331.88,-6001.07 1335.77,-6005.64 1333.66,-6010.21 1327.66,-6010.21"/>
<text text-anchor="start" x="942.54" y="-5968.51" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-5953.51" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-5938.51" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar13&#45;&gt;sph13 -->
<g id="edge251" class="edge">
<title>qkv_ar13&#45;&gt;sph13</title>
<path fill="none" stroke="black" d="M1119,-6046.01C1119,-6037.97 1119,-6029.24 1119,-6020.51"/>
<polygon fill="black" stroke="black" points="1122.5,-6020.3 1119,-6010.3 1115.5,-6020.3 1122.5,-6020.3"/>
</g>
<!-- sdp13 -->
<g id="node258" class="node">
<title>sdp13</title>
<path fill="none" stroke="black" d="M1220,-5868.21C1220,-5868.21 1018,-5868.21 1018,-5868.21 1012,-5868.21 1006,-5862.21 1006,-5856.21 1006,-5856.21 1006,-5827.21 1006,-5827.21 1006,-5821.21 1012,-5815.21 1018,-5815.21 1018,-5815.21 1220,-5815.21 1220,-5815.21 1226,-5815.21 1232,-5821.21 1232,-5827.21 1232,-5827.21 1232,-5856.21 1232,-5856.21 1232,-5862.21 1226,-5868.21 1220,-5868.21"/>
<text text-anchor="start" x="1014" y="-5853.01" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-5838.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-5823.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph13&#45;&gt;sdp13 -->
<g id="edge252" class="edge">
<title>sph13&#45;&gt;sdp13</title>
<path fill="none" stroke="black" d="M1119,-5904.11C1119,-5895.44 1119,-5886.62 1119,-5878.47"/>
<polygon fill="black" stroke="black" points="1122.5,-5878.22 1119,-5868.22 1115.5,-5878.22 1122.5,-5878.22"/>
</g>
<!-- sm13 -->
<g id="node259" class="node">
<title>sm13</title>
<path fill="none" stroke="black" d="M1182.5,-5779.21C1182.5,-5779.21 1055.5,-5779.21 1055.5,-5779.21 1049.5,-5779.21 1043.5,-5773.21 1043.5,-5767.21 1043.5,-5767.21 1043.5,-5738.21 1043.5,-5738.21 1043.5,-5732.21 1049.5,-5726.21 1055.5,-5726.21 1055.5,-5726.21 1182.5,-5726.21 1182.5,-5726.21 1188.5,-5726.21 1194.5,-5732.21 1194.5,-5738.21 1194.5,-5738.21 1194.5,-5767.21 1194.5,-5767.21 1194.5,-5773.21 1188.5,-5779.21 1182.5,-5779.21"/>
<text text-anchor="start" x="1051.5" y="-5764.01" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-5749.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-5734.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp13&#45;&gt;sm13 -->
<g id="edge253" class="edge">
<title>sdp13&#45;&gt;sm13</title>
<path fill="none" stroke="black" d="M1119,-5815.07C1119,-5807.09 1119,-5798.14 1119,-5789.59"/>
<polygon fill="black" stroke="black" points="1122.5,-5789.46 1119,-5779.46 1115.5,-5789.46 1122.5,-5789.46"/>
</g>
<!-- do13 -->
<g id="node260" class="node">
<title>do13</title>
<path fill="none" stroke="black" d="M1166.5,-5690.21C1166.5,-5690.21 1071.5,-5690.21 1071.5,-5690.21 1065.5,-5690.21 1059.5,-5684.21 1059.5,-5678.21 1059.5,-5678.21 1059.5,-5649.21 1059.5,-5649.21 1059.5,-5643.21 1065.5,-5637.21 1071.5,-5637.21 1071.5,-5637.21 1166.5,-5637.21 1166.5,-5637.21 1172.5,-5637.21 1178.5,-5643.21 1178.5,-5649.21 1178.5,-5649.21 1178.5,-5678.21 1178.5,-5678.21 1178.5,-5684.21 1172.5,-5690.21 1166.5,-5690.21"/>
<text text-anchor="start" x="1067.5" y="-5675.01" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-5660.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-5645.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm13&#45;&gt;do13 -->
<g id="edge254" class="edge">
<title>sm13&#45;&gt;do13</title>
<path fill="none" stroke="black" d="M1119,-5726.07C1119,-5718.09 1119,-5709.14 1119,-5700.59"/>
<polygon fill="black" stroke="black" points="1122.5,-5700.46 1119,-5690.46 1115.5,-5700.46 1122.5,-5700.46"/>
</g>
<!-- mgh13 -->
<g id="node261" class="node">
<title>mgh13</title>
<path fill="none" stroke="black" d="M1323.86,-5601.21C1323.86,-5601.21 1002.88,-5601.21 1002.88,-5601.21 996.88,-5601.21 987.03,-5596.61 983.18,-5592.01 983.18,-5592.01 909.84,-5504.41 909.84,-5504.41 905.99,-5499.81 908.14,-5495.21 914.14,-5495.21 914.14,-5495.21 1235.12,-5495.21 1235.12,-5495.21 1241.12,-5495.21 1250.97,-5499.81 1254.82,-5504.41 1254.82,-5504.41 1328.16,-5592.01 1328.16,-5592.01 1332.01,-5596.61 1329.86,-5601.21 1323.86,-5601.21"/>
<text text-anchor="start" x="946" y="-5559.51" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-5544.51" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-5529.51" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do13&#45;&gt;mgh13 -->
<g id="edge255" class="edge">
<title>do13&#45;&gt;mgh13</title>
<path fill="none" stroke="black" d="M1119,-5636.95C1119,-5629.25 1119,-5620.46 1119,-5611.47"/>
<polygon fill="black" stroke="black" points="1122.5,-5611.3 1119,-5601.3 1115.5,-5611.3 1122.5,-5611.3"/>
</g>
<!-- proj_r13 -->
<g id="node262" class="node">
<title>proj_r13</title>
<path fill="none" stroke="black" d="M1219,-5459.21C1219,-5459.21 1019,-5459.21 1019,-5459.21 1013,-5459.21 1007,-5453.21 1007,-5447.21 1007,-5447.21 1007,-5418.21 1007,-5418.21 1007,-5412.21 1013,-5406.21 1019,-5406.21 1019,-5406.21 1219,-5406.21 1219,-5406.21 1225,-5406.21 1231,-5412.21 1231,-5418.21 1231,-5418.21 1231,-5447.21 1231,-5447.21 1231,-5453.21 1225,-5459.21 1219,-5459.21"/>
<text text-anchor="start" x="1015" y="-5444.01" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-5429.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-5414.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh13&#45;&gt;proj_r13 -->
<g id="edge256" class="edge">
<title>mgh13&#45;&gt;proj_r13</title>
<path fill="none" stroke="black" d="M1119,-5495.11C1119,-5486.44 1119,-5477.62 1119,-5469.47"/>
<polygon fill="black" stroke="black" points="1122.5,-5469.22 1119,-5459.22 1115.5,-5469.22 1122.5,-5469.22"/>
</g>
<!-- proj_ar13 -->
<g id="node263" class="node">
<title>proj_ar13</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-5332.73" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-5344.03" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-5329.03" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-5314.03" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r13&#45;&gt;proj_ar13 -->
<g id="edge257" class="edge">
<title>proj_r13&#45;&gt;proj_ar13</title>
<path fill="none" stroke="black" d="M1119,-5405.96C1119,-5398.14 1119,-5389.29 1119,-5380.53"/>
<polygon fill="black" stroke="black" points="1122.5,-5380.35 1119,-5370.35 1115.5,-5380.35 1122.5,-5380.35"/>
</g>
<!-- norm13 -->
<g id="node264" class="node">
<title>norm13</title>
<path fill="none" stroke="black" d="M1204,-5259.25C1204,-5259.25 1034,-5259.25 1034,-5259.25 1028,-5259.25 1022,-5253.25 1022,-5247.25 1022,-5247.25 1022,-5218.25 1022,-5218.25 1022,-5212.25 1028,-5206.25 1034,-5206.25 1034,-5206.25 1204,-5206.25 1204,-5206.25 1210,-5206.25 1216,-5212.25 1216,-5218.25 1216,-5218.25 1216,-5247.25 1216,-5247.25 1216,-5253.25 1210,-5259.25 1204,-5259.25"/>
<text text-anchor="start" x="1030" y="-5244.05" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-5229.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-5214.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar13&#45;&gt;norm13 -->
<g id="edge258" class="edge">
<title>proj_ar13&#45;&gt;norm13</title>
<path fill="none" stroke="black" d="M1119,-5295.25C1119,-5286.83 1119,-5277.89 1119,-5269.5"/>
<polygon fill="black" stroke="black" points="1122.5,-5269.26 1119,-5259.26 1115.5,-5269.26 1122.5,-5269.26"/>
</g>
<!-- gate_c13 -->
<g id="node265" class="node">
<title>gate_c13</title>
<path fill="none" stroke="black" d="M1218.5,-5170.25C1218.5,-5170.25 1019.5,-5170.25 1019.5,-5170.25 1013.5,-5170.25 1007.5,-5164.25 1007.5,-5158.25 1007.5,-5158.25 1007.5,-5129.25 1007.5,-5129.25 1007.5,-5123.25 1013.5,-5117.25 1019.5,-5117.25 1019.5,-5117.25 1218.5,-5117.25 1218.5,-5117.25 1224.5,-5117.25 1230.5,-5123.25 1230.5,-5129.25 1230.5,-5129.25 1230.5,-5158.25 1230.5,-5158.25 1230.5,-5164.25 1224.5,-5170.25 1218.5,-5170.25"/>
<text text-anchor="start" x="1015.5" y="-5155.05" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-5140.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-5125.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm13&#45;&gt;gate_c13 -->
<g id="edge259" class="edge">
<title>norm13&#45;&gt;gate_c13</title>
<path fill="none" stroke="black" d="M1119,-5206.12C1119,-5198.14 1119,-5189.19 1119,-5180.64"/>
<polygon fill="black" stroke="black" points="1122.5,-5180.5 1119,-5170.5 1115.5,-5180.5 1122.5,-5180.5"/>
</g>
<!-- gate_ar13 -->
<g id="node266" class="node">
<title>gate_ar13</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-5043.78" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-5055.08" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-5040.08" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-5025.08" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c13&#45;&gt;gate_ar13 -->
<g id="edge260" class="edge">
<title>gate_c13&#45;&gt;gate_ar13</title>
<path fill="none" stroke="black" d="M1119,-5117.01C1119,-5109.19 1119,-5100.33 1119,-5091.57"/>
<polygon fill="black" stroke="black" points="1122.5,-5091.4 1119,-5081.4 1115.5,-5091.4 1122.5,-5091.4"/>
</g>
<!-- route13 -->
<g id="node267" class="node">
<title>route13</title>
<path fill="none" stroke="black" d="M1310.41,-4970.3C1310.41,-4970.3 1010.83,-4970.3 1010.83,-4970.3 1004.83,-4970.3 995.13,-4965.58 991.42,-4960.86 991.42,-4960.86 923,-4873.74 923,-4873.74 919.3,-4869.02 921.59,-4864.3 927.59,-4864.3 927.59,-4864.3 1227.17,-4864.3 1227.17,-4864.3 1233.17,-4864.3 1242.87,-4869.02 1246.58,-4873.74 1246.58,-4873.74 1315,-4960.86 1315,-4960.86 1318.7,-4965.58 1316.41,-4970.3 1310.41,-4970.3"/>
<text text-anchor="start" x="957.26" y="-4928.6" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-4913.6" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-4898.6" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar13&#45;&gt;route13 -->
<g id="edge261" class="edge">
<title>gate_ar13&#45;&gt;route13</title>
<path fill="none" stroke="black" d="M1119,-5006.1C1119,-4998.06 1119,-4989.33 1119,-4980.6"/>
<polygon fill="black" stroke="black" points="1122.5,-4980.39 1119,-4970.39 1115.5,-4980.39 1122.5,-4980.39"/>
</g>
<!-- a2a_s13 -->
<g id="node268" class="node">
<title>a2a_s13</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-4790.82" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-4802.12" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-4787.12" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-4772.12" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route13&#45;&gt;a2a_s13 -->
<g id="edge262" class="edge">
<title>route13&#45;&gt;a2a_s13</title>
<path fill="none" stroke="black" d="M1119,-4864.23C1119,-4855.8 1119,-4847.11 1119,-4838.81"/>
<polygon fill="black" stroke="black" points="1122.5,-4838.55 1119,-4828.55 1115.5,-4838.55 1122.5,-4838.55"/>
</g>
<!-- exp13 -->
<g id="node269" class="node">
<title>exp13</title>
<path fill="none" stroke="black" d="M1233.5,-4717.35C1233.5,-4717.35 1004.5,-4717.35 1004.5,-4717.35 998.5,-4717.35 992.5,-4711.35 992.5,-4705.35 992.5,-4705.35 992.5,-4676.35 992.5,-4676.35 992.5,-4670.35 998.5,-4664.35 1004.5,-4664.35 1004.5,-4664.35 1233.5,-4664.35 1233.5,-4664.35 1239.5,-4664.35 1245.5,-4670.35 1245.5,-4676.35 1245.5,-4676.35 1245.5,-4705.35 1245.5,-4705.35 1245.5,-4711.35 1239.5,-4717.35 1233.5,-4717.35"/>
<text text-anchor="start" x="1000.5" y="-4702.15" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-4687.15" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-4672.15" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s13&#45;&gt;exp13 -->
<g id="edge263" class="edge">
<title>a2a_s13&#45;&gt;exp13</title>
<path fill="none" stroke="black" d="M1119,-4753.34C1119,-4744.92 1119,-4735.98 1119,-4727.6"/>
<polygon fill="black" stroke="black" points="1122.5,-4727.36 1119,-4717.36 1115.5,-4727.36 1122.5,-4727.36"/>
</g>
<!-- exp_ar13 -->
<g id="node270" class="node">
<title>exp_ar13</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-4590.87" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-4602.17" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-4587.17" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-4572.17" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp13&#45;&gt;exp_ar13 -->
<g id="edge264" class="edge">
<title>exp13&#45;&gt;exp_ar13</title>
<path fill="none" stroke="black" d="M1119,-4664.1C1119,-4656.28 1119,-4647.43 1119,-4638.67"/>
<polygon fill="black" stroke="black" points="1122.5,-4638.49 1119,-4628.49 1115.5,-4638.49 1122.5,-4638.49"/>
</g>
<!-- a2a_r13 -->
<g id="node271" class="node">
<title>a2a_r13</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-4479.92" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-4491.22" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-4476.22" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-4461.22" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar13&#45;&gt;a2a_r13 -->
<g id="edge265" class="edge">
<title>exp_ar13&#45;&gt;a2a_r13</title>
<path fill="none" stroke="black" d="M1119,-4553.29C1119,-4545.11 1119,-4536.33 1119,-4527.81"/>
<polygon fill="black" stroke="black" points="1122.5,-4527.59 1119,-4517.59 1115.5,-4527.59 1122.5,-4527.59"/>
</g>
<!-- agg13 -->
<g id="node272" class="node">
<title>agg13</title>
<path fill="none" stroke="black" d="M1308.26,-4406.44C1308.26,-4406.44 1012.1,-4406.44 1012.1,-4406.44 1006.1,-4406.44 996.42,-4401.7 992.74,-4396.96 992.74,-4396.96 925.1,-4309.92 925.1,-4309.92 921.42,-4305.18 923.74,-4300.44 929.74,-4300.44 929.74,-4300.44 1225.9,-4300.44 1225.9,-4300.44 1231.9,-4300.44 1241.58,-4305.18 1245.26,-4309.92 1245.26,-4309.92 1312.9,-4396.96 1312.9,-4396.96 1316.58,-4401.7 1314.26,-4406.44 1308.26,-4406.44"/>
<text text-anchor="start" x="958.99" y="-4364.74" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-4349.74" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-4334.74" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r13&#45;&gt;agg13 -->
<g id="edge266" class="edge">
<title>a2a_r13&#45;&gt;agg13</title>
<path fill="none" stroke="black" d="M1119,-4442.24C1119,-4434.2 1119,-4425.47 1119,-4416.74"/>
<polygon fill="black" stroke="black" points="1122.5,-4416.53 1119,-4406.53 1115.5,-4416.53 1122.5,-4416.53"/>
</g>
<!-- norm_m13 -->
<g id="node273" class="node">
<title>norm_m13</title>
<path fill="none" stroke="black" d="M1199,-4264.44C1199,-4264.44 1039,-4264.44 1039,-4264.44 1033,-4264.44 1027,-4258.44 1027,-4252.44 1027,-4252.44 1027,-4223.44 1027,-4223.44 1027,-4217.44 1033,-4211.44 1039,-4211.44 1039,-4211.44 1199,-4211.44 1199,-4211.44 1205,-4211.44 1211,-4217.44 1211,-4223.44 1211,-4223.44 1211,-4252.44 1211,-4252.44 1211,-4258.44 1205,-4264.44 1199,-4264.44"/>
<text text-anchor="start" x="1035" y="-4249.24" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-4234.24" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-4219.24" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg13&#45;&gt;norm_m13 -->
<g id="edge267" class="edge">
<title>agg13&#45;&gt;norm_m13</title>
<path fill="none" stroke="black" d="M1119,-4300.34C1119,-4291.67 1119,-4282.85 1119,-4274.71"/>
<polygon fill="black" stroke="black" points="1122.5,-4274.45 1119,-4264.45 1115.5,-4274.45 1122.5,-4274.45"/>
</g>
<!-- qkv_c14 -->
<g id="node274" class="node">
<title>qkv_c14</title>
<path fill="none" stroke="black" d="M1241,-4175.44C1241,-4175.44 997,-4175.44 997,-4175.44 991,-4175.44 985,-4169.44 985,-4163.44 985,-4163.44 985,-4134.44 985,-4134.44 985,-4128.44 991,-4122.44 997,-4122.44 997,-4122.44 1241,-4122.44 1241,-4122.44 1247,-4122.44 1253,-4128.44 1253,-4134.44 1253,-4134.44 1253,-4163.44 1253,-4163.44 1253,-4169.44 1247,-4175.44 1241,-4175.44"/>
<text text-anchor="start" x="993" y="-4160.24" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-4145.24" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-4130.24" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m13&#45;&gt;qkv_c14 -->
<g id="edge268" class="edge">
<title>norm_m13&#45;&gt;qkv_c14</title>
<path fill="none" stroke="black" d="M1119,-4211.31C1119,-4203.33 1119,-4194.37 1119,-4185.82"/>
<polygon fill="black" stroke="black" points="1122.5,-4185.69 1119,-4175.69 1115.5,-4185.69 1122.5,-4185.69"/>
</g>
<!-- qkv_ar14 -->
<g id="node275" class="node">
<title>qkv_ar14</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-4048.96" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-4060.26" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-4045.26" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-4030.26" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c14&#45;&gt;qkv_ar14 -->
<g id="edge269" class="edge">
<title>qkv_c14&#45;&gt;qkv_ar14</title>
<path fill="none" stroke="black" d="M1119,-4122.2C1119,-4114.37 1119,-4105.52 1119,-4096.76"/>
<polygon fill="black" stroke="black" points="1122.5,-4096.59 1119,-4086.59 1115.5,-4096.59 1122.5,-4096.59"/>
</g>
<!-- sph14 -->
<g id="node276" class="node">
<title>sph14</title>
<path fill="none" stroke="black" d="M1327.66,-3975.49C1327.66,-3975.49 1000.64,-3975.49 1000.64,-3975.49 994.64,-3975.49 984.75,-3970.92 980.86,-3966.35 980.86,-3966.35 906.12,-3878.62 906.12,-3878.62 902.23,-3874.05 904.34,-3869.49 910.34,-3869.49 910.34,-3869.49 1237.36,-3869.49 1237.36,-3869.49 1243.36,-3869.49 1253.25,-3874.05 1257.14,-3878.62 1257.14,-3878.62 1331.88,-3966.35 1331.88,-3966.35 1335.77,-3970.92 1333.66,-3975.49 1327.66,-3975.49"/>
<text text-anchor="start" x="942.54" y="-3933.79" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-3918.79" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-3903.79" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar14&#45;&gt;sph14 -->
<g id="edge270" class="edge">
<title>qkv_ar14&#45;&gt;sph14</title>
<path fill="none" stroke="black" d="M1119,-4011.29C1119,-4003.25 1119,-3994.52 1119,-3985.79"/>
<polygon fill="black" stroke="black" points="1122.5,-3985.58 1119,-3975.58 1115.5,-3985.58 1122.5,-3985.58"/>
</g>
<!-- sdp14 -->
<g id="node277" class="node">
<title>sdp14</title>
<path fill="none" stroke="black" d="M1220,-3833.49C1220,-3833.49 1018,-3833.49 1018,-3833.49 1012,-3833.49 1006,-3827.49 1006,-3821.49 1006,-3821.49 1006,-3792.49 1006,-3792.49 1006,-3786.49 1012,-3780.49 1018,-3780.49 1018,-3780.49 1220,-3780.49 1220,-3780.49 1226,-3780.49 1232,-3786.49 1232,-3792.49 1232,-3792.49 1232,-3821.49 1232,-3821.49 1232,-3827.49 1226,-3833.49 1220,-3833.49"/>
<text text-anchor="start" x="1014" y="-3818.29" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-3803.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-3788.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph14&#45;&gt;sdp14 -->
<g id="edge271" class="edge">
<title>sph14&#45;&gt;sdp14</title>
<path fill="none" stroke="black" d="M1119,-3869.39C1119,-3860.72 1119,-3851.9 1119,-3843.75"/>
<polygon fill="black" stroke="black" points="1122.5,-3843.5 1119,-3833.5 1115.5,-3843.5 1122.5,-3843.5"/>
</g>
<!-- sm14 -->
<g id="node278" class="node">
<title>sm14</title>
<path fill="none" stroke="black" d="M1182.5,-3744.49C1182.5,-3744.49 1055.5,-3744.49 1055.5,-3744.49 1049.5,-3744.49 1043.5,-3738.49 1043.5,-3732.49 1043.5,-3732.49 1043.5,-3703.49 1043.5,-3703.49 1043.5,-3697.49 1049.5,-3691.49 1055.5,-3691.49 1055.5,-3691.49 1182.5,-3691.49 1182.5,-3691.49 1188.5,-3691.49 1194.5,-3697.49 1194.5,-3703.49 1194.5,-3703.49 1194.5,-3732.49 1194.5,-3732.49 1194.5,-3738.49 1188.5,-3744.49 1182.5,-3744.49"/>
<text text-anchor="start" x="1051.5" y="-3729.29" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-3714.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-3699.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp14&#45;&gt;sm14 -->
<g id="edge272" class="edge">
<title>sdp14&#45;&gt;sm14</title>
<path fill="none" stroke="black" d="M1119,-3780.35C1119,-3772.37 1119,-3763.42 1119,-3754.87"/>
<polygon fill="black" stroke="black" points="1122.5,-3754.74 1119,-3744.74 1115.5,-3754.74 1122.5,-3754.74"/>
</g>
<!-- do14 -->
<g id="node279" class="node">
<title>do14</title>
<path fill="none" stroke="black" d="M1166.5,-3655.49C1166.5,-3655.49 1071.5,-3655.49 1071.5,-3655.49 1065.5,-3655.49 1059.5,-3649.49 1059.5,-3643.49 1059.5,-3643.49 1059.5,-3614.49 1059.5,-3614.49 1059.5,-3608.49 1065.5,-3602.49 1071.5,-3602.49 1071.5,-3602.49 1166.5,-3602.49 1166.5,-3602.49 1172.5,-3602.49 1178.5,-3608.49 1178.5,-3614.49 1178.5,-3614.49 1178.5,-3643.49 1178.5,-3643.49 1178.5,-3649.49 1172.5,-3655.49 1166.5,-3655.49"/>
<text text-anchor="start" x="1067.5" y="-3640.29" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-3625.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-3610.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm14&#45;&gt;do14 -->
<g id="edge273" class="edge">
<title>sm14&#45;&gt;do14</title>
<path fill="none" stroke="black" d="M1119,-3691.35C1119,-3683.37 1119,-3674.42 1119,-3665.87"/>
<polygon fill="black" stroke="black" points="1122.5,-3665.74 1119,-3655.74 1115.5,-3665.74 1122.5,-3665.74"/>
</g>
<!-- mgh14 -->
<g id="node280" class="node">
<title>mgh14</title>
<path fill="none" stroke="black" d="M1323.86,-3566.49C1323.86,-3566.49 1002.88,-3566.49 1002.88,-3566.49 996.88,-3566.49 987.03,-3561.89 983.18,-3557.29 983.18,-3557.29 909.84,-3469.69 909.84,-3469.69 905.99,-3465.09 908.14,-3460.49 914.14,-3460.49 914.14,-3460.49 1235.12,-3460.49 1235.12,-3460.49 1241.12,-3460.49 1250.97,-3465.09 1254.82,-3469.69 1254.82,-3469.69 1328.16,-3557.29 1328.16,-3557.29 1332.01,-3561.89 1329.86,-3566.49 1323.86,-3566.49"/>
<text text-anchor="start" x="946" y="-3524.79" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-3509.79" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-3494.79" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do14&#45;&gt;mgh14 -->
<g id="edge274" class="edge">
<title>do14&#45;&gt;mgh14</title>
<path fill="none" stroke="black" d="M1119,-3602.23C1119,-3594.53 1119,-3585.74 1119,-3576.75"/>
<polygon fill="black" stroke="black" points="1122.5,-3576.58 1119,-3566.58 1115.5,-3576.58 1122.5,-3576.58"/>
</g>
<!-- proj_r14 -->
<g id="node281" class="node">
<title>proj_r14</title>
<path fill="none" stroke="black" d="M1219,-3424.49C1219,-3424.49 1019,-3424.49 1019,-3424.49 1013,-3424.49 1007,-3418.49 1007,-3412.49 1007,-3412.49 1007,-3383.49 1007,-3383.49 1007,-3377.49 1013,-3371.49 1019,-3371.49 1019,-3371.49 1219,-3371.49 1219,-3371.49 1225,-3371.49 1231,-3377.49 1231,-3383.49 1231,-3383.49 1231,-3412.49 1231,-3412.49 1231,-3418.49 1225,-3424.49 1219,-3424.49"/>
<text text-anchor="start" x="1015" y="-3409.29" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-3394.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-3379.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh14&#45;&gt;proj_r14 -->
<g id="edge275" class="edge">
<title>mgh14&#45;&gt;proj_r14</title>
<path fill="none" stroke="black" d="M1119,-3460.39C1119,-3451.72 1119,-3442.9 1119,-3434.75"/>
<polygon fill="black" stroke="black" points="1122.5,-3434.5 1119,-3424.5 1115.5,-3434.5 1122.5,-3434.5"/>
</g>
<!-- proj_ar14 -->
<g id="node282" class="node">
<title>proj_ar14</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-3298.01" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-3309.31" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-3294.31" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-3279.31" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r14&#45;&gt;proj_ar14 -->
<g id="edge276" class="edge">
<title>proj_r14&#45;&gt;proj_ar14</title>
<path fill="none" stroke="black" d="M1119,-3371.24C1119,-3363.42 1119,-3354.57 1119,-3345.81"/>
<polygon fill="black" stroke="black" points="1122.5,-3345.63 1119,-3335.63 1115.5,-3345.63 1122.5,-3345.63"/>
</g>
<!-- norm14 -->
<g id="node283" class="node">
<title>norm14</title>
<path fill="none" stroke="black" d="M1204,-3224.53C1204,-3224.53 1034,-3224.53 1034,-3224.53 1028,-3224.53 1022,-3218.53 1022,-3212.53 1022,-3212.53 1022,-3183.53 1022,-3183.53 1022,-3177.53 1028,-3171.53 1034,-3171.53 1034,-3171.53 1204,-3171.53 1204,-3171.53 1210,-3171.53 1216,-3177.53 1216,-3183.53 1216,-3183.53 1216,-3212.53 1216,-3212.53 1216,-3218.53 1210,-3224.53 1204,-3224.53"/>
<text text-anchor="start" x="1030" y="-3209.33" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-3194.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-3179.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar14&#45;&gt;norm14 -->
<g id="edge277" class="edge">
<title>proj_ar14&#45;&gt;norm14</title>
<path fill="none" stroke="black" d="M1119,-3260.53C1119,-3252.11 1119,-3243.17 1119,-3234.78"/>
<polygon fill="black" stroke="black" points="1122.5,-3234.54 1119,-3224.54 1115.5,-3234.54 1122.5,-3234.54"/>
</g>
<!-- gate_c14 -->
<g id="node284" class="node">
<title>gate_c14</title>
<path fill="none" stroke="black" d="M1218.5,-3135.53C1218.5,-3135.53 1019.5,-3135.53 1019.5,-3135.53 1013.5,-3135.53 1007.5,-3129.53 1007.5,-3123.53 1007.5,-3123.53 1007.5,-3094.53 1007.5,-3094.53 1007.5,-3088.53 1013.5,-3082.53 1019.5,-3082.53 1019.5,-3082.53 1218.5,-3082.53 1218.5,-3082.53 1224.5,-3082.53 1230.5,-3088.53 1230.5,-3094.53 1230.5,-3094.53 1230.5,-3123.53 1230.5,-3123.53 1230.5,-3129.53 1224.5,-3135.53 1218.5,-3135.53"/>
<text text-anchor="start" x="1015.5" y="-3120.33" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-3105.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-3090.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm14&#45;&gt;gate_c14 -->
<g id="edge278" class="edge">
<title>norm14&#45;&gt;gate_c14</title>
<path fill="none" stroke="black" d="M1119,-3171.4C1119,-3163.42 1119,-3154.47 1119,-3145.92"/>
<polygon fill="black" stroke="black" points="1122.5,-3145.78 1119,-3135.78 1115.5,-3145.78 1122.5,-3145.78"/>
</g>
<!-- gate_ar14 -->
<g id="node285" class="node">
<title>gate_ar14</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-3009.06" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-3020.36" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-3005.36" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-2990.36" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c14&#45;&gt;gate_ar14 -->
<g id="edge279" class="edge">
<title>gate_c14&#45;&gt;gate_ar14</title>
<path fill="none" stroke="black" d="M1119,-3082.29C1119,-3074.47 1119,-3065.61 1119,-3056.85"/>
<polygon fill="black" stroke="black" points="1122.5,-3056.68 1119,-3046.68 1115.5,-3056.68 1122.5,-3056.68"/>
</g>
<!-- route14 -->
<g id="node286" class="node">
<title>route14</title>
<path fill="none" stroke="black" d="M1310.41,-2935.58C1310.41,-2935.58 1010.83,-2935.58 1010.83,-2935.58 1004.83,-2935.58 995.13,-2930.86 991.42,-2926.14 991.42,-2926.14 923,-2839.02 923,-2839.02 919.3,-2834.3 921.59,-2829.58 927.59,-2829.58 927.59,-2829.58 1227.17,-2829.58 1227.17,-2829.58 1233.17,-2829.58 1242.87,-2834.3 1246.58,-2839.02 1246.58,-2839.02 1315,-2926.14 1315,-2926.14 1318.7,-2930.86 1316.41,-2935.58 1310.41,-2935.58"/>
<text text-anchor="start" x="957.26" y="-2893.88" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-2878.88" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-2863.88" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar14&#45;&gt;route14 -->
<g id="edge280" class="edge">
<title>gate_ar14&#45;&gt;route14</title>
<path fill="none" stroke="black" d="M1119,-2971.38C1119,-2963.34 1119,-2954.61 1119,-2945.88"/>
<polygon fill="black" stroke="black" points="1122.5,-2945.67 1119,-2935.67 1115.5,-2945.67 1122.5,-2945.67"/>
</g>
<!-- a2a_s14 -->
<g id="node287" class="node">
<title>a2a_s14</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-2756.1" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-2767.4" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-2752.4" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-2737.4" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route14&#45;&gt;a2a_s14 -->
<g id="edge281" class="edge">
<title>route14&#45;&gt;a2a_s14</title>
<path fill="none" stroke="black" d="M1119,-2829.51C1119,-2821.08 1119,-2812.39 1119,-2804.09"/>
<polygon fill="black" stroke="black" points="1122.5,-2803.83 1119,-2793.83 1115.5,-2803.83 1122.5,-2803.83"/>
</g>
<!-- exp14 -->
<g id="node288" class="node">
<title>exp14</title>
<path fill="none" stroke="black" d="M1233.5,-2682.63C1233.5,-2682.63 1004.5,-2682.63 1004.5,-2682.63 998.5,-2682.63 992.5,-2676.63 992.5,-2670.63 992.5,-2670.63 992.5,-2641.63 992.5,-2641.63 992.5,-2635.63 998.5,-2629.63 1004.5,-2629.63 1004.5,-2629.63 1233.5,-2629.63 1233.5,-2629.63 1239.5,-2629.63 1245.5,-2635.63 1245.5,-2641.63 1245.5,-2641.63 1245.5,-2670.63 1245.5,-2670.63 1245.5,-2676.63 1239.5,-2682.63 1233.5,-2682.63"/>
<text text-anchor="start" x="1000.5" y="-2667.43" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-2652.43" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-2637.43" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s14&#45;&gt;exp14 -->
<g id="edge282" class="edge">
<title>a2a_s14&#45;&gt;exp14</title>
<path fill="none" stroke="black" d="M1119,-2718.62C1119,-2710.2 1119,-2701.26 1119,-2692.88"/>
<polygon fill="black" stroke="black" points="1122.5,-2692.64 1119,-2682.64 1115.5,-2692.64 1122.5,-2692.64"/>
</g>
<!-- exp_ar14 -->
<g id="node289" class="node">
<title>exp_ar14</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-2556.15" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-2567.45" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-2552.45" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-2537.45" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp14&#45;&gt;exp_ar14 -->
<g id="edge283" class="edge">
<title>exp14&#45;&gt;exp_ar14</title>
<path fill="none" stroke="black" d="M1119,-2629.38C1119,-2621.56 1119,-2612.71 1119,-2603.95"/>
<polygon fill="black" stroke="black" points="1122.5,-2603.77 1119,-2593.77 1115.5,-2603.77 1122.5,-2603.77"/>
</g>
<!-- a2a_r14 -->
<g id="node290" class="node">
<title>a2a_r14</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-2445.2" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-2456.5" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-2441.5" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-2426.5" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar14&#45;&gt;a2a_r14 -->
<g id="edge284" class="edge">
<title>exp_ar14&#45;&gt;a2a_r14</title>
<path fill="none" stroke="black" d="M1119,-2518.57C1119,-2510.39 1119,-2501.61 1119,-2493.09"/>
<polygon fill="black" stroke="black" points="1122.5,-2492.87 1119,-2482.87 1115.5,-2492.87 1122.5,-2492.87"/>
</g>
<!-- agg14 -->
<g id="node291" class="node">
<title>agg14</title>
<path fill="none" stroke="black" d="M1308.26,-2371.72C1308.26,-2371.72 1012.1,-2371.72 1012.1,-2371.72 1006.1,-2371.72 996.42,-2366.98 992.74,-2362.24 992.74,-2362.24 925.1,-2275.2 925.1,-2275.2 921.42,-2270.46 923.74,-2265.72 929.74,-2265.72 929.74,-2265.72 1225.9,-2265.72 1225.9,-2265.72 1231.9,-2265.72 1241.58,-2270.46 1245.26,-2275.2 1245.26,-2275.2 1312.9,-2362.24 1312.9,-2362.24 1316.58,-2366.98 1314.26,-2371.72 1308.26,-2371.72"/>
<text text-anchor="start" x="958.99" y="-2330.02" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-2315.02" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-2300.02" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r14&#45;&gt;agg14 -->
<g id="edge285" class="edge">
<title>a2a_r14&#45;&gt;agg14</title>
<path fill="none" stroke="black" d="M1119,-2407.52C1119,-2399.48 1119,-2390.75 1119,-2382.02"/>
<polygon fill="black" stroke="black" points="1122.5,-2381.81 1119,-2371.81 1115.5,-2381.81 1122.5,-2381.81"/>
</g>
<!-- norm_m14 -->
<g id="node292" class="node">
<title>norm_m14</title>
<path fill="none" stroke="black" d="M1199,-2229.72C1199,-2229.72 1039,-2229.72 1039,-2229.72 1033,-2229.72 1027,-2223.72 1027,-2217.72 1027,-2217.72 1027,-2188.72 1027,-2188.72 1027,-2182.72 1033,-2176.72 1039,-2176.72 1039,-2176.72 1199,-2176.72 1199,-2176.72 1205,-2176.72 1211,-2182.72 1211,-2188.72 1211,-2188.72 1211,-2217.72 1211,-2217.72 1211,-2223.72 1205,-2229.72 1199,-2229.72"/>
<text text-anchor="start" x="1035" y="-2214.52" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-2199.52" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-2184.52" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg14&#45;&gt;norm_m14 -->
<g id="edge286" class="edge">
<title>agg14&#45;&gt;norm_m14</title>
<path fill="none" stroke="black" d="M1119,-2265.62C1119,-2256.95 1119,-2248.13 1119,-2239.99"/>
<polygon fill="black" stroke="black" points="1122.5,-2239.73 1119,-2229.73 1115.5,-2239.73 1122.5,-2239.73"/>
</g>
<!-- qkv_c15 -->
<g id="node293" class="node">
<title>qkv_c15</title>
<path fill="none" stroke="black" d="M1241,-2140.72C1241,-2140.72 997,-2140.72 997,-2140.72 991,-2140.72 985,-2134.72 985,-2128.72 985,-2128.72 985,-2099.72 985,-2099.72 985,-2093.72 991,-2087.72 997,-2087.72 997,-2087.72 1241,-2087.72 1241,-2087.72 1247,-2087.72 1253,-2093.72 1253,-2099.72 1253,-2099.72 1253,-2128.72 1253,-2128.72 1253,-2134.72 1247,-2140.72 1241,-2140.72"/>
<text text-anchor="start" x="993" y="-2125.52" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="993" y="-2110.52" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="993" y="-2095.52" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m14&#45;&gt;qkv_c15 -->
<g id="edge287" class="edge">
<title>norm_m14&#45;&gt;qkv_c15</title>
<path fill="none" stroke="black" d="M1119,-2176.59C1119,-2168.61 1119,-2159.65 1119,-2151.1"/>
<polygon fill="black" stroke="black" points="1122.5,-2150.97 1119,-2140.97 1115.5,-2150.97 1122.5,-2150.97"/>
</g>
<!-- qkv_ar15 -->
<g id="node294" class="node">
<title>qkv_ar15</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-2014.24" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="1026.5" y="-2025.54" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="1026.5" y="-2010.54" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="1026.5" y="-1995.54" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c15&#45;&gt;qkv_ar15 -->
<g id="edge288" class="edge">
<title>qkv_c15&#45;&gt;qkv_ar15</title>
<path fill="none" stroke="black" d="M1119,-2087.48C1119,-2079.65 1119,-2070.8 1119,-2062.04"/>
<polygon fill="black" stroke="black" points="1122.5,-2061.87 1119,-2051.87 1115.5,-2061.87 1122.5,-2061.87"/>
</g>
<!-- sph15 -->
<g id="node295" class="node">
<title>sph15</title>
<path fill="none" stroke="black" d="M1327.66,-1940.77C1327.66,-1940.77 1000.64,-1940.77 1000.64,-1940.77 994.64,-1940.77 984.75,-1936.2 980.86,-1931.63 980.86,-1931.63 906.12,-1843.9 906.12,-1843.9 902.23,-1839.33 904.34,-1834.77 910.34,-1834.77 910.34,-1834.77 1237.36,-1834.77 1237.36,-1834.77 1243.36,-1834.77 1253.25,-1839.33 1257.14,-1843.9 1257.14,-1843.9 1331.88,-1931.63 1331.88,-1931.63 1335.77,-1936.2 1333.66,-1940.77 1327.66,-1940.77"/>
<text text-anchor="start" x="942.54" y="-1899.07" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="942.54" y="-1884.07" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="942.54" y="-1869.07" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar15&#45;&gt;sph15 -->
<g id="edge289" class="edge">
<title>qkv_ar15&#45;&gt;sph15</title>
<path fill="none" stroke="black" d="M1119,-1976.57C1119,-1968.53 1119,-1959.8 1119,-1951.07"/>
<polygon fill="black" stroke="black" points="1122.5,-1950.86 1119,-1940.86 1115.5,-1950.86 1122.5,-1950.86"/>
</g>
<!-- sdp15 -->
<g id="node296" class="node">
<title>sdp15</title>
<path fill="none" stroke="black" d="M1220,-1798.77C1220,-1798.77 1018,-1798.77 1018,-1798.77 1012,-1798.77 1006,-1792.77 1006,-1786.77 1006,-1786.77 1006,-1757.77 1006,-1757.77 1006,-1751.77 1012,-1745.77 1018,-1745.77 1018,-1745.77 1220,-1745.77 1220,-1745.77 1226,-1745.77 1232,-1751.77 1232,-1757.77 1232,-1757.77 1232,-1786.77 1232,-1786.77 1232,-1792.77 1226,-1798.77 1220,-1798.77"/>
<text text-anchor="start" x="1014" y="-1783.57" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="1014" y="-1768.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="1014" y="-1753.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph15&#45;&gt;sdp15 -->
<g id="edge290" class="edge">
<title>sph15&#45;&gt;sdp15</title>
<path fill="none" stroke="black" d="M1119,-1834.67C1119,-1826 1119,-1817.18 1119,-1809.03"/>
<polygon fill="black" stroke="black" points="1122.5,-1808.78 1119,-1798.78 1115.5,-1808.78 1122.5,-1808.78"/>
</g>
<!-- sm15 -->
<g id="node297" class="node">
<title>sm15</title>
<path fill="none" stroke="black" d="M1182.5,-1709.77C1182.5,-1709.77 1055.5,-1709.77 1055.5,-1709.77 1049.5,-1709.77 1043.5,-1703.77 1043.5,-1697.77 1043.5,-1697.77 1043.5,-1668.77 1043.5,-1668.77 1043.5,-1662.77 1049.5,-1656.77 1055.5,-1656.77 1055.5,-1656.77 1182.5,-1656.77 1182.5,-1656.77 1188.5,-1656.77 1194.5,-1662.77 1194.5,-1668.77 1194.5,-1668.77 1194.5,-1697.77 1194.5,-1697.77 1194.5,-1703.77 1188.5,-1709.77 1182.5,-1709.77"/>
<text text-anchor="start" x="1051.5" y="-1694.57" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="1051.5" y="-1679.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1051.5" y="-1664.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp15&#45;&gt;sm15 -->
<g id="edge291" class="edge">
<title>sdp15&#45;&gt;sm15</title>
<path fill="none" stroke="black" d="M1119,-1745.63C1119,-1737.65 1119,-1728.7 1119,-1720.15"/>
<polygon fill="black" stroke="black" points="1122.5,-1720.02 1119,-1710.02 1115.5,-1720.02 1122.5,-1720.02"/>
</g>
<!-- do15 -->
<g id="node298" class="node">
<title>do15</title>
<path fill="none" stroke="black" d="M1166.5,-1620.77C1166.5,-1620.77 1071.5,-1620.77 1071.5,-1620.77 1065.5,-1620.77 1059.5,-1614.77 1059.5,-1608.77 1059.5,-1608.77 1059.5,-1579.77 1059.5,-1579.77 1059.5,-1573.77 1065.5,-1567.77 1071.5,-1567.77 1071.5,-1567.77 1166.5,-1567.77 1166.5,-1567.77 1172.5,-1567.77 1178.5,-1573.77 1178.5,-1579.77 1178.5,-1579.77 1178.5,-1608.77 1178.5,-1608.77 1178.5,-1614.77 1172.5,-1620.77 1166.5,-1620.77"/>
<text text-anchor="start" x="1067.5" y="-1605.57" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="1067.5" y="-1590.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1067.5" y="-1575.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm15&#45;&gt;do15 -->
<g id="edge292" class="edge">
<title>sm15&#45;&gt;do15</title>
<path fill="none" stroke="black" d="M1119,-1656.63C1119,-1648.65 1119,-1639.7 1119,-1631.15"/>
<polygon fill="black" stroke="black" points="1122.5,-1631.02 1119,-1621.02 1115.5,-1631.02 1122.5,-1631.02"/>
</g>
<!-- mgh15 -->
<g id="node299" class="node">
<title>mgh15</title>
<path fill="none" stroke="black" d="M1323.86,-1531.77C1323.86,-1531.77 1002.88,-1531.77 1002.88,-1531.77 996.88,-1531.77 987.03,-1527.17 983.18,-1522.57 983.18,-1522.57 909.84,-1434.97 909.84,-1434.97 905.99,-1430.37 908.14,-1425.77 914.14,-1425.77 914.14,-1425.77 1235.12,-1425.77 1235.12,-1425.77 1241.12,-1425.77 1250.97,-1430.37 1254.82,-1434.97 1254.82,-1434.97 1328.16,-1522.57 1328.16,-1522.57 1332.01,-1527.17 1329.86,-1531.77 1323.86,-1531.77"/>
<text text-anchor="start" x="946" y="-1490.07" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="946" y="-1475.07" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="946" y="-1460.07" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do15&#45;&gt;mgh15 -->
<g id="edge293" class="edge">
<title>do15&#45;&gt;mgh15</title>
<path fill="none" stroke="black" d="M1119,-1567.51C1119,-1559.81 1119,-1551.02 1119,-1542.04"/>
<polygon fill="black" stroke="black" points="1122.5,-1541.86 1119,-1531.86 1115.5,-1541.86 1122.5,-1541.86"/>
</g>
<!-- proj_r15 -->
<g id="node300" class="node">
<title>proj_r15</title>
<path fill="none" stroke="black" d="M1219,-1389.77C1219,-1389.77 1019,-1389.77 1019,-1389.77 1013,-1389.77 1007,-1383.77 1007,-1377.77 1007,-1377.77 1007,-1348.77 1007,-1348.77 1007,-1342.77 1013,-1336.77 1019,-1336.77 1019,-1336.77 1219,-1336.77 1219,-1336.77 1225,-1336.77 1231,-1342.77 1231,-1348.77 1231,-1348.77 1231,-1377.77 1231,-1377.77 1231,-1383.77 1225,-1389.77 1219,-1389.77"/>
<text text-anchor="start" x="1015" y="-1374.57" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015" y="-1359.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015" y="-1344.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh15&#45;&gt;proj_r15 -->
<g id="edge294" class="edge">
<title>mgh15&#45;&gt;proj_r15</title>
<path fill="none" stroke="black" d="M1119,-1425.67C1119,-1417 1119,-1408.18 1119,-1400.03"/>
<polygon fill="black" stroke="black" points="1122.5,-1399.78 1119,-1389.78 1115.5,-1399.78 1122.5,-1399.78"/>
</g>
<!-- proj_ar15 -->
<g id="node301" class="node">
<title>proj_ar15</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-1263.29" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="1039" y="-1274.59" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="1039" y="-1259.59" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="1039" y="-1244.59" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r15&#45;&gt;proj_ar15 -->
<g id="edge295" class="edge">
<title>proj_r15&#45;&gt;proj_ar15</title>
<path fill="none" stroke="black" d="M1119,-1336.52C1119,-1328.7 1119,-1319.85 1119,-1311.09"/>
<polygon fill="black" stroke="black" points="1122.5,-1310.91 1119,-1300.91 1115.5,-1310.91 1122.5,-1310.91"/>
</g>
<!-- norm15 -->
<g id="node302" class="node">
<title>norm15</title>
<path fill="none" stroke="black" d="M1204,-1189.81C1204,-1189.81 1034,-1189.81 1034,-1189.81 1028,-1189.81 1022,-1183.81 1022,-1177.81 1022,-1177.81 1022,-1148.81 1022,-1148.81 1022,-1142.81 1028,-1136.81 1034,-1136.81 1034,-1136.81 1204,-1136.81 1204,-1136.81 1210,-1136.81 1216,-1142.81 1216,-1148.81 1216,-1148.81 1216,-1177.81 1216,-1177.81 1216,-1183.81 1210,-1189.81 1204,-1189.81"/>
<text text-anchor="start" x="1030" y="-1174.61" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="1030" y="-1159.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1030" y="-1144.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar15&#45;&gt;norm15 -->
<g id="edge296" class="edge">
<title>proj_ar15&#45;&gt;norm15</title>
<path fill="none" stroke="black" d="M1119,-1225.81C1119,-1217.39 1119,-1208.45 1119,-1200.06"/>
<polygon fill="black" stroke="black" points="1122.5,-1199.82 1119,-1189.82 1115.5,-1199.82 1122.5,-1199.82"/>
</g>
<!-- gate_c15 -->
<g id="node303" class="node">
<title>gate_c15</title>
<path fill="none" stroke="black" d="M1218.5,-1100.81C1218.5,-1100.81 1019.5,-1100.81 1019.5,-1100.81 1013.5,-1100.81 1007.5,-1094.81 1007.5,-1088.81 1007.5,-1088.81 1007.5,-1059.81 1007.5,-1059.81 1007.5,-1053.81 1013.5,-1047.81 1019.5,-1047.81 1019.5,-1047.81 1218.5,-1047.81 1218.5,-1047.81 1224.5,-1047.81 1230.5,-1053.81 1230.5,-1059.81 1230.5,-1059.81 1230.5,-1088.81 1230.5,-1088.81 1230.5,-1094.81 1224.5,-1100.81 1218.5,-1100.81"/>
<text text-anchor="start" x="1015.5" y="-1085.61" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1015.5" y="-1070.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1015.5" y="-1055.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm15&#45;&gt;gate_c15 -->
<g id="edge297" class="edge">
<title>norm15&#45;&gt;gate_c15</title>
<path fill="none" stroke="black" d="M1119,-1136.68C1119,-1128.7 1119,-1119.75 1119,-1111.2"/>
<polygon fill="black" stroke="black" points="1122.5,-1111.06 1119,-1101.06 1115.5,-1111.06 1122.5,-1111.06"/>
</g>
<!-- gate_ar15 -->
<g id="node304" class="node">
<title>gate_ar15</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-974.34" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="1048" y="-985.64" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="1048" y="-970.64" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1048" y="-955.64" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c15&#45;&gt;gate_ar15 -->
<g id="edge298" class="edge">
<title>gate_c15&#45;&gt;gate_ar15</title>
<path fill="none" stroke="black" d="M1119,-1047.57C1119,-1039.75 1119,-1030.89 1119,-1022.13"/>
<polygon fill="black" stroke="black" points="1122.5,-1021.96 1119,-1011.96 1115.5,-1021.96 1122.5,-1021.96"/>
</g>
<!-- route15 -->
<g id="node305" class="node">
<title>route15</title>
<path fill="none" stroke="black" d="M1310.41,-900.86C1310.41,-900.86 1010.83,-900.86 1010.83,-900.86 1004.83,-900.86 995.13,-896.14 991.42,-891.42 991.42,-891.42 923,-804.3 923,-804.3 919.3,-799.58 921.59,-794.86 927.59,-794.86 927.59,-794.86 1227.17,-794.86 1227.17,-794.86 1233.17,-794.86 1242.87,-799.58 1246.58,-804.3 1246.58,-804.3 1315,-891.42 1315,-891.42 1318.7,-896.14 1316.41,-900.86 1310.41,-900.86"/>
<text text-anchor="start" x="957.26" y="-859.16" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="957.26" y="-844.16" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="957.26" y="-829.16" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar15&#45;&gt;route15 -->
<g id="edge299" class="edge">
<title>gate_ar15&#45;&gt;route15</title>
<path fill="none" stroke="black" d="M1119,-936.66C1119,-928.62 1119,-919.89 1119,-911.16"/>
<polygon fill="black" stroke="black" points="1122.5,-910.95 1119,-900.95 1115.5,-910.95 1122.5,-910.95"/>
</g>
<!-- a2a_s15 -->
<g id="node306" class="node">
<title>a2a_s15</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-721.38" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1005.5" y="-732.68" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1005.5" y="-717.68" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1005.5" y="-702.68" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route15&#45;&gt;a2a_s15 -->
<g id="edge300" class="edge">
<title>route15&#45;&gt;a2a_s15</title>
<path fill="none" stroke="black" d="M1119,-794.79C1119,-786.36 1119,-777.67 1119,-769.37"/>
<polygon fill="black" stroke="black" points="1122.5,-769.11 1119,-759.11 1115.5,-769.11 1122.5,-769.11"/>
</g>
<!-- exp15 -->
<g id="node307" class="node">
<title>exp15</title>
<path fill="none" stroke="black" d="M1233.5,-647.91C1233.5,-647.91 1004.5,-647.91 1004.5,-647.91 998.5,-647.91 992.5,-641.91 992.5,-635.91 992.5,-635.91 992.5,-606.91 992.5,-606.91 992.5,-600.91 998.5,-594.91 1004.5,-594.91 1004.5,-594.91 1233.5,-594.91 1233.5,-594.91 1239.5,-594.91 1245.5,-600.91 1245.5,-606.91 1245.5,-606.91 1245.5,-635.91 1245.5,-635.91 1245.5,-641.91 1239.5,-647.91 1233.5,-647.91"/>
<text text-anchor="start" x="1000.5" y="-632.71" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1000.5" y="-617.71" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1000.5" y="-602.71" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s15&#45;&gt;exp15 -->
<g id="edge301" class="edge">
<title>a2a_s15&#45;&gt;exp15</title>
<path fill="none" stroke="black" d="M1119,-683.9C1119,-675.48 1119,-666.54 1119,-658.16"/>
<polygon fill="black" stroke="black" points="1122.5,-657.92 1119,-647.92 1115.5,-657.92 1122.5,-657.92"/>
</g>
<!-- exp_ar15 -->
<g id="node308" class="node">
<title>exp_ar15</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-521.43" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="1041" y="-532.73" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="1041" y="-517.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1041" y="-502.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp15&#45;&gt;exp_ar15 -->
<g id="edge302" class="edge">
<title>exp15&#45;&gt;exp_ar15</title>
<path fill="none" stroke="black" d="M1119,-594.66C1119,-586.84 1119,-577.99 1119,-569.23"/>
<polygon fill="black" stroke="black" points="1122.5,-569.05 1119,-559.05 1115.5,-569.05 1122.5,-569.05"/>
</g>
<!-- a2a_r15 -->
<g id="node309" class="node">
<title>a2a_r15</title>
<ellipse fill="none" stroke="black" cx="1119" cy="-410.48" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="1022.5" y="-421.78" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="1022.5" y="-406.78" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="1022.5" y="-391.78" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar15&#45;&gt;a2a_r15 -->
<g id="edge303" class="edge">
<title>exp_ar15&#45;&gt;a2a_r15</title>
<path fill="none" stroke="black" d="M1119,-483.85C1119,-475.67 1119,-466.89 1119,-458.37"/>
<polygon fill="black" stroke="black" points="1122.5,-458.15 1119,-448.15 1115.5,-458.15 1122.5,-458.15"/>
</g>
<!-- agg15 -->
<g id="node310" class="node">
<title>agg15</title>
<path fill="none" stroke="black" d="M1308.26,-337C1308.26,-337 1012.1,-337 1012.1,-337 1006.1,-337 996.42,-332.26 992.74,-327.52 992.74,-327.52 925.1,-240.48 925.1,-240.48 921.42,-235.74 923.74,-231 929.74,-231 929.74,-231 1225.9,-231 1225.9,-231 1231.9,-231 1241.58,-235.74 1245.26,-240.48 1245.26,-240.48 1312.9,-327.52 1312.9,-327.52 1316.58,-332.26 1314.26,-337 1308.26,-337"/>
<text text-anchor="start" x="958.99" y="-295.3" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="958.99" y="-280.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-265.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r15&#45;&gt;agg15 -->
<g id="edge304" class="edge">
<title>a2a_r15&#45;&gt;agg15</title>
<path fill="none" stroke="black" d="M1119,-372.8C1119,-364.76 1119,-356.03 1119,-347.3"/>
<polygon fill="black" stroke="black" points="1122.5,-347.09 1119,-337.09 1115.5,-347.09 1122.5,-347.09"/>
</g>
<!-- norm_m15 -->
<g id="node311" class="node">
<title>norm_m15</title>
<path fill="none" stroke="black" d="M1199,-195C1199,-195 1039,-195 1039,-195 1033,-195 1027,-189 1027,-183 1027,-183 1027,-154 1027,-154 1027,-148 1033,-142 1039,-142 1039,-142 1199,-142 1199,-142 1205,-142 1211,-148 1211,-154 1211,-154 1211,-183 1211,-183 1211,-189 1205,-195 1199,-195"/>
<text text-anchor="start" x="1035" y="-179.8" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="1035" y="-164.8" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1035" y="-149.8" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg15&#45;&gt;norm_m15 -->
<g id="edge305" class="edge">
<title>agg15&#45;&gt;norm_m15</title>
<path fill="none" stroke="black" d="M1119,-230.9C1119,-222.23 1119,-213.41 1119,-205.27"/>
<polygon fill="black" stroke="black" points="1122.5,-205.01 1119,-195.01 1115.5,-205.01 1122.5,-205.01"/>
</g>
<!-- output -->
<g id="node312" class="node">
<title>output</title>
<path fill="none" stroke="black" d="M1308.26,-106C1308.26,-106 1012.1,-106 1012.1,-106 1006.1,-106 996.42,-101.26 992.74,-96.52 992.74,-96.52 925.1,-9.48 925.1,-9.48 921.42,-4.74 923.74,0 929.74,0 929.74,0 1225.9,0 1225.9,0 1231.9,0 1241.58,-4.74 1245.26,-9.48 1245.26,-9.48 1312.9,-96.52 1312.9,-96.52 1316.58,-101.26 1314.26,-106 1308.26,-106"/>
<text text-anchor="start" x="958.99" y="-64.3" font-family="Helvetica,sans-Serif" font-size="14.00">Aggregate Final Hidden</text>
<text text-anchor="start" x="958.99" y="-49.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="958.99" y="-34.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- norm_m15&#45;&gt;output -->
<g id="edge309" class="edge">
<title>norm_m15&#45;&gt;output</title>
<path fill="none" stroke="black" d="M1119,-141.75C1119,-134.05 1119,-125.25 1119,-116.27"/>
<polygon fill="black" stroke="black" points="1122.5,-116.1 1119,-106.1 1115.5,-116.1 1122.5,-116.1"/>
</g>
<!-- split0&#45;&gt;qkv_c0 -->
<g id="edge2" class="edge">
<title>split0&#45;&gt;qkv_c0</title>
<path fill="none" stroke="black" d="M1119,-33159.23C1119,-33150.91 1119,-33140.61 1119,-33130.71"/>
<polygon fill="black" stroke="black" points="1122.5,-33130.64 1119,-33120.64 1115.5,-33130.64 1122.5,-33130.64"/>
</g>
</g>
</svg>
