<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: G Pages: 1 -->
<svg width="7584pt" height="8614pt"
 viewBox="0.00 0.00 7584.13 8613.88" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 8609.88)">
<title>G</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-8609.88 7580.13,-8609.88 7580.13,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_legend</title>
<polygon fill="white" stroke="black" stroke-dasharray="1,5" points="2326,-8487.88 2326,-8562.88 3000,-8562.88 3000,-8487.88 2326,-8487.88"/>
<text text-anchor="middle" x="2663" y="-8547.68" font-family="Times,serif" font-size="14.00">Legend</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_pp0</title>
<path fill="white" stroke="blue" d="M5526,-161C5526,-161 5984,-161 5984,-161 5990,-161 5996,-167 5996,-173 5996,-173 5996,-8432.88 5996,-8432.88 5996,-8438.88 5990,-8444.88 5984,-8444.88 5984,-8444.88 5526,-8444.88 5526,-8444.88 5520,-8444.88 5514,-8438.88 5514,-8432.88 5514,-8432.88 5514,-173 5514,-173 5514,-167 5520,-161 5526,-161"/>
<text text-anchor="middle" x="5755" y="-8429.68" font-family="Times,serif" font-size="14.00">PP Stage 0 (Layers 0&#45;3) – GPUs 0&#45;15</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_pp1</title>
<path fill="white" stroke="green" d="M20,-8C20,-8 5984,-8 5984,-8 5990,-8 5996,-14 5996,-20 5996,-20 5996,-141 5996,-141 5996,-147 5990,-153 5984,-153 5984,-153 20,-153 20,-153 14,-153 8,-147 8,-141 8,-141 8,-20 8,-20 8,-14 14,-8 20,-8"/>
<text text-anchor="middle" x="3002" y="-137.8" font-family="Times,serif" font-size="14.00">PP Stage 1 (Layers 4&#45;7) – GPUs 16&#45;31</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_pp2</title>
<path fill="white" stroke="orange" d="M6204,-8452.88C6204,-8452.88 6662,-8452.88 6662,-8452.88 6668,-8452.88 6674,-8458.88 6674,-8464.88 6674,-8464.88 6674,-8585.88 6674,-8585.88 6674,-8591.88 6668,-8597.88 6662,-8597.88 6662,-8597.88 6204,-8597.88 6204,-8597.88 6198,-8597.88 6192,-8591.88 6192,-8585.88 6192,-8585.88 6192,-8464.88 6192,-8464.88 6192,-8458.88 6198,-8452.88 6204,-8452.88"/>
<text text-anchor="middle" x="6433" y="-8582.68" font-family="Times,serif" font-size="14.00">PP Stage 2 (Layers 8&#45;11) – GPUs 32&#45;47</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_pp3</title>
<path fill="white" stroke="red" d="M6694,-8452.88C6694,-8452.88 7152,-8452.88 7152,-8452.88 7158,-8452.88 7164,-8458.88 7164,-8464.88 7164,-8464.88 7164,-8585.88 7164,-8585.88 7164,-8591.88 7158,-8597.88 7152,-8597.88 7152,-8597.88 6694,-8597.88 6694,-8597.88 6688,-8597.88 6682,-8591.88 6682,-8585.88 6682,-8585.88 6682,-8464.88 6682,-8464.88 6682,-8458.88 6688,-8452.88 6694,-8452.88"/>
<text text-anchor="middle" x="6923" y="-8582.68" font-family="Times,serif" font-size="14.00">PP Stage 3 (Layers 12&#45;15) – GPUs 48&#45;63</text>
</g>
<!-- comp -->
<g id="node1" class="node">
<title>comp</title>
<path fill="none" stroke="black" d="M2980,-8531.88C2980,-8531.88 2898,-8531.88 2898,-8531.88 2892,-8531.88 2886,-8525.88 2886,-8519.88 2886,-8519.88 2886,-8507.88 2886,-8507.88 2886,-8501.88 2892,-8495.88 2898,-8495.88 2898,-8495.88 2980,-8495.88 2980,-8495.88 2986,-8495.88 2992,-8501.88 2992,-8507.88 2992,-8507.88 2992,-8519.88 2992,-8519.88 2992,-8525.88 2986,-8531.88 2980,-8531.88"/>
<text text-anchor="middle" x="2939" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">Computation</text>
</g>
<!-- comm -->
<g id="node2" class="node">
<title>comm</title>
<ellipse fill="none" stroke="black" cx="2787" cy="-8513.88" rx="81.49" ry="18"/>
<text text-anchor="middle" x="2787" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">Communication</text>
</g>
<!-- route -->
<g id="node3" class="node">
<title>route</title>
<path fill="none" stroke="black" d="M2676.49,-8531.88C2676.49,-8531.88 2418.14,-8531.88 2418.14,-8531.88 2412.14,-8531.88 2400.77,-8529.22 2395.39,-8526.55 2395.39,-8526.55 2344.26,-8501.21 2344.26,-8501.21 2338.88,-8498.54 2339.51,-8495.88 2345.51,-8495.88 2345.51,-8495.88 2603.86,-8495.88 2603.86,-8495.88 2609.86,-8495.88 2621.23,-8498.54 2626.61,-8501.21 2626.61,-8501.21 2677.74,-8526.55 2677.74,-8526.55 2683.12,-8529.22 2682.49,-8531.88 2676.49,-8531.88"/>
<text text-anchor="middle" x="2511" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">Split / Route / Aggregate</text>
</g>
<!-- input -->
<g id="node4" class="node">
<title>input</title>
<path fill="none" stroke="black" d="M6170.28,-8566.88C6170.28,-8566.88 5514.57,-8566.88 5514.57,-8566.88 5508.57,-8566.88 5497.44,-8563.77 5492.31,-8560.66 5492.31,-8560.66 5337.98,-8467.1 5337.98,-8467.1 5332.85,-8463.99 5333.72,-8460.88 5339.72,-8460.88 5339.72,-8460.88 5995.43,-8460.88 5995.43,-8460.88 6001.43,-8460.88 6012.56,-8463.99 6017.69,-8467.1 6017.69,-8467.1 6172.02,-8560.66 6172.02,-8560.66 6177.15,-8563.77 6176.28,-8566.88 6170.28,-8566.88"/>
<text text-anchor="start" x="5406.2" y="-8525.18" font-family="Helvetica,sans-Serif" font-size="14.00">Input</text>
<text text-anchor="start" x="5406.2" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [batch_size=128, seq_len=10240, hidden=1024]</text>
<text text-anchor="start" x="5406.2" y="-8495.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- split0 -->
<g id="node5" class="node">
<title>split0</title>
<path fill="none" stroke="black" d="M5976.04,-8413.88C5976.04,-8413.88 5629.33,-8413.88 5629.33,-8413.88 5623.33,-8413.88 5613.31,-8409.42 5609.3,-8404.96 5609.3,-8404.96 5529.99,-8316.8 5529.99,-8316.8 5525.97,-8312.34 5527.96,-8307.88 5533.96,-8307.88 5533.96,-8307.88 5880.67,-8307.88 5880.67,-8307.88 5886.67,-8307.88 5896.69,-8312.34 5900.7,-8316.8 5900.7,-8316.8 5980.01,-8404.96 5980.01,-8404.96 5984.03,-8409.42 5982.04,-8413.88 5976.04,-8413.88"/>
<text text-anchor="start" x="5568.14" y="-8372.18" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="5568.14" y="-8357.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5568.14" y="-8342.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- input&#45;&gt;split0 -->
<g id="edge1" class="edge">
<title>input&#45;&gt;split0</title>
<path fill="none" stroke="black" d="M5755,-8460.49C5755,-8448.71 5755,-8436.1 5755,-8423.97"/>
<polygon fill="black" stroke="black" points="5758.5,-8423.92 5755,-8413.92 5751.5,-8423.92 5758.5,-8423.92"/>
</g>
<!-- qkv_c0 -->
<g id="node6" class="node">
<title>qkv_c0</title>
<path fill="none" stroke="black" d="M5877,-8271.88C5877,-8271.88 5633,-8271.88 5633,-8271.88 5627,-8271.88 5621,-8265.88 5621,-8259.88 5621,-8259.88 5621,-8230.88 5621,-8230.88 5621,-8224.88 5627,-8218.88 5633,-8218.88 5633,-8218.88 5877,-8218.88 5877,-8218.88 5883,-8218.88 5889,-8224.88 5889,-8230.88 5889,-8230.88 5889,-8259.88 5889,-8259.88 5889,-8265.88 5883,-8271.88 5877,-8271.88"/>
<text text-anchor="start" x="5629" y="-8256.68" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="5629" y="-8241.68" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="5629" y="-8226.68" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- split0&#45;&gt;qkv_c0 -->
<g id="edge2" class="edge">
<title>split0&#45;&gt;qkv_c0</title>
<path fill="none" stroke="black" d="M5755,-8307.78C5755,-8299.11 5755,-8290.29 5755,-8282.15"/>
<polygon fill="black" stroke="black" points="5758.5,-8281.89 5755,-8271.89 5751.5,-8281.89 5758.5,-8281.89"/>
</g>
<!-- qkv_ar0 -->
<g id="node7" class="node">
<title>qkv_ar0</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-8145.4" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="5662.5" y="-8156.7" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="5662.5" y="-8141.7" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5662.5" y="-8126.7" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c0&#45;&gt;qkv_ar0 -->
<g id="edge3" class="edge">
<title>qkv_c0&#45;&gt;qkv_ar0</title>
<path fill="none" stroke="black" d="M5755,-8218.64C5755,-8210.81 5755,-8201.96 5755,-8193.2"/>
<polygon fill="black" stroke="black" points="5758.5,-8193.03 5755,-8183.03 5751.5,-8193.03 5758.5,-8193.03"/>
</g>
<!-- sph0 -->
<g id="node8" class="node">
<title>sph0</title>
<path fill="none" stroke="black" d="M5963.66,-8071.93C5963.66,-8071.93 5636.64,-8071.93 5636.64,-8071.93 5630.64,-8071.93 5620.75,-8067.36 5616.86,-8062.79 5616.86,-8062.79 5542.12,-7975.06 5542.12,-7975.06 5538.23,-7970.49 5540.34,-7965.93 5546.34,-7965.93 5546.34,-7965.93 5873.36,-7965.93 5873.36,-7965.93 5879.36,-7965.93 5889.25,-7970.49 5893.14,-7975.06 5893.14,-7975.06 5967.88,-8062.79 5967.88,-8062.79 5971.77,-8067.36 5969.66,-8071.93 5963.66,-8071.93"/>
<text text-anchor="start" x="5578.54" y="-8030.23" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="5578.54" y="-8015.23" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5578.54" y="-8000.23" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar0&#45;&gt;sph0 -->
<g id="edge4" class="edge">
<title>qkv_ar0&#45;&gt;sph0</title>
<path fill="none" stroke="black" d="M5755,-8107.73C5755,-8099.69 5755,-8090.96 5755,-8082.23"/>
<polygon fill="black" stroke="black" points="5758.5,-8082.02 5755,-8072.02 5751.5,-8082.02 5758.5,-8082.02"/>
</g>
<!-- sdp0 -->
<g id="node9" class="node">
<title>sdp0</title>
<path fill="none" stroke="black" d="M5856,-7929.93C5856,-7929.93 5654,-7929.93 5654,-7929.93 5648,-7929.93 5642,-7923.93 5642,-7917.93 5642,-7917.93 5642,-7888.93 5642,-7888.93 5642,-7882.93 5648,-7876.93 5654,-7876.93 5654,-7876.93 5856,-7876.93 5856,-7876.93 5862,-7876.93 5868,-7882.93 5868,-7888.93 5868,-7888.93 5868,-7917.93 5868,-7917.93 5868,-7923.93 5862,-7929.93 5856,-7929.93"/>
<text text-anchor="start" x="5650" y="-7914.73" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="5650" y="-7899.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5650" y="-7884.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph0&#45;&gt;sdp0 -->
<g id="edge5" class="edge">
<title>sph0&#45;&gt;sdp0</title>
<path fill="none" stroke="black" d="M5755,-7965.83C5755,-7957.16 5755,-7948.34 5755,-7940.19"/>
<polygon fill="black" stroke="black" points="5758.5,-7939.94 5755,-7929.94 5751.5,-7939.94 5758.5,-7939.94"/>
</g>
<!-- sm0 -->
<g id="node10" class="node">
<title>sm0</title>
<path fill="none" stroke="black" d="M5818.5,-7840.93C5818.5,-7840.93 5691.5,-7840.93 5691.5,-7840.93 5685.5,-7840.93 5679.5,-7834.93 5679.5,-7828.93 5679.5,-7828.93 5679.5,-7799.93 5679.5,-7799.93 5679.5,-7793.93 5685.5,-7787.93 5691.5,-7787.93 5691.5,-7787.93 5818.5,-7787.93 5818.5,-7787.93 5824.5,-7787.93 5830.5,-7793.93 5830.5,-7799.93 5830.5,-7799.93 5830.5,-7828.93 5830.5,-7828.93 5830.5,-7834.93 5824.5,-7840.93 5818.5,-7840.93"/>
<text text-anchor="start" x="5687.5" y="-7825.73" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="5687.5" y="-7810.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5687.5" y="-7795.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp0&#45;&gt;sm0 -->
<g id="edge6" class="edge">
<title>sdp0&#45;&gt;sm0</title>
<path fill="none" stroke="black" d="M5755,-7876.79C5755,-7868.81 5755,-7859.86 5755,-7851.31"/>
<polygon fill="black" stroke="black" points="5758.5,-7851.18 5755,-7841.18 5751.5,-7851.18 5758.5,-7851.18"/>
</g>
<!-- do0 -->
<g id="node11" class="node">
<title>do0</title>
<path fill="none" stroke="black" d="M5802.5,-7751.93C5802.5,-7751.93 5707.5,-7751.93 5707.5,-7751.93 5701.5,-7751.93 5695.5,-7745.93 5695.5,-7739.93 5695.5,-7739.93 5695.5,-7710.93 5695.5,-7710.93 5695.5,-7704.93 5701.5,-7698.93 5707.5,-7698.93 5707.5,-7698.93 5802.5,-7698.93 5802.5,-7698.93 5808.5,-7698.93 5814.5,-7704.93 5814.5,-7710.93 5814.5,-7710.93 5814.5,-7739.93 5814.5,-7739.93 5814.5,-7745.93 5808.5,-7751.93 5802.5,-7751.93"/>
<text text-anchor="start" x="5703.5" y="-7736.73" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="5703.5" y="-7721.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5703.5" y="-7706.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm0&#45;&gt;do0 -->
<g id="edge7" class="edge">
<title>sm0&#45;&gt;do0</title>
<path fill="none" stroke="black" d="M5755,-7787.79C5755,-7779.81 5755,-7770.86 5755,-7762.31"/>
<polygon fill="black" stroke="black" points="5758.5,-7762.18 5755,-7752.18 5751.5,-7762.18 5758.5,-7762.18"/>
</g>
<!-- mgh0 -->
<g id="node12" class="node">
<title>mgh0</title>
<path fill="none" stroke="black" d="M5959.86,-7662.93C5959.86,-7662.93 5638.88,-7662.93 5638.88,-7662.93 5632.88,-7662.93 5623.03,-7658.33 5619.18,-7653.73 5619.18,-7653.73 5545.84,-7566.13 5545.84,-7566.13 5541.99,-7561.53 5544.14,-7556.93 5550.14,-7556.93 5550.14,-7556.93 5871.12,-7556.93 5871.12,-7556.93 5877.12,-7556.93 5886.97,-7561.53 5890.82,-7566.13 5890.82,-7566.13 5964.16,-7653.73 5964.16,-7653.73 5968.01,-7658.33 5965.86,-7662.93 5959.86,-7662.93"/>
<text text-anchor="start" x="5582" y="-7621.23" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="5582" y="-7606.23" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5582" y="-7591.23" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do0&#45;&gt;mgh0 -->
<g id="edge8" class="edge">
<title>do0&#45;&gt;mgh0</title>
<path fill="none" stroke="black" d="M5755,-7698.67C5755,-7690.97 5755,-7682.18 5755,-7673.19"/>
<polygon fill="black" stroke="black" points="5758.5,-7673.02 5755,-7663.02 5751.5,-7673.02 5758.5,-7673.02"/>
</g>
<!-- proj_r0 -->
<g id="node13" class="node">
<title>proj_r0</title>
<path fill="none" stroke="black" d="M5855,-7520.93C5855,-7520.93 5655,-7520.93 5655,-7520.93 5649,-7520.93 5643,-7514.93 5643,-7508.93 5643,-7508.93 5643,-7479.93 5643,-7479.93 5643,-7473.93 5649,-7467.93 5655,-7467.93 5655,-7467.93 5855,-7467.93 5855,-7467.93 5861,-7467.93 5867,-7473.93 5867,-7479.93 5867,-7479.93 5867,-7508.93 5867,-7508.93 5867,-7514.93 5861,-7520.93 5855,-7520.93"/>
<text text-anchor="start" x="5651" y="-7505.73" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651" y="-7490.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651" y="-7475.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh0&#45;&gt;proj_r0 -->
<g id="edge9" class="edge">
<title>mgh0&#45;&gt;proj_r0</title>
<path fill="none" stroke="black" d="M5755,-7556.83C5755,-7548.16 5755,-7539.34 5755,-7531.19"/>
<polygon fill="black" stroke="black" points="5758.5,-7530.94 5755,-7520.94 5751.5,-7530.94 5758.5,-7530.94"/>
</g>
<!-- proj_ar0 -->
<g id="node14" class="node">
<title>proj_ar0</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-7394.45" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="5675" y="-7405.75" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="5675" y="-7390.75" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="5675" y="-7375.75" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r0&#45;&gt;proj_ar0 -->
<g id="edge10" class="edge">
<title>proj_r0&#45;&gt;proj_ar0</title>
<path fill="none" stroke="black" d="M5755,-7467.68C5755,-7459.86 5755,-7451.01 5755,-7442.25"/>
<polygon fill="black" stroke="black" points="5758.5,-7442.07 5755,-7432.07 5751.5,-7442.07 5758.5,-7442.07"/>
</g>
<!-- norm0 -->
<g id="node15" class="node">
<title>norm0</title>
<path fill="none" stroke="black" d="M5840,-7320.97C5840,-7320.97 5670,-7320.97 5670,-7320.97 5664,-7320.97 5658,-7314.97 5658,-7308.97 5658,-7308.97 5658,-7279.97 5658,-7279.97 5658,-7273.97 5664,-7267.97 5670,-7267.97 5670,-7267.97 5840,-7267.97 5840,-7267.97 5846,-7267.97 5852,-7273.97 5852,-7279.97 5852,-7279.97 5852,-7308.97 5852,-7308.97 5852,-7314.97 5846,-7320.97 5840,-7320.97"/>
<text text-anchor="start" x="5666" y="-7305.77" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="5666" y="-7290.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5666" y="-7275.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar0&#45;&gt;norm0 -->
<g id="edge11" class="edge">
<title>proj_ar0&#45;&gt;norm0</title>
<path fill="none" stroke="black" d="M5755,-7356.97C5755,-7348.55 5755,-7339.61 5755,-7331.22"/>
<polygon fill="black" stroke="black" points="5758.5,-7330.98 5755,-7320.98 5751.5,-7330.98 5758.5,-7330.98"/>
</g>
<!-- gate_c0 -->
<g id="node16" class="node">
<title>gate_c0</title>
<path fill="none" stroke="black" d="M5854.5,-7231.97C5854.5,-7231.97 5655.5,-7231.97 5655.5,-7231.97 5649.5,-7231.97 5643.5,-7225.97 5643.5,-7219.97 5643.5,-7219.97 5643.5,-7190.97 5643.5,-7190.97 5643.5,-7184.97 5649.5,-7178.97 5655.5,-7178.97 5655.5,-7178.97 5854.5,-7178.97 5854.5,-7178.97 5860.5,-7178.97 5866.5,-7184.97 5866.5,-7190.97 5866.5,-7190.97 5866.5,-7219.97 5866.5,-7219.97 5866.5,-7225.97 5860.5,-7231.97 5854.5,-7231.97"/>
<text text-anchor="start" x="5651.5" y="-7216.77" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651.5" y="-7201.77" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651.5" y="-7186.77" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm0&#45;&gt;gate_c0 -->
<g id="edge12" class="edge">
<title>norm0&#45;&gt;gate_c0</title>
<path fill="none" stroke="black" d="M5755,-7267.84C5755,-7259.86 5755,-7250.91 5755,-7242.36"/>
<polygon fill="black" stroke="black" points="5758.5,-7242.22 5755,-7232.22 5751.5,-7242.22 5758.5,-7242.22"/>
</g>
<!-- gate_ar0 -->
<g id="node17" class="node">
<title>gate_ar0</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-7105.5" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="5684" y="-7116.8" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="5684" y="-7101.8" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5684" y="-7086.8" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c0&#45;&gt;gate_ar0 -->
<g id="edge13" class="edge">
<title>gate_c0&#45;&gt;gate_ar0</title>
<path fill="none" stroke="black" d="M5755,-7178.73C5755,-7170.91 5755,-7162.05 5755,-7153.29"/>
<polygon fill="black" stroke="black" points="5758.5,-7153.12 5755,-7143.12 5751.5,-7153.12 5758.5,-7153.12"/>
</g>
<!-- route0 -->
<g id="node18" class="node">
<title>route0</title>
<path fill="none" stroke="black" d="M5946.41,-7032.02C5946.41,-7032.02 5646.83,-7032.02 5646.83,-7032.02 5640.83,-7032.02 5631.13,-7027.3 5627.42,-7022.58 5627.42,-7022.58 5559,-6935.46 5559,-6935.46 5555.3,-6930.74 5557.59,-6926.02 5563.59,-6926.02 5563.59,-6926.02 5863.17,-6926.02 5863.17,-6926.02 5869.17,-6926.02 5878.87,-6930.74 5882.58,-6935.46 5882.58,-6935.46 5951,-7022.58 5951,-7022.58 5954.7,-7027.3 5952.41,-7032.02 5946.41,-7032.02"/>
<text text-anchor="start" x="5593.26" y="-6990.32" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="5593.26" y="-6975.32" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5593.26" y="-6960.32" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar0&#45;&gt;route0 -->
<g id="edge14" class="edge">
<title>gate_ar0&#45;&gt;route0</title>
<path fill="none" stroke="black" d="M5755,-7067.82C5755,-7059.78 5755,-7051.05 5755,-7042.32"/>
<polygon fill="black" stroke="black" points="5758.5,-7042.11 5755,-7032.11 5751.5,-7042.11 5758.5,-7042.11"/>
</g>
<!-- a2a_s0 -->
<g id="node19" class="node">
<title>a2a_s0</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-6852.54" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="5641.5" y="-6863.84" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="5641.5" y="-6848.84" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5641.5" y="-6833.84" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route0&#45;&gt;a2a_s0 -->
<g id="edge15" class="edge">
<title>route0&#45;&gt;a2a_s0</title>
<path fill="none" stroke="black" d="M5755,-6925.95C5755,-6917.52 5755,-6908.83 5755,-6900.53"/>
<polygon fill="black" stroke="black" points="5758.5,-6900.27 5755,-6890.27 5751.5,-6900.27 5758.5,-6900.27"/>
</g>
<!-- exp0 -->
<g id="node20" class="node">
<title>exp0</title>
<path fill="none" stroke="black" d="M5869.5,-6779.07C5869.5,-6779.07 5640.5,-6779.07 5640.5,-6779.07 5634.5,-6779.07 5628.5,-6773.07 5628.5,-6767.07 5628.5,-6767.07 5628.5,-6738.07 5628.5,-6738.07 5628.5,-6732.07 5634.5,-6726.07 5640.5,-6726.07 5640.5,-6726.07 5869.5,-6726.07 5869.5,-6726.07 5875.5,-6726.07 5881.5,-6732.07 5881.5,-6738.07 5881.5,-6738.07 5881.5,-6767.07 5881.5,-6767.07 5881.5,-6773.07 5875.5,-6779.07 5869.5,-6779.07"/>
<text text-anchor="start" x="5636.5" y="-6763.87" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5636.5" y="-6748.87" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="5636.5" y="-6733.87" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s0&#45;&gt;exp0 -->
<g id="edge16" class="edge">
<title>a2a_s0&#45;&gt;exp0</title>
<path fill="none" stroke="black" d="M5755,-6815.06C5755,-6806.64 5755,-6797.7 5755,-6789.32"/>
<polygon fill="black" stroke="black" points="5758.5,-6789.08 5755,-6779.08 5751.5,-6789.08 5758.5,-6789.08"/>
</g>
<!-- exp_ar0 -->
<g id="node21" class="node">
<title>exp_ar0</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-6652.59" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="5677" y="-6663.89" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="5677" y="-6648.89" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5677" y="-6633.89" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp0&#45;&gt;exp_ar0 -->
<g id="edge17" class="edge">
<title>exp0&#45;&gt;exp_ar0</title>
<path fill="none" stroke="black" d="M5755,-6725.82C5755,-6718 5755,-6709.15 5755,-6700.39"/>
<polygon fill="black" stroke="black" points="5758.5,-6700.21 5755,-6690.21 5751.5,-6700.21 5758.5,-6700.21"/>
</g>
<!-- a2a_r0 -->
<g id="node22" class="node">
<title>a2a_r0</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-6541.64" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="5658.5" y="-6552.94" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="5658.5" y="-6537.94" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="5658.5" y="-6522.94" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar0&#45;&gt;a2a_r0 -->
<g id="edge18" class="edge">
<title>exp_ar0&#45;&gt;a2a_r0</title>
<path fill="none" stroke="black" d="M5755,-6615.01C5755,-6606.83 5755,-6598.05 5755,-6589.53"/>
<polygon fill="black" stroke="black" points="5758.5,-6589.31 5755,-6579.31 5751.5,-6589.31 5758.5,-6589.31"/>
</g>
<!-- agg0 -->
<g id="node23" class="node">
<title>agg0</title>
<path fill="none" stroke="black" d="M5944.26,-6468.16C5944.26,-6468.16 5648.1,-6468.16 5648.1,-6468.16 5642.1,-6468.16 5632.42,-6463.42 5628.74,-6458.68 5628.74,-6458.68 5561.1,-6371.64 5561.1,-6371.64 5557.42,-6366.9 5559.74,-6362.16 5565.74,-6362.16 5565.74,-6362.16 5861.9,-6362.16 5861.9,-6362.16 5867.9,-6362.16 5877.58,-6366.9 5881.26,-6371.64 5881.26,-6371.64 5948.9,-6458.68 5948.9,-6458.68 5952.58,-6463.42 5950.26,-6468.16 5944.26,-6468.16"/>
<text text-anchor="start" x="5594.99" y="-6426.46" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="5594.99" y="-6411.46" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5594.99" y="-6396.46" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r0&#45;&gt;agg0 -->
<g id="edge19" class="edge">
<title>a2a_r0&#45;&gt;agg0</title>
<path fill="none" stroke="black" d="M5755,-6503.96C5755,-6495.92 5755,-6487.19 5755,-6478.46"/>
<polygon fill="black" stroke="black" points="5758.5,-6478.25 5755,-6468.25 5751.5,-6478.25 5758.5,-6478.25"/>
</g>
<!-- norm_m0 -->
<g id="node24" class="node">
<title>norm_m0</title>
<path fill="none" stroke="black" d="M5835,-6326.16C5835,-6326.16 5675,-6326.16 5675,-6326.16 5669,-6326.16 5663,-6320.16 5663,-6314.16 5663,-6314.16 5663,-6285.16 5663,-6285.16 5663,-6279.16 5669,-6273.16 5675,-6273.16 5675,-6273.16 5835,-6273.16 5835,-6273.16 5841,-6273.16 5847,-6279.16 5847,-6285.16 5847,-6285.16 5847,-6314.16 5847,-6314.16 5847,-6320.16 5841,-6326.16 5835,-6326.16"/>
<text text-anchor="start" x="5671" y="-6310.96" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="5671" y="-6295.96" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5671" y="-6280.96" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg0&#45;&gt;norm_m0 -->
<g id="edge20" class="edge">
<title>agg0&#45;&gt;norm_m0</title>
<path fill="none" stroke="black" d="M5755,-6362.06C5755,-6353.39 5755,-6344.57 5755,-6336.43"/>
<polygon fill="black" stroke="black" points="5758.5,-6336.17 5755,-6326.17 5751.5,-6336.17 5758.5,-6336.17"/>
</g>
<!-- qkv_c1 -->
<g id="node25" class="node">
<title>qkv_c1</title>
<path fill="none" stroke="black" d="M5877,-6237.16C5877,-6237.16 5633,-6237.16 5633,-6237.16 5627,-6237.16 5621,-6231.16 5621,-6225.16 5621,-6225.16 5621,-6196.16 5621,-6196.16 5621,-6190.16 5627,-6184.16 5633,-6184.16 5633,-6184.16 5877,-6184.16 5877,-6184.16 5883,-6184.16 5889,-6190.16 5889,-6196.16 5889,-6196.16 5889,-6225.16 5889,-6225.16 5889,-6231.16 5883,-6237.16 5877,-6237.16"/>
<text text-anchor="start" x="5629" y="-6221.96" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="5629" y="-6206.96" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5629" y="-6191.96" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m0&#45;&gt;qkv_c1 -->
<g id="edge21" class="edge">
<title>norm_m0&#45;&gt;qkv_c1</title>
<path fill="none" stroke="black" d="M5755,-6273.03C5755,-6265.05 5755,-6256.09 5755,-6247.54"/>
<polygon fill="black" stroke="black" points="5758.5,-6247.41 5755,-6237.41 5751.5,-6247.41 5758.5,-6247.41"/>
</g>
<!-- qkv_ar1 -->
<g id="node26" class="node">
<title>qkv_ar1</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-6110.68" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="5662.5" y="-6121.98" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="5662.5" y="-6106.98" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5662.5" y="-6091.98" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c1&#45;&gt;qkv_ar1 -->
<g id="edge22" class="edge">
<title>qkv_c1&#45;&gt;qkv_ar1</title>
<path fill="none" stroke="black" d="M5755,-6183.92C5755,-6176.09 5755,-6167.24 5755,-6158.48"/>
<polygon fill="black" stroke="black" points="5758.5,-6158.31 5755,-6148.31 5751.5,-6158.31 5758.5,-6158.31"/>
</g>
<!-- sph1 -->
<g id="node27" class="node">
<title>sph1</title>
<path fill="none" stroke="black" d="M5963.66,-6037.21C5963.66,-6037.21 5636.64,-6037.21 5636.64,-6037.21 5630.64,-6037.21 5620.75,-6032.64 5616.86,-6028.07 5616.86,-6028.07 5542.12,-5940.34 5542.12,-5940.34 5538.23,-5935.77 5540.34,-5931.21 5546.34,-5931.21 5546.34,-5931.21 5873.36,-5931.21 5873.36,-5931.21 5879.36,-5931.21 5889.25,-5935.77 5893.14,-5940.34 5893.14,-5940.34 5967.88,-6028.07 5967.88,-6028.07 5971.77,-6032.64 5969.66,-6037.21 5963.66,-6037.21"/>
<text text-anchor="start" x="5578.54" y="-5995.51" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="5578.54" y="-5980.51" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5578.54" y="-5965.51" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar1&#45;&gt;sph1 -->
<g id="edge23" class="edge">
<title>qkv_ar1&#45;&gt;sph1</title>
<path fill="none" stroke="black" d="M5755,-6073.01C5755,-6064.97 5755,-6056.24 5755,-6047.51"/>
<polygon fill="black" stroke="black" points="5758.5,-6047.3 5755,-6037.3 5751.5,-6047.3 5758.5,-6047.3"/>
</g>
<!-- sdp1 -->
<g id="node28" class="node">
<title>sdp1</title>
<path fill="none" stroke="black" d="M5856,-5895.21C5856,-5895.21 5654,-5895.21 5654,-5895.21 5648,-5895.21 5642,-5889.21 5642,-5883.21 5642,-5883.21 5642,-5854.21 5642,-5854.21 5642,-5848.21 5648,-5842.21 5654,-5842.21 5654,-5842.21 5856,-5842.21 5856,-5842.21 5862,-5842.21 5868,-5848.21 5868,-5854.21 5868,-5854.21 5868,-5883.21 5868,-5883.21 5868,-5889.21 5862,-5895.21 5856,-5895.21"/>
<text text-anchor="start" x="5650" y="-5880.01" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="5650" y="-5865.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5650" y="-5850.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph1&#45;&gt;sdp1 -->
<g id="edge24" class="edge">
<title>sph1&#45;&gt;sdp1</title>
<path fill="none" stroke="black" d="M5755,-5931.11C5755,-5922.44 5755,-5913.62 5755,-5905.47"/>
<polygon fill="black" stroke="black" points="5758.5,-5905.22 5755,-5895.22 5751.5,-5905.22 5758.5,-5905.22"/>
</g>
<!-- sm1 -->
<g id="node29" class="node">
<title>sm1</title>
<path fill="none" stroke="black" d="M5818.5,-5806.21C5818.5,-5806.21 5691.5,-5806.21 5691.5,-5806.21 5685.5,-5806.21 5679.5,-5800.21 5679.5,-5794.21 5679.5,-5794.21 5679.5,-5765.21 5679.5,-5765.21 5679.5,-5759.21 5685.5,-5753.21 5691.5,-5753.21 5691.5,-5753.21 5818.5,-5753.21 5818.5,-5753.21 5824.5,-5753.21 5830.5,-5759.21 5830.5,-5765.21 5830.5,-5765.21 5830.5,-5794.21 5830.5,-5794.21 5830.5,-5800.21 5824.5,-5806.21 5818.5,-5806.21"/>
<text text-anchor="start" x="5687.5" y="-5791.01" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="5687.5" y="-5776.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5687.5" y="-5761.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp1&#45;&gt;sm1 -->
<g id="edge25" class="edge">
<title>sdp1&#45;&gt;sm1</title>
<path fill="none" stroke="black" d="M5755,-5842.07C5755,-5834.09 5755,-5825.14 5755,-5816.59"/>
<polygon fill="black" stroke="black" points="5758.5,-5816.46 5755,-5806.46 5751.5,-5816.46 5758.5,-5816.46"/>
</g>
<!-- do1 -->
<g id="node30" class="node">
<title>do1</title>
<path fill="none" stroke="black" d="M5802.5,-5717.21C5802.5,-5717.21 5707.5,-5717.21 5707.5,-5717.21 5701.5,-5717.21 5695.5,-5711.21 5695.5,-5705.21 5695.5,-5705.21 5695.5,-5676.21 5695.5,-5676.21 5695.5,-5670.21 5701.5,-5664.21 5707.5,-5664.21 5707.5,-5664.21 5802.5,-5664.21 5802.5,-5664.21 5808.5,-5664.21 5814.5,-5670.21 5814.5,-5676.21 5814.5,-5676.21 5814.5,-5705.21 5814.5,-5705.21 5814.5,-5711.21 5808.5,-5717.21 5802.5,-5717.21"/>
<text text-anchor="start" x="5703.5" y="-5702.01" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="5703.5" y="-5687.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5703.5" y="-5672.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm1&#45;&gt;do1 -->
<g id="edge26" class="edge">
<title>sm1&#45;&gt;do1</title>
<path fill="none" stroke="black" d="M5755,-5753.07C5755,-5745.09 5755,-5736.14 5755,-5727.59"/>
<polygon fill="black" stroke="black" points="5758.5,-5727.46 5755,-5717.46 5751.5,-5727.46 5758.5,-5727.46"/>
</g>
<!-- mgh1 -->
<g id="node31" class="node">
<title>mgh1</title>
<path fill="none" stroke="black" d="M5959.86,-5628.21C5959.86,-5628.21 5638.88,-5628.21 5638.88,-5628.21 5632.88,-5628.21 5623.03,-5623.61 5619.18,-5619.01 5619.18,-5619.01 5545.84,-5531.41 5545.84,-5531.41 5541.99,-5526.81 5544.14,-5522.21 5550.14,-5522.21 5550.14,-5522.21 5871.12,-5522.21 5871.12,-5522.21 5877.12,-5522.21 5886.97,-5526.81 5890.82,-5531.41 5890.82,-5531.41 5964.16,-5619.01 5964.16,-5619.01 5968.01,-5623.61 5965.86,-5628.21 5959.86,-5628.21"/>
<text text-anchor="start" x="5582" y="-5586.51" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="5582" y="-5571.51" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5582" y="-5556.51" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do1&#45;&gt;mgh1 -->
<g id="edge27" class="edge">
<title>do1&#45;&gt;mgh1</title>
<path fill="none" stroke="black" d="M5755,-5663.95C5755,-5656.25 5755,-5647.46 5755,-5638.47"/>
<polygon fill="black" stroke="black" points="5758.5,-5638.3 5755,-5628.3 5751.5,-5638.3 5758.5,-5638.3"/>
</g>
<!-- proj_r1 -->
<g id="node32" class="node">
<title>proj_r1</title>
<path fill="none" stroke="black" d="M5855,-5486.21C5855,-5486.21 5655,-5486.21 5655,-5486.21 5649,-5486.21 5643,-5480.21 5643,-5474.21 5643,-5474.21 5643,-5445.21 5643,-5445.21 5643,-5439.21 5649,-5433.21 5655,-5433.21 5655,-5433.21 5855,-5433.21 5855,-5433.21 5861,-5433.21 5867,-5439.21 5867,-5445.21 5867,-5445.21 5867,-5474.21 5867,-5474.21 5867,-5480.21 5861,-5486.21 5855,-5486.21"/>
<text text-anchor="start" x="5651" y="-5471.01" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651" y="-5456.01" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651" y="-5441.01" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh1&#45;&gt;proj_r1 -->
<g id="edge28" class="edge">
<title>mgh1&#45;&gt;proj_r1</title>
<path fill="none" stroke="black" d="M5755,-5522.11C5755,-5513.44 5755,-5504.62 5755,-5496.47"/>
<polygon fill="black" stroke="black" points="5758.5,-5496.22 5755,-5486.22 5751.5,-5496.22 5758.5,-5496.22"/>
</g>
<!-- proj_ar1 -->
<g id="node33" class="node">
<title>proj_ar1</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-5359.73" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="5675" y="-5371.03" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="5675" y="-5356.03" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="5675" y="-5341.03" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r1&#45;&gt;proj_ar1 -->
<g id="edge29" class="edge">
<title>proj_r1&#45;&gt;proj_ar1</title>
<path fill="none" stroke="black" d="M5755,-5432.96C5755,-5425.14 5755,-5416.29 5755,-5407.53"/>
<polygon fill="black" stroke="black" points="5758.5,-5407.35 5755,-5397.35 5751.5,-5407.35 5758.5,-5407.35"/>
</g>
<!-- norm1 -->
<g id="node34" class="node">
<title>norm1</title>
<path fill="none" stroke="black" d="M5840,-5286.25C5840,-5286.25 5670,-5286.25 5670,-5286.25 5664,-5286.25 5658,-5280.25 5658,-5274.25 5658,-5274.25 5658,-5245.25 5658,-5245.25 5658,-5239.25 5664,-5233.25 5670,-5233.25 5670,-5233.25 5840,-5233.25 5840,-5233.25 5846,-5233.25 5852,-5239.25 5852,-5245.25 5852,-5245.25 5852,-5274.25 5852,-5274.25 5852,-5280.25 5846,-5286.25 5840,-5286.25"/>
<text text-anchor="start" x="5666" y="-5271.05" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="5666" y="-5256.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5666" y="-5241.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar1&#45;&gt;norm1 -->
<g id="edge30" class="edge">
<title>proj_ar1&#45;&gt;norm1</title>
<path fill="none" stroke="black" d="M5755,-5322.25C5755,-5313.83 5755,-5304.89 5755,-5296.5"/>
<polygon fill="black" stroke="black" points="5758.5,-5296.26 5755,-5286.26 5751.5,-5296.26 5758.5,-5296.26"/>
</g>
<!-- gate_c1 -->
<g id="node35" class="node">
<title>gate_c1</title>
<path fill="none" stroke="black" d="M5854.5,-5197.25C5854.5,-5197.25 5655.5,-5197.25 5655.5,-5197.25 5649.5,-5197.25 5643.5,-5191.25 5643.5,-5185.25 5643.5,-5185.25 5643.5,-5156.25 5643.5,-5156.25 5643.5,-5150.25 5649.5,-5144.25 5655.5,-5144.25 5655.5,-5144.25 5854.5,-5144.25 5854.5,-5144.25 5860.5,-5144.25 5866.5,-5150.25 5866.5,-5156.25 5866.5,-5156.25 5866.5,-5185.25 5866.5,-5185.25 5866.5,-5191.25 5860.5,-5197.25 5854.5,-5197.25"/>
<text text-anchor="start" x="5651.5" y="-5182.05" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651.5" y="-5167.05" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651.5" y="-5152.05" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm1&#45;&gt;gate_c1 -->
<g id="edge31" class="edge">
<title>norm1&#45;&gt;gate_c1</title>
<path fill="none" stroke="black" d="M5755,-5233.12C5755,-5225.14 5755,-5216.19 5755,-5207.64"/>
<polygon fill="black" stroke="black" points="5758.5,-5207.5 5755,-5197.5 5751.5,-5207.5 5758.5,-5207.5"/>
</g>
<!-- gate_ar1 -->
<g id="node36" class="node">
<title>gate_ar1</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-5070.78" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="5684" y="-5082.08" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="5684" y="-5067.08" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5684" y="-5052.08" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c1&#45;&gt;gate_ar1 -->
<g id="edge32" class="edge">
<title>gate_c1&#45;&gt;gate_ar1</title>
<path fill="none" stroke="black" d="M5755,-5144.01C5755,-5136.19 5755,-5127.33 5755,-5118.57"/>
<polygon fill="black" stroke="black" points="5758.5,-5118.4 5755,-5108.4 5751.5,-5118.4 5758.5,-5118.4"/>
</g>
<!-- route1 -->
<g id="node37" class="node">
<title>route1</title>
<path fill="none" stroke="black" d="M5946.41,-4997.3C5946.41,-4997.3 5646.83,-4997.3 5646.83,-4997.3 5640.83,-4997.3 5631.13,-4992.58 5627.42,-4987.86 5627.42,-4987.86 5559,-4900.74 5559,-4900.74 5555.3,-4896.02 5557.59,-4891.3 5563.59,-4891.3 5563.59,-4891.3 5863.17,-4891.3 5863.17,-4891.3 5869.17,-4891.3 5878.87,-4896.02 5882.58,-4900.74 5882.58,-4900.74 5951,-4987.86 5951,-4987.86 5954.7,-4992.58 5952.41,-4997.3 5946.41,-4997.3"/>
<text text-anchor="start" x="5593.26" y="-4955.6" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="5593.26" y="-4940.6" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5593.26" y="-4925.6" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar1&#45;&gt;route1 -->
<g id="edge33" class="edge">
<title>gate_ar1&#45;&gt;route1</title>
<path fill="none" stroke="black" d="M5755,-5033.1C5755,-5025.06 5755,-5016.33 5755,-5007.6"/>
<polygon fill="black" stroke="black" points="5758.5,-5007.39 5755,-4997.39 5751.5,-5007.39 5758.5,-5007.39"/>
</g>
<!-- a2a_s1 -->
<g id="node38" class="node">
<title>a2a_s1</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-4817.82" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="5641.5" y="-4829.12" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="5641.5" y="-4814.12" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5641.5" y="-4799.12" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route1&#45;&gt;a2a_s1 -->
<g id="edge34" class="edge">
<title>route1&#45;&gt;a2a_s1</title>
<path fill="none" stroke="black" d="M5755,-4891.23C5755,-4882.8 5755,-4874.11 5755,-4865.81"/>
<polygon fill="black" stroke="black" points="5758.5,-4865.55 5755,-4855.55 5751.5,-4865.55 5758.5,-4865.55"/>
</g>
<!-- exp1 -->
<g id="node39" class="node">
<title>exp1</title>
<path fill="none" stroke="black" d="M5869.5,-4744.35C5869.5,-4744.35 5640.5,-4744.35 5640.5,-4744.35 5634.5,-4744.35 5628.5,-4738.35 5628.5,-4732.35 5628.5,-4732.35 5628.5,-4703.35 5628.5,-4703.35 5628.5,-4697.35 5634.5,-4691.35 5640.5,-4691.35 5640.5,-4691.35 5869.5,-4691.35 5869.5,-4691.35 5875.5,-4691.35 5881.5,-4697.35 5881.5,-4703.35 5881.5,-4703.35 5881.5,-4732.35 5881.5,-4732.35 5881.5,-4738.35 5875.5,-4744.35 5869.5,-4744.35"/>
<text text-anchor="start" x="5636.5" y="-4729.15" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5636.5" y="-4714.15" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="5636.5" y="-4699.15" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s1&#45;&gt;exp1 -->
<g id="edge35" class="edge">
<title>a2a_s1&#45;&gt;exp1</title>
<path fill="none" stroke="black" d="M5755,-4780.34C5755,-4771.92 5755,-4762.98 5755,-4754.6"/>
<polygon fill="black" stroke="black" points="5758.5,-4754.36 5755,-4744.36 5751.5,-4754.36 5758.5,-4754.36"/>
</g>
<!-- exp_ar1 -->
<g id="node40" class="node">
<title>exp_ar1</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-4617.87" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="5677" y="-4629.17" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="5677" y="-4614.17" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5677" y="-4599.17" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp1&#45;&gt;exp_ar1 -->
<g id="edge36" class="edge">
<title>exp1&#45;&gt;exp_ar1</title>
<path fill="none" stroke="black" d="M5755,-4691.1C5755,-4683.28 5755,-4674.43 5755,-4665.67"/>
<polygon fill="black" stroke="black" points="5758.5,-4665.49 5755,-4655.49 5751.5,-4665.49 5758.5,-4665.49"/>
</g>
<!-- a2a_r1 -->
<g id="node41" class="node">
<title>a2a_r1</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-4506.92" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="5658.5" y="-4518.22" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="5658.5" y="-4503.22" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="5658.5" y="-4488.22" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar1&#45;&gt;a2a_r1 -->
<g id="edge37" class="edge">
<title>exp_ar1&#45;&gt;a2a_r1</title>
<path fill="none" stroke="black" d="M5755,-4580.29C5755,-4572.11 5755,-4563.33 5755,-4554.81"/>
<polygon fill="black" stroke="black" points="5758.5,-4554.59 5755,-4544.59 5751.5,-4554.59 5758.5,-4554.59"/>
</g>
<!-- agg1 -->
<g id="node42" class="node">
<title>agg1</title>
<path fill="none" stroke="black" d="M5944.26,-4433.44C5944.26,-4433.44 5648.1,-4433.44 5648.1,-4433.44 5642.1,-4433.44 5632.42,-4428.7 5628.74,-4423.96 5628.74,-4423.96 5561.1,-4336.92 5561.1,-4336.92 5557.42,-4332.18 5559.74,-4327.44 5565.74,-4327.44 5565.74,-4327.44 5861.9,-4327.44 5861.9,-4327.44 5867.9,-4327.44 5877.58,-4332.18 5881.26,-4336.92 5881.26,-4336.92 5948.9,-4423.96 5948.9,-4423.96 5952.58,-4428.7 5950.26,-4433.44 5944.26,-4433.44"/>
<text text-anchor="start" x="5594.99" y="-4391.74" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="5594.99" y="-4376.74" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5594.99" y="-4361.74" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r1&#45;&gt;agg1 -->
<g id="edge38" class="edge">
<title>a2a_r1&#45;&gt;agg1</title>
<path fill="none" stroke="black" d="M5755,-4469.24C5755,-4461.2 5755,-4452.47 5755,-4443.74"/>
<polygon fill="black" stroke="black" points="5758.5,-4443.53 5755,-4433.53 5751.5,-4443.53 5758.5,-4443.53"/>
</g>
<!-- norm_m1 -->
<g id="node43" class="node">
<title>norm_m1</title>
<path fill="none" stroke="black" d="M5835,-4291.44C5835,-4291.44 5675,-4291.44 5675,-4291.44 5669,-4291.44 5663,-4285.44 5663,-4279.44 5663,-4279.44 5663,-4250.44 5663,-4250.44 5663,-4244.44 5669,-4238.44 5675,-4238.44 5675,-4238.44 5835,-4238.44 5835,-4238.44 5841,-4238.44 5847,-4244.44 5847,-4250.44 5847,-4250.44 5847,-4279.44 5847,-4279.44 5847,-4285.44 5841,-4291.44 5835,-4291.44"/>
<text text-anchor="start" x="5671" y="-4276.24" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="5671" y="-4261.24" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5671" y="-4246.24" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg1&#45;&gt;norm_m1 -->
<g id="edge39" class="edge">
<title>agg1&#45;&gt;norm_m1</title>
<path fill="none" stroke="black" d="M5755,-4327.34C5755,-4318.67 5755,-4309.85 5755,-4301.71"/>
<polygon fill="black" stroke="black" points="5758.5,-4301.45 5755,-4291.45 5751.5,-4301.45 5758.5,-4301.45"/>
</g>
<!-- qkv_c2 -->
<g id="node44" class="node">
<title>qkv_c2</title>
<path fill="none" stroke="black" d="M5877,-4202.44C5877,-4202.44 5633,-4202.44 5633,-4202.44 5627,-4202.44 5621,-4196.44 5621,-4190.44 5621,-4190.44 5621,-4161.44 5621,-4161.44 5621,-4155.44 5627,-4149.44 5633,-4149.44 5633,-4149.44 5877,-4149.44 5877,-4149.44 5883,-4149.44 5889,-4155.44 5889,-4161.44 5889,-4161.44 5889,-4190.44 5889,-4190.44 5889,-4196.44 5883,-4202.44 5877,-4202.44"/>
<text text-anchor="start" x="5629" y="-4187.24" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="5629" y="-4172.24" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5629" y="-4157.24" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m1&#45;&gt;qkv_c2 -->
<g id="edge40" class="edge">
<title>norm_m1&#45;&gt;qkv_c2</title>
<path fill="none" stroke="black" d="M5755,-4238.31C5755,-4230.33 5755,-4221.37 5755,-4212.82"/>
<polygon fill="black" stroke="black" points="5758.5,-4212.69 5755,-4202.69 5751.5,-4212.69 5758.5,-4212.69"/>
</g>
<!-- qkv_ar2 -->
<g id="node45" class="node">
<title>qkv_ar2</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-4075.96" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="5662.5" y="-4087.26" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="5662.5" y="-4072.26" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5662.5" y="-4057.26" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c2&#45;&gt;qkv_ar2 -->
<g id="edge41" class="edge">
<title>qkv_c2&#45;&gt;qkv_ar2</title>
<path fill="none" stroke="black" d="M5755,-4149.2C5755,-4141.37 5755,-4132.52 5755,-4123.76"/>
<polygon fill="black" stroke="black" points="5758.5,-4123.59 5755,-4113.59 5751.5,-4123.59 5758.5,-4123.59"/>
</g>
<!-- sph2 -->
<g id="node46" class="node">
<title>sph2</title>
<path fill="none" stroke="black" d="M5963.66,-4002.49C5963.66,-4002.49 5636.64,-4002.49 5636.64,-4002.49 5630.64,-4002.49 5620.75,-3997.92 5616.86,-3993.35 5616.86,-3993.35 5542.12,-3905.62 5542.12,-3905.62 5538.23,-3901.05 5540.34,-3896.49 5546.34,-3896.49 5546.34,-3896.49 5873.36,-3896.49 5873.36,-3896.49 5879.36,-3896.49 5889.25,-3901.05 5893.14,-3905.62 5893.14,-3905.62 5967.88,-3993.35 5967.88,-3993.35 5971.77,-3997.92 5969.66,-4002.49 5963.66,-4002.49"/>
<text text-anchor="start" x="5578.54" y="-3960.79" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="5578.54" y="-3945.79" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5578.54" y="-3930.79" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar2&#45;&gt;sph2 -->
<g id="edge42" class="edge">
<title>qkv_ar2&#45;&gt;sph2</title>
<path fill="none" stroke="black" d="M5755,-4038.29C5755,-4030.25 5755,-4021.52 5755,-4012.79"/>
<polygon fill="black" stroke="black" points="5758.5,-4012.58 5755,-4002.58 5751.5,-4012.58 5758.5,-4012.58"/>
</g>
<!-- sdp2 -->
<g id="node47" class="node">
<title>sdp2</title>
<path fill="none" stroke="black" d="M5856,-3860.49C5856,-3860.49 5654,-3860.49 5654,-3860.49 5648,-3860.49 5642,-3854.49 5642,-3848.49 5642,-3848.49 5642,-3819.49 5642,-3819.49 5642,-3813.49 5648,-3807.49 5654,-3807.49 5654,-3807.49 5856,-3807.49 5856,-3807.49 5862,-3807.49 5868,-3813.49 5868,-3819.49 5868,-3819.49 5868,-3848.49 5868,-3848.49 5868,-3854.49 5862,-3860.49 5856,-3860.49"/>
<text text-anchor="start" x="5650" y="-3845.29" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="5650" y="-3830.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5650" y="-3815.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph2&#45;&gt;sdp2 -->
<g id="edge43" class="edge">
<title>sph2&#45;&gt;sdp2</title>
<path fill="none" stroke="black" d="M5755,-3896.39C5755,-3887.72 5755,-3878.9 5755,-3870.75"/>
<polygon fill="black" stroke="black" points="5758.5,-3870.5 5755,-3860.5 5751.5,-3870.5 5758.5,-3870.5"/>
</g>
<!-- sm2 -->
<g id="node48" class="node">
<title>sm2</title>
<path fill="none" stroke="black" d="M5818.5,-3771.49C5818.5,-3771.49 5691.5,-3771.49 5691.5,-3771.49 5685.5,-3771.49 5679.5,-3765.49 5679.5,-3759.49 5679.5,-3759.49 5679.5,-3730.49 5679.5,-3730.49 5679.5,-3724.49 5685.5,-3718.49 5691.5,-3718.49 5691.5,-3718.49 5818.5,-3718.49 5818.5,-3718.49 5824.5,-3718.49 5830.5,-3724.49 5830.5,-3730.49 5830.5,-3730.49 5830.5,-3759.49 5830.5,-3759.49 5830.5,-3765.49 5824.5,-3771.49 5818.5,-3771.49"/>
<text text-anchor="start" x="5687.5" y="-3756.29" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="5687.5" y="-3741.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5687.5" y="-3726.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp2&#45;&gt;sm2 -->
<g id="edge44" class="edge">
<title>sdp2&#45;&gt;sm2</title>
<path fill="none" stroke="black" d="M5755,-3807.35C5755,-3799.37 5755,-3790.42 5755,-3781.87"/>
<polygon fill="black" stroke="black" points="5758.5,-3781.74 5755,-3771.74 5751.5,-3781.74 5758.5,-3781.74"/>
</g>
<!-- do2 -->
<g id="node49" class="node">
<title>do2</title>
<path fill="none" stroke="black" d="M5802.5,-3682.49C5802.5,-3682.49 5707.5,-3682.49 5707.5,-3682.49 5701.5,-3682.49 5695.5,-3676.49 5695.5,-3670.49 5695.5,-3670.49 5695.5,-3641.49 5695.5,-3641.49 5695.5,-3635.49 5701.5,-3629.49 5707.5,-3629.49 5707.5,-3629.49 5802.5,-3629.49 5802.5,-3629.49 5808.5,-3629.49 5814.5,-3635.49 5814.5,-3641.49 5814.5,-3641.49 5814.5,-3670.49 5814.5,-3670.49 5814.5,-3676.49 5808.5,-3682.49 5802.5,-3682.49"/>
<text text-anchor="start" x="5703.5" y="-3667.29" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="5703.5" y="-3652.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5703.5" y="-3637.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm2&#45;&gt;do2 -->
<g id="edge45" class="edge">
<title>sm2&#45;&gt;do2</title>
<path fill="none" stroke="black" d="M5755,-3718.35C5755,-3710.37 5755,-3701.42 5755,-3692.87"/>
<polygon fill="black" stroke="black" points="5758.5,-3692.74 5755,-3682.74 5751.5,-3692.74 5758.5,-3692.74"/>
</g>
<!-- mgh2 -->
<g id="node50" class="node">
<title>mgh2</title>
<path fill="none" stroke="black" d="M5959.86,-3593.49C5959.86,-3593.49 5638.88,-3593.49 5638.88,-3593.49 5632.88,-3593.49 5623.03,-3588.89 5619.18,-3584.29 5619.18,-3584.29 5545.84,-3496.69 5545.84,-3496.69 5541.99,-3492.09 5544.14,-3487.49 5550.14,-3487.49 5550.14,-3487.49 5871.12,-3487.49 5871.12,-3487.49 5877.12,-3487.49 5886.97,-3492.09 5890.82,-3496.69 5890.82,-3496.69 5964.16,-3584.29 5964.16,-3584.29 5968.01,-3588.89 5965.86,-3593.49 5959.86,-3593.49"/>
<text text-anchor="start" x="5582" y="-3551.79" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="5582" y="-3536.79" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5582" y="-3521.79" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do2&#45;&gt;mgh2 -->
<g id="edge46" class="edge">
<title>do2&#45;&gt;mgh2</title>
<path fill="none" stroke="black" d="M5755,-3629.23C5755,-3621.53 5755,-3612.74 5755,-3603.75"/>
<polygon fill="black" stroke="black" points="5758.5,-3603.58 5755,-3593.58 5751.5,-3603.58 5758.5,-3603.58"/>
</g>
<!-- proj_r2 -->
<g id="node51" class="node">
<title>proj_r2</title>
<path fill="none" stroke="black" d="M5855,-3451.49C5855,-3451.49 5655,-3451.49 5655,-3451.49 5649,-3451.49 5643,-3445.49 5643,-3439.49 5643,-3439.49 5643,-3410.49 5643,-3410.49 5643,-3404.49 5649,-3398.49 5655,-3398.49 5655,-3398.49 5855,-3398.49 5855,-3398.49 5861,-3398.49 5867,-3404.49 5867,-3410.49 5867,-3410.49 5867,-3439.49 5867,-3439.49 5867,-3445.49 5861,-3451.49 5855,-3451.49"/>
<text text-anchor="start" x="5651" y="-3436.29" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651" y="-3421.29" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651" y="-3406.29" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh2&#45;&gt;proj_r2 -->
<g id="edge47" class="edge">
<title>mgh2&#45;&gt;proj_r2</title>
<path fill="none" stroke="black" d="M5755,-3487.39C5755,-3478.72 5755,-3469.9 5755,-3461.75"/>
<polygon fill="black" stroke="black" points="5758.5,-3461.5 5755,-3451.5 5751.5,-3461.5 5758.5,-3461.5"/>
</g>
<!-- proj_ar2 -->
<g id="node52" class="node">
<title>proj_ar2</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-3325.01" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="5675" y="-3336.31" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="5675" y="-3321.31" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="5675" y="-3306.31" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r2&#45;&gt;proj_ar2 -->
<g id="edge48" class="edge">
<title>proj_r2&#45;&gt;proj_ar2</title>
<path fill="none" stroke="black" d="M5755,-3398.24C5755,-3390.42 5755,-3381.57 5755,-3372.81"/>
<polygon fill="black" stroke="black" points="5758.5,-3372.63 5755,-3362.63 5751.5,-3372.63 5758.5,-3372.63"/>
</g>
<!-- norm2 -->
<g id="node53" class="node">
<title>norm2</title>
<path fill="none" stroke="black" d="M5840,-3251.53C5840,-3251.53 5670,-3251.53 5670,-3251.53 5664,-3251.53 5658,-3245.53 5658,-3239.53 5658,-3239.53 5658,-3210.53 5658,-3210.53 5658,-3204.53 5664,-3198.53 5670,-3198.53 5670,-3198.53 5840,-3198.53 5840,-3198.53 5846,-3198.53 5852,-3204.53 5852,-3210.53 5852,-3210.53 5852,-3239.53 5852,-3239.53 5852,-3245.53 5846,-3251.53 5840,-3251.53"/>
<text text-anchor="start" x="5666" y="-3236.33" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="5666" y="-3221.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5666" y="-3206.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar2&#45;&gt;norm2 -->
<g id="edge49" class="edge">
<title>proj_ar2&#45;&gt;norm2</title>
<path fill="none" stroke="black" d="M5755,-3287.53C5755,-3279.11 5755,-3270.17 5755,-3261.78"/>
<polygon fill="black" stroke="black" points="5758.5,-3261.54 5755,-3251.54 5751.5,-3261.54 5758.5,-3261.54"/>
</g>
<!-- gate_c2 -->
<g id="node54" class="node">
<title>gate_c2</title>
<path fill="none" stroke="black" d="M5854.5,-3162.53C5854.5,-3162.53 5655.5,-3162.53 5655.5,-3162.53 5649.5,-3162.53 5643.5,-3156.53 5643.5,-3150.53 5643.5,-3150.53 5643.5,-3121.53 5643.5,-3121.53 5643.5,-3115.53 5649.5,-3109.53 5655.5,-3109.53 5655.5,-3109.53 5854.5,-3109.53 5854.5,-3109.53 5860.5,-3109.53 5866.5,-3115.53 5866.5,-3121.53 5866.5,-3121.53 5866.5,-3150.53 5866.5,-3150.53 5866.5,-3156.53 5860.5,-3162.53 5854.5,-3162.53"/>
<text text-anchor="start" x="5651.5" y="-3147.33" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651.5" y="-3132.33" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651.5" y="-3117.33" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm2&#45;&gt;gate_c2 -->
<g id="edge50" class="edge">
<title>norm2&#45;&gt;gate_c2</title>
<path fill="none" stroke="black" d="M5755,-3198.4C5755,-3190.42 5755,-3181.47 5755,-3172.92"/>
<polygon fill="black" stroke="black" points="5758.5,-3172.78 5755,-3162.78 5751.5,-3172.78 5758.5,-3172.78"/>
</g>
<!-- gate_ar2 -->
<g id="node55" class="node">
<title>gate_ar2</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-3036.06" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="5684" y="-3047.36" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="5684" y="-3032.36" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5684" y="-3017.36" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c2&#45;&gt;gate_ar2 -->
<g id="edge51" class="edge">
<title>gate_c2&#45;&gt;gate_ar2</title>
<path fill="none" stroke="black" d="M5755,-3109.29C5755,-3101.47 5755,-3092.61 5755,-3083.85"/>
<polygon fill="black" stroke="black" points="5758.5,-3083.68 5755,-3073.68 5751.5,-3083.68 5758.5,-3083.68"/>
</g>
<!-- route2 -->
<g id="node56" class="node">
<title>route2</title>
<path fill="none" stroke="black" d="M5946.41,-2962.58C5946.41,-2962.58 5646.83,-2962.58 5646.83,-2962.58 5640.83,-2962.58 5631.13,-2957.86 5627.42,-2953.14 5627.42,-2953.14 5559,-2866.02 5559,-2866.02 5555.3,-2861.3 5557.59,-2856.58 5563.59,-2856.58 5563.59,-2856.58 5863.17,-2856.58 5863.17,-2856.58 5869.17,-2856.58 5878.87,-2861.3 5882.58,-2866.02 5882.58,-2866.02 5951,-2953.14 5951,-2953.14 5954.7,-2957.86 5952.41,-2962.58 5946.41,-2962.58"/>
<text text-anchor="start" x="5593.26" y="-2920.88" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="5593.26" y="-2905.88" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5593.26" y="-2890.88" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar2&#45;&gt;route2 -->
<g id="edge52" class="edge">
<title>gate_ar2&#45;&gt;route2</title>
<path fill="none" stroke="black" d="M5755,-2998.38C5755,-2990.34 5755,-2981.61 5755,-2972.88"/>
<polygon fill="black" stroke="black" points="5758.5,-2972.67 5755,-2962.67 5751.5,-2972.67 5758.5,-2972.67"/>
</g>
<!-- a2a_s2 -->
<g id="node57" class="node">
<title>a2a_s2</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-2783.1" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="5641.5" y="-2794.4" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="5641.5" y="-2779.4" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5641.5" y="-2764.4" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route2&#45;&gt;a2a_s2 -->
<g id="edge53" class="edge">
<title>route2&#45;&gt;a2a_s2</title>
<path fill="none" stroke="black" d="M5755,-2856.51C5755,-2848.08 5755,-2839.39 5755,-2831.09"/>
<polygon fill="black" stroke="black" points="5758.5,-2830.83 5755,-2820.83 5751.5,-2830.83 5758.5,-2830.83"/>
</g>
<!-- exp2 -->
<g id="node58" class="node">
<title>exp2</title>
<path fill="none" stroke="black" d="M5869.5,-2709.63C5869.5,-2709.63 5640.5,-2709.63 5640.5,-2709.63 5634.5,-2709.63 5628.5,-2703.63 5628.5,-2697.63 5628.5,-2697.63 5628.5,-2668.63 5628.5,-2668.63 5628.5,-2662.63 5634.5,-2656.63 5640.5,-2656.63 5640.5,-2656.63 5869.5,-2656.63 5869.5,-2656.63 5875.5,-2656.63 5881.5,-2662.63 5881.5,-2668.63 5881.5,-2668.63 5881.5,-2697.63 5881.5,-2697.63 5881.5,-2703.63 5875.5,-2709.63 5869.5,-2709.63"/>
<text text-anchor="start" x="5636.5" y="-2694.43" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5636.5" y="-2679.43" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="5636.5" y="-2664.43" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s2&#45;&gt;exp2 -->
<g id="edge54" class="edge">
<title>a2a_s2&#45;&gt;exp2</title>
<path fill="none" stroke="black" d="M5755,-2745.62C5755,-2737.2 5755,-2728.26 5755,-2719.88"/>
<polygon fill="black" stroke="black" points="5758.5,-2719.64 5755,-2709.64 5751.5,-2719.64 5758.5,-2719.64"/>
</g>
<!-- exp_ar2 -->
<g id="node59" class="node">
<title>exp_ar2</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-2583.15" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="5677" y="-2594.45" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="5677" y="-2579.45" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5677" y="-2564.45" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp2&#45;&gt;exp_ar2 -->
<g id="edge55" class="edge">
<title>exp2&#45;&gt;exp_ar2</title>
<path fill="none" stroke="black" d="M5755,-2656.38C5755,-2648.56 5755,-2639.71 5755,-2630.95"/>
<polygon fill="black" stroke="black" points="5758.5,-2630.77 5755,-2620.77 5751.5,-2630.77 5758.5,-2630.77"/>
</g>
<!-- a2a_r2 -->
<g id="node60" class="node">
<title>a2a_r2</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-2472.2" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="5658.5" y="-2483.5" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="5658.5" y="-2468.5" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="5658.5" y="-2453.5" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar2&#45;&gt;a2a_r2 -->
<g id="edge56" class="edge">
<title>exp_ar2&#45;&gt;a2a_r2</title>
<path fill="none" stroke="black" d="M5755,-2545.57C5755,-2537.39 5755,-2528.61 5755,-2520.09"/>
<polygon fill="black" stroke="black" points="5758.5,-2519.87 5755,-2509.87 5751.5,-2519.87 5758.5,-2519.87"/>
</g>
<!-- agg2 -->
<g id="node61" class="node">
<title>agg2</title>
<path fill="none" stroke="black" d="M5944.26,-2398.72C5944.26,-2398.72 5648.1,-2398.72 5648.1,-2398.72 5642.1,-2398.72 5632.42,-2393.98 5628.74,-2389.24 5628.74,-2389.24 5561.1,-2302.2 5561.1,-2302.2 5557.42,-2297.46 5559.74,-2292.72 5565.74,-2292.72 5565.74,-2292.72 5861.9,-2292.72 5861.9,-2292.72 5867.9,-2292.72 5877.58,-2297.46 5881.26,-2302.2 5881.26,-2302.2 5948.9,-2389.24 5948.9,-2389.24 5952.58,-2393.98 5950.26,-2398.72 5944.26,-2398.72"/>
<text text-anchor="start" x="5594.99" y="-2357.02" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="5594.99" y="-2342.02" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5594.99" y="-2327.02" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r2&#45;&gt;agg2 -->
<g id="edge57" class="edge">
<title>a2a_r2&#45;&gt;agg2</title>
<path fill="none" stroke="black" d="M5755,-2434.52C5755,-2426.48 5755,-2417.75 5755,-2409.02"/>
<polygon fill="black" stroke="black" points="5758.5,-2408.81 5755,-2398.81 5751.5,-2408.81 5758.5,-2408.81"/>
</g>
<!-- norm_m2 -->
<g id="node62" class="node">
<title>norm_m2</title>
<path fill="none" stroke="black" d="M5835,-2256.72C5835,-2256.72 5675,-2256.72 5675,-2256.72 5669,-2256.72 5663,-2250.72 5663,-2244.72 5663,-2244.72 5663,-2215.72 5663,-2215.72 5663,-2209.72 5669,-2203.72 5675,-2203.72 5675,-2203.72 5835,-2203.72 5835,-2203.72 5841,-2203.72 5847,-2209.72 5847,-2215.72 5847,-2215.72 5847,-2244.72 5847,-2244.72 5847,-2250.72 5841,-2256.72 5835,-2256.72"/>
<text text-anchor="start" x="5671" y="-2241.52" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="5671" y="-2226.52" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5671" y="-2211.52" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg2&#45;&gt;norm_m2 -->
<g id="edge58" class="edge">
<title>agg2&#45;&gt;norm_m2</title>
<path fill="none" stroke="black" d="M5755,-2292.62C5755,-2283.95 5755,-2275.13 5755,-2266.99"/>
<polygon fill="black" stroke="black" points="5758.5,-2266.73 5755,-2256.73 5751.5,-2266.73 5758.5,-2266.73"/>
</g>
<!-- qkv_c3 -->
<g id="node63" class="node">
<title>qkv_c3</title>
<path fill="none" stroke="black" d="M5877,-2167.72C5877,-2167.72 5633,-2167.72 5633,-2167.72 5627,-2167.72 5621,-2161.72 5621,-2155.72 5621,-2155.72 5621,-2126.72 5621,-2126.72 5621,-2120.72 5627,-2114.72 5633,-2114.72 5633,-2114.72 5877,-2114.72 5877,-2114.72 5883,-2114.72 5889,-2120.72 5889,-2126.72 5889,-2126.72 5889,-2155.72 5889,-2155.72 5889,-2161.72 5883,-2167.72 5877,-2167.72"/>
<text text-anchor="start" x="5629" y="-2152.52" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="5629" y="-2137.52" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5629" y="-2122.52" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- norm_m2&#45;&gt;qkv_c3 -->
<g id="edge59" class="edge">
<title>norm_m2&#45;&gt;qkv_c3</title>
<path fill="none" stroke="black" d="M5755,-2203.59C5755,-2195.61 5755,-2186.65 5755,-2178.1"/>
<polygon fill="black" stroke="black" points="5758.5,-2177.97 5755,-2167.97 5751.5,-2177.97 5758.5,-2177.97"/>
</g>
<!-- qkv_ar3 -->
<g id="node64" class="node">
<title>qkv_ar3</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-2041.24" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="5662.5" y="-2052.54" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="5662.5" y="-2037.54" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5662.5" y="-2022.54" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- qkv_c3&#45;&gt;qkv_ar3 -->
<g id="edge60" class="edge">
<title>qkv_c3&#45;&gt;qkv_ar3</title>
<path fill="none" stroke="black" d="M5755,-2114.48C5755,-2106.65 5755,-2097.8 5755,-2089.04"/>
<polygon fill="black" stroke="black" points="5758.5,-2088.87 5755,-2078.87 5751.5,-2088.87 5758.5,-2088.87"/>
</g>
<!-- sph3 -->
<g id="node65" class="node">
<title>sph3</title>
<path fill="none" stroke="black" d="M5963.66,-1967.77C5963.66,-1967.77 5636.64,-1967.77 5636.64,-1967.77 5630.64,-1967.77 5620.75,-1963.2 5616.86,-1958.63 5616.86,-1958.63 5542.12,-1870.9 5542.12,-1870.9 5538.23,-1866.33 5540.34,-1861.77 5546.34,-1861.77 5546.34,-1861.77 5873.36,-1861.77 5873.36,-1861.77 5879.36,-1861.77 5889.25,-1866.33 5893.14,-1870.9 5893.14,-1870.9 5967.88,-1958.63 5967.88,-1958.63 5971.77,-1963.2 5969.66,-1967.77 5963.66,-1967.77"/>
<text text-anchor="start" x="5578.54" y="-1926.07" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="5578.54" y="-1911.07" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="5578.54" y="-1896.07" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- qkv_ar3&#45;&gt;sph3 -->
<g id="edge61" class="edge">
<title>qkv_ar3&#45;&gt;sph3</title>
<path fill="none" stroke="black" d="M5755,-2003.57C5755,-1995.53 5755,-1986.8 5755,-1978.07"/>
<polygon fill="black" stroke="black" points="5758.5,-1977.86 5755,-1967.86 5751.5,-1977.86 5758.5,-1977.86"/>
</g>
<!-- sdp3 -->
<g id="node66" class="node">
<title>sdp3</title>
<path fill="none" stroke="black" d="M5856,-1825.77C5856,-1825.77 5654,-1825.77 5654,-1825.77 5648,-1825.77 5642,-1819.77 5642,-1813.77 5642,-1813.77 5642,-1784.77 5642,-1784.77 5642,-1778.77 5648,-1772.77 5654,-1772.77 5654,-1772.77 5856,-1772.77 5856,-1772.77 5862,-1772.77 5868,-1778.77 5868,-1784.77 5868,-1784.77 5868,-1813.77 5868,-1813.77 5868,-1819.77 5862,-1825.77 5856,-1825.77"/>
<text text-anchor="start" x="5650" y="-1810.57" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="5650" y="-1795.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5650" y="-1780.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph3&#45;&gt;sdp3 -->
<g id="edge62" class="edge">
<title>sph3&#45;&gt;sdp3</title>
<path fill="none" stroke="black" d="M5755,-1861.67C5755,-1853 5755,-1844.18 5755,-1836.03"/>
<polygon fill="black" stroke="black" points="5758.5,-1835.78 5755,-1825.78 5751.5,-1835.78 5758.5,-1835.78"/>
</g>
<!-- sm3 -->
<g id="node67" class="node">
<title>sm3</title>
<path fill="none" stroke="black" d="M5818.5,-1736.77C5818.5,-1736.77 5691.5,-1736.77 5691.5,-1736.77 5685.5,-1736.77 5679.5,-1730.77 5679.5,-1724.77 5679.5,-1724.77 5679.5,-1695.77 5679.5,-1695.77 5679.5,-1689.77 5685.5,-1683.77 5691.5,-1683.77 5691.5,-1683.77 5818.5,-1683.77 5818.5,-1683.77 5824.5,-1683.77 5830.5,-1689.77 5830.5,-1695.77 5830.5,-1695.77 5830.5,-1724.77 5830.5,-1724.77 5830.5,-1730.77 5824.5,-1736.77 5818.5,-1736.77"/>
<text text-anchor="start" x="5687.5" y="-1721.57" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="5687.5" y="-1706.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5687.5" y="-1691.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sdp3&#45;&gt;sm3 -->
<g id="edge63" class="edge">
<title>sdp3&#45;&gt;sm3</title>
<path fill="none" stroke="black" d="M5755,-1772.63C5755,-1764.65 5755,-1755.7 5755,-1747.15"/>
<polygon fill="black" stroke="black" points="5758.5,-1747.02 5755,-1737.02 5751.5,-1747.02 5758.5,-1747.02"/>
</g>
<!-- do3 -->
<g id="node68" class="node">
<title>do3</title>
<path fill="none" stroke="black" d="M5802.5,-1647.77C5802.5,-1647.77 5707.5,-1647.77 5707.5,-1647.77 5701.5,-1647.77 5695.5,-1641.77 5695.5,-1635.77 5695.5,-1635.77 5695.5,-1606.77 5695.5,-1606.77 5695.5,-1600.77 5701.5,-1594.77 5707.5,-1594.77 5707.5,-1594.77 5802.5,-1594.77 5802.5,-1594.77 5808.5,-1594.77 5814.5,-1600.77 5814.5,-1606.77 5814.5,-1606.77 5814.5,-1635.77 5814.5,-1635.77 5814.5,-1641.77 5808.5,-1647.77 5802.5,-1647.77"/>
<text text-anchor="start" x="5703.5" y="-1632.57" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="5703.5" y="-1617.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5703.5" y="-1602.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm3&#45;&gt;do3 -->
<g id="edge64" class="edge">
<title>sm3&#45;&gt;do3</title>
<path fill="none" stroke="black" d="M5755,-1683.63C5755,-1675.65 5755,-1666.7 5755,-1658.15"/>
<polygon fill="black" stroke="black" points="5758.5,-1658.02 5755,-1648.02 5751.5,-1658.02 5758.5,-1658.02"/>
</g>
<!-- mgh3 -->
<g id="node69" class="node">
<title>mgh3</title>
<path fill="none" stroke="black" d="M5959.86,-1558.77C5959.86,-1558.77 5638.88,-1558.77 5638.88,-1558.77 5632.88,-1558.77 5623.03,-1554.17 5619.18,-1549.57 5619.18,-1549.57 5545.84,-1461.97 5545.84,-1461.97 5541.99,-1457.37 5544.14,-1452.77 5550.14,-1452.77 5550.14,-1452.77 5871.12,-1452.77 5871.12,-1452.77 5877.12,-1452.77 5886.97,-1457.37 5890.82,-1461.97 5890.82,-1461.97 5964.16,-1549.57 5964.16,-1549.57 5968.01,-1554.17 5965.86,-1558.77 5959.86,-1558.77"/>
<text text-anchor="start" x="5582" y="-1517.07" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="5582" y="-1502.07" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="5582" y="-1487.07" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- do3&#45;&gt;mgh3 -->
<g id="edge65" class="edge">
<title>do3&#45;&gt;mgh3</title>
<path fill="none" stroke="black" d="M5755,-1594.51C5755,-1586.81 5755,-1578.02 5755,-1569.04"/>
<polygon fill="black" stroke="black" points="5758.5,-1568.86 5755,-1558.86 5751.5,-1568.86 5758.5,-1568.86"/>
</g>
<!-- proj_r3 -->
<g id="node70" class="node">
<title>proj_r3</title>
<path fill="none" stroke="black" d="M5855,-1416.77C5855,-1416.77 5655,-1416.77 5655,-1416.77 5649,-1416.77 5643,-1410.77 5643,-1404.77 5643,-1404.77 5643,-1375.77 5643,-1375.77 5643,-1369.77 5649,-1363.77 5655,-1363.77 5655,-1363.77 5855,-1363.77 5855,-1363.77 5861,-1363.77 5867,-1369.77 5867,-1375.77 5867,-1375.77 5867,-1404.77 5867,-1404.77 5867,-1410.77 5861,-1416.77 5855,-1416.77"/>
<text text-anchor="start" x="5651" y="-1401.57" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651" y="-1386.57" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651" y="-1371.57" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- mgh3&#45;&gt;proj_r3 -->
<g id="edge66" class="edge">
<title>mgh3&#45;&gt;proj_r3</title>
<path fill="none" stroke="black" d="M5755,-1452.67C5755,-1444 5755,-1435.18 5755,-1427.03"/>
<polygon fill="black" stroke="black" points="5758.5,-1426.78 5755,-1416.78 5751.5,-1426.78 5758.5,-1426.78"/>
</g>
<!-- proj_ar3 -->
<g id="node71" class="node">
<title>proj_ar3</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-1290.29" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="5675" y="-1301.59" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="5675" y="-1286.59" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="5675" y="-1271.59" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_r3&#45;&gt;proj_ar3 -->
<g id="edge67" class="edge">
<title>proj_r3&#45;&gt;proj_ar3</title>
<path fill="none" stroke="black" d="M5755,-1363.52C5755,-1355.7 5755,-1346.85 5755,-1338.09"/>
<polygon fill="black" stroke="black" points="5758.5,-1337.91 5755,-1327.91 5751.5,-1337.91 5758.5,-1337.91"/>
</g>
<!-- norm3 -->
<g id="node72" class="node">
<title>norm3</title>
<path fill="none" stroke="black" d="M5840,-1216.81C5840,-1216.81 5670,-1216.81 5670,-1216.81 5664,-1216.81 5658,-1210.81 5658,-1204.81 5658,-1204.81 5658,-1175.81 5658,-1175.81 5658,-1169.81 5664,-1163.81 5670,-1163.81 5670,-1163.81 5840,-1163.81 5840,-1163.81 5846,-1163.81 5852,-1169.81 5852,-1175.81 5852,-1175.81 5852,-1204.81 5852,-1204.81 5852,-1210.81 5846,-1216.81 5840,-1216.81"/>
<text text-anchor="start" x="5666" y="-1201.61" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="5666" y="-1186.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5666" y="-1171.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- proj_ar3&#45;&gt;norm3 -->
<g id="edge68" class="edge">
<title>proj_ar3&#45;&gt;norm3</title>
<path fill="none" stroke="black" d="M5755,-1252.81C5755,-1244.39 5755,-1235.45 5755,-1227.06"/>
<polygon fill="black" stroke="black" points="5758.5,-1226.82 5755,-1216.82 5751.5,-1226.82 5758.5,-1226.82"/>
</g>
<!-- gate_c3 -->
<g id="node73" class="node">
<title>gate_c3</title>
<path fill="none" stroke="black" d="M5854.5,-1127.81C5854.5,-1127.81 5655.5,-1127.81 5655.5,-1127.81 5649.5,-1127.81 5643.5,-1121.81 5643.5,-1115.81 5643.5,-1115.81 5643.5,-1086.81 5643.5,-1086.81 5643.5,-1080.81 5649.5,-1074.81 5655.5,-1074.81 5655.5,-1074.81 5854.5,-1074.81 5854.5,-1074.81 5860.5,-1074.81 5866.5,-1080.81 5866.5,-1086.81 5866.5,-1086.81 5866.5,-1115.81 5866.5,-1115.81 5866.5,-1121.81 5860.5,-1127.81 5854.5,-1127.81"/>
<text text-anchor="start" x="5651.5" y="-1112.61" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5651.5" y="-1097.61" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5651.5" y="-1082.61" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- norm3&#45;&gt;gate_c3 -->
<g id="edge69" class="edge">
<title>norm3&#45;&gt;gate_c3</title>
<path fill="none" stroke="black" d="M5755,-1163.68C5755,-1155.7 5755,-1146.75 5755,-1138.2"/>
<polygon fill="black" stroke="black" points="5758.5,-1138.06 5755,-1128.06 5751.5,-1138.06 5758.5,-1138.06"/>
</g>
<!-- gate_ar3 -->
<g id="node74" class="node">
<title>gate_ar3</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-1001.34" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="5684" y="-1012.64" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="5684" y="-997.64" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5684" y="-982.64" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c3&#45;&gt;gate_ar3 -->
<g id="edge70" class="edge">
<title>gate_c3&#45;&gt;gate_ar3</title>
<path fill="none" stroke="black" d="M5755,-1074.57C5755,-1066.75 5755,-1057.89 5755,-1049.13"/>
<polygon fill="black" stroke="black" points="5758.5,-1048.96 5755,-1038.96 5751.5,-1048.96 5758.5,-1048.96"/>
</g>
<!-- route3 -->
<g id="node75" class="node">
<title>route3</title>
<path fill="none" stroke="black" d="M5946.41,-927.86C5946.41,-927.86 5646.83,-927.86 5646.83,-927.86 5640.83,-927.86 5631.13,-923.14 5627.42,-918.42 5627.42,-918.42 5559,-831.3 5559,-831.3 5555.3,-826.58 5557.59,-821.86 5563.59,-821.86 5563.59,-821.86 5863.17,-821.86 5863.17,-821.86 5869.17,-821.86 5878.87,-826.58 5882.58,-831.3 5882.58,-831.3 5951,-918.42 5951,-918.42 5954.7,-923.14 5952.41,-927.86 5946.41,-927.86"/>
<text text-anchor="start" x="5593.26" y="-886.16" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="5593.26" y="-871.16" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5593.26" y="-856.16" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- gate_ar3&#45;&gt;route3 -->
<g id="edge71" class="edge">
<title>gate_ar3&#45;&gt;route3</title>
<path fill="none" stroke="black" d="M5755,-963.66C5755,-955.62 5755,-946.89 5755,-938.16"/>
<polygon fill="black" stroke="black" points="5758.5,-937.95 5755,-927.95 5751.5,-937.95 5758.5,-937.95"/>
</g>
<!-- a2a_s3 -->
<g id="node76" class="node">
<title>a2a_s3</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-748.38" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="5641.5" y="-759.68" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="5641.5" y="-744.68" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5641.5" y="-729.68" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- route3&#45;&gt;a2a_s3 -->
<g id="edge72" class="edge">
<title>route3&#45;&gt;a2a_s3</title>
<path fill="none" stroke="black" d="M5755,-821.79C5755,-813.36 5755,-804.67 5755,-796.37"/>
<polygon fill="black" stroke="black" points="5758.5,-796.11 5755,-786.11 5751.5,-796.11 5758.5,-796.11"/>
</g>
<!-- exp3 -->
<g id="node77" class="node">
<title>exp3</title>
<path fill="none" stroke="black" d="M5869.5,-674.91C5869.5,-674.91 5640.5,-674.91 5640.5,-674.91 5634.5,-674.91 5628.5,-668.91 5628.5,-662.91 5628.5,-662.91 5628.5,-633.91 5628.5,-633.91 5628.5,-627.91 5634.5,-621.91 5640.5,-621.91 5640.5,-621.91 5869.5,-621.91 5869.5,-621.91 5875.5,-621.91 5881.5,-627.91 5881.5,-633.91 5881.5,-633.91 5881.5,-662.91 5881.5,-662.91 5881.5,-668.91 5875.5,-674.91 5869.5,-674.91"/>
<text text-anchor="start" x="5636.5" y="-659.71" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="5636.5" y="-644.71" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="5636.5" y="-629.71" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- a2a_s3&#45;&gt;exp3 -->
<g id="edge73" class="edge">
<title>a2a_s3&#45;&gt;exp3</title>
<path fill="none" stroke="black" d="M5755,-710.9C5755,-702.48 5755,-693.54 5755,-685.16"/>
<polygon fill="black" stroke="black" points="5758.5,-684.92 5755,-674.92 5751.5,-684.92 5758.5,-684.92"/>
</g>
<!-- exp_ar3 -->
<g id="node78" class="node">
<title>exp_ar3</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-548.43" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="5677" y="-559.73" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="5677" y="-544.73" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5677" y="-529.73" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- exp3&#45;&gt;exp_ar3 -->
<g id="edge74" class="edge">
<title>exp3&#45;&gt;exp_ar3</title>
<path fill="none" stroke="black" d="M5755,-621.66C5755,-613.84 5755,-604.99 5755,-596.23"/>
<polygon fill="black" stroke="black" points="5758.5,-596.05 5755,-586.05 5751.5,-596.05 5758.5,-596.05"/>
</g>
<!-- a2a_r3 -->
<g id="node79" class="node">
<title>a2a_r3</title>
<ellipse fill="none" stroke="black" cx="5755" cy="-437.48" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="5658.5" y="-448.78" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="5658.5" y="-433.78" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="5658.5" y="-418.78" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- exp_ar3&#45;&gt;a2a_r3 -->
<g id="edge75" class="edge">
<title>exp_ar3&#45;&gt;a2a_r3</title>
<path fill="none" stroke="black" d="M5755,-510.85C5755,-502.67 5755,-493.89 5755,-485.37"/>
<polygon fill="black" stroke="black" points="5758.5,-485.15 5755,-475.15 5751.5,-485.15 5758.5,-485.15"/>
</g>
<!-- agg3 -->
<g id="node80" class="node">
<title>agg3</title>
<path fill="none" stroke="black" d="M5944.26,-364C5944.26,-364 5648.1,-364 5648.1,-364 5642.1,-364 5632.42,-359.26 5628.74,-354.52 5628.74,-354.52 5561.1,-267.48 5561.1,-267.48 5557.42,-262.74 5559.74,-258 5565.74,-258 5565.74,-258 5861.9,-258 5861.9,-258 5867.9,-258 5877.58,-262.74 5881.26,-267.48 5881.26,-267.48 5948.9,-354.52 5948.9,-354.52 5952.58,-359.26 5950.26,-364 5944.26,-364"/>
<text text-anchor="start" x="5594.99" y="-322.3" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="5594.99" y="-307.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5594.99" y="-292.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r3&#45;&gt;agg3 -->
<g id="edge76" class="edge">
<title>a2a_r3&#45;&gt;agg3</title>
<path fill="none" stroke="black" d="M5755,-399.8C5755,-391.76 5755,-383.03 5755,-374.3"/>
<polygon fill="black" stroke="black" points="5758.5,-374.09 5755,-364.09 5751.5,-374.09 5758.5,-374.09"/>
</g>
<!-- norm_m3 -->
<g id="node81" class="node">
<title>norm_m3</title>
<path fill="none" stroke="black" d="M5835,-222C5835,-222 5675,-222 5675,-222 5669,-222 5663,-216 5663,-210 5663,-210 5663,-181 5663,-181 5663,-175 5669,-169 5675,-169 5675,-169 5835,-169 5835,-169 5841,-169 5847,-175 5847,-181 5847,-181 5847,-210 5847,-210 5847,-216 5841,-222 5835,-222"/>
<text text-anchor="start" x="5671" y="-206.8" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="5671" y="-191.8" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="5671" y="-176.8" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- agg3&#45;&gt;norm_m3 -->
<g id="edge77" class="edge">
<title>agg3&#45;&gt;norm_m3</title>
<path fill="none" stroke="black" d="M5755,-257.9C5755,-249.23 5755,-240.41 5755,-232.27"/>
<polygon fill="black" stroke="black" points="5758.5,-232.01 5755,-222.01 5751.5,-232.01 5758.5,-232.01"/>
</g>
<!-- split1 -->
<g id="node82" class="node">
<title>split1</title>
<path fill="none" stroke="black" d="M5976.04,-122C5976.04,-122 5629.33,-122 5629.33,-122 5623.33,-122 5613.31,-117.54 5609.3,-113.08 5609.3,-113.08 5529.99,-24.92 5529.99,-24.92 5525.97,-20.46 5527.96,-16 5533.96,-16 5533.96,-16 5880.67,-16 5880.67,-16 5886.67,-16 5896.69,-20.46 5900.7,-24.92 5900.7,-24.92 5980.01,-113.08 5980.01,-113.08 5984.03,-117.54 5982.04,-122 5976.04,-122"/>
<text text-anchor="start" x="5568.14" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="5568.14" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="5568.14" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- norm_m3&#45;&gt;split1 -->
<g id="edge78" class="edge">
<title>norm_m3&#45;&gt;split1</title>
<path fill="none" stroke="black" d="M5755,-168.7C5755,-158.08 5755,-145.27 5755,-132.45"/>
<polygon fill="black" stroke="black" points="5758.5,-132.21 5755,-122.21 5751.5,-132.21 5758.5,-132.21"/>
</g>
<!-- qkv_c4 -->
<g id="node83" class="node">
<title>qkv_c4</title>
<path fill="none" stroke="black" d="M5492,-95.5C5492,-95.5 5248,-95.5 5248,-95.5 5242,-95.5 5236,-89.5 5236,-83.5 5236,-83.5 5236,-54.5 5236,-54.5 5236,-48.5 5242,-42.5 5248,-42.5 5248,-42.5 5492,-42.5 5492,-42.5 5498,-42.5 5504,-48.5 5504,-54.5 5504,-54.5 5504,-83.5 5504,-83.5 5504,-89.5 5498,-95.5 5492,-95.5"/>
<text text-anchor="start" x="5244" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">QKV Column&#45;Parallel Linear (TP=16)</text>
<text text-anchor="start" x="5244" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="5244" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,192]</text>
</g>
<!-- qkv_ar4 -->
<g id="node84" class="node">
<title>qkv_ar4</title>
<ellipse fill="none" stroke="black" cx="5076" cy="-69" rx="142.26" ry="37.45"/>
<text text-anchor="start" x="4983.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce QKV (TP group)</text>
<text text-anchor="start" x="4983.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="4983.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sph4 -->
<g id="node85" class="node">
<title>sph4</title>
<path fill="none" stroke="black" d="M4903.66,-122C4903.66,-122 4576.64,-122 4576.64,-122 4570.64,-122 4560.75,-117.43 4556.86,-112.87 4556.86,-112.87 4482.12,-25.13 4482.12,-25.13 4478.23,-20.57 4480.34,-16 4486.34,-16 4486.34,-16 4813.36,-16 4813.36,-16 4819.36,-16 4829.25,-20.57 4833.14,-25.13 4833.14,-25.13 4907.88,-112.87 4907.88,-112.87 4911.77,-117.43 4909.66,-122 4903.66,-122"/>
<text text-anchor="start" x="4518.54" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Split Heads (16 heads)</text>
<text text-anchor="start" x="4518.54" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,192]</text>
<text text-anchor="start" x="4518.54" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,16,64]</text>
</g>
<!-- sdp4 -->
<g id="node86" class="node">
<title>sdp4</title>
<path fill="none" stroke="black" d="M4444,-95.5C4444,-95.5 4242,-95.5 4242,-95.5 4236,-95.5 4230,-89.5 4230,-83.5 4230,-83.5 4230,-54.5 4230,-54.5 4230,-48.5 4236,-42.5 4242,-42.5 4242,-42.5 4444,-42.5 4444,-42.5 4450,-42.5 4456,-48.5 4456,-54.5 4456,-54.5 4456,-83.5 4456,-83.5 4456,-89.5 4450,-95.5 4444,-95.5"/>
<text text-anchor="start" x="4238" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Scaled Dot&#45;Product (per head)</text>
<text text-anchor="start" x="4238" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="4238" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- sm4 -->
<g id="node87" class="node">
<title>sm4</title>
<path fill="none" stroke="black" d="M4199.5,-95.5C4199.5,-95.5 4072.5,-95.5 4072.5,-95.5 4066.5,-95.5 4060.5,-89.5 4060.5,-83.5 4060.5,-83.5 4060.5,-54.5 4060.5,-54.5 4060.5,-48.5 4066.5,-42.5 4072.5,-42.5 4072.5,-42.5 4199.5,-42.5 4199.5,-42.5 4205.5,-42.5 4211.5,-48.5 4211.5,-54.5 4211.5,-54.5 4211.5,-83.5 4211.5,-83.5 4211.5,-89.5 4205.5,-95.5 4199.5,-95.5"/>
<text text-anchor="start" x="4068.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Softmax (per head)</text>
<text text-anchor="start" x="4068.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="4068.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- do4 -->
<g id="node88" class="node">
<title>do4</title>
<path fill="none" stroke="black" d="M4030.5,-95.5C4030.5,-95.5 3935.5,-95.5 3935.5,-95.5 3929.5,-95.5 3923.5,-89.5 3923.5,-83.5 3923.5,-83.5 3923.5,-54.5 3923.5,-54.5 3923.5,-48.5 3929.5,-42.5 3935.5,-42.5 3935.5,-42.5 4030.5,-42.5 4030.5,-42.5 4036.5,-42.5 4042.5,-48.5 4042.5,-54.5 4042.5,-54.5 4042.5,-83.5 4042.5,-83.5 4042.5,-89.5 4036.5,-95.5 4030.5,-95.5"/>
<text text-anchor="start" x="3931.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Dropout (attn)</text>
<text text-anchor="start" x="3931.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="3931.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- mgh4 -->
<g id="node89" class="node">
<title>mgh4</title>
<path fill="none" stroke="black" d="M3893.86,-122C3893.86,-122 3572.88,-122 3572.88,-122 3566.88,-122 3557.03,-117.4 3553.18,-112.8 3553.18,-112.8 3479.84,-25.2 3479.84,-25.2 3475.99,-20.6 3478.14,-16 3484.14,-16 3484.14,-16 3805.12,-16 3805.12,-16 3811.12,-16 3820.97,-20.6 3824.82,-25.2 3824.82,-25.2 3898.16,-112.8 3898.16,-112.8 3902.01,-117.4 3899.86,-122 3893.86,-122"/>
<text text-anchor="start" x="3516" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Merge Heads</text>
<text text-anchor="start" x="3516" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,16,64]</text>
<text text-anchor="start" x="3516" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- proj_r4 -->
<g id="node90" class="node">
<title>proj_r4</title>
<path fill="none" stroke="black" d="M3442,-95.5C3442,-95.5 3242,-95.5 3242,-95.5 3236,-95.5 3230,-89.5 3230,-83.5 3230,-83.5 3230,-54.5 3230,-54.5 3230,-48.5 3236,-42.5 3242,-42.5 3242,-42.5 3442,-42.5 3442,-42.5 3448,-42.5 3454,-48.5 3454,-54.5 3454,-54.5 3454,-83.5 3454,-83.5 3454,-89.5 3448,-95.5 3442,-95.5"/>
<text text-anchor="start" x="3238" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Attn Proj Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="3238" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="3238" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,64]</text>
</g>
<!-- proj_ar4 -->
<g id="node91" class="node">
<title>proj_ar4</title>
<ellipse fill="none" stroke="black" cx="3088" cy="-69" rx="124.4" ry="37.45"/>
<text text-anchor="start" x="3008" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Proj (TP)</text>
<text text-anchor="start" x="3008" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,64]</text>
<text text-anchor="start" x="3008" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- norm4 -->
<g id="node92" class="node">
<title>norm4</title>
<path fill="none" stroke="black" d="M2934,-95.5C2934,-95.5 2764,-95.5 2764,-95.5 2758,-95.5 2752,-89.5 2752,-83.5 2752,-83.5 2752,-54.5 2752,-54.5 2752,-48.5 2758,-42.5 2764,-42.5 2764,-42.5 2934,-42.5 2934,-42.5 2940,-42.5 2946,-48.5 2946,-54.5 2946,-54.5 2946,-83.5 2946,-83.5 2946,-89.5 2940,-95.5 2934,-95.5"/>
<text text-anchor="start" x="2760" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm</text>
<text text-anchor="start" x="2760" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="2760" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- gate_c4 -->
<g id="node93" class="node">
<title>gate_c4</title>
<path fill="none" stroke="black" d="M2721.5,-95.5C2721.5,-95.5 2522.5,-95.5 2522.5,-95.5 2516.5,-95.5 2510.5,-89.5 2510.5,-83.5 2510.5,-83.5 2510.5,-54.5 2510.5,-54.5 2510.5,-48.5 2516.5,-42.5 2522.5,-42.5 2522.5,-42.5 2721.5,-42.5 2721.5,-42.5 2727.5,-42.5 2733.5,-48.5 2733.5,-54.5 2733.5,-54.5 2733.5,-83.5 2733.5,-83.5 2733.5,-89.5 2727.5,-95.5 2721.5,-95.5"/>
<text text-anchor="start" x="2518.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Gate Column&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="2518.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="2518.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,4]</text>
</g>
<!-- gate_ar4 -->
<g id="node94" class="node">
<title>gate_ar4</title>
<ellipse fill="none" stroke="black" cx="2381" cy="-69" rx="111.95" ry="37.45"/>
<text text-anchor="start" x="2310" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Gate (TP)</text>
<text text-anchor="start" x="2310" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="2310" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- route4 -->
<g id="node95" class="node">
<title>route4</title>
<path fill="none" stroke="black" d="M2239.41,-122C2239.41,-122 1939.83,-122 1939.83,-122 1933.83,-122 1924.13,-117.28 1920.42,-112.56 1920.42,-112.56 1852,-25.44 1852,-25.44 1848.3,-20.72 1850.59,-16 1856.59,-16 1856.59,-16 2156.17,-16 2156.17,-16 2162.17,-16 2171.87,-20.72 2175.58,-25.44 2175.58,-25.44 2244,-112.56 2244,-112.56 2247.7,-117.28 2245.41,-122 2239.41,-122"/>
<text text-anchor="start" x="1886.26" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Top&#45;2 Routing</text>
<text text-anchor="start" x="1886.26" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="1886.26" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: indices+weights</text>
</g>
<!-- a2a_s4 -->
<g id="node96" class="node">
<title>a2a_s4</title>
<ellipse fill="none" stroke="black" cx="1655" cy="-69" rx="171.65" ry="37.45"/>
<text text-anchor="start" x="1541.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Send tokens (EP=64)</text>
<text text-anchor="start" x="1541.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="1541.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: scattered to 64 experts</text>
</g>
<!-- exp4 -->
<g id="node97" class="node">
<title>exp4</title>
<path fill="none" stroke="black" d="M1453.5,-95.5C1453.5,-95.5 1224.5,-95.5 1224.5,-95.5 1218.5,-95.5 1212.5,-89.5 1212.5,-83.5 1212.5,-83.5 1212.5,-54.5 1212.5,-54.5 1212.5,-48.5 1218.5,-42.5 1224.5,-42.5 1224.5,-42.5 1453.5,-42.5 1453.5,-42.5 1459.5,-42.5 1465.5,-48.5 1465.5,-54.5 1465.5,-54.5 1465.5,-83.5 1465.5,-83.5 1465.5,-89.5 1459.5,-95.5 1453.5,-95.5"/>
<text text-anchor="start" x="1220.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Expert FFN Row&#45;Parallel (TP=16)</text>
<text text-anchor="start" x="1220.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: local tokens, hidden=1024</text>
<text text-anchor="start" x="1220.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same shape</text>
</g>
<!-- exp_ar4 -->
<g id="node98" class="node">
<title>exp_ar4</title>
<ellipse fill="none" stroke="black" cx="1073" cy="-69" rx="121.74" ry="37.45"/>
<text text-anchor="start" x="995" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;Reduce Expert (TP)</text>
<text text-anchor="start" x="995" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="995" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- a2a_r4 -->
<g id="node99" class="node">
<title>a2a_r4</title>
<ellipse fill="none" stroke="black" cx="786" cy="-69" rx="147.57" ry="37.45"/>
<text text-anchor="start" x="689.5" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">All&#45;to&#45;All Recv results</text>
<text text-anchor="start" x="689.5" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: scattered</text>
<text text-anchor="start" x="689.5" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: [128,10240,1024]</text>
</g>
<!-- agg4 -->
<g id="node100" class="node">
<title>agg4</title>
<path fill="none" stroke="black" d="M608.26,-122C608.26,-122 312.1,-122 312.1,-122 306.1,-122 296.42,-117.26 292.74,-112.52 292.74,-112.52 225.1,-25.48 225.1,-25.48 221.42,-20.74 223.74,-16 229.74,-16 229.74,-16 525.9,-16 525.9,-16 531.9,-16 541.58,-20.74 545.26,-25.48 545.26,-25.48 612.9,-112.52 612.9,-112.52 616.58,-117.26 614.26,-122 608.26,-122"/>
<text text-anchor="start" x="258.99" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Weighted Aggregate</text>
<text text-anchor="start" x="258.99" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="258.99" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- norm_m4 -->
<g id="node101" class="node">
<title>norm_m4</title>
<path fill="none" stroke="black" d="M188,-95.5C188,-95.5 28,-95.5 28,-95.5 22,-95.5 16,-89.5 16,-83.5 16,-83.5 16,-54.5 16,-54.5 16,-48.5 22,-42.5 28,-42.5 28,-42.5 188,-42.5 188,-42.5 194,-42.5 200,-48.5 200,-54.5 200,-54.5 200,-83.5 200,-83.5 200,-89.5 194,-95.5 188,-95.5"/>
<text text-anchor="start" x="24" y="-80.3" font-family="Helvetica,sans-Serif" font-size="14.00">Add &amp; LayerNorm (MoE)</text>
<text text-anchor="start" x="24" y="-65.3" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: same</text>
<text text-anchor="start" x="24" y="-50.3" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
<!-- split2 -->
<g id="node102" class="node">
<title>split2</title>
<path fill="none" stroke="black" d="M6654.04,-8566.88C6654.04,-8566.88 6307.33,-8566.88 6307.33,-8566.88 6301.33,-8566.88 6291.31,-8562.42 6287.3,-8557.96 6287.3,-8557.96 6207.99,-8469.8 6207.99,-8469.8 6203.97,-8465.34 6205.96,-8460.88 6211.96,-8460.88 6211.96,-8460.88 6558.67,-8460.88 6558.67,-8460.88 6564.67,-8460.88 6574.69,-8465.34 6578.7,-8469.8 6578.7,-8469.8 6658.01,-8557.96 6658.01,-8557.96 6662.03,-8562.42 6660.04,-8566.88 6654.04,-8566.88"/>
<text text-anchor="start" x="6246.14" y="-8525.18" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="6246.14" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="6246.14" y="-8495.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- split3 -->
<g id="node103" class="node">
<title>split3</title>
<path fill="none" stroke="black" d="M7144.04,-8566.88C7144.04,-8566.88 6797.33,-8566.88 6797.33,-8566.88 6791.33,-8566.88 6781.31,-8562.42 6777.3,-8557.96 6777.3,-8557.96 6697.99,-8469.8 6697.99,-8469.8 6693.97,-8465.34 6695.96,-8460.88 6701.96,-8460.88 6701.96,-8460.88 7048.67,-8460.88 7048.67,-8460.88 7054.67,-8460.88 7064.69,-8465.34 7068.7,-8469.8 7068.7,-8469.8 7148.01,-8557.96 7148.01,-8557.96 7152.03,-8562.42 7150.04,-8566.88 7144.04,-8566.88"/>
<text text-anchor="start" x="6736.14" y="-8525.18" font-family="Helvetica,sans-Serif" font-size="14.00">Split to TP=16 GPUs</text>
<text text-anchor="start" x="6736.14" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="6736.14" y="-8495.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: 16× [128,10240,64]</text>
</g>
<!-- output -->
<g id="node104" class="node">
<title>output</title>
<path fill="none" stroke="black" d="M7564.26,-8566.88C7564.26,-8566.88 7268.1,-8566.88 7268.1,-8566.88 7262.1,-8566.88 7252.42,-8562.14 7248.74,-8557.4 7248.74,-8557.4 7181.1,-8470.36 7181.1,-8470.36 7177.42,-8465.62 7179.74,-8460.88 7185.74,-8460.88 7185.74,-8460.88 7481.9,-8460.88 7481.9,-8460.88 7487.9,-8460.88 7497.58,-8465.62 7501.26,-8470.36 7501.26,-8470.36 7568.9,-8557.4 7568.9,-8557.4 7572.58,-8562.14 7570.26,-8566.88 7564.26,-8566.88"/>
<text text-anchor="start" x="7214.99" y="-8525.18" font-family="Helvetica,sans-Serif" font-size="14.00">Aggregate Final Hidden</text>
<text text-anchor="start" x="7214.99" y="-8510.18" font-family="Helvetica,sans-Serif" font-size="14.00">INPUT: [128,10240,1024]</text>
<text text-anchor="start" x="7214.99" y="-8495.18" font-family="Helvetica,sans-Serif" font-size="14.00">OUTPUT: same</text>
</g>
</g>
</svg>
