// Complete 32-Expert Large-Scale Parallelism
digraph {
	rankdir=LR size="150,50"
	input [label="Input
[batch=32, seq=2048, hidden=7168]" fillcolor=lightgray shape=box]
	mha [label="Multi-Head Attention
GPU: Shared
[batch=32, seq=2048, hidden=7168]" fillcolor=lightblue shape=box]
	gate [label="Gating Network
GPU: Shared
[batch=32, seq=2048, experts=32]" fillcolor=lightyellow shape=parallelogram]
	route [label="Token Routing
GPU: Shared" fillcolor=lightyellow shape=parallelogram]
	scatter [label="Token Scatter
All-to-all Comm" fillcolor=lightgreen shape=ellipse]
	subgraph cluster_gpu_0 {
		label="GPU 0" style=dotted
		expert_gate_0 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_0 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_0 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_1 {
		label="GPU 1" style=dotted
		expert_gate_1 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_1 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_1 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_2 {
		label="GPU 2" style=dotted
		expert_gate_2 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_2 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_2 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_3 {
		label="GPU 3" style=dotted
		expert_gate_3 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_3 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_3 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_4 {
		label="GPU 4" style=dotted
		expert_gate_4 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_4 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_4 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_5 {
		label="GPU 5" style=dotted
		expert_gate_5 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_5 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_5 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_6 {
		label="GPU 6" style=dotted
		expert_gate_6 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_6 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_6 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_7 {
		label="GPU 7" style=dotted
		expert_gate_7 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_7 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_7 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_8 {
		label="GPU 8" style=dotted
		expert_gate_8 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_8 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_8 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_9 {
		label="GPU 9" style=dotted
		expert_gate_9 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_9 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_9 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_10 {
		label="GPU 10" style=dotted
		expert_gate_10 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_10 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_10 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_11 {
		label="GPU 11" style=dotted
		expert_gate_11 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_11 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_11 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_12 {
		label="GPU 12" style=dotted
		expert_gate_12 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_12 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_12 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_13 {
		label="GPU 13" style=dotted
		expert_gate_13 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_13 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_13 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_14 {
		label="GPU 14" style=dotted
		expert_gate_14 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_14 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_14 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_15 {
		label="GPU 15" style=dotted
		expert_gate_15 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_15 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_15 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_16 {
		label="GPU 16" style=dotted
		expert_gate_16 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_16 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_16 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_17 {
		label="GPU 17" style=dotted
		expert_gate_17 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_17 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_17 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_18 {
		label="GPU 18" style=dotted
		expert_gate_18 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_18 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_18 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_19 {
		label="GPU 19" style=dotted
		expert_gate_19 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_19 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_19 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_20 {
		label="GPU 20" style=dotted
		expert_gate_20 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_20 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_20 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_21 {
		label="GPU 21" style=dotted
		expert_gate_21 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_21 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_21 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_22 {
		label="GPU 22" style=dotted
		expert_gate_22 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_22 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_22 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_23 {
		label="GPU 23" style=dotted
		expert_gate_23 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_23 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_23 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_24 {
		label="GPU 24" style=dotted
		expert_gate_24 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_24 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_24 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_25 {
		label="GPU 25" style=dotted
		expert_gate_25 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_25 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_25 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_26 {
		label="GPU 26" style=dotted
		expert_gate_26 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_26 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_26 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_27 {
		label="GPU 27" style=dotted
		expert_gate_27 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_27 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_27 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_28 {
		label="GPU 28" style=dotted
		expert_gate_28 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_28 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_28 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_29 {
		label="GPU 29" style=dotted
		expert_gate_29 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_29 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_29 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_30 {
		label="GPU 30" style=dotted
		expert_gate_30 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_30 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_30 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	subgraph cluster_gpu_31 {
		label="GPU 31" style=dotted
		expert_gate_31 [label="Expert Gate
[batch=?, seq=?, hidden=2048]" fillcolor=lightblue shape=box]
		expert_expert_31 [label="Expert Expert
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
		expert_multiply_31 [label="Multiply
[batch=?, seq=?, hidden=7168]" fillcolor=lightblue shape=box]
	}
	gather [label="Token Gather
All-to-all Comm" fillcolor=lightcoral shape=ellipse]
	output [label="Layer Output
[batch=32, seq=2048, hidden=7168]" fillcolor=lightgray shape=box]
	input -> mha
	input -> gate
	gate -> route
	route -> scatter
	mha -> gather
	scatter -> expert_gate_0
	expert_gate_0 -> expert_expert_0
	expert_expert_0 -> expert_multiply_0
	expert_multiply_0 -> gather
	route -> expert_gate_0 [constraint=false style=dashed]
	scatter -> expert_gate_1
	expert_gate_1 -> expert_expert_1
	expert_expert_1 -> expert_multiply_1
	expert_multiply_1 -> gather
	route -> expert_gate_1 [constraint=false style=dashed]
	scatter -> expert_gate_2
	expert_gate_2 -> expert_expert_2
	expert_expert_2 -> expert_multiply_2
	expert_multiply_2 -> gather
	route -> expert_gate_2 [constraint=false style=dashed]
	scatter -> expert_gate_3
	expert_gate_3 -> expert_expert_3
	expert_expert_3 -> expert_multiply_3
	expert_multiply_3 -> gather
	route -> expert_gate_3 [constraint=false style=dashed]
	scatter -> expert_gate_4
	expert_gate_4 -> expert_expert_4
	expert_expert_4 -> expert_multiply_4
	expert_multiply_4 -> gather
	route -> expert_gate_4 [constraint=false style=dashed]
	scatter -> expert_gate_5
	expert_gate_5 -> expert_expert_5
	expert_expert_5 -> expert_multiply_5
	expert_multiply_5 -> gather
	route -> expert_gate_5 [constraint=false style=dashed]
	scatter -> expert_gate_6
	expert_gate_6 -> expert_expert_6
	expert_expert_6 -> expert_multiply_6
	expert_multiply_6 -> gather
	route -> expert_gate_6 [constraint=false style=dashed]
	scatter -> expert_gate_7
	expert_gate_7 -> expert_expert_7
	expert_expert_7 -> expert_multiply_7
	expert_multiply_7 -> gather
	route -> expert_gate_7 [constraint=false style=dashed]
	scatter -> expert_gate_8
	expert_gate_8 -> expert_expert_8
	expert_expert_8 -> expert_multiply_8
	expert_multiply_8 -> gather
	route -> expert_gate_8 [constraint=false style=dashed]
	scatter -> expert_gate_9
	expert_gate_9 -> expert_expert_9
	expert_expert_9 -> expert_multiply_9
	expert_multiply_9 -> gather
	route -> expert_gate_9 [constraint=false style=dashed]
	scatter -> expert_gate_10
	expert_gate_10 -> expert_expert_10
	expert_expert_10 -> expert_multiply_10
	expert_multiply_10 -> gather
	route -> expert_gate_10 [constraint=false style=dashed]
	scatter -> expert_gate_11
	expert_gate_11 -> expert_expert_11
	expert_expert_11 -> expert_multiply_11
	expert_multiply_11 -> gather
	route -> expert_gate_11 [constraint=false style=dashed]
	scatter -> expert_gate_12
	expert_gate_12 -> expert_expert_12
	expert_expert_12 -> expert_multiply_12
	expert_multiply_12 -> gather
	route -> expert_gate_12 [constraint=false style=dashed]
	scatter -> expert_gate_13
	expert_gate_13 -> expert_expert_13
	expert_expert_13 -> expert_multiply_13
	expert_multiply_13 -> gather
	route -> expert_gate_13 [constraint=false style=dashed]
	scatter -> expert_gate_14
	expert_gate_14 -> expert_expert_14
	expert_expert_14 -> expert_multiply_14
	expert_multiply_14 -> gather
	route -> expert_gate_14 [constraint=false style=dashed]
	scatter -> expert_gate_15
	expert_gate_15 -> expert_expert_15
	expert_expert_15 -> expert_multiply_15
	expert_multiply_15 -> gather
	route -> expert_gate_15 [constraint=false style=dashed]
	scatter -> expert_gate_16
	expert_gate_16 -> expert_expert_16
	expert_expert_16 -> expert_multiply_16
	expert_multiply_16 -> gather
	route -> expert_gate_16 [constraint=false style=dashed]
	scatter -> expert_gate_17
	expert_gate_17 -> expert_expert_17
	expert_expert_17 -> expert_multiply_17
	expert_multiply_17 -> gather
	route -> expert_gate_17 [constraint=false style=dashed]
	scatter -> expert_gate_18
	expert_gate_18 -> expert_expert_18
	expert_expert_18 -> expert_multiply_18
	expert_multiply_18 -> gather
	route -> expert_gate_18 [constraint=false style=dashed]
	scatter -> expert_gate_19
	expert_gate_19 -> expert_expert_19
	expert_expert_19 -> expert_multiply_19
	expert_multiply_19 -> gather
	route -> expert_gate_19 [constraint=false style=dashed]
	scatter -> expert_gate_20
	expert_gate_20 -> expert_expert_20
	expert_expert_20 -> expert_multiply_20
	expert_multiply_20 -> gather
	route -> expert_gate_20 [constraint=false style=dashed]
	scatter -> expert_gate_21
	expert_gate_21 -> expert_expert_21
	expert_expert_21 -> expert_multiply_21
	expert_multiply_21 -> gather
	route -> expert_gate_21 [constraint=false style=dashed]
	scatter -> expert_gate_22
	expert_gate_22 -> expert_expert_22
	expert_expert_22 -> expert_multiply_22
	expert_multiply_22 -> gather
	route -> expert_gate_22 [constraint=false style=dashed]
	scatter -> expert_gate_23
	expert_gate_23 -> expert_expert_23
	expert_expert_23 -> expert_multiply_23
	expert_multiply_23 -> gather
	route -> expert_gate_23 [constraint=false style=dashed]
	scatter -> expert_gate_24
	expert_gate_24 -> expert_expert_24
	expert_expert_24 -> expert_multiply_24
	expert_multiply_24 -> gather
	route -> expert_gate_24 [constraint=false style=dashed]
	scatter -> expert_gate_25
	expert_gate_25 -> expert_expert_25
	expert_expert_25 -> expert_multiply_25
	expert_multiply_25 -> gather
	route -> expert_gate_25 [constraint=false style=dashed]
	scatter -> expert_gate_26
	expert_gate_26 -> expert_expert_26
	expert_expert_26 -> expert_multiply_26
	expert_multiply_26 -> gather
	route -> expert_gate_26 [constraint=false style=dashed]
	scatter -> expert_gate_27
	expert_gate_27 -> expert_expert_27
	expert_expert_27 -> expert_multiply_27
	expert_multiply_27 -> gather
	route -> expert_gate_27 [constraint=false style=dashed]
	scatter -> expert_gate_28
	expert_gate_28 -> expert_expert_28
	expert_expert_28 -> expert_multiply_28
	expert_multiply_28 -> gather
	route -> expert_gate_28 [constraint=false style=dashed]
	scatter -> expert_gate_29
	expert_gate_29 -> expert_expert_29
	expert_expert_29 -> expert_multiply_29
	expert_multiply_29 -> gather
	route -> expert_gate_29 [constraint=false style=dashed]
	scatter -> expert_gate_30
	expert_gate_30 -> expert_expert_30
	expert_expert_30 -> expert_multiply_30
	expert_multiply_30 -> gather
	route -> expert_gate_30 [constraint=false style=dashed]
	scatter -> expert_gate_31
	expert_gate_31 -> expert_expert_31
	expert_expert_31 -> expert_multiply_31
	expert_multiply_31 -> gather
	route -> expert_gate_31 [constraint=false style=dashed]
	gather -> output
}
