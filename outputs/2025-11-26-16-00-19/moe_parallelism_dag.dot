digraph "Large-Scale Cross-Node Expert Parallelism DAG" {
	rankdir=TB;
	size="100,100";
	splines=ortho;
	node [fontsize=10, height=0.8, width=2.5];

	input [label="Input Layer\nGPU: ALL\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: [batch_size=32, seq_len=2048, heads=7168]", fillcolor=lightgray, shape=box, style=filled];
	q_proj [label="Q Projection\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: [batch_size=32, seq_len=2048, heads=128, d_k=128]", fillcolor=lightblue, shape=box, style=filled];
	k_proj [label="K Projection\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: [batch_size=32, seq_len=2048, heads=128, d_k=128]", fillcolor=lightblue, shape=box, style=filled];
	v_proj [label="V Projection\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: [batch_size=32, seq_len=2048, heads=128, d_k=128]", fillcolor=lightblue, shape=box, style=filled];
	attention [label="Multi-Head Attention\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, heads=128, d_k=128]\nOutput: [batch_size=32, seq_len=2048, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	mha_out_proj [label="MHA Output Projection\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: [batch_size=32, seq_len=2048, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	gating [label="Gating Network\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: [batch_size=32, seq_len=2048, experts=32, top_k=2]", fillcolor=lightyellow, shape=parallelogram, style=filled];
	routing [label="Token Routing Decision\nGPU: Shared (All GPUs)\nInput: [batch_size=32, seq_len=2048, experts=32, top_k=2]\nOutput: Token routing masks", fillcolor=lightyellow, shape=parallelogram, style=filled];
	token_scatter [label="Token Scatter Communication\nGPU: All-to-all\nInput: [batch_size=32, seq_len=2048, heads=7168]\nOutput: Distributed tokens per expert", fillcolor=lightgreen, shape=ellipse, style=filled];
	expert_0_gate [label="Expert 0 Gate\nGPU: 0\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_0_expert [label="Expert 0 Expert\nGPU: 0\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_0_multiply [label="Expert 0 Multiply\nGPU: 0\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_1_gate [label="Expert 1 Gate\nGPU: 1\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_1_expert [label="Expert 1 Expert\nGPU: 1\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_1_multiply [label="Expert 1 Multiply\nGPU: 1\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_2_gate [label="Expert 2 Gate\nGPU: 2\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_2_expert [label="Expert 2 Expert\nGPU: 2\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_2_multiply [label="Expert 2 Multiply\nGPU: 2\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_3_gate [label="Expert 3 Gate\nGPU: 3\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_3_expert [label="Expert 3 Expert\nGPU: 3\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_3_multiply [label="Expert 3 Multiply\nGPU: 3\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_4_gate [label="Expert 4 Gate\nGPU: 4\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_4_expert [label="Expert 4 Expert\nGPU: 4\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_4_multiply [label="Expert 4 Multiply\nGPU: 4\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_5_gate [label="Expert 5 Gate\nGPU: 5\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_5_expert [label="Expert 5 Expert\nGPU: 5\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_5_multiply [label="Expert 5 Multiply\nGPU: 5\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_6_gate [label="Expert 6 Gate\nGPU: 6\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_6_expert [label="Expert 6 Expert\nGPU: 6\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_6_multiply [label="Expert 6 Multiply\nGPU: 6\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_7_gate [label="Expert 7 Gate\nGPU: 7\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_7_expert [label="Expert 7 Expert\nGPU: 7\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_7_multiply [label="Expert 7 Multiply\nGPU: 7\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_8_gate [label="Expert 8 Gate\nGPU: 8\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_8_expert [label="Expert 8 Expert\nGPU: 8\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_8_multiply [label="Expert 8 Multiply\nGPU: 8\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_9_gate [label="Expert 9 Gate\nGPU: 9\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_9_expert [label="Expert 9 Expert\nGPU: 9\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_9_multiply [label="Expert 9 Multiply\nGPU: 9\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_10_gate [label="Expert 10 Gate\nGPU: 10\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_10_expert [label="Expert 10 Expert\nGPU: 10\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_10_multiply [label="Expert 10 Multiply\nGPU: 10\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_11_gate [label="Expert 11 Gate\nGPU: 11\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];
	expert_11_expert [label="Expert 11 Expert\nGPU: 11\nInput: [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled]
	expert_11_multiply [label="Expert 11 Multiply\nGPU: 11\nInput: [batch_size=?, seq_len=?, heads=7168], [batch_size=?, seq_len=?, heads=2048]\nOutput: [batch_size=?, seq_len=?, heads=7168]", fillcolor=lightblue, shape=box, style=filled];