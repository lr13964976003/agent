digraph Large_Scale_Cross_Node_Expert_Parallelism_32_Experts {
	rankdir=TB size="200,200" splines=ortho
	node [fontsize=10 height=0.8 width=2.5]
	input [label="Input Layer
GPU: ALL
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, hidden=7168]" fillcolor=lightgray shape=box style=filled]
	q_proj [label="Q Projection
GPU: Shared
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, heads=128, d_k=128]" fillcolor=lightblue shape=box style=filled]
	k_proj [label="K Projection
GPU: Shared
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, heads=128, d_k=128]" fillcolor=lightblue shape=box style=filled]
	v_proj [label="V Projection
GPU: Shared
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, heads=128, d_k=128]" fillcolor=lightblue shape=box style=filled]
	attention [label="Multi-Head Attention
GPU: Shared
Input: [batch_size=32, seq_len=2048, heads=128, d_k=128]
Output: [batch_size=32, seq_len=2048, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	mha_out_proj [label="MHA Output Projection
GPU: Shared
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	gating [label="Gating Network
GPU: Shared
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, experts=32, top_k=2]" fillcolor=lightyellow shape=parallelogram style=filled]
	routing [label="Token Routing Decision
GPU: Shared
Input: [batch_size=32, seq_len=2048, experts=32, top_k=2]
Output: Routing decisions and token masks" fillcolor=lightyellow shape=parallelogram style=filled]
	token_scatter [label="Token Scatter Communication
GPU: All-to-all
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=7168] per expert" fillcolor=lightgreen shape=ellipse style=filled]
	expert_0_gate [label="Expert 0 Gate
GPU: 0
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_0_expert [label="Expert 0 Expert
GPU: 0
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_0_multiply [label="Expert 0 Multiply
GPU: 0
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_1_gate [label="Expert 1 Gate
GPU: 1
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_1_expert [label="Expert 1 Expert
GPU: 1
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_1_multiply [label="Expert 1 Multiply
GPU: 1
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_2_gate [label="Expert 2 Gate
GPU: 2
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_2_expert [label="Expert 2 Expert
GPU: 2
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_2_multiply [label="Expert 2 Multiply
GPU: 2
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_3_gate [label="Expert 3 Gate
GPU: 3
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_3_expert [label="Expert 3 Expert
GPU: 3
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_3_multiply [label="Expert 3 Multiply
GPU: 3
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_4_gate [label="Expert 4 Gate
GPU: 4
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_4_expert [label="Expert 4 Expert
GPU: 4
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_4_multiply [label="Expert 4 Multiply
GPU: 4
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_5_gate [label="Expert 5 Gate
GPU: 5
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_5_expert [label="Expert 5 Expert
GPU: 5
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_5_multiply [label="Expert 5 Multiply
GPU: 5
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_6_gate [label="Expert 6 Gate
GPU: 6
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_6_expert [label="Expert 6 Expert
GPU: 6
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_6_multiply [label="Expert 6 Multiply
GPU: 6
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_7_gate [label="Expert 7 Gate
GPU: 7
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_7_expert [label="Expert 7 Expert
GPU: 7
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_7_multiply [label="Expert 7 Multiply
GPU: 7
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_8_gate [label="Expert 8 Gate
GPU: 8
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_8_expert [label="Expert 8 Expert
GPU: 8
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_8_multiply [label="Expert 8 Multiply
GPU: 8
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_9_gate [label="Expert 9 Gate
GPU: 9
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_9_expert [label="Expert 9 Expert
GPU: 9
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_9_multiply [label="Expert 9 Multiply
GPU: 9
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_10_gate [label="Expert 10 Gate
GPU: 10
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_10_expert [label="Expert 10 Expert
GPU: 10
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_10_multiply [label="Expert 10 Multiply
GPU: 10
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_11_gate [label="Expert 11 Gate
GPU: 11
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_11_expert [label="Expert 11 Expert
GPU: 11
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_11_multiply [label="Expert 11 Multiply
GPU: 11
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_12_gate [label="Expert 12 Gate
GPU: 12
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_12_expert [label="Expert 12 Expert
GPU: 12
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_12_multiply [label="Expert 12 Multiply
GPU: 12
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_13_gate [label="Expert 13 Gate
GPU: 13
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_13_expert [label="Expert 13 Expert
GPU: 13
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_13_multiply [label="Expert 13 Multiply
GPU: 13
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_14_gate [label="Expert 14 Gate
GPU: 14
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_14_expert [label="Expert 14 Expert
GPU: 14
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_14_multiply [label="Expert 14 Multiply
GPU: 14
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_15_gate [label="Expert 15 Gate
GPU: 15
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_15_expert [label="Expert 15 Expert
GPU: 15
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_15_multiply [label="Expert 15 Multiply
GPU: 15
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_16_gate [label="Expert 16 Gate
GPU: 16
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_16_expert [label="Expert 16 Expert
GPU: 16
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_16_multiply [label="Expert 16 Multiply
GPU: 16
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_17_gate [label="Expert 17 Gate
GPU: 17
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_17_expert [label="Expert 17 Expert
GPU: 17
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_17_multiply [label="Expert 17 Multiply
GPU: 17
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_18_gate [label="Expert 18 Gate
GPU: 18
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_18_expert [label="Expert 18 Expert
GPU: 18
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_18_multiply [label="Expert 18 Multiply
GPU: 18
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_19_gate [label="Expert 19 Gate
GPU: 19
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_19_expert [label="Expert 19 Expert
GPU: 19
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_19_multiply [label="Expert 19 Multiply
GPU: 19
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_20_gate [label="Expert 20 Gate
GPU: 20
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_20_expert [label="Expert 20 Expert
GPU: 20
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_20_multiply [label="Expert 20 Multiply
GPU: 20
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_21_gate [label="Expert 21 Gate
GPU: 21
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_21_expert [label="Expert 21 Expert
GPU: 21
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_21_multiply [label="Expert 21 Multiply
GPU: 21
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_22_gate [label="Expert 22 Gate
GPU: 22
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_22_expert [label="Expert 22 Expert
GPU: 22
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_22_multiply [label="Expert 22 Multiply
GPU: 22
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_23_gate [label="Expert 23 Gate
GPU: 23
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_23_expert [label="Expert 23 Expert
GPU: 23
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_23_multiply [label="Expert 23 Multiply
GPU: 23
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_24_gate [label="Expert 24 Gate
GPU: 24
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_24_expert [label="Expert 24 Expert
GPU: 24
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_24_multiply [label="Expert 24 Multiply
GPU: 24
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_25_gate [label="Expert 25 Gate
GPU: 25
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_25_expert [label="Expert 25 Expert
GPU: 25
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_25_multiply [label="Expert 25 Multiply
GPU: 25
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_26_gate [label="Expert 26 Gate
GPU: 26
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_26_expert [label="Expert 26 Expert
GPU: 26
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_26_multiply [label="Expert 26 Multiply
GPU: 26
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_27_gate [label="Expert 27 Gate
GPU: 27
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_27_expert [label="Expert 27 Expert
GPU: 27
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_27_multiply [label="Expert 27 Multiply
GPU: 27
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_28_gate [label="Expert 28 Gate
GPU: 28
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_28_expert [label="Expert 28 Expert
GPU: 28
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_28_multiply [label="Expert 28 Multiply
GPU: 28
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_29_gate [label="Expert 29 Gate
GPU: 29
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_29_expert [label="Expert 29 Expert
GPU: 29
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_29_multiply [label="Expert 29 Multiply
GPU: 29
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_30_gate [label="Expert 30 Gate
GPU: 30
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_30_expert [label="Expert 30 Expert
GPU: 30
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_30_multiply [label="Expert 30 Multiply
GPU: 30
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_31_gate [label="Expert 31 Gate
GPU: 31
Input: [batch_size=4, seq_len=128, hidden=7168]
Output: [batch_size=4, seq_len=128, hidden=2048]" fillcolor=lightblue shape=box style=filled]
	expert_31_expert [label="Expert 31 Expert
GPU: 31
Input: [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	expert_31_multiply [label="Expert 31 Multiply
GPU: 31
Input: [batch_size=4, seq_len=128, hidden=7168], [batch_size=4, seq_len=128, hidden=2048]
Output: [batch_size=4, seq_len=128, hidden=7168]" fillcolor=lightblue shape=box style=filled]
	token_gather [label="Token Gather Communication
GPU: All-to-all
Input: [batch_size=4, seq_len=128, hidden=7168] from each expert
Output: [batch_size=32, seq_len=2048, hidden=7168]" fillcolor=lightcoral shape=ellipse style=filled]
	layer_output [label="Layer Output
GPU: ALL
Input: [batch_size=32, seq_len=2048, hidden=7168]
Output: [batch_size=32, seq_len=2048, hidden=7168]" fillcolor=lightgray shape=box style=filled]
	input -> q_proj
	input -> k_proj
	input -> v_proj
	q_proj -> attention
	k_proj -> attention
	v_proj -> attention
	attention -> mha_out_proj
	mha_out_proj -> gating
	input -> gating
	gating -> routing
	routing -> token_scatter
	token_scatter -> expert_0_gate
	expert_0_gate -> expert_0_expert
	expert_0_expert -> expert_0_multiply
	expert_0_multiply -> token_gather
	routing -> expert_0_gate [style=dashed]
	token_scatter -> expert_1_gate
	expert_1_gate -> expert_1_expert
	expert_1_expert -> expert_1_multiply
	expert_1_multiply -> token_gather
	routing -> expert_1_gate [style=dashed]
	token_scatter -> expert_2_gate
	expert_2_gate -> expert_2_expert
	expert_2_expert -> expert_2_multiply
	expert_2_multiply -> token_gather
	routing -> expert_2_gate [style=dashed]
	token_scatter -> expert_3_gate
	expert_3_gate -> expert_3_expert
	expert_3_expert -> expert_3_multiply
	expert_3_multiply -> token_gather
	routing -> expert_3_gate [style=dashed]
	token_scatter -> expert_4_gate
	expert_4_gate -> expert_4_expert
	expert_4_expert -> expert_4_multiply
	expert_4_multiply -> token_gather
	routing -> expert_4_gate [style=dashed]
	token_scatter -> expert_5_gate
	expert_5_gate -> expert_5_expert
	expert_5_expert -> expert_5_multiply
	expert_5_multiply -> token_gather
	routing -> expert_5_gate [style=dashed]
	token_scatter -> expert_6_gate
	expert_6_gate -> expert_6_expert
	expert_6_expert -> expert_6_multiply
	expert_6_multiply -> token_gather
	routing -> expert_6_gate [style=dashed]
	token_scatter -> expert_7_gate
	expert_7_gate -> expert_7_expert
	expert_7_expert -> expert_7_multiply
	expert_7_multiply -> token_gather
	routing -> expert_7_gate [style=dashed]
	token_scatter -> expert_8_gate
	expert_8_gate -> expert_8_expert
	expert_8_expert -> expert_8_multiply
	expert_8_multiply -> token_gather
	routing -> expert_8_gate [style=dashed]
	token_scatter -> expert_9_gate
	expert_9_gate -> expert_9_expert
	expert_9_expert -> expert_9_multiply
	expert_9_multiply -> token_gather
	routing -> expert_9_gate [style=dashed]
	token_scatter -> expert_10_gate
	expert_10_gate -> expert_10_expert
	expert_10_expert -> expert_10_multiply
	expert_10_multiply -> token_gather
	routing -> expert_10_gate [style=dashed]
	token_scatter -> expert_11_gate
	expert_11_gate -> expert_11_expert
	expert_11_expert -> expert_11_multiply
	expert_11_multiply -> token_gather
	routing -> expert_11_gate [style=dashed]
	token_scatter -> expert_12_gate
	expert_12_gate -> expert_12_expert
	expert_12_expert -> expert_12_multiply
	expert_12_multiply -> token_gather
	routing -> expert_12_gate [style=dashed]
	token_scatter -> expert_13_gate
	expert_13_gate -> expert_13_expert
	expert_13_expert -> expert_13_multiply
	expert_13_multiply -> token_gather
	routing -> expert_13_gate [style=dashed]
	token_scatter -> expert_14_gate
	expert_14_gate -> expert_14_expert
	expert_14_expert -> expert_14_multiply
	expert_14_multiply -> token_gather
	routing -> expert_14_gate [style=dashed]
	token_scatter -> expert_15_gate
	expert_15_gate -> expert_15_expert
	expert_15_expert -> expert_15_multiply
	expert_15_multiply -> token_gather
	routing -> expert_15_gate [style=dashed]
	token_scatter -> expert_16_gate
	expert_16_gate -> expert_16_expert
	expert_16_expert -> expert_16_multiply
	expert_16_multiply -> token_gather
	routing -> expert_16_gate [style=dashed]
	token_scatter -> expert_17_gate
	expert_17_gate -> expert_17_expert
	expert_17_expert -> expert_17_multiply
	expert_17_multiply -> token_gather
	routing -> expert_17_gate [style=dashed]
	token_scatter -> expert_18_gate
	expert_18_gate -> expert_18_expert
	expert_18_expert -> expert_18_multiply
	expert_18_multiply -> token_gather
	routing -> expert_18_gate [style=dashed]
	token_scatter -> expert_19_gate
	expert_19_gate -> expert_19_expert
	expert_19_expert -> expert_19_multiply
	expert_19_multiply -> token_gather
	routing -> expert_19_gate [style=dashed]
	token_scatter -> expert_20_gate
	expert_20_gate -> expert_20_expert
	expert_20_expert -> expert_20_multiply
	expert_20_multiply -> token_gather
	routing -> expert_20_gate [style=dashed]
	token_scatter -> expert_21_gate
	expert_21_gate -> expert_21_expert
	expert_21_expert -> expert_21_multiply
	expert_21_multiply -> token_gather
	routing -> expert_21_gate [style=dashed]
	token_scatter -> expert_22_gate
	expert_22_gate -> expert_22_expert
	expert_22_expert -> expert_22_multiply
	expert_22_multiply -> token_gather
	routing -> expert_22_gate [style=dashed]
	token_scatter -> expert_23_gate
	expert_23_gate -> expert_23_expert
	expert_23_expert -> expert_23_multiply
	expert_23_multiply -> token_gather
	routing -> expert_23_gate [style=dashed]
	token_scatter -> expert_24_gate
	expert_24_gate -> expert_24_expert
	expert_24_expert -> expert_24_multiply
	expert_24_multiply -> token_gather
	routing -> expert_24_gate [style=dashed]
	token_scatter -> expert_25_gate
	expert_25_gate -> expert_25_expert
	expert_25_expert -> expert_25_multiply
	expert_25_multiply -> token_gather
	routing -> expert_25_gate [style=dashed]
	token_scatter -> expert_26_gate
	expert_26_gate -> expert_26_expert
	expert_26_expert -> expert_26_multiply
	expert_26_multiply -> token_gather
	routing -> expert_26_gate [style=dashed]
	token_scatter -> expert_27_gate
	expert_27_gate -> expert_27_expert
	expert_27_expert -> expert_27_multiply
	expert_27_multiply -> token_gather
	routing -> expert_27_gate [style=dashed]
	token_scatter -> expert_28_gate
	expert_28_gate -> expert_28_expert
	expert_28_expert -> expert_28_multiply
	expert_28_multiply -> token_gather
	routing -> expert_28_gate [style=dashed]
	token_scatter -> expert_29_gate
	expert_29_gate -> expert_29_expert
	expert_29_expert -> expert_29_multiply
	expert_29_multiply -> token_gather
	routing -> expert_29_gate [style=dashed]
	token_scatter -> expert_30_gate
	expert_30_gate -> expert_30_expert
	expert_30_expert -> expert_30_multiply
	expert_30_multiply -> token_gather
	routing -> expert_30_gate [style=dashed]
	token_scatter -> expert_31_gate
	expert_31_gate -> expert_31_expert
	expert_31_expert -> expert_31_multiply
	expert_31_multiply -> token_gather
	routing -> expert_31_gate [style=dashed]
	token_gather -> layer_output
	mha_out_proj -> layer_output
}
