<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: MoE_Single_Layer_Detailed Pages: 1 -->
<svg width="2681pt" height="10500pt"
 viewBox="0.00 0.00 643.42 2520.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(3.41 3.41) rotate(0) translate(4 3074.43)">
<title>MoE_Single_Layer_Detailed</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-3074.43 782,-3074.43 782,4 -4,4"/>
<g id="clust1" class="cluster">
<title>cluster_attn_detailed</title>
<path fill="lightblue" stroke="black" stroke-width="2" d="M184,-1855.66C184,-1855.66 528,-1855.66 528,-1855.66 534,-1855.66 540,-1861.66 540,-1867.66 540,-1867.66 540,-3050.43 540,-3050.43 540,-3056.43 534,-3062.43 528,-3062.43 528,-3062.43 184,-3062.43 184,-3062.43 178,-3062.43 172,-3056.43 172,-3050.43 172,-3050.43 172,-1867.66 172,-1867.66 172,-1861.66 178,-1855.66 184,-1855.66"/>
<text text-anchor="middle" x="356" y="-3047.23" font-family="Times,serif" font-size="14.00">Attention Block &#45; Detailed Operator Breakdown</text>
</g>
<g id="clust2" class="cluster">
<title>cluster_moe_detailed</title>
<path fill="lightgreen" stroke="black" stroke-width="2" d="M20,-230.63C20,-230.63 758,-230.63 758,-230.63 764,-230.63 770,-236.63 770,-242.63 770,-242.63 770,-1824.66 770,-1824.66 770,-1830.66 764,-1836.66 758,-1836.66 758,-1836.66 20,-1836.66 20,-1836.66 14,-1836.66 8,-1830.66 8,-1824.66 8,-1824.66 8,-242.63 8,-242.63 8,-236.63 14,-230.63 20,-230.63"/>
<text text-anchor="middle" x="389" y="-1821.46" font-family="Times,serif" font-size="14.00">MoE Block &#45; Detailed Expert Parallelism</text>
</g>
<g id="clust5" class="cluster">
<title>cluster_expert_2</title>
<path fill="lightyellow" stroke="black" d="M395,-677.73C395,-677.73 539,-677.73 539,-677.73 545,-677.73 551,-683.73 551,-689.73 551,-689.73 551,-1243.56 551,-1243.56 551,-1249.56 545,-1255.56 539,-1255.56 539,-1255.56 395,-1255.56 395,-1255.56 389,-1255.56 383,-1249.56 383,-1243.56 383,-1243.56 383,-689.73 383,-689.73 383,-683.73 389,-677.73 395,-677.73"/>
<text text-anchor="middle" x="467" y="-1240.36" font-family="Times,serif" font-size="14.00">Expert 2 (EP Rank 2)</text>
</g>
<g id="clust4" class="cluster">
<title>cluster_expert_1</title>
<path fill="lightyellow" stroke="black" d="M219,-677.73C219,-677.73 363,-677.73 363,-677.73 369,-677.73 375,-683.73 375,-689.73 375,-689.73 375,-1243.56 375,-1243.56 375,-1249.56 369,-1255.56 363,-1255.56 363,-1255.56 219,-1255.56 219,-1255.56 213,-1255.56 207,-1249.56 207,-1243.56 207,-1243.56 207,-689.73 207,-689.73 207,-683.73 213,-677.73 219,-677.73"/>
<text text-anchor="middle" x="291" y="-1240.36" font-family="Times,serif" font-size="14.00">Expert 1 (EP Rank 1)</text>
</g>
<g id="clust3" class="cluster">
<title>cluster_expert_0</title>
<path fill="lightyellow" stroke="black" d="M43,-677.73C43,-677.73 187,-677.73 187,-677.73 193,-677.73 199,-683.73 199,-689.73 199,-689.73 199,-1243.56 199,-1243.56 199,-1249.56 193,-1255.56 187,-1255.56 187,-1255.56 43,-1255.56 43,-1255.56 37,-1255.56 31,-1249.56 31,-1243.56 31,-1243.56 31,-689.73 31,-689.73 31,-683.73 37,-677.73 43,-677.73"/>
<text text-anchor="middle" x="115" y="-1240.36" font-family="Times,serif" font-size="14.00">Expert 0 (EP Rank 0)</text>
</g>
<g id="clust6" class="cluster">
<title>cluster_expert_3</title>
<path fill="lightyellow" stroke="black" d="M571,-677.73C571,-677.73 715,-677.73 715,-677.73 721,-677.73 727,-683.73 727,-689.73 727,-689.73 727,-1243.56 727,-1243.56 727,-1249.56 721,-1255.56 715,-1255.56 715,-1255.56 571,-1255.56 571,-1255.56 565,-1255.56 559,-1249.56 559,-1243.56 559,-1243.56 559,-689.73 559,-689.73 559,-683.73 565,-677.73 571,-677.73"/>
<text text-anchor="middle" x="643" y="-1240.36" font-family="Times,serif" font-size="14.00">Expert 3 (EP Rank 3)</text>
</g>
<!-- input -->
<g id="node1" class="node">
<title>input</title>
<ellipse fill="white" stroke="black" stroke-width="2" cx="356" cy="-2934.61" rx="96.63" ry="96.63"/>
<text text-anchor="middle" x="356" y="-2937.21" font-family="Times,serif" font-size="8.00">Layer Input</text>
<text text-anchor="middle" x="356" y="-2928.21" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
</g>
<!-- q_proj -->
<g id="node2" class="node">
<title>q_proj</title>
<polygon fill="lightblue" stroke="black" points="285.5,-2800.79 180.5,-2800.79 180.5,-2762.79 285.5,-2762.79 285.5,-2800.79"/>
<text text-anchor="middle" x="233" y="-2793.39" font-family="Times,serif" font-size="8.00">Q Projection (TP8)</text>
<text text-anchor="middle" x="233" y="-2784.39" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="233" y="-2775.39" font-family="Times,serif" font-size="8.00">→ [heads=16, d_k=64]</text>
<text text-anchor="middle" x="233" y="-2766.39" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- input&#45;&gt;q_proj -->
<g id="edge1" class="edge">
<title>input&#45;&gt;q_proj</title>
<path fill="none" stroke="black" d="M295.22,-2859.09C280.45,-2840.97 265.62,-2822.79 254.14,-2808.72"/>
<polygon fill="black" stroke="black" points="256.83,-2806.48 247.8,-2800.94 251.41,-2810.91 256.83,-2806.48"/>
</g>
<!-- k_proj -->
<g id="node3" class="node">
<title>k_proj</title>
<polygon fill="lightblue" stroke="black" points="408.5,-2800.79 303.5,-2800.79 303.5,-2762.79 408.5,-2762.79 408.5,-2800.79"/>
<text text-anchor="middle" x="356" y="-2793.39" font-family="Times,serif" font-size="8.00">K Projection (TP8)</text>
<text text-anchor="middle" x="356" y="-2784.39" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="356" y="-2775.39" font-family="Times,serif" font-size="8.00">→ [heads=16, d_k=64]</text>
<text text-anchor="middle" x="356" y="-2766.39" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- input&#45;&gt;k_proj -->
<g id="edge2" class="edge">
<title>input&#45;&gt;k_proj</title>
<path fill="none" stroke="black" d="M356,-2837.67C356,-2828.08 356,-2818.98 356,-2811.04"/>
<polygon fill="black" stroke="black" points="359.5,-2811 356,-2801 352.5,-2811 359.5,-2811"/>
</g>
<!-- v_proj -->
<g id="node4" class="node">
<title>v_proj</title>
<polygon fill="lightblue" stroke="black" points="531.5,-2800.79 426.5,-2800.79 426.5,-2762.79 531.5,-2762.79 531.5,-2800.79"/>
<text text-anchor="middle" x="479" y="-2793.39" font-family="Times,serif" font-size="8.00">V Projection (TP8)</text>
<text text-anchor="middle" x="479" y="-2784.39" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="479" y="-2775.39" font-family="Times,serif" font-size="8.00">→ [heads=16, d_k=64]</text>
<text text-anchor="middle" x="479" y="-2766.39" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- input&#45;&gt;v_proj -->
<g id="edge3" class="edge">
<title>input&#45;&gt;v_proj</title>
<path fill="none" stroke="black" d="M416.78,-2859.09C431.55,-2840.97 446.38,-2822.79 457.86,-2808.72"/>
<polygon fill="black" stroke="black" points="460.59,-2810.91 464.2,-2800.94 455.17,-2806.48 460.59,-2810.91"/>
</g>
<!-- q_ag -->
<g id="node5" class="node">
<title>q_ag</title>
<ellipse fill="lightyellow" stroke="black" cx="235" cy="-2705.29" rx="55.31" ry="20.51"/>
<text text-anchor="middle" x="235" y="-2712.39" font-family="Times,serif" font-size="8.00">TP All&#45;Gather Q</text>
<text text-anchor="middle" x="235" y="-2703.39" font-family="Times,serif" font-size="8.00">Complete Q tensor</text>
<text text-anchor="middle" x="235" y="-2694.39" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- q_proj&#45;&gt;q_ag -->
<g id="edge4" class="edge">
<title>q_proj&#45;&gt;q_ag</title>
<path fill="none" stroke="black" d="M233.48,-2762.76C233.7,-2754.77 233.96,-2745.16 234.2,-2736.15"/>
<polygon fill="black" stroke="black" points="237.7,-2736.08 234.47,-2725.99 230.7,-2735.89 237.7,-2736.08"/>
</g>
<!-- k_ag -->
<g id="node6" class="node">
<title>k_ag</title>
<ellipse fill="lightyellow" stroke="black" cx="363" cy="-2705.29" rx="54.39" ry="20.51"/>
<text text-anchor="middle" x="363" y="-2712.39" font-family="Times,serif" font-size="8.00">TP All&#45;Gather K</text>
<text text-anchor="middle" x="363" y="-2703.39" font-family="Times,serif" font-size="8.00">Complete K tensor</text>
<text text-anchor="middle" x="363" y="-2694.39" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- k_proj&#45;&gt;k_ag -->
<g id="edge5" class="edge">
<title>k_proj&#45;&gt;k_ag</title>
<path fill="none" stroke="black" d="M357.69,-2762.76C358.44,-2754.77 359.35,-2745.16 360.19,-2736.15"/>
<polygon fill="black" stroke="black" points="363.7,-2736.27 361.15,-2725.99 356.73,-2735.62 363.7,-2736.27"/>
</g>
<!-- v_ag -->
<g id="node7" class="node">
<title>v_ag</title>
<ellipse fill="lightyellow" stroke="black" cx="478" cy="-2646.28" rx="54.39" ry="20.51"/>
<text text-anchor="middle" x="478" y="-2653.38" font-family="Times,serif" font-size="8.00">TP All&#45;Gather V</text>
<text text-anchor="middle" x="478" y="-2644.38" font-family="Times,serif" font-size="8.00">Complete V tensor</text>
<text text-anchor="middle" x="478" y="-2635.38" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- v_proj&#45;&gt;v_ag -->
<g id="edge6" class="edge">
<title>v_proj&#45;&gt;v_ag</title>
<path fill="none" stroke="black" d="M478.87,-2762.79C478.7,-2740.89 478.42,-2703.61 478.23,-2677.33"/>
<polygon fill="black" stroke="black" points="481.72,-2677.14 478.15,-2667.17 474.72,-2677.19 481.72,-2677.14"/>
</g>
<!-- attn_scores -->
<g id="node8" class="node">
<title>attn_scores</title>
<polygon fill="lightblue" stroke="black" points="458.5,-2607.77 249.5,-2607.77 249.5,-2569.77 458.5,-2569.77 458.5,-2607.77"/>
<text text-anchor="middle" x="354" y="-2600.37" font-family="Times,serif" font-size="8.00">Attention Scores</text>
<text text-anchor="middle" x="354" y="-2591.37" font-family="Times,serif" font-size="8.00">Q × K^T / sqrt(d_k)</text>
<text text-anchor="middle" x="354" y="-2582.37" font-family="Times,serif" font-size="8.00">[batch=128, heads=16, seq_q=1024, seq_k=1024]</text>
<text text-anchor="middle" x="354" y="-2573.37" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- q_ag&#45;&gt;attn_scores -->
<g id="edge7" class="edge">
<title>q_ag&#45;&gt;attn_scores</title>
<path fill="none" stroke="black" d="M254.12,-2685.89C273.98,-2666.77 305.22,-2636.71 327.47,-2615.3"/>
<polygon fill="black" stroke="black" points="330.15,-2617.58 334.93,-2608.12 325.3,-2612.54 330.15,-2617.58"/>
</g>
<!-- k_ag&#45;&gt;attn_scores -->
<g id="edge8" class="edge">
<title>k_ag&#45;&gt;attn_scores</title>
<path fill="none" stroke="black" d="M361.45,-2684.6C360.01,-2666.3 357.86,-2638.84 356.23,-2618.17"/>
<polygon fill="black" stroke="black" points="359.71,-2617.76 355.44,-2608.07 352.73,-2618.31 359.71,-2617.76"/>
</g>
<!-- attn_output -->
<g id="node11" class="node">
<title>attn_output</title>
<polygon fill="lightblue" stroke="black" points="480,-2386.77 298,-2386.77 298,-2348.77 480,-2348.77 480,-2386.77"/>
<text text-anchor="middle" x="389" y="-2379.37" font-family="Times,serif" font-size="8.00">Attention Output</text>
<text text-anchor="middle" x="389" y="-2370.37" font-family="Times,serif" font-size="8.00">Weights × V</text>
<text text-anchor="middle" x="389" y="-2361.37" font-family="Times,serif" font-size="8.00">[batch=128, heads=16, seq=1024, d_k=64]</text>
<text text-anchor="middle" x="389" y="-2352.37" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- v_ag&#45;&gt;attn_output -->
<g id="edge12" class="edge">
<title>v_ag&#45;&gt;attn_output</title>
<path fill="none" stroke="black" d="M478,-2625.57C478,-2606.65 478,-2577.26 478,-2551.77 478,-2551.77 478,-2551.77 478,-2440.77 478,-2419.59 462.58,-2403.57 444.57,-2392.08"/>
<polygon fill="black" stroke="black" points="445.98,-2388.85 435.59,-2386.8 442.44,-2394.88 445.98,-2388.85"/>
</g>
<!-- attn_mask -->
<g id="node9" class="node">
<title>attn_mask</title>
<polygon fill="lightblue" stroke="black" points="408,-2532.77 310,-2532.77 310,-2496.77 408,-2496.77 408,-2532.77"/>
<text text-anchor="middle" x="359" y="-2521.87" font-family="Times,serif" font-size="8.00">Causal Mask</text>
<text text-anchor="middle" x="359" y="-2512.87" font-family="Times,serif" font-size="8.00">Triangular mask</text>
<text text-anchor="middle" x="359" y="-2503.87" font-family="Times,serif" font-size="8.00">[seq=1024, seq=1024]</text>
</g>
<!-- attn_scores&#45;&gt;attn_mask -->
<g id="edge9" class="edge">
<title>attn_scores&#45;&gt;attn_mask</title>
<path fill="none" stroke="black" d="M355.26,-2569.6C355.81,-2561.66 356.47,-2552.18 357.08,-2543.4"/>
<polygon fill="black" stroke="black" points="360.59,-2543.41 357.79,-2533.19 353.61,-2542.92 360.59,-2543.41"/>
</g>
<!-- attn_softmax -->
<g id="node10" class="node">
<title>attn_softmax</title>
<polygon fill="lightblue" stroke="black" points="458,-2459.77 266,-2459.77 266,-2423.77 458,-2423.77 458,-2459.77"/>
<text text-anchor="middle" x="362" y="-2448.87" font-family="Times,serif" font-size="8.00">Softmax</text>
<text text-anchor="middle" x="362" y="-2439.87" font-family="Times,serif" font-size="8.00">[batch=128, heads=16, seq=1024, seq=1024]</text>
<text text-anchor="middle" x="362" y="-2430.87" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- attn_mask&#45;&gt;attn_softmax -->
<g id="edge10" class="edge">
<title>attn_mask&#45;&gt;attn_softmax</title>
<path fill="none" stroke="black" d="M359.73,-2496.58C360.07,-2488.56 360.48,-2478.82 360.86,-2469.84"/>
<polygon fill="black" stroke="black" points="364.36,-2469.94 361.28,-2459.8 357.36,-2469.64 364.36,-2469.94"/>
</g>
<!-- attn_softmax&#45;&gt;attn_output -->
<g id="edge11" class="edge">
<title>attn_softmax&#45;&gt;attn_output</title>
<path fill="none" stroke="black" d="M368.4,-2423.71C371.44,-2415.58 375.17,-2405.66 378.6,-2396.5"/>
<polygon fill="black" stroke="black" points="381.94,-2397.56 382.18,-2386.97 375.39,-2395.1 381.94,-2397.56"/>
</g>
<!-- attn_ar -->
<g id="node12" class="node">
<title>attn_ar</title>
<ellipse fill="lightyellow" stroke="black" cx="389" cy="-2284.9" rx="113.69" ry="26.74"/>
<text text-anchor="middle" x="389" y="-2296.5" font-family="Times,serif" font-size="8.00">TP All&#45;Reduce</text>
<text text-anchor="middle" x="389" y="-2287.5" font-family="Times,serif" font-size="8.00">Sum partial results</text>
<text text-anchor="middle" x="389" y="-2278.5" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="389" y="-2269.5" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- attn_output&#45;&gt;attn_ar -->
<g id="edge13" class="edge">
<title>attn_output&#45;&gt;attn_ar</title>
<path fill="none" stroke="black" d="M389,-2348.42C389,-2340.56 389,-2331.1 389,-2321.95"/>
<polygon fill="black" stroke="black" points="392.5,-2321.84 389,-2311.84 385.5,-2321.84 392.5,-2321.84"/>
</g>
<!-- out_proj -->
<g id="node13" class="node">
<title>out_proj</title>
<polygon fill="lightblue" stroke="black" points="441.5,-2221.03 336.5,-2221.03 336.5,-2185.03 441.5,-2185.03 441.5,-2221.03"/>
<text text-anchor="middle" x="389" y="-2210.13" font-family="Times,serif" font-size="8.00">Output Projection (TP8)</text>
<text text-anchor="middle" x="389" y="-2201.13" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="389" y="-2192.13" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- attn_ar&#45;&gt;out_proj -->
<g id="edge14" class="edge">
<title>attn_ar&#45;&gt;out_proj</title>
<path fill="none" stroke="black" d="M389,-2257.75C389,-2249.3 389,-2239.92 389,-2231.39"/>
<polygon fill="black" stroke="black" points="392.5,-2231.18 389,-2221.18 385.5,-2231.18 392.5,-2231.18"/>
</g>
<!-- final_ar -->
<g id="node14" class="node">
<title>final_ar</title>
<ellipse fill="lightyellow" stroke="black" cx="389" cy="-2121.16" rx="113.69" ry="26.74"/>
<text text-anchor="middle" x="389" y="-2132.76" font-family="Times,serif" font-size="8.00">Final TP All&#45;Reduce</text>
<text text-anchor="middle" x="389" y="-2123.76" font-family="Times,serif" font-size="8.00">Complete attention output</text>
<text text-anchor="middle" x="389" y="-2114.76" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="389" y="-2105.76" font-family="Times,serif" font-size="8.00">GPU: TP0&#45;TP7</text>
</g>
<!-- out_proj&#45;&gt;final_ar -->
<g id="edge15" class="edge">
<title>out_proj&#45;&gt;final_ar</title>
<path fill="none" stroke="black" d="M389,-2184.7C389,-2176.97 389,-2167.55 389,-2158.39"/>
<polygon fill="black" stroke="black" points="392.5,-2158.26 389,-2148.26 385.5,-2158.26 392.5,-2158.26"/>
</g>
<!-- attn_final -->
<g id="node15" class="node">
<title>attn_final</title>
<ellipse fill="white" stroke="black" cx="389" cy="-1960.47" rx="96.63" ry="96.63"/>
<text text-anchor="middle" x="389" y="-1963.07" font-family="Times,serif" font-size="8.00">Attention Block Output</text>
<text text-anchor="middle" x="389" y="-1954.07" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
</g>
<!-- final_ar&#45;&gt;attn_final -->
<g id="edge16" class="edge">
<title>final_ar&#45;&gt;attn_final</title>
<path fill="none" stroke="black" d="M389,-2093.96C389,-2086.18 389,-2077.15 389,-2067.52"/>
<polygon fill="black" stroke="black" points="392.5,-2067.3 389,-2057.3 385.5,-2067.3 392.5,-2067.3"/>
</g>
<!-- moe_input -->
<g id="node16" class="node">
<title>moe_input</title>
<ellipse fill="white" stroke="black" cx="389" cy="-1708.84" rx="96.63" ry="96.63"/>
<text text-anchor="middle" x="389" y="-1711.44" font-family="Times,serif" font-size="8.00">MoE Input</text>
<text text-anchor="middle" x="389" y="-1702.44" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
</g>
<!-- attn_final&#45;&gt;moe_input -->
<g id="edge37" class="edge">
<title>attn_final&#45;&gt;moe_input</title>
<path fill="none" stroke="black" d="M389,-1863.32C389,-1847.88 389,-1831.83 389,-1816.17"/>
<polygon fill="black" stroke="black" points="392.5,-1815.95 389,-1805.95 385.5,-1815.95 392.5,-1815.95"/>
</g>
<!-- gate_compute -->
<g id="node17" class="node">
<title>gate_compute</title>
<polygon fill="lightgreen" stroke="black" points="493.92,-1575.03 327.01,-1575.03 284.08,-1481.03 450.99,-1481.03 493.92,-1575.03"/>
<text text-anchor="middle" x="389" y="-1544.13" font-family="Times,serif" font-size="8.00">Gate Computation</text>
<text text-anchor="middle" x="389" y="-1535.13" font-family="Times,serif" font-size="8.00">Linear + Softmax</text>
<text text-anchor="middle" x="389" y="-1526.13" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="389" y="-1517.13" font-family="Times,serif" font-size="8.00">→ [num_experts=64]</text>
<text text-anchor="middle" x="389" y="-1508.13" font-family="Times,serif" font-size="8.00">GPU: All EP Ranks</text>
</g>
<!-- moe_input&#45;&gt;gate_compute -->
<g id="edge38" class="edge">
<title>moe_input&#45;&gt;gate_compute</title>
<path fill="none" stroke="black" d="M389,-1611.89C389,-1602.82 389,-1593.84 389,-1585.33"/>
<polygon fill="black" stroke="black" points="392.5,-1585.2 389,-1575.2 385.5,-1585.2 392.5,-1585.2"/>
</g>
<!-- top2_select -->
<g id="node18" class="node">
<title>top2_select</title>
<polygon fill="lightgreen" stroke="black" points="516.54,-1444.03 313.65,-1444.03 261.46,-1386.03 464.35,-1386.03 516.54,-1444.03"/>
<text text-anchor="middle" x="389" y="-1422.13" font-family="Times,serif" font-size="8.00">Top&#45;2 Expert Selection</text>
<text text-anchor="middle" x="389" y="-1413.13" font-family="Times,serif" font-size="8.00">Select highest scoring experts</text>
<text text-anchor="middle" x="389" y="-1404.13" font-family="Times,serif" font-size="8.00">GPU: All EP Ranks</text>
</g>
<!-- gate_compute&#45;&gt;top2_select -->
<g id="edge39" class="edge">
<title>gate_compute&#45;&gt;top2_select</title>
<path fill="none" stroke="black" d="M389,-1480.92C389,-1472.03 389,-1462.8 389,-1454.2"/>
<polygon fill="black" stroke="black" points="392.5,-1454.07 389,-1444.07 385.5,-1454.07 392.5,-1454.07"/>
</g>
<!-- dispatch -->
<g id="node19" class="node">
<title>dispatch</title>
<ellipse fill="lightyellow" stroke="black" cx="389" cy="-1315.79" rx="81.13" ry="33.47"/>
<text text-anchor="middle" x="389" y="-1331.89" font-family="Times,serif" font-size="8.00">Expert Dispatch</text>
<text text-anchor="middle" x="389" y="-1322.89" font-family="Times,serif" font-size="8.00">All&#45;to&#45;All Communication</text>
<text text-anchor="middle" x="389" y="-1313.89" font-family="Times,serif" font-size="8.00">Send tokens to expert GPUs</text>
<text text-anchor="middle" x="389" y="-1304.89" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="389" y="-1295.89" font-family="Times,serif" font-size="8.00">GPU: EP0&#45;EP63</text>
</g>
<!-- top2_select&#45;&gt;dispatch -->
<g id="edge40" class="edge">
<title>top2_select&#45;&gt;dispatch</title>
<path fill="none" stroke="black" d="M389,-1385.9C389,-1377.68 389,-1368.5 389,-1359.58"/>
<polygon fill="black" stroke="black" points="392.5,-1359.31 389,-1349.31 385.5,-1359.31 392.5,-1359.31"/>
</g>
<!-- expert_recv_0 -->
<g id="node20" class="node">
<title>expert_recv_0</title>
<ellipse fill="white" stroke="black" cx="122" cy="-1173.65" rx="50.82" ry="50.82"/>
<text text-anchor="middle" x="122" y="-1180.75" font-family="Times,serif" font-size="8.00">Expert 0 Receive</text>
<text text-anchor="middle" x="122" y="-1171.75" font-family="Times,serif" font-size="8.00">Subset of tokens</text>
<text text-anchor="middle" x="122" y="-1162.75" font-family="Times,serif" font-size="8.00">GPU: EP0</text>
</g>
<!-- top2_select&#45;&gt;expert_recv_0 -->
<g id="edge51" class="edge">
<title>top2_select&#45;&gt;expert_recv_0</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M279.95,-1406.79C196.46,-1398.7 91.13,-1382.12 64,-1349.03 34.01,-1312.44 58.22,-1259.73 83.91,-1221.85"/>
<polygon fill="black" stroke="black" points="86.87,-1223.73 89.74,-1213.53 81.13,-1219.71 86.87,-1223.73"/>
<text text-anchor="middle" x="119" y="-1312.09" font-family="Times,serif" font-size="14.00">Top&#45;2 Selection</text>
</g>
<!-- expert_recv_1 -->
<g id="node26" class="node">
<title>expert_recv_1</title>
<ellipse fill="white" stroke="black" cx="298" cy="-1173.65" rx="50.82" ry="50.82"/>
<text text-anchor="middle" x="298" y="-1180.75" font-family="Times,serif" font-size="8.00">Expert 1 Receive</text>
<text text-anchor="middle" x="298" y="-1171.75" font-family="Times,serif" font-size="8.00">Subset of tokens</text>
<text text-anchor="middle" x="298" y="-1162.75" font-family="Times,serif" font-size="8.00">GPU: EP1</text>
</g>
<!-- top2_select&#45;&gt;expert_recv_1 -->
<g id="edge52" class="edge">
<title>top2_select&#45;&gt;expert_recv_1</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M276.42,-1402.82C242.88,-1393.61 209.6,-1377.38 189,-1349.03 155.52,-1302.94 206.12,-1246.56 249,-1210.62"/>
<polygon fill="black" stroke="black" points="251.37,-1213.2 256.89,-1204.15 246.94,-1207.78 251.37,-1213.2"/>
<text text-anchor="middle" x="244" y="-1312.09" font-family="Times,serif" font-size="14.00">Top&#45;2 Selection</text>
</g>
<!-- expert_recv_2 -->
<g id="node32" class="node">
<title>expert_recv_2</title>
<ellipse fill="white" stroke="black" cx="460" cy="-1173.65" rx="50.82" ry="50.82"/>
<text text-anchor="middle" x="460" y="-1180.75" font-family="Times,serif" font-size="8.00">Expert 2 Receive</text>
<text text-anchor="middle" x="460" y="-1171.75" font-family="Times,serif" font-size="8.00">Subset of tokens</text>
<text text-anchor="middle" x="460" y="-1162.75" font-family="Times,serif" font-size="8.00">GPU: EP2</text>
</g>
<!-- top2_select&#45;&gt;expert_recv_2 -->
<g id="edge53" class="edge">
<title>top2_select&#45;&gt;expert_recv_2</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M444.9,-1385.97C458.53,-1376.25 471.37,-1363.96 479,-1349.03 497.57,-1312.72 491.51,-1266.68 481.51,-1231.03"/>
<polygon fill="black" stroke="black" points="484.81,-1229.85 478.6,-1221.26 478.1,-1231.85 484.81,-1229.85"/>
<text text-anchor="middle" x="546" y="-1312.09" font-family="Times,serif" font-size="14.00">Top&#45;2 Selection</text>
</g>
<!-- expert_recv_3 -->
<g id="node38" class="node">
<title>expert_recv_3</title>
<ellipse fill="white" stroke="black" cx="636" cy="-1173.65" rx="50.82" ry="50.82"/>
<text text-anchor="middle" x="636" y="-1180.75" font-family="Times,serif" font-size="8.00">Expert 3 Receive</text>
<text text-anchor="middle" x="636" y="-1171.75" font-family="Times,serif" font-size="8.00">Subset of tokens</text>
<text text-anchor="middle" x="636" y="-1162.75" font-family="Times,serif" font-size="8.00">GPU: EP3</text>
</g>
<!-- top2_select&#45;&gt;expert_recv_3 -->
<g id="edge54" class="edge">
<title>top2_select&#45;&gt;expert_recv_3</title>
<path fill="none" stroke="black" stroke-dasharray="5,2" d="M483.95,-1407.62C526.81,-1399.77 574.54,-1383.26 605,-1349.03 632.37,-1318.27 639.59,-1271.98 640.25,-1234.82"/>
<polygon fill="black" stroke="black" points="643.75,-1234.61 640.27,-1224.6 636.75,-1234.59 643.75,-1234.61"/>
<text text-anchor="middle" x="690" y="-1312.09" font-family="Times,serif" font-size="14.00">Top&#45;2 Selection</text>
</g>
<!-- dispatch&#45;&gt;expert_recv_0 -->
<g id="edge41" class="edge">
<title>dispatch&#45;&gt;expert_recv_0</title>
<path fill="none" stroke="black" d="M328.05,-1293.72C316.75,-1289.93 305.04,-1286.07 294,-1282.56 253.8,-1269.78 239.26,-1277.13 203,-1255.56 187.72,-1246.47 173.23,-1233.86 160.84,-1221.29"/>
<polygon fill="black" stroke="black" points="163.24,-1218.73 153.8,-1213.92 158.18,-1223.57 163.24,-1218.73"/>
</g>
<!-- dispatch&#45;&gt;expert_recv_1 -->
<g id="edge42" class="edge">
<title>dispatch&#45;&gt;expert_recv_1</title>
<path fill="none" stroke="black" d="M368.58,-1283.34C357.49,-1266.26 343.5,-1244.72 330.91,-1225.34"/>
<polygon fill="black" stroke="black" points="333.81,-1223.37 325.43,-1216.89 327.94,-1227.19 333.81,-1223.37"/>
</g>
<!-- dispatch&#45;&gt;expert_recv_2 -->
<g id="edge43" class="edge">
<title>dispatch&#45;&gt;expert_recv_2</title>
<path fill="none" stroke="black" d="M405.11,-1282.99C413.27,-1266.9 423.39,-1246.91 432.71,-1228.51"/>
<polygon fill="black" stroke="black" points="435.96,-1229.84 437.36,-1219.34 429.72,-1226.68 435.96,-1229.84"/>
</g>
<!-- dispatch&#45;&gt;expert_recv_3 -->
<g id="edge44" class="edge">
<title>dispatch&#45;&gt;expert_recv_3</title>
<path fill="none" stroke="black" d="M450.15,-1293.68C495.48,-1277.91 550.22,-1258.59 555,-1255.56 570.03,-1246.06 584.44,-1233.32 596.84,-1220.77"/>
<polygon fill="black" stroke="black" points="599.49,-1223.06 603.89,-1213.42 594.44,-1218.21 599.49,-1223.06"/>
</g>
<!-- expert_mlp1_0 -->
<g id="node21" class="node">
<title>expert_mlp1_0</title>
<polygon fill="lightblue" stroke="black" points="185,-1085.74 59,-1085.74 59,-1047.74 185,-1047.74 185,-1085.74"/>
<text text-anchor="middle" x="122" y="-1078.34" font-family="Times,serif" font-size="8.00">Expert 0 MLP Layer 1 (TP8)</text>
<text text-anchor="middle" x="122" y="-1069.34" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="122" y="-1060.34" font-family="Times,serif" font-size="8.00">→ [2048]</text>
<text text-anchor="middle" x="122" y="-1051.34" font-family="Times,serif" font-size="8.00">GPU: EP0, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_recv_0&#45;&gt;expert_mlp1_0 -->
<g id="edge17" class="edge">
<title>expert_recv_0&#45;&gt;expert_mlp1_0</title>
<path fill="none" stroke="black" d="M122,-1122.65C122,-1113.55 122,-1104.35 122,-1096.15"/>
<polygon fill="black" stroke="black" points="125.5,-1096.04 122,-1086.04 118.5,-1096.04 125.5,-1096.04"/>
</g>
<!-- expert_act_0 -->
<g id="node22" class="node">
<title>expert_act_0</title>
<polygon fill="lightblue" stroke="black" points="170.5,-1010.74 73.5,-1010.74 73.5,-974.74 170.5,-974.74 170.5,-1010.74"/>
<text text-anchor="middle" x="122" y="-995.34" font-family="Times,serif" font-size="8.00">Activation (SiLU/GeLU)</text>
<text text-anchor="middle" x="122" y="-986.34" font-family="Times,serif" font-size="8.00">GPU: EP0, TP0&#45;TP7</text>
</g>
<!-- expert_mlp1_0&#45;&gt;expert_act_0 -->
<g id="edge18" class="edge">
<title>expert_mlp1_0&#45;&gt;expert_act_0</title>
<path fill="none" stroke="black" d="M122,-1047.57C122,-1039.63 122,-1030.15 122,-1021.37"/>
<polygon fill="black" stroke="black" points="125.5,-1021.15 122,-1011.15 118.5,-1021.15 125.5,-1021.15"/>
</g>
<!-- expert_mlp2_0 -->
<g id="node23" class="node">
<title>expert_mlp2_0</title>
<polygon fill="lightblue" stroke="black" points="185,-937.74 59,-937.74 59,-899.74 185,-899.74 185,-937.74"/>
<text text-anchor="middle" x="122" y="-930.34" font-family="Times,serif" font-size="8.00">Expert 0 MLP Layer 2 (TP8)</text>
<text text-anchor="middle" x="122" y="-921.34" font-family="Times,serif" font-size="8.00">[2048]</text>
<text text-anchor="middle" x="122" y="-912.34" font-family="Times,serif" font-size="8.00">→ [hidden=1024]</text>
<text text-anchor="middle" x="122" y="-903.34" font-family="Times,serif" font-size="8.00">GPU: EP0, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_act_0&#45;&gt;expert_mlp2_0 -->
<g id="edge19" class="edge">
<title>expert_act_0&#45;&gt;expert_mlp2_0</title>
<path fill="none" stroke="black" d="M122,-974.67C122,-966.72 122,-957.05 122,-948.05"/>
<polygon fill="black" stroke="black" points="125.5,-947.94 122,-937.94 118.5,-947.94 125.5,-947.94"/>
</g>
<!-- expert_ar_0 -->
<g id="node24" class="node">
<title>expert_ar_0</title>
<ellipse fill="lightyellow" stroke="black" cx="122" cy="-842.23" rx="69.09" ry="20.51"/>
<text text-anchor="middle" x="122" y="-849.33" font-family="Times,serif" font-size="8.00">Expert 0 TP All&#45;Reduce</text>
<text text-anchor="middle" x="122" y="-840.33" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="122" y="-831.33" font-family="Times,serif" font-size="8.00">GPU: EP0, TP0&#45;TP7</text>
</g>
<!-- expert_mlp2_0&#45;&gt;expert_ar_0 -->
<g id="edge20" class="edge">
<title>expert_mlp2_0&#45;&gt;expert_ar_0</title>
<path fill="none" stroke="black" d="M122,-899.7C122,-891.71 122,-882.11 122,-873.1"/>
<polygon fill="black" stroke="black" points="125.5,-872.93 122,-862.93 118.5,-872.93 125.5,-872.93"/>
</g>
<!-- expert_done_0 -->
<g id="node25" class="node">
<title>expert_done_0</title>
<ellipse fill="white" stroke="black" cx="132" cy="-735.23" rx="49.49" ry="49.49"/>
<text text-anchor="middle" x="132" y="-737.83" font-family="Times,serif" font-size="8.00">Expert 0 Output</text>
<text text-anchor="middle" x="132" y="-728.83" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
</g>
<!-- expert_ar_0&#45;&gt;expert_done_0 -->
<g id="edge21" class="edge">
<title>expert_ar_0&#45;&gt;expert_done_0</title>
<path fill="none" stroke="black" d="M123.88,-821.48C124.62,-813.72 125.51,-804.37 126.43,-794.75"/>
<polygon fill="black" stroke="black" points="129.92,-794.96 127.39,-784.68 122.95,-794.3 129.92,-794.96"/>
</g>
<!-- combine -->
<g id="node45" class="node">
<title>combine</title>
<ellipse fill="lightyellow" stroke="black" cx="384" cy="-615.5" rx="73.58" ry="33.47"/>
<text text-anchor="middle" x="384" y="-631.6" font-family="Times,serif" font-size="8.00">Expert Combine</text>
<text text-anchor="middle" x="384" y="-622.6" font-family="Times,serif" font-size="8.00">All&#45;to&#45;All Communication</text>
<text text-anchor="middle" x="384" y="-613.6" font-family="Times,serif" font-size="8.00">Gather expert outputs</text>
<text text-anchor="middle" x="384" y="-604.6" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024]</text>
<text text-anchor="middle" x="384" y="-595.6" font-family="Times,serif" font-size="8.00">GPU: EP0&#45;EP63</text>
</g>
<!-- expert_done_0&#45;&gt;combine -->
<g id="edge45" class="edge">
<title>expert_done_0&#45;&gt;combine</title>
<path fill="none" stroke="black" d="M168.24,-701.45C178.91,-692.92 190.97,-684.29 203,-677.73 236.53,-659.45 276.51,-645.22 310.36,-635.11"/>
<polygon fill="black" stroke="black" points="311.58,-638.4 320.19,-632.23 309.61,-631.68 311.58,-638.4"/>
</g>
<!-- expert_mlp1_1 -->
<g id="node27" class="node">
<title>expert_mlp1_1</title>
<polygon fill="lightblue" stroke="black" points="361,-1085.74 235,-1085.74 235,-1047.74 361,-1047.74 361,-1085.74"/>
<text text-anchor="middle" x="298" y="-1078.34" font-family="Times,serif" font-size="8.00">Expert 1 MLP Layer 1 (TP8)</text>
<text text-anchor="middle" x="298" y="-1069.34" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="298" y="-1060.34" font-family="Times,serif" font-size="8.00">→ [2048]</text>
<text text-anchor="middle" x="298" y="-1051.34" font-family="Times,serif" font-size="8.00">GPU: EP1, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_recv_1&#45;&gt;expert_mlp1_1 -->
<g id="edge22" class="edge">
<title>expert_recv_1&#45;&gt;expert_mlp1_1</title>
<path fill="none" stroke="black" d="M298,-1122.65C298,-1113.55 298,-1104.35 298,-1096.15"/>
<polygon fill="black" stroke="black" points="301.5,-1096.04 298,-1086.04 294.5,-1096.04 301.5,-1096.04"/>
</g>
<!-- expert_act_1 -->
<g id="node28" class="node">
<title>expert_act_1</title>
<polygon fill="lightblue" stroke="black" points="346.5,-1010.74 249.5,-1010.74 249.5,-974.74 346.5,-974.74 346.5,-1010.74"/>
<text text-anchor="middle" x="298" y="-995.34" font-family="Times,serif" font-size="8.00">Activation (SiLU/GeLU)</text>
<text text-anchor="middle" x="298" y="-986.34" font-family="Times,serif" font-size="8.00">GPU: EP1, TP0&#45;TP7</text>
</g>
<!-- expert_mlp1_1&#45;&gt;expert_act_1 -->
<g id="edge23" class="edge">
<title>expert_mlp1_1&#45;&gt;expert_act_1</title>
<path fill="none" stroke="black" d="M298,-1047.57C298,-1039.63 298,-1030.15 298,-1021.37"/>
<polygon fill="black" stroke="black" points="301.5,-1021.15 298,-1011.15 294.5,-1021.15 301.5,-1021.15"/>
</g>
<!-- expert_mlp2_1 -->
<g id="node29" class="node">
<title>expert_mlp2_1</title>
<polygon fill="lightblue" stroke="black" points="361,-937.74 235,-937.74 235,-899.74 361,-899.74 361,-937.74"/>
<text text-anchor="middle" x="298" y="-930.34" font-family="Times,serif" font-size="8.00">Expert 1 MLP Layer 2 (TP8)</text>
<text text-anchor="middle" x="298" y="-921.34" font-family="Times,serif" font-size="8.00">[2048]</text>
<text text-anchor="middle" x="298" y="-912.34" font-family="Times,serif" font-size="8.00">→ [hidden=1024]</text>
<text text-anchor="middle" x="298" y="-903.34" font-family="Times,serif" font-size="8.00">GPU: EP1, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_act_1&#45;&gt;expert_mlp2_1 -->
<g id="edge24" class="edge">
<title>expert_act_1&#45;&gt;expert_mlp2_1</title>
<path fill="none" stroke="black" d="M298,-974.67C298,-966.72 298,-957.05 298,-948.05"/>
<polygon fill="black" stroke="black" points="301.5,-947.94 298,-937.94 294.5,-947.94 301.5,-947.94"/>
</g>
<!-- expert_ar_1 -->
<g id="node30" class="node">
<title>expert_ar_1</title>
<ellipse fill="lightyellow" stroke="black" cx="298" cy="-842.23" rx="69.09" ry="20.51"/>
<text text-anchor="middle" x="298" y="-849.33" font-family="Times,serif" font-size="8.00">Expert 1 TP All&#45;Reduce</text>
<text text-anchor="middle" x="298" y="-840.33" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="298" y="-831.33" font-family="Times,serif" font-size="8.00">GPU: EP1, TP0&#45;TP7</text>
</g>
<!-- expert_mlp2_1&#45;&gt;expert_ar_1 -->
<g id="edge25" class="edge">
<title>expert_mlp2_1&#45;&gt;expert_ar_1</title>
<path fill="none" stroke="black" d="M298,-899.7C298,-891.71 298,-882.11 298,-873.1"/>
<polygon fill="black" stroke="black" points="301.5,-872.93 298,-862.93 294.5,-872.93 301.5,-872.93"/>
</g>
<!-- expert_done_1 -->
<g id="node31" class="node">
<title>expert_done_1</title>
<ellipse fill="white" stroke="black" cx="313" cy="-735.23" rx="49.49" ry="49.49"/>
<text text-anchor="middle" x="313" y="-737.83" font-family="Times,serif" font-size="8.00">Expert 1 Output</text>
<text text-anchor="middle" x="313" y="-728.83" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
</g>
<!-- expert_ar_1&#45;&gt;expert_done_1 -->
<g id="edge26" class="edge">
<title>expert_ar_1&#45;&gt;expert_done_1</title>
<path fill="none" stroke="black" d="M300.82,-821.48C301.93,-813.72 303.27,-804.37 304.64,-794.75"/>
<polygon fill="black" stroke="black" points="308.13,-795.07 306.08,-784.68 301.2,-794.08 308.13,-795.07"/>
</g>
<!-- expert_done_1&#45;&gt;combine -->
<g id="edge46" class="edge">
<title>expert_done_1&#45;&gt;combine</title>
<path fill="none" stroke="black" d="M338.23,-692.39C345.28,-680.7 352.93,-668.02 359.91,-656.44"/>
<polygon fill="black" stroke="black" points="362.93,-658.21 365.1,-647.84 356.94,-654.59 362.93,-658.21"/>
</g>
<!-- expert_mlp1_2 -->
<g id="node33" class="node">
<title>expert_mlp1_2</title>
<polygon fill="lightblue" stroke="black" points="523,-1085.74 397,-1085.74 397,-1047.74 523,-1047.74 523,-1085.74"/>
<text text-anchor="middle" x="460" y="-1078.34" font-family="Times,serif" font-size="8.00">Expert 2 MLP Layer 1 (TP8)</text>
<text text-anchor="middle" x="460" y="-1069.34" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="460" y="-1060.34" font-family="Times,serif" font-size="8.00">→ [2048]</text>
<text text-anchor="middle" x="460" y="-1051.34" font-family="Times,serif" font-size="8.00">GPU: EP2, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_recv_2&#45;&gt;expert_mlp1_2 -->
<g id="edge27" class="edge">
<title>expert_recv_2&#45;&gt;expert_mlp1_2</title>
<path fill="none" stroke="black" d="M460,-1122.65C460,-1113.55 460,-1104.35 460,-1096.15"/>
<polygon fill="black" stroke="black" points="463.5,-1096.04 460,-1086.04 456.5,-1096.04 463.5,-1096.04"/>
</g>
<!-- expert_act_2 -->
<g id="node34" class="node">
<title>expert_act_2</title>
<polygon fill="lightblue" stroke="black" points="508.5,-1010.74 411.5,-1010.74 411.5,-974.74 508.5,-974.74 508.5,-1010.74"/>
<text text-anchor="middle" x="460" y="-995.34" font-family="Times,serif" font-size="8.00">Activation (SiLU/GeLU)</text>
<text text-anchor="middle" x="460" y="-986.34" font-family="Times,serif" font-size="8.00">GPU: EP2, TP0&#45;TP7</text>
</g>
<!-- expert_mlp1_2&#45;&gt;expert_act_2 -->
<g id="edge28" class="edge">
<title>expert_mlp1_2&#45;&gt;expert_act_2</title>
<path fill="none" stroke="black" d="M460,-1047.57C460,-1039.63 460,-1030.15 460,-1021.37"/>
<polygon fill="black" stroke="black" points="463.5,-1021.15 460,-1011.15 456.5,-1021.15 463.5,-1021.15"/>
</g>
<!-- expert_mlp2_2 -->
<g id="node35" class="node">
<title>expert_mlp2_2</title>
<polygon fill="lightblue" stroke="black" points="523,-937.74 397,-937.74 397,-899.74 523,-899.74 523,-937.74"/>
<text text-anchor="middle" x="460" y="-930.34" font-family="Times,serif" font-size="8.00">Expert 2 MLP Layer 2 (TP8)</text>
<text text-anchor="middle" x="460" y="-921.34" font-family="Times,serif" font-size="8.00">[2048]</text>
<text text-anchor="middle" x="460" y="-912.34" font-family="Times,serif" font-size="8.00">→ [hidden=1024]</text>
<text text-anchor="middle" x="460" y="-903.34" font-family="Times,serif" font-size="8.00">GPU: EP2, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_act_2&#45;&gt;expert_mlp2_2 -->
<g id="edge29" class="edge">
<title>expert_act_2&#45;&gt;expert_mlp2_2</title>
<path fill="none" stroke="black" d="M460,-974.67C460,-966.72 460,-957.05 460,-948.05"/>
<polygon fill="black" stroke="black" points="463.5,-947.94 460,-937.94 456.5,-947.94 463.5,-947.94"/>
</g>
<!-- expert_ar_2 -->
<g id="node36" class="node">
<title>expert_ar_2</title>
<ellipse fill="lightyellow" stroke="black" cx="460" cy="-842.23" rx="69.09" ry="20.51"/>
<text text-anchor="middle" x="460" y="-849.33" font-family="Times,serif" font-size="8.00">Expert 2 TP All&#45;Reduce</text>
<text text-anchor="middle" x="460" y="-840.33" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="460" y="-831.33" font-family="Times,serif" font-size="8.00">GPU: EP2, TP0&#45;TP7</text>
</g>
<!-- expert_mlp2_2&#45;&gt;expert_ar_2 -->
<g id="edge30" class="edge">
<title>expert_mlp2_2&#45;&gt;expert_ar_2</title>
<path fill="none" stroke="black" d="M460,-899.7C460,-891.71 460,-882.11 460,-873.1"/>
<polygon fill="black" stroke="black" points="463.5,-872.93 460,-862.93 456.5,-872.93 463.5,-872.93"/>
</g>
<!-- expert_done_2 -->
<g id="node37" class="node">
<title>expert_done_2</title>
<ellipse fill="white" stroke="black" cx="450" cy="-735.23" rx="49.49" ry="49.49"/>
<text text-anchor="middle" x="450" y="-737.83" font-family="Times,serif" font-size="8.00">Expert 2 Output</text>
<text text-anchor="middle" x="450" y="-728.83" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
</g>
<!-- expert_ar_2&#45;&gt;expert_done_2 -->
<g id="edge31" class="edge">
<title>expert_ar_2&#45;&gt;expert_done_2</title>
<path fill="none" stroke="black" d="M458.12,-821.48C457.38,-813.72 456.49,-804.37 455.57,-794.75"/>
<polygon fill="black" stroke="black" points="459.05,-794.3 454.61,-784.68 452.08,-794.96 459.05,-794.3"/>
</g>
<!-- expert_done_2&#45;&gt;combine -->
<g id="edge47" class="edge">
<title>expert_done_2&#45;&gt;combine</title>
<path fill="none" stroke="black" d="M426.17,-691.72C419.76,-680.29 412.85,-667.96 406.52,-656.66"/>
<polygon fill="black" stroke="black" points="409.52,-654.86 401.58,-647.85 403.42,-658.29 409.52,-654.86"/>
</g>
<!-- expert_mlp1_3 -->
<g id="node39" class="node">
<title>expert_mlp1_3</title>
<polygon fill="lightblue" stroke="black" points="699,-1085.74 573,-1085.74 573,-1047.74 699,-1047.74 699,-1085.74"/>
<text text-anchor="middle" x="636" y="-1078.34" font-family="Times,serif" font-size="8.00">Expert 3 MLP Layer 1 (TP8)</text>
<text text-anchor="middle" x="636" y="-1069.34" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="636" y="-1060.34" font-family="Times,serif" font-size="8.00">→ [2048]</text>
<text text-anchor="middle" x="636" y="-1051.34" font-family="Times,serif" font-size="8.00">GPU: EP3, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_recv_3&#45;&gt;expert_mlp1_3 -->
<g id="edge32" class="edge">
<title>expert_recv_3&#45;&gt;expert_mlp1_3</title>
<path fill="none" stroke="black" d="M636,-1122.65C636,-1113.55 636,-1104.35 636,-1096.15"/>
<polygon fill="black" stroke="black" points="639.5,-1096.04 636,-1086.04 632.5,-1096.04 639.5,-1096.04"/>
</g>
<!-- expert_act_3 -->
<g id="node40" class="node">
<title>expert_act_3</title>
<polygon fill="lightblue" stroke="black" points="684.5,-1010.74 587.5,-1010.74 587.5,-974.74 684.5,-974.74 684.5,-1010.74"/>
<text text-anchor="middle" x="636" y="-995.34" font-family="Times,serif" font-size="8.00">Activation (SiLU/GeLU)</text>
<text text-anchor="middle" x="636" y="-986.34" font-family="Times,serif" font-size="8.00">GPU: EP3, TP0&#45;TP7</text>
</g>
<!-- expert_mlp1_3&#45;&gt;expert_act_3 -->
<g id="edge33" class="edge">
<title>expert_mlp1_3&#45;&gt;expert_act_3</title>
<path fill="none" stroke="black" d="M636,-1047.57C636,-1039.63 636,-1030.15 636,-1021.37"/>
<polygon fill="black" stroke="black" points="639.5,-1021.15 636,-1011.15 632.5,-1021.15 639.5,-1021.15"/>
</g>
<!-- expert_mlp2_3 -->
<g id="node41" class="node">
<title>expert_mlp2_3</title>
<polygon fill="lightblue" stroke="black" points="699,-937.74 573,-937.74 573,-899.74 699,-899.74 699,-937.74"/>
<text text-anchor="middle" x="636" y="-930.34" font-family="Times,serif" font-size="8.00">Expert 3 MLP Layer 2 (TP8)</text>
<text text-anchor="middle" x="636" y="-921.34" font-family="Times,serif" font-size="8.00">[2048]</text>
<text text-anchor="middle" x="636" y="-912.34" font-family="Times,serif" font-size="8.00">→ [hidden=1024]</text>
<text text-anchor="middle" x="636" y="-903.34" font-family="Times,serif" font-size="8.00">GPU: EP3, TP0&#45;TP7 (1/8 each)</text>
</g>
<!-- expert_act_3&#45;&gt;expert_mlp2_3 -->
<g id="edge34" class="edge">
<title>expert_act_3&#45;&gt;expert_mlp2_3</title>
<path fill="none" stroke="black" d="M636,-974.67C636,-966.72 636,-957.05 636,-948.05"/>
<polygon fill="black" stroke="black" points="639.5,-947.94 636,-937.94 632.5,-947.94 639.5,-947.94"/>
</g>
<!-- expert_ar_3 -->
<g id="node42" class="node">
<title>expert_ar_3</title>
<ellipse fill="lightyellow" stroke="black" cx="636" cy="-842.23" rx="69.09" ry="20.51"/>
<text text-anchor="middle" x="636" y="-849.33" font-family="Times,serif" font-size="8.00">Expert 3 TP All&#45;Reduce</text>
<text text-anchor="middle" x="636" y="-840.33" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
<text text-anchor="middle" x="636" y="-831.33" font-family="Times,serif" font-size="8.00">GPU: EP3, TP0&#45;TP7</text>
</g>
<!-- expert_mlp2_3&#45;&gt;expert_ar_3 -->
<g id="edge35" class="edge">
<title>expert_mlp2_3&#45;&gt;expert_ar_3</title>
<path fill="none" stroke="black" d="M636,-899.7C636,-891.71 636,-882.11 636,-873.1"/>
<polygon fill="black" stroke="black" points="639.5,-872.93 636,-862.93 632.5,-872.93 639.5,-872.93"/>
</g>
<!-- expert_done_3 -->
<g id="node43" class="node">
<title>expert_done_3</title>
<ellipse fill="white" stroke="black" cx="626" cy="-735.23" rx="49.49" ry="49.49"/>
<text text-anchor="middle" x="626" y="-737.83" font-family="Times,serif" font-size="8.00">Expert 3 Output</text>
<text text-anchor="middle" x="626" y="-728.83" font-family="Times,serif" font-size="8.00">[hidden=1024]</text>
</g>
<!-- expert_ar_3&#45;&gt;expert_done_3 -->
<g id="edge36" class="edge">
<title>expert_ar_3&#45;&gt;expert_done_3</title>
<path fill="none" stroke="black" d="M634.12,-821.48C633.38,-813.72 632.49,-804.37 631.57,-794.75"/>
<polygon fill="black" stroke="black" points="635.05,-794.3 630.61,-784.68 628.08,-794.96 635.05,-794.3"/>
</g>
<!-- expert_done_3&#45;&gt;combine -->
<g id="edge48" class="edge">
<title>expert_done_3&#45;&gt;combine</title>
<path fill="none" stroke="black" d="M589.68,-701.59C579.01,-693.06 566.97,-684.4 555,-677.73 524.04,-660.49 487.31,-646.59 455.84,-636.41"/>
<polygon fill="black" stroke="black" points="456.85,-633.06 446.26,-633.38 454.73,-639.73 456.85,-633.06"/>
</g>
<!-- experts_ellipsis -->
<g id="node44" class="node">
<title>experts_ellipsis</title>
<text text-anchor="middle" x="146" y="-1715.94" font-family="Times,serif" font-size="8.00">...</text>
<text text-anchor="middle" x="146" y="-1706.94" font-family="Times,serif" font-size="8.00">60 more experts</text>
<text text-anchor="middle" x="146" y="-1697.94" font-family="Times,serif" font-size="8.00">EP4&#45;EP63</text>
</g>
<!-- weighted_sum -->
<g id="node46" class="node">
<title>weighted_sum</title>
<polygon fill="lightcoral" stroke="black" points="550.83,-545.26 285.44,-545.26 217.17,-469.26 482.56,-469.26 550.83,-545.26"/>
<text text-anchor="middle" x="384" y="-518.86" font-family="Times,serif" font-size="8.00">Weighted Aggregation</text>
<text text-anchor="middle" x="384" y="-509.86" font-family="Times,serif" font-size="8.00">Gate scores × Expert outputs</text>
<text text-anchor="middle" x="384" y="-500.86" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
<text text-anchor="middle" x="384" y="-491.86" font-family="Times,serif" font-size="8.00">GPU: All EP Ranks</text>
</g>
<!-- combine&#45;&gt;weighted_sum -->
<g id="edge49" class="edge">
<title>combine&#45;&gt;weighted_sum</title>
<path fill="none" stroke="black" d="M384,-582.04C384,-573.62 384,-564.38 384,-555.37"/>
<polygon fill="black" stroke="black" points="387.5,-555.35 384,-545.35 380.5,-555.35 387.5,-555.35"/>
</g>
<!-- moe_final -->
<g id="node47" class="node">
<title>moe_final</title>
<ellipse fill="white" stroke="black" cx="384" cy="-335.45" rx="96.63" ry="96.63"/>
<text text-anchor="middle" x="384" y="-338.05" font-family="Times,serif" font-size="8.00">MoE Block Output</text>
<text text-anchor="middle" x="384" y="-329.05" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
</g>
<!-- weighted_sum&#45;&gt;moe_final -->
<g id="edge50" class="edge">
<title>weighted_sum&#45;&gt;moe_final</title>
<path fill="none" stroke="black" d="M384,-468.99C384,-460.89 384,-451.94 384,-442.61"/>
<polygon fill="black" stroke="black" points="387.5,-442.38 384,-432.38 380.5,-442.38 387.5,-442.38"/>
</g>
<!-- output -->
<g id="node48" class="node">
<title>output</title>
<ellipse fill="white" stroke="black" stroke-width="2" cx="384" cy="-100.82" rx="96.64" ry="96.64"/>
<ellipse fill="none" stroke="black" stroke-width="2" cx="384" cy="-100.82" rx="100.63" ry="100.63"/>
<text text-anchor="middle" x="384" y="-103.42" font-family="Times,serif" font-size="8.00">Layer Output</text>
<text text-anchor="middle" x="384" y="-94.42" font-family="Times,serif" font-size="8.00">[batch=128, seq=1024, hidden=1024]</text>
</g>
<!-- moe_final&#45;&gt;output -->
<g id="edge55" class="edge">
<title>moe_final&#45;&gt;output</title>
<path fill="none" stroke="black" d="M384,-238.48C384,-229.66 384,-220.68 384,-211.75"/>
<polygon fill="black" stroke="black" points="387.5,-211.7 384,-201.7 380.5,-211.7 387.5,-211.7"/>
</g>
</g>
</svg>
