digraph layer_2_baseline {
	graph [bb="0,0,1778,1083",
		nodesep=0.3,
		rankdir=TB,
		ranksep=0.8,
		splines=ortho
	];
	node [fillcolor=lightblue,
		label="\N",
		shape=rectangle,
		style=filled
	];
	layer2_input	[fillcolor=lightgreen,
		height=1.041,
		label="Layer 2 Input
Input: [1024,2048,4096]
GPU: 0-7",
		pos="820.5,1045.5",
		shape=ellipse,
		width=3.7516];
	l2_mha_qkv	[fillcolor=yellow,
		height=0.94444,
		label="QKV Projection
Input: [1024,2048,4096]
Output: [1024,2048,128] per GPU
GPU: 0-7",
		pos="902.5,916",
		width=3.6111];
	layer2_input -> l2_mha_qkv	[pos="e,864.03,950.27 864.03,1009.8 864.03,1009.8 864.03,960.27 864.03,960.27"];
	l2_mha_res	[fillcolor=orange,
		height=0.94444,
		label="Residual Add
Input: [1024,2048,4096], [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 0-7",
		pos="806.5,538",
		width=4.5556];
	layer2_input -> l2_mha_res	[pos="e,728.97,572.18 728.97,1017.8 728.97,1017.8 728.97,582.18 728.97,582.18"];
	l2_mha_attn	[fillcolor=yellow,
		height=0.94444,
		label="Multi-Head Attention
Input: [1024,2048,128]
Output: [1024,2048,128]
GPU: 0-7",
		pos="895.5,790",
		width=2.6944];
	l2_mha_qkv -> l2_mha_attn	[pos="e,895.5,824.12 895.5,881.9 895.5,881.9 895.5,834.12 895.5,834.12"];
	l2_mha_out	[fillcolor=yellow,
		height=0.94444,
		label="Output Projection
Input: [1024,2048,128]
Output: [1024,2048,4096]
GPU: 0-7",
		pos="888.5,664",
		width=2.8194];
	l2_mha_attn -> l2_mha_out	[pos="e,894.25,698.12 894.25,755.9 894.25,755.9 894.25,708.12 894.25,708.12"];
	l2_mha_out -> l2_mha_res	[pos="e,878.75,572.12 878.75,629.9 878.75,629.9 878.75,582.12 878.75,582.12"];
	l2_moe_gate	[fillcolor=lightcoral,
		height=0.94444,
		label="Gate Network
Input: [1024,2048,4096]
Output: [1024,2048,16]
GPU: 0-7",
		pos="871.5,412",
		width=2.6528];
	l2_mha_res -> l2_moe_gate	[pos="e,871.5,446.12 871.5,503.9 871.5,503.9 871.5,456.12 871.5,456.12"];
	l2_exp0_gpu0	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 0,1
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 0",
		pos="1226.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp0_gpu0	[pos="e,1260.3,320.07 970.67,531 1100.6,531 1260.3,531 1260.3,531 1260.3,531 1260.3,330.07 1260.3,330.07"];
	l2_exp2_gpu1	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 2,3
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 1",
		pos="1451.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp2_gpu1	[pos="e,1485.3,320.26 970.83,544 1171.7,544 1485.3,544 1485.3,544 1485.3,544 1485.3,330.26 1485.3,330.26"];
	l2_exp4_gpu2	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 4,5
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 2",
		pos="1676.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp4_gpu2	[pos="e,1710.3,320.17 970.7,558 1231.3,558 1710.3,558 1710.3,558 1710.3,558 1710.3,330.17 1710.3,330.17"];
	l2_exp6_gpu3	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 6,7
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 3",
		pos="101.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp6_gpu3	[pos="e,67.667,320.11 642.07,549 424.36,549 67.667,549 67.667,549 67.667,549 67.667,330.11 67.667,330.11"];
	l2_exp8_gpu4	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 8,9
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 4",
		pos="326.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp8_gpu4	[pos="e,292.67,320.13 642.15,526 491.82,526 292.67,526 292.67,526 292.67,526 292.67,330.13 292.67,330.13"];
	l2_exp10_gpu5	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 10,11
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 5",
		pos="551.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp10_gpu5	[pos="e,646,320.17 646,503.75 646,503.75 646,330.17 646,330.17"];
	l2_exp12_gpu6	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 12,13
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 6",
		pos="776.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp12_gpu6	[pos="e,725.5,320.17 725.5,503.75 725.5,503.75 725.5,330.17 725.5,330.17"];
	l2_exp14_gpu7	[fillcolor=lightpink,
		height=0.94444,
		label="Experts 14,15
Input: [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 7",
		pos="1001.5,286",
		width=2.8194];
	l2_mha_res -> l2_exp14_gpu7	[pos="e,980.25,320.08 970.66,517 976.72,517 980.25,517 980.25,517 980.25,517 980.25,330.08 980.25,330.08"];
	l2_moe_res	[fillcolor=orange,
		height=0.94444,
		label="Residual Add
Input: [1024,2048,4096], [1024,2048,4096]
Output: [1024,2048,4096]
GPU: 0-7",
		pos="370.5,34",
		width=4.5556];
	l2_mha_res -> l2_moe_res	[pos="e,534.85,34 661.75,503.75 661.75,390.32 661.75,34 661.75,34 661.75,34 544.85,34 544.85,34"];
	l2_moe_gate -> l2_exp0_gpu0	[pos="e,1192.7,320.19 967.43,395 1062.1,395 1192.7,395 1192.7,395 1192.7,395 1192.7,330.19 1192.7,330.19",
		style=dashed];
	l2_moe_gate -> l2_exp2_gpu1	[pos="e,1417.7,320.1 967.26,412 1123.9,412 1417.7,412 1417.7,412 1417.7,412 1417.7,330.1 1417.7,330.1",
		style=dashed];
	l2_moe_gate -> l2_exp4_gpu2	[pos="e,1642.7,320.25 967.22,429 1173.7,429 1642.7,429 1642.7,429 1642.7,429 1642.7,330.25 1642.7,330.25",
		style=dashed];
	l2_moe_gate -> l2_exp6_gpu3	[pos="e,135.33,320.25 775.64,429 576.27,429 135.33,429 135.33,429 135.33,429 135.33,330.25 135.33,330.25",
		style=dashed];
	l2_moe_gate -> l2_exp8_gpu4	[pos="e,360.33,320.1 775.95,412 628,412 360.33,412 360.33,412 360.33,412 360.33,330.1 360.33,330.1",
		style=dashed];
	l2_moe_gate -> l2_exp10_gpu5	[pos="e,649.5,320.19 775.74,395 715.66,395 649.5,395 649.5,395 649.5,395 649.5,330.19 649.5,330.19",
		style=dashed];
	l2_moe_gate -> l2_exp12_gpu6	[pos="e,827,320.12 827,377.9 827,377.9 827,330.12 827,330.12",
		style=dashed];
	l2_moe_gate -> l2_exp14_gpu7	[pos="e,933.5,320.12 933.5,377.9 933.5,377.9 933.5,330.12 933.5,330.12",
		style=dashed];
	l2_moe_agg	[fillcolor=lightcyan,
		height=0.94444,
		label="Expert Aggregation
Input: [1024,2048,4096]Ã—8
Output: [1024,2048,4096]
GPU: 0-7",
		pos="776.5,160",
		width=2.9444];
	l2_exp0_gpu0 -> l2_moe_agg	[pos="e,882.57,166 1226.5,251.93 1226.5,216.46 1226.5,166 1226.5,166 1226.5,166 892.57,166 892.57,166"];
	l2_exp2_gpu1 -> l2_moe_agg	[pos="e,882.71,153 1451.5,251.75 1451.5,212.34 1451.5,153 1451.5,153 1451.5,153 892.71,153 892.71,153"];
	l2_exp4_gpu2 -> l2_moe_agg	[pos="e,882.83,139 1676.5,251.91 1676.5,208.48 1676.5,139 1676.5,139 1676.5,139 892.83,139 892.83,139"];
	l2_exp6_gpu3 -> l2_moe_agg	[pos="e,670.29,153 101.5,251.75 101.5,212.34 101.5,153 101.5,153 101.5,153 660.29,153 660.29,153"];
	l2_exp8_gpu4 -> l2_moe_agg	[pos="e,670.43,166 326.5,251.93 326.5,216.46 326.5,166 326.5,166 326.5,166 660.43,166 660.43,166"];
	l2_exp10_gpu5 -> l2_moe_agg	[pos="e,670.46,180 593.75,251.88 593.75,220.89 593.75,180 593.75,180 593.75,180 660.46,180 660.46,180"];
	l2_exp12_gpu6 -> l2_moe_agg	[pos="e,776.5,194.12 776.5,251.9 776.5,251.9 776.5,204.12 776.5,204.12"];
	l2_exp14_gpu7 -> l2_moe_agg	[pos="e,882.74,180 1001.5,251.88 1001.5,220.89 1001.5,180 1001.5,180 1001.5,180 892.74,180 892.74,180"];
	l2_moe_agg -> l2_moe_res	[pos="e,492.25,68.09 670.25,139 589.51,139 492.25,139 492.25,139 492.25,139 492.25,78.09 492.25,78.09"];
}
