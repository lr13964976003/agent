digraph MoE_Layer_4_Detailed {
	graph [concentrate=true nodesep=0.5 rankdir=LR ranksep=1.5 splines=ortho]
	input_layer_4 [label="Input
Layer 4
[bs=4, seq=2048, dim=7168]" fillcolor=lightgrey shape=ellipse style=filled]
	mha_layer_4 [label="Multi-Head Attention
GPU: 0
[bs=4, seq=2048, heads=128, d_k=128]
→ [bs=4, seq=2048, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	gate_layer_4 [label="Gating Network
GPU: 0
Compute routing scores
Select top-2 experts" fillcolor=lightyellow shape=parallelogram style=filled]
	distribute_layer_4 [label="Token Distribution
Cross-node communication
Route tokens to 32 GPUs" fillcolor=lightgreen shape=ellipse style="filled,dashed"]
	expert_0_layer_4_gpu_0 [label="Expert 0
GPU: 0 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_1_layer_4_gpu_1 [label="Expert 1
GPU: 1 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_2_layer_4_gpu_2 [label="Expert 2
GPU: 2 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_3_layer_4_gpu_3 [label="Expert 3
GPU: 3 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_4_layer_4_gpu_4 [label="Expert 4
GPU: 4 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_5_layer_4_gpu_5 [label="Expert 5
GPU: 5 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_6_layer_4_gpu_6 [label="Expert 6
GPU: 6 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_7_layer_4_gpu_7 [label="Expert 7
GPU: 7 (Node 0)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_8_layer_4_gpu_8 [label="Expert 8
GPU: 8 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_9_layer_4_gpu_9 [label="Expert 9
GPU: 9 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_10_layer_4_gpu_10 [label="Expert 10
GPU: 10 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_11_layer_4_gpu_11 [label="Expert 11
GPU: 11 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_12_layer_4_gpu_12 [label="Expert 12
GPU: 12 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_13_layer_4_gpu_13 [label="Expert 13
GPU: 13 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_14_layer_4_gpu_14 [label="Expert 14
GPU: 14 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_15_layer_4_gpu_15 [label="Expert 15
GPU: 15 (Node 1)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_16_layer_4_gpu_16 [label="Expert 16
GPU: 16 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_17_layer_4_gpu_17 [label="Expert 17
GPU: 17 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_18_layer_4_gpu_18 [label="Expert 18
GPU: 18 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_19_layer_4_gpu_19 [label="Expert 19
GPU: 19 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_20_layer_4_gpu_20 [label="Expert 20
GPU: 20 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_21_layer_4_gpu_21 [label="Expert 21
GPU: 21 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_22_layer_4_gpu_22 [label="Expert 22
GPU: 22 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_23_layer_4_gpu_23 [label="Expert 23
GPU: 23 (Node 2)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_24_layer_4_gpu_24 [label="Expert 24
GPU: 24 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_25_layer_4_gpu_25 [label="Expert 25
GPU: 25 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_26_layer_4_gpu_26 [label="Expert 26
GPU: 26 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_27_layer_4_gpu_27 [label="Expert 27
GPU: 27 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_28_layer_4_gpu_28 [label="Expert 28
GPU: 28 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_29_layer_4_gpu_29 [label="Expert 29
GPU: 29 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_30_layer_4_gpu_30 [label="Expert 30
GPU: 30 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	expert_31_layer_4_gpu_31 [label="Expert 31
GPU: 31 (Node 3)
MLP Processing
[bs=?, seq=?, dim=7168]
→ [bs=?, seq=?, dim=7168]" fillcolor=lightblue shape=rectangle style=filled]
	aggregate_layer_4 [label="Token Aggregation
Cross-node communication
Gather from 32 GPUs" fillcolor=lightgreen shape=ellipse style="filled,dashed"]
	output_layer_4 [label="Output
Layer 4
[bs=4, seq=2048, dim=7168]" fillcolor=lightgrey shape=ellipse style=filled]
	input_layer_4 -> mha_layer_4
	mha_layer_4 -> gate_layer_4
	gate_layer_4 -> distribute_layer_4
	distribute_layer_4 -> expert_0_layer_4_gpu_0 [style=dashed]
	distribute_layer_4 -> expert_1_layer_4_gpu_1 [style=dashed]
	distribute_layer_4 -> expert_2_layer_4_gpu_2 [style=dashed]
	distribute_layer_4 -> expert_3_layer_4_gpu_3 [style=dashed]
	distribute_layer_4 -> expert_4_layer_4_gpu_4 [style=dashed]
	distribute_layer_4 -> expert_5_layer_4_gpu_5 [style=dashed]
	distribute_layer_4 -> expert_6_layer_4_gpu_6 [style=dashed]
	distribute_layer_4 -> expert_7_layer_4_gpu_7 [style=dashed]
	distribute_layer_4 -> expert_8_layer_4_gpu_8 [style=dashed]
	distribute_layer_4 -> expert_9_layer_4_gpu_9 [style=dashed]
	distribute_layer_4 -> expert_10_layer_4_gpu_10 [style=dashed]
	distribute_layer_4 -> expert_11_layer_4_gpu_11 [style=dashed]
	distribute_layer_4 -> expert_12_layer_4_gpu_12 [style=dashed]
	distribute_layer_4 -> expert_13_layer_4_gpu_13 [style=dashed]
	distribute_layer_4 -> expert_14_layer_4_gpu_14 [style=dashed]
	distribute_layer_4 -> expert_15_layer_4_gpu_15 [style=dashed]
	distribute_layer_4 -> expert_16_layer_4_gpu_16 [style=dashed]
	distribute_layer_4 -> expert_17_layer_4_gpu_17 [style=dashed]
	distribute_layer_4 -> expert_18_layer_4_gpu_18 [style=dashed]
	distribute_layer_4 -> expert_19_layer_4_gpu_19 [style=dashed]
	distribute_layer_4 -> expert_20_layer_4_gpu_20 [style=dashed]
	distribute_layer_4 -> expert_21_layer_4_gpu_21 [style=dashed]
	distribute_layer_4 -> expert_22_layer_4_gpu_22 [style=dashed]
	distribute_layer_4 -> expert_23_layer_4_gpu_23 [style=dashed]
	distribute_layer_4 -> expert_24_layer_4_gpu_24 [style=dashed]
	distribute_layer_4 -> expert_25_layer_4_gpu_25 [style=dashed]
	distribute_layer_4 -> expert_26_layer_4_gpu_26 [style=dashed]
	distribute_layer_4 -> expert_27_layer_4_gpu_27 [style=dashed]
	distribute_layer_4 -> expert_28_layer_4_gpu_28 [style=dashed]
	distribute_layer_4 -> expert_29_layer_4_gpu_29 [style=dashed]
	distribute_layer_4 -> expert_30_layer_4_gpu_30 [style=dashed]
	distribute_layer_4 -> expert_31_layer_4_gpu_31 [style=dashed]
	expert_0_layer_4_gpu_0 -> aggregate_layer_4 [style=dashed]
	expert_1_layer_4_gpu_1 -> aggregate_layer_4 [style=dashed]
	expert_2_layer_4_gpu_2 -> aggregate_layer_4 [style=dashed]
	expert_3_layer_4_gpu_3 -> aggregate_layer_4 [style=dashed]
	expert_4_layer_4_gpu_4 -> aggregate_layer_4 [style=dashed]
	expert_5_layer_4_gpu_5 -> aggregate_layer_4 [style=dashed]
	expert_6_layer_4_gpu_6 -> aggregate_layer_4 [style=dashed]
	expert_7_layer_4_gpu_7 -> aggregate_layer_4 [style=dashed]
	expert_8_layer_4_gpu_8 -> aggregate_layer_4 [style=dashed]
	expert_9_layer_4_gpu_9 -> aggregate_layer_4 [style=dashed]
	expert_10_layer_4_gpu_10 -> aggregate_layer_4 [style=dashed]
	expert_11_layer_4_gpu_11 -> aggregate_layer_4 [style=dashed]
	expert_12_layer_4_gpu_12 -> aggregate_layer_4 [style=dashed]
	expert_13_layer_4_gpu_13 -> aggregate_layer_4 [style=dashed]
	expert_14_layer_4_gpu_14 -> aggregate_layer_4 [style=dashed]
	expert_15_layer_4_gpu_15 -> aggregate_layer_4 [style=dashed]
	expert_16_layer_4_gpu_16 -> aggregate_layer_4 [style=dashed]
	expert_17_layer_4_gpu_17 -> aggregate_layer_4 [style=dashed]
	expert_18_layer_4_gpu_18 -> aggregate_layer_4 [style=dashed]
	expert_19_layer_4_gpu_19 -> aggregate_layer_4 [style=dashed]
	expert_20_layer_4_gpu_20 -> aggregate_layer_4 [style=dashed]
	expert_21_layer_4_gpu_21 -> aggregate_layer_4 [style=dashed]
	expert_22_layer_4_gpu_22 -> aggregate_layer_4 [style=dashed]
	expert_23_layer_4_gpu_23 -> aggregate_layer_4 [style=dashed]
	expert_24_layer_4_gpu_24 -> aggregate_layer_4 [style=dashed]
	expert_25_layer_4_gpu_25 -> aggregate_layer_4 [style=dashed]
	expert_26_layer_4_gpu_26 -> aggregate_layer_4 [style=dashed]
	expert_27_layer_4_gpu_27 -> aggregate_layer_4 [style=dashed]
	expert_28_layer_4_gpu_28 -> aggregate_layer_4 [style=dashed]
	expert_29_layer_4_gpu_29 -> aggregate_layer_4 [style=dashed]
	expert_30_layer_4_gpu_30 -> aggregate_layer_4 [style=dashed]
	expert_31_layer_4_gpu_31 -> aggregate_layer_4 [style=dashed]
	aggregate_layer_4 -> output_layer_4
}
