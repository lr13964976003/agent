digraph {
	graph [bb="0,0,828.48,1506.5",
		bgcolor=white,
		rankdir=TB,
		size="20,15"
	];
	node [fontname=Arial,
		fontsize=12,
		label="\N"
	];
	edge [fontname=Arial,
		fontsize=10
	];
	input	[fillcolor=lightcoral,
		height=0.66782,
		label="Input Tokens\n[batch_size=128, seq_len=10000]",
		pos="463.55,1482.5",
		shape=ellipse,
		width=3.8694];
	embed	[fillcolor=lightgreen,
		height=0.5,
		label="Embedding\n[batch_size=128, seq_len=10000, hidden_size=4096]",
		pos="463.55,1403.4",
		shape=rectangle,
		width=4.1944];
	input -> embed	[pos="e,463.55,1421.9 463.55,1458.3 463.55,1450 463.55,1440.6 463.55,1431.9"];
	ln_0	[fillcolor=lightgreen,
		height=0.5,
		label=LayerNorm_0,
		pos="463.55,1330.4",
		shape=rectangle,
		width=1.2361];
	embed -> ln_0	[pos="e,463.55,1348.4 463.55,1385.2 463.55,1377.2 463.55,1367.5 463.55,1358.5"];
	mha_0	[fillcolor=lightgreen,
		height=0.5,
		label="MHA_0\n(Tensor Parallel)",
		pos="463.55,1257.4",
		shape=rectangle,
		width=1.4444];
	ln_0 -> mha_0	[pos="e,463.55,1275.4 463.55,1312.2 463.55,1304.2 463.55,1294.5 463.55,1285.5"];
	ar_mha_0	[fillcolor=lightblue,
		height=0.66782,
		label="AllReduce\nMHA_0",
		pos="463.55,1178.4",
		shape=ellipse,
		style=dashed,
		width=1.4339];
	mha_0 -> ar_mha_0	[pos="e,463.55,1202.6 463.55,1239.3 463.55,1231.5 463.55,1221.9 463.55,1212.7"];
	gate_0	[fillcolor=lightyellow,
		height=0.5,
		label="Expert Gate_0",
		pos="524.55,1099.3",
		shape=parallelogram,
		width=2.3316];
	ar_mha_0 -> gate_0	[pos="e,511.07,1117.4 480.86,1155.5 488.27,1146.1 496.97,1135.2 504.64,1125.5"];
	expert_0_0	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_0\nGPU0-1",
		pos="514.55,1016.3",
		shape=rectangle,
		width=0.90278];
	ar_mha_0 -> expert_0_0	[pos="e,481.95,1029 445.91,1155.3 427.08,1128.9 402.72,1084.2 424.55,1052.3 426.1,1050.1 449.72,1040.9 472.37,1032.5"];
	expert_0_1	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_1\nGPU2-3",
		pos="626.55,1016.3",
		shape=rectangle,
		width=0.90278];
	ar_mha_0 -> expert_0_1	[pos="e,659.33,1027.1 515.24,1176.4 589.78,1171.8 725.34,1151.2 787.55,1063.3 824.45,1011.2 890.28,1080.7 687.55,1034.3 681.64,1033 675.45,\
1031.4 669.38,1029.8"];
	expert_0_2	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_2\nGPU4-5",
		pos="728.55,1016.3",
		shape=rectangle,
		width=0.90278];
	ar_mha_0 -> expert_0_2	[pos="e,761.38,1023.6 513.67,1172.4 588.55,1164.2 725.04,1145.8 764.55,1117.3 792.26,1097.4 824.04,1081.1 805.55,1052.3 797.68,1040.1 \
784.38,1032.1 771.04,1026.9"];
	expert_0_3	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_3\nGPU6-7",
		pos="422.55,1016.3",
		shape=rectangle,
		width=0.90278];
	ar_mha_0 -> expert_0_3	[pos="e,393.11,1034.6 422.53,1163.5 409.72,1157.1 396.8,1148.3 388.55,1136.3 367.22,1105.4 362.21,1086.2 378.55,1052.3 380.41,1048.5 382.92,\
1044.9 385.81,1041.7"];
	res_0	[fillcolor=lightyellow,
		height=0.5,
		label=Residual_0,
		pos="338.55,753.25",
		shape=parallelogram,
		width=1.9556];
	ar_mha_0 -> res_0	[pos="e,334.35,771.27 414.86,1170.3 375.48,1161.4 326.55,1142.1 326.55,1100.3 326.55,1100.3 326.55,1100.3 326.55,831.29 326.55,814.52 \
329.36,795.93 332.26,781.22"];
	gate_0 -> expert_0_0	[label=route_to_expert_0,
		lp="559.05,1057.8",
		pos="e,516.66,1034.5 522.43,1081.2 521.11,1070.5 519.4,1056.6 517.9,1044.5",
		style=dashed];
	gate_0 -> expert_0_1	[label=route_to_expert_1,
		lp="650.05,1057.8",
		pos="e,620.84,1034.4 574.64,1081.8 584.66,1077 594.55,1070.9 602.55,1063.3 608.31,1057.9 612.95,1050.8 616.56,1043.7",
		style=dashed];
	gate_0 -> expert_0_2	[label=route_to_expert_2,
		lp="744.05,1057.8",
		pos="e,719.48,1034.7 587.93,1095.8 621.48,1092 662.11,1083.1 693.55,1063.3 701.48,1058.3 708.28,1050.9 713.73,1043.4",
		style=dashed];
	gate_0 -> expert_0_3	[label=route_to_expert_3,
		lp="475.05,1057.8",
		pos="e,423.7,1034.4 459.68,1081.2 450.67,1076.6 442.23,1070.7 435.55,1063.3 430.76,1058 427.72,1051.1 425.79,1044.2",
		style=dashed];
	agg_0	[fillcolor=lightyellow,
		height=0.94444,
		label="Expert\nAggregate_0",
		pos="514.55,927.33",
		shape=parallelogram,
		width=2.4767];
	expert_0_0 -> agg_0	[pos="e,514.55,961.34 514.55,998.14 514.55,990.43 514.55,980.96 514.55,971.5"];
	expert_0_1 -> agg_0	[pos="e,557.03,961.34 604.42,998.14 593.12,989.37 578.88,978.3 565.08,967.59"];
	expert_0_2 -> agg_0	[pos="e,595.98,961.44 696.04,1002.1 671.89,992.3 637.67,978.39 605.45,965.29"];
	expert_0_3 -> agg_0	[pos="e,479.65,961.34 440.72,998.14 449.74,989.61 461.05,978.92 472.08,968.49"];
	all2all_0	[fillcolor=lightblue,
		height=0.66782,
		label="All2All\nExperts_0",
		pos="454.55,832.29",
		shape=ellipse,
		style=dashed,
		width=1.3946];
	agg_0 -> all2all_0	[pos="e,468.85,855.47 493.22,893.27 487.1,883.77 480.44,873.45 474.41,864.09"];
	all2all_0 -> res_0	[pos="e,364.26,771.32 426.17,812.44 410.06,801.75 389.79,788.28 372.8,777"];
	ln_1	[fillcolor=lightgreen,
		height=0.5,
		label=LayerNorm_1,
		pos="338.55,680.25",
		shape=rectangle,
		width=1.2361];
	res_0 -> ln_1	[pos="e,338.55,698.28 338.55,735.06 338.55,727.04 338.55,717.3 338.55,708.32"];
	mha_1	[fillcolor=lightgreen,
		height=0.5,
		label="MHA_1\n(Tensor Parallel)",
		pos="338.55,607.25",
		shape=rectangle,
		width=1.4444];
	ln_1 -> mha_1	[pos="e,338.55,625.28 338.55,662.06 338.55,654.04 338.55,644.3 338.55,635.32"];
	ar_mha_1	[fillcolor=lightblue,
		height=0.66782,
		label="AllReduce\nMHA_1",
		pos="338.55,528.21",
		shape=ellipse,
		style=dashed,
		width=1.4339];
	mha_1 -> ar_mha_1	[pos="e,338.55,552.39 338.55,589.15 338.55,581.29 338.55,571.69 338.55,562.49"];
	gate_1	[fillcolor=lightyellow,
		height=0.5,
		label="Expert Gate_1",
		pos="399.55,449.17",
		shape=parallelogram,
		width=2.3316];
	ar_mha_1 -> gate_1	[pos="e,386.07,467.19 355.86,505.34 363.27,495.98 371.97,485 379.64,475.3"];
	expert_1_0	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_4\nGPU8-9",
		pos="392.55,366.17",
		shape=rectangle,
		width=0.90278];
	ar_mha_1 -> expert_1_0	[pos="e,359.95,378.86 321.75,505.09 303.85,478.6 280.86,433.86 302.55,402.17 304.1,399.9 327.72,390.75 350.37,382.38"];
	expert_1_1	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_5\nGPU10-11",
		pos="501.55,366.17",
		shape=rectangle,
		width=1.0278];
	ar_mha_1 -> expert_1_1	[pos="e,538.72,379.18 390.23,526.35 465.16,521.98 601.83,501.55 664.55,413.17 683.98,385.79 675.45,411.86 557.55,384.17 554.58,383.47 \
551.53,382.7 548.47,381.89"];
	expert_1_2	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_6\nGPU12-13",
		pos="603.55,366.17",
		shape=rectangle,
		width=1.0278];
	ar_mha_1 -> expert_1_2	[pos="e,640.84,374.55 388.72,522.37 464.06,514.28 601.83,495.98 641.55,467.17 669.01,447.25 699.98,430.64 681.55,402.17 674.28,390.95 \
662.48,383.29 650.23,378.08"];
	expert_1_3	[fillcolor=lightgreen,
		height=0.5,
		label="Expert_7\nGPU14-15",
		pos="297.55,366.17",
		shape=rectangle,
		width=1.0278];
	ar_mha_1 -> expert_1_3	[pos="e,268.11,384.45 297.53,513.3 284.72,506.97 271.8,498.15 263.55,486.17 242.22,455.2 237.21,436.03 253.55,402.17 255.41,398.31 257.92,\
394.75 260.81,391.49"];
	res_1	[fillcolor=lightyellow,
		height=0.5,
		label=Residual_1,
		pos="213.55,103.08",
		shape=parallelogram,
		width=1.9556];
	ar_mha_1 -> res_1	[pos="e,209.35,121.1 289.86,520.1 250.48,511.28 201.55,491.92 201.55,450.17 201.55,450.17 201.55,450.17 201.55,181.12 201.55,164.35 204.36,\
145.76 207.26,131.05"];
	gate_1 -> expert_1_0	[label=route_to_expert_4,
		lp="436.05,407.67",
		pos="e,394.03,384.32 398.06,430.99 397.14,420.36 395.94,406.47 394.9,394.37",
		style=dashed];
	gate_1 -> expert_1_1	[label=route_to_expert_5,
		lp="527.05,407.67",
		pos="e,496.66,384.26 450.71,432.27 461.12,427.35 471.37,421.07 479.55,413.17 485.15,407.75 489.5,400.62 492.79,393.6",
		style=dashed];
	gate_1 -> expert_1_2	[label=route_to_expert_6,
		lp="621.05,407.67",
		pos="e,595.22,384.58 463.49,446.19 497.58,442.53 538.89,433.69 570.55,413.17 578.25,408.17 584.73,400.69 589.85,393.21",
		style=dashed];
	gate_1 -> expert_1_3	[label=route_to_expert_7,
		lp="353.05,407.67",
		pos="e,299.96,384.28 338.53,431.04 329.3,426.39 320.54,420.53 313.55,413.17 308.54,407.89 305.09,400.97 302.72,394.1",
		style=dashed];
	agg_1	[fillcolor=lightyellow,
		height=0.94444,
		label="Expert\nAggregate_1",
		pos="392.55,277.17",
		shape=parallelogram,
		width=2.4767];
	expert_1_0 -> agg_1	[pos="e,392.55,311.17 392.55,347.98 392.55,340.27 392.55,330.79 392.55,321.34"];
	expert_1_1 -> agg_1	[pos="e,433.9,311.17 480.01,347.98 469.02,339.2 455.15,328.14 441.73,317.42"];
	expert_1_2 -> agg_1	[pos="e,472.68,311.21 566.31,349.81 542.93,340.17 511.71,327.3 482.19,315.13"];
	expert_1_3 -> agg_1	[pos="e,356.51,311.17 316.32,347.98 325.72,339.37 337.53,328.55 349.03,318.02"];
	all2all_1	[fillcolor=lightblue,
		height=0.66782,
		label="All2All\nExperts_1",
		pos="332.55,182.12",
		shape=ellipse,
		style=dashed,
		width=1.3946];
	agg_1 -> all2all_1	[pos="e,346.85,205.31 371.22,243.1 365.1,233.6 358.44,223.28 352.41,213.93"];
	all2all_1 -> res_1	[pos="e,239.92,121.16 303.44,162.28 286.91,151.58 266.11,138.12 248.69,126.83"];
	output	[fillcolor=lightcoral,
		height=0.66782,
		label="Output\n[batch_size=128, seq_len=10000, hidden_size=4096]",
		pos="213.55,24.042",
		shape=ellipse,
		width=5.9318];
	res_1 -> output	[pos="e,213.55,48.228 213.55,84.985 213.55,77.126 213.55,67.523 213.55,58.326"];
}
