digraph fa_pool_practical_dag {
	graph [bb="0,0,526.5,472",
		rankdir=TB,
		size="25,35",
		splines=ortho
	];
	node [fontname=Arial,
		fontsize=10,
		label="\N"
	];
	input	[fillcolor=lightblue,
		height=0.5,
		label="Input<br/>[batch=1024, seq_len=?, vocab=32000]",
		pos="244.5,454",
		shape=ellipse,
		width=3.8263];
	decision	[fillcolor=lightcoral,
		height=1.1389,
		label="Sequence Length Decision<br/>
             < 4096: Base only<br/>
             ≥ 4096: Activate pool",
		pos="244.5,358",
		shape=diamond,
		width=4.3889];
	input -> decision	[pos="e,244.5,399.06 244.5,435.94 244.5,435.94 244.5,409.06 244.5,409.06"];
	base_processing	[fillcolor=lightgreen,
		height=0.56944,
		label="Base Layer (8 GPUs)<br/>
             Embedding + FFN<br/>
             Always active",
		pos="79.5,240",
		shape=rectangle,
		width=2.2083];
	decision -> base_processing	[pos="e,122.75,260.78 122.75,348.34 122.75,348.34 122.75,270.78 122.75,270.78"];
	base_attention	[fillcolor=lightgreen,
		height=0.56944,
		label="Base Attention<br/>
             8 GPUs<br/>
             TP=8 across base",
		pos="244.5,240",
		shape=rectangle,
		width=1.875];
	decision -> base_attention	[label="< 4096",
		lp="271,291.5",
		pos="e,244.5,260.54 244.5,316.73 244.5,316.73 244.5,270.54 244.5,270.54"];
	pool_attention	[fillcolor=lightyellow,
		height=0.72222,
		label="Attention Pool<br/>
             8-32 GPUs<br/>
             Block-wise parallel<br/>
             Sequence length / GPUs blocks",
		pos="428.5,240",
		shape=rectangle,
		width=2.7222];
	decision -> pool_attention	[label="≥ 4096",
		lp="401,291.5",
		pos="e,366.5,266.36 366.5,348.34 366.5,348.34 366.5,276.36 366.5,276.36"];
	communication	[fillcolor=lightyellow,
		height=1.4444,
		label="Communication<br/>
             KV cache sharing<br/>
             Hierarchical reduction<br/>
             Async overlap",
		pos="244.5,125",
		shape=parallelogram,
		width=4.9822];
	base_processing -> communication	[pos="e,112.07,139.55 112.07,219.44 112.07,219.44 112.07,149.55 112.07,149.55"];
	base_attention -> communication	[pos="e,244.5,177.47 244.5,219.44 244.5,219.44 244.5,187.47 244.5,187.47"];
	pool_attention -> communication	[pos="e,377.18,177.32 377.18,213.9 377.18,213.9 377.18,187.32 377.18,187.32"];
	output	[fillcolor=lightblue,
		height=0.5,
		label="Output<br/>[batch=1024, seq_len=?, vocab=32000]",
		pos="244.5,18",
		shape=ellipse,
		width=3.9571];
	communication -> output	[pos="e,244.5,36.166 244.5,72.754 244.5,72.754 244.5,46.166 244.5,46.166"];
}
