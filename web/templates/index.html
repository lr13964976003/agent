<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>Paper to Real</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }
    .layout {
      display: flex;
      height: 100vh;
      transition: all 0.3s ease;
    }
    .sidebar {
      flex: 0 0 33%;
      background: #fff;
      border-right: 1px solid #ddd;
      padding: 60px 15px 15px;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    .layout.collapsed .sidebar {
      flex: 0 0 0;
      padding: 0;
      border: none;
      overflow: hidden;
    }
    .main {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    #docContent {
      white-space: pre-wrap;
      background: #f1f3f5;
      padding: 15px;
      border-radius: 8px;
      height: 70vh;
      overflow-y: auto;
    }
    #promptContent {
      font-family: monospace;
      height: 300px;
      resize: vertical;
    }
    #toggleSidebar {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
    }
    .text-center { text-align: center; }
  </style>
</head>
<body>
<button id="toggleSidebar" class="btn btn-outline-secondary">ğŸ“‚ èœå•</button>

<div class="layout" id="layout">
  <!-- å·¦ä¾§ -->
  <div id="sidebar" class="sidebar">
    <h4>âš™ï¸ ç¯å¢ƒé€‰æ‹©</h4>
    <select id="envSelect" class="form-select mb-3" onchange="loadPrompts()"></select>

    <h5>ğŸ“ Prompt é€‰æ‹©</h5>
    <select id="promptSelect" class="form-select mb-3" onchange="loadPromptContent()"></select>

    <textarea id="promptContent" class="form-control mb-3"></textarea>

    <div class="mb-3">
      <label class="form-label">Arxiv ID</label>
      <input type="text" id="arxiv_id" class="form-control" placeholder="ä¾‹å¦‚: 1234.5678">
    </div>

    <button class="btn btn-primary w-100 mb-2" onclick="generateDocs()">Paper to Real</button>
    <button class="btn btn-secondary w-100 mb-2" onclick="queryDocs()">æŸ¥è¯¢å·²ç”Ÿæˆå†…å®¹</button>
    <button class="btn btn-success w-100" onclick="viewPaper()">æŸ¥çœ‹è®ºæ–‡</button>
  </div>

  <!-- å³ä¾§ -->
  <div class="main" id="mainContent">
    <h4 class="text-center">ğŸ“„ æ–‡æ¡£é€‰æ‹©</h4>
    <select id="docSelect" class="form-select mb-3" onchange="showSelectedDoc()"></select>

    <div class="mb-3">
      <a id="downloadLink" class="btn btn-outline-success d-none" target="_blank">ä¸‹è½½æ–‡æ¡£</a>
    </div>

    <h5 id="docTitle"></h5>
    <div id="docContent"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById("toggleSidebar").addEventListener("click", () => {
  document.getElementById("layout").classList.toggle("collapsed");
});

// åŠ è½½ç¯å¢ƒ
async function loadEnvs() {
  const res = await fetch("/list_environments");
  const data = await res.json();
  const select = document.getElementById("envSelect");
  select.innerHTML = "";
  data.environments.forEach(env => {
    const opt = document.createElement("option");
    opt.value = env;
    opt.textContent = env;
    select.appendChild(opt);
  });
  if (data.environments.length > 0) loadPrompts();
}

// åŠ è½½ prompts
async function loadPrompts() {
  const env = document.getElementById("envSelect").value;
  const res = await fetch(`/list_prompts?env=${env}`);
  const data = await res.json();
  const select = document.getElementById("promptSelect");
  select.innerHTML = "";
  if (data.prompts) {
    data.prompts.forEach(fname => {
      const opt = document.createElement("option");
      opt.value = fname;
      opt.textContent = fname;
      select.appendChild(opt);
    });
    loadPromptContent();
  }
}

async function loadPromptContent() {
  const env = document.getElementById("envSelect").value;
  const fname = document.getElementById("promptSelect").value;
  const res = await fetch(`/get_prompt?env=${env}&filename=${fname}`);
  const data = await res.json();
  document.getElementById("promptContent").value = data.content || "";
}

// ç”Ÿæˆæ–‡æ¡£
async function generateDocs() {
  const arxiv_id = document.getElementById("arxiv_id").value.trim();
  const env = document.getElementById("envSelect").value;
  const prompt = document.getElementById("promptContent").value;
  if (!arxiv_id) { alert("è¯·è¾“å…¥ Arxiv ID"); return; }
  const res = await fetch("/generate", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({arxiv_id, env, prompt})
  });
  const data = await res.json();
  alert(data.message || data.error);
  queryDocs(); // ç”Ÿæˆå®Œæˆååˆ·æ–°æ–‡æ¡£åˆ—è¡¨
}

// æŸ¥è¯¢å·²æœ‰æ–‡æ¡£
async function queryDocs() {
  const arxiv_id = document.getElementById("arxiv_id").value.trim();
  if (!arxiv_id) { alert("è¯·è¾“å…¥ Arxiv ID"); return; }
  const res = await fetch(`/list_docs?arxiv_id=${arxiv_id}`);
  const data = await res.json();
  const select = document.getElementById("docSelect");
  select.innerHTML = "";
  if (data.files) {
    data.files.forEach(file => {
      const opt = document.createElement("option");
      opt.value = file;
      opt.textContent = file;
      select.appendChild(opt);
    });
    if (data.files.length>0) {
      document.getElementById("docSelect").value = data.files[0];
      showSelectedDoc();
    }
  } else {
    document.getElementById("docTitle").textContent = "";
    document.getElementById("docContent").textContent = "";
    document.getElementById("downloadLink").classList.add("d-none");
  }
}

// æ˜¾ç¤ºé€‰ä¸­æ–‡æ¡£å†…å®¹
async function showSelectedDoc() {
  const arxiv_id = document.getElementById("arxiv_id").value.trim();
  const filename = document.getElementById("docSelect").value;
  if (!arxiv_id || !filename) return;
  const res = await fetch(`/get_doc?arxiv_id=${arxiv_id}&filename=${filename}`);
  const data = await res.json();
  if (data.content) {
    document.getElementById("docTitle").textContent = "ğŸ“‘ " + data.filename;
    document.getElementById("docContent").textContent = data.content;
    const link = document.getElementById("downloadLink");
    link.href = `/download_doc?arxiv_id=${arxiv_id}&filename=${filename}`;
    link.classList.remove("d-none");
    link.textContent = "ä¸‹è½½ " + filename;
  }
}

function viewPaper() {
  const arxiv_id = document.getElementById("arxiv_id").value.trim();
  if (!arxiv_id) { alert("è¯·è¾“å…¥ Arxiv ID"); return; }
  window.open(`https://arxiv.org/abs/${arxiv_id}`, "_blank");
}

loadEnvs();
</script>
</body>
</html>
